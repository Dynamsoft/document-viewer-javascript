/*! 
* 20250627164847
* Dynamsoft JavaScript Library
* Product: Dynamsoft Document Viewer
* Web Site: https://www.dynamsoft.com
*
* Copyright 2025, Dynamsoft Corporation
* Author: Dynamsoft Support Team
* Version: 3.0.0
*/

import { mapPackageRegister, CoreModule } from 'dynamsoft-core';

function i(t,e,i){return (e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return ("string"===e?String:Number)(t)}(t,"string");return "symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function n(t,e){return h(t,o(t,e,"get"))}function s(t,e,i){return c(t,o(t,e,"set"),i),i}function o(t,e,i){if(!e.has(t))throw new TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function r(t,e,i){return d(t,e),u(i,"get"),h(t,i)}function a(t,e,i,n){return d(t,e),u(i,"set"),c(t,i,n),n}function l(t,e,i){return d(t,e),i}function h(t,e){return e.get?e.get.call(t):e.value}function c(t,e,i){if(e.set)e.set.call(t,i);else {if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=i;}}function d(t,e){if(t!==e)throw new TypeError("Private static access of wrong provenance")}function u(t,e){if(void 0===t)throw new TypeError("attempted to "+e+" private static field before its declaration")}function p(t,e,i){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return i}function g(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function f(t,e,i){g(t,e),e.set(t,i);}function v(t,e){g(t,e),e.add(t);}function m(t,e,i,n){return new(i||(i=Promise))((function(s,o){function r(t){try{l(n.next(t));}catch(t){o(t);}}function a(t){try{l(n.throw(t));}catch(t){o(t);}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e);}))).then(r,a);}l((n=n.apply(t,e||[])).next());}))}function y(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function x(t,e,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===n?s.call(t,i):s?s.value=i:e.set(t,i),i}var w,b,S,C,P,T,A,k,E,D,R,I,M,B,U,L,O,W,N,_,F,H,V,z,$,j,X,G,Y,q,J,Z,Q,K,tt,et,it,nt,st,ot,rt,at,lt,ht,ct,dt,ut,pt,gt,ft,vt,mt,yt,xt,wt,bt,St,Ct,Pt,Tt,At,kt,Et,Dt,Rt,It,Mt,Bt,Ut,Lt,Ot,Wt,Nt,_t,Ft,Ht,Vt,zt,$t,jt,Xt,Gt,Yt,qt,Jt,Zt,Qt,Kt,te,ee,ie,ne,se,oe,re,ae,le,he,ce,de,ue,pe,ge,fe,ve,me,ye,xe,we,be,Se,Ce,Pe,Te,Ae,ke,Ee,De,Re,Ie,Me,Be,Ue,Le,Oe,We,Ne,_e,Fe,He,Ve,ze,$e,je,Xe,Ge,Ye,qe,Je,Ze,Qe,Ke,ti,ei,ii,ni,si,oi,ri,ai,li,hi,ci,di,ui,pi,gi,fi,vi,mi,yi,xi,wi;"function"==typeof SuppressedError&&SuppressedError,function(t){t.logInfo="logInfo",t.logDebug="logDebug",t.logAll="logAll",t.imgIO="imgIO",t.imgProc="imgProc",t.binaryBlobType="application/octet-stream",t.wasmExtension=".wasm";}(w||(w={})),function(t){t.imgCore="imgCore",t.imgProc="imgProc",t.pdfCore="pdfCore";}(b||(b={})),function(t){t.core="ddv-core",t.reader="ddv-reader",t.detector="ddv-detector",t.loader="ddv-loader",t.proc="ddv-proc";}(S||(S={})),function(t){t.pending="pending",t.ready="ready",t.failed="failed",t.destroyed="destroyed",t.init="init";}(C||(C={})),function(t){t.PARAMETER_TYPE_ERROR="Parameter Type not Supported = ",t.TIMEOUT="Timeout no Response = ",t.FILE_STREAM_ERROR="File Stream Error = ",t.WASM_EXCEPTION_ERROR="An WASM exception occurred.";}(P||(P={})),function(t){t[t.LONG_KEY=0]="LONG_KEY",t[t.DLS_KEY=1]="DLS_KEY";}(T||(T={})),function(t){t[t.wasmSucceed=0]="wasmSucceed",t[t.wasmBase=-4e3]="wasmBase",t[t.wasmException=-4001]="wasmException",t[t.wasmNoModule=-4002]="wasmNoModule",t[t.wasmJsBase=-4100]="wasmJsBase",t[t.wasmJsObjectNotInit=-4101]="wasmJsObjectNotInit",t[t.wasmJsObjectTerminated=-4102]="wasmJsObjectTerminated",t[t.wasmJsObjectInitFailed=-4103]="wasmJsObjectInitFailed",t[t.wasmJsNotLoaded=-4104]="wasmJsNotLoaded",t[t.wasmJsInvalidJson=-4105]="wasmJsInvalidJson",t[t.wasmJsWorkerRunException=-4106]="wasmJsWorkerRunException",t[t.wasmJsWorkerRunFailed=-4107]="wasmJsWorkerRunFailed",t[t.wasmJsReadFileFailed=-4108]="wasmJsReadFileFailed",t[t.wasmJsCoreTaskException=-4109]="wasmJsCoreTaskException",t[t.wasmJsProcTaskException=-4110]="wasmJsProcTaskException",t[t.wasmJsSavePdfFailed=-4111]="wasmJsSavePdfFailed",t[t.wasmJsSaveTiffFailed=-4112]="wasmJsSaveTiffFailed";}(A||(A={})),function(t){t[t.IT_DIB=-1]="IT_DIB",t[t.IT_RGBA=-2]="IT_RGBA",t[t.IT_BGRA=-3]="IT_BGRA",t[t.IT_BMP=0]="IT_BMP",t[t.IT_JPG=1]="IT_JPG",t[t.IT_PNG=3]="IT_PNG",t[t.IT_ALL=5]="IT_ALL";}(k||(k={})),function(t){t[t.RT_AUTO=-1]="RT_AUTO",t[t.RT_BINARY=1]="RT_BINARY",t[t.RT_BASE64=2]="RT_BASE64";}(E||(E={})),function(t){t[t.SF_DEF=0]="SF_DEF",t[t.SF_ENABLE=1]="SF_ENABLE",t[t.SF_DISABLE=2]="SF_DISABLE";}(D||(D={})),function(t){t.imgIOVer="3.0.0",t.imgProcVer="3.0.0";}(nt||(nt={}));class bi{static setLogFunc(t,e,i){x(this,R,t,"f",I),x(this,R,e,"f",M),x(this,R,i,"f",B);}static get level(){return y(this,R,"f",I)}static get func(){return y(this,R,"f",M)}static get context(){return y(this,R,"f",B)}static logAll(t){this.log(w.logAll,t);}static logD(t){this.log(w.logDebug,t);}static log(t,e){y(this,R,"f",M)&&y(this,R,"f",I)===t&&y(this,R,"f",M).call(this,e,y(this,R,"f",B));}}R=bi,I={value:""},M={value:void 0},B={value:null};class Si{static unload(){x(this,U,"","f",L),x(this,U,"","f",W),x(this,U,null,"f",N),x(this,U,{name:w.imgIO,instanceName:b.imgCore,workerName:S.core,autoLoad:!1,ver:nt.imgIOVer,prefixName:Si.ImageIOPrefixName,useSimd:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli},"f",tt),x(this,U,{name:w.imgProc,instanceName:b.imgProc,workerName:S.proc,autoLoad:!1,ver:nt.imgProcVer,prefixName:Si.ImageProcPrefixName,useSimd:Si.UseSimd,useBrotli:Si.UseBrotli},"f",et),bi.setLogFunc("",void 0,null);}static get UseSimd(){return y(this,U,"f",F)}static set UseSimd(t){x(this,U,t,"f",F);}static get UseBrotli(){return y(this,U,"f",H)}static set UseBrotli(t){x(this,U,t,"f",H);}static get License(){return y(this,U,"f",L)}static set License(t){x(this,U,t,"f",L);}static get LicMode(){return y(this,U,"f",O)}static set LicMode(t){x(this,U,t,"f",O);}static get UUID(){return y(this,U,"f",W)}static set UUID(t){x(this,U,t,"f",W);}static get NavInfo(){return y(this,U,"f",N)}static set NavInfo(t){x(this,U,t,"f",N);}static get Mobile(){return y(this,U,"f",_)}static set Mobile(t){x(this,U,t,"f",_);}static get DefHeapSize(){return y(this,U,"f",V)}static set DefHeapSize(t){x(this,U,t,"f",V);}static get MaxHeapSize(){return y(this,U,"f",z)}static get HeapConfig(){return y(this,U,"m",j).call(this),Object.assign({},y(this,U,"f",$))}static getWorkerHeap(t){return void 0!==y(this,U,"f",$)[t]?y(this,U,"f",$)[t]:{maxHeapSize:y(this,U,"f",z),initHeapSize:y(this,U,"f",V)}}static UpdateHeapConfig(t,e,i){y(this,U,"m",j).call(this),e&&void 0!==y(this,U,"f",$)[t]&&(y(this,U,"f",$)[t].maxHeapSize=e),i&&void 0!==y(this,U,"f",$)[t]&&(y(this,U,"f",$)[t].initHeapSize=i);}static get FileReadModeSize(){return y(this,U,"f",X)}static set FileReadModeSize(t){x(this,U,t,"f",X);}static get FontUseFileReadMode(){return {load:y(this,U,"f",G),save:y(this,U,"f",Y)}}static set FontUseFileReadMode(t){"boolean"==typeof t.load&&x(this,U,t.load,"f",G),"boolean"==typeof t.save&&x(this,U,t.save,"f",Y);}static get ImageIOWorkerJS(){return "ddv-imageio.worker.js?v="+nt.imgIOVer}static get ImageProcWorkerJS(){return "ddv-imageproc.worker.js?v="+nt.imgProcVer}static get ImageProcSimdWorkerJS(){return "ddv-imageproc-simd.worker.js?v="+nt.imgProcVer}static get ImageIOPrefixName(){return "ddv-imageio"}static get ImageProcPrefixName(){return "ddv-imageproc"}static get ImageIOResource(){return y(this,U,"f",Z)}static set ImageIOResource(t){x(this,U,y(this,U,"m",q).call(this,t),"f",Z),y(this,U,"m",K).call(this,y(this,U,"f",Z),y(this,U,"f",tt)),y(this,U,"m",K).call(this,y(this,U,"f",Z),y(this,U,"f",et));}static get ImageProcResource(){return y(this,U,"f",Q)}static set ImageProcResource(t){t.useFastCompEdition=!1,x(this,U,y(this,U,"m",q).call(this,t),"f",Q),y(this,U,"m",K).call(this,y(this,U,"f",Q),y(this,U,"f",et));}static get ImageIOModule(){return y(this,U,"f",tt)}static get ImageReadereModule(){const t=Object.assign({},y(this,U,"f",tt));return t.workerName=S.reader,t}static get PdfReaderModule(){const t=Object.assign({},y(this,U,"f",tt));return t.workerName=S.reader,t.singleInstance=!0,t.instanceName=b.pdfCore,t}static get PdfWriterModule(){const t=Object.assign({},y(this,U,"f",tt));return t.singleInstance=!0,t.instanceName=b.pdfCore,t}static get ImageProcModule(){return y(this,U,"f",et)}static get DetectorModule(){return x(this,U,Object.assign({},y(this,U,"f",et)),"f",it),y(this,U,"f",it).workerName=S.detector,y(this,U,"f",it)}static setLogFunc(t,e,i){bi.setLogFunc(t,e,i);}static hasLogFunc(){return void 0!==bi.func}}U=Si,j=function(){0===Object.keys(y(this,U,"f",$)).length&&(y(this,U,"f",$)[S.core]={},y(this,U,"f",$)[S.core].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.core].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.reader]={},y(this,U,"f",$)[S.reader].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.reader].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.detector]={},y(this,U,"f",$)[S.detector].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.detector].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.proc]={},y(this,U,"f",$)[S.proc].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.proc].initHeapSize=y(this,U,"f",V));},q=function(t){var e,i,n,s;let o={crossScript:!1,resourceDir:t.resourceDir,workerScript:t.workerScript,useFastCompEdition:null!==(e=t.useFastCompEdition)&&void 0!==e&&e,useSimd:null!==(i=t.useSimd)&&void 0!==i?i:y(this,U,"f",F),fetchOptions:null!==(n=t.fetchOptions)&&void 0!==n?n:y(this,U,"f",J),useBrotli:null!==(s=t.useBrotli)&&void 0!==s?s:y(this,U,"f",H)};return o.workerScript=t.resourceDir+t.workerScript,o.workerScript.startsWith("http://")||o.workerScript.startsWith("https://")||o.workerScript.includes("://")?(o.resourceDir=t.resourceDir,o.workerScript.startsWith(location.origin)||(o.crossScript=!0)):t.resourceDir.startsWith("/")?null!=location.origin&&(o.resourceDir=location.origin+t.resourceDir):null!=location.href&&(o.resourceDir=location.href.substring(0,location.href.replace(/[?#].*/,"").lastIndexOf("/")+1)+t.resourceDir),o.resourceDir.endsWith("/")||(o.resourceDir+="/"),t.useFastCompEdition&&(o.resourceDir+="fastcomp/",o.workerScript=o.resourceDir+t.workerScript),o},K=function(t,e){e.resourceDir=t.resourceDir,e.crossScript=t.crossScript,e.name===w.imgProc?e.useSimd=t.useSimd:e.useSimd=!1,e.script=t.workerScript,e.fetchOptions=t.fetchOptions,e.useBrotli=t.useBrotli;},L={value:""},O={value:T.LONG_KEY},W={value:""},N={value:null},_={value:!1},F={value:!1},H={value:!1},V={value:32},z={value:200},$={value:Object.create(null)},X={value:20},G={value:!0},Y={value:!1},J={value:{mode:"cors",credentials:"same-origin",retries:3,retryDelay:500}},Z={value:{resourceDir:"",workerScript:Si.ImageIOWorkerJS,useFastCompEdition:!1,useSimd:!1,crossScript:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},Q={value:{resourceDir:"",workerScript:Si.ImageIOWorkerJS,useFastCompEdition:!1,useSimd:!1,crossScript:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},tt={value:{name:w.imgIO,instanceName:b.imgCore,workerName:S.core,autoLoad:!1,ver:nt.imgIOVer,prefixName:Si.ImageIOPrefixName,useSimd:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},et={value:{name:w.imgProc,instanceName:b.imgProc,workerName:S.proc,autoLoad:!1,ver:nt.imgProcVer,prefixName:Si.ImageProcPrefixName,useSimd:Si.UseSimd,useBrotli:Si.UseBrotli}},it={value:void 0};class Ci{static read(t){return new Promise((function(e,i){let n=Object.prototype.toString.call(t);if("[object String]"===n){if(0===t.indexOf("blob:")||t.indexOf(".jpg")>0||t.indexOf(".jpeg")>0||t.indexOf(".png")>0||t.indexOf(".bmp")>0||t.indexOf(".dib")>0||t.indexOf(".pdf")>0||t.indexOf(".tiff")>0||t.indexOf(".tif")>0)return fetch(t,{mode:"cors"}).then((function(t){return t.arrayBuffer()})).then((function(t){return e(t)})).catch((function(t){return Promise.reject(t)}));i("Error url: Can not read the file URL");}else if("[object Blob]"===n||"[object FileList]"===n||"[object File]"===n){let s=t;"[object FileList]"!==n&&"[object File]"!==n||(s=t[0]?t[0]:t),y(Ci,st,"m",ot).call(Ci,s,e,i);}else "[object ArrayBuffer]"===n||"[object Uint8ClampedArray]"===n?e(t):i("Not support source type: "+n);}))}}st=Ci,ot=function(t,e,i){let n,s,o=0;try{n=new ArrayBuffer(t.size),s=new Uint8Array(n);}catch(t){i(t);}!function r(){const a=new FileReader;a.onload=function(a){var l;if(null===(l=null==a?void 0:a.target)||void 0===l?void 0:l.result){const i=a.target.result;s.set(new Uint8Array(i),o),o+=i.byteLength,o<t.size?r():e(n);}else i(a);},a.onerror=function(t){i(t);},a.onabort=function(t){i(t);};const l=Math.min(o+1048576,t.size),h=t.slice(o,l);a.readAsArrayBuffer(h);}();};class Pi{static fetchRetry(t,e,i,n){let s=e.retries,o=e.retryDelay;return new Promise((function(r,a){const l=function(h){return fetch(t,e).then((function(t){r(t);})).catch((function(t){h<s?function(t,e,s){i&&i(e,n),setTimeout((function(){l(++t);}),o);}(h,t):a(t);}))};return l(0)}))}}class Ti{constructor(t,e,i,n,s,o){rt.add(this),at.set(this,void 0),lt.set(this,void 0),ht.set(this,void 0),ct.set(this,void 0),dt.set(this,void 0),ut.set(this,void 0),pt.set(this,void 0),gt.set(this,void 0),ft.set(this,void 0),vt.set(this,void 0),mt.set(this,void 0),yt.set(this,void 0),xt.set(this,void 0),wt.set(this,0),bt.set(this,{}),St.set(this,null),x(this,at,t,"f"),x(this,ft,n,"f"),x(this,xt,i,"f"),x(this,ht,[],"f"),x(this,ct,!1,"f"),x(this,dt,!1,"f"),x(this,wt,e,"f"),x(this,St,Object.create(null),"f"),y(this,bt,"f").modulesInfo=[],x(this,mt,Object.create(null),"f"),x(this,gt,null,"f"),x(this,vt,0,"f"),x(this,yt,0,"f"),x(this,lt,y(this,rt,"m",Pt).call(this,y(this,at,"f")),"f"),y(this,lt,"f").on("message",y(this,rt,"m",At),this),y(this,lt,"f").on("error",y(this,rt,"m",Tt),this),y(this,lt,"f").on("exit",(function(e,i,n){let s="Worker #terminated Unexpectedly\n";s+=" exitCode: `"+e+"`\n",s+=" signalCode: `"+i+"`\n",s+=" #script: `"+t+"`\n",y(n,rt,"m",Tt).call(n,new Error(s),n);}),this);}get WorkerScript(){return y(this,ft,"f")}get id(){return y(this,wt,"f")}get Module(){return y(this,bt,"f")}get Instances(){return y(this,St,"f")}get WorkerName(){return y(this,xt,"f")}execTask(t,e,i){i||((i={}).promise=new Promise((function(t,e){i.resolve=t,i.reject=e;})));let n=x(this,yt,+y(this,yt,"f")+1,"f");y(this,mt,"f")[n]={id:n,insId:e.insId,resolver:i,cost:e.cost},delete e.cost;let s={id:n,func:t,params:e};return bi.logD("["+e.insId+"] "+t+" send"),y(this,dt,"f")?i.reject(new Error("Worker is #terminated")):y(this,ct,"f")?i.reject(new Error("Worker is #terminating")):y(this,lt,"f").wasmReady||y(this,lt,"f").ready&&"loadWasm"===t?y(this,lt,"f").send(s):y(this,ht,"f").push(s),i.promise}get memSize(){return y(this,vt,"f")}get busy(){return this.howManyTasks>0}get howManyTasks(){return Object.keys(y(this,mt,"f")).length}get alive(){return !y(this,ct,"f")&&!y(this,dt,"f")}terminate(t,e){if(bi.logD("["+this.id+"] worker terminate "+t),t&&y(this,rt,"m",Et).call(this,"Worker has been #terminated"),"function"==typeof e&&x(this,gt,e,"f"),this.busy)x(this,ct,!0,"f");else {if(y(this,lt,"f")){if("function"!=typeof y(this,lt,"f").terminate)throw new Error("Failed to terminate worker");bi.logD("["+this.id+"] will be terminated"),y(this,lt,"f").terminate(),x(this,lt,null,"f");}x(this,ct,!1,"f"),x(this,dt,!0,"f"),y(this,gt,"f")&&y(this,gt,"f").call(this,this);}}hasInstance(t){if(t){const e=y(this,St,"f")[t];if(e)return 0!=Object.keys(e).length}else {const t=Object.keys(y(this,St,"f"));for(const e of t)if(0!=Object.keys(y(this,St,"f")[e]).length)return !0}return !1}exceedMaxMemory(){const t=1024*Si.getWorkerHeap(this.WorkerName).maxHeapSize*1024;return !!(y(this,vt,"f")&&y(this,vt,"f")>t&&0!=t)&&(bi.logD("[w-"+this.id+"] current memSize="+y(this,vt,"f")+", max="+t),!0)}shouldBeFreed(){return !(!this.exceedMaxMemory()||this.hasInstance(void 0)||(bi.logD("[w-"+this.id+"] try to terminate the worker"),this.terminate(),0))}}at=new WeakMap,lt=new WeakMap,ht=new WeakMap,ct=new WeakMap,dt=new WeakMap,ut=new WeakMap,pt=new WeakMap,gt=new WeakMap,ft=new WeakMap,vt=new WeakMap,mt=new WeakMap,yt=new WeakMap,xt=new WeakMap,wt=new WeakMap,bt=new WeakMap,St=new WeakMap,rt=new WeakSet,Ct=function(t){let e=new Error(""),i=Object.keys(t);for(let n=0;n<i.length;n++)e[i[n]]=t[i[n]];return e},Pt=function(t){if("function"!=typeof Worker&&"object"!=typeof Worker)throw new Error("Web Workers not supported");let e=new Worker(t,{name:this.WorkerName});return e.on=function(t,e,i){this.addEventListener(t,(function(n){"exit"===t?e(n.data,"",i):e(n.data,i);}));},e.send=function(t){if(null!=t&&null!=t.params&&null!=t.params.input){let e=Object.prototype.toString.call(t.params.input);if("[object Array]"===Object.prototype.toString.call(t.params.input)){if(e=Object.prototype.toString.call(t.params.input[0]),"[object ArrayBuffer]"===e||"[object Uint8ClampedArray]"===e||"[object Uint8Array]"===e)return void this.postMessage(t,[null!=t.params.input[0].buffer?t.params.input[0].buffer:t.params.input[0]])}else if("[object ArrayBuffer]"===e||"[object Uint8ClampedArray]"===e||"[object Uint8Array]"===e)return void this.postMessage(t,[null!=t.params.input.buffer?t.params.input.buffer:t.params.input])}this.postMessage(t);},e},Tt=function(t,e){x(e,dt,!0,"f"),bi.logD("[js]["+e.id+"] worker error "+JSON.stringify(t)),y(e,ct,"f")&&y(e,gt,"f")&&y(e,gt,"f").call(e,e),x(e,ct,!1,"f"),y(e,rt,"m",Et).call(e);},At=function(t,e){let i=t.id,n=y(e,mt,"f")[i];if(t&&t.cost&&n&&n.cost){const e=n.cost;e.exec=t.cost;const i=Date.now();e.total=i-e.ctime,e.msgQueue=t.ctime-e.time;const s=i-t.time;delete e.time,delete e.ctime,t.cost=e,t.cost.receive=s,delete t.ctime,delete t.time;}if(bi.logD(t.log?t.log:t),"string"==typeof t&&"ready"===t)y(e,lt,"f").ready=!0,setTimeout((()=>{y(e,rt,"m",kt).call(e);}),0);else if(!t.log){if("object"==typeof t){let i=t.result;"object"==typeof i?(null!=i.errorCode&&(i.code=i.errorCode,delete i.errorCode),null!=i.errorMessage&&(i.message=i.errorMessage,delete i.errorMessage)):"string"==typeof i&&(i=i.replace('"errorCode"','"code"'),i=i.replace("'errorCode'","'code'"),i=i.replace('"errorMessage"','"message"'),i=i.replace("'errorMessage'","'message'"),t.result=i),null!=t.memSize&&x(e,vt,t.memSize,"f");}if(void 0!==n){const s=n.insId;delete y(e,mt,"f")[i],bi.logD("["+s+"] "+t.func+" received"),!0===y(e,ct,"f")&&e.terminate(),"loadWasm"===t.func&&null!=t.result&&(y(e,lt,"f").wasmReady=!0,setTimeout((()=>{y(e,rt,"m",kt).call(e);}),0)),t.error?n.resolver.reject(y(e,rt,"m",Ct).call(e,t.error)):t.result&&n.resolver.resolve(t.result);}}},kt=function(){this.alive&&(y(this,ht,"f").forEach(y(this,lt,"f").send.bind(y(this,lt,"f"))),x(this,ht,[],"f"));},Et=function(t){for(let e in y(this,mt,"f"))void 0!==y(this,mt,"f")[e]&&y(this,mt,"f")[e].resolver.reject(new Error(t));x(this,mt,Object.create(null),"f");};class Ai{constructor(){Dt.add(this),Mt.set(this,[]),Bt.set(this,4),Ut.set(this,60),Lt.set(this,!1),Ot.set(this,0),Nt.set(this,!1);}static get Instance(){return y(this,Rt,"f",It)||x(this,Rt,new Ai,"f",It),y(this,Rt,"f",It)}get Terminated(){return y(this,Lt,"f")}getModuleLoadedError(t){for(let e of y(Ai,Rt,"f",Wt))if(e.name==t)return e.error}getModuleStatus(t){for(let e of y(Ai,Rt,"f",Wt))if(e.name==t)return e.status;return ""}addModules(t,e){let i=!1;if(y(Ai,Rt,"f",Wt).forEach((function(e,n,s){e.name==t.name&&(e.ver==t.ver?i=!0:s.splice(n,1));})),!i){let i=t;i.status=e||"",i.wasmModule=null,y(Ai,Rt,"f",Wt).push(i);}}loadModule(t,e){return m(this,void 0,void 0,(function*(){let i,n;null==e&&(e=0!=y(this,Dt,"m",Xt).call(this,t).length),this.addModules(t);for(let s of y(Ai,Rt,"f",Wt))if(s.name===t.name){if(s.status===C.pending)return !1;if(s.wasmModule){if(e)return !0;i=s.wasmModule,n=s.wasmBinary;break}break}let s=null;if(i)s=t,s.wasmModule=i,s.wasmBinary=n,s.status=C.pending;else if(s=t,""===s.status)s.status=C.pending,s.wasmModule=null;else {if(s.status===C.pending)return !1;e||(s.error={code:0,message:""},s.status=C.pending);}return y(this,Dt,"m",_t).call(this,s)}))}get busy(){y(this,Dt,"m",Jt).call(this);let t=y(this,Mt,"f");for(let e of t)if(e.busy)return !0;return !1}getWorker(t,e){return m(this,void 0,void 0,(function*(){if(y(this,Dt,"m",Gt).call(this,t.name))return y(this,Dt,"m",qt).call(this),{worker:null,workers:0};let i=y(this,Dt,"m",Xt).call(this,t,!0);return 0!=i.length?{worker:y(this,Dt,"m",Zt).call(this,i,e,t),workers:i.length}:(yield this.loadModule(t,!1),{worker:null,workers:0})}))}removeInstanceInWorker(t,e,i,n){if(y(this,Dt,"m",Qt).call(this,e,t.instanceName,i),n&&e&&e.shouldBeFreed()){let t=y(this,Mt,"f").indexOf(e);-1!==t&&y(this,Mt,"f").splice(t,1);}}terminate(t){x(Ai,Rt,null,"f",It),bi.logD("worker pool terminate "+t),x(this,Lt,!0,"f");let e=[];return y(this,Mt,"f").splice(0).forEach((function(i){let n={};n.promise=new Promise((function(t,e){n.resolve=t,n.reject=e;})),e.push(n.promise),i.terminate(t,(function(t){n.resolve(t);}));})),Promise.all(e)}static unload(){x(Ai,Rt,new Array,"f",Wt);}terminateWorker(t){y(this,Mt,"f").splice(0,y(this,Mt,"f").length,...y(this,Mt,"f").filter((e=>e.WorkerName!==t||(e.terminate(!0),!1))));}getMemoryUsed(){let t=y(this,Mt,"f"),e=[],i=0;for(let n of t)n&&null!=n.memSize&&(e[i]={},e[i].size=n.memSize,e[i].limit=1024*Si.getWorkerHeap(n.WorkerName).maxHeapSize*1024,e[i].name=n.WorkerName,e[i].id=n.id,i+=1);return e}}Rt=Ai,Mt=new WeakMap,Bt=new WeakMap,Ut=new WeakMap,Lt=new WeakMap,Ot=new WeakMap,Nt=new WeakMap,Dt=new WeakSet,_t=function(t){return m(this,void 0,void 0,(function*(){let e=this,i=yield y(this,Dt,"m",$t).call(this,t);if(i){let n={id:0,func:"loadWasm",params:{insId:0,priority:0,module:{modulesInfo:[]},fetchOptions:t.fetchOptions}};n.params.resourceDir=t.resourceDir,n.params.initMemory=Si.getWorkerHeap(t.workerName).initHeapSize,n.params.module&&n.params.module.modulesInfo.push(t),yield y(this,Dt,"m",Ht).call(this,i,n),x(e,Bt,y(e,Dt,"m",zt).call(e),"f"),t.status===C.pending&&(t.status="");}else t.status="",t.wasmModule=null;}))},Ft=function(t,e,i,n){for(let s of y(Ai,Rt,"f",Wt))if(s.name===t){s.status=e,s.wasmModule=i.wasmModule,s.wasmBinary=i.wasmBinary,s.error=n;break}},Ht=function(t,e,i){return m(this,void 0,void 0,(function*(){let n=this;try{const i=yield t.execTask(e.func,e.params);let s=!1;return void 0===i.code||i.modules?s=y(n,Dt,"m",Vt).call(n,i,t):bi.logD(i),s}catch(n){return bi.logD(n),!1}finally{i&&i();}}))},Vt=function(t,e){if(bi.logD("handleWasmLoad:"),bi.logD(t),y(this,Lt,"f"))return e.terminate(),!1;if(("object"!=typeof t||null==t.modules)&&"object"==typeof t)return !1;let i=!1;for(const n of t.modules)t.code?(y(this,Dt,"m",Ft).call(this,n.name,C.failed,null,{code:t.code,message:t.message}),e.Module.modulesInfo[n.name]=!1):(y(this,Dt,"m",Ft).call(this,n.name,C.ready,n.wasmResource,void 0),e.Module.modulesInfo[n.name]=!0,i=!0);return i},zt=function(){let t=2;return "hardwareConcurrency"in self.navigator&&(t=self.navigator.hardwareConcurrency),Math.max(Math.min(y(this,Bt,"f"),Math.max(y(this,Bt,"f"),t/2)),1)},$t=function(t){return m(this,void 0,void 0,(function*(){y(this,Dt,"m",Jt).call(this);let e=y(this,Mt,"f");for(let i of e)if(i.WorkerName===t.workerName)return i.busy?null:i;return y(this,Dt,"m",jt).call(this,t)}))},jt=function(t){var e;return m(this,void 0,void 0,(function*(){let i=this,n=y(i,Mt,"f");if(n.length<y(i,Bt,"f")&&!y(i,Nt,"f")){x(i,Nt,!0,"f");let s=t.script;t.crossScript&&(s=yield Pi.fetchRetry(t.script,t.fetchOptions,bi.func,i).then((t=>t.blob())).then((t=>URL.createObjectURL(t))).catch((t=>(bi.logD("get new worker fetch failed: "),bi.logD(t),x(i,Nt,!1,"f"),null))));let o=new Ti(s,x(e=i,Ot,+y(e,Ot,"f")+1,"f"),t.workerName,t.script,bi.func,bi.context);return n.push(o),x(i,Nt,!1,"f"),bi.logAll(n),bi.logD("[wl-"+y(i,Mt,"f").length+"] got new worker w-"+o.id+"("+o.WorkerName+") succeed!"),o}return null}))},Xt=function(t,e){y(this,Dt,"m",Jt).call(this);let i=y(this,Mt,"f");bi.logAll(i);let n=[];for(let s of i)if(s.Module.modulesInfo[t.name]){if(e&&s.WorkerName!==t.workerName)continue;n.push(s);}return bi.logAll("[wl-"+i.length+"] got workers for module "+t.name),bi.logAll(n),n},Gt=function(t){for(let e of y(Ai,Rt,"f",Wt))if(e.name===t&&e.status===C.pending)return !0;return !1},Yt=function(){return m(this,void 0,void 0,(function*(){this.terminate(!0);for(let t of y(Ai,Rt,"f",Wt))yield y(this,Dt,"m",_t).call(this,t);}))},qt=function(){y(this,Dt,"m",Jt).call(this),0==y(this,Mt,"f").length&&0!=y(Ai,Rt,"f",Wt).length&&(bi.logD("no worker ready, reinit"),y(this,Dt,"m",Yt).call(this));},Jt=function(){y(this,Mt,"f").splice(0,y(this,Mt,"f").length,...y(this,Mt,"f").filter((function(t){return t.alive})));},Zt=function(t,e,i){bi.logAll("[wl-"+y(this,Mt,"f").length+"] getWorkerByIntanceId"),bi.logAll(t);let n,s=9007199254740991;for(let o of t){if(i.singleInstance&&o.hasInstance(i.instanceName)&&!o.Instances[i.instanceName][e])continue;const t=o.Instances[i.instanceName];if(!t||void 0!==t[e]){n=o;break}{let t=o.howManyTasks;t<s&&(n=o,s=t);}}if(n){if(n.shouldBeFreed())return null;const s=n.Instances[i.instanceName];if(s)s[e]="";else {const t=Object.create(null);t[e]="",n.Instances[i.instanceName]=t;}return bi.logAll(t),bi.logD("[wl-"+t.length+"]["+e+"] got worker w-"+n.id),n}return bi.logAll("#getWorkerByIntanceId: no suitable worker"),null},Qt=function(t,e,i){let n=y(this,Mt,"f");bi.logAll("removeInstanceInWorkerInner"),bi.logAll(n);for(let s of n)if(s===t){const o=s.Instances[e];if(o){if(null!=o[i]){delete o[i],bi.logAll(n),bi.logD("[w-"+s.id+"] removeInstanceInWorkerInner "+i+" in "+t.id+" succeed!");break}bi.logD("[w-"+s.id+"] not found instance "+i);}}},It={value:null},Wt={value:new Array};class ki{static buildWasmFileName(t,e,i,n,s){return t+(n?"-simd":"")+i+"?v="+e}static base64DecToArr(t,e){let i=t.replace(/[^A-Za-z0-9\+\/]/g,""),n=i.length,s=e?Math.ceil((3*n+1>>>2)/e)*e:3*n+1>>>2,o=new Uint8Array(s);for(let t,e,r=0,a=0,l=0;l<n;l++)if(e=3&l,r|=y(this,Kt,"m",te).call(this,i.charCodeAt(l))<<18-6*e,3===e||n-l==1){for(t=0;t<3&&a<s;t++,a++)o[a]=r>>>(16>>>t&24)&255;r=0;}return o}static isWasmSupport(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return !1}static random(){return (Date.now()%10086).toString(36).slice(2)+Math.random().toString(36).slice(2)}static newBlobInChunks(t,e,i){var n;let s;const o=i||t.byteLength,r=8388608,a=[];for(let e=0;e<o;e+=r)a.push(new Blob([new Uint8Array(null!==(n=t.buffer)&&void 0!==n?n:t,e,Math.min(o-e,r))]));return s=null!=e?new Blob(a,{type:e}):new Blob(a),s}}Kt=ki,te=function(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:43===t?62:47===t?63:0};class Ei{constructor(t,e){var i,n,s,o;ee.add(this),se.set(this,void 0),this._outputType=k.IT_JPG,this._inputType=k.IT_ALL,this._jpegQuality=80,oe.set(this,null!==(i=Si.License)&&void 0!==i?i:""),re.set(this,[]),ae.set(this,null),le.set(this,0),he.set(this,x(o=Ei,ie,+y(o,ie,"f",ne)+1,"f",ne)),ce.set(this,null),de.set(this,JSON.parse(JSON.stringify(Si.NavInfo))),ue.set(this,Si.Mobile),pe.set(this,location.origin),ge.set(this,""),fe.set(this,C.init),ve.set(this,!1),me.set(this,null!==(n=Si.LicMode)&&void 0!==n?n:T.LONG_KEY),ye.set(this,null!==(s=Si.UUID)&&void 0!==s?s:""),xe.set(this,0),we.set(this,!1),be.set(this,!1),this._handleBooleanResult=function(t,e){return !0},x(this,se,t,"f"),x(this,oe,null!=e?e:Si.License,"f");}_prepareModule(t){}get workerId(){return y(this,ae,"f")&&y(this,ae,"f").alive?y(this,ae,"f").id:0}get id(){return y(this,he,"f")}hasTask(){return y(this,re,"f").length>0}_canTerminateWork(){return !1}_makeSureWorkerMemoryNotExceed(){return !(y(this,ae,"f")&&y(this,ae,"f").alive&&this._canTerminateWork()&&y(this,ae,"f").exceedMaxMemory()&&(bi.logD(`[${this.id}] try to termiate worker [${y(this,ae,"f").id}]`),y(this,ae,"f").terminate(!0),x(this,ae,null,"f"),x(this,fe,C.init,"f"),1))}_makeSureWorkerChanged(){return !!(y(this,ae,"f")&&y(this,ae,"f").alive&&this._canTerminateWork())&&(bi.logD(`[${this.id}] try to termiate worker [${y(this,ae,"f").id}]`),y(this,ae,"f").terminate(!0),x(this,ae,null,"f"),x(this,fe,C.init,"f"),!0)}_workerChanged(t){}_handleBasicResult(t,e){return delete t.code,delete t.message,t}_handleImageData(t,e){var i,n,s;if("object"==typeof t.imageData)if(null!=t.imageCount&&t.imageCount>1)for(let n=0;n<t.imageCount;n++)t.imageData[n]=y(i=e.context,ee,"m",Pe).call(i,t.imageData[n],t.blobType,e.params.returnBlob,t.imageDataSize);else t.imageData=y(n=e.context,ee,"m",Pe).call(n,t.imageData,t.blobType,e.params.returnBlob,t.imageDataSize);return "object"==typeof t.pdfData&&(t.pdfData=y(s=e.context,ee,"m",Pe).call(s,t.pdfData,t.blobType,e.params.returnBlob,t.pdfDataSize)),t}_handleResult(t,e){var i,n;let s=y(n=e.context,ee,"m",Te).call(n,t);if(void 0===s.code||!s.code&&"Successful."===s.message)s=e.handleResult(s,e),setTimeout((()=>{var t;y(t=e.context,ee,"m",Ce).call(t);}),0),(0, e.resolve)(s);else {let t={code:s.code,message:s.code===A.wasmException?P.WASM_EXCEPTION_ERROR+"("+(null===(i=e.params)||void 0===i?void 0:i.moduleName)+":"+e.func+":"+s.message+")":s.message};e.context.terminated?e.resolve(t):e.reject(t);}}_execTask(t){let e=this,i=y(e,ae,"f");if(bi.logAll(t),i)try{if(t.params.cost){const e=t.params.cost.time;t.params.cost.time=Date.now(),t.params.cost.taskQueue=t.params.cost.time-e;}i.execTask(t.func,t.params).then((function(i){e._handleResult(y(e,ee,"m",Te).call(e,i),t);})).catch((function(i){bi.logD(i),setTimeout((()=>{y(e,ee,"m",Ce).call(e);}),0);let n=i;"object"==typeof i&&null!=i.message&&(n=i.message);let s={code:A.wasmJsWorkerRunFailed,message:n};y(e,ve,"f")?t.resolve(s):t.reject(s);}));}catch(i){setTimeout((()=>{y(e,ee,"m",Ce).call(e);}),0),bi.logD(i);let n={code:A.wasmJsWorkerRunException,message:i.message,stack:i.stack};y(e,ve,"f")?t.resolve(n):t.reject(n);}}_cancelAllTasks(t,e){for(let i of y(this,re,"f"))if(void 0!==i){let n={code:t,message:e};y(this,ve,"f")?i.resolve(n):i.reject(n);}x(this,re,[],"f");}_createTask(t,e,i){let n={moduleName:y(this,se,"f").instanceName,insId:y(this,he,"f")},s={id:x(this,le,+y(this,le,"f")+1,"f"),func:t,params:n};return s.promise=new Promise((function(t,e){s.resolve=t,s.reject=e;})),s.func=t,s.context=this,s.handleResult=void 0!==i&&i?i:this._handleBasicResult,s.params.input=void 0!==e&&e?e:"",s.params.returnType=E.RT_AUTO,s.params.returnBlob=!0,s.params.logLevel=bi.level,s.params.cost={},s.params.cost.ctime=Date.now(),s.params.cost.time=s.params.cost.ctime,s}_addTask(t,e){if(t.params.cost){const e=t.params.cost.time;t.params.cost.time=Date.now(),t.params.cost.create=t.params.cost.time-e;}return y(this,fe,"f")===C.destroyed?t.reject({code:A.wasmJsObjectNotInit,message:y(this,ve,"f")?"object has been disposed":"object not init"}):y(this,fe,"f")===C.failed?t.reject({code:A.wasmJsObjectInitFailed,message:y(this,ge,"f")}):(e?y(this,re,"f").unshift(t):y(this,re,"f").push(t),y(this,ee,"m",Ce).call(this)),t.promise}terminate(t){let e=this;y(e,we,"f")?x(e,ve,!0,"f"):(x(this,be,!0,"f"),y(e,ee,"m",ke).call(e).then((function(t){bi.logD("["+e.id+"] "+y(e,se,"f").name+" destroy return: "),bi.logD(t);})).catch((function(t){bi.logD(y(e,se,"f").name+" destroy failed"),bi.logD(t);})).finally((()=>{Ai.Instance&&Ai.Instance.removeInstanceInWorker(y(e,se,"f"),y(e,ae,"f"),y(e,he,"f"),null==t||t),x(e,ae,null,"f"),x(e,ve,!0,"f"),x(e,be,!1,"f");}))),x(e,fe,"","f");}_readFile(t){return Ci.read(t).catch((function(t){let e=t;return "object"!=typeof e&&(e={},e.code=A.wasmJsReadFileFailed,e.message=t),Promise.reject(e)}))}updateLicense(t,e,i){return m(this,void 0,void 0,(function*(){x(this,oe,t,"f"),x(this,me,null!=e?e:T.LONG_KEY,"f"),x(this,ye,null!=i?i:"","f");let n=this,s=n._createTask("UpdateLicense");return s.params.input=[y(n,oe,"f"),y(n,me,"f"),y(n,ye,"f")],n._addTask(s),s.promise}))}}ie=Ei,se=new WeakMap,oe=new WeakMap,re=new WeakMap,ae=new WeakMap,le=new WeakMap,he=new WeakMap,ce=new WeakMap,de=new WeakMap,ue=new WeakMap,pe=new WeakMap,ge=new WeakMap,fe=new WeakMap,ve=new WeakMap,me=new WeakMap,ye=new WeakMap,xe=new WeakMap,we=new WeakMap,be=new WeakMap,ee=new WeakSet,Se=function t(e){let i=null!=e?e:this;return y(i,ce,"f")&&clearTimeout(y(i,ce,"f")),y(i,ve,"f")?(bi.logD(`[${i.id}] has been termiated.(getWorker)`),i._cancelAllTasks(A.wasmJsObjectTerminated,`Instance [${i.id}] has been termiated.`),y(i,ae,"f")):y(i,ae,"f")&&y(i,ae,"f").alive?y(i,ae,"f"):void(Ai.Instance?Ai.Instance.getWorker(y(i,se,"f"),y(i,he,"f")).then((e=>{var n;if(x(i,ae,e.worker,"f"),y(i,ae,"f")&&y(i,ae,"f").alive)y(i,xe,"f")!=y(i,ae,"f").id&&(0!==y(i,xe,"f")&&i._workerChanged(y(i,ae,"f").id),x(i,xe,y(i,ae,"f").id,"f")),y(i,re,"f").length>0&&setTimeout((()=>{y(i,ee,"m",Ce).call(i);}),0);else {let e=null===(n=Ai.Instance)||void 0===n?void 0:n.getModuleLoadedError(y(i,se,"f").name);if(null==e?void 0:e.code)return i._cancelAllTasks(A.wasmJsNotLoaded,e.message),y(i,ae,"f");y(i,re,"f").length>0&&x(i,ce,setTimeout(y(i,ee,"m",t),50,i),"f");}return y(i,ae,"f")})).catch((t=>y(i,ae,"f"))):i._cancelAllTasks(A.wasmJsNotLoaded,"wasm env not loaded or unloaded"))},Ce=function(){if(bi.logAll(y(this,re,"f")),y(this,fe,"f")!=C.init)if(y(this,ae,"f")&&y(this,ae,"f").alive){if(y(this,re,"f").length>0&&(y(this,fe,"f")===C.ready||"init"===y(this,re,"f")[0].func)){const t=y(this,re,"f").shift();this._execTask(t);}}else {if(y(this,ae,"f")&&!y(this,ae,"f").alive&&y(this,re,"f").length>0&&"init"!=y(this,re,"f")[0].func)return x(this,ae,null,"f"),void y(this,ee,"m",Ae).call(this);y(this,re,"f").length>0&&y(this,se,"f").script&&y(this,ee,"m",Se).call(this,this);}else y(this,ee,"m",Ae).call(this);},Pe=function(t,e,i,n){return i?ki.newBlobInChunks(t,e,n):void 0===n||n===t.byteLength?t:t.slice(0,n)},Te=function(t){try{return "string"==typeof t?JSON.parse(t):t}catch(e){return t}},Ae=function(){let t=this;t._prepareModule(y(this,se,"f"));let e=this._createTask("init");e.params.key=y(this,oe,"f"),e.params.uuid=y(this,ye,"f"),e.params.licMode=y(this,me,"f"),e.params.val={nv:y(this,de,"f"),mb:y(this,ue,"f"),dm:y(this,pe,"f")},e.handleResult=function(t,e){return x(e.context,fe,C.ready,"f"),t},x(this,fe,C.pending,"f"),this._addTask(e,!0),e.promise.then((function(e){bi.logD("["+t.id+"] "+y(t,se,"f").name+" init return: "),bi.logD(e),x(t,we,!1,"f");})).catch((function(e){x(t,fe,C.failed,"f"),x(t,ge,e.message,"f"),bi.logD(y(t,se,"f").name+" init failed"),bi.logD(e),t._cancelAllTasks(A.wasmJsObjectInitFailed,e.message);}));},ke=function(){if(y(this,fe,"f")==C.pending||y(this,fe,"f")==C.ready){let t=this._createTask("destroy",null,this._handleBooleanResult);return this._addTask(t),t.promise}return Promise.resolve(!0)},ne={value:0};class Di extends Ei{constructor(t,e){super(t,e);}_prepareModule(t){Ai.Instance.addModules(t);}}class Ri extends Di{constructor(t){super(Si.ImageIOModule,t),Ee.add(this),De.set(this,0);}getImageFormat(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetImageFormat");const n=yield e._readFile(t);return i.params.input=n,e._addTask(i),i.promise}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("ReadImageInfo");const n=yield e._readFile(t);return i.params.input=n,e._addTask(i),i.promise}))}getMD5(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetMD5");const n=yield e._readFile(t);return i.params.input=n,i.handleResult=function(t,e){return t.MD5},e._addTask(i),i.promise}))}getLicenseInfo(){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("GetLicenseInfo"))}))}getAesResult(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:"",this._addTask(this._createTask("GetAesResult",[t]))}))}saveImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){return (s=null!=s&&s)?y(this,Ee,"m",Re).call(this,t,void 0,void 0,void 0,1,void 0,void 0,e,i,n):y(this,Ee,"m",Re).call(this,t,void 0,void 0,void 0,void 0,void 0,void 0,e,i,n)}))}readImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._outputType,i=null!=i?i:this._jpegQuality,n=null!=n&&n,s=null!=s&&s;let o=this,r=o._createTask("ReadImage");const a=yield o._readFile(t);r.params.input=[a,e,i,s],r.params.returnType=n?E.RT_BASE64:E.RT_AUTO,r.params.returnBlob=!n,r.handleResult=o._handleImageData,o._addTask(r);const l=yield r.promise;if(l.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete l.srcBuffer;}return l}))}openTiff(t,e){return m(this,void 0,void 0,(function*(){let i=this,n=i._createTask("LoadTiff");e=null!=e&&e;const s=yield i._readFile(t);n.params.input=[s,e],i._addTask(n);const o=yield n.promise;if(o.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete o.srcBuffer;}return o}))}readTiff(t,e,i,n){t=null!=t?t:0,e=null!=e?e:this._outputType,i=null!=i&&i,n=null!=n&&n;let s=this._createTask("ReadTiffPage");return s.params.input=[t,e,n],s.params.returnType=i?E.RT_BASE64:E.RT_AUTO,s.params.returnBlob=!i,s.handleResult=this._handleImageData,this._addTask(s)}readTiffInfos(t){let e=this._createTask("GetTiffPageInfos");return e.params.input=[t],this._addTask(e)}closeTiff(){return this._addTask(this._createTask("EndReadTiff",null,this._handleBooleanResult))}createTiff(){return this._addTask(this._createTask("NewTiff",null,this._handleBooleanResult))}appendImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._inputType,i=null!=i?i:y(this,De,"f"),n=null!=n?n:this._jpegQuality,s=null!=s&&s;let o=this,r=o._createTask("AppendImageToTiff");const a=yield o._readFile(t);return r.params.input=[a,e,i,n,s],r.handleResult=o._handleBooleanResult,o._addTask(r),r.promise}))}addTag(t,e,i){return i=null!=i&&i,this._addTask(this._createTask("AddTagToNextPage",[t,e,i],this._handleBooleanResult))}getTiff(t){let e=this._createTask("GetTiffStream");return e.handleResult=this._handleImageData,e.params.returnType=null!=t?t:E.RT_AUTO,e.params.returnBlob=t!=E.RT_AUTO,this._addTask(e)}getMemoryUsed(){return this._addTask(this._createTask("getMemoryUsed",null,(function(t,e){return t.memoryUsed})))}getMultiPartFile(t,e){return this._addTask(this._createTask("ds_get_file",[t,e],(function(t,e){return t})))}}De=new WeakMap,Ee=new WeakSet,Re=function(t,e,i,n,s,o,r,a,l,h){return m(this,void 0,void 0,(function*(){let c=this;e=null!=e?e:this._inputType,i=null!=i?i:0,n=null!=n?n:0,s=null!=s?s:24,o=null!=o?o:96,r=null!=r?r:96,a=null!=a?a:this._outputType,l=null!=l?l:this._jpegQuality,h=null!=h?h:E.RT_AUTO;let d=c._createTask("SaveImage");const u=yield c._readFile(t);return d.params.input=[u,e,i,n,s,o,r,a,l],d.params.returnType=h,d.params.returnBlob=h!=E.RT_BASE64,d.handleResult=c._handleImageData,c._addTask(d),d.promise}))};class Ii extends Di{constructor(t){super(Si.ImageReadereModule,t),Ie.add(this),Me.set(this,0),Be.set(this,!1),Ue.set(this,null),Le.set(this,void 0),Oe.set(this,0),We.set(this,void 0),Ne.set(this,void 0);}workerChanged(t){x(this,Be,!1,"f"),t&&(bi.logD("["+this.id+"] worker changed to "+t),x(this,Oe,t,"f"));}setExternalWorkerChanged(t,e){x(this,We,t,"f"),x(this,Ne,e,"f");}_workerChanged(t){this.workerChanged(t),y(this,We,"f")&&y(this,We,"f").call(this,y(this,Ne,"f"),this,t);}_canTerminateWork(){return !0}makeSureWorkerMemoryNotExceed(){this._makeSureWorkerMemoryNotExceed()||(x(this,Be,!1,"f"),y(this,We,"f")&&y(this,We,"f").call(this,y(this,Ne,"f"),this));}getImageFormat(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetImageFormat");const n=yield e._readFile(t.fileSource);return i.params.input=n,e._addTask(i),i.promise}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("ReadImageInfo");const n=yield e._readFile(t.fileSource);return i.params.input=n,e._addTask(i),i.promise}))}readImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._outputType,i=null!=i?i:this._jpegQuality,n=null!=n&&n,s=null!=s&&s;let o=this,r=o._createTask("ReadImage");const a=yield o._readFile(t.fileSource);r.params.input=[a,e,i,s],r.params.returnType=n?E.RT_BASE64:E.RT_AUTO,r.params.returnBlob=!n,r.handleResult=o._handleImageData,o._addTask(r);const l=yield r.promise;if(l.srcBuffer){let e=Object.prototype.toString.call(t.fileSource);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete l.srcBuffer;}return l}))}openTiff(t,e){return m(this,void 0,void 0,(function*(){e=null!=e&&e;let i,n=this,s=n._createTask("LoadTiff");t!=y(this,Ue,"f")&&(t instanceof Blob?x(n,Ue,t,"f"):(i=yield n._readFile(t),x(n,Ue,ki.newBlobInChunks(i),"f"))),y(n,Ue,"f").size>1024*Si.FileReadModeSize*1024?s.params.input=[y(n,Ue,"f"),e]:(i||(i=yield n._readFile(y(n,Ue,"f"))),s.params.input=[i,e]),n._addTask(s);const o=yield s.promise;if(x(n,Be,!0,"f"),o.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete o.srcBuffer;}return x(n,Le,{pageCount:o.pageCount},"f"),o}))}readTiffPage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){yield y(this,Ie,"m",_e).call(this,t.fileSource),e=null!=e?e:0,i=null!=i?i:this._outputType,n=null!=n&&n,s=null!=s&&s;let o=this._createTask("ReadTiffPage");return o.params.input=[e,i,s],o.params.returnType=n?E.RT_BASE64:E.RT_AUTO,o.params.returnBlob=!n,o.handleResult=this._handleImageData,this._addTask(o)}))}getTiffInfo(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,Ie,"m",_e).call(this,t.fileSource),y(this,Le,"f")}))}getTiffPageInfos(t,e){return m(this,void 0,void 0,(function*(){yield y(this,Ie,"m",_e).call(this,t.fileSource);let i=this._createTask("GetTiffPageInfos");return i.params.input=[e],this._addTask(i)}))}}Me=new WeakMap,Be=new WeakMap,Ue=new WeakMap,Le=new WeakMap,Oe=new WeakMap,We=new WeakMap,Ne=new WeakMap,Ie=new WeakSet,_e=function(t){return m(this,void 0,void 0,(function*(){if(this.makeSureWorkerMemoryNotExceed(),y(this,Be,"f")){if(y(this,Ue,"f")===t)return void bi.logD("["+this.id+"] already opened in "+this.workerId);yield y(this,Ie,"m",Fe).call(this);}bi.logD("["+this.id+"] reopen in worker "+this.workerId),yield this.openTiff(t,!1);}))},Fe=function(){if(x(this,Ue,null,"f"),y(this,Be,"f"))return x(this,Be,!1,"f"),this._addTask(this._createTask("EndReadTiff",null,this._handleBooleanResult))};class Mi{static decode(t){const e={encodeChars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",decodeChars:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1]};function i(t){let e,i,n,s,o,r,a,l=[],h=t.length;for(e=0;e<h;e++)s=t.charCodeAt(e),s>>7&255?6==(s>>5&255)?(o=t.charCodeAt(++e),i=(31&s)<<6,n=63&o,a=i|n,l.push(String.fromCharCode(a))):14==(s>>4&255)&&(o=t.charCodeAt(++e),r=t.charCodeAt(++e),i=s<<4|o>>2&15,n=(3&o)<<6|63&r,a=(255&i)<<8|n,l.push(String.fromCharCode(a))):l.push(t.charAt(e));return l.join("")}return function(t){let n,s,o,r,a=[],l=0,h=t.length;for(;l<h;){do{n=e.decodeChars[255&t.charCodeAt(l++)];}while(l<h&&-1==n);if(-1==n)break;do{s=e.decodeChars[255&t.charCodeAt(l++)];}while(l<h&&-1==s);if(-1==s)break;a.push(String.fromCharCode(n<<2|(48&s)>>4));do{if(o=255&t.charCodeAt(l++),61==o)return i(a.join(""));o=e.decodeChars[o];}while(l<h&&-1==o);if(-1==o)break;a.push(String.fromCharCode((15&s)<<4|(60&o)>>2));do{if(r=255&t.charCodeAt(l++),61==r)return i(a.join(""));r=e.decodeChars[r];}while(l<h&&-1==r);if(-1==r)break;a.push(String.fromCharCode((3&o)<<6|r));}return i(a.join(""))}(t)}}!function(t){t[t.render=1]="render",t[t.extractImageOnly=2]="extractImageOnly",t[t.auto=3]="auto",t[t.renderWithAnnot=4]="renderWithAnnot";}(ri||(ri={}));class Bi extends Ei{constructor(t){super(Si.PdfReaderModule,t),He.add(this),$e.set(this,void 0),je.set(this,void 0),Ge.set(this,0),Ye.set(this,200),qe.set(this,3),Je.set(this,!1),Ze.set(this,void 0),Qe.set(this,null),Ke.set(this,""),this._outputType=k.IT_ALL;}static get fonts(){return y(this,Ve,"f",ze)}static addPdfFont(t,e){return m(this,void 0,void 0,(function*(){return y(this,Ve,"m",Xe).call(this,t,e)}))}static getPdfFonts(){return this.fonts?Object.keys(this.fonts):[]}static removeFont(){x(this,Ve,Object.create(null),"f",ze);}workerChanged(t){x(this,Je,!1,"f"),t&&(bi.logD("["+this.id+"] worker changed to "+t),x(this,Ge,t,"f"));}setExternalWorkerChanged(t,e){x(this,$e,t,"f"),x(this,je,e,"f");}_workerChanged(t){this.workerChanged(t),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this,t);}_canTerminateWork(){return !0}makeSureWorkerMemoryNotExceed(){this._makeSureWorkerMemoryNotExceed()||(x(this,Je,!1,"f"),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this));}makeSureWorkerChanged(){this._makeSureWorkerChanged()&&(x(this,Je,!1,"f"),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this));}getPdfInfo(t){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),y(this,Ze,"f")}))}readPage(t,e,i,n,s,o,r,a){return m(this,void 0,void 0,(function*(){return this.readPageEx(t,e,{convertMode:n,renderOptions:{resolution:i}},s,o,r,a)}))}readPageEx(t,e,i,n,s,o,r){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0,n=null!=n?n:this._outputType,o=null!=o&&o,s=null!=s&&s,r=null!=r&&r;let a=i?JSON.stringify(i):"{}",l=this._createTask("ReadPdfPageEx");return l.params.input=[e,a,n,s,r],l.params.returnType=o?E.RT_BASE64:E.RT_AUTO,l.params.returnBlob=!o,l.handleResult=this._handleImageData,this._addTask(l)}))}renderPage(t,e,i,n,s){var o,r,a,l,h;return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0;const c=null!==(o=null==s?void 0:s.outputType)&&void 0!==o?o:k.IT_RGBA,d=null!==(r=null==s?void 0:s.rect)&&void 0!==r?r:null,u=null!==(a=null==s?void 0:s.returnBase64)&&void 0!==a&&a,p=null!==(l=null==s?void 0:s.returnBlob)&&void 0!==l?l:c!=k.IT_RGBA,g=null!==(h=null==s?void 0:s.is1BitTo8Bit)&&void 0!==h&&h;let f=(null==s?void 0:s.renderOptions)?JSON.stringify(s.renderOptions):"{}",v=this._createTask("RenderPdfPage");return v.params.input=[e,f,d,i,n,c,g],v.params.returnType=u?E.RT_BASE64:E.RT_AUTO,v.params.returnBlob=p,v.handleResult=this._handleImageData,this._addTask(v)}))}readPageImageInfos(t,e,i,n){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),n=null!=n?n:this._outputType;let s=i?JSON.stringify(i):"{}",o=this._createTask("ReadPageImageInfos");return o.params.input=[e,s,n],this._addTask(o)}))}readPageAnnot(t,e){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0;let i=this._createTask("GetPageAnnot",[e]);return this._addTask(i)}))}findText(t,e,i,n){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t);let s=0;return n&&(n.matchCase&&(s|=1),n.matchWholeWord&&(s|=2),n.consecutive&&(s|=4)),this._addTask(this._createTask("SearchText",[e,i,s]))}))}getCharInfos(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPageCharInfos",[e]))}))}getPageInfos(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPdfPageInfos",[e]))}))}getPdfPageType(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPageContentType",[e]))}))}UnloadPage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("UnloadPdfPage",[t]))}))}}Ve=Bi,$e=new WeakMap,je=new WeakMap,Ge=new WeakMap,Ye=new WeakMap,qe=new WeakMap,Je=new WeakMap,Ze=new WeakMap,Qe=new WeakMap,Ke=new WeakMap,He=new WeakSet,Xe=function(t,e){return m(this,void 0,void 0,(function*(){if("string"==typeof t&&0!==t.length||Promise.reject("The 'name' should be a valid string"),void 0===y(this,Ve,"f",ze)[t])if(e instanceof Blob)y(this,Ve,"f",ze)[t]=e;else {const i=yield Ci.read(e);y(this,Ve,"f",ze)[t]=ki.newBlobInChunks(i);}}))},ti=function(t){var e,i;return m(this,void 0,void 0,(function*(){if(this.makeSureWorkerMemoryNotExceed(),y(this,Je,"f")){if(y(this,Qe,"f")===t.fileSource)return void bi.logD("["+this.id+"] already opened in "+this.workerId);yield y(this,He,"m",oi).call(this);}bi.logD("["+this.id+"] reopen in worker "+this.workerId),yield y(this,He,"m",si).call(this,null!==(e=t.fileSource)&&void 0!==e?e:y(this,Qe,"f"),null!==(i=t.password)&&void 0!==i?i:y(this,Ke,"f"));}))},ei=function(){return m(this,void 0,void 0,(function*(){if(0===y(this,Ge,"f")||y(this,Ge,"f")!==this.workerId){if(bi.logD("["+this.id+"] load font in worker "+this.workerId),Si.FontUseFileReadMode.load)return yield y(this,He,"m",ii).call(this);const t=Bi.fonts,e=Object.keys(t);for(let i of e){const e=t[i],n=yield Ci.read(e);n&&(yield y(this,He,"m",ni).call(this,i,n));}}}))},ii=function(){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("SetSystemFonts",[Bi.fonts]))}))},ni=function(t,e){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("AddSystemFont",[t,e]))}))},si=function(t,e){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ei).call(this),e=null!=e?e:"";let i,n=this,s=n._createTask("LoadPdf");return t!==y(n,Qe,"f")||e!==y(n,Ke,"f")?(t instanceof Blob?x(n,Qe,t,"f"):(i=yield n._readFile(t),x(n,Qe,ki.newBlobInChunks(i),"f")),x(n,Ke,e,"f")):e=y(n,Ke,"f"),y(n,Qe,"f").size>1024*Si.FileReadModeSize*1024?s.params.input=[y(n,Qe,"f"),e]:(i||(i=yield n._readFile(y(n,Qe,"f"))),s.params.input=[i,e]),s.handleResult=function(e,i){if(e.srcBuffer){let i=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=i&&"[object Uint8ClampedArray]"!=i&&delete e.srcBuffer;}let s=Mi.decode(e.infoBase64);try{let t;try{s.replace(new RegExp("\\\\","gi"),"\\\\"),t=JSON.parse(s);}catch(e){t=s;}let i={PdfCount:e.pageCount,PdfInfo:t,isTextBased:e.isTextBased};return e.srcBuffer&&(i.srcBuffer=e.srcBuffer,delete e.srcBuffer),x(n,Je,!0,"f"),x(n,Ze,i,"f"),i}catch(e){i.reject({code:A.wasmJsInvalidJson,message:e.message,stack:e.stack});}},n._addTask(s)}))},oi=function(){return m(this,void 0,void 0,(function*(){if(x(this,Qe,null,"f"),x(this,Ke,"","f"),y(this,Je,"f"))return x(this,Je,!1,"f"),this._addTask(this._createTask("UnloadDocument",null,this._handleBooleanResult))}))},ze={value:Object.create(null)};const Ui=["readPdfPage","readTiffPage","readImage"];class Li{constructor(t){this.items=[],t&&(this.items=t);}push(t){this.items.push(t);}pop(){return this.items.pop()}peek(){return this.items[this.items.length-1]}isEmpty(){return 0===this.items.length}size(){return this.items.length}add(t){let e;-1!==Ui.indexOf(t.api)&&this.push(t);for(let i of this.items)i.api===t.api&&i.params[0]===t.params[0]&&i.params[1]===t.params[1]&&(e=i);e?(e.resolves=[...e.resolves,...t.resolves],e.rejects=[...e.rejects,...t.rejects]):this.push(t);}remove(t){-1!==Ui.indexOf(t.api)&&this.items.forEach(((e,i)=>{e.api===t.api&&e.params[0]===t.params[0]&&e.params[1]===t.params[1]&&this.items.splice(i,1).forEach((t=>{null==t||t.resolves.forEach((t=>{t(null);}));}));}));}}class Oi{static unload(){if(x(this,ai,[],"f",li),x(this,ai,new Li,"f",hi),x(this,ai,!1,"f",ui),x(this,ai,0,"f",fi),x(this,ai,!1,"f",vi),Bi.removeFont(),y(this,ai,"f",ci)){bi.logD("pdfReader destroy");const t=y(this,ai,"f",ci);x(this,ai,null,"f",ci),t.terminate();}if(y(this,ai,"f",di)){bi.logD("imageReader destroy");const t=y(this,ai,"f",di);x(this,ai,null,"f",di),t.terminate();}}static updateLicense(t,e,i){return m(this,void 0,void 0,(function*(){let n=[];return y(this,ai,"f",ci)&&n.push(y(this,ai,"f",ci).updateLicense(t,e,i)),y(this,ai,"f",di)&&n.push(y(this,ai,"f",di).updateLicense(t,e,i)),Promise.all(n)}))}static add(t){return m(this,void 0,void 0,(function*(){y(this,ai,"f",li).push(t),y(this,ai,"f",ci)||(x(this,ai,new Bi,"f",ci),y(this,ai,"f",ci).setExternalWorkerChanged(y(Oi,ai,"m",mi),this),this.initPdfReaderFunctionMap()),y(this,ai,"f",di)||(x(this,ai,new Ii,"f",di),y(this,ai,"f",di).setExternalWorkerChanged(y(Oi,ai,"m",mi),this),this.initImageReaderFunctionMap());}))}static addFont(t,e){return m(this,void 0,void 0,(function*(){Bi.addPdfFont(t,e);}))}static getFonts(){return Bi.getPdfFonts()}static delete(t){const e=y(this,ai,"f",li).indexOf(t);if(e>=0&&(y(this,ai,"f",li).splice(e,1),0===y(this,ai,"f",li).length&&!y(this,ai,"f",ui))){if(y(this,ai,"f",ci)){bi.logD("pdfReader destroy");const t=y(this,ai,"f",ci);x(this,ai,null,"f",ci),t.terminate();}if(y(this,ai,"f",di)){bi.logD("imageReader destroy");const t=y(this,ai,"f",di);x(this,ai,null,"f",di),t.terminate();}}}static createTask(t,e){const i={api:t,params:[],promise:[],resolves:[],rejects:[],retry:0};for(const t of e)i.params.push(t);const n=new Promise((function(t,e){i.resolves.push(t),i.rejects.push(e);}));return i.promise.push(n),y(this,ai,"m",yi).call(this,i),n}static cancelTask(t,e){if(-1!==Ui.indexOf(t)){const i={api:t,params:[],promise:[],resolves:[],rejects:[],retry:0};for(const t of e)i.params.push(t);y(this,ai,"f",hi).remove(i);}}static initPdfReaderFunctionMap(){var t,e,i,n,s,o,r,a,l;y(this,ai,"f",pi).findPdfText=null===(t=y(this,ai,"f",ci))||void 0===t?void 0:t.findText,y(this,ai,"f",pi).getPdfPageInfos=null===(e=y(this,ai,"f",ci))||void 0===e?void 0:e.getPageInfos,y(this,ai,"f",pi).getPdfInfo=null===(i=y(this,ai,"f",ci))||void 0===i?void 0:i.getPdfInfo,y(this,ai,"f",pi).readPdfPageAnnot=null===(n=y(this,ai,"f",ci))||void 0===n?void 0:n.readPageAnnot,y(this,ai,"f",pi).readPdfPage=null===(s=y(this,ai,"f",ci))||void 0===s?void 0:s.readPageEx,y(this,ai,"f",pi).readPdfPageImageInfos=null===(o=y(this,ai,"f",ci))||void 0===o?void 0:o.readPageImageInfos,y(this,ai,"f",pi).getPdfCharInfos=null===(r=y(this,ai,"f",ci))||void 0===r?void 0:r.getCharInfos,y(this,ai,"f",pi).getPdfPageType=null===(a=y(this,ai,"f",ci))||void 0===a?void 0:a.getPdfPageType,y(this,ai,"f",pi).renderPdfPage=null===(l=y(this,ai,"f",ci))||void 0===l?void 0:l.renderPage;}static initImageReaderFunctionMap(){var t,e,i,n,s,o;y(this,ai,"f",gi).readImage=null===(t=y(this,ai,"f",di))||void 0===t?void 0:t.readImage,y(this,ai,"f",gi).getImageFormat=null===(e=y(this,ai,"f",di))||void 0===e?void 0:e.getImageFormat,y(this,ai,"f",gi).readImageInfo=null===(i=y(this,ai,"f",di))||void 0===i?void 0:i.readImageInfo,y(this,ai,"f",gi).getTiffInfo=null===(n=y(this,ai,"f",di))||void 0===n?void 0:n.getTiffInfo,y(this,ai,"f",gi).readTiffPage=null===(s=y(this,ai,"f",di))||void 0===s?void 0:s.readTiffPage,y(this,ai,"f",gi).getTiffPageInfos=null===(o=y(this,ai,"f",di))||void 0===o?void 0:o.getTiffPageInfos;}}ai=Oi,mi=function(t,e,i){let n=null!=t?t:this;y(n,ai,"f",ci)&&y(n,ai,"f",ci)!==e&&y(n,ai,"f",ci).workerChanged(i),y(n,ai,"f",di)&&y(n,ai,"f",di)!==e&&y(n,ai,"f",di).workerChanged(i);},yi=function(t){y(this,ai,"f",hi).add(t),y(this,ai,"f",ui)||(x(this,ai,!0,"f",ui),y(this,ai,"m",wi).call(this));},xi=function(){try{y(this,ai,"f",di)&&y(this,ai,"f",di).makeSureWorkerMemoryNotExceed(),y(this,ai,"f",ci)&&y(this,ai,"f",ci).makeSureWorkerMemoryNotExceed();}catch(t){}},wi=function(){return m(this,void 0,void 0,(function*(){do{if(y(this,ai,"f",hi).isEmpty()||!y(this,ai,"f",ci)||!y(this,ai,"f",di))break;const t=y(this,ai,"f",hi).pop();if(t)try{let e,i=y(this,ai,"f",pi)[t.api];if(i){const i=this.getFonts().length;y(this,ai,"f",fi)!==i&&(y(this,ai,"f",vi)&&(y(this,ai,"f",ci).makeSureWorkerChanged(),x(this,ai,!1,"f",vi)),x(this,ai,i,"f",fi)),e=yield y(this,ai,"f",pi)[t.api].apply(y(this,ai,"f",ci),t.params),y(this,ai,"f",ci).makeSureWorkerMemoryNotExceed(),x(this,ai,!0,"f",vi);}else i=y(this,ai,"f",gi)[t.api],i&&(e=yield y(this,ai,"f",gi)[t.api].apply(y(this,ai,"f",di),t.params),y(this,ai,"f",di).makeSureWorkerMemoryNotExceed());null==t||t.resolves.forEach((t=>{t(e);}));}catch(e){bi.logD(e),t.retry<1&&-80202!==(null==e?void 0:e.code)?(t.retry+=1,y(this,ai,"m",xi).call(this),y(this,ai,"f",hi).push(t)):null==t||t.rejects.forEach((t=>{t(e);}));}}while(!y(this,ai,"f",hi).isEmpty());x(this,ai,!1,"f",ui);}))},li={value:[]},hi={value:new Li},ci={value:void 0},di={value:void 0},ui={value:!1},pi={value:Object.create(null)},gi={value:Object.create(null)},fi={value:0},vi={value:!1};class Wi{constructor(){Oi.add(this);}destroy(){Oi.delete(this);}readImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){return Oi.createTask("readImage",[t,e,i,n,s])}))}getImageFormat(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getImageFormat",[t])}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("readImageInfo",[t])}))}cancelReadImage(t,e){return Oi.cancelTask("readImage",[t,e])}getTiffInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getTiffInfo",[t,!1])}))}readTiffPage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){return Oi.createTask("readTiffPage",[t,e,i,n,s])}))}cancelReadTiffPage(t,e){return Oi.cancelTask("readTiffPage",[t,e])}getTiffPageInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getTiffPageInfos",[t,e])}))}}var Ni,_i,Fi,Hi,Vi,zi,$i,ji,Xi,Gi,Yi,qi,Ji,Zi,Qi,Ki,tn,en,nn,sn;!function(t){t[t.NearestNeighbour=1]="NearestNeighbour",t[t.Bilinear=2]="Bilinear",t[t.Bicublic=3]="Bicublic",t[t.BestQuality=5]="BestQuality";}(Fi||(Fi={}));class on extends Di{constructor(t){super(Si.ImageProcModule,t),Ni.add(this);}initImage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){e=null!=e&&e,i=null!=i?i:0,n=null!=n?n:0,s=null!=s&&s;let o=this,r=o._createTask("InitImageObject");if(r.params.input=[t,i,n],e||s)e?r.params.input.push(k.IT_RGBA):r.params.input.push(k.IT_BGRA),o._addTask(r);else {const e=yield o._readFile(t);r.params.input[0]=e,r.params.input.push(k.IT_ALL),o._addTask(r);}const a=yield r.promise;if(a.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete a.srcBuffer;}return a}))}restore(){return this._addTask(this._createTask("BackToOriginal",null,this._handleBooleanResult))}filter(t,e,i){var n,s,o,r,a,l,h,c,d,u;let p=this;e=null!=e?e:{},i=null!=i?i:{};let g=p._createTask("Filter");if(g.params.input=[],g.params.input.push(t),"toBW"===t)g.params.input.push(JSON.stringify(y(p,Ni,"m",_i).call(p,e)));else if("toGray"===t)g.params.input.push(JSON.stringify(y(p,Ni,"m",_i).call(p,e)));else if("removeShadow"===t)g.params.input.push(JSON.stringify(y(p,Ni,"m",_i).call(p,e)));else if("enhance"===t)g.params.input.push(JSON.stringify(y(p,Ni,"m",_i).call(p,e)));else if("invert"===t)g.params.input.push(JSON.stringify(y(p,Ni,"m",_i).call(p,e)));else if("brightnessAndContrast"===t){let t=null!==(n=e.brightness)&&void 0!==n?n:0,i=null!==(s=e.contrast)&&void 0!==s?s:0;g.params.input.push(t),g.params.input.push(i);}let f=null!==(o=i.returnType)&&void 0!==o?o:k.IT_JPG,v=null!==(r=i.jpegQuality)&&void 0!==r?r:this._jpegQuality,m=null!==(a=i.bRGBA)&&void 0!==a&&a,x=null!==(l=i.bitDepth)&&void 0!==l?l:0,w=null!==(h=i.xdpi)&&void 0!==h?h:0,b=null!==(c=i.ydpi)&&void 0!==c?c:0,S=null===(d=i.returnBlob)||void 0===d||d;f=m&&null==f?k.IT_JPG:null!=f?f:k.IT_ALL;let C=null!==(u=i.is1BitTo8Bit)&&void 0!==u&&u;return g.params.input.push([f,x,w,b,!1,v,!1,C]),g.params.returnBlob=S,g.handleResult=this._handleImageData,p._addTask(g),g.promise}rotate(t,e,i,n){return t=null!=t?t:0,i=null!=i&&i,n=null!=n?n:Fi.Bicublic,e=null!=e?e:"FFFFFF",(t<0||t>360)&&(t%=360)<0&&(t+=360),this._addTask(this._createTask("RotateEx",[t,i,n,e],this._handleBooleanResult))}flip(t){t=null!=t?t:1;let e=this._createTask("");return e.handleResult=this._handleBooleanResult,1===t?e.func="Flip":-1===t&&(e.func="Mirror"),this._addTask(e),e.promise}erase(t,e,i,n,s){let o=this,r=o._createTask("Erase");return r.handleResult=this._handleBooleanResult,r.params.input=[t,e,i,n,JSON.stringify(y(o,Ni,"m",_i).call(o,s))],o._addTask(r),r.promise}crop(t,e,i,n){return this._addTask(this._createTask("Crop",[t,e,i,n],this._handleBooleanResult))}resize(t,e,i){return i=null!=i?i:Fi.BestQuality,this._addTask(this._createTask("ChangeImageSize",[t,e,i],this._handleBooleanResult))}toGrayscaleLevel(t){(t=null!=t?t:1)<1&&(t=1),t>3&&(t=3);let e={};return 2===t?(e.clean=!0,e.sigma=3,e.scaleLimit=720,e.alpha=1.05):3===t&&(e.clean=!0,e.sigma=5,e.scaleLimit=1080,e.alpha=1.05),this.toGrayscale(e)}toGrayscale(t){return this._addTask(this._createTask("ConvertToGrayScale",JSON.stringify(y(this,Ni,"m",_i).call(this,t)),this._handleBooleanResult))}toBinaryLevel(t,e){(e=null!=e?e:1)<1&&(e=1),e>3&&(e=3);let i={};return null!=t&&(t?i.method="adaptiveThreshold":(i.method="threshold",2===e?(i.clean=!0,i.sigma=3,i.scaleLimit=720,i.alpha=1.05):3===e&&(i.clean=!0,i.sigma=5,i.scaleLimit=1080,i.alpha=1.05))),this.toBinary(i)}toBinary(t){return this._addTask(this._createTask("ConvertToBW",JSON.stringify(y(this,Ni,"m",_i).call(this,t)),this._handleBooleanResult))}invert(){return this._addTask(this._createTask("Invert",null,this._handleBooleanResult))}setImageWidth(t,e){return this._addTask(this._createTask("SetImageWidth",[t,JSON.stringify(y(this,Ni,"m",_i).call(this,e))],this._handleBooleanResult))}setImageHeight(t,e){return this._addTask(this._createTask("SetImageHeight",[t,JSON.stringify(y(this,Ni,"m",_i).call(this,e))],this._handleBooleanResult))}setDPI(t,e,i,n,s,o){return s=null!=s&&s,o=null!=o?o:Fi.Bilinear,this._addTask(this._createTask("SetDPI",[t,e,i,n,s,o],this._handleBooleanResult))}getImage(t,e,i,n,s,o,r,a,l){t=null!=t?t:this._jpegQuality,e=null==e||e,n=null!=n?n:0,s=null!=s?s:0,o=null!=o?o:0,r=null==r||r,a=(i=null!=i&&i)&&null==a?k.IT_JPG:null!=a?a:k.IT_ALL,l=null!=l&&l;let h=this._createTask("GetCurrentImage");return h.params.input=[a,n,s,o,!1,t,e,l],h.params.returnBlob=r,h.handleResult=this._handleImageData,this._addTask(h)}getSkewAngle(t){return this._addTask(this._createTask("GetSkewAngle",[JSON.stringify(y(this,Ni,"m",_i).call(this,t))],(function(t,e){return t.skewAngle})))}freeReservedData(){return this._addTask(this._createTask("FreeReservedData",null,this._handleBooleanResult))}detectDocument(t,e,i,n,s){return t=null!=t?t:Fi.Bilinear,e=null!=e?e:75,i=null!=i?i:100,n=null!=n?n:0,s=null!=s?s:"",this._addTask(this._createTask("DocumentDetect",[t,e/100,i,n/255,s,"1"]))}perspective(t,e,i,n,s,o,r,a){return this._addTask(this._createTask("Perspective",[t,e,i,n,s,o,r,a],this._handleBooleanResult))}changeBrightness(t,e){return t=null!=t?t:0,0!=(e=null!=e?e:1)&&1!=e&&(e=0),1===e?this._addTask(this._createTask("ChangeBrightnessAndContrast",[t,0],this._handleBooleanResult)):this._addTask(this._createTask("ChangeBrightness",[Math.floor(t/1e3*255)],this._handleBooleanResult))}changeContrast(t,e){return t=null!=t?t:0,0!=(e=null!=e?e:1)&&1!=e&&(e=0),1===e?this._addTask(this._createTask("ChangeBrightnessAndContrast",[0,t],this._handleBooleanResult)):this._addTask(this._createTask("ChangeContrast",[1+t/1e3],this._handleBooleanResult))}changeBrightnessAndContrast(t,e){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("ChangeBrightnessAndContrast",[t,e],this._handleBooleanResult))}removeShadowLevel(t,e){e=null!=e?e:1.05,(t=null!=t?t:1)<1&&(t=1),t>3&&(t=3);let i={};return 1===t&&(i.sigma=3,i.scaleLimit=720,i.alpha=e),2===t?(i.sigma=5,i.scaleLimit=1080,i.alpha=e):3===t&&(i.sigma=10,i.scaleLimit=0,i.alpha=e),this.removeShadow(i)}removeShadow(t){return this._addTask(this._createTask("ShadowRemovel",[JSON.stringify(y(this,Ni,"m",_i).call(this,t))],this._handleBooleanResult))}enhanceAndSharpenImage(){return this._addTask(this._createTask("EnhanceAndSharpen",[""],this._handleBooleanResult))}brighten(){return this._addTask(this._createTask("Brighten",[""],this._handleBooleanResult))}getBlurryScore(){return this._addTask(this._createTask("GetBlurScore",[""],(function(t,e){return t.blurryScore})))}drawQuadrangle(t,e,i,n,s,o,r,a,l){return this._addTask(this._createTask("DrawQuadrangle",[t,e,i,n,s,o,r,a,JSON.stringify(y(this,Ni,"m",_i).call(this,l))],this._handleBooleanResult))}getImageInfo(){return this._addTask(this._createTask("GetImageInfo",[]))}}Ni=new WeakSet,_i=function(t){let e={};if(null!=t&&"object"==typeof t)for(let i in t)e[i]=t[i];return e};class rn{constructor(){Oi.add(this);}destroy(){Oi.delete(this);}static addPdfFont(t,e){return m(this,void 0,void 0,(function*(){return Oi.addFont(t,e)}))}static getPdfFonts(){return Oi.getFonts()}getPdfInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfInfo",[t])}))}getPdfPageType(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfPageType",[t,e])}))}readPage(t,e,i,n,s,o,r,a){return m(this,void 0,void 0,(function*(){return this.readPageEx(t,e,{convertMode:n,renderOptions:{resolution:i}},s,o,r,a)}))}readPageEx(t,e,i,n,s,o,r){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPage",[t,e,i,n,s,o,r])}))}renderPage(t,e,i,n,s){return m(this,void 0,void 0,(function*(){return Oi.createTask("renderPdfPage",[t,e,i,n,s])}))}cancelReadPage(t,e){return Oi.cancelTask("readPdfPage",[t,e])}readPageImageInfos(t,e,i,n,s,o,r){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPageImageInfos",[t,e,i,n,s,o,r])}))}readPageAnnot(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPageAnnot",[t,e])}))}findText(t,e,i,n){return m(this,void 0,void 0,(function*(){return Oi.createTask("findPdfText",[t,e,i,n])}))}getCharInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfCharInfos",[t,e])}))}getPageInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfPageInfos",[t,e])}))}}!function(t){t[t.auto=0]="auto",t[t.store=1]="store";}(ji||(ji={}));class an extends Di{constructor(t){super(Si.PdfWriterModule,t),Hi.add(this);}initPdfSetting(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("CreateDocument");return i.params.input=[JSON.stringify(y(e,Hi,"m",$i).call(e,t))],i.handleResult=this._handleBooleanResult,yield y(this,Hi,"m",Vi).call(this),e._addTask(i)}))}appendPage(t,e){return m(this,void 0,void 0,(function*(){let i=this,n=i._createTask("InsertImagePage");e=null!=e&&e;const s=yield i._readFile(t);return n.params.input=[s,-1,e],n.handleResult=i._handleBooleanResult,i._addTask(n),n.promise}))}insertPage(t,e,i){return m(this,void 0,void 0,(function*(){let n=this,s=n._createTask("InsertImagePage");i=null!=i&&i;const o=yield n._readFile(t);return s.params.input=[o,e,i],s.handleResult=n._handleBooleanResult,n._addTask(s),s.promise}))}writePdf(t){return m(this,void 0,void 0,(function*(){let e=this._createTask("GetCurrentPdf");return e.params.returnType=null!=t?t:E.RT_AUTO,e.params.returnBlob=t!=E.RT_AUTO,e.handleResult=this._handleImageData,this._addTask(e)}))}insertBlankPage(t,e,i){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:595,i=null!=i?i:842,this._addTask(this._createTask("InsertBlankPage",[t,e,i]))}))}insertBlankPages(t,e,i,n){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:595,i=null!=i?i:842,n=null!=n?n:1,this._addTask(this._createTask("InsertBlankPages",[t,e,i,n]))}))}deletePage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("DeletePage",[t],this._handleBooleanResult))}))}movePages(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:[],this._addTask(this._createTask("MovePages",[t,e],this._handleBooleanResult))}))}pageSetRotation(t,e){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,0!=(e=((e=null!=e?e:0)%360+360)%360)&&90!==e&&180!==e&&270!==e&&(e=0);let i=this._createTask("SetPageRotation");return i.params.input=[t,e],i.handleResult=this._handleBooleanResult,this._addTask(i)}))}pageSetCropBox(t,e,i,n,s){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,e=null!=e?e:0,i=null!=i?i:0,(n=null!=n?n:e)<e&&(n=e),(s=null!=s?s:i)<i&&(s=i);let o=this._createTask("SetPageCropBox");return o.params.input=[t,e,i,n,s],o.handleResult=this._handleBooleanResult,this._addTask(o)}))}pageSetMediaBox(t,e,i,n,s){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,e=null!=e?e:0,i=null!=i?i:0,(n=null!=n?n:e)<e&&(n=e),(s=null!=s?s:i)<i&&(s=i);let o=this._createTask("SetPageMediaBox");return o.params.input=[t,e,i,n,s],o.handleResult=this._handleBooleanResult,this._addTask(o)}))}pageAddImage(t,e,i,n,s,o){return m(this,void 0,void 0,(function*(){o=null!=o&&o;let r=this,a=r._createTask("PageAddImage"),l=JSON.stringify(y(r,Hi,"m",$i).call(r,i));const h=yield r._readFile(t);return a.params.input=[h,e,l,n,s,o],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}pageAddText(t,e){return m(this,void 0,void 0,(function*(){let i=JSON.stringify(e);return this._addTask(this._createTask("PageAddText",[t,i],this._handleBooleanResult))}))}pageAddPath(t,e){return m(this,void 0,void 0,(function*(){let i=JSON.stringify(e);return this._addTask(this._createTask("PageAddPath",[t,i],this._handleBooleanResult))}))}pageClearObjects(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("PageClearObjects",[t],this._handleBooleanResult))}))}pageSetAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("SetPageAnnot",[t,i],this._handleBooleanResult))}))}pageFlattenAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("FlattenPageAnnot",[t,i],this._handleBooleanResult))}))}getFontFromTextObject(t){return t.fontName?t.fontName:""}getFontFromAnnot(t){let e=[];t&&t.normalAppearance&&t.normalAppearance.objs&&t.normalAppearance.objs.forEach((t=>{if("text"===t.type){const i=t,n=this.getFontFromTextObject(i);n&&e.push(n);}}));const i=new Set(e);return e=[...i],e}getFontFromAnnots(t){let e=[];Array.isArray(t)?t.forEach((t=>{const i=this.getFontFromAnnot(t);e=e.concat(i);})):e=this.getFontFromAnnot(t);const i=new Set(e);return e=[...i],e}pageAddAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("PageAddAnnot",[t,i],this._handleBooleanResult))}))}pageDeleteAnnot(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("DeletePageAnnot",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotByTypes(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotByTypes",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotExceptTypes(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotExceptTypes",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotByNames(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotByNames",[t,e],this._handleBooleanResult))}))}mergePdf(t,e,i,n,s){return m(this,void 0,void 0,(function*(){n=null!=n?n:-1,i=null!=i?i:[],e=null!=e?e:"",s=null!=s&&s;let o,r=this,a=r._createTask("MergePdfPages");return o=t instanceof Blob?t:yield r._readFile(t),a.params.input=[o,n,e,i,s],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}replacePdfPages(t,e,i,n,s){return m(this,void 0,void 0,(function*(){i=null!=i?i:[],n=null!=n?n:[],e=null!=e?e:"",s=null!=s&&s;let o,r=this,a=r._createTask("ReplacePdfPages");return o=t instanceof Blob?t:yield r._readFile(t),a.params.input=[o,e,i,n,s],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}pageFlatten(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("PageFlatten",[t,e],this._handleBooleanResult))}))}GetFontInfo(t){return m(this,void 0,void 0,(function*(){const e=yield this._readFile(t);return this._addTask(this._createTask("GetFontInfo",[e]))}))}IfFontsExist(t){return m(this,void 0,void 0,(function*(){let e=JSON.stringify(t);return yield y(this,Hi,"m",Vi).call(this),this._addTask(this._createTask("IfFontsExist",[e]))}))}UnloadPage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("UnloadPdfPage",[t]))}))}}Hi=new WeakSet,Vi=function(){return m(this,void 0,void 0,(function*(){if(bi.logD("["+this.id+"] load font in worker "+this.workerId),0===Object.keys(Bi.fonts).length)return null;if(Si.FontUseFileReadMode.save)return this._addTask(this._createTask("LoadFonts",[Bi.fonts]));const t=Bi.fonts,e=Object.keys(t);for(let i of e){const e=t[i],n=yield Ci.read(e);n&&(yield y(this,Hi,"m",zi).call(this,i,n));}}))},zi=function(t,e){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("LoadFont",[e,t]))}))},$i=function(t){let e={};if(null!=t&&"object"==typeof t)for(let i in t)e[i]=t[i];return e},function(t){t.Text="Text",t.Link="Link",t.FreeText="FreeText",t.Line="Line",t.Square="Square",t.Circle="Circle",t.Polygon="Polygon",t.PolyLine="PolyLine",t.Hignlight="Highlight",t.Underline="Underline",t.Squiggly="Squiggly",t.StrikeOut="StrikeOut",t.Stamp="Stamp",t.Caret="Caret",t.Ink="Ink",t.Popup="Popup";}(Xi||(Xi={})),function(t){t.None="none",t.Invisible="invisible",t.Hidden="hidden",t.Print="print",t.NoZoom="nozoom",t.NoRotate="norotate",t.NoView="noview",t.ReadOnly="readonly",t.Locked="locked",t.ToggleNoView="togglenoview",t.LockedContents="lockedcontents";}(Gi||(Gi={})),function(t){t.Solid="S",t.Dashed="D",t.Beveled="B",t.Insert="I",t.Underline="U";}(Yi||(Yi={})),function(t){t.NoEffect="S",t.Cloudy="C";}(qi||(qi={})),function(t){t.Comment="Comment",t.Key="Key",t.Note="Note",t.Help="Help",t.NewParagraph="NewParagraph",t.Paragraph="Paragraph",t.Insert="Insert";}(Ji||(Ji={})),function(t){t.Marked="Marked",t.Review="Review";}(Zi||(Zi={})),function(t){t.Accepted="Accepted",t.Rejected="Rejected",t.Cancelled="Cancelled",t.Completed="Completed",t.None="None";}(Qi||(Qi={})),function(t){t.None="None",t.Square="Square",t.Circle="Circle",t.Diamond="Diamond",t.OpenArrow="OpenArrow",t.ClosedArrow="ClosedArrow",t.Butt="Butt",t.ROpenArrow="ROpenArrow",t.RClosedArrow="RClosedArrow",t.Slash="Slash";}(Ki||(Ki={})),function(t){t[t.LeftJustified=0]="LeftJustified",t[t.Centered=1]="Centered",t[t.RightJustified=2]="RightJustified";}(tn||(tn={})),function(t){t.FreeText="FreeText",t.FreeTextCallout="FreeTextCallout",t.FreeTextTypeWriter="FreeTextTypeWriter";}(en||(en={})),function(t){t.LineArrow="LineArrow",t.LineDimension="LineDimension";}(nn||(nn={})),function(t){t.Approved="Approved",t.Experimental="Experimental",t.NotApproved="NotApproved",t.Asls="Asls",t.Expired="Expired",t.NotForPublicRelease="NotForPublicRelease",t.Confidential="Confidential",t.Final="Final",t.Sold="Sold",t.Departmental="Departmental",t.ForComment="ForComment",t.TopSecret="TopSecret",t.Draft="Draft",t.ForPublicRelease="ForPublicRelease";}(sn||(sn={}));const ln="undefined"==typeof self,hn=ln?{}:self;let cn,dn,un,pn,gn;"undefined"!=typeof navigator&&(cn=navigator,dn=cn.userAgent,un=cn.platform,pn=cn.mediaDevices),function(){if(!ln){const t={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:cn.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},e={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:un,search:"Win"},Mac:{str:un},Linux:{str:un}};let i="unknownBrowser",n=0,s="unknownOS";for(let e in t){const s=t[e]||{};let o=s.str||dn,r=s.search||e,a=s.verStr||dn,l=s.verSearch||e;if(l instanceof Array||(l=[l]),-1!=o.indexOf(r)){i=e;for(let t of l){let e=a.indexOf(t);if(-1!=e){n=parseFloat(a.substring(e+t.length+1));break}}break}}for(let t in e){const i=e[t]||{};let n=i.str||dn,o=i.search||t;if(-1!=n.indexOf(o)){s=t;break}}"Linux"==s&&-1!=dn.indexOf("Windows NT")&&(s="HarmonyOS"),gn={browser:i,version:n,OS:s};}ln&&(gn={browser:"ssr",version:0,OS:"ssr"});}(),pn&&pn.getUserMedia;const fn="Chrome"===gn.browser&&gn.version>66||"Safari"===gn.browser&&gn.version>13||"OPR"===gn.browser&&gn.version>43||"Edge"===gn.browser&&gn.version>15,vn="\\s*([+-]?\\d+)\\s*",mn="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",yn="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",xn=/^#([0-9a-f]{3,8})$/,wn=new RegExp(`^rgb\\(${vn},${vn},${vn}\\)$`),bn=new RegExp(`^rgb\\(${yn},${yn},${yn}\\)$`),Sn=new RegExp(`^rgba\\(${vn},${vn},${vn},${mn}\\)$`),Cn=new RegExp(`^rgba\\(${yn},${yn},${yn},${mn}\\)$`),Pn=new RegExp(`^hsl\\(${mn},${yn},${yn}\\)$`),Tn=new RegExp(`^hsla\\(${mn},${yn},${yn},${mn}\\)$`),An={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};let kn=class{constructor(t,e,n,s){i(this,"r",void 0),i(this,"g",void 0),i(this,"b",void 0),i(this,"opacity",void 0),this.r=t,this.g=e,this.b=n,this.opacity=s;}};function En(t){return new kn(t>>16&255,t>>8&255,255&t,1)}function Dn(t,e,i,n){return n<=0&&(t=NaN,e=NaN,i=NaN),new kn(t,e,i,n)}function Rn(t,e,i,n){return n<=0?(t=NaN,e=NaN,i=NaN):i<=0||i>=1?(t=NaN,e=NaN):e<=0&&(t=NaN),{h:t,s:e,l:i,opacity:n}}function In(t,e,i){return t<60?(e+(i-e)*t)/60*255:t<180?255*i:t<240?(e+(i-e)*(240-t))/60*255:255*e}function Mn(t){const e=t.h<0?t.h%360+360:t.h%360,i=Number.isNaN(e)||Number.isNaN(t.s)?0:t.s,{l:n}=t,s=n+(n<.5?n:1-n)*i,o=2*n-s;return new kn(In(e>=240?e-240:e+120,o,s),In(e,o,s),In(e<120?e+240:e-120,o,s),t.opacity)}const Bn=t=>{let e,i;if(t=`${t}`.trim().toLowerCase(),xn.exec(t))switch(e=xn.exec(t),i=e[1].length,e=parseInt(e[1],16),i){case 6:return En(e);case 3:return new kn(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1);case 8:return Dn(e>>24&255,e>>16&255,e>>8&255,(255&e)/255);case 4:return Dn(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255);default:return null}return wn.exec(t)?(e=wn.exec(t),new kn(e[1],e[2],e[3],1)):bn.exec(t)?(e=bn.exec(t),new kn(255*e[1]/100,255*e[2]/100,255*e[3]/100,1)):Sn.exec(t)?(e=Sn.exec(t),Dn(e[1],e[2],e[3],e[4])):Cn.exec(t)?(e=Cn.exec(t),Dn(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4])):Pn.exec(t)?(e=Pn.exec(t),Mn(Rn(e[1],e[2]/100,e[3]/100,1))):Tn.exec(t)?(e=Tn.exec(t),Mn(Rn(e[1],e[2]/100,e[3]/100,e[4]))):An.hasOwnProperty(t)?En(An[t]):"transparent"===t?new kn(NaN,NaN,NaN,0):null},Un=t=>t.replace(/[A-Z]/g,(t=>`-${t.toLowerCase()}`)),Ln=t=>Object.prototype.toString.call(t),On=t=>Array.isArray?Array.isArray(t):"[object Array]"===Ln(t),Wn=t=>null!==t&&"[object Object]"===Ln(t),Nn=t=>{let e=null;return On(t)&&(e||(e=[]),t.forEach((t=>{e.push(Nn(t));}))),Wn(t)&&(e||(e={}),Object.keys(t).forEach((i=>{e[i]=Nn(t[i]);}))),e||t},_n=t=>void 0===t,Fn=(t,e)=>{var i;t=null!==(i=t)&&void 0!==i?i:"yyyy-MM-dd hh:mm:ss";const n=_n(e)?new Date:new Date(e),s={"M+":(n.getMonth()+1).toString(),"d+":n.getDate().toString(),"h+":n.getHours().toString(),"m+":n.getMinutes().toString(),"s+":n.getSeconds().toString(),"q+":Math.floor((n.getMonth()+3)/3).toString(),S:n.getMilliseconds().toString()};return /(y+)/.test(t)&&(t=t.replace(RegExp.$1,`${n.getFullYear()}`.substring(4-RegExp.$1.length))),Object.keys(s).forEach((e=>{new RegExp(`(${e})`).test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?s[e]:`00${s[e]}`.substring(`${s[e]}`.length)));})),t},Hn=t=>"[object ArrayBuffer]"===Ln(t),Vn=t=>"[object Blob]"===Ln(t),zn=t=>"[object Boolean]"===Ln(t),$n=t=>"function"==typeof t,jn=()=>"ontouchstart"in document.documentElement,Xn=t=>"number"==typeof t&&!Number.isNaN(t),Gn=t=>"string"==typeof t,Yn=(t,e,i)=>Math.min(Math.max(t,e),i);let qn=0;const Jn=()=>(qn+=1,`${(new Date).getTime().toString(36)}${qn.toString(36)}`),Zn=t=>{const e=window.URL||window.webkitURL;let i="string";return Gn(t)?i="string":Vn(t)?(i="blob",t=e.createObjectURL(t)):(Hn(t)||On(t))&&(i="blob",t=e.createObjectURL(new Blob([t]))),{type:i,data:t}};function Qn(t){return "object"==typeof HTMLElement?t instanceof HTMLElement:t&&"object"==typeof t&&1===t.nodeType&&"string"==typeof t.nodeName}let Kn=class t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(this,"prefix",void 0),i(this,"postfix",void 0),i(this,"isDestroyed",!1),i(this,"uid",Jn()),i(this,"cacheEvents",void 0),i(this,"events",void 0),i(this,"isCached",void 0),this.cacheEvents=[],this.events={},this.isCached=!1,this.prefix=t,this.postfix=e;}static create(e,i){return new t(e,i)}hasCallback(t){return this.events[t]&&this.events[t].length>0}save(){this.isCached=!0;}restore(){this.isCached=!1,this.cacheEvents.forEach((t=>{let{eventName:e,param:i}=t;this.emit(e,...i);})),this.cacheEvents.length=0;}destroy(){if(!this.isDestroyed){for(const t in this.events)if(Object.prototype.hasOwnProperty.call(this.events,t)){const e=this.events[t];e&&e.slice().forEach((t=>{let{name:e,fn:i,context:n,once:s}=t;this.off(e,i,n,s);}));}this.events={},this.isDestroyed=!0;}}on(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{events:s}=this,o={name:t=this.format(t),uid:Jn(),context:i,once:n,fn:e};return s[t]||(s[t]=[]),s[t].indexOf(o)<0&&s[t].push(o),o}once(t,e,i){return this.on(t,e,i,!0)}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(this.isCached)return this.cacheEvents.push({eventName:t,param:i}),!0;const{events:s}=this,o=s[t=this.format(t)];return !(!o||!o.length||(o.slice().forEach((t=>{let{fn:e,context:n}=t;e.call(n||null,...i);})),o.slice().forEach((e=>{let{fn:i,context:n,once:s}=e;s&&this.off(t,i,n,s);})),0))}off(t,e,i,n){const{events:s}=this,o=s[t=this.format(t)];if(!o)return !1;if(!arguments.length)return o.length=0,!0;for(let t=o.length-1;t>=0;t--){const s=o[t];e&&s.fn!==e||i&&s.context!==i||n&&s.once!==n||o.splice(t,1);}return !0}removeAllEventListeners(t){if(t){t=this.format(t);const e=this.cacheEvents.findIndex((e=>e.eventName===t));e>-1&&this.cacheEvents.splice(e,1),this.events[t]&&delete this.events[t];}else this.cacheEvents=[],this.events={};}getAllEvents(){return this.events}format(t){return `${this.prefix||""}${t}${this.postfix||""}`}};const ts="default";let es=class t{constructor(){i(this,"emitter",new Kn);}static create(){return new t}hasCallback(){return this.emitter.hasCallback(ts)}on(t){this.emitter.on(ts,t);}emit(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.emitter.emit(ts,...e);}off(t){this.emitter.off(ts,t);}};function is(){return new es}class ns{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,"x",void 0),i(this,"y",void 0),i(this,"z",void 0),this.x=t,this.y=e,this.z=n;}static fromPoint(t){return new ns(t.x,t.y,t.z)}static fromTwoPoint(t,e){var i,n,s,o,r,a;return new ns((null!==(i=e.x)&&void 0!==i?i:0)-(null!==(n=t.x)&&void 0!==n?n:0),(null!==(s=e.y)&&void 0!==s?s:0)-(null!==(o=t.y)&&void 0!==o?o:0),(null!==(r=e.z)&&void 0!==r?r:0)-(null!==(a=t.z)&&void 0!==a?a:0))}static fromValue(t,e,i){return new ns(t,e,i)}setFromVector(t){var e;this.x=t.x,this.y=t.y,this.z=null!==(e=t.z)&&void 0!==e?e:0;}clone(){return new ns(this.x,this.y,this.z)}norm(){return Math.hypot(this.x,this.y,this.z)}dot(t){var e;return this.x*t.x+this.y*t.y+this.z*(null!==(e=t.z)&&void 0!==e?e:0)}projectionTo(t){const e=Math.hypot(t.x,t.y,t.z);return this.dot(t)/e}angle(t){const e=this.norm()*Math.hypot(t.x,t.y,t.z),i=e&&this.dot(t)/e;return Math.acos(Yn(i,-1,1))}equals(t){var e;return this.x===t.x&&this.y===t.y&&this.z===(null!==(e=t.z)&&void 0!==e?e:0)}distance(t){var e;return Math.hypot(this.x-t.x,this.y-t.y,this.z-(null!==(e=t.z)&&void 0!==e?e:0))}lerp(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:n,y:s,z:o}=this;return new ns(n+i*(t.x-n),s+i*(t.y-s),o+i*((null!==(e=t.z)&&void 0!==e?e:0)-o))}normalize(){const t=this,e=t.norm();return t.x/=e,t.y/=e,t.z/=e,this}negate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}cross(t){const e=this;return {x:e.y*t.z-e.z*t.y,y:e.z*t.x-e.x*t.z,z:e.x*t.y-e.y*t.x}}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}}function ss(t,e){return ns.fromTwoPoint(t,e)}class os{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,"x",void 0),i(this,"y",void 0),i(this,"z",void 0),this.x=t,this.y=e,this.z=n;}static fromPoint(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new os(t.x,t.y,t.z)}matrixTransform(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{x:e,y:i,z:n}=this,{m11:s,m21:o,m31:r,m41:a,m12:l,m22:h,m32:c,m42:d,m13:u,m23:p,m33:g,m43:f,m14:v,m24:m,m34:y,m44:x}=t,w=v*e+m*i+y*n+x;return rs({x:(s*e+o*i+r*n+a)/w,y:(l*e+h*i+c*n+d)/w,z:(u*e+p*i+g*n+f)/w})}setFromPoint(t){return this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this}clone(){return rs(this)}equals(t){const{x:e=0,y:i=0,z:n=0}=t,s=this;return s.x===e&&s.y===i&&s.z===n}distanceTo(t){const{x:e=0,y:i=0,z:n=0}=t,s=this;return Math.hypot(s.x-e,s.y-i,s.z-n)}lerpTo(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:i=0,y:n=0,z:s=0}=t,o=this;return rs({x:o.x+e*(i-o.x),y:o.y+e*(n-o.y),z:o.z+e*(s-o.z)})}footPointInSegment(t,e){const i=ss(t,this),n=ss(t,e),s=n.norm(),o=rs(t);if(0===s)return o;const r=i.projectionTo(n)/s;return o.lerpTo(e,r)}perpendicularToSegment(t,e){const i=this.footPointInSegment(t,e);return this.distanceTo(i)}}function rs(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Xn(t)?new os(t,e,i):new os(t.x,t.y,t.z)}function as(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}class ls{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,"x",0),i(this,"y",0),i(this,"left",0),i(this,"top",0),i(this,"right",0),i(this,"bottom",0),i(this,"width",0),i(this,"height",0),this.update(t,e,n,s);}update(t,e,i,n){this.x=t,this.y=e,this.left=t,this.top=e,this.right=t+i,this.bottom=e+n,this.width=i,this.height=n;}toJSON(){}}const hs=new class{constructor(){i(this,"tasks",[]);}createTimer(t,e){const i=Jn();return this.tasks.push({uid:i,callback:t,time:e}),this.executeTimer(i),i}executeTimer(t){const e=this.tasks.find((e=>e.uid===t));if(!e)return;const i=()=>{e.callback(),null!==e.timer&&(e.timer=setTimeout(i,e.time));};e.timer=setTimeout(i,e.time);}clearTimer(t){const e=this.tasks.findIndex((e=>e.uid===t));e>-1&&(clearTimeout(this.tasks[e].timer),this.tasks[e].timer=null,this.tasks.splice(e,1));}};function cs(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}function ds(t){const{type:e,value:i}=t;return "hex"===e?`#${i}`:"literal"===e?i:"rgb"===e?`rgb(${i.join(",")})`:`rgba(${i.join(",")})`}const us=function(){const t={linearGradient:/^(linear\-gradient)/i,repeatingLinearGradient:/^(repeating\-linear\-gradient)/i,radialGradient:/^(radial\-gradient)/i,repeatingRadialGradient:/^(repeating\-radial\-gradient)/i,conicGradient:/^(conic\-gradient)/i,sideOrCorner:/^to (left (top|bottom)|right (top|bottom)|top (left|right)|bottom (left|right)|left|right|top|bottom)/i,extentKeywords:/^(closest\-side|closest\-corner|farthest\-side|farthest\-corner|contain|cover)/,positionKeywords:/^(left|center|right|top|bottom)/i,pixelValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))px/,percentageValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))\%/,emValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))em/,angleValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))deg/,startCall:/^\(/,endCall:/^\)/,comma:/^,/,hexColor:/^\#([0-9a-fA-F]+)/,literalColor:/^([a-zA-Z]+)/,rgbColor:/^rgb/i,rgbaColor:/^rgba/i,number:/^(([0-9]*\.[0-9]+)|([0-9]+\.?))/};let e="";function i(t){throw new Error(`${e}: ${t}`)}function n(){return s("linear-gradient",t.linearGradient,r)||s("repeating-linear-gradient",t.repeatingLinearGradient,r)||s("radial-gradient",t.radialGradient,a)||s("repeating-radial-gradient",t.repeatingRadialGradient,a)||s("conic-gradient",t.conicGradient,a)}function s(e,n,s){return o(n,(n=>{const o=s();return o&&(y(t.comma)||i("Missing comma before color stops")),{type:e,orientation:o,colorStops:u(p)}}))}function o(e,n){const s=y(e);if(s){y(t.startCall)||i("Missing (");const e=n(s);return y(t.endCall)||i("Missing )"),e}}function r(){return m("directional",t.sideOrCorner,1)||m("angular",t.angleValue,1)}function a(){let i,n,s=l();return s&&(i=[],i.push(s),n=e,y(t.comma)&&(s=l(),s?i.push(s):e=n)),i}function l(){let t=function(){const t=m("shape",/^(circle)/i,0);return t&&(t.style=v()||h()),t}()||function(){const t=m("shape",/^(ellipse)/i,0);return t&&(t.style=f()||h()),t}();if(t)t.at=c();else {const e=h();if(e){t=e;const i=c();i&&(t.at=i);}else {const e=d();e&&(t={type:"default-radial",at:e});}}return t}function h(){return m("extent-keyword",t.extentKeywords,1)}function c(){if(m("position",/^at/,0)){const t=d();return t||i("Missing positioning value"),t}}function d(){const t={x:f(),y:f()};if(t.x||t.y)return {type:"position",value:t}}function u(e){let n=e();const s=[];if(n)for(s.push(n);y(t.comma);)n=e(),n?s.push(n):i("One extra comma");return s}function p(){const e=m("hex",t.hexColor,1)||o(t.rgbaColor,(()=>({type:"rgba",value:u(g)})))||o(t.rgbColor,(()=>({type:"rgb",value:u(g)})))||m("literal",t.literalColor,0);return e||i("Expected color definition"),e.length=f(),e}function g(){return y(t.number)[1]}function f(){return m("%",t.percentageValue,1)||m("position-keyword",t.positionKeywords,1)||v()}function v(){return m("px",t.pixelValue,1)||m("em",t.emValue,1)}function m(t,e,i){const n=y(e);if(n)return {type:t,value:n[i]}}function y(t){const i=/^[\n\r\t\s]+/.exec(e);i&&x(i[0].length);const n=t.exec(e);return n&&x(n[0].length),n}function x(t){e=e.substring(t);}return function(t){return e=t,function(){const t=u(n);return e.length>0&&i("Invalid input not EOF"),t}()}}();const ps={"&amp;":"&","&gt;":">","&lt;":"<","&nbsp;":" ","&quot;":'"',"&#x27;":"'"},gs={};let fs;function vs(t,e){const i=Object.keys(t);let n=0;for(;n<i.length;n++){const s=i[n];if(!1===e.call(null,t[s],s,t))break}}vs(ps,((t,e)=>{gs[t]=e;}));const ms=t=>{const{parentNode:e}=t,{children:i}=e;for(let e=0;e<i.length;e++)if(i[e]===t)return e;return -1},ys=(t,e,i)=>{try{void 0===e?i.appendChild(t):i.insertBefore(t,e);}catch(t){}},xs=()=>{const t=window;if(t){if(t.devicePixelRatio)return t.devicePixelRatio;if(t.screen.deviceXDPI&&t.screen.logicalXDPI)return t.screen.deviceXDPI/t.screen.logicalXDPI}return 1};function ws(t){let e="0px",i="",n="solid";if(!_n(t)&&""!==t){const s=document.createElement("div");s.style.border=t;const{borderWidth:o,borderColor:r,borderStyle:a}=s.style;"initial"!==o&&""!==o&&(e=o),"initial"!==r&&""!==r&&(i=r),"initial"!==a&&""!==a&&(n=a);}return {borderWidth:e,borderColor:i,borderStyle:n}}const bs=t=>{const{pointerType:e}=t;return "touch"===e||"pen"===e||void 0===e};let Ss;function Cs(){return void 0===Ss&&(Ss=/Mac OS/.test(navigator.userAgent)),Ss}function Ps(t){return Cs()?Ds(t,3):Ds(t,2)}function Ts(t){return Cs()&&Ds(t,3)||Ds(t,2)}function As(t){return Ds(t,5)}function ks(t){return Ds(t,1)}function Es(t){return Ds(t,0)}function Ds(t,e){const{ctrlKey:i,metaKey:n,altKey:s,shiftKey:o}=t;switch(e){case 0:return i||n||s||o;case 1:return !(i||n||s||o);case 2:return i&&!n&&!s&&!o;case 3:return !i&&n&&!s&&!o;case 4:return !i&&!n&&s&&!o;case 5:return !i&&!n&&!s&&o;default:return !1}}const Rs=function(t,e){const i=t.indexOf(e);return !(i<0||(t.splice(i,1),0))},Is=function(t,e,i){if(Xn(i)){let n=[],s=[];if(e.includes(i)){const t=e.length;if(t>1){const o=e.indexOf(i);0===o?s=e.slice(1):o===t-1?n=e.slice(0,-1):(n=e.slice(0,o),s=e.slice(o+1));}}else n=e;const o=t[i],r=n.map((e=>t[e])),a=s.map((e=>t[e]));r.forEach((e=>{const i=t.indexOf(e);i>-1&&t.splice(i,1);})),a.forEach((e=>{const i=t.indexOf(e);i>-1&&t.splice(i,1);}));const l=t.indexOf(o);t.splice(l+1,0,...a),t.splice(l,0,...r);}else e.map((e=>t[e])).forEach((e=>{const i=t.indexOf(e);t.splice(i,1),t.push(e);}));return !0},Ms=function(t,e,i){if(e===i)return !0;const n=t[e];return t[e]=t[i],t[i]=n,!0},Bs=function(t,e){const i=e.length;return !(t.length!==i||!i||(e.every(((t,e)=>t===e))||e.map((e=>t[e])).forEach(((e,i)=>{t[i]=e;})),0))};function Us(t){return null==t}const Ls=(t,e)=>t in e,Os=(t,e)=>{const i=[];for(;t;){const n=t.match(e);if(!n)break;i.push(n),t=t.substring(n.index+n[0].length);}return i};function Ws(t,e){return Object.keys(t).forEach((i=>{(function(t){return "__proto__"===t||"constructor"===t||"prototype"===t})(i)||(_n(e[i])?e[i]=t[i]:Wn(t[i])?Ws(t[i],e[i]):e[i]=t[i]);})),e}class Ns{static read(t){return new Promise(((e,i)=>{const n=Object.prototype.toString.call(t);if("[object String]"===n){if(0===t.indexOf("blob:")||t.indexOf(".jpg")>0||t.indexOf(".jpeg")>0||t.indexOf(".png")>0||t.indexOf(".bmp")>0||t.indexOf(".dib")>0||t.indexOf(".pdf")>0||t.indexOf(".tiff")>0||t.indexOf(".tif")>0)return fetch(t,{mode:"cors"}).then((t=>t.arrayBuffer())).then((t=>e(t))).catch((t=>Promise.reject(t)));i("Error url: Can not read the file URL");}else if("[object Blob]"===n||"[object FileList]"===n||"[object File]"===n){let s=t;"[object FileList]"!==n&&"[object File]"!==n||(s=t[0]?t[0]:t),l(Ns,Ns,_s).call(Ns,s,e,i);}else "[object ArrayBuffer]"===n||"[object Uint8ClampedArray]"===n?e(t):i(`Not support source type: ${n}`);}))}}function _s(t,e,i){let n,s,o=0;try{n=new ArrayBuffer(t.size),s=new Uint8Array(n);}catch(t){i(t);}!function r(){const a=new FileReader;a.onload=function(a){var l;if(null!=a&&null!==(l=a.target)&&void 0!==l&&l.result){const i=a.target.result;s.set(new Uint8Array(i),o),o+=i.byteLength,o<t.size?r():e(n);}else i(a);},a.onerror=function(t){i(t);},a.onabort=function(t){i(t);};const l=Math.min(o+1048576,t.size),h=t.slice(o,l);a.readAsArrayBuffer(h);}();}async function Fs(t){let e;if(t instanceof ArrayBuffer)t.byteLength>12&&(e=new Uint8Array(t.slice(0,12)));else if(t instanceof Blob&&t.size>12){const i=t.slice(0,12),n=await Ns.read(i);e=new Uint8Array(n);}if(e){if(function(t){return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]}(e))return "application/pdf";if(function(t){return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]}(e))return "image/png";if(function(t){return 255===t[0]&&216===t[1]}(e))return "image/jpeg";if(function(t){return 66===t[0]&&77===t[1]}(e))return "image/bmp";if(function(t){return 73===t[0]&&73===t[1]&&42===t[2]&&0===t[3]||77===t[0]&&77===t[1]&&0===t[2]&&42===t[3]}(e))return "image/tiff";if(function(t){return 0===t[0]&&0===t[1]&&0===t[2]&&12===t[3]&&106===t[4]&&80===t[5]&&32===t[6]&&32===t[7]||255===t[0]&&79===t[1]&&255===t[2]&&81===t[3]}(e))return "image/jp2";if(function(t){return 82===t[0]&&73===t[1]&&70===t[2]&&70===t[3]&&87===t[8]&&69===t[9]&&66===t[10]&&80===t[11]}(e))return null;if(t instanceof Blob&&("application/pdf"===t.type||"image/bmp"===t.type||"image/jp2"===t.type||"image/jpeg"===t.type||"image/png"===t.type||"image/tiff"===t.type||"image/rgba"===t.type))return t.type}return t instanceof Blob&&"application/ddv-blank-image"===t.type?t.type:null}function Hs(t,e,i){return e===i?t:Xn(t)?t/e*i:On(t)?t.map((t=>On(t)?[t[0]/e*i,t[1]/e*i]:t/e*i)):(t={...t},Object.keys(t).forEach((n=>{t[n]=t[n]/e*i;})),t)}function Vs(t,e){return t.every(((t,i)=>{let[n,s]=t;const[o,r]=e[i];return n===o&&s===r}))}function zs(t,e){return Number.parseFloat(t.toFixed(e))}class $s{constructor(){i(this,"disposed",!1),i(this,"toDispose",new Set);}get isDisposed(){return this.disposed}add(t){if(!t)return t;if(t===this)throw new Error("Cannot register a disposable on itself!");return this.disposed||this.toDispose.add(t),t}delete(t){if(t){if(t===this)throw new Error("Cannot dispose a disposable on itself!");this.toDispose.delete(t),t.dispose();}}dispose(){this.disposed||(this.disposed=!0,this.clear());}clear(){try{for(const t of this.toDispose)if(t)try{t.dispose();}catch(t){throw new Error("can not dispose an object")}}finally{this.toDispose.clear();}}}class js{constructor(){i(this,"store",new $s);}dispose(){this.store.dispose();}register(t){if(t===this)throw new Error("Cannot register a disposable on itself!");return this.store.add(t)}}class Xs{static create(t){return new Xs(t)}constructor(t){i(this,"isDisposed",!1),i(this,"listeners",void 0),i(this,"options",void 0),this.options=t,this.listeners=[];}dispose(){this.isDisposed||(this.isDisposed=!0,this.listeners&&(this.listeners=null));}on(t,e,i){var n,s,o,r;if(this.isDisposed)return {dispose:()=>{}};const a={uid:Jn(),callback:t,context:e};this.listeners.length?this.listeners.push(a):(null!==(n=this.options)&&void 0!==n&&null!==(s=n.beforeAddFirstListener)&&void 0!==s&&s.call(n,this),this.listeners.push(a),null===(o=this.options)||void 0===o||null===(r=o.afterAddFirstListener)||void 0===r||r.call(o,this));const l={dispose:()=>{this.remove(a);}};return i instanceof $s?i.add(l):Array.isArray(i)?i.push(l):i instanceof js&&i.register(l),l}remove(t){var e,i,n,s;if(null!==(e=this.options)&&void 0!==e&&null!==(i=e.beforeRemoveListener)&&void 0!==i&&i.call(e,this),!this.listeners)return;if(1===this.listeners.length)return this.listeners=[],void(null===(n=this.options)||void 0===n||null===(s=n.afterRemoveLastListener)||void 0===s||s.call(n,this));const o=this.listeners.indexOf(t);if(o<0)throw new Error("Attempted to dispose unknown listener.");this.listeners.splice(o,1);}off(t){if(this.isDisposed||!this.listeners)return;const e=this.listeners.findIndex((e=>e.callback===t));e>-1&&this.listeners.splice(e,1);}emit(t){this.listeners&&this.listeners.length&&this.listeners.slice().forEach((e=>{try{e.context?e.callback.call(e.context,t):e.callback(t);}catch(e){}}));}}function Gs(t){const e=t.register(new Xs);return {on:(i,n)=>e.on(i,t,n),emit:t=>{e.emit(t);}}}function Ys(t,e,i){return {on:(n,s)=>{const o=new Xs({beforeAddFirstListener:()=>{t.addEventListener(e,n,s);},afterRemoveLastListener:()=>{t.removeEventListener(e,n);}});i.register(o.on((()=>{}))),i.register(o);}}}function qs(t,e,i,n){if(function(t,e,i,n){return Math.min(t[0],e[0])<=Math.max(i[0],n[0])&&Math.min(i[0],n[0])<=Math.max(t[0],e[0])&&Math.min(t[1],e[1])<=Math.max(i[1],n[1])&&Math.min(i[1],n[1])<=Math.max(t[1],e[1])}(t,e,i,n)&&function(t,e,i,n){let s=t[0]*(i[1]-e[1])+e[0]*(t[1]-i[1])+i[0]*(e[1]-t[1]),o=t[0]*(n[1]-e[1])+e[0]*(t[1]-n[1])+n[0]*(e[1]-t[1]);return !((s^o)>=0&&0!==s&&0!==o||(s=i[0]*(t[1]-n[1])+n[0]*(i[1]-t[1])+t[0]*(n[1]-i[1]),o=i[0]*(e[1]-n[1])+n[0]*(i[1]-e[1])+e[0]*(n[1]-i[1]),(s^o)>=0&&0!==s&&0!==o))}(t,e,i,n)){let s=(n[0]-i[0])*(t[1]-e[1])-(e[0]-t[0])*(i[1]-n[1]),o=(t[1]-i[1])*(e[0]-t[0])*(n[0]-i[0])+i[0]*(n[1]-i[1])*(e[0]-t[0])-t[0]*(e[1]-t[1])*(n[0]-i[0]);if(0===s||0===o){const s=Js(t,e),o=Js(i,n),r=s[0],a=s[1],l=o[0],h=o[1];if(a[0]===l[0]&&a[1]===l[1])return a;if(r[0]===h[0]&&r[1]===h[1])return r;if(Zs(a,o)&&Zs(l,s))return [l,a];if(Zs(r,o)&&Zs(h,s))return [r,h];if(Zs(r,o)&&Zs(a,o))return [r,a];if(Zs(l,o)&&Zs(h,o))return [l,h]}const r=o/s;return s=(t[0]-e[0])*(n[1]-i[1])-(e[1]-t[1])*(i[0]-n[0]),o=e[1]*(t[0]-e[0])*(n[1]-i[1])+(n[0]-e[0])*(n[1]-i[1])*(t[1]-e[1])-n[1]*(i[0]-n[0])*(e[1]-t[1]),[r,o/s]}return !1}function Js(t,e){return t[0]===e[0]?t[1]<e[1]?[t,e]:[e,t]:t[0]<e[0]?[t,e]:[e,t]}function Zs(t,e){return e[0][0]===e[1][0]?t[1]>=e[0][1]&&t[1]<=e[1][1]:t[0]>=e[0][0]&&t[0]<=e[1][0]}function Qs(t){const e=[];let i=null;const n=t.slice(0,8).concat(t[0],t[1]);for(let t=0;t<4;t++){const s=n[2*(t+1)+1]-n[2*t+1],o=n[2*(t+1)]-n[2*t];i=0===s&&0===o?0:s/o,e.push(i);}return e}function Ks(t,e){return Number.parseFloat(t.toFixed(e))}function to(t){const[e,i,n,s,o,r,a,l]=t,h=(a-e)*(s-i)-(l-i)*(n-e),c=(e-n)*(r-s)-(i-s)*(o-n),d=(n-o)*(l-r)-(s-r)*(a-o),u=(o-a)*(i-l)-(r-l)*(e-a);if(h*c*d*u<0)return !1;const p=t.slice().concat(t.slice(0,2)),g=Qs(t);if(g.length)for(let t=0;t<2;t++)if(g[t]!==g[t+2]&&qs(p.slice(2*t,2*(t+1)),p.slice(2*(t+1),2*(t+2)),p.slice(2*(t+2),2*(t+3)),p.slice(2*(t+3),2*(t+4))))return !1;return h*c*d*u>0}var eo,io;!function(t){t.core="ddv-core",t.reader="ddv-reader",t.detector="ddv-detector",t.loader="ddv-loader";}(io||(io={}));class no{static get isApple(){return r(this,no,vo)}static get version(){return Si.ImageIOModule.ver}static enableDebugOutput(t,e){if(t){const t=t=>{var i,n,s;let o=Nn(t);o.srcBuffer&&(o.srcBuffer=l(this,no,so).call(this,o.srcBuffer)),null!==(i=o.result)&&void 0!==i&&i.srcBuffer&&(o.result.srcBuffer=l(this,no,so).call(this,o.result.srcBuffer)),null!==(n=o.result)&&void 0!==n&&n.imageData&&(o.result.imageData=l(this,no,so).call(this,o.result.imageData)),null!==(s=o.result)&&void 0!==s&&s.pdfData&&(o.result.pdfData=l(this,no,so).call(this,o.result.pdfData)),o.imageData&&(o.imageData=l(this,no,so).call(this,o.imageData)),e&&(Gn(o)&&(o=`[${Date.now()}]${o}`),e(o));};Si.setLogFunc("logDebug",t);}else Si.setLogFunc("",void 0);}static hasDebugOutput(){return Si.hasLogFunc()}static get blobReadModeSettings(){const{FontUseFileReadMode:t}=Si;return {minBlobSize:Si.FileReadModeSize,fontForLoad:t.load,fontForSave:t.save}}static set blobReadModeSettings(t){"number"==typeof t.minBlobSize&&(Si.FileReadModeSize=t.minBlobSize),Si.FontUseFileReadMode={load:t.fontForLoad,save:t.fontForSave};}static getMemoryUsed(){return Ai.Instance.getMemoryUsed()}static get heapConfig(){return Si.HeapConfig}static updateHeapConfig(t,e,i){Si.UpdateHeapConfig(t,e,i),r(this,no,yo)[t]||(r(this,no,yo)[t]={}),e&&(r(this,no,yo)[t].maxHeapSize=e),i&&(r(this,no,yo)[t].initHeapSize=i);}static async getLicenseInfo(t,e,i){this.Init(t,e,i),await Oi.updateLicense(r(this,no,ao),r(this,no,lo),r(this,no,ho));const n=new Ri(r(this,no,ao));try{return await n.getLicenseInfo()}finally{n.terminate();}}static Init(t,e,i){var n;a(this,no,ao,null!=t?t:r(this,no,ao)),void 0!==e&&a(this,no,lo,e?1:0),a(this,no,ho,null!=i?i:r(this,no,ho));const s={bMac:"Mac"===gn.OS,biPhone:"iPhone"===gn.OS,biPad:"iPad"===gn.OS};a(this,no,vo,s.bMac||s.biPhone||s.biPad),Si.NavInfo=s,Si.License=r(this,no,ao),Si.UUID=r(this,no,ho),Si.LicMode=r(this,no,lo),l(this,no,ro).call(this),Si.UpdateHeapConfig(io.detector,null!==(n=l(this,no,oo).call(this,io.detector))&&void 0!==n?n:100);}static async isResourceDirValid(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;l(this,no,ro).call(this);let i=0;for(;i<t;){try{const t=Si.PdfReaderModule;if(r(this,no,mo)===t.script)return !0;const e={...t.fetchOptions};e.method="HEAD";if((await fetch(t.script,e)).ok)return a(this,no,mo,t.script),!0}catch(t){}await new Promise((t=>setTimeout(t,e))),i+=1;}return !1}static async loadPdfReader(t,e,i){return this.Init(t,e,i),r(this,no,go)||(await Ai.Instance.loadModule(Si.ImageProcModule),a(this,no,go,Ai.Instance.loadModule(Si.PdfReaderModule)),await r(this,no,go)),r(this,no,go)}static async loadMain(t,e,i){return this.Init(t,e,i),r(this,no,fo)||Ai.Instance.loadModule(Si.ImageProcModule),r(this,no,fo)}static async load(t,e,i){Ai.Instance.terminate(!0),this.Init(t,e,i),await this.loadMain(t,e,i);}static async preloadModule(t){let e;Si.PdfReaderModule;const i={...Si.ImageProcModule};switch(t){case"core":case"pdf":if(r(this,no,fo)){e=r(this,no,fo);break}a(this,no,fo,Ai.Instance.loadModule(Si.ImageIOModule)),e=r(this,no,fo),await r(this,no,fo);break;case"proc":if(r(this,no,go)){e=r(this,no,go);break}a(this,no,go,Ai.Instance.loadModule(i)),e=r(this,no,go),await r(this,no,go);}return e}static unloadMainWorker(){a(this,no,fo,void 0),Ai.Instance.terminateWorker(Si.ImageIOModule.workerName);}static unloadPdfReaderWorker(){a(this,no,go,void 0),Ai.Instance.terminateWorker(Si.PdfReaderModule.workerName);}static unloadDocumentDetectorWorker(){Ai.Instance.terminateWorker(Si.DetectorModule.workerName);}static async unloadWorker(){a(this,no,fo,void 0),a(this,no,go,void 0),await Ai.Instance.terminate(!0);}static async unload(){Ai.unload(),Oi.unload(),Si.unload(),a(this,no,fo,void 0),a(this,no,go,void 0);try{await Ai.Instance.terminate(!0);}catch(t){}}static getUseSimd(){if(this.enableSimd){var t;const e=navigator;if(null!==(t=e.userAgentData)&&void 0!==t&&t.brands)for(const{brand:t,version:i}of e.userAgentData.brands)if(t&&("Chromium"===t||"Google Chrome"===t)&&i&&parseInt(i,10)>=94)return !0}return !1}static getPdfFonts(){return rn.getPdfFonts()}static async getPdfInfo(t,e){let i;try{i=new rn;const n=await i.getPdfInfo({fileSource:t,password:e});return i.destroy(),n}catch(t){return null}finally{i&&i.destroy();}}}function so(t){return t instanceof ArrayBuffer?{type:"ArrayBuffer",length:t.byteLength}:t instanceof Uint8ClampedArray?{type:"Uint8ClampedArray",length:t.byteLength}:{type:Object.prototype.toString.call(t)}}function oo(t){return void 0!==r(this,eo,yo)[t]?r(this,eo,yo)[t].maxHeapSize:null}function ro(){this.enableSimd?Si.UseSimd=this.getUseSimd():Si.UseSimd=!1,Si.UseBrotli=this.enableWasmCompression;const t={resourceDir:this.resourceDir,workerScript:"",useFastCompEdition:!1,useSimd:Si.UseSimd,fetchOptions:this.fetchOptions,useBrotli:Si.UseBrotli};t.workerScript=Si.ImageIOWorkerJS,Si.ImageIOResource=t;const e={...t};e.workerScript=Si.UseSimd?Si.ImageProcSimdWorkerJS:Si.ImageProcWorkerJS,Si.ImageProcResource=e;}eo=no,i(no,"resourceDir","");var ao={writable:!0,value:""},lo={writable:!0,value:T.LONG_KEY},ho={writable:!0,value:""};i(no,"fetchOptions",{mode:"cors",credentials:"same-origin",retries:3,retryDelay:500}),i(no,"enableSimd",!0),i(no,"enableWasmCompression",!1);var co,uo,po,go={writable:!0,value:void 0},fo={writable:!0,value:void 0},vo={writable:!0,value:!1},mo={writable:!0,value:void 0},yo={writable:!0,value:Object.create(null)};class xo{constructor(){i(this,"processor",void 0),this.processor=new on;}async initImage(t){return this.processor.initImage(t.source,t.isRGBA,t.width,t.height,t.isBGRA)}async getImage(t){return await this.processor.getImage(t.jpegQuality,t.ifDeleteObject,t.isRGBA,t.bitDepth,t.xDpi,t.yDpi,t.returnBlob,t.returnType,no.isApple)}async getImageInfo(){return await this.processor.getImageInfo()}async freeReservedData(){this.processor.freeReservedData();}async toBinaryLevel(t,e){return this.processor.toBinaryLevel(t,e)}async toGrayscale(t){return this.processor.toGrayscale(t)}async removeShadowLevel(t,e){return this.processor.removeShadowLevel(t,e)}async brighten(){return this.processor.brighten()}async invert(){return this.processor.invert()}async changeBrightnessAndContrast(t,e){return this.processor.changeBrightnessAndContrast(t,e)}async perspective(t){return this.processor.perspective(t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1],t[3][0],t[3][1])}async getSkewAngle(t){return this.processor.getSkewAngle(t)}async rotate(t){return this.processor.rotate(t.angle,t.fillColor,t.keepSize,t.mode)}async flip(){return this.processor.flip()}async resize(t,e,i){return this.processor.resize(t,e,i)}async resizeWidth(t,e){return this.processor.setImageWidth(t,e)}async resizeHeight(t,e){return this.processor.setImageHeight(t,e)}async crop(t){return this.processor.crop(t.left,t.top,t.left+t.width,t.top+t.height)}async erase(t,e){return this.processor.erase(t.left,t.top,t.left+t.width,t.top+t.height,e)}async setDpi(t){return this.processor.setDPI(t.rawResolutionX,t.rawResolutionY,t.resolutionX,t.resolutionY,t.resample,t.mode)}async drawQuadrangle(t){return this.processor.drawQuadrangle(t.location[0][0],t.location[0][1],t.location[1][0],t.location[1][1],t.location[2][0],t.location[2][1],t.location[3][0],t.location[3][1],t)}async filter(t,e,i){return this.processor.filter(t,e,i)}async setImageWidth(t,e){return this.processor.setImageWidth(t,e)}async setImageHeight(t,e){return this.processor.setImageHeight(t,e)}terminate(t){return this.processor.terminate(t)}}class wo{constructor(){i(this,"reader",void 0),this.reader=new Wi;}async readImage(t){return await this.reader.readImage(t.source,t.outputType,t.jpegQuality,t.returnBase64,no.isApple)}async readImageInfo(t){return await this.reader.readImageInfo(t)}cancelReadImage(t,e){this.reader.cancelReadImage(t,e);}async readTiffPage(t){return await this.reader.readTiffPage(t.source,t.index,t.outputType,t.returnBase64,no.isApple)}async readTiffPageInfo(t,e){const{imageInfos:i}=await this.reader.getTiffPageInfos(t,e);return i}async getTiffPageCount(t){return (await this.reader.getTiffInfo(t)).pageCount}cancelReadTiffPage(t,e){this.reader.cancelReadTiffPage(t,e);}destroy(){var t;null===(t=this.reader)||void 0===t||t.destroy(),this.reader=void 0;}}!function(t){t[t.RGBA=1]="RGBA",t[t.BGRA=2]="BGRA",t[t.JPEG=3]="JPEG",t[t.PNG=4]="PNG";}(co||(co={})),function(t){t[t.IT_DIB=-1]="IT_DIB",t[t.IT_RGBA=-2]="IT_RGBA",t[t.IT_BGRA=-3]="IT_BGRA",t[t.IT_BMP=0]="IT_BMP",t[t.IT_JPG=1]="IT_JPG",t[t.IT_PNG=3]="IT_PNG",t[t.IT_ALL=5]="IT_ALL";}(uo||(uo={})),function(t){t[t.RT_AUTO=-1]="RT_AUTO",t[t.RT_BINARY=1]="RT_BINARY",t[t.RT_BASE64=2]="RT_BASE64";}(po||(po={}));class bo{constructor(){i(this,"writer",void 0),this.writer=new Ri;}terminate(){var t;null===(t=this.writer)||void 0===t||t.terminate(),this.writer=void 0;}createTiff(){return this.writer.createTiff()}addTiffTag(t,e,i){return this.writer.addTag(t,e,i)}async appendImage(t,e){var i;e=null!==(i=e)&&void 0!==i?i:{};return await this.writer.appendImage(t,e.inputType,e.tiffFormat,e.jpegQuality,e.is1Bit)}async getTiff(){return (await this.writer.getTiff(po.RT_BINARY)).imageData}async saveImage(t,e){var i;e=null!==(i=e)&&void 0!==i?i:{};return (await this.writer.saveImage(t,e.outputType,e.jpegQuality,e.returnType,e.is1Bit)).imageData}}class So{constructor(){i(this,"reader",void 0),this.reader=new rn;}initFonts(t){var e;const i=null==t||null===(e=t.renderOptions)||void 0===e?void 0:e.fonts;if(i)for(const t of i)t.name&&t.data&&So.addPdfFont(t.name,t.data);}static addPdfFont(t,e){rn.addPdfFont(t,e);}async readPageImageInfos(t){await this.initFonts(t.readOptions);const{imageInfos:e}=await this.reader.readPageImageInfos(t.source,t.indices,t.readOptions,t.outputType,t.isInfoOnly,t.returnBase64,no.isApple);return e}async readPage(t){await this.initFonts(t.readOptions);return await this.reader.readPageEx(t.source,t.index,t.readOptions,t.outputType,t.isInfoOnly,t.returnBase64,no.isApple)}cancelReadPage(t,e){this.reader.cancelReadPage(t,e);}async getPdfPageCount(t,e){await this.initFonts(e);return (await this.reader.getPdfInfo(t)).PdfCount}async getPdfPageContentType(t,e){const i=await this.reader.getPdfPageType(t,e);return 1===i.pageContentType?"application/pdf/text":2===i.pageContentType?"application/pdf/image":"application/pdf"}async readAnnotations(t,e){const{annot:{annots:i}}=await this.reader.readPageAnnot(t,e);return i}async findText(t,e,i,n){return await this.reader.findText(t,e,i,n)}async getCharInfos(t,e){return (await this.reader.getCharInfos(t,e)).pageCharInfos}destroy(){this.reader.destroy(),this.reader=null;}}class Co{constructor(){i(this,"writer",void 0),this.writer=new an;}terminate(){var t;null===(t=this.writer)||void 0===t||t.terminate(),this.writer=null;}async initPdfSetting(t){return this.writer.initPdfSetting(t)}async insertBlankPage(t,e,i){return this.writer.insertBlankPage(t,e,i)}async insertBlankPages(t,e,i,n){return this.writer.insertBlankPages(t,e,i,n)}async appendPage(t,e){return this.writer.appendPage(t,e)}async addImageToPages(t,e,i,n,s,o){return this.writer.pageAddImage(t,e,i,n,s,o)}async mergeRawPdfPages(t,e,i){return this.writer.mergePdf(t,e,i)}async replaceRawPdfPages(t,e,i,n){return this.writer.replacePdfPages(t,e,i,n)}async setPageRotation(t,e){return this.writer.pageSetRotation(t,e)}async clearPageObjects(t){return this.writer.pageClearObjects(t)}async setPageCropBox(t,e,i,n,s){return this.writer.pageSetCropBox(t,e,i,n,s)}async setPageMediaBox(t,e,i,n,s){return this.writer.pageSetMediaBox(t,e,i,n,s)}async setPageAnnotations(t,e){return this.writer.pageSetAnnot(t,e)}async addAnnotationsToPage(t,e){return this.writer.pageAddAnnot(t,e)}async flattenPageAnnotations(t,e){return this.writer.pageFlattenAnnot(t,e)}async deletePageAnnotationsByTypes(t,e){return this.writer.pageDeleteAnnotByTypes(t,e)}async deletePageAnnotationsExceptTypes(t,e){return this.writer.pageDeleteAnnotExceptTypes(t,e)}async deletePageAnnotations(t){return this.writer.pageDeleteAnnot(t)}async flattenPage(t,e){return this.writer.pageFlatten(t,e)}async deletePage(t){return this.writer.deletePage(t)}async movePages(t,e){return this.writer.movePages(t,e)}async getPdf(t){return (await this.writer.writePdf(t)).pdfData}async getFontInfo(t){return await this.writer.GetFontInfo(t)}async ifFontsExist(t){return (await this.writer.IfFontsExist(t)).fontsExist}async unloadPage(t){var e,i;await(null===(e=(i=this.writer).UnloadPage)||void 0===e?void 0:e.call(i,t));}}class Po{constructor(t){i(this,"items",[]),t&&(this.items=t);}push(t){this.items.push(t);}pop(){return this.items.pop()}peek(){return this.items[this.items.length-1]}isEmpty(){return 0===this.items.length}size(){return this.items.length}remove(t){"filter"===t.api&&this.items.forEach(((e,i)=>{if(e.api===t.api&&e.params[0]===t.params[0]&&e.params[1]===t.params[1]&&e.params[2]===t.params[2]){this.items.splice(i,1).forEach((t=>{null==t||t.resolve(null);}));}}));}}const To={[co.BGRA]:uo.IT_BGRA,[co.RGBA]:uo.IT_RGBA,[co.PNG]:uo.IT_PNG,[co.JPEG]:uo.IT_JPG},Ao={[uo.IT_BGRA]:co.BGRA,[uo.IT_RGBA]:co.RGBA,[uo.IT_PNG]:co.PNG,[uo.IT_JPG]:co.JPEG},ko={displayResolution:96,dataResolution:72,pdfResolution:72,enableResolution:!0,autoReleaseImg:jn(),autoReleaseBlob:!0,loadRawPageTimeout:2e4};class Eo{constructor(){i(this,"db",void 0),this.db=new Map;}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}getSaverConstructor(t){return this.db.get(t)}setSaverConstructor(t,e){this.db.set(t,e);}deleteSaverConstructor(t){this.db.delete(t);}clear(){this.db.clear();}}const Do=new Eo,Ro=new Eo;const Io=new class{constructor(t,e){i(this,"saverConstructorRepo",void 0),i(this,"customSaverConstructorRepo",void 0),this.saverConstructorRepo=t,this.customSaverConstructorRepo=e;}execute(t){let e=this.customSaverConstructorRepo.getSaverConstructor(t);e||(e=this.saverConstructorRepo.getSaverConstructor(t));return new e}}(Do,Ro),Mo=new class{constructor(t){i(this,"saverConstructorRepo",void 0),this.saverConstructorRepo=t;}execute(t){let{mime:e,saverConstructor:i}=t;this.saverConstructorRepo.setSaverConstructor(e,i);}}(Do),Bo=new class{constructor(t){i(this,"saverConstructorRepo",void 0),this.saverConstructorRepo=t;}execute(t){this.saverConstructorRepo.deleteSaverConstructor(t);}}(Do);var Uo,Lo,Oo,Wo;!function(t){t.TIFF_AUTO="tiff/auto",t.TIFF_FAX3="tiff/fax3",t.TIFF_FAX4="tiff/fax4",t.TIFF_LZW="tiff/lzw",t.TIFF_JPEG="tiff/jpeg";}(Uo||(Uo={})),function(t){t.PDF_AUTO="pdf/auto",t.PDF_FAX4="pdf/fax4",t.PDF_LZW="pdf/lzw",t.PDF_JPEG="pdf/jpeg",t.PDF_JP2000="pdf/jp2000",t.PDF_JBIG2="pdf/jbig2";}(Lo||(Lo={})),function(t){t.PAGE_DEFAULT="page/default",t.PAGE_A4="page/a4",t.PAGE_A4_REVERSE="page/a4reverse",t.PAGE_A3="page/a3",t.PAGE_A3_REVERSE="page/a3reverse",t.PAGE_LETTER="page/letter",t.PAGE_LETTER_REVERSE="page/letterreverse",t.PAGE_LEGAL="page/legal",t.PAGE_LEGAL_REVERSE="page/legalreverse";}(Oo||(Oo={})),function(t){t.PRINT="print",t.MODIFY_CONTENTS="modify_contents",t.COPY_CONTENTS="copy_contents",t.EXTRACT_CONTENTS="extract_contents",t.MODIFY_ANNOTATIONS="modify_annotations",t.FILL_IN="fill_in",t.ASSEMBLY="assembly",t.DEGRADED_PRINT="degraded_print";}(Wo||(Wo={})),new Map([[Wo.PRINT,2052],[Wo.MODIFY_CONTENTS,8],[Wo.COPY_CONTENTS,16],[Wo.MODIFY_ANNOTATIONS,32],[Wo.FILL_IN,256],[Wo.EXTRACT_CONTENTS,512],[Wo.ASSEMBLY,1024],[Wo.DEGRADED_PRINT,4]]);const No=new Map([[Oo.PAGE_DEFAULT,0],[Oo.PAGE_A4,2],[Oo.PAGE_A4_REVERSE,3],[Oo.PAGE_A3,4],[Oo.PAGE_A3_REVERSE,5],[Oo.PAGE_LETTER,6],[Oo.PAGE_LETTER_REVERSE,7],[Oo.PAGE_LEGAL,8],[Oo.PAGE_LEGAL_REVERSE,9]]),_o=new Map([[Lo.PDF_AUTO,0],[Lo.PDF_FAX4,2],[Lo.PDF_LZW,3],[Lo.PDF_JPEG,5],[Lo.PDF_JP2000,6],[Lo.PDF_JBIG2,7]]),Fo=new Map([[Uo.TIFF_AUTO,0],[Uo.TIFF_FAX3,1],[Uo.TIFF_FAX4,2],[Uo.TIFF_LZW,3],[Uo.TIFF_JPEG,5]]);var Ho=new WeakMap,Vo=new WeakMap,zo=new WeakMap;class $o{constructor(){f(this,Ho,{writable:!0,value:void 0}),f(this,Vo,{writable:!0,value:void 0}),f(this,zo,{writable:!0,value:void 0}),s(this,Ho,new Co),s(this,Vo,new Map);}destroy(){var t;null===(t=n(this,Ho))||void 0===t||t.terminate(),s(this,Ho,void 0);}convertPageSize(t,e){let i=0,n=0,s=0,o=0,r=0,a=0,l=0,h=0;const{pdfResolution:c,displayResolution:d}=ko;switch(t){case Oo.PAGE_A4:s=210/25.4*c,o=297/25.4*c,l=s,a=o;break;case Oo.PAGE_A4_REVERSE:s=297/25.4*c,o=210/25.4*c,l=s,a=o;break;case Oo.PAGE_A3:s=297/25.4*c,o=420/25.4*c,l=s,a=o;break;case Oo.PAGE_A3_REVERSE:s=420/25.4*c,o=297/25.4*c,l=s,a=o;break;case Oo.PAGE_LETTER:s=8.5*c,o=11*c,l=s,a=o;break;case Oo.PAGE_LETTER_REVERSE:s=11*c,o=8.5*c,l=s,a=o;break;case Oo.PAGE_LEGAL:s=8.5*c,o=14*c,l=s,a=o;break;case Oo.PAGE_LEGAL_REVERSE:s=14*c,o=8.5*c,l=s,a=o;break;default:i=e.mediaBox.left/d*c,n=e.mediaBox.top/d*c,s=e.mediaBox.width/d*c,o=e.mediaBox.height/d*c,r=e.cropBox.left/d*c,a=2*n+o-e.cropBox.top/d*c,l=Math.max(r+e.cropBox.width/d*c,r+1),h=Math.min(a-e.cropBox.height/d*c,a-1);}return {left:i,top:n,width:s,height:o,cropLeft:r,cropTop:a,cropRight:l,cropBottom:h}}convertPdfSettings(t){const e={};return e.author=null==t?void 0:t.author,e.compression=null!=t&&t.compression?_o.get(t.compression):void 0,e.creationDate=null==t?void 0:t.creationDate,e.creator=null==t?void 0:t.creator,e.keyWords=null==t?void 0:t.keyWords,e.modifiedDate=null==t?void 0:t.modifiedDate,e.pageType=null!=t&&t.pageType?No.get(t.pageType):void 0,e.producer=null==t?void 0:t.producer,e.quality=null==t?void 0:t.quality,e.subject=null==t?void 0:t.subject,e.title=null==t?void 0:t.title,e.version=null==t?void 0:t.version,null!=t&&t.password&&(e.encryptOptions={},e.encryptOptions.enabled=!0,e.encryptOptions.userPassword=t.password),e}async init(t){s(this,zo,t||{});const e=this.convertPdfSettings(t);await n(this,Ho).initPdfSetting(e);}async appendBlankPages(t,e,i){await n(this,Ho).insertBlankPages(-1,t,e,i);}async applyImageToPage(t,e,i){const{mediaBox:s,cropBox:o}=i,r=this.convertPageSize(n(this,zo).pageType,i);await n(this,Ho).setPageMediaBox(t,r.left,r.top,r.left+r.width,r.top+r.height),i.rotation&&await n(this,Ho).setPageRotation(t,i.rotation);const{displayResolution:a,pdfResolution:l}=ko;let h=r.width,c=r.height,d=0,u=0;if(n(this,zo).pageType&&n(this,zo).pageType!==Oo.PAGE_DEFAULT){const e={width:o.width/a*l,height:o.height/a*l},i=r.width/e.width,p=r.height/e.height;if(i<p){const t=e.height*i;u=(r.height-t)/2,h=r.width,c=t;}else {const t=e.width*p;d=(r.width-t)/2,h=t,c=r.height;}const g=o.left/a*l,f=(s.height-(o.top+o.height))/a*l;n(this,Vo).set(t,[h/e.width,0,0,c/e.height,d-h/e.width*g,u-c/e.height*f]);}d+=r.left,u+=r.top;let p=i.width,g=i.height,f=e;if(n(this,zo).imageScaleFactor){let t=Math.floor(i.width*n(this,zo).imageScaleFactor+.5),s=Math.floor(i.height*n(this,zo).imageScaleFactor+.5);if(t<1&&(t=1),s<1&&(s=1),t!==p&&s!==g){const i=new xo;await i.initImage({source:e}),await i.resize(t,s);f=(await i.getImage({})).imageData,p=t,g=s,await i.freeReservedData();}}const v=await n(this,Ho).addImageToPages(f,[t],{type:"image",imageWidth:h,imageHeight:c,position:[d,u]},p,g,1===i.bitDepth);return await n(this,Ho).setPageCropBox(t,r.cropLeft,r.cropBottom,r.cropRight,r.cropTop),await n(this,Ho).unloadPage(t),v}async appendImagePage(t,e){const{mediaBox:i}=e,s=this.convertPageSize(n(this,zo).pageType,e);let o=await n(this,Ho).insertBlankPage(-1,s.left+s.width,s.top+s.height);const{pageIndex:r}=o;await n(this,Ho).setPageMediaBox(r,s.left,s.top,s.left+s.width,s.top+s.height),e.rotation&&await n(this,Ho).setPageRotation(r,e.rotation);const{displayResolution:a,pdfResolution:l}=ko;let h=s.width,c=s.height,d=0,u=0;if(n(this,zo).pageType&&n(this,zo).pageType!==Oo.PAGE_DEFAULT){const t={width:i.width/a*l,height:i.height/a*l},e=s.width/t.width,o=s.height/t.height;if(e<o){const i=t.height*e;u=(s.height-i)/2,h=s.width,c=i;}else {const e=t.width*o;d=(s.width-e)/2,h=e,c=s.height;}n(this,Vo).set(r,[h/t.width,0,0,c/t.height,d,u]);}d+=s.left,u+=s.top;let p=e.width,g=e.height,f=t;if(n(this,zo).imageScaleFactor){let i=Math.floor(e.width*n(this,zo).imageScaleFactor+.5),s=Math.floor(e.height*n(this,zo).imageScaleFactor+.5);if(i<1&&(i=1),s<1&&(s=1),i!==p&&s!==g){const e=new xo;await e.initImage({source:t}),await e.resize(i,s);f=(await e.getImage({})).imageData,p=i,g=s,await e.freeReservedData();}}return o=await n(this,Ho).addImageToPages(f,[r],{type:"image",imageWidth:h,imageHeight:c,position:[d,u]},p,g,1===e.bitDepth),await n(this,Ho).setPageCropBox(r,s.cropLeft,s.cropBottom,s.cropRight,s.cropTop),await n(this,Ho).unloadPage(r),o}async appendRawPdfPages(t,e,i){await n(this,Ho).mergeRawPdfPages(t,e,i);}async replaceRawPdfPages(t,e,i,s){await n(this,Ho).replaceRawPdfPages(t,e,i,s);}async changePageImage(t,e,i){const s=this.convertPageSize(Oo.PAGE_DEFAULT,i);await n(this,Ho).clearPageObjects(t);return await n(this,Ho).addImageToPages(e,[t],{type:"image",imageWidth:s.width,imageHeight:s.height,position:[s.left,s.top]},i.width,i.height)}async setPageInfo(t){for(const[e,i]of t){const t=this.convertPageSize(Oo.PAGE_DEFAULT,i),{rotation:s}=i;await n(this,Ho).setPageCropBox(e,t.cropLeft,t.cropBottom,t.cropRight,t.cropTop),await n(this,Ho).setPageRotation(e,(s%360+360)%360);}}async setPageRotation(t){for(const[e,i]of t){const t=(i%360+360)%360;await n(this,Ho).setPageRotation(e,t);}}async getPdf(t){return n(this,Ho).getPdf(t)}updateAnnotPoint(t,e){return [t[0]*e[0]+t[1]*e[2]+e[4],t[0]*e[1]+t[1]*e[3]+e[5]]}fixAnnotationPosition(t,e){n(this,Vo).has(t)&&e.forEach((e=>{const i=this.updateAnnotPoint([e.rect[0],e.rect[1]],n(this,Vo).get(t)),s=this.updateAnnotPoint([e.rect[2],e.rect[3]],n(this,Vo).get(t));if(e.rect=[i[0],i[1],s[0],s[1]],"Highlight"===e.type||"StrikeOut"===e.type||"Underline"===e.type||"Squiggly"===e.type)e.quadPoints.forEach(((i,s)=>{const o=this.updateAnnotPoint([i[0],i[1]],n(this,Vo).get(t)),r=this.updateAnnotPoint([i[2],i[3]],n(this,Vo).get(t)),a=this.updateAnnotPoint([i[4],i[5]],n(this,Vo).get(t)),l=this.updateAnnotPoint([i[6],i[7]],n(this,Vo).get(t));e.quadPoints[s]=[o[0],o[1],r[0],r[1],a[0],a[1],l[0],l[1]];}));else if("Line"===e.type){const i=this.updateAnnotPoint([e.line[0],e.line[1]],n(this,Vo).get(t)),s=this.updateAnnotPoint([e.line[2],e.line[3]],n(this,Vo).get(t));e.line=[i[0],i[1],s[0],s[1]];}else if("Ink"===e.type)e.inkList.forEach((e=>{for(let i=0;i<e.length;i+=2){const[s,o]=this.updateAnnotPoint([e[i],e[i+1]],n(this,Vo).get(t));e[i]=s,e[i+1]=o;}}));else if("Polygon"===e.type||"PolyLine"===e.type)for(let i=0;i<e.vertices.length;i+=2){const[s,o]=this.updateAnnotPoint([e.vertices[i],e.vertices[i+1]],n(this,Vo).get(t));e.vertices[i]=s,e.vertices[i+1]=o;}}));}async removePageAnnotations(t){await n(this,Ho).deletePageAnnotationsExceptTypes(t,"Widget");}async setPageAnnotations(t,e,i){let s;return e&&e.length>0&&this.fixAnnotationPosition(t,e),i?e&&e.length>0&&(s=await n(this,Ho).addAnnotationsToPage(t,e)):s=await n(this,Ho).setPageAnnotations(t,e),s}async flattenPageAnnotations(t,e){e&&e.length>0&&this.fixAnnotationPosition(t,e);return await n(this,Ho).flattenPageAnnotations(t,e)}async flattenPage(t){return await n(this,Ho).flattenPage(t)}async getFontInfo(t){return await n(this,Ho).getFontInfo(t)}async ifFontsExist(t){return await n(this,Ho).ifFontsExist(t)}}class jo{constructor(){i(this,"imageWriter",void 0),this.imageWriter=new bo;}destroy(){var t;null===(t=this.imageWriter)||void 0===t||t.terminate(),this.imageWriter=void 0;}async save(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await this.imageWriter.saveImage(t,{outputType:e.outputType,jpegQuality:e.jpegQuality,returnType:e.returnType,is1Bit:e.is1Bit})}}class Xo{constructor(){i(this,"imageWriter",void 0),i(this,"tiffCompression",void 0),i(this,"tiffQuality",void 0),this.imageWriter=new bo,this.tiffCompression=Fo.get(Uo.TIFF_AUTO);}destroy(){var t;null===(t=this.imageWriter)||void 0===t||t.terminate(),this.imageWriter=void 0;}async init(t){if(await this.imageWriter.createTiff(),t&&(this.tiffQuality=t.quality,t.compression&&(this.tiffCompression=Fo.get(t.compression)),t.customTag))for(let e=0;e<t.customTag.length;e++)await this.imageWriter.addTiffTag(t.customTag[e].id,t.customTag[e].content,t.customTag[e].contentIsBase64);}async appendPage(t,e){await this.imageWriter.appendImage(t,{inputType:void 0,tiffFormat:this.tiffCompression,jpegQuality:this.tiffQuality,is1Bit:null==e?void 0:e.is1Bit});}async getTiff(){return this.imageWriter.getTiff()}}class Go{constructor(t){i(this,"uid",void 0),this.uid=t||Jn();}equals(t){return null!=t&&void 0!==t&&(this===t||!!function(t){return t instanceof Go}(t)&&this.uid===t.uid)}}class Yo extends Go{}class qo{constructor(t){i(this,"type",void 0),i(this,"uid",void 0),this.type=t,this.uid=Jn();}}class Jo{constructor(t){i(this,"bubbles",!0),i(this,"cancelBubble",!0),i(this,"cancelable",!1),i(this,"composed",!1),i(this,"currentTarget",void 0),i(this,"defaultPrevented",!1),i(this,"eventPhase",Jo.prototype.NONE),i(this,"isTrusted",void 0),i(this,"returnValue",void 0),i(this,"srcElement",void 0),i(this,"target",void 0),i(this,"timeStamp",void 0),i(this,"type",void 0),i(this,"detail",void 0),i(this,"view",void 0),i(this,"which",void 0),i(this,"path",void 0),i(this,"immediatePropagationStopped",!1),i(this,"propagationStopped",!1),i(this,"nativeEvent",void 0),i(this,"originalEvent",void 0),i(this,"eventService",void 0),i(this,"NONE",0),i(this,"CAPTURING_PHASE",1),i(this,"AT_TARGET",2),i(this,"BUBBLING_PHASE",3),this.eventService=t;}initUIEvent(t,e,i,n,s){}composedPath(){const{path:t,eventService:e,target:i}=this;return !e||t&&t[this.path.length-1]===i||(this.path=i?e.getPropagationPath(i):[]),this.path}bindEvents(t,e,i){}preventDefault(){const{nativeEvent:t}=this;t instanceof Event&&t.cancelable&&t.preventDefault(),this.defaultPrevented=!0;}stopImmediatePropagation(){this.immediatePropagationStopped=!0;}stopPropagation(){this.propagationStopped=!0;}}function Zo(t,e){e.isTrusted=t.isTrusted,e.srcElement=t.srcElement,e.timeStamp=performance.now(),e.type=t.type,e.detail=t.detail,e.view=t.view,e.which=t.which;}class Qo extends Jo{constructor(t,e){super(null),this.type=t,this.detail=e;}}class Ko{constructor(){i(this,"pubsub",Kn.create());}addEventListener(t,e,i){let n,s=zn(i)&&i;Wn(i)&&(s=i.capture,n=i.once),t=s?`${t}:capture`:t,e=$n(e)?e:e.handleEvent,this.pubsub.on(t,e,this,n);}dispatchEvent(t){const e=this.ownerDocument||this.document;var i;e&&(t.eventService=(null===(i=e.defaultView)||void 0===i?void 0:i.eventService)||null,t.defaultPrevented=!1,t.path=[],t.target=this,er(t));return !t.defaultPrevented}removeEventListener(t,e,i){let n=zn(i)&&i;Wn(i)&&(n=i.capture),t=n?`${t}:capture`:t,e=$n(e)?e:e.handleEvent,this.pubsub.off(t,e);}removeAllEventListeners(){this.pubsub.removeAllEventListeners();}getAllEvents(){return this.pubsub.getAllEvents()}}function tr(t,e){const i=t.currentTarget.getAllEvents()[e]||[];for(let e=0,n=i.length;e<n;e++){if(t.immediatePropagationStopped)return;const{context:n,fn:s}=i[e];s.call(n,t);}}function er(t,e){var i;if(e=null!==(i=e)&&void 0!==i?i:t.type,t.propagationStopped=!1,t.immediatePropagationStopped=!1,!t.target)return;const n=t.composedPath(),s=n.length;t.eventPhase=t.CAPTURING_PHASE;for(let i=0;i<s-1;i++){t.currentTarget=n[i];if(tr(t,`${e}:capture`),ir(t))return}if(t.eventPhase=t.AT_TARGET,t.currentTarget=t.target,tr(t,e),!ir(t)){t.eventPhase=t.BUBBLING_PHASE;for(let i=s-2;i>=0;i--)if(t.currentTarget=n[i],tr(t,e),ir(t))return}}function ir(t){return t.propagationStopped||t.immediatePropagationStopped}const nr=t=>t/180*Math.PI,sr=t=>t/Math.PI*180;class or{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,"x",0),i(this,"y",0),this.x=t,this.y=e;}static fromValue(t,e){return new or(t,e)}static fromPoint(t){return new or(t.x,t.y)}static fromTwoPoint(t,e){var i,n,s,o;return new or((null!==(i=e.x)&&void 0!==i?i:0)-(null!==(n=t.x)&&void 0!==n?n:0),(null!==(s=e.y)&&void 0!==s?s:0)-(null!==(o=t.y)&&void 0!==o?o:0))}static create(){return new or(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)}setFromVector(t){this.x=t.x,this.y=t.y;}clone(){return new or(this.x,this.y)}norm(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}projectionTo(t){const e=Math.hypot(t.x,t.y);return this.dot(t)/e}angle(t){const e=this.norm()*Math.hypot(t.x,t.y);return Math.acos(this.dot(t)/e)}equals(t){return this.x===t.x&&this.y===t.y}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}lerp(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:i,y:n}=this;return new or(i+(t.x-i)*e,n+(t.y-n)*e)}normalize(){const t=this.norm();return this.x/=t,this.y/=t,this}negate(){return this.x*=-1,this.y*=-1,this}cross(t){return this.x*t.y-this.y*t.x}add(t){return new or(this.x+t.x,this.y+t.y)}addSelf(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return new or(this.x-t.x,this.y-t.y)}subSelf(t){return this.x-=t.x,this.y-=t.y,this}multiply(t){return new or(this.x*t.x,this.y*t.y)}multiplySelf(t){return this.x*=t.x,this.y*=t.y,this}}class rr{constructor(t){i(this,"a",1),i(this,"b",0),i(this,"c",0),i(this,"d",1),i(this,"e",0),i(this,"f",0),i(this,"m11",1),i(this,"m12",0),i(this,"m13",0),i(this,"m21",0),i(this,"m22",1),i(this,"m23",0),i(this,"m31",0),i(this,"m32",0),i(this,"m33",1),t&&this.setFromMatrix(t);}static compose(t,e,i){const n=nr(i),s=Math.cos(n),o=Math.sin(n),r=e.x*s,a=e.x*o,l=-e.y*o,h=e.y*s,c=t.x,d=t.y;return rr.fromMatrix({m11:r,m21:l,m31:c,m12:a,m22:h,m32:d,m13:0,m23:0,m33:1})}static create(t){return new rr(t)}static fromMatrix(t){return (new rr).setFromMatrix(t)}static createRotationMatrix(t,e){const i=cr(t,e);return rr.fromMatrix(i)}static createTranslationMatrix(t){const e=lr(t.x,t.y);return rr.fromMatrix(e)}static createScaleMatrix(t){const e=hr(t.x,t.y);return rr.fromMatrix(e)}setFromMatrix(t){if(Array.isArray(t)){const[e,i,n,s,o,r]=t;this.m11=e,this.m12=i,this.m13=0,this.m21=n,this.m22=s,this.m23=0,this.m31=o,this.m32=r,this.m33=1;}else {var e,i,n,s,o,r,a,l,h,c,d,u,p,g,f;this.m11=null!==(e=null!==(i=t.m11)&&void 0!==i?i:t.a)&&void 0!==e?e:1,this.m12=null!==(n=null!==(s=t.m12)&&void 0!==s?s:t.b)&&void 0!==n?n:0,this.m13=null!==(o=t.m13)&&void 0!==o?o:0,this.m21=null!==(r=null!==(a=t.m21)&&void 0!==a?a:t.c)&&void 0!==r?r:0,this.m22=null!==(l=null!==(h=t.m22)&&void 0!==h?h:t.d)&&void 0!==l?l:1,this.m23=null!==(c=t.m23)&&void 0!==c?c:0,this.m31=null!==(d=null!==(u=t.m31)&&void 0!==u?u:t.e)&&void 0!==d?d:0,this.m32=null!==(p=null!==(g=t.m32)&&void 0!==g?g:t.f)&&void 0!==p?p:0,this.m33=null!==(f=t.m33)&&void 0!==f?f:1;}return this.a=this.m11,this.b=this.m12,this.c=this.m21,this.d=this.m22,this.e=this.m31,this.f=this.m32,this}clone(){return rr.fromMatrix(this)}translate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.clone().translateSelf(t,e)}translateSelf(){const t=lr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0);return this.multiplySelf(t)}multiplySelf(){const t=ar(this,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return this.setFromMatrix(t)}preMultiplySelf(){const t=ar(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this);return this.setFromMatrix(t)}multiply(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.clone().multiplySelf(t)}scaleSelf(t,e,i,n){var s,o;void 0===e&&(e=t),null!==(s=i)&&void 0!==s||(i=0),null!==(o=n)&&void 0!==o||(n=0),0===i&&0===n||this.translateSelf(i,n);const r=hr(t,e);return this.multiplySelf(r)}scale(t,e,i,n){return this.clone().scaleSelf(t,e,i,n)}rotateSelf(t,e,i){var n,s;null!==(n=e)&&void 0!==n||(e=0),null!==(s=i)&&void 0!==s||(i=0);const o=cr(t,{x:e,y:i});return this.multiplySelf(o)}rotate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.clone().rotateSelf(t)}invertSelf(){const t=function(t){const{m11:e,m21:i,m31:n,m12:s,m22:o,m32:r}=t,a=1/(e*o-s*i);return {m11:o*a,m21:-i*a,m31:(i*r-o*n)*a,m12:-s*a,m22:e*a,m32:(s*n-e*r)*a,m13:0,m23:0,m33:1}}(this);return this.setFromMatrix(t)}inverse(){return this.clone().invertSelf()}getScaling(){const t=Math.hypot(this.m11,this.m12),e=Math.hypot(this.m21,this.m22);return new or(t,e)}getScaleMatrix(){const t=this.getScaling(),e=hr(t.x,t.y);return rr.fromMatrix(e)}getTranslation(){return new or(this.m31,this.m32)}getRotationMatrix(){const t=this.getScaling(),e={m11:this.m11/t.x,m12:this.m12/t.x,m13:0,m21:this.m21/t.y,m22:this.m22/t.y,m23:0,m31:0,m32:0,m33:1};return rr.fromMatrix(e)}getRotation(){const t=Math.atan2(this.m12,this.m11);return sr(t)}decompose(){let{m11:t,m12:e,m21:i,m22:n}=this;const s={x:this.m31,y:this.m32},o={x:Math.hypot(t,e),y:Math.hypot(i,n)};t*n-e*i<0&&(t<n?o.x=-o.x:o.y=-o.y),o.x&&(t/=o.x,e/=o.x),o.y&&(i/=o.y,n/=o.y);const r=Math.atan2(e,t);return {translation:s,scale:o,rotation:sr(r)}}transformPoint(t){const{m11:e,m12:i,m21:n,m22:s,m31:o,m32:r}=this;return {x:t.x*e+t.y*n+o,y:t.x*i+t.y*s+r}}}function ar(t,e){const i={},{m11:n,m21:s,m31:o,m12:r,m22:a,m32:l,m13:h,m23:c,m33:d}=t,{m11:u,m21:p,m31:g,m12:f,m22:v,m32:m,m13:y,m23:x,m33:w}=e;return i.m11=n*u+s*f+o*y,i.m21=n*p+s*v+o*x,i.m31=n*g+s*m+o*w,i.m12=r*u+a*f+l*y,i.m22=r*p+a*v+l*x,i.m32=r*g+a*m+l*w,i.m13=h*u+c*f+d*y,i.m23=h*p+c*v+d*x,i.m33=h*g+c*m+d*w,i}function lr(){return {m11:1,m21:0,m31:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,m12:0,m22:1,m32:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,m13:0,m23:0,m33:1}}function hr(){return {m11:arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,m21:0,m31:0,m12:0,m22:arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,m32:0,m13:0,m23:0,m33:1}}function cr(){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0};const e=nr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),i=Math.cos(e),n=Math.sin(e),{x:s,y:o}=t;return {m11:i,m21:-n,m31:s-s*i+o*n,m12:n,m22:i,m32:o-s*n-o*i,m13:0,m23:0,m33:1}}const dr=new class{recursiveUpdateHierarchy(t){const{transform:e,childNodes:i}=t;e.frozen||(e.frozen=!0,(e.localDirty||e.worldDirty)&&this.updateHierarchy(t),i.forEach((t=>{this.recursiveUpdateHierarchy(t);})));}querySelector(t,e){return t.startsWith("#")?e.find((e=>e.id===t.substring(1))):null}querySelectorAll(t,e){return []}append(t,e,i){t.parentNode&&this.remove(t),t.parentNode=e;const{childNodes:n,sortable:s}=e;void 0!==i?n.splice(i,0,t):n.push(t),s&&(s.dirty=!0);const{transform:o}=t;o&&this.dirtyWorld(t,o),o.frozen&&this.unfreezeParentToRoot(t);}remove(t){const{parentNode:e}=t;let i=!0;if(!e)return i=!1,i;const{sortable:n}=e;n&&(n.dirty=!0);const{childNodes:s}=e,o=s.indexOf(t);o>-1?(i=!0,s.splice(o,1)):i=!1;const{transform:r}=t;return r&&this.dirtyWorld(t,r),t.parentNode=null,i}isChildExist(t){const{parentNode:e}=t;if(!e)return !1;const{childNodes:i}=e;return !(i.indexOf(t)<0)}setOrigin(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Xn(e)&&(e=or.fromValue(e,i));const{transform:n}=t;n.origin.equals(e)||(n.origin.setFromVector(e),this.dirtyLocal(t,n));}getOrigin(t){return t.transform.origin.clone()}setPosition(t,e){const{transform:i}=t,n=this.getPosition(t);if(n.equals(e))return;let s=this.getWorldTransform(t);if(i.position.setFromVector(e),t.hasParentTransform()){s=rr.create().translateSelf(e.x-n.x,e.y-n.y).multiply(s);const{worldTransform:o}=t.parentNode.transform,r=this.getWorldTransform(t);r.m31=e.x,r.m32=e.y;const a=o.inverse().multiply(s),l=this.getOrigin(t),h=a.getScaleMatrix().inverse(),c=a.translate(l.x,l.y).multiply(h),d=c.getRotationMatrix().inverse(),u=c.multiply(d).getTranslation();u.subSelf(l),i.localPosition.setFromVector(u);}else i.localPosition.setFromVector(e);this.dirtyLocal(t,i);}setLocalPosition(t,e){const{transform:i}=t;i.localPosition.equals(e)||(i.localPosition.setFromVector(e),this.dirtyLocal(t,i));}getPosition(t){const e=this.getWorldTransform(t),{transform:i}=t,n=e.getTranslation();return i.position.setFromVector(n),t.transform.position.clone()}getLocalPosition(t){return t.transform.localPosition.clone()}translate(t,e){if(0===e.x&&0===e.y)return;const i=this.getPosition(t);i.addSelf(e),this.setPosition(t,i);}translateLocal(t,e){const{transform:i}=t;if(0===e.x&&0===e.y)return;const n=or.fromPoint(e).multiplySelf(i.localScale),s=rr.createRotationMatrix(i.localRotation).transformPoint(n);i.localPosition.addSelf(s),this.dirtyLocal(t,i);}scaleLocal(t,e){const{transform:i}=t;i.localScale.multiplySelf(e),this.dirtyLocal(t,i);}setLocalScale(t,e){const{transform:i}=t;i.localScale.equals(e)||(i.localScale.setFromVector(e),this.dirtyLocal(t,i));}getScale(t){const{transform:e}=t,i=this.getWorldTransform(t).getScaling();return e.scale.setFromVector(i),e.scale.clone()}getLocalScale(t){return t.transform.localScale.clone()}getRotation(t){const{transform:e}=t,i=this.getWorldTransform(t).getRotation();return e.rotation=i,i}getLocalRotation(t){return t.transform.localRotation}rotate(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e)return;const{transform:i}=t;if(t.hasParentTransform()){const n=this.getRotation(t),s=-this.getRotation(t.parentNode)+e+n;i.localRotation=s,this.dirtyLocal(t,i);}else this.rotateLocal(t,e);}rotateLocal(t,e){const{transform:i}=t;i.localRotation+=e,this.dirtyLocal(t,i);}setAngle(t,e){const{transform:i}=t;if(t.hasParentTransform()){const n=this.getRotation(t.parentNode);i.localRotation=-n+e,this.dirtyLocal(t,i);}else this.setLocalAngle(t,e);}setLocalAngle(t,e){const{transform:i}=t;i.localRotation=e,this.dirtyLocal(t,i);}getAngle(t){return this.getWorldTransform(t).getRotation()}getLocalAngle(t){return this.getLocalRotation(t)}setLocalTransform(t,e){const i=this.getOrigin(t),{rotation:n,scale:s}=e.decompose(),o=rr.createScaleMatrix(s).inverse(),r=e.translate(i.x,i.y).multiply(o).getTranslation();r.subSelf(i),this.setLocalPosition(t,r),this.setLocalAngle(t,n),this.setLocalScale(t,s);}resetLocalTransform(t){this.setLocalScale(t,new or(1,1)),this.setLocalPosition(t,new or(0,0)),this.setLocalAngle(t,0);}getWorldTransform(t){const{transform:e}=t;if(!e.worldDirty&&!e.localDirty)return e.worldTransform;const{parentNode:i}=t;return i&&i.transform&&this.getWorldTransform(i),this.updateHierarchy(t),e.worldTransform.clone()}getLocalTransform(t){const{transform:e}=t;return e.localDirty&&e.updateLocalTransform(),e.localTransform.clone()}getBounds(t,e){const{renderable:i,childNodes:n}=t;if(e&&!i.renderBoundsDirty&&i)return i.renderBounds;if(!e&&!i.boundsDirty&&i.bounds)return i.bounds;let s=this.getTransformedGeometryBounds(t,e);n.forEach((t=>{const i=this.getBounds(t,e);i&&(s?s.addBounds(i):s=el.fromBounds(i));}));const{clipPath:o}=t.style;if(o){const e=this.getTransformedGeometryBounds(o,!0);let i=null;e&&(i=el.create(),i.setFromTransformedBounds(this.getWorldTransform(t),e)),s?i&&(s=i.intersection(s)):s=i;}return e?(i.renderBoundsDirty=!1,s&&(i.renderBounds=s)):(i.boundsDirty=!1,s&&(i.bounds=s)),s||el.create()}getLocalBounds(t){const{parentNode:e}=t;if(e){let i=rr.create();if(e.transform){i=this.getWorldTransform(e).inverse();}const n=this.getBounds(t);if(!el.isEmpty(n)){const t=el.create();return t.setFromTransformedBounds(i,n),t}}return this.getBounds(t)}getGeometryBounds(t,e){const{geometry:i}=t;return (e?i.renderBounds:i.contentBounds)||el.create()}getBoundingClientRect(t){var e;let i;const n=this.getGeometryBounds(t);el.isEmpty(n)||(i=el.create(),i.setFromTransformedBounds(this.getWorldTransform(t),n));const s=null===(e=t.ownerDocument)||void 0===e?void 0:e.defaultView.getContextService().getBoundingClientRect();return i?{x:i.minX+((null==s?void 0:s.left)||0),y:i.minY+((null==s?void 0:s.top)||0),width:i.maxX-i.minX,height:i.maxY-i.minY}:{x:(null==s?void 0:s.left)||0,y:(null==s?void 0:s.top)||0,width:0,height:0}}updateHierarchy(t){const{transform:e}=t;if(e.localDirty&&e.updateLocalTransform(),e.worldDirty){var i;let n=null==t||null===(i=t.parentNode)||void 0===i?void 0:i.transform;t.parentNode&&n||(n=new fr),e.updateWorldTransform(n);}}getTransformedGeometryBounds(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=this.getGeometryBounds(t,e);if(!el.isEmpty(i)){const e=el.create();return e.setFromTransformedBounds(this.getWorldTransform(t),i),e}return null}dirtyLocal(t,e){e.localDirty||(e.localDirty=!0,e.worldDirty||this.dirtyWorld(t,e));}dirtyWorld(t,e){e.worldDirty||this.unfreezeParentToRoot(t),this.recursiveDirtyWorld(t,e),function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t;for(;i;){const{renderable:t}=i;t&&(t.boundsDirty=!0,t.renderBoundsDirty=!0),i=i.parentNode;}const n=new Qo("bounds-changed",{affectChildren:e});t.dispatchEvent(n);}(t,!0);}recursiveDirtyWorld(t,e){if(e.worldDirty)return;e.worldDirty=!0,e.frozen=!1,t.childNodes.forEach((t=>{const{transform:e}=t;e.worldDirty||this.recursiveDirtyWorld(t,e);}));const{renderable:i}=t;i&&(i.boundsDirty=!0,i.renderBoundsDirty=!0);const n=new fl("DOMAttrModified",t,null,null,"modelMatrix",fl.MODIFICATION,null,null);t.dispatchEvent(n);}unfreezeParentToRoot(t){let e=t;for(;e;){const{transform:t}=e;t&&(t.frozen=!1),e=e.parentNode;}}};class ur{constructor(){i(this,"contentBounds",void 0),i(this,"renderBounds",void 0);}}class pr{constructor(){i(this,"boundsDirty",!0),i(this,"bounds",void 0),i(this,"renderBoundsDirty",!0),i(this,"renderBounds",void 0);}isRenderable(){return this.boundsDirty||this.renderBoundsDirty}toRenderable(){this.boundsDirty=!0,this.renderBoundsDirty=!0;}}class gr{constructor(){i(this,"renderOrder",0),i(this,"lastSortedIndex",void 0),i(this,"sorted",void 0),i(this,"dirty",!1);}}let fr=class{constructor(){i(this,"frozen",!0),i(this,"worldDirty",!1),i(this,"localDirty",!1),i(this,"localRotation",0),i(this,"rotation",0),i(this,"localScale",or.create(1,1)),i(this,"scale",or.create(1,1)),i(this,"localPosition",or.create(0,0)),i(this,"position",or.create(0,0)),i(this,"localSkew",or.create(0,0)),i(this,"skew",or.create(0,0)),i(this,"origin",or.create(0,0)),i(this,"worldTransform",rr.create()),i(this,"localTransform",rr.create());}updateLocalTransform(){const{origin:t,localScale:e,localPosition:i,localRotation:n}=this,s=rr.create();s.translateSelf(t.x,t.y);const o=rr.compose(i,e,n);s.multiplySelf(o),s.translateSelf(-t.x,-t.y),this.localTransform.setFromMatrix(s),this.localDirty=!1;}updateWorldTransform(t){const e=t.worldTransform.clone();e.multiplySelf(this.localTransform),this.worldTransform.setFromMatrix(e),this.worldDirty=!1;}};function vr(t,e){if(Number.isNaN(e))return {unit:"px",value:0};if(Us(e))return {unit:"px",value:0};if(Xn(e))return {unit:"px",value:e};if(e=e.trim().toLowerCase(),Number.isFinite(Number(e))&&"px".search(t)>=0)return {unit:"px",value:Number(e)};const i=[];e=e.replace(t,(t=>(i.push(t),`U${t}`)));const n=`U(${t.source})`;return i.map((t=>({unit:t,value:Number(e.replace(new RegExp(`U${t}`,"g"),"").replace(new RegExp(n,"g"),"*0"))})))[0]}const mr=t=>vr(/px|pt/g,t),yr=t=>vr(/px|%|em/g,t),xr=t=>vr(/deg|rad|grad|turn/g,t);class wr{constructor(t,e,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];i(this,"r",void 0),i(this,"g",void 0),i(this,"b",void 0),i(this,"alpha",void 0),i(this,"isNone",void 0),i(this,"formatted",""),this.r=t,this.g=e,this.b=n,this.alpha=s,this.isNone=o,this.formatted=`rgba(${t}, ${e}, ${n}, ${s})`;}clone(){return new wr(this.r,this.g,this.b,this.alpha)}}class br{constructor(t,e){i(this,"type",void 0),i(this,"value",void 0),this.type=t,this.value=e;}clone(){return new br(this.type,this.value)}}const Sr={left:180,top:-90,bottom:90,right:0,"left top":225,"top left":225,"left bottom":135,"bottom left":135,"right top":-45,"top right":-45,"right bottom":45,"bottom right":45},Cr=t=>{let e;return e="angular"===t.type?Number(t.value):Sr[t.value]||0,{value:e,unit:"deg"}},Pr=t=>{if(t.includes("linear")||t.includes("radial")){return us(t).map((t=>{let{type:e,orientation:i,colorStops:n}=t;!function(t){var e;const{length:i}=t;var n;t[i-1].length=null!==(e=t[i-1].length)&&void 0!==e?e:{type:"%",value:"100"},i>1&&(t[0].length=null!==(n=t[0].length)&&void 0!==n?n:{type:"%",value:"0"});let s=0,o=Number(t[0].length.value);for(let e=1;e<i;e++){var r;const i=null===(r=t[e].length)||void 0===r?void 0:r.value;if(!Us(i)&&!Us(o)){for(let n=1;n<e-s;n++)t[s+n].length={type:"%",value:`${o+(Number(i)-o)*n/(e-s)}`};s=e,o=Number(i);}}}(n);const s=n.map((t=>({offset:{value:t.length.value,unit:"%"},color:ds(t)})));if("linear-gradient"===e)return new br(1,{angle:i?Cr(i):{value:0,unit:"deg"},steps:s});if("radial-gradient"===e){i||(i=[{type:"shape",value:"circle"}]);const t=i[0];if("shape"===(null==t?void 0:t.type)&&"circle"===(null==t?void 0:t.value)){const{cx:i,cy:n}=(t=>{let e=50,i=50,n="%",s="%";if("position"===(null==t?void 0:t.type)){const{x:o,y:r}=t.value;"position-keyword"===(null==o?void 0:o.type)&&("left"===o.value?e=0:"center"===o.value?e=50:"right"===o.value?e=100:"top"===o.value?i=0:"bottom"===o.value&&(i=100)),"position-keyword"===(null==r?void 0:r.type)&&("left"===r.value?e=0:"center"===r.value?i=50:"right"===r.value?e=100:"top"===r.value?i=0:"bottom"===r.value&&(i=100)),"px"!==(null==o?void 0:o.type)&&"%"!==(null==o?void 0:o.type)&&"em"!==(null==o?void 0:o.type)||(n=null==o?void 0:o.type,e=Number(o.value)),"px"!==(null==r?void 0:r.type)&&"%"!==(null==r?void 0:r.type)&&"em"!==(null==r?void 0:r.type)||(s=null==r?void 0:r.type,i=Number(r.value));}return {cx:{value:e,unit:n},cy:{value:i,unit:s}}})(null==t?void 0:t.at);let o;if(null!=t&&t.style){const{type:i,value:n}=t.style;o="extent-keyword"===i?n:{value:n,unit:e};}return new br(2,{cx:i,cy:n,size:o,steps:s})}}}))}};function Tr(t){const e=t.replace(/rgba?\(/,"").replace(/\)/,"").replace(/[\s+]/g,"").split(","),i=parseFloat(e[3]||"1"),n=Math.floor(i*parseInt(e[0],10)+255*(1-i)),s=Math.floor(i*parseInt(e[1],10)+255*(1-i)),o=Math.floor(i*parseInt(e[2],10)+255*(1-i));return `#${`0${n.toString(16)}`.slice(-2)}${`0${s.toString(16)}`.slice(-2)}${`0${o.toString(16)}`.slice(-2)}`}function Ar(t){return /^hsla?\(.+\)$/i.test(t)}function kr(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(Us(t))return null;if("currentColor"===t&&(t="black"),"transparent"===t)return new wr(0,0,0,0);const e=Pr(t);if(e)return e;if(Ar){const e=document.createElement("div");e.style.color=t,t=e.style.color;}const i=Bn(t),n=[0,0,0,0];return null!==i&&(n[0]=parseInt(i.r,10)||0,n[1]=parseInt(i.g,10)||0,n[2]=parseInt(i.b,10)||0,n[3]=parseFloat(i.opacity)),new wr(...n)}function Er(t){let e=null;On(t)&&(e=t),Gn(t)&&(e=t.split(" "));for(let t=0;t<3;t++)e[t]?e[t]=mr(e[t]).value:e[t]=0;const i=kr(e[3]);return e[3]=i?i.formatted:"black",e.slice(0,4)}function Dr(t){const e=[];return Gn(t)?t.split(" ").forEach((t=>{const i=mr(t);i&&e.push(i.value);})):e.push(...t),1===e.length?[e[0],e[0]]:e}const Rr=t=>{let e=t;if(Gn(t)){const i=yr(t);"%"===i.unit&&(e=i.value/100),"px"===i.unit&&(e=i.value);}return e>1&&(e=1),e},Ir={visibility:"visible",x:0,y:0,zIndex:0,anchor:[0,0],lineDash:[0,0],opacity:1,fillOpacity:1,borderOpacity:1,miterLimit:10,lineDashOffset:0,lineJoin:"miter",lineCap:"butt",borderColor:"black",renderBlendMode:"normal"},Mr={color:"rgb(0,0,0)",fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",fontSize:20};function Br(t){const e=[];return t.forEach((t=>{e.push({...Mr,...t,fontSize:mr(t.fontSize||Mr.fontSize)});})),e}function Ur(t,e,i,n){const{x:s=0,y:o=0}=i.parsedStyle,{x:r,y:a}=i.getLocalPosition();i.boundsDirty=!0,"x"===n&&s===r||"y"===n&&o===a||i.setLocalPosition(s,o);}function Lr(t,e,i){if(!(i instanceof Na||i instanceof _a||i instanceof Ba))return;if(t===e)return;i.pathDirty=!0,i.boundsDirty=!0,i.getPath();const{left:n,top:s}=i.getBoundingRect();i.updatePosition(n,s),i.updateOrigin();}function Or(t,e,i){!(i instanceof Fa)||i instanceof ja||i instanceof Ma||t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath(),i.updateOrigin());}function Wr(t,e,i){(i instanceof Da||i instanceof Ra||i instanceof Ia)&&t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function Nr(t,e,i){if(!(i instanceof Va||i instanceof _a))return;if(t===e)return;i.pathDirty=!0,i.boundsDirty=!0,i.getPath();const{left:n,top:s}=i.getBoundingRect();i.updatePosition(n,s),i.updateOrigin();}function _r(t,e,i){t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function Fr(t,e,i){i instanceof Ha&&t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function Hr(t,e,i,n){i instanceof Xa&&t!==e&&(i.setLimitWidth(i.parsedStyle.width.value),i.pathDirty=!0,i.boundsDirty=!0,("freeTextWriter"!==i.textType||"freeTextWriter"===i.textType&&["width","textContents"].includes(n))&&i.calculateTextLines(),i.getPath());}class Vr{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,"x",void 0),i(this,"y",void 0),this.x=t,this.y=e;}static fromPoint(t){return new Vr(t.x,t.y)}setFromPoint(t){return this.x=t.x||0,this.y=t.y||0,this}clone(){return new Vr(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}distanceTo(t){return Math.hypot(this.x-t.x,this.y-t.y)}lerpTo(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;return new Vr(this.x+e*(t.x-this.x),this.y+e*(t.y-this.y))}footPointInSegment(t,e){const i=or.fromTwoPoint(t,this),n=or.fromTwoPoint(t,e),s=n.norm(),o=Vr.fromPoint(t);if(0===s)return o;const r=i.projectionTo(n)/s;return o.lerpTo(e,r)}perpendicularToSegment(t,e){const i=this.footPointInSegment(t,e);return this.distanceTo(i)}}function zr(t,e,i){const n=t.x-e.x,s=t.y-e.y;let o=(i.x-t.x)*n+(i.y-t.y)*s;o/=n*n+s*s;return new Vr(t.x+o*n,t.y+o*s)}function $r(t,e,i,n){let s=t[0]*(i[1]-e[1])+e[0]*(t[1]-i[1])+i[0]*(e[1]-t[1]),o=t[0]*(n[1]-e[1])+e[0]*(t[1]-n[1])+n[0]*(e[1]-t[1]);return !((s^o)>=0&&0!==s&&0!==o)&&(s=i[0]*(t[1]-n[1])+n[0]*(i[1]-t[1])+t[0]*(n[1]-i[1]),o=i[0]*(e[1]-n[1])+n[0]*(i[1]-e[1])+e[0]*(n[1]-i[1]),!((s^o)>=0&&0!==s&&0!==o))}function jr(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}function Xr(t,e,i,n,s){const o=s||[],r=t[e],a=t[i];let l=0,h=1;for(let n=e+1;n<i;n++){const e=jr(zr(r,a,t[n]),t[n]);e>l&&(l=e,h=n);}return l>=n?(Xr(t,e,h,n,o),Xr(t,h,i,n,o)):(!o.length&&r&&o.push(r),o.push(a)),o}function Gr(t,e,i,n,s,o){const r=function(t,e,i,n,s,o){const r=function(t,e,i){const n=Math.cos(t),s=Math.sin(t);return function(t,o){return {x:n*(t-e)+s*(o-i),y:-s*(t-e)+n*(o-i)}}}((p=s-t,g=o-e,Math.atan2(g,p)),(t+s)/2,(e+o)/2),a=r(t,e),l=r(i,n),h=r(s,o),c=Math.abs(a.x),[d,u]=[l.y/2,0].sort(((t,e)=>t-e));var p,g;let f,v;l.x>=a.x&&l.x<=h.y?[f,v]=[a.x,h.x]:l.x>0?[f,v]=[a.x,.5*(l.x+c*c/l.x)]:[f,v]=[.5*(l.x+c*c/l.x),h.x];return function(t,e,i){const n=r(t,e);return !(n.x<f-i||n.x>v+i)&&!(n.y<d-i||n.y>u+i)}}(t,e,i,n,s,o),{getDistance:a}=function(t,e,i,n,s,o){const r=[i-t,n-e],a=[t-2*i+s,e-2*n+o],l=[2*r[0],2*r[1]],h=1/qr(a,a),c=h*qr(r,a),d=c*c,u=qr(r,r),p=3**.5,g=0===qr(a,a)?function(t){return 0===u?0:Yr(-qr(r,t)/2/u,0,1)}:function(t){const e=h*(2*u+qr(t,a))/3,i=h*qr(t,r),n=e-d,s=c*(2*d-3*e)+i;let o=s*s+4*(n*n*n);if(o>=0){o=Math.sqrt(o);const t=(o-s)/2,e=(-o-s)/2;return Yr(Math.sign(t)*Math.abs(t)**(1/3)+Math.sign(e)*Math.abs(e)**(1/3)-c,0,1)}const l=Math.sqrt(-n),g=Math.acos(s/(n*l*2))/3,f=Math.cos(g),v=Math.sin(g)*p;return [Yr((f+f)*l-c,0,1),Yr((-v-f)*l-c,0,1)]};return {getDistance(i,n){const s=[t-i,e-n],o=g(s);if("number"==typeof o)return Math.sqrt(Jr((l[0]+a[0]*o)*o+s[0],(l[1]+a[1]*o)*o+s[1]));const[r,h]=o;return Math.sqrt(Math.min(Jr(s[0]+(l[0]+a[0]*r)*r,s[1]+(l[1]+a[1]*r)*r),Jr(s[0]+(l[0]+a[0]*h)*h,s[1]+(l[1]+a[1]*h)*h)))}}}(t,e,i,n,s,o);return {isHit:function(t,e){return function(t,e,i){return !!r(t,e,i)&&a(t,e)<=i}(t[0],t[1],e)}}}function Yr(t,e,i){return Math.min(Math.max(t,e),i)}function qr(t,e){return t[0]*e[0]+t[1]*e[1]}function Jr(t,e){return t*t+e*e}function Zr(t,e,i,n,s){const{PI:o,cos:r,sin:a,min:l,max:h,tan:c}=Math;s-n>2*o&&(s=n+2*o);let d=h(o/12,(s-n)/12);const u=[];for(u.push({x:t+i*r(n),y:e+i*a(n)});n<s;){const o=t+i*r(n),h=e+i*a(n),p=l(s,n+d);d=l(s-n,d);const g=t+i*r(p),f=e+i*a(p),v=i*c(d/3),m={x:o-(h-e)/i*v,y:h+(o-t)/i*v},y={x:g+(f-e)/i*v,y:f-(g-t)/i*v},x={x:g,y:f};u.push(m,y,x),n+=d;}return u}function Qr(t,e,i,n){const s=t-i,o=t+i,r=e-n,a=e+n,l=.551915024494,h=l*i,c=l*n,d=[];return d.push({x:o,y:e}),d.push({x:o,y:e+c},{x:t+h,y:a},{x:t,y:a}),d.push({x:t-h,y:a},{x:s,y:e+c},{x:s,y:e}),d.push({x:s,y:e-c},{x:t-h,y:r},{x:t,y:r}),d.push({x:t+h,y:r},{x:o,y:e-c},{x:o,y:e}),d}function Kr(t,e){return {type:t,data:e,close:arguments.length>2&&void 0!==arguments[2]&&arguments[2]}}function ta(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=t.length;if(i<=1)return [];const n=[],[s]=t;n.push(Kr("moveTo",[s]));for(let e=0;e+3<i;e+=3){const i=t[e+1],s=t[e+2],o=t[e+3];n.push(Kr("bezierCurveTo",[i,s,o]));}return e&&t.length>2&&n.push(Kr("lineTo",[s])),n}function ea(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function ia(t,e){const i=t.length;if(i<=1)return [];if(2===i)return [{index:0,ops:[Kr("moveTo",[t[0]])]},{index:1,ops:[Kr("lineTo",[t[1]])]}];let n=i-e;i<=e&&(n=0);const s=[];let o=[],r={index:n,ops:[]};if(s.push(r),i<=e){const e=Kr("moveTo",[t[0]]);r.ops.push(e),o=[...t];}else o=t.slice(-e);const a=function(t,e,i){const n=[];for(let s=1;s<t.length-1;s++){const o=180*Wa(La(t[s-1],t[s]),La(t[s],t[s+1]))/Math.PI;o>=e&&o<=i&&n.push(s);}return n}(o,45,135),l=[];for(let e=0;e<o.length;e++)if(a.includes(e)){const i=t[e-1],s=t[e+1],r=ea(t[e],i),a=ea(t[e],s);let h,c;r>6&&(h=la(i,t[e],.2),l.push({val:h})),l.push({index:e+n,val:o[e]}),a>6&&(c=la(s,t[e],.2),l.push({val:c}));}else l.push({index:e+n,val:o[e]});for(let t=0;t<l.length;t++){var h,c,d,u,p,g;const e=l[t],i=l[t].val,o=null!==(h=null===(c=l[t-1])||void 0===c?void 0:c.val)&&void 0!==h?h:i,a=null!==(d=null===(u=l[t+1])||void 0===u?void 0:u.val)&&void 0!==d?d:i,f=na(o,i,a,null!==(p=null===(g=l[t+2])||void 0===g?void 0:g.val)&&void 0!==p?p:a);void 0!==e.index&&(e.index!==n&&(r={index:void 0,ops:[]},s.push(r)),r.index=e.index),r.ops.push(f);}return s}function na(t,e,i,n){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:5;const o=ea(e,i);let r={x:e.x+(i.x-t.x)/s,y:e.y+(i.y-t.y)/s},a={x:i.x-(n.x-e.x)/s,y:i.y-(n.y-e.y)/s};const l=ea(r,e),h=ea(a,i);l>o&&(r=la(r,e,o)),h>o&&(a=la(a,i,o));return Kr("bezierCurveTo",[r,a,i])}function sa(t,e,i){const n=(t.x+e.x)/2,s=(t.y+e.y)/2,o=(e.x+i.x)/2,r=(e.y+i.y)/2;return Kr("bezierCurveTo",[{x:n+2*(e.x-n)/3,y:s+2*(e.y-s)/3},{x:o+2*(e.x-o)/3,y:r+2*(e.y-r)/3},e])}function oa(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[];let[n]=t;i.push(Kr("moveTo",[n]));for(let e=1;e<t.length;e++)n=t[e],i.push(Kr("lineTo",[n]));return e&&t.length>2&&([n]=t,i.push(Kr("lineTo",[n]))),i}function ra(t,e){const{data:i,type:n}=e,[s,o,r]=i;switch(n){case"moveTo":t.moveTo(s.x,s.y);break;case"lineTo":t.lineTo(s.x,s.y);break;case"bezierCurveTo":t.bezierCurveTo(s.x,s.y,o.x,o.y,r.x,r.y);break;case"quadraticCurveTo":t.quadraticCurveTo(s.x,s.y,o.x,o.y);}}function aa(t){let{x:e,y:i}=t[0],n=e,s=i;for(let o=1;o<t.length;o++){const{x:r,y:a}=t[o];e=Math.min(e,r),n=Math.max(n,r),i=Math.min(i,a),s=Math.max(s,a);}return {left:e,top:i,right:n,bottom:s,width:n-e,height:s-i}}function la(t,e,i){const n=e.x-t.x,s=e.y-t.y,o=Math.abs(n)/Math.abs(s);let r=Math.sqrt(i*i/(o*o+1)),a=r*o;return 0===n&&(a=0,r=Math.sqrt(i)),0===s&&(r=0,a=Math.sqrt(i)),{x:e.x-(n>=0?a:-a),y:e.y-(s>=0?r:-r)}}function ha(t){if(t.length<1)return [];const e=[];let i=[];for(let n=0;n<t.length;n++){const s=t[n];if(0===s.step)n>0&&e.push({step:i,close:t[n-1].close}),i=[],i.push(Kr("moveTo",[{x:s.x,y:s.y}]));else if(1===s.step)i.push(Kr("lineTo",[{x:s.x,y:s.y}]));else if(2===s.step&&n+2<t.length&&2===t[n+1].step&&2===t[n+2].step){const e=t[n+1],o=t[n+2];i.push(Kr("bezierCurveTo",[s,e,o])),n+=2;}}return e.push({step:i,close:t[t.length-1].close}),e}function ca(t){return 180*t/Math.PI}function da(t){return t<0?t%360+360:t%360}function ua(t,e,i,n){return t/(i*i)+e/(n*n)}function pa(t,e,i,n){let s=0,o=0,r=0,a=0;const l=[t,e],h=aa(l),c=function(t,e,i,n){let s=n/2,o=n/2;const r=e.y-t.y,a=e.x-t.x;if(0===r||0===a)return [a,r];const l=-1/((e.y-t.y)/(e.x-t.x)),h=Math.atan(l);return "square"===i?(s=Math.sqrt(2)*n/2,o=Math.sqrt(2)*n/2):"round"===i?(s=n/2,o=n/2):(s=Math.abs(Math.cos(h)*n)/2,o=Math.abs(Math.sin(h)*n)/2),[s,o]}(l[0],l[1],n,i||0);return 0===c[1]?(s=h.left,o=h.top-i/2,r=h.width,a=h.height+i,"square"!==n&&"round"!==n||(s-=i/2,r+=i)):0===c[0]?(s=h.left-i/2,o=h.top,r=h.width+i,a=h.height,"square"!==n&&"round"!==n||(o-=i/2,a+=i)):(s=h.left-c[0],o=h.top-c[1],r=h.width+2*c[0],a=h.height+2*c[1]),{left:s,top:o,width:r,height:a}}function ga(t){return Math.abs(t)<1e-6?0:t<0?-1:1}function fa(t,e,i,n){const{x:s,y:o}=t,{x:r,y:a}=e,{x:l,y:h}=n,c=Math.min(s,r),d=Math.max(s,r),u=Math.min(o,a),p=Math.max(o,a),g=i/2;return l>=c-g&&l<=d+g&&h>=u-g&&h<=p+g&&function(t,e,i,n,s,o){const r=[i-t,n-e];if(new or(r[0],r[1]).equals({x:0,y:0}))return Math.sqrt((s-t)*(s-t)+(o-e)*(o-e));const a=[-r[1],r[0]],l=new or(a[0],a[1]);l.normalize();const h=[s-t,o-e],c=new or(h[0],h[1]);return Math.abs(c.dot(l))}(s,o,r,a,l,h)<=i/2}function va(t,e,i,n,s){const o=t.length;if(o<2)return !1;for(let s=0;s<o-1;s++)if(fa(t[s],t[s+1],e,{x:i,y:n}))return !0;if(s){if(fa(t[0],t[o-1],e,{x:i,y:n}))return !0}return !1}function ma(t,e,i,n,s,o){return s>=t&&s<=t+i&&o>=e&&o<=e+n}function ya(t,e,i,n,s,o){const r=o;let a=n.x,l=n.y,h=s.x,c=s.y;0===e&&(a=s.x,l=s.y,h=n.x,c=n.y);let d=Math.PI/2;const u=h-a>=0?1:-1,p=c-l>=0?1:-1;a!==h&&(d=Math.atan(Math.abs(c-l)/Math.abs(h-a)));const g=Math.cos(d),f=Math.sin(d),v=i?1:-1,m={x:h+7.8*v*r*g*u-4.5*r*f*u,y:c+7.8*v*r*f*p+4.5*r*g*p,step:0,close:!1},y={x:h,y:c,step:1,close:!1};i&&(y.x=h+r*v*g*u,y.y=c+r*v*f*p);const x={x:h+7.8*v*r*g*u+4.5*r*f*u,y:c+7.8*v*r*f*p-4.5*r*g*p,step:1,close:!1};t.push(m,y,x);}function xa(t,e,i,n,s,o){const r=o;let a=n.x,l=n.y,h=s.x,c=s.y;0===e&&(a=s.x,l=s.y,h=n.x,c=n.y);let d=Math.PI/2;const u=h-a>=0?1:-1,p=c-l>=0?1:-1;a!==h&&(d=Math.atan(Math.abs(c-l)/Math.abs(h-a)));const g=Math.cos(d),f=Math.sin(d),v=i?1:-1,m={x:h+7.8*v*r*g*u-4.5*r*f*u,y:c+7.8*v*r*f*p+4.5*r*g*p,step:0,close:!1},y={x:h,y:c,step:1,close:!1};i&&(y.x=h+r*v*g*u,y.y=c+r*v*f*p);const x={x:h+7.8*v*r*g*u+4.5*r*f*u,y:c+7.8*v*r*f*p-4.5*r*g*p,step:1,close:!0};t.push(m,y,x);}function wa(t,e,i,n,s){const o=s;let r=i.x,a=i.y,l=n.x,h=n.y;0===e&&(r=n.x,a=n.y,l=i.x,h=i.y);let c=Math.PI/2;const d=l-r>=0?1:-1,u=h-a>=0?1:-1;r!==l&&(c=Math.atan(Math.abs(h-a)/Math.abs(l-r)));const p=Math.cos(c),g=Math.sin(c),f={x:l-3*o*g*d,y:h+3*o*p*u,step:0,close:!1},v={x:l+3*o*g*d,y:h-3*o*p*u,step:1,close:!1};t.push(f,v);}function ba(t,e,i,n,s){const o=s;let r=i.x,a=i.y,l=n.x,h=n.y;0===e&&(r=n.x,a=n.y,l=i.x,h=i.y);let c=Math.PI/2;const d=l-r>=0?1:-1,u=h-a>=0?1:-1,p=h>=a&&l>=r||h<=a&&l<=r?-1:1;r!==l&&(c=Math.atan(Math.abs(h-a)/Math.abs(l-r)));const g=Math.cos(c),f=Math.sin(c),v=4.5*Math.sqrt(3)*o,m={x:l+4.5*o*g*d-v*f*d*p,y:h+4.5*o*f*u+v*g*u*p,step:0,close:!1},y={x:l-4.5*o*g*d+v*f*d*p,y:h-4.5*o*f*u-v*g*u*p,step:1,close:!1};t.push(m,y);}function Sa(t,e,i,n,s){const o=s;let{x:r,y:a}=n;0===e&&(r=i.x,a=i.y);const l={x:r-3*o,y:a-3*o,step:0,close:!1},h={x:r+3*o,y:a-3*o,step:1,close:!1},c={x:r+3*o,y:a+3*o,step:1,close:!1},d={x:r-3*o,y:a+3*o,step:1,close:!0};t.push(l,h,c,d);}function Ca(t,e,i,n,s){const o=s;let{x:r,y:a}=n;0===e&&(r=i.x,a=i.y);const l={x:r-3*o,y:a,step:0,close:!1},h={x:r,y:a-3*o,step:1,close:!1},c={x:r+3*o,y:a,step:1,close:!1},d={x:r,y:a+3*o,step:1,close:!0};t.push(l,h,c,d);}function Pa(t,e,i,n,s){const o=s;let{x:r,y:a}=n;0===e&&(r=i.x,a=i.y);const l=3*o-0*o,h=Qr(r,a,l,l);h.forEach(((e,i)=>{const n=0===i?0:2,s=i===h.length-1,o={x:e.x,y:e.y,step:n,close:s};t.push(o);}));}class Ta{constructor(t){i(this,"lineAlign",void 0),i(this,"owner",void 0),this.owner=t,this.reset();}reset(){this.lineAlign=.5;}get x(){return this.owner.getAttribute("x")}set x(t){this.owner.setAttribute("x",t);}get y(){return this.owner.getAttribute("y")}set y(t){this.owner.setAttribute("y",t);}get r(){return this.owner.getAttribute("r")}set r(t){this.owner.setAttribute("r",t);}get width(){return this.owner.getAttribute("width")}set width(t){this.owner.setAttribute("width",t);}get height(){return this.owner.getAttribute("height")}set height(t){this.owner.setAttribute("height",t);}get points(){return this.owner.getAttribute("points")}set points(t){this.owner.setAttribute("points",t);}get origin(){return this.owner.getAttribute("origin")}set origin(t){this.owner.setAttribute("origin",t);}get anchor(){return this.owner.getAttribute("anchor")}set anchor(t){this.owner.setAttribute("anchor",t);}get visibility(){return this.owner.getAttribute("visibility")}set visibility(t){this.owner.setAttribute("visibility",t);}get zIndex(){return this.owner.getAttribute("zIndex")}set zIndex(t){this.owner.setAttribute("zIndex",t);}get borderWidth(){return this.owner.getAttribute("borderWidth")}set borderWidth(t){this.owner.setAttribute("borderWidth",t);}get borderColor(){return this.owner.getAttribute("borderColor")}set borderColor(t){this.owner.setAttribute("borderColor",t);}get opacity(){return this.owner.getAttribute("opacity")}set opacity(t){this.owner.setAttribute("opacity",t);}get fillOpacity(){return this.owner.getAttribute("fillOpacity")}set fillOpacity(t){this.owner.setAttribute("fillOpacity",t);}get borderOpacity(){return this.owner.getAttribute("borderOpacity")}set borderOpacity(t){this.owner.setAttribute("borderOpacity",t);}get background(){return this.owner.getAttribute("background")}set background(t){this.owner.setAttribute("background",t);}get clipPath(){return this.owner.getAttribute("clipPath")}set clipPath(t){this.owner.setAttribute("clipPath",t);}get cursor(){return this.owner.getAttribute("cursor")}set cursor(t){this.owner.setAttribute("cursor",t);}get hitArea(){return this.owner.getAttribute("hitArea")}set hitArea(t){this.owner.setAttribute("hitArea",t);}get pointerEvents(){return this.owner.getAttribute("pointerEvents")}set pointerEvents(t){this.owner.setAttribute("pointerEvents",t);}get miterLimit(){return this.owner.getAttribute("miterLimit")}set miterLimit(t){this.owner.setAttribute("miterLimit",t);}get roundedRadius(){return this.owner.getAttribute("roundedRadius")}set roundedRadius(t){this.owner.setAttribute("roundedRadius",t);}get lineCap(){return this.owner.getAttribute("lineCap")}set lineCap(t){this.owner.setAttribute("lineCap",t);}get lineJoin(){return this.owner.getAttribute("lineJoin")}set lineJoin(t){this.owner.setAttribute("lineJoin",t);}get lineDash(){return this.owner.getAttribute("lineDash")}set lineDash(t){this.owner.setAttribute("lineDash",t);}get lineDashOffset(){return this.owner.getAttribute("lineDashOffset")}set lineDashOffset(t){this.owner.setAttribute("lineDashOffset",t);}get shadow(){return this.owner.getAttribute("shadow")}set shadow(t){this.owner.setAttribute("shadow",t);}get shadowOffsetX(){return this.owner.getAttribute("shadowOffsetX")}set shadowOffsetX(t){this.owner.setAttribute("shadowOffsetX",t);}get shadowOffsetY(){return this.owner.getAttribute("shadowOffsetY")}set shadowOffsetY(t){this.owner.setAttribute("shadowOffsetY",t);}get shadowBlur(){return this.owner.getAttribute("shadowBlur")}set shadowBlur(t){this.owner.setAttribute("shadowBlur",t);}get shadowColor(){return this.owner.getAttribute("shadowColor")}set shadowColor(t){this.owner.setAttribute("shadowColor",t);}get startAngle(){return this.owner.getAttribute("startAngle")}set startAngle(t){this.owner.setAttribute("startAngle",t);}get endAngle(){return this.owner.getAttribute("endAngle")}set endAngle(t){this.owner.setAttribute("endAngle",t);}get rx(){return this.owner.getAttribute("rx")}set rx(t){this.owner.setAttribute("rx",t);}get ry(){return this.owner.getAttribute("ry")}set ry(t){this.owner.setAttribute("ry",t);}get img(){return this.owner.getAttribute("img")}set img(t){this.owner.setAttribute("img",t);}get src(){return this.owner.getAttribute("src")}set src(t){this.owner.setAttribute("src",t);}get text(){return this.owner.getAttribute("text")}set text(t){this.owner.setAttribute("text",t);}get wordWarp(){return this.owner.getAttribute("wordWarp")}set wordWarp(t){this.owner.setAttribute("wordWarp",t);}get wordBreak(){return this.owner.getAttribute("wordBreak")}set wordBreak(t){this.owner.setAttribute("wordBreak",t);}get textMaxWidth(){return this.owner.getAttribute("textMaxWidth")}set textMaxWidth(t){this.owner.setAttribute("textMaxWidth",t);}get letterSpacing(){return this.owner.getAttribute("letterSpacing")}set letterSpacing(t){this.owner.setAttribute("letterSpacing",t);}get textBaseLine(){return this.owner.getAttribute("textBaseLine")}set textBaseLine(t){this.owner.setAttribute("textBaseLine",t);}get color(){return this.owner.getAttribute("color")}set color(t){this.owner.setAttribute("color",t);}get fontStyle(){return this.owner.getAttribute("fontStyle")}set fontStyle(t){this.owner.setAttribute("fontStyle",t);}get fontVariant(){return this.owner.getAttribute("fontVariant")}set fontVariant(t){this.owner.setAttribute("fontVariant",t);}get fontWeight(){return this.owner.getAttribute("fontWeight")}set fontWeight(t){this.owner.setAttribute("fontWeight",t);}get fontSize(){return this.owner.getAttribute("fontSize")}set fontSize(t){this.owner.setAttribute("fontSize",t);}get lineHeight(){return this.owner.getAttribute("lineHeight")}set lineHeight(t){this.owner.setAttribute("lineHeight",t);}get fontFamily(){return this.owner.getAttribute("fontFamily")}set fontFamily(t){this.owner.setAttribute("fontFamily",t);}get font(){return this.owner.getAttribute("font")}set font(t){this.owner.setAttribute("font",t);}get startPoint(){return this.owner.getAttribute("startPoint")}set startPoint(t){this.owner.setAttribute("startPoint",t);}get endPoint(){return this.owner.getAttribute("endPoint")}set endPoint(t){this.owner.setAttribute("endPoint",t);}get lineEnding(){return this.owner.getAttribute("lineEnding")}set lineEnding(t){this.owner.setAttribute("lineEnding",t);}get segments(){return this.owner.getAttribute("segments")}set segments(t){this.owner.setAttribute("segments",t);}get stampPoints(){return this.owner.getAttribute("stampPoints")}set stampPoints(t){this.owner.setAttribute("stampPoints",t);}get imageData(){return this.owner.getAttribute("imageData")}set imageData(t){this.owner.setAttribute("imageData",t);}get iconName(){return this.owner.getAttribute("iconName")}set iconName(t){this.owner.setAttribute("iconName",t);}get textContents(){return this.owner.getAttribute("textContents")}set textContents(t){this.owner.setAttribute("textContents",function(t){const e=[];return t.forEach((t=>{t.content.length&&e.push(t);})),e}(t));}get textAlign(){return this.owner.getAttribute("textAlign")}set textAlign(t){this.owner.setAttribute("textAlign",t);}get renderBlendMode(){return this.owner.getAttribute("renderBlendMode")}set renderBlendMode(t){this.owner.setAttribute("renderBlendMode",t);}get lines(){return this.owner.getAttribute("lines")}set lines(t){this.owner.setAttribute("lines",t);}}const Aa=new class{constructor(){i(this,"parsers",void 0),i(this,"updaters",void 0),this.parsers=new Map,this.updaters=new Map,this.initParser(),this.initUpdater();}getStyleParser(t){return this.parsers.get(t)}getStyleUpdaters(t){return this.updaters.get(t)}initParser(){this.bindHandler(["borderWidth","letterSpacing","lineDashOffset","shadowOffsetX","shadowOffsetY","shadowBlur","textMaxWidth","roundedRadius"],mr,void 0),this.bindHandler(["startAngle","endAngle"],xr,void 0),this.bindHandler(["r","rx","ry","width","height","fontSize"],mr,void 0),this.bindHandler(["borderColor","background","shadowColor","color"],kr,void 0),this.bindHandler(["opacity","fillOpacity","borderOpacity"],Rr,void 0),this.bindHandler(["lineDash"],Dr,void 0),this.bindHandler(["shadow"],Er,void 0),this.bindHandler(["textContents"],Br,void 0);}initUpdater(){this.bindHandler(["borderWidth"],void 0,_r),this.bindHandler(["x","y"],void 0,Ur),this.bindHandler(["width","height"],void 0,Or),this.bindHandler(["r","rx","ry","startAngle","endAngle"],void 0,Wr),this.bindHandler(["points","segments"],void 0,Lr),this.bindHandler(["startPoint","endPoint","lineEnding"],void 0,Nr),this.bindHandler(["stampPoints"],void 0,Fr),this.bindHandler(["width","height","textContents","textAlign","borderWidth"],void 0,Hr);}bindHandler(t,e,i){for(let n=0;n<t.length;n++)if(e&&this.parsers.set(t[n],e),i){const e=this.updaters.get(t[n])||[];e.push(i),this.updaters.set(t[n],e);}}};class ka extends Ko{constructor(t){super(),i(this,"attributes",{}),i(this,"id",void 0),i(this,"pageUid",void 0),i(this,"index",void 0),i(this,"name",void 0),i(this,"renderable",new pr),i(this,"sortable",new gr),i(this,"geometry",new ur),i(this,"transform",new fr),i(this,"parsedStyle",{}),i(this,"style",void 0),i(this,"isDestroyed",!1),i(this,"childNodes",[]),i(this,"nodeName",""),i(this,"nodeType",0),i(this,"nodeValue",null),i(this,"ownerDocument",null),i(this,"parentNode",null),i(this,"isConnected",!1),i(this,"textContent",void 0),i(this,"shapeType",void 0),i(this,"config",void 0),i(this,"path",void 0),i(this,"steps",void 0),i(this,"pathDirty",!0),i(this,"boundsDirty",!0),i(this,"bounds",void 0),i(this,"strokePath",void 0),i(this,"strokeSteps",void 0),i(this,"externalMatrices",[]),i(this,"clippable",!1),i(this,"imageData",null),this.config=t,this.id=t.id||t.uid||"",this.name=t.name||"",this.index=t.index,this.nodeName=t.type||"container",this.pageUid=t.pageUid||"",(t.className||t.class)&&(this.className=t.className||t.class),this.style=new Ta(this),this.initAttributes(t);}static isNode(t){return !!t.childNodes}set className(t){this.setAttribute("class",t);}get className(){return this.getAttribute("class")||""}get classList(){return this.className.split(" ").filter((t=>""!==t))}get tagName(){return this.nodeName}get children(){return this.childNodes}get childElementCount(){return this.childNodes.length}get firstElementChild(){return this.firstChild}get lastElementChild(){return this.lastChild}get firstChild(){return this.childNodes.length>0?this.childNodes[0]:null}get lastChild(){const{childNodes:t}=this;return t.length>0?t[t.length-1]:null}get nextSibling(){const{parentNode:t}=this;if(t){const e=t.childNodes.indexOf(this);return t.childNodes[e+1]}return null}get parentElement(){return this.parentNode}get previousSibling(){const{parentNode:t}=this;if(t){const e=t.childNodes.indexOf(this);return t.childNodes[e-1]}return null}getAttribute(t){const e=this.attributes[t];return null==e?null:e}getElementsByName(t){return dr.querySelectorAll(`[name="${t}"]`,this)}getElementsByClassName(t){return dr.querySelectorAll(`.${t}`,this)}getElementsByTagName(t){return dr.querySelectorAll(t,this)}hasAttribute(t){return Object.keys(this.attributes).indexOf(t)>-1}removeAttribute(t){this.setAttribute(t,null),delete this.attributes[t];}appendChild(t,e){dr.append(t,this,e);const i=new Qo("child-inserted",{child:t});this.dispatchEvent(i);const n=new fl("DOMNodeInserted",this,"","","",0,"","");return t.dispatchEvent(n),t}cloneNode(t){return null}insertBefore(t,e){if(e){const i=this.childNodes.indexOf(e);this.appendChild(t,i-1);}else this.appendChild(t);return t}removeChild(t){const e=new fl("removed",this,"","","",0,"","");t.dispatchEvent(e);const i=new Qo("child-removed",{child:t});return this.dispatchEvent(i),dr.remove(t),t}isChildExist(t){return dr.isChildExist(t)}replaceChild(t,e){const i=this.childNodes.indexOf(e);return this.removeChild(e),this.appendChild(t,i),e}destroy(){const t=new Qo("destroy",{});this.dispatchEvent(t),this.remove(),this.removeAllEventListeners(),this.isDestroyed=!0;}after(){const{parentNode:t}=this;if(t){const s=t.childNodes.indexOf(this);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];i.forEach(((e,i)=>{null==t||t.appendChild(e,s+i+1);}));}}before(){const{parentNode:t}=this;if(t){const s=t.childNodes.indexOf(this);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];i.forEach(((e,i)=>{null==t||t.appendChild(e,s+i);}));}}remove(){this.parentNode&&this.parentNode.removeChild(this);}replaceWith(){this.after(...arguments),this.remove();}append(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach((t=>{this.appendChild(t);}));}prepend(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(((t,e)=>{this.appendChild(t,e);}));}querySelector(t){return dr.querySelector(t,this)}querySelectorAll(t){return dr.querySelectorAll(t,this)}find(t){let e=null;return this.recursiveCall((i=>!(i!==this||!t(i))&&(e=i,!0))),e}findAll(t){const e=[];return this.recursiveCall((i=>{i===this&&t(i)&&e.push(i);})),e}contains(t){let e=t;for(;e&&this!==e;)e=e.parentNode;return !!e}getRootNode(t){return this.parentNode?this.parentNode.getRootNode(t):this}hasChildNodes(){return this.childNodes.length>0}isEqualNode(t){return this===t}isSameNode(t){return this.isEqualNode(t)}normalize(){throw new Error("Method to be implemented")}recursiveCall(t){t(this)||this.childNodes.forEach((e=>{e.recursiveCall(t);}));}hasParentTransform(){return !(!this.parentNode||!this.parentNode.transform)}getGeometryBounds(){return dr.getGeometryBounds(this)}getRenderBounds(){return dr.getBounds(this,!0)}getBounds(){return dr.getBounds(this)}getLocalBounds(){return dr.getLocalBounds(this)}getBoundingClientRect(){return dr.getBoundingClientRect(this)}get isVisible(){return "visible"===this.parsedStyle.visibility}get isInteractive(){return "none"!==this.parsedStyle.pointerEvents}get width(){return this.parsedStyle.width.value*Math.abs(this.getScale().x)}get height(){return this.parsedStyle.height.value*Math.abs(this.getScale().y)}initAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(const e in t)if(Ls(e,t)){if("style"===e)continue;this.attributes[e]=t[e];}for(const e in t.style)Ls(e,t.style)&&(this.parseStyleProperty(e,t.style[e]),this.attributes[e]=t.style[e]);this.renderable.toRenderable();}setAttribute(t,e){if(_n(e))return;const i="x"===t||"y"===t,n=this.attributes[t];(e!==this.attributes[t]||i)&&(this.attributes[t]=e,Object.keys(this.config).includes(t)||(this.parseStyleProperty(t,e),this.updateStyleProperty(t,n,e)));}parseStyleProperty(t,e){const i=Aa.getStyleParser(t);this.parsedStyle[t]=i?i(e,this,t):e;}updateStyleProperty(t,e,i){const n=Aa.getStyleUpdaters(t);n&&n.forEach((n=>{n(e,i,this,t);}));}toFront(){const{parentNode:t}=this;if(t){const e=Math.max(...t.children.map((t=>t.style.zIndex)));this.style.zIndex=e+1;}return this}toBack(){const{parentNode:t}=this;if(t){const e=Math.min(...t.children.map((t=>t.style.zIndex)));this.style.zIndex=e-1;}return this}setOrigin(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return dr.setOrigin(this,t,e),this}getOrigin(){return dr.getOrigin(this)}setPosition(t){return t=Ea(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),dr.setPosition(this,t),this}setLocalPosition(t){return t=Ea(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),dr.setLocalPosition(this,t),this}getPosition(){return dr.getPosition(this)}getLocalPosition(){return dr.getLocalPosition(this)}translate(t){return t=Ea(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),dr.translate(this,t),this}translateLocal(t){return t=Ea(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),dr.translateLocal(this,t),this}scale(t,e){return this.scaleLocal(t,e)}scaleLocal(t,e){return Xn(t)&&(t={x:t,y:e=e||t}),dr.scaleLocal(this,t),this}setLocalScale(t,e){return Xn(t)&&(t={x:t,y:e=e||t}),dr.setLocalScale(this,t),this}getScale(){return dr.getScale(this)}getLocalScale(){return dr.getLocalScale(this)}rotate(t){return dr.rotate(this,t),this}rotateLocal(t){return dr.rotateLocal(this,t),this}setAngle(t){return dr.setAngle(this,t),this}setLocalAngle(t){return dr.setLocalAngle(this,t),this}getAngle(){return dr.getAngle(this)}getLocalAngle(){return dr.getLocalAngle(this)}getLocalTransform(){return dr.getLocalTransform(this)}getWorldTransform(){return dr.getWorldTransform(this)}setLocalTransform(t){return dr.setLocalTransform(this,t),this}resetLocalTransform(){return dr.resetLocalTransform(this),this}getPath(){}getBoundingRect(){return {left:0,top:0,width:0,height:0}}isPointInPath(t){return !1}updateStyle(t){Object.keys(t).forEach((e=>{Ls(e,t)&&(this.style[e]=t[e]);}));}updatePosition(t,e){this.style.x=t||0,this.style.y=e||0;}updateOrigin(){const{width:t,height:e}=this.getBoundingRect();this.setOrigin(t/2,e/2);}getBoundingRectObject(){const{left:t,top:e,width:i,height:n}=this.getBoundingRect();return new Fa({style:{x:t,y:e,width:i,height:n,borderWidth:1,background:"transparent"}})}}function Ea(t,e){return Xn(t)?{x:t,y:e}:t}class Da extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"arc",style:{...Ir,r:0,startAngle:0,endAngle:1.5*Math.PI,...t},...e}),i(this,"shapeType","arc");const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}normAngle(){const{startAngle:t,endAngle:e}=this.style;let i=xr(t).value,n=xr(e).value;if(i>n){const t=i;i=n,n=t;}if(Math.abs(n-i)>=2*Math.PI-1e-5&&(i=0,n=2*Math.PI),i<-2*Math.PI||n<-2*Math.PI){const t=Math.max(Math.floor(i/(-2*Math.PI)),Math.floor(n/(-2*Math.PI)));i+=2*Math.PI*t,n+=2*Math.PI*t;}if(i>2*Math.PI||n>2*Math.PI){const t=Math.max(Math.floor(i/(2*Math.PI)),Math.floor(n/(2*Math.PI)));i-=2*Math.PI*t,n-=2*Math.PI*t;}this.parsedStyle.startAngle=xr(i),this.parsedStyle.endAngle=xr(n);}updateOrigin(){const{width:t,height:e,left:i,top:n}=this.getBoundingRect(),s=i-this.style.x+t/2,o=n-this.style.y+e/2;this.setOrigin(s,o);}getPath(){if(!this.pathDirty)return this.path;this.normAngle();const{r:t,borderWidth:e,startAngle:i,endAngle:n}=this.parsedStyle,s=.5*((null==e?void 0:e.value)||0),o=i.value,r=n.value;return this.path=Zr(0,0,t.value-s,o,r),this.steps=ta(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,r:i,startAngle:n,endAngle:s,borderWidth:o}=this.parsedStyle,r=i.value,a=n.value,l=s.value;null==o||o.value;if(n===s)return {left:t-r-0,top:e-r-0,width:2*r+0,height:2*r+0};const{sin:h,cos:c,PI:d}=Math,u=[t+r*c(a),t+r*c(l)],p=[e+r*h(a),e+r*h(l)];return a<0&&l>0&&u.push(t+r),(a<.5*d&&l>.5*d||a<-1.5*d&&l>-1.5*d)&&p.push(e+r),(a<d&&l>d||a<-d&&l>-d)&&u.push(t-r),(a<1.5*d&&l>1.5*d||a<-.5*d&&l>-.5*d)&&p.push(e-r),u.sort(((t,e)=>t-e)),p.sort(((t,e)=>t-e)),this.boundsDirty=!1,this.bounds={left:u[0]-0,top:p[0]-0,width:u[u.length-1]-u[0]+0,height:p[p.length-1]-p[0]+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:n,r:s,startAngle:o,endAngle:r,background:a,borderWidth:l}=this.parsedStyle,h=da(ca(o.value)),c=da(ca(r.value)),d=da(ca(o.value+r.value)/2),u=Gn(this.style.background)&&""!==this.style.background,p=l&&l.value,g=u?0:e,f=(l.value+g||0)/2,v=s.value-f,m=new Vr(i+v*Math.cos(h*Math.PI/180),n+v*Math.sin(h*Math.PI/180)),y=new Vr(i+v*Math.cos(c*Math.PI/180),n+v*Math.sin(c*Math.PI/180)),x=new Vr(i+v*Math.cos(d*Math.PI/180),n+v*Math.sin(d*Math.PI/180)),w=new Vr(t.x,t.y),b=w.distanceTo({x:i,y:n}),S=$r([m.x,m.y],[x.x,x.y],[w.x,w.y],[i,n]),C=$r([y.x,y.y],[x.x,x.y],[w.x,w.y],[i,n]),P=$r([m.x,m.y],[y.x,y.y],[w.x,w.y],[i,n]);if(b>v+f)return !1;const T=fa(m,y,2*f,t);if(c-h<180&&c-h>0||c-h<-180){if(a&&P||T)return !0;if(!a&&p&&b>=v-f&&b<=v+f&&P)return !0}else if(180===Math.abs(c-h)){if(a){if(S||C)return !0;if(function(t,e,i,n){const{x:s,y:o}=t,{x:r,y:a}=e,{x:l,y:h}=i,{x:c,y:d}=n;return !(((c-s)*(a-o)-(d-o)*(r-s))*((l-s)*(a-o)-(h-o)*(r-s))<=0||((c-l)*(a-h)-(d-h)*(r-l))*((s-l)*(a-h)-(o-h)*(r-l))<=0||((c-s)*(h-o)-(d-o)*(l-s))*((r-s)*(h-o)-(a-o)*(l-s))<=0)}(m,x,y,t))return !0}if(!a&&p&&b>=v-f&&b<=v+f&&(S||C))return !0}else {if(a){if(S||C)return !0;if(!P)return !0}if(!a&&p&&b>=v-f&&b<=v+f&&(S||C))return !0}return !!T}}class Ra extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"circle",style:{...Ir,r:0,anchor:[.5,.5],...t},...e}),i(this,"shapeType","circle");const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}updateOrigin(){this.setOrigin(0,0);}getPath(){if(!this.pathDirty)return this.path;const{r:t,borderWidth:e}=this.parsedStyle;let i=.5*((null==e?void 0:e.value)||0);return t.value===i&&(i=0),this.path=Zr(0,0,t.value-i,0,2*Math.PI),this.steps=ta(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,r:i}=this.parsedStyle,n=i.value;return this.boundsDirty=!1,this.bounds={left:t-n-0,top:e-n-0,width:2*n+0,height:2*n+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:n,r:s,background:o,borderWidth:r}=this.parsedStyle,a=Gn(this.style.background)&&""!==this.style.background,l=r&&r.value,h=a?0:e,c=(r.value+h||0)/2,d=s.value-c,u=new Vr(t.x,t.y).distanceTo({x:i,y:n});return o&&l?u<=d+c:o?u<=d:!!l&&(u>=d-c&&u<=d+c)}}let Ia=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"ellipse",style:{...Ir,rx:"",ry:"",borderWidth:0,anchor:[.5,.5],...t},...e}),i(this,"shapeType","ellipse");const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}updateOrigin(){this.setOrigin(0,0);}getPath(){if(!this.pathDirty)return this.path;const{rx:t,ry:e,borderWidth:i}=this.parsedStyle,n=.5*i.value;return this.path=Qr(0,0,t.value-n,e.value-n),this.steps=ta(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,rx:i,ry:n}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t-i.value-0,top:e-n.value-0,width:2*i.value+0,height:2*n.value+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:n,rx:s,ry:o,borderWidth:r}=this.parsedStyle,a=Gn(this.style.background)&&""!==this.style.background,l=r&&r.value,h=a?0:e,c=(r.value||0)/2,d=s.value-c,u=o.value-c,p=(t.x-i)*(t.x-i),g=(t.y-n)*(t.y-n);return a&&l?ua(p,g,d+c,u+c)<=1:a?ua(p,g,d,u)<=1:!!l&&(ua(p,g,d-c-h/2,u-c-h/2)>=1&&ua(p,g,d+c+h/2,u+c+h/2)<=1)}},Ma=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"image",style:{...Ir,width:0,height:0,img:"",...t},...e}),i(this,"shapeType","image"),i(this,"meteData",void 0),this.meteData=(null==e?void 0:e.metadata)||null;const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:n}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:n.value},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}},Ba=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"ink",style:{...Ir,segments:[],lineJoin:"round",lineCap:"round",borderWidth:2,miterLimit:10,...t},...e}),i(this,"shapeType","ink"),i(this,"inkPaths",[]),i(this,"inkSteps",[]),i(this,"inkRenderPaths",[]),i(this,"inkOriginalRenderPath",void 0),i(this,"inkRenderSteps",[]),i(this,"initialRect",void 0),i(this,"douglasPeuckerPoints",[]),i(this,"partDirty",!1),i(this,"optimizedOpSteps",[]),i(this,"positionDirty",!1),this.getPath(),this.initialRect=this.getBoundingRect(),this.updatePosition(this.initialRect.left,this.initialRect.top),this.setOrigin(this.initialRect.width,this.initialRect.height);}addSegment(){const{segments:t}=this.style;t[t.length-1].length&&this.style.segments.push([]);}addPoint(t){const e=[...this.style.segments],i=this.style.segments.length,n=e[i-1],s=n[n.length-1];if((null==s?void 0:s.x)!==t.x||(null==s?void 0:s.y)!==t.y){this.partDirty=!0;const n=this.getBoundingRect(),s=this.parsedStyle.borderWidth.value/2;(t.x<n.left+s||t.y<n.top+s)&&(this.positionDirty=!0),e[i-1].push(t),this.style.segments=e;const o=this.getBoundingRect();(t.x<o.left||t.y<o.top||t.x>o.left+o.width||t.y>o.top+o.height)&&(this.boundsDirty=!0);}}getPath(){if(!this.pathDirty&&!this.partDirty)return this.path;const{segments:t}=this.parsedStyle;if(this.partDirty){const e=t.length;if(e>1)for(let i=0;i<e-1;i++){const e=t[i];if(!this.optimizedOpSteps[i]){let t=[...e];1===t.length?t=this.offsetPoints(e[0],.1):(t=Xr(t,0,t.length-1,1),t.length<=3&&t.push({...t[t.length-1]}));const n=ia(t,t.length).map((t=>t.ops)).flat(2);this.optimizedOpSteps[i]=n;}if(this.positionDirty||!this.inkRenderSteps[i]){const t=this.getRenderStep(this.optimizedOpSteps[i]);this.inkRenderSteps[i]=t;}}let i=t[e-1];1===i.length?i=this.offsetPoints(i[0],.1):i.length<=3&&i.push(i[i.length-1]),i=this.getRenderPath(i);const n=function(t){const e=t.length;if(e<=1)return [];if(2===e)return [Kr("moveTo",[t[0]]),Kr("lineTo",[t[1]])];const i=[Kr("moveTo",[t[0]])];for(let n=0;n<e-1;n++){const e=t[n-1]||t[n],s=t[n],o=t[n+1]||t[n];i.push(sa(e,s,o));}return i}(i);this.inkRenderSteps[e-1]=n;}else this.pathDirty&&(this.reset(),t.forEach(((t,e)=>{if(0===t.length)return;let i=[...t];1===t.length?i=this.offsetPoints(t[0],.1):(i=Xr(i,0,i.length-1,1),i.length<=3&&i.push({...i[i.length-1]})),this.inkPaths[e]=i;const n=ia(i,i.length);this.inkSteps[e]=n.map((t=>t.ops)).flat(2);const s=this.getRenderPath(i),o=ia(s,s.length).map((t=>t.ops)).flat(2);this.inkRenderSteps[e]=o;})));return this.pathDirty=!1,this.partDirty=!1,this.positionDirty=!1,this.path}offsetPoints(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.001;const{x:i,y:n}=t;return [{x:i-e,y:n-e},{x:i+e,y:n-e},{x:i+e,y:n+e},{x:i-e,y:n+e}]}getRenderStep(t){return t.map((t=>({...t,data:this.getRenderPath(t.data)})))}getInkOriginalRenderPath(){if(!this.pathDirty&&this.inkOriginalRenderPath)return;const{segments:t}=this.parsedStyle,e=[];for(let i=0;i<t.length;i++){const n=this.getRenderPath(t[i]);e.push(n);}this.inkOriginalRenderPath=e;}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),n=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||n.push({x:t.x-e,y:t.y-i});})),n}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t}=this.parsedStyle,e=[],i=[];this.parsedStyle.segments.forEach((t=>{t.forEach((t=>{t&&(e.push(t.x),i.push(t.y));}));}));const{min:n,max:s}=Ua(e),{min:o,max:r}=Ua(i),a=t.value/2;return this.boundsDirty=!1,this.bounds={left:n-a,top:o-a,width:s-n+2*a,height:r-o+2*a},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i}=this.parsedStyle;for(let n=0;n<this.inkSteps.length;n++){const s=this.inkSteps[n];for(let n=1;n<s.length;n+=2){const o=s[n-1].data[0],r=s[n].data[0],a=s[n].data[1];if(Gr(o.x,o.y,r.x,r.y,a.x,a.y).isHit([t.x,t.y],i.value+e))return !0}}return !1}reset(){this.inkPaths=[],this.inkSteps=[],this.inkRenderPaths=[],this.inkRenderSteps=[];}};function Ua(t){if(0===t.length)return {min:void 0,max:void 0};let e=t[0],i=t[0];for(let n=1;n<t.length;n++)t[n]<e&&(e=t[n]),t[n]>i&&(i=t[n]);return {min:e,max:i}}function La(t,e){return {x:e.x-t.x,y:e.y-t.y}}function Oa(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function Wa(t,e){const i=function(t,e){return t.x*e.x+t.y*e.y}(t,e),n=Oa(t),s=Oa(e);return Math.acos(i/(n*s))}let Na=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"polygon",style:{...Ir,points:[{x:0,y:0},{x:10,y:10}],miterLimit:10,borderWidth:2,...t},...e}),i(this,"shapeType","polygon"),i(this,"renderPath",void 0),0===this.parsedStyle.points.length&&(this.style.points=[{x:0,y:0},{x:10,y:10}]);const{left:n,top:s,width:o,height:r}=this.getBoundingRect();this.updatePosition(n,s),this.setOrigin(o/2,r/2);}addPoint(t){const e=[...this.style.points];e.push(t),this.style.points=e;}updatePoints(){const{renderPath:t}=this,e=this.getLocalPosition(),i=[];t.forEach((t=>{i.push({x:t.x+e.x,y:t.y+e.y});})),this.style.points=i;}getPath(){if(!this.pathDirty)return this.path;const{left:t,top:e}=this.getBoundingRect();return this.path=this.parsedStyle.points,this.renderPath=this.parsedStyle.points.map((i=>({x:i.x-t,y:i.y-e}))),this.steps=oa(this.renderPath,!0),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,points:e,lineCap:i}=this.parsedStyle;if(2===e.length)return this.boundsDirty=!1,this.bounds=pa(e[0],e[1],t.value,i),this.bounds;const n=aa(e),s=t.value/2||0;return this.boundsDirty=!1,this.bounds={left:n.left-s,top:n.top-s,width:n.width+2*s,height:n.height+2*s},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i,points:n}=this.parsedStyle,s=Gn(this.style.background)&&""!==this.style.background,o=s?0:e;let r=!1;return i&&i.value&&(r=va(n,i.value+o,t.x,t.y,!0)),!r&&s&&(r=function(t,e,i){let n=!1;const s=t.length;if(s<=2)return !1;for(let l=0;l<s;l++){const h=t[l],c=t[(l+1)%s];if(r=c,((a={x:e,y:i}).x-(o=h).x)*(r.y-o.y)==(r.x-o.x)*(a.y-o.y)&&Math.min(o.x,r.x)<=a.x&&a.x<=Math.max(o.x,r.x)&&Math.min(o.y,r.y)<=a.y&&a.y<=Math.max(o.y,r.y))return !0;ga(h.y-i)>0!=ga(c.y-i)>0&&ga(e-(i-h.y)*(h.x-c.x)/(h.y-c.y)-h.x)<0&&(n=!n);}var o,r,a;return n}(n,t.x,t.y)),r}},_a=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"polyline",style:{...Ir,points:[{x:0,y:0},{x:0,y:0}],lineEnding:null,borderWidth:2,miterLimit:10,...t},...e}),i(this,"shapeType","polyline"),i(this,"renderPath",void 0),this.getPath();const{left:n,top:s}=this.getBoundingRect();this.updatePosition(n,s),this.updateOrigin();}initPath(){const {points:t,lineEnding:e}=this.parsedStyle,n=[];if(t.forEach(((t,e)=>{0===e?n.push({x:t.x,y:t.y,step:0,close:!1}):n.push({x:t.x,y:t.y,step:1,close:!1});})),e&&n.length>1)for(let t=0;t<e.length;t++)switch(e[t]){case"OpenArrow":this.addOpenArrow(n,t,!1);break;case"ROpenArrow":this.addOpenArrow(n,t,!0);break;case"ClosedArrow":this.addCloseArrow(n,t,!1);break;case"RClosedArrow":this.addCloseArrow(n,t,!0);break;case"Butt":this.addButt(n,t);break;case"Slash":this.addSlash(n,t);break;case"Square":this.addSquare(n,t);break;case"Diamond":this.addDiamond(n,t);break;case"Circle":this.addCircle(n,t);}return n}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),n=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||n.push({x:t.x-e,y:t.y-i,step:t.step,close:t.close});})),n}addPoint(t){const e=[...this.style.points];e.push(t),this.style.points=e;}updatePoints(){const{length:t}=this.parsedStyle.points,e=this.getLocalPosition(),i=[];this.renderPath.slice(0,t).forEach((t=>{i.push({x:t.x+e.x,y:t.y+e.y});})),this.style.points=i;}updatePoint(){const t=this.getLocalPosition(),e=this.parsedStyle.points.length,i=[];for(let n=0;n<e;n++)i.push({x:this.renderPath[n].x+t.x,y:this.renderPath[n].y+t.y});this.updateStyle({points:i});}getPath(){return this.pathDirty?(this.path=this.initPath(),this.renderPath=this.getRenderPath(this.path),this.steps=ha(this.renderPath),this.pathDirty=!1,this.path):this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,lineCap:e}=this.parsedStyle;if(2===this.path.length)return this.boundsDirty=!1,this.bounds=pa(this.path[0],this.path[1],t.value,e),this.bounds;const i=aa(this.path),n=t.value/2;return this.boundsDirty=!1,this.bounds={left:i.left-n,top:i.top-n,width:i.width+2*n,height:i.height+2*n},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i,points:n}=this.parsedStyle;return va(n,i.value+e,t.x,t.y,!1)}isLineArrow(){const{lineEnding:t}=this.parsedStyle;return !!t&&("None"!==t[0]||"None"!==t[1])}addOpenArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{points:n,borderWidth:s}=this.parsedStyle,{length:o}=n;let r=n[o-2],a=n[o-1];0===e&&(r={...n[0]},a={...n[1]}),ya(t,e,i,r,a,s.value);}addCloseArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{points:n,borderWidth:s}=this.parsedStyle,{length:o}=n;let r=n[o-2],a=n[o-1];0===e&&(r={...n[0]},a={...n[1]}),xa(t,e,i,r,a,s.value);}addCircle(t,e){const{points:i,borderWidth:n}=this.parsedStyle,{length:s}=i;Pa(t,e,i[0],i[s-1],n.value);}addDiamond(t,e){const{points:i,borderWidth:n}=this.parsedStyle,{length:s}=i;Ca(t,e,i[0],i[s-1],n.value);}addSquare(t,e){const{points:i,borderWidth:n}=this.parsedStyle,{length:s}=i;Sa(t,e,i[0],i[s-1],n.value);}addSlash(t,e){const{points:i,borderWidth:n}=this.parsedStyle,{length:s}=i;let o=i[s-2],r=i[s-1];0===e&&(o={...i[0]},r={...i[1]}),ba(t,e,o,r,n.value);}addButt(t,e){const{points:i,borderWidth:n}=this.parsedStyle,{length:s}=i;let o=i[s-2],r=i[s-1];0===e&&(o={...i[0]},r={...i[1]}),wa(t,e,o,r,n.value);}},Fa=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"rect",style:{...Ir,width:0,height:0,...t},...e}),i(this,"shapeType","rect");const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}getPath(){if(!this.pathDirty)return this.path;const{width:t,height:e,borderWidth:i}=this.parsedStyle,n=(null==i?void 0:i.value)||0,s=n,o=n,r=t.value-2*n,a=e.value-2*n;return this.path=[{x:s,y:o},{x:s+r,y:o},{x:s+r,y:o+a},{x:s,y:o+a}],this.steps=oa(this.path),this.pathDirty=!1,this.path}getStrokePath(){const{width:t,height:e,borderWidth:i}=this.parsedStyle,n=.5*((null==i?void 0:i.value)||0),s=n,o=n,r=t.value-2*n,a=e.value-2*n;this.strokePath=[{x:s,y:o},{x:s+r,y:o},{x:s+r,y:o+a},{x:s,y:o+a}],this.strokeSteps=oa(this.strokePath);}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:n}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:n.value},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{x:i,y:n,borderWidth:s,width:o,height:r}=this.parsedStyle,a=Gn(this.style.background)&&""!==this.style.background,l=s&&s.value,h=e/2;return a?ma(i,n,o.value,r.value,t.x,t.y):!!l&&function(t,e,i,n,s,o,r){return ma(t,e,i,s,o,r)||ma(t,e,s,n,o,r)||ma(t,e+n-s,i,s,o,r)||ma(t+i-s,e,s,n,o,r)}(i-h,n-h,o.value+e,r.value+e,s.value+e,t.x,t.y)}};class Ha extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stampPath",style:{...Ir,stampPoints:[],lineJoin:"miter",lineCap:"butt",borderWidth:2,miterLimit:4,...t},...e}),i(this,"shapeType","stampPath"),i(this,"renderPath",void 0),this.getPath();}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),n=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||n.push({x:t.x-e,y:t.y-i,step:t.step,close:t.close});})),n}isLinePath(){const t=this.path;if(t.length<2)return !0;let e=!0,i=!0;const n=t[0].x,s=t[0].y;for(let o=1;o<t.length;o++)t[o].x!==n&&(e=!1),t[o].y!==s&&(i=!1);return e||i}getPath(){return this.pathDirty?(this.path=this.parsedStyle.stampPoints,this.renderPath=this.getRenderPath(this.path),this.steps=function(t){if(t.length<1)return [];const e=[];for(let i=0;i<t.length;i++){const n=t[i];if(0===n.step)e.push(Kr("lineTo",[n],n.close));else if(1===n.step){if(i+2<t.length&&1===t[i+1].step&&1===t[i+2].step){const s=t[i+1],o=t[i+2];e.push(Kr("bezierCurveTo",[n,s,o],n.close)),i+=2;}}else 2===n.step&&e.push(Kr("moveTo",[n],n.close));}return e}(this.renderPath),this.pathDirty=!1,this.path):this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,stampPoints:e,lineCap:i}=this.parsedStyle;if(2===e.length)return this.boundsDirty=!1,this.bounds=pa(e[0],e[1],t.value,i),this.bounds;const n=aa(e),s=t.value/2;return this.boundsDirty=!1,this.bounds={left:n.left-s,top:n.top-s,width:n.width+2*s,height:n.height+2*s},this.bounds}}let Va=class extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"line",style:{...Ir,startPoint:{x:0,y:0},endPoint:{x:0,y:0},lineEnding:["None","None"],borderWidth:2,...t},...e}),i(this,"shapeType","line"),i(this,"renderPath",void 0),this.getPath();const{left:n,top:s}=this.getBoundingRect();this.updatePosition(n,s),this.updateOrigin();}initPath(){const{startPoint:t,endPoint:e,lineEnding:i}=this.parsedStyle,n=[{...t,step:0,close:!1},{...e,step:1,close:!1}];if(i)for(let t=0;t<i.length;t++)switch(i[t]){case"OpenArrow":this.addOpenArrow(n,t,!1);break;case"ROpenArrow":this.addOpenArrow(n,t,!0);break;case"ClosedArrow":this.addCloseArrow(n,t,!1);break;case"RClosedArrow":this.addCloseArrow(n,t,!0);break;case"Butt":this.addButt(n,t);break;case"Slash":this.addSlash(n,t);break;case"Square":this.addSquare(n,t);break;case"Diamond":this.addDiamond(n,t);break;case"Circle":this.addCircle(n,t);}return n}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),n=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||n.push({x:t.x-e,y:t.y-i,step:t.step,close:t.close});})),n}updatePoints(){const t=this.getLocalPosition();this.updateStyle({startPoint:{x:this.renderPath[0].x+t.x,y:this.renderPath[0].y+t.y},endPoint:{x:this.renderPath[1].x+t.x,y:this.renderPath[1].y+t.y}});}getPath(){return this.pathDirty?(this.path=this.initPath(),this.renderPath=this.getRenderPath(this.path),this.steps=ha(this.renderPath),this.pathDirty=!1,this.path):this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,lineCap:e}=this.parsedStyle,i=aa(this.path);if(2===this.path.length)return this.boundsDirty=!1,this.bounds=pa(this.path[0],this.path[1],t.value,e),this.bounds;const n=t.value/2||0;return this.boundsDirty=!1,this.bounds={left:i.left-n,top:i.top-n,width:i.width+2*n,height:i.height+2*n},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;return fa(i,n,s.value+e,t)}isLineArrow(){const{lineEnding:t}=this.parsedStyle;return !!t&&("None"!==t[0]||"None"!==t[1])}addCircle(t,e){const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;Pa(t,e,i,n,s.value);}addDiamond(t,e){const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;Ca(t,e,i,n,s.value);}addSquare(t,e){const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;Sa(t,e,i,n,s.value);}addSlash(t,e){const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;ba(t,e,i,n,s.value);}addButt(t,e){const{startPoint:i,endPoint:n,borderWidth:s}=this.parsedStyle;wa(t,e,i,n,s.value);}addOpenArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{startPoint:n,endPoint:s,borderWidth:o}=this.parsedStyle;ya(t,e,i,n,s,o.value);}addCloseArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{startPoint:n,endPoint:s,borderWidth:o}=this.parsedStyle;xa(t,e,i,n,s,o.value);}};class za extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stampText",style:{...Ir,text:"",color:"black",fontSize:12,fontFamily:"Microsoft YaHei",fontWeight:"normal",fontStyle:"normal",...t},...e}),i(this,"shapeType","stampText"),this.setTextFont();const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}setTextFont(){const{fontStyle:t,fontWeight:e,fontFamily:i,fontSize:n}=this.parsedStyle,s=""===(null==i?void 0:i.trim())?"sans-serif":i;null!=i&&i.includes(" ")?this.style.font=`${t} ${e} ${n.value}${n.unit} '${s}'`:this.style.font=`${t} ${e} ${n.value}${n.unit} ${s}`;}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,text:i,fontSize:n,font:s}=this.parsedStyle,o=document.createElement("canvas").getContext("2d");o.font=s;const{width:r}=o.measureText(i);return this.boundsDirty=!1,this.bounds={left:t,top:e-n.value,width:r,height:n.value},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}}let $a=class extends Fa{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stamp",style:{...t,background:"transparent",borderColor:"transparent"},...e}),i(this,"shapeType","stamp"),i(this,"stampConfig",[]),i(this,"stampItemShapes",[]),i(this,"renderType","stamp"),i(this,"initialWidth",0),i(this,"initialHeight",0),this.stampConfig=t.stampConfig||[];}initStamp(){this.stampConfig&&(this.renderType="stamp",this.initStampItem(),this.initStampStyle());}initStampItem(){if(!On(this.stampConfig))return;this.stampItemShapes=[];const{stampConfig:t,stampItemShapes:e}=this,{renderBlendMode:i}=this.parsedStyle;for(let n=0;n<t.length;n++){let s;"path"===t[n].type&&(s=new Ha({style:{opacity:this.style.opacity,renderBlendMode:i,...t[n]}})),"text"===t[n].type&&(s=new za({style:{opacity:this.style.opacity,renderBlendMode:i,...t[n]}})),"image"===t[n].type&&(s=new Ma({style:{opacity:this.style.opacity,renderBlendMode:i,...t[n]}})),s&&e.push(s);}}initStampStyle(){if(!On(this.stampConfig))return;const t=[],e=[],{stampItemShapes:i}=this,n=i.some((t=>t instanceof Ha));for(const s of i){if(n&&!(s instanceof Ha)){this.appendChild(s);continue}const{left:i,top:o,width:r,height:a}=s.getBoundingRect();t.push(i,i+r),e.push(o,o+a),this.appendChild(s);}this.initialWidth=Math.max(...t)-Math.min(...t),this.initialHeight=Math.max(...e)-Math.min(...e);const s=Math.min(...t),o=Math.min(...e);this.updateStyle({x:s,y:o,width:this.initialWidth,height:this.initialHeight});for(let t=0;t<i.length;t++){const{left:e,top:n}=i[t].getBoundingRect();let s=n-this.style.y;i[t]instanceof za&&(s+=i[t].parsedStyle.fontSize.value),i[t].setLocalPosition(e-this.style.x,s);}this.updateOrigin();}isPointInPath(t,e){return super.isPointInPath(t,0)}};class ja extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"roundedRect",style:{...Ir,roundedRadius:0,width:0,height:0,...t},...e}),i(this,"shapeType","roundedRect");const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:n}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:n.value},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{x:i,y:n,width:s,height:o,borderWidth:r}=this.parsedStyle,a=(r.value+e||0)/2;return ma(i-a,n-a,s.value+2*a,o.value+2*a,t.x,t.y)}getCenterPosition(){const{width:t,height:e}=this.parsedStyle,i=new Ra({style:{x:t.value/2,y:e.value/2}});this.appendChild(i);const{x:n,y:s}=i.getPosition();return i.destroy(),{x:n,y:s}}}class Xa extends ka{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"freeText",style:{...Ir,width:0,height:0,textAlign:"left",...t},...e}),i(this,"shapeType","freeText"),i(this,"lines",void 0),i(this,"textType","textBox"),i(this,"lineHeightOffset",.2),i(this,"renderClipPath",void 0),i(this,"renderClipStep",void 0),i(this,"totalTextHeight",0),i(this,"limitWidth",1),i(this,"textMaxWidth",0),i(this,"borderOffset",0),i(this,"padding",1),this.textType=t.freeTextType||"textBox",this.setLimitWidth(this.parsedStyle.width.value),this.calculateTextLines();const{x:n,y:s}=this.parsedStyle;this.setLocalPosition(n,s),this.updateOrigin();}getLimitTextWithoutSpace(t,e){const{textContents:i}=this.parsedStyle,n=Nn(t),s=n.segmentation.length,o=n.segmentation[s-1],r=Ga(" ",i[o.freeContentIndex]),a=o.text.split(" ").length-1;let l;for(let t=0;t<a&&(l=t+1,!(n.width-l*r<e));t++);for(let t=0;t<l;t++)n.word=n.word.slice(0,-1),n.width-=r,o.text=o.text.slice(0,-1),o.width-=r;return n}splitWordSegment(t,e){const i=t,n=[],s=[];let o=e;const r=i.segmentation.length;for(let t=0;t<r;t++){const e=i.segmentation[t];if(!(e.width<o)){if(e.width===o){n.push({...e}),s.push(...i.segmentation.slice(r-t-1));break}{const a=this.parsedStyle.textContents[e.freeContentIndex],l=Ya(e.text,o,a);2===l.length?(n.push({text:l[0],width:Ga(l[0],a),freeContentIndex:e.freeContentIndex}),s.push({text:l[1],width:Ga(l[1],a),freeContentIndex:e.freeContentIndex})):s.push({...e});const h=r-t-1;h>0&&s.push(...i.segmentation.slice(-h));break}}n.push({...e}),o-=e.width;}const a=t=>{let e="",i=0;return t.forEach((t=>{e+=t.text,i+=t.width;})),{word:e,width:i,segmentation:t}};return 0===n.length?[a(s)]:[a(n),a(s)]}getWordSegmentation(){const{textContents:t}=this.parsedStyle;let e="";const i=[0];t.forEach((t=>{e+=t.content,i.push(e.length);}));const n=e.match(/\S+\s*/g)||[],s=[];let o=0;const r=Za(e);if(r.length&&n.unshift(...r)," "===e[0]){const t=e.match(/^ +/)[0];n[0]?n[0]=t+n[0]:n[0]=t;}for(let t=0;t<n.length;t++){const e=n[t].split(/(\r\n|[\r\n])/).filter((t=>""!==t));e.length>2&&(n[t]=e[0]+e[1],n.splice(t+1,0,...e.slice(2)));}return n.forEach((e=>{const n=o+e.length-1,r=[...i.filter((t=>t>o&&t<=n))];if(0===r.length){const n=i.filter((t=>t<=o)).length,r=Ga(e,t[n-1]);s.push({word:e,segmentation:[{text:e,width:r,freeContentIndex:n-1}],width:r});}else {const n=[];let a=0;r.forEach(((s,l)=>{const h=s-(r[l-1]||o),c=r[l-1]-o||0,d=e.substring(c,c+h),u=Ga(d,t[i.indexOf(s)-1]);if(n.push({text:d,width:u,freeContentIndex:i.indexOf(s)-1}),a+=u,l===r.length-1){const o=Ga(e.substring(c+h),t[i.indexOf(s)]);n.push({text:e.substring(c+h),freeContentIndex:i.indexOf(s),width:o}),a+=o;}})),s.push({word:e,width:a,segmentation:n});}o+=e.length;})),s}organizeLine(){if(0===this.lines.length)return;const{y:t}=this.parsedStyle;let e=t+this.borderOffset+this.padding,i=0,n=0;this.lines.forEach(((t,s)=>{n=0,i=Math.max(t.width,i);let o=0,r="";if(0===t.width&&""===t.words[0].text){const e=Ga(" ",t.words[0].style);t.width=e,t.words[0].wordWidth=e,t.words[0].text=" ";}if(t.words.forEach((t=>{r+=t.text,o=Math.max(o,t.wordHeight),t.widthWithoutLf=Ja(t.text)?Ga(t.text,t.style,!0):t.wordWidth,n+=t.widthWithoutLf;})),"textBox"===this.textType&&"justify"===this.style.textAlign&&s!==this.lines.length-1){const e=[],i=/\S+/g;let s,o=0;for(;null!==(s=i.exec(r));)0===e.length&&0!==s.index?e.push(0):e.push(s.index);if(e.length>1){let i=this.limitWidth-n;i<0&&(i=0);const s=i/(e.length-1),r=t=>{for(let i=0;i<e.length;i++)if(e[i]>t)return i;return e.length};t.words.forEach(((t,e)=>{e>0&&(t.x+=s*(r(o)-1)),o+=t.text.length;})),n=this.limitWidth,t.width=this.limitWidth;}}const{lineHeightOffset:a}=this;t.widthWithoutLF=n,t.height=o,t.y=o*(1-a)+e,e+=o,s>0&&(t.y+=this.lines[s-1].height*a,e+=this.lines[s-1].height*a);})),this.textMaxWidth=i;}getTextAlignOffset(t){if("freeTextWriter"===this.textType)return 0;const{limitWidth:e}=this,{textAlign:i}=this.parsedStyle,n=t?t.widthWithoutLF:0;let s=0;return "center"===i?s=(e-n)/2:"right"===i&&(s=e-n),s}getPath(){var t;if(!this.pathDirty)return this.path;const{width:e,height:i}=this.getBoundingRect(),n=.5*((null===(t=this.parsedStyle.borderWidth)||void 0===t?void 0:t.value)||0),s=n,o=n,r=e-2*n,a=i-2*n;if(this.path=[{x:s,y:o},{x:s+r,y:o},{x:s+r,y:o+a},{x:s,y:o+a}],"textBox"===this.textType){const t=this.borderOffset/2;this.renderClipPath=[{x:s+t,y:o+t},{x:s+r-t,y:o+t},{x:s+r-t,y:o+a-t},{x:s+t,y:o+a-t}],this.renderClipStep=oa(this.renderClipPath);}return this.steps=oa(this.path),this.pathDirty=!1,this.path}setLimitWidth(t){const{borderWidth:e,borderColor:i}=this.parsedStyle;"textBox"===this.textType&&e.value&&!i.isNone&&(this.borderOffset=e.value,this.padding=e.value),this.limitWidth=t-2*this.borderOffset-2*this.padding;}calculateTextLines(){const{textContents:t,x:e}=this.parsedStyle;if(null==t||!t.length||this.limitWidth<=0)return this.lines=[],void this.calculateTotalHeight();const i=e+this.borderOffset+this.padding;this.lines=function(t,e,i){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=document.createElement("div"),o=function(t,e,i){const n=[],s=document.createDocumentFragment();return t.style.width=`${e}px`,t.style.wordBreak="break-word",t.style.visibility="hidden",t.style.position="absolute",i.forEach((t=>{const{fontSize:e,fontStyle:i,fontFamily:o,fontWeight:r,color:a,content:l}=t;if(!l.length)return;const h=""===(null==o?void 0:o.trim())?"sans-serif":o,c=null!=o&&o.includes(" ")?`${i} ${r} ${e.value}${e.unit} '${h}'`:`${i} ${r} ${e.value}${e.unit} ${h}`,d=document.createElement("div");if(d.style.font=c,d.style.letterSpacing="0px",d.style.whiteSpace="pre-wrap",d.style.display="inline",d.style.color=a,u=l,new RegExp(`([A-Za-z0-9])\\1{${10-1},}`).test(u)){const t=document.createDocumentFragment();for(let t=0;t<l.length;t++)if("\n"===l[t]||"\r"===l[t]||"\n\r"===l[t])d.appendChild(document.createElement("br"));else {const e=document.createElement("span");e.style.display="inline-block",e.innerText=l[t],d.appendChild(e);}d.appendChild(t);}else d.innerText=l;var u;s.appendChild(d),n.push(d);})),t.appendChild(s),n}(s,e,t);document.body.appendChild(s);const r=[];let a,l=[],h={};const c=()=>{if(!l.length)return;h.x=i,h.words=l;let t=0;l.forEach((e=>{t+=e.wordWidth;})),h.width=t,r.push(h),l=[],h={};},d=(e,s,o,r)=>{const h=t[o];if(n){const n=[],r=/\S+/g;let c;for(;null!==(c=r.exec(e));)0===n.length&&0!==c.index?n.push(0):n.push(c.index);let d=s-(a||0)+i;for(let i=0;i<n.length;i++){const s=n[i],r=i===n.length-1?e.length:n[i+1],a=e.slice(s,r),c=Ga(a,t[o]);l.push({freeContentIndex:o,originText:a,style:h,text:a,wordHeight:h.fontSize.value,wordWidth:c,x:d}),d+=c;}}else l.push({freeContentIndex:o,originText:e,style:h,text:e,wordHeight:h.fontSize.value,wordWidth:r,x:s-(a||0)+i});},u=(t,e)=>{d("\n",a||0,t,e),c();};for(let e=0;e<o.length;e++){const i=Qa(o[e]);if(0===i.length)continue;const n=t[e].content.replace(/\r\n/g,"\n"),s=n.length,r=Za(n).length,l=n.slice(r),h=Ga("\n",t[e]);if(r)for(let t=0;t<r;t++)u(e,h);i.length&&_n(a)&&(a=i[0].x);const p=i.map(((t,e)=>({obj:t,index:e,oldIndex:e,minIndex:void 0}))).filter((t=>{let{obj:e,index:i}=t;return e.x===a&&0!==i}));i.length&&i[0].x===a&&c();const g=i[i.length-1];if(s===i.length)if(p.length){let t=0;p.forEach((s=>{const{index:o}=s,r=n.slice(t,o),a=i[o-1],l=i[t].x;t=o,d(r,l,e,a.x-l+a.width),c();}));const s=n.slice(t),o=i[t].x;d(s,o,e,g.x-o+g.width);}else {const t=g.x-i[0].x+g.width;d(n,i[0].x,e,t);}else {const t=Ka(l);for(let e=0;e<t.length;e++)p.forEach((i=>{i.index>=t[e]&&(i.index===t[e]&&_n(null==i?void 0:i.minIndex)&&(i.minIndex=t[e]),i.index+=1);}));if(p.length){let n=0,s=0;p.forEach(((t,o)=>{const{index:r,oldIndex:a,minIndex:p}=t;let g=0;if(_n(p)||(g=r-p),g){const t=l.slice(n,r-g+1),o=i[a-1],p=i[s].x,f=o.x-p+o.width+h;d(t,p,e,f),c();for(let t=0;t<g-1;t++)u(e,h);}else {const t=l.slice(n,r),o=i[a-1],h=i[s].x;d(t,h,e,o.x-h+o.width),c();}n=r,s=a;}));const o=t.filter((t=>t>p[p.length-1].index)).length,r=l.slice(n,l.length-o+1),a=i[i.length-1],g=i[p[p.length-1].oldIndex].x,f=o>0?a.x-g+a.width+h:a.x-g+a.width;d(r,g,e,f);for(let t=0;t<o-1;t++)0===t&&c(),u(e,h);}else if(t.length){const n=l.slice(0,l.length-t.length+1),s=g.x-i[0].x+g.width+h;d(n,i[0].x,e,s),c();for(let i=0;i<t.length-1;i++)u(e,h);}else {const t=g.x-i[0].x+g.width;d(l,i[0].x,e,t);}}}return c(),s.remove(),r}(t,this.limitWidth,i,"justify"===this.style.textAlign),this.organizeLine(),this.calculateTotalHeight();}calculateTotalHeight(){const{y:t,height:e}=this.parsedStyle,i=this.lines.length;if(i){const n=this.lines[i-1];let s=n.y+n.height*this.lineHeightOffset-t+2*this.borderOffset;Ja(n.words[0].text)&&(s+=n.height*(1+this.lineHeightOffset)),this.totalTextHeight=s>e.value?s:e.value;}else this.totalTextHeight=e.value;}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,height:i}=this.parsedStyle,n="freeTextWriter"===this.textType?this.totalTextHeight:i.value,s="freeTextWriter"===this.textType?this.textMaxWidth+2*this.borderOffset+2*this.padding:this.parsedStyle.width.value;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:s,height:n},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}}function Ga(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{fontSize:n,fontStyle:s,fontFamily:o,fontWeight:r}=e,a=document.createElement("canvas").getContext("2d"),l=""===(null==o?void 0:o.trim())?"sans-serif":o;null!=o&&o.includes(" ")?a.font=`${s} ${r} ${n.value}${n.unit} '${l}'`:a.font=`${s} ${r} ${n.value}${n.unit} ${l}`;let h=0;for(let e=0;e<t.length;e++){const n=t.charAt(e);i&&qa(n)||(h+=a.measureText(n).width);}return h}function Ya(t,e,i){let n=0;for(let s=0;s<t.length;s++){if(Ga(t.substring(0,s+1),i)>e){n=s;break}}return 0===n?[t]:[t.substring(0,n),t.substring(n)]}function qa(t){return /^[\r\n]+$/.test(t)}function Ja(t){return t.endsWith("\n")||t.endsWith("\r")||t.endsWith("\r\n")}function Za(t){const e=t.match(/^(?:\r\n|\r|\n)*/);if(e){const t=e[0];let i=0;for(const e of t)"\n"!==e&&"\r"!==e||(i+=1);return t.includes("\r\n")&&(i-=1),Array.from({length:i},(()=>"\n"))}return []}function Qa(t){const e=[],i=document.createRange(),n=function(t){const e=[],i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let n;for(;n=i.nextNode();)e.push(n);return e}(t);return n.forEach((t=>{i.selectNodeContents(t);const n=t.nodeValue;for(let s=0;s<n.length;s++){i.setStart(t,s),i.setEnd(t,s+1);const o=i.getClientRects(),r=o.length>1?o[1]:o[0];e.push({text:n[s],x:r.left,y:r.top,width:r.width,height:r.height});}})),function(t){const e=new Map;t.forEach((t=>{var i;e.has(t.y)||e.set(t.y,[]),null===(i=e.get(t.y))||void 0===i||i.push(t);})),e.forEach((t=>{t.sort(((t,e)=>t.x-e.x));}));const i=[];return e.forEach((t=>{i.push(...t);})),i}(e)}function Ka(t){const e=/(\r\n|[\r\n])/g;let i;const n=[];for(;null!==(i=e.exec(t));)n.push(i.index);return n}const tl=1/0;class el{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:tl,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:tl,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1/0;i(this,"minX",void 0),i(this,"maxX",void 0),i(this,"minY",void 0),i(this,"maxY",void 0),i(this,"rect",void 0),i(this,"updateId",void 0),this.minX=t,this.maxX=e,this.minY=n,this.maxY=s,this.rect=null,this.updateId=-1;}static isEmpty(t){return t.minX===t.maxX&&t.minY===t.maxY}static fromBounds(t){return (new el).setFromBounds(t)}static create(){return new el}setFromBounds(t){return this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY,this}clear(){return this.minX=tl,this.maxX=-1/0,this.minY=tl,this.maxY=-1/0,this}getRect(t){const{minX:e,minY:i,maxX:n,maxY:s}=this;if(e>n||i>s)return new ls(0,0,0,0);const o=t||new ls;return o.update(e,i,n-e,s-i),o}addPoint(t){return this.addBounds({minX:t.x,maxX:t.x,minY:t.y,maxY:t.y})}addBounds(t){const e=nl(this,t);return this.setFromBounds(e)}addBoundsMask(t,e){const i=il(t,e);if(i.minX<=i.maxX&&i.minY<=i.maxY){const t=nl(i,this);this.setFromBounds(t);}return this}intersection(t){if(i=t,!((e=this).minX<=i.maxX&&e.maxX>=i.minX&&e.minY<=i.maxY&&e.maxY>=i.minY))return null;var e,i;const n=il(this,t);return el.fromBounds(n)}union(t){const e=nl(this,t);return el.fromBounds(e)}addBoundsArea(t,e){const{x:i,y:n,width:s,height:o}=e,r={minX:i,minY:n,maxX:i+s,maxY:n+o};return this.addBoundsMask(t,r)}addFrame(t,e){return this.setFromTransformedBounds(t.worldTransform,e)}setFromTransformedBounds(t,e){for(let i=0;i<2;i++){const n=t.transformPoint({x:i?e.maxX:e.minX,y:i?e.maxY:e.minY});this.addPoint(n);}return this}addQuad(t){for(let e=0;e<4;e++)this.addPoint({x:t[2*e],y:t[2*e+1]});}}function il(t,e){return {minX:t.minX>e.minX?t.minX:e.minX,minY:t.minY>e.minY?t.minY:e.minY,maxX:t.maxX<e.maxX?t.maxX:e.maxX,maxY:t.maxY<e.maxY?t.maxY:e.maxY}}function nl(t,e){return {minX:t.minX<e.minX?t.minX:e.minX,minY:t.minY<e.minY?t.minY:e.minY,maxX:t.maxX>e.maxX?t.maxX:e.maxX,maxY:t.maxY>e.maxY?t.maxY:e.maxY}}class sl extends ka{constructor(){super({}),i(this,"name","Document"),i(this,"defaultView",void 0),i(this,"documentElement",void 0),i(this,"timeLine",void 0),this.nodeName="document",this.documentElement=new ka({name:"Root",id:"root",style:{visibility:"visible"}}),this.documentElement.ownerDocument=this,this.documentElement.parentNode=this,this.childNodes=[this.documentElement];}get children(){return this.childNodes}get childElementCount(){return this.childNodes.length}get firstElementChild(){return this.firstChild}get lastElementChild(){return this.lastChild}createElement(t,e){const i=this.defaultView.customElements.get(t);return new i(e)}getElementById(t){return null}getElementsByName(t){return this.documentElement.getElementsByTagName(t)}getElementsByTagName(t){return this.documentElement.getElementsByTagName(t)}getElementsByClassName(t){return this.documentElement.getElementsByClassName(t)}append(){return this.documentElement.append(...arguments)}prepend(){return this.documentElement.prepend(...arguments)}querySelector(t){return this.documentElement.querySelector(t)}querySelectorAll(t){return this.documentElement.querySelectorAll(t)}find(t){return this.documentElement.find(t)}findAll(t){return this.documentElement.findAll(t)}appendChild(t){return this.documentElement.appendChild(t)}cloneNode(t){return this.documentElement.cloneNode(t)}insertBefore(t,e){return this.documentElement.insertBefore(t,e)}removeChild(t){return this.documentElement.removeChild(t)}replaceChild(t,e){return this.documentElement.replaceChild(t,e)}destroy(){}}class ol extends Jo{constructor(){super(...arguments),i(this,"altKey",void 0),i(this,"button",void 0),i(this,"buttons",void 0),i(this,"ctrlKey",void 0),i(this,"metaKey",void 0),i(this,"shiftKey",void 0),i(this,"relatedTarget",void 0),i(this,"client",new Vr),i(this,"movement",new Vr),i(this,"offset",new Vr),i(this,"page",new Vr),i(this,"screen",new Vr),i(this,"global",new Vr),i(this,"canvas",new Vr);}initEvent(t,e,i){throw new Error("Method not implemented.")}get clientX(){return this.client.x}get clientY(){return this.client.y}get x(){return this.client.x}get y(){return this.client.y}get movementX(){return this.movement.x}get movementY(){return this.movement.x}get offsetX(){return this.offset.x}get offsetY(){return this.offset.y}get pageX(){return this.page.x}get pageY(){return this.page.y}get screenX(){return this.screen.x}get screenY(){return this.screen.y}get globalX(){return this.global.x}get globalY(){return this.global.y}get canvasX(){return this.canvas.x}get canvasY(){return this.canvas.y}getModifierState(t){return "getModifierState"in this.nativeEvent&&this.nativeEvent.getModifierState(t)}initMouseEvent(t,e,i,n,s,o,r,a,l,h,c,d,u,p,g){throw this.initUIEvent(t,i,i,n,s),new Error("initMouseEvent() DOM API is deprecated.")}}function rl(t,e){e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey,e.relatedTarget=null,e.client.setFromPoint(t.client),e.movement.setFromPoint(t.movement),e.offset.setFromPoint(t.offset),e.page.setFromPoint(t.page),e.screen.setFromPoint(t.screen),e.global.setFromPoint(t.global),e.canvas.setFromPoint(t.canvas);}class al extends ol{constructor(){super(...arguments),i(this,"deltaMode",void 0),i(this,"deltaX",void 0),i(this,"deltaY",void 0),i(this,"deltaZ",void 0),i(this,"DOM_DELTA_PIXEL",0),i(this,"DOM_DELTA_LINE",1),i(this,"DOM_DELTA_PAGE",2);}}function ll(t,e){e.deltaMode=t.deltaMode,e.deltaX=t.deltaX,e.deltaY=t.deltaY,e.deltaZ=t.deltaZ;}class hl extends ol{constructor(t){super(t),i(this,"height",0),i(this,"isPrimary",void 0),i(this,"pointerId",void 0),i(this,"pointerType",void 0),i(this,"pressure",void 0),i(this,"tangentialPressure",void 0),i(this,"tiltX",void 0),i(this,"tiltY",void 0),i(this,"twist",void 0),i(this,"width",0),i(this,"getCoalescedEvents",void 0),i(this,"getPredictedEvents",void 0),this.isPrimary=!1,this.height=0,this.width=0;}}function cl(t,e){e.isPrimary=t.isPrimary,e.width=t.width,e.height=t.height,e.tiltX=t.tiltX,e.tiltY=t.tiltY,e.pointerType=t.pointerType,e.pointerId=t.pointerId,e.pressure=t.pressure,e.twist=t.twist,e.tangentialPressure=t.tangentialPressure;}class dl{constructor(t,e){i(this,"root",void 0),i(this,"cursor","default"),i(this,"events",void 0),i(this,"trackingData",void 0),i(this,"contextService",void 0),this.root=t,this.contextService=e,this.events={},this.trackingData={},this.on("pointerdown",this.onPointerdown.bind(this)),this.on("pointermove",this.onPointermove.bind(this)),this.on("pointerout",this.onPointerout.bind(this)),this.on("pointerleave",this.onPointerout.bind(this)),this.on("pointerover",this.onPointerover.bind(this)),this.on("pointerup",this.onPointerup.bind(this)),this.on("wheel",this.onWheel.bind(this));}clientToCanvas(t){const e=this.contextService.getBoundingClientRect();return new Vr(t.x-(e.x||0),t.y-(e.y||0))}canvasToClient(t){const e=this.root.defaultView.contextService.getBoundingClientRect();return new Vr(t.x+(e.x||0),t.y+(e.y||0))}getPropagationPath(t){const e=[t];for(;ka.isNode(t)&&t!==this.root;)t=t.parentNode,e.push(t);return e.reverse()}getHitTarget(t,e){const{root:i}=this,{isInteractive:n}=i,s=gl(i,n,new Vr(t,e));return s?s[0]:null}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push({fn:e,order:0}),this.events[t].sort(((t,e)=>t.order-e.order));}emit(t){if(!this.root)return;const e=this.events[t.type]||[];for(let i=0;i<e.length;i++)e[i].fn(t);}onPointerdown(t){if(!(t instanceof hl))return;const e=this.generatePointerEvent(t);let i;er(e,"pointerdown"),"touch"===e.pointerType?i="touchstart":ul(e)&&(i=2===e.button?"rightdown":"mousedown"),er(e,i);this.getTrackingData(t.pointerId).pressTargetsByButton[t.button]=e.composedPath();}onPointermove(t){if(!(t instanceof hl))return;const e=this.generatePointerEvent(t),i=ul(e),n=this.getTrackingData(t.pointerId),s=pl(n.overTargets);if(s&&s!==e.target){const n="mousemove"===t.type?"mouseout":"pointerout",o=this.generatePointerEvent(t,n,s);er(o,"pointerout"),i&&er(o,"mouseout");const r=e.composedPath();if(!r.includes(s)){const e=this.generatePointerEvent(t,"pointerleave",s);for(e.eventPhase=e.AT_TARGET;e.target&&!r.includes(e.target);)e.currentTarget=e.target,tr(e,e.type),i&&tr(e,"mouseleave"),e.target=e.target.parentNode;}}if(s!==e.target){const n="mousemove"===t.type?"mouseover":"pointerover",o=this.clonePointerEvent(e,n);er(o,"pointerover"),i&&er(o,"mouseover");let r=ka.isNode(s)&&(null==s?void 0:s.parentNode);for(;r&&r!==(ka.isNode(this.root)&&this.root.parentNode)&&r!==e.target;)r=r.parentNode;if(!r||r===this.root.parentNode){const t=this.clonePointerEvent(e,"pointerenter");for(t.eventPhase=t.AT_TARGET;t.target&&t.target!==s&&t.target!==this.root.parentNode;)t.currentTarget=t.target,tr(t,t.type),i&&tr(t,"mouseenter"),t.target=t.target.parentNode;}}var o;(er(e,"pointermove"),"touch"===e.pointerType&&er(e,"touchmove"),i)&&(er(e,"mousemove"),this.cursor=null===(o=e.target)||void 0===o?void 0:o.cursor);n.overTargets=e.composedPath();}onPointerup(t){if(!(t instanceof hl))return;const e=performance.now(),i=this.generatePointerEvent(t);er(i,"pointerup");const{pointerType:n}=i;let s;"touch"===n?s="touchend":ul(i)&&(s=2===i.button?"rightup":"mouseup"),er(i,s);const o=this.getTrackingData(t.pointerId),r=pl(o.pressTargetsByButton[t.button]);let a=r;const l=i.composedPath();if(r&&!l.includes(r)){let e=r;for(;e&&!l.includes(e);)i.currentTarget=e,tr(i,"pointerupoutside"),"touch"===n?s="touchendoutside":ul(i)&&(s=2===i.button?"rightupoutside":"mouseupoutside"),tr(i,s),e=e.parentNode;delete o.pressTargetsByButton[t.button],a=e;}if(a){const r=this.clonePointerEvent(i,"click");r.target=a,r.path=null,o.clicksByButton[t.button]||(o.clicksByButton[t.button]={clickCount:0,target:r.target,timeStamp:e});const l=o.clicksByButton[t.button];l.target===r.target&&e-l.timeStamp<200?l.clickCount+=1:l.clickCount=1,l.target=r.target,l.timeStamp=e,r.detail=l.clickCount,s="mouse"===n?"click":"touch"===n?"tap":"pointertap",er(r,s);}}onPointerout(t){if(!(t instanceof hl))return;const e=this.getTrackingData(t.pointerId);if(e.overTargets){const i=ul(t),n=pl(e.overTargets),s=this.generatePointerEvent(t,"pointerout",n);er(s),i&&er(s,"mouseout");const o=this.generatePointerEvent(t,"pointerleave",n);for(o.eventPhase=o.AT_TARGET;o.target&&o.target!==this.root.parentNode;)o.currentTarget=o.target,tr(o,o.type),i&&tr(o,"mouseleave"),o.target=o.target.parentNode;e.overTargets=null;}this.cursor=null;}onPointerover(t){if(!(t instanceof hl))return;const e=this.getTrackingData(t.pointerId),i=this.generatePointerEvent(t),n=ul(t);var s;(er(i,"pointerover"),n&&er(i,"mouseover"),"mouse"===i.pointerType)&&(this.cursor=null===(s=i.target)||void 0===s?void 0:s.cursor);const o=this.clonePointerEvent(i,"pointerenter");for(o.eventPhase=o.AT_TARGET;o.target&&o.target!==this.root.parentNode;)o.currentTarget=i.target,tr(o,o.type),n&&tr(o,"mouseenter"),o.target=o.target.parentNode;e.overTargets=i.composedPath();}onWheel(t){if(!(t instanceof al))return;er(this.generateWheelEvent(t));}generatePointerEvent(t,e,i){const n=new hl(this);return cl(t,n),rl(t,n),Zo(t,n),n.nativeEvent=t.nativeEvent,n.originalEvent=t,n.target=null!=i?i:this.getHitTarget(n.globalX,n.globalY),n.type=null!=e?e:n.type,n}generateWheelEvent(t){const e=new al(this);return ll(t,e),rl(t,e),Zo(t,e),e.nativeEvent=t.nativeEvent,e.originalEvent=t,e.target=this.getHitTarget(e.globalX,e.globalY),e}clonePointerEvent(t,e){const i=new hl(this);return cl(t,i),rl(t,i),Zo(t,i),i.nativeEvent=t.nativeEvent,i.originalEvent=t,i.target=t.target,i.path=t.composedPath().slice(),i}getTrackingData(t){return this.trackingData[t]||(this.trackingData[t]={pressTargetsByButton:{},clicksByButton:{},overTargets:null}),this.trackingData[t]}}function ul(t){const{pointerType:e}=t;return "mouse"===e||"pen"===e}function pl(t){if(!t)return null;let e=t[0]||null;for(let i=1,n=t.length;i<n&&t[i].parentNode===e;i++)e=t[i];return e}function gl(t,e,i){if(!t||"visible"!==t.style.visibility)return null;const{hitArea:n}=t.style;if(n){const{x:e,y:s}=t.transform.worldTransform.transformPoint(i);if(!n.contains(e,s))return null}const{clipPath:s}=t.style;if(s&&!s.containPoint(i))return null;if(t.isChildrenInteractive&&t.children){const{children:n}=t;for(let s=n.length-1;s>=0;s--){const o=n[s],r=gl(o,e||o.isInteractive,i);if(r)return (r.length>0||t.isInteractive)&&r.push(t),r}}return e&&t.containPoint(i)?t.isInteractive?[t]:[]:null}i(class{constructor(){i(this,"canvasConfig",void 0),i(this,"contextService",void 0),i(this,"renderingContext",void 0),i(this,"eventService",void 0),i(this,"rootPointerEvent",new hl(null)),i(this,"rootWheelEvent",new al(null)),i(this,"autoPreventDefault",!0);}init(t){const{renderingService:e,renderingContext:i,contextService:n,canvasConfig:s}=t;this.eventService=new dl(i.root.parentNode,n),t.eventService=this.eventService,this.renderingContext=i,this.contextService=n,this.canvasConfig=s,e.hooks.wheel.on(this.onWheel),e.hooks.pointerdown.on(this.onPointerdown),e.hooks.pointermove.on(this.onPointermove),e.hooks.pointerup.on(this.onPointerup),e.hooks.pointerout.on(this.onPointermove),e.hooks.pointerover.on(this.onPointermove);}destroy(){}onWheel(t){const e=this.normalizeWheelEvent(t);this.eventService.emit(e);}onPointerdown(t){if(this.isTouchEvent(t))return;const e=this.normalizeToPointerEvent(t);if(this.autoPreventDefault&&e.isNormalized){(t.cancelable||!("cancelable"in t))&&t.preventDefault();}const i=this.bootstrapEvent(e,this.rootPointerEvent);this.eventService.emit(i),this.setCursor(this.eventService.cursor);}onPointermove(t){if(this.isTouchEvent(t))return;const e=this.normalizeToPointerEvent(t),i=this.bootstrapEvent(e,this.rootPointerEvent);this.eventService.emit(i),this.setCursor(this.eventService.cursor);}onPointerup(t){if(this.isTouchEvent(t))return;const e=this.contextService.getDomElement(),i=t.target===e?"":"outside",n=this.normalizeToPointerEvent(t),s=this.bootstrapEvent(n,this.rootPointerEvent);s.type+=i,this.eventService.emit(s),this.setCursor(this.eventService.cursor);}setCursor(t){this.contextService.setCursor(t||this.canvasConfig.cursor||"default");}normalizeWheelEvent(t){const e=this.rootWheelEvent;e.nativeEvent=t,this.transferMouseData(t,e),ll(t,e);const i=new Vr(t.clientX,t.clientY),{x:n,y:s}=this.eventService.clientToCanvas(i);return e.canvas.x=n,e.canvas.y=s,e.offset.setFromPoint(e.canvas),e.global.setFromPoint(e.canvas),Zo(t,e),e}normalizeToPointerEvent(t){const e=this.renderingContext.root.ownerDocument.defaultView;if(e.supportTouchEvent&&t instanceof TouchEvent){const e=t;e.isNormalized=!0,e.pointerType="touch";}else if(!MouseEvent||t instanceof MouseEvent&&(!e.supportPointerEvent||!(t instanceof PointerEvent))){const e=t;e.isPrimary=!0,e.width=1,e.height=1,e.tiltX=0,e.tiltY=0,e.pointerType="mouse",e.pointerId=1,e.pressure=.5,e.twist=0,e.tangentialPressure=0,e.isNormalized=!0;}return t}bootstrapEvent(t,e){this.renderingContext.root.ownerDocument.defaultView,e.originalEvent=null,e.nativeEvent=t,cl(t,e),this.transferMouseData(t,e);const{x:i,y:n}=this.eventService.clientToCanvas(new Vr(t.clientX,t.clientY));return e.canvas.x=i,e.canvas.y=n,e.offset.setFromPoint(e.canvas),e.global.setFromPoint(e.canvas),Zo(t,e),"pointerleave"===e.type&&(e.type="pointerout"),e.type.startsWith("mouse")&&e.type.replace("mouse","pointer"),e}transferMouseData(t,e){e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey,e.relatedTarget=null,e.client.x=t.clientX,e.client.y=t.clientY,e.movement.x=t.movementX,e.movement.y=t.movementY,e.page.x=t.pageX,e.page.y=t.pageY,e.screen.x=t.screenX,e.screen.y=t.screenY;}isTouchEvent(t){return this.renderingContext.root.ownerDocument.defaultView.supportTouchEvent&&"touch"===t.pointerType}},"moduleName","Event");class fl extends Jo{constructor(t,e,n,s,o,r,a,l){super(null),i(this,"relatedNode",void 0),i(this,"prevValue",void 0),i(this,"newValue",void 0),i(this,"attrName",void 0),i(this,"attrChange",void 0),i(this,"prevParsedValue",void 0),i(this,"newParsedValue",void 0),this.type=t,this.relatedNode=e,this.prevValue=n,this.newValue=s,this.attrName=o,this.attrChange=r,this.prevParsedValue=a,this.newParsedValue=l;}}i(fl,"ADDITION",2),i(fl,"MODIFICATION",1),i(fl,"REMOVAL",3);class vl{constructor(t){i(this,"contextService",void 0),i(this,"renderingPlugins",[]),i(this,"config",{autoRendering:!0}),Object.assign(this.config,t);}use(t){this.renderingPlugins.includes(t)||this.renderingPlugins.push(t);}initPlugins(t){this.renderingPlugins.forEach((e=>{e.init(t);}));}destroyPlugins(){this.renderingPlugins.forEach((t=>{t.destroy();}));}getPlugins(){return this.renderingPlugins}getAnnotationConfig(){return this.config}}class ml{constructor(t){i(this,"hooks",{init:es.create(),beginFrame:es.create(),beforeRender:es.create(),render:es.create(),afterRender:es.create(),putImageData:es.create(),endFrame:es.create(),destroy:es.create(),pointerdown:es.create(),pointerup:es.create(),pointermove:es.create(),pointerout:es.create(),pointerover:es.create(),pointerCancel:es.create(),wheel:es.create()}),i(this,"isInited",!1),i(this,"zIndexCounter",0),i(this,"renderingContext",void 0),this.renderingContext=t;}init(){this.hooks.init.emit(),this.isInited=!0;}destroy(){this.isInited=!1,this.hooks.destroy.emit();}render(){const{root:t}=this.renderingContext;this.zIndexCounter=0,dr.recursiveUpdateHierarchy(t),this.isInited&&(this.renderDisplayObject(t),this.renderingContext.dirty&&(this.hooks.endFrame.emit(),this.renderingContext.dirty=!1),this.renderingContext.renderCondition.clear());}renderDisplayObject(t){if(!t.isVisible)return;const{sortable:e}=t;if(e.renderOrder=this.zIndexCounter,this.zIndexCounter+=1,this.renderingContext.dirty||(this.renderingContext.dirty=!0,this.hooks.beginFrame.emit()),t.imageData)return void this.hooks.putImageData.emit(t);this.hooks.beforeRender.emit(t),this.hooks.render.emit(t),this.hooks.afterRender.emit(t);let i=!1;e.dirty&&(e.sorted=t.childNodes.slice().sort(yl),e.dirty=!1,i=!0);let n=e.sorted||t.childNodes;t.isTab?(n=t.visibleChildren,n.sort(((t,e)=>t.index-e.index)),n.length>1&&n.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),n.forEach((t=>{this.renderDisplayObject(t);}))):(n.sort(((t,e)=>t.index-e.index)),n.length>1&&n.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),n.forEach((t=>{this.renderDisplayObject(t);}))),n.sort(((t,e)=>t.index-e.index)),i&&t.recursiveCall((t=>{const e=new Qo("renderOrderChanged",{renderOrder:t.sortable.renderOrder});t.dispatchEvent(e);}));}dirty(){this.renderingContext.renderCondition.add(0);}}function yl(t,e){const i=Number(t.style.zIndex),n=Number(e.style.zIndex);if(i===n&&t.parentNode){const{childNodes:i=[]}=t.parentNode;return i.indexOf(t)-i.indexOf(e)}return i-n}class xl extends Ko{constructor(t){super(),i(this,"document",void 0),i(this,"customElements",void 0),i(this,"devicePixelRatio",void 0),i(this,"eventService",void 0),i(this,"renderingService",void 0),i(this,"renderingContext",void 0),i(this,"canvasConfig",void 0),i(this,"renderer",void 0),i(this,"supportTouchEvent",void 0),i(this,"supportPointerEvent",void 0),i(this,"limit1px",!1),i(this,"contextService",void 0);const{renderer:e,dpr:n,width:s,height:o,canvas:r,supportPointerEvent:a,supportTouchEvent:l}=t;this.supportPointerEvent=null!=a?a:!!globalThis.PointerEvent,this.supportTouchEvent=null!=l?l:"touchstart"in window;let h=s,c=o,d=n;r&&(d=n||window.devicePixelRatio||1,h=s||r.width/d,c=o||r.height/d),this.canvasConfig={...t,width:h,height:c,dpr:d},this.canvasConfig=t,this.renderer=e,this.document=new sl,this.document.defaultView=this,this.initRenderingContext(),this.renderingService=new ml(this.renderingContext),this.initRenderer(e);}initRenderingContext(){this.renderingContext={root:this.document.documentElement,force:!1,dirty:!1,renderCondition:new Set},this.document.documentElement.addEventListener("child-inserted",(t=>{this.mountChildren(t.detail.child);})),this.document.documentElement.addEventListener("child-removed",(t=>{this.unmountChildren(t.detail.child);}));}initRenderer(t){this.renderingService.init(),t.initPlugins(this),this.contextService.init();t.getAnnotationConfig().autoRendering&&this.render(),this.document.documentElement.recursiveCall((t=>{const{renderable:e}=t;e&&(e.boundsDirty=!0,e.renderBoundsDirty=!0);})),this.mountChildren(this.document.documentElement);}render(){const t=new Qo("beforeRender",{});this.dispatchEvent(t),this.contextService.clearCanvas(),this.renderingService.render();}setDPR(t){this.canvasConfig.dpr=t,this.contextService.setDPR(t);}resize(t,e){this.canvasConfig.width=t,this.canvasConfig.height=e,this.contextService.resize(t,e);}getContextService(){return this.contextService}getEventService(){return this.eventService}appendChild(t,e){return this.document.documentElement.appendChild(t,e)}insertBefore(t,e){return this.document.documentElement.insertBefore(t,e)}removeChild(t){return this.document.documentElement.removeChild(t)}getBoundingClientRect(){return this.contextService.getBoundingClientRect()}mountChildren(t){t.recursiveCall((t=>{if(!t.isConnected){t.isConnected=!0,t.ownerDocument=this.document;const e=new Qo("DOMNodeInsertedIntoDocument",{});t.dispatchEvent(e);}}));}unmountChildren(t){const e=[];t.recursiveCall((t=>{t.isConnected&&e.push(t);})),e.reverse().forEach((t=>{t.isConnected=!1;const e=new Qo("DOMNodeRemovedFromDocument",{});t.dispatchEvent(e),t!==this.document.documentElement&&(t.ownerDocument=null);}));}}class wl{}class bl extends wl{constructor(t){super(),i(this,"close",!0),i(this,"shape",void 0),i(this,"ctx",void 0),i(this,"rCanvas",void 0),this.rCanvas=t;}render(t,e){const{background:i,borderColor:n,visibility:s}=t.parsedStyle;if("hidden"===s)return;const o=!Us(i)&&!i.isNone,r=!Us(n)&&!n.isNone;this.renderPath(t,e),o&&this.renderFill(t,e),this.renderStrokePath(t,e),r&&this.renderStroke(t,e);}renderPath(t,e){t.getPath(),e.beginPath(),t.steps.forEach((t=>{ra(e,t);})),this.close&&t.steps.length>2&&e.closePath();}renderStrokePath(t,e){$n(null==t?void 0:t.getStrokePath)&&(t.getStrokePath(),0!==t.strokePath.length&&(e.beginPath(),t.strokeSteps.forEach((t=>{ra(e,t);})),this.close&&t.strokeSteps.length>2&&e.closePath()));}renderFill(t,e){const{parsedStyle:i}=t,{background:n,opacity:s,fillOpacity:o,renderBlendMode:r}=i;if(e.save(),e.globalAlpha=s*o,"normal"!==r&&(e.globalCompositeOperation=r),Array.isArray(n)){this.setShapeGradientOrigin(t,e);for(let i=0;i<n.length;i++)0===i&&this.setShadow(t,e),e.fillStyle=this.getColor(t,n[i],e),e.fill();}else this.setShadow(t,e),e.fillStyle=n.formatted,e.fill();e.restore();}renderStroke(t,e){const{parsedStyle:i}=t,{borderWidth:n,borderColor:s,opacity:o,lineCap:r,lineJoin:a,miterLimit:l,lineDash:h,lineDashOffset:c,borderOpacity:d,renderBlendMode:u}=i;if(n&&n.value>0){if(e.save(),!Us(n)){const i=t.getScale();this.rCanvas.limit1px?e.lineWidth=Math.max(1/i.x,n.value):e.lineWidth=n.value;}"normal"!==u&&(e.globalCompositeOperation=u),e.miterLimit=l,e.globalAlpha=o*d,e.lineCap=r,e.lineJoin=a,e.setLineDash(Sl(h)?[0,0]:h),e.lineDashOffset=c.value,Array.isArray(s)?(this.setShapeGradientOrigin(t,e),s.forEach((i=>{e.strokeStyle=this.getColor(t,i,e),e.stroke();}))):(e.strokeStyle=s.formatted,e.stroke()),e.restore();}}setShadow(t,e){const{shadow:i,shadowOffsetX:n,shadowOffsetY:s,shadowBlur:o,shadowColor:r}=t.parsedStyle;(i||r)&&(e.shadowOffsetX=(null==n?void 0:n.value)||i[0],e.shadowOffsetY=(null==s?void 0:s.value)||i[1],e.shadowBlur=(null==o?void 0:o.value)||i[2],e.shadowColor=(null==r?void 0:r.formatted)||i[3]);}getColor(t,e,i){let n;if(1===e.type||2===e.type){const s=t.getBoundingRect(),{width:o,height:r}=s;n=function(t,e){const{type:i,steps:n,width:s,height:o,angle:r,cx:a,cy:l,size:h}=t;let c=null;if(1===i){const{x1:t,y1:i,x2:n,y2:a}=function(t,e,i){const n=i*Math.PI/180,s=0+t/2,o=0+e/2,r=Math.abs(t*Math.cos(n))+Math.abs(e*Math.sin(n));return {x1:s-Math.cos(n)*r/2,y1:o-Math.sin(n)*r/2,x2:s+Math.cos(n)*r/2,y2:o+Math.sin(n)*r/2}}(s,o,r.value);c=e.createLinearGradient(t,i,n,a);}else if(2===i){const{x:t,y:i,r:n}=function(t,e,i,n,s){let o=i.value,r=n.value;"%"===i.unit&&(o=i.value/100*t),"%"===n.unit&&(r=n.value/100*e);let a=Math.max(cs({x:0,y:0},{x:o,y:r}),cs({x:0,y:e},{x:o,y:r}),cs({x:t,y:e},{x:o,y:r}),cs({x:t,y:0},{x:o,y:r}));return s&&(Wn(s)?a=s.value:Gn(s)&&("closest-side"===s?a=Math.min(o,t-o,r,e-r):"farthest-side"===s?a=Math.max(o,t-o,r,e-r):"closest-corner"===s&&(a=Math.min(cs({x:0,y:0},{x:o,y:r}),cs({x:0,y:e},{x:o,y:r}),cs({x:t,y:e},{x:o,y:r}),cs({x:t,y:0},{x:o,y:r}))))),{x:o,y:r,r:a}}(s,o,a,l,h);c=e.createRadialGradient(t,i,0,t,i,n);}c&&n.forEach((t=>{let{offset:e,color:i}=t;var n;"%"===e.unit&&(null===(n=c)||void 0===n||n.addColorStop(e.value/100,i.toString()));}));return c}({type:e.type,...e.value,width:o,height:r},i);}return n}setShapeGradientOrigin(t,e){const{type:i}=t.config;switch(i){case"circle":case"arc":{const{r:i}=t.parsedStyle;e.translate(0-i.value,0-i.value);break}case"ellipse":{const{rx:i,ry:n}=t.parsedStyle;e.translate(0-i.value,0-n.value);break}default:e.translate(0,0);}}}function Sl(t){if(0===t.length)return !0;if(1===t.length)return 0===t[0];t.length%2!=0&&(t=t.concat(t));for(let e=1;e<t.length;e+=2)if(0!==t[e])return !1;return !0}class Cl extends bl{constructor(t){super(t),this.close=!1;}}class Pl extends bl{}class Tl extends bl{}class Al extends bl{render(t,e){const{width:i,height:n,img:s,opacity:o,visibility:r}=t.parsedStyle;if("hidden"!==r&&!Gn(s)&&s){if(e.save(),e.globalAlpha=o,s instanceof ImageData)e.putImageData(s,0,0);else {e.imageSmoothingEnabled=!0,e.imageSmoothingQuality&&(e.imageSmoothingQuality="high");try{e.drawImage(s,0,0,i.value,n.value);}catch(t){}}e.restore();}}}class kl extends bl{constructor(){super(...arguments),i(this,"close",!1);}render(t,e){const{visibility:i}=t.parsedStyle;"hidden"!==i&&(this.renderPath(t,e),this.renderStroke(t,e));}renderPath(t,e){t.getPath(),e.beginPath(),t.inkRenderSteps.forEach((t=>{t.forEach((t=>{ra(e,t);}));}));}}class El extends bl{}class Dl extends bl{render(t,e){const{background:i,borderColor:n,visibility:s}=t.parsedStyle;if("hidden"===s)return;const o=!Us(i)&&!i.isNone,r=!Us(n)&&!n.isNone;t.getPath();const a=t.steps.length;for(let i=0;i<a;i++){const n=t.steps[i];e.beginPath(),n.step.forEach((t=>{ra(e,t);})),n.close&&(e.closePath(),o&&this.renderFill(t,e)),r&&this.renderStroke(t,e);}}}class Rl extends bl{}class Il extends bl{constructor(){super(...arguments),i(this,"close",!0);}renderPath(t,e){t.getPath(),e.beginPath(),t.steps.forEach((t=>{ra(e,t),t.close&&e.closePath();}));}}class Ml extends bl{render(t,e){const{background:i,borderColor:n,visibility:s}=t.parsedStyle;if("hidden"===s)return;const o=!Us(i)&&!i.isNone,r=!Us(n)&&!n.isNone;t.getPath();const a=t.steps.length;for(let i=0;i<a;i++){const n=t.steps[i];e.beginPath(),n.step.forEach((t=>{ra(e,t);})),n.close&&(e.closePath(),o&&this.renderFill(t,e)),r&&this.renderStroke(t,e);}}}class Bl extends bl{render(t,e){const{width:i,height:n,roundedRadius:s,background:o,borderWidth:r,visibility:a}=t.parsedStyle;if("hidden"!==a){for(let t=0;t<4;t++){e.beginPath();const t=s.value;if(0===t)e.rect(0,0,i.value,n.value);else {const{PI:s}=Math;e.arc(t,t,t,s,3*s/2),e.arc(i.value-t,t,t,3*s/2,2*s),e.arc(i.value-t,n.value-t,t,0,s/2),e.arc(t,n.value-t,t,s/2,s);}}e.closePath(),o&&this.renderFill(t,e),r.value>0&&this.renderStroke(t,e);}}}class Ul extends bl{render(t,e){t&&"hidden"!==t.parsedStyle.visibility&&(this.renderBox(t,e),e.save(),t.renderClipStep&&(e.beginPath(),t.renderClipStep.forEach((t=>{ra(e,t);})),e.closePath(),e.clip()),this.renderText(t,e),e.restore());}renderBox(t,e){const{background:i,borderColor:n}=t.parsedStyle,s="textBox"===t.textType&&!Us(i)&&!i.isNone,o="textBox"===t.textType&&!Us(n)&&!n.isNone;this.renderPath(t,e),s&&this.renderFill(t,e),o&&this.renderStroke(t,e);}renderText(t,e){const{parsedStyle:i,lines:n}=t,{opacity:s,y:o,x:r}=i;e.globalAlpha=s,n.forEach((i=>{const n=i.height/30,s=t.getTextAlignOffset(i);i.words.forEach((t=>{const{color:a,fontFamily:l,fontSize:h,fontStyle:c,fontWeight:d,lineThrough:u,underline:p}=t.style;e.fillStyle=a;const g=""===l.trim()?"sans-serif":l,f=l.includes(" ")?`'${g}'`:g;e.font=`${c} ${d} ${h.value}${h.unit} ${f}`;let v=t.x-r+s;if(function(t){return /[\u0600-\u06FF]/.test(t)}(t.text))e.fillText(t.text,v,i.y-o);else for(let n=0;n<t.text.length;n++){const s=t.text.charAt(n);e.fillText(s,v,i.y-o),v+=e.measureText(s).width;}p&&e.fillRect(t.x-r+s,i.y-o+n,t.widthWithoutLf,n),u&&e.fillRect(t.x-r+s,i.y-t.wordHeight/3-o,t.widthWithoutLf,h.value/30);}));}));}}class Ll extends bl{render(t,e){t&&"hidden"!==t.parsedStyle.visibility&&this.renderText(t,e);}renderText(t,e){const{parsedStyle:i}=t;t.setTextFont();const{text:n,font:s,opacity:o,color:r,y:a}=i;e.save(),e.globalAlpha=o,e.font=s,e.fillStyle=r.formatted,e.textBaseline="alphabetic",e.fillText(n,0,0),e.restore();}}class Ol{constructor(t){i(this,"canvasConfig",void 0),i(this,"container",void 0),i(this,"canvas",void 0),i(this,"dpr",void 0),i(this,"context",void 0),i(this,"shapeRenderers",{}),this.canvasConfig=t;}init(){const{container:t,canvas:e,dpr:i,willReadFrequently:n}=this.canvasConfig;if(e){this.canvas=e;const{parentElement:i}=e;t&&i!==t&&t.appendChild(e),this.container=i,this.canvasConfig.container=i;}else if(t&&(this.container=t,Gn(t)&&(this.container=document.getElementById(t)),this.container)){const t=document.createElement("canvas");this.container.appendChild(t),this.canvas=t;}this.context=this.canvas.getContext("2d",{willReadFrequently:n}),this.dpr=i||xs(),this.resize(this.canvasConfig.width,this.canvasConfig.height);}registerShapeRenderer(t,e){this.shapeRenderers[t]||(this.shapeRenderers[t]=e);}getShapeRenderer(t){return this.shapeRenderers[t]}destroy(){const{canvas:t,container:e}=this;e&&null!=t&&t.parentNode&&e.removeChild(t);}resize(t,e){const{canvas:i,dpr:n}=this;i&&(i.width=t*n,i.height=e*n,this.context.scale(n,n));}getDPR(){return this.dpr}setDPR(t){this.canvasConfig.dpr=t,this.dpr=t;}getContext(){return this.context}getDomElement(){return this.canvas}getCanvas(){return this.canvas}setCursor(t){var e;null!=this&&null!==(e=this.container)&&void 0!==e&&e.style&&(this.container.style.cursor=t);}getBoundingClientRect(){var t;return null===(t=this.canvas)||void 0===t?void 0:t.getBoundingClientRect()}clearCanvas(){this.canvas&&(this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.scale(this.dpr,this.dpr));}}class Wl{constructor(){i(this,"restoreStack",[]);}init(t){const{hooks:e}=t.renderingService;e.endFrame.on((()=>{const{contextService:e}=t,i=e.getContext();this.restoreStack.forEach((()=>{i.restore();})),this.restoreStack=[];})),e.render.on((e=>{this.renderDisplayObject(e,t);})),e.putImageData.on((e=>{if(e.imageData){const{x:i,y:n}=e.getPosition(),s=t.contextService.getContext(),o=t.contextService.getDPR();s.putImageData(e.imageData,Math.floor(i*o+.5),Math.floor(n*o+.5));}}));}renderDisplayObject(t,e){if(!t.isVisible)return;const{contextService:i}=e,n=i.getContext();let s=this.restoreStack[this.restoreStack.length-1];for(;s&&t.parentNode!==s;)n.restore(),this.restoreStack.pop(),s=this.restoreStack[this.restoreStack.length-1];n.save(),this.applyTransform(n,t);const{clipPath:o}=t.style;o&&(n.save(),this.applyTransform(n,o),n.restore(),n.clip()),this.useAnchor(n,t);const r=i.getShapeRenderer(t.shapeType);r&&(r.render(t,n),t.clippable&&n.clip()),this.restoreStack.push(t);}applyTransform(t,e){e.externalMatrices.length&&e.externalMatrices.slice().reverse().forEach((e=>{const{a:i,b:n,c:s,d:o,e:r,f:a}=e;t.transform(i,n,s,o,r,a);}));const i=e.getLocalTransform(),{a:n,b:s,c:o,d:r,e:a,f:l}=i;t.transform(n,s,o,r,a,l);}applyAttributes(t,e,i){}useAnchor(t,e){const{anchor:i}=e.parsedStyle||{};if(!i||0===i[0]&&0===i[1])return;const n=e.getGeometryBounds().getRect();t.translate(-(i&&i[0]||0)*n.width,-(i&&i[1]||0)*n.height);}destroy(){}}i(Wl,"moduleName",void 0);class Nl{init(t){const e=new Ol(t.canvasConfig);t.contextService=e;[{name:"arc",renderer:new Cl},{name:"circle",renderer:new Pl(t)},{name:"ellipse",renderer:new Tl(t)},{name:"line",renderer:new Ml(t)},{name:"image",renderer:new Al(t)},{name:"ink",renderer:new kl(t)},{name:"polygon",renderer:new El(t)},{name:"polyline",renderer:new Dl(t)},{name:"rect",renderer:new Rl(t)},{name:"stampText",renderer:new Ll(t)},{name:"stampPath",renderer:new Il(t)},{name:"roundedRect",renderer:new Bl(t)},{name:"freeText",renderer:new Ul(t)}].forEach((t=>{let{name:i,renderer:n}=t;e.registerShapeRenderer(i,n);}));}destroy(){}}class _l extends vl{constructor(t){super(t),this.use(new Nl),this.use(new Wl);}}function Fl(t,e,i){const n=e.x-t.x,s=e.y-t.y,o=i.x-t.x,r=n*(i.y-t.y)-s*o,a=as(t,e),l=as(t,i);let h=(a**2+l**2-as(e,i)**2)/(2*a*l);h<-1&&(h=-1),h>1&&(h=1);let c=180*Math.acos(h)/Math.PI;return c=Math.round(100*c)/100,r<0?-c:c}function Hl(t,e,i){const n=or.fromTwoPoint(e,t);return or.fromTwoPoint(e,i).angle(n)>Math.PI/2}function Vl(t,e){return (e=t.getWorldTransform().inverse().transformPoint(e)).x+=t.parsedStyle.x,e.y+=t.parsedStyle.y,e}function zl(t){if(!t)return !1;const{shapeType:e}=t;return "annotationRect"===e||"annotationFreeText"===e&&"textBox"===t.textType||"annotationStamp"===e&&"image"===t.renderType}function $l(t){return !!t&&("annotationPolyline"===t.shapeType||"annotationPolygon"===t.shapeType||"annotationLine"===t.shapeType)}function jl(t){return !!t&&("annotationFreeText"===t.shapeType||"annotationTextBox"===t.shapeType)}function Xl(t){return !!t&&("annotationUnderline"===t.shapeType||"annotationStrikeout"===t.shapeType||"annotationHighlight"===t.shapeType)}function Gl(t,e){e.controls||e.context.initControls(),e.context.renderControls();const i=e.controls.controlPoints.slice(0,4),n=[];for(let t=0;t<4;t++){const{x:e,y:s}=i[t].getPosition();n.push({x:e,y:s});}const{x:s,y:o}=t.getPosition(),{width:r,height:a}=t.parsedStyle,l=Math.abs(t.getScale().x),h=Math.abs(t.getScale().y);return function(t,e){const i={x1:Math.min(...e.map((t=>t.x))),y1:Math.min(...e.map((t=>t.y))),x2:Math.max(...e.map((t=>t.x))),y2:Math.max(...e.map((t=>t.y)))};if(!function(t,e){const i=t.x1,n=t.x2,s=t.y1,o=t.y2,r=e.x1,a=e.x2,l=e.y1,h=e.y2;return !(n<r||a<i||o<l||h<s)}(t,i))return !1;return function(t,e){const i=e,n=[];for(let t=0;t<i.length;t++){const e=(t+1)%i.length;n.push({p1:i[t],p2:i[e]});}for(const e of n){const n={x:e.p2.y-e.p1.y,y:e.p1.x-e.p2.x},s=Math.min(Yl(n,{x:t.x1,y:t.y1}),Yl(n,{x:t.x1,y:t.y2}),Yl(n,{x:t.x2,y:t.y1}),Yl(n,{x:t.x2,y:t.y2})),o=Math.max(Yl(n,{x:t.x1,y:t.y1}),Yl(n,{x:t.x1,y:t.y2}),Yl(n,{x:t.x2,y:t.y1}),Yl(n,{x:t.x2,y:t.y2})),r=Math.min(Yl(n,i[0]),Yl(n,i[1]),Yl(n,i[2]),Yl(n,i[3])),a=Math.max(Yl(n,i[0]),Yl(n,i[1]),Yl(n,i[2]),Yl(n,i[3]));if(o<r||a<s)return !1}return !0}(t,e)}({x1:s,y1:o,x2:s+r.value*l,y2:o+a.value*h},n)}function Yl(t,e){return t.x*e.x+t.y*e.y}function ql(t,e){const i=window.TouchEvent&&e instanceof TouchEvent?e.targetTouches[0]:e,n=t.getBoundingClientRect();return {offsetX:i.pageX-window.scrollX-n.left,offsetY:i.pageY-window.scrollY-n.top}}function Jl(t){let e,i;if(t.controls){const{width:n,height:s}=t.controls.getLength();e=n,i=s;}else {const{x:n,y:s}=t.getScale(),{width:o,height:r}=t.getBoundingRect();e=o*n,i=r*s;}return {width:e,height:i}}function Zl(t){return /^[\r\n]+$/.test(t)}function Ql(t,e,i){return t.slice(0,e)+t.slice(i+1)}function Kl(t,e){const{textContents:i}=t.style,n=[];return i.forEach((t=>{n.push({...t,...e});})),n}function th(t,e){const{textContents:i}=t.style,{textSelection:n}=t.textEditEventHandler;if(!n.length)return i;const[s,o]=n,r=s.freeContentIndex,a=o.freeContentIndex,l=i.slice(0,r),h=i.slice(r,a+1),c=i.slice(a+1),d=[];if(s.freeContentIndex===o.freeContentIndex){const{content:t}=h[0],i=t.slice(0,s.indexInFreeContent),n=t.slice(s.indexInFreeContent,o.indexInFreeContent+1),r=t.slice(o.indexInFreeContent+1);i&&d.push({...h[0],content:i}),n&&d.push({...h[0],...e,content:n}),r&&d.push({...h[0],content:r});}else for(let t=0;t<h.length;t++){const i=h[t];0===t?(0!==s.indexInFreeContent&&d.push({...i,content:i.content.slice(0,s.indexInFreeContent)}),d.push({...i,...e,content:i.content.slice(s.indexInFreeContent)})):t===h.length-1?(d.push({...i,...e,content:i.content.slice(0,o.indexInFreeContent+1)}),o.indexInFreeContent+1<i.content.length&&d.push({...i,content:i.content.slice(o.indexInFreeContent+1)})):d.push({...i,...e});}return [...l,...d,...c]}function eh(t){if(!t)return !1;let e=t,i="visible"===e.parsedStyle.visibility;for(;e;)e.parsedStyle.visibility&&"hidden"===e.parsedStyle.visibility&&(i=!1),e=e.parentNode;return i}var ih;!function(t){t.REJECTED="SBRejected",t.ACCEPTED="SHAccepted",t.INITIAL_HERE="SHInitialHere",t.SIGN_HERE="SHSignHere",t.WITNESS="SHWitness",t.APPROVED="SBApproved",t.NOT_APPROVED="SBNotApproved",t.DRAFT="SBDraft",t.FINAL="SBFinal",t.COMPLETED="SBCompleted",t.CONFIDENTIAL="SBConfidential",t.VOID="SBVoid";}(ih||(ih={}));const nh={border:"1px solid #59626A",background:"transparent",ctrlBorderRadius:"6px",ctrlWidth:"12px",ctrlHeight:"12px",ctrlBorder:"1px solid #59626A",ctrlBackground:"white"},sh={content:"Insert text here...",fontSize:32,color:"red",lineThrough:!1,underline:!1,fontFamily:"Times New Roman",fontStyle:"normal",fontWeight:"normal"},oh={opacity:1,background:"",borderColor:"red",borderWidth:4,lineDash:[0,0],lineEnding:["None","None"],stampIcon:ih.DRAFT,imageData:null,textAlign:"left",textContent:{...sh}},rh={enableControl:!0,useDefaultControls:!0,enableEdit:!0,enableMove:!0,enableRotate:!0},ah={showOnTopWhenSelected:!1,enableContinuousDrawing:!1,enableDeleteWithKeyboard:!0,enableMoveWithKeyboard:!0,enableMultipleSelectWidthCtrl:!0,inkCreateDelay:3e3,controlsStyle:nh,defaultStyleConfig:{},eraserStyle:{background:"rgba(0,0,0)",borderColor:"rgba(0,0,0)",opacity:.3,borderWidth:8},selectionStyle:{background:"transparent",borderWidth:2,borderColor:"#59626A",lineDash:[5,5]}};class lh{constructor(t){i(this,"shape",void 0),i(this,"startTime",void 0),i(this,"startPoint",void 0),i(this,"lastPoint",void 0),i(this,"limitPosition",void 0),i(this,"limitAngle",void 0),i(this,"unLimitPosition",void 0),i(this,"unLimitScale",void 0),i(this,"unLimitStyle",void 0),i(this,"limitArea",void 0),this.shape=t;}setLimitArea(t){this.limitArea=t;}updateShapeByLimitArea(){const{shapeType:t}=this.shape,{left:e,right:i,top:n,bottom:s}=this.isOutOfLimitArea(1,1),o=e||i||n||s,r=zl(this.shape)||"annotationEllipse"===t;o?(r?this.shape.updateStyle(this.unLimitStyle||{}):this.shape.setLocalScale(this.unLimitScale||this.shape.getLocalScale()),this.shape.setLocalPosition(this.unLimitPosition||this.shape.getLocalPosition())):(r&&(this.unLimitStyle={width:this.shape.style.width,height:this.shape.style.height,rx:this.shape.style.rx,ry:this.shape.style.ry}),this.unLimitPosition=this.shape.getLocalPosition().clone(),this.unLimitScale=this.shape.getLocalScale().clone());}getShapeOriginPosition(){const{left:t,top:e,width:i,height:n}=this.shape.getBoundingRect(),s=new Ra({style:{x:t-this.shape.style.x+i/2,y:e-this.shape.style.y+n/2}});this.shape.appendChild(s);const{x:o,y:r}=s.getPosition();return s.destroy(),{x:o,y:r}}getShapeControlPointPosition(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"vertexes";const{left:e,top:i,width:n,height:s}=this.shape.getBoundingRect(),o=[];for(let r=0;r<4;r++){let a=e-this.shape.style.x,l=i-this.shape.style.y;if("vertexes"===t)switch(r){case 1:a+=n;break;case 2:a+=n,l+=s;break;case 3:l+=s;}else switch(r){case 1:a+=n,l+=s/2;break;case 2:a+=n/2,l+=s;break;case 3:l+=s/2;break;default:a+=n/2;}const h=new Ra({style:{x:a,y:l}});this.shape.appendChild(h);const{x:c,y:d}=h.getPosition();o.push({x:c,y:d}),h.destroy();}return o}isOutOfLimitArea(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!this.limitArea)return {left:!1,right:!1,top:!1,bottom:!1};const{left:n,top:s,width:o,height:r}=this.limitArea,a=i||this.getShapeControlPointPosition();let l=!1,h=!1,c=!1,d=!1;for(let i=0;i<4;i++){const{x:u,y:p}=a[i];l=u<n-t||l,h=u>n+o+t||h,c=p<s-e||c,d=p>s+r+e||d;}return {left:l,right:h,top:c,bottom:d}}getLimitPosition(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.limitArea)return null;const e=t||this.getShapeControlPointPosition(),{x:i,y:n}=e[0],{left:s,top:o,width:r,height:a}=this.limitArea,l=e[1].x-i,h=e[2].x-i,c=e[3].x-i,d=e[1].y-n,u=e[2].y-n,p=e[3].y-n;let g=s-Math.min(l,h,c),f=s+r-Math.max(l,h,c),v=o-Math.min(d,u,p),m=o+a-Math.max(d,u,p);if(l>=0&&h>=0&&c>=0?g=s:l<=0&&h<=0&&c<=0&&(f=s+r),d>=0&&u>=0&&p>=0?v=o:d<=0&&u<=0&&p<=0&&(m=o+a),(y=this.shape)&&("annotationEllipse"===y.shapeType||"annotationCircle"===y.shapeType)){const{x:t,y:e}=this.getShapeOriginPosition(),s=t-i,o=e-n;g+=s,f+=s,v+=o,m+=o;}var y;return {minPosX:g,maxPosX:f,minPosY:v,maxPosY:m}}getLimitRotateAngle(){if(!this.limitArea)return [];const t=function(t,e){const i=t,[n,s,o,r]=i,{left:a,top:l,width:h,height:c}=e,d=a+h,u=l+c,p=(n.x+s.x+o.x+r.x)/4,g=(n.y+s.y+o.y+r.y)/4,f=Math.sqrt((p-n.x)**2+(g-n.y)**2),v=p-f,m=p+f,y=g-f,x=g+f;if(v>a&&y>l&&m<d&&x<u)return [];const w=t=>{const e=f*f-(t-p)**2;return [{x:t,y:g-Math.sqrt(e)},{x:t,y:g+Math.sqrt(e)}]},b=t=>{const e=f*f-(t-g)**2;return [{x:p-Math.sqrt(e),y:t},{x:p+Math.sqrt(e),y:t}]},S=(e,i)=>{const n=[];return e.forEach((e=>{t.forEach((t=>{let s=Fl({x:p,y:g},t,e);0===s&&(s=p>t.x?g>t.y?-0:0:g>t.y?0:-0,"top"!==i&&"bottom"!==i||(s=-s)),n.push(s);}));})),n},C=[];if(v<a){const t=w(a);C.push(...S(t,"left"));}if(y<l){const t=b(l);C.push(...S(t,"top"));}if(m>d){const t=w(d);C.push(...S(t,"right"));}if(x>u){const t=b(u);C.push(...S(t,"bottom"));}return C}(this.getShapeControlPointPosition(),this.limitArea);if(0===t.length)return [];let e=0;if(t.forEach((t=>{0===t&&e++;})),e>=2)return [0,0];const{maxNegative:i,minPositive:n}=function(t){let e=-1/0,i=1/0;for(let n=0;n<t.length;n++)t[n]<0&&t[n]>e||Object.is(t[n],-0)?e=t[n]:(t[n]>0&&t[n]<i||Object.is(t[n],0))&&(i=t[n]);return e===-1/0&&(e=0),i===1/0&&(i=0),{maxNegative:e,minPositive:i}}(t);return [i,n]}moveByKeyboard(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const{shape:i}=this,{controlsFlags:n}=i.context;if(!n.enableMove)return !1;t.preventDefault();let s=0,o=0;const r=Math.max(1,Math.round(e*(As(t)?8:1)));switch(t.key){case"ArrowLeft":s=-r;break;case"ArrowRight":s=r;break;case"ArrowUp":o=-r;break;case"ArrowDown":o=r;}const a=i.getPosition();let l=a.x+s,h=a.y+o;const{left:c,right:d,top:u,bottom:p}=this.isOutOfLimitArea(1,1),g=c||d||u||p,f=this.getLimitPosition();if(f&&!g){const{minPosX:t,maxPosX:e,minPosY:i,maxPosY:n}=f;l<t&&(l=t),l>e&&(l=e),h<i&&(h=i),h>n&&(h=n);}return this.shape.setPosition({x:l,y:h}),$l(i)&&i.pointEventsHandler.updateLineControls(),!0}moveShape(t){const{shape:e,startPoint:i}=this,{lastWorldPosition:n,controlsFlags:s}=e.context;if(!s.enableMove)return;if(new Vr(t.x,t.y).distanceTo(i)<0)return;const o=t.x-i.x,r=t.y-i.y;let a=n.x+o,l=n.y+r;const{left:h,right:c,top:d,bottom:u}=this.isOutOfLimitArea(1,1),p=h||c||d||u;if(this.limitPosition&&!p){const{minPosX:t,maxPosX:e,minPosY:i,maxPosY:n}=this.limitPosition;a<t&&(a=t),a>e&&(a=e),l<i&&(l=i),l>n&&(l=n);}this.shape.setPosition({x:a,y:l});}moveVertex(t){const{shape:e}=this,{context:i,shapeType:n}=e,{hitControlPoint:s,lastLocalScale:o,lastControlsWidth:r,lastControlsHeight:a,keepAspectRatio:l,lastHitControlPoint:h,lastShareAxisYPoint:c,lastShareAxisXPoint:d,lastLocalTransform:u}=i,p=zr(h,d,t).distanceTo(d)||1;if(Hl(h,d,t))return;let g=p-r,f=p/r;const v=zr(h,c,t).distanceTo(c)||1;if(Hl(h,c,t))return;let m=v-a,y=v/a;l&&(f<=y?(y=f,m=y*a-a):(f=y,g=f*r-r));const{left:x,right:w,top:b,bottom:S}=this.isOutOfLimitArea(1,1),C=x||w||b||S,P="annotationEllipse"===n;if(zl(e))this.moveRectVertex(s,g,m);else if(P)this.moveEllipseVertex(s,g,m);else {s<2&&(m=-m),0!==s&&3!==s||(g=-g),e.setLocalTransform(u);const{x:t,y:i}=e.getScale();g/=Math.abs(t),m/=Math.abs(i),e.translateLocal(g/2,m/2),e.setLocalScale(f*o.x,y*o.y);}C||0===e.getAngle()||this.updateShapeByLimitArea();}moveEllipseVertex(t,e,i){const{shape:n}=this,{x:s,y:o}=n.getScale(),{lastShapeWidth:r,lastShapeHeight:a,lastLocalTransform:l}=this.shape.context;e/=Math.abs(s),i/=Math.abs(o),n.style.rx=Math.max(1,(r+e)/2),n.style.ry=Math.max(1,(a+i)/2),t<2&&(i=-i),0!==t&&3!==t||(e=-e),n.setLocalTransform(l),n.translateLocal(e/2,i/2);}moveRectVertex(t,e,i){const{shape:n}=this,{x:s,y:o}=n.getScale(),{lastShapeWidth:r,lastShapeHeight:a,lastWorldPosition:l,lastLocalTransform:h}=this.shape.context;if(e/=Math.abs(s),i/=Math.abs(o),n.style.width=Math.max(r+e,1),n.style.height=Math.max(a+i,1),2===t)n.setPosition(l);else switch(n.setLocalTransform(h),t){case 1:n.translateLocal(0,-i);break;case 3:n.translateLocal(-e,0);break;default:n.translateLocal(-e,-i);}}moveMidpoints(t){const{shape:e}=this,{context:i,shapeType:n}=e,{lastLocalScale:s,lastWorldTransform:o,lastHitControlPoint:r,lastShareAxisPoint:a,hitControlPoint:l,lastWorldPosition:h,lastControlsWidth:c,lastControlsHeight:d,lastHitControlPointCenter:u,lastParentWorldAngle:p}=i,g=l-4,f=zr(r,a,t).distanceTo(a);if(Hl(r,a,t))return;const v="annotationEllipse"===n,m=f/c*s.x,y=f/d*s.y,{left:x,right:w,top:b,bottom:S}=this.isOutOfLimitArea(1,1),C=x||w||b||S,P={x:t.x-(r.x-u.x),y:t.y-(r.y-u.y)};if(zl(e))this.moveRectMidPoint(g,P);else if(v)this.moveEllipseMidPoint(g,P);else {const t=o.inverse(),i=t.transformPoint(P),n=t.transformPoint(h),r={...s};0===g?(r.y=y,90===p?n.x=i.x:n.y=i.y):1===g?r.x=m:2===g?r.y=y:3===g&&(r.x=m,90===p?n.y=i.y:n.x=i.x),this.shape.setLocalScale(r);const a=o.transformPoint(n);e.setPosition(a);}C||0===e.getAngle()||this.updateShapeByLimitArea();}moveRectMidPoint(t,e){const{shape:i}=this,{lastShapeHeight:n,lastWorldPosition:s,lastShapeWidth:o}=i.context,r=i.getWorldTransform(),a=r.inverse().transformPoint(e),l=r.inverse().transformPoint(s),h=l;0===t?(i.style.height=n-(a.y-l.y),h.y=a.y):1===t?i.style.width=Math.max(1,a.x-l.x):2===t?i.style.height=Math.max(1,a.y-l.y):3===t&&(i.style.width=o-(a.x-l.x),h.x=a.x);const c=r.transformPoint(h);i.setPosition(c);}moveEllipseMidPoint(t,e){const{shape:i}=this,{lastShapeHeight:n,lastShapeWidth:s,lastWorldPosition:o}=i.context,r=i.getWorldTransform(),a=r.inverse().transformPoint(e),l=r.inverse().transformPoint(o),h=l;if(0===t){const t=(n/2-(a.y-l.y))/2;i.style.ry=t,h.y=a.y+t;}else if(1===t){const t=(s/2+(a.x-l.x))/2;i.style.rx=t,h.x=a.x-t;}else if(2===t){const t=(n/2+(a.y-l.y))/2;i.style.ry=t,h.y=a.y-t;}else if(3===t){const t=(s/2-(a.x-l.x))/2;i.style.rx=t,h.x=a.x+t;}const c=r.transformPoint(h);i.setPosition(c);}moveRotationPoint(t){const{startPoint:e,shape:i}=this,{lastOriginWorldPosition:n,lastLocalTransform:s}=i.context,o=Fl(n,e,t);this.shape.setLocalTransform(s),this.shape.rotateLocal(o);}isHit(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{shape:i}=this,{context:n,parsedStyle:s}=i;if("hidden"===s.visibility||!n.controlsFlags.enableControl)return -1;if(n.isGrouped)return n.unHitShape(),-1;let{controls:o}=i,r=!0;o||(r=!1,n.initControls(),n.renderControls(),o=i.controls);let a=o.checkHitArea(t.x,t.y);return $l(i)&&!i.context.controlsFlags.useDefaultControls&&(8===a?a=-1:a>0&&(a=9),-1!==i.pointEventsHandler.isHitPoint(t)&&(a=0)),Xl(i)&&!i.context.controlsFlags.useDefaultControls&&(8===a?a=-1:a>0&&(a=9),a=i.textAssistEventHandler.isHitPoint(t)),a<0?(e&&(n.unHitShape(),r||i.context.destroyControls()),-1):a}startHandler(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.isHit(t);if(-1===i&&!e)return;-1===i&&e&&(i=9);const{shape:n}=this,{context:s}=n;s.isStart=!0,this.lastPoint={...t},this.startPoint={...t},this.startTime=(new Date).getTime(),$l(n)&&(n.pointEventsHandler.enableEditMode(),n.pointEventsHandler.editStartHandler(t)),jl(n)&&n.textEditEventHandler.editStartHandler(t),Xl(n)&&n.textAssistEventHandler.editStartHandler(t);const o=this.getShapeControlPointPosition();if(this.limitPosition=this.getLimitPosition(o),s.controlsFlags.useDefaultControls){if(s.hitShape(),s.hitControlPoint=i,i<4){const{x:e,y:n}=o[i];s.lastHitControlPoint={...t},s.lastHitControlPointCenter={x:e,y:n},s.lastShareAxisYPoint={x:o[3-i].x+t.x-e,y:o[3-i].y+t.y-n},s.lastShareAxisXPoint={x:o[i%2?i-1:i+1].x+t.x-e,y:o[i%2?i-1:i+1].y+t.y-n};}else if(i<8){const e=this.getShapeControlPointPosition("mid"),{x:n,y:o}=e[i-4];s.lastHitControlPoint={...t},s.lastHitControlPointCenter={x:n,y:o},s.lastShareAxisPoint={x:e[(i-2)%4].x+t.x-n,y:e[(i-2)%4].y+t.y-o};}}else s.isHit=!0,s.hitControlPoint=9,s.lastWorldPosition=n.getPosition(),s.lastControlsWorldPosition=n.controls.getPosition();}moveHandler(t,e){const{shape:i}=this,{context:n,controls:s}=i,{isHit:o,isStart:r,hitControlPoint:a}=n;if(!o||!r||!s)return;this.lastPoint={...t};const l=$l(i);if(l&&-1!==i.pointEventsHandler.hitIndex)return void i.pointEventsHandler.editMoveHandler(t);if(jl(i)&&i.textEditEventHandler.editMode)return void i.textEditEventHandler.editMoveHandler(t);Xl(i)&&i.textAssistEventHandler.isEditMode?i.textAssistEventHandler.editMoveHandler(t):a<4?(n.keepAspectRatio=e,this.moveVertex(t)):a<8?this.moveMidpoints(t):a<9?this.moveRotationPoint(t):(this.moveShape(t),l&&i.pointEventsHandler.updateLineControls());}endHandler(t){const{shape:e,startPoint:i,lastPoint:n}=this,{context:s}=e,{isStart:o,isHit:r}=e.context;if(!o||!r)return;const a=(new Date).getTime()-this.startTime,l=n.x-i.x,h=n.y-i.y,c=a<=200&&(l**2+h**2)**.5<2,d=$l(e),u=jl(e),p=Xl(e);if(d&&e.pointEventsHandler.editEndHandler(),u&&e.textEditEventHandler.editEndHandler(),p&&e.textAssistEventHandler.editEndHandler(),!s.isActive&&c&&(s.isActive=!0),t){if(u&&e.textEditEventHandler.editMode)return void(s.hitControlPoint=-1);if(p&&e.textAssistEventHandler.isEditMode)return void(s.hitControlPoint=-1);const i=[];if(8===s.hitControlPoint&&this.shape.getAngle()!==(null==s?void 0:s.lastWorldAngle))i.push("rotated");else {const{lastControlsWorldPosition:t,lastControlsWidth:n,lastControlsHeight:o,lastWorldPosition:r}=s;e.context.renderControls();const{width:a,height:l}=e.controls.getLength(),h=e.controls.getPosition(),c=e.getPosition(),u=e instanceof ph?t:r,p=e instanceof ph?h:c;p.x.toFixed(1)===u.x.toFixed(1)&&p.y.toFixed(1)===u.y.toFixed(1)||i.push("moved");const g=d&&-1!==e.pointEventsHandler.hitIndex,f=!(!n||!o)&&(a.toFixed(3)!==n.toFixed(3)||l.toFixed(3)!==o.toFixed(3));if(!(e instanceof wh))if(f)i.push("resized");else if(g){const{hitIndex:t,hitPointPos:n}=e.pointEventsHandler,s=e.path[t];s.x.toFixed(2)===n.x.toFixed(2)&&s.y.toFixed(2)===n.y.toFixed(2)||i.push("resized");}}const n=[...new Set(i)];n.length&&t.emitModifyAnnotation(n,[e]);}s.isHit=!1,s.keepAspectRatio=!1;}}class hh extends ka{constructor(t,e){super({type:"annotationGroup",style:{visibility:"visible"}}),i(this,"shapeType","annotationControls"),i(this,"container",void 0),i(this,"borders",void 0),i(this,"rotationPoint",void 0),i(this,"controlPoints",void 0),i(this,"rotationBorder",void 0),i(this,"rotationPointOffset",30),i(this,"vertexes",[]),i(this,"midpoints",[]),this.container=t;for(const t in e)Ls(t,e)&&(this[t]=e[t]);this.updateControlPoints(this.vertexes),this.initBorders(),this.initControls();}get isVisible(){return "hidden"!==this.parsedStyle.visibility&&eh(null==this?void 0:this.container)}initBorders(){const{borderColor:t,borderWidth:e,lineDash:i,background:n}=this.container.context.parsedControlsStyle,{width:s}=this.container.getBoundingRect(),o=e/2;this.borders=new Na({style:{points:this.vertexes,borderWidth:e,background:n,borderColor:t,lineDash:i}}),this.borders.setLocalPosition(-o,-o),this.rotationBorder=new Na({style:{points:[this.midpoints[0],this.rotationPoint],borderWidth:e,borderColor:t,lineDash:i}});const r=Math.abs(this.midpoints[0].y-this.rotationPoint.y);this.rotationBorder.setLocalPosition(s/2-o,-r),this.appendChild(this.borders),this.appendChild(this.rotationBorder);}initControls(){const{vertexes:t,midpoints:e,rotationPoint:i}=this,{ctrlBorderColor:n,ctrlBorderWidth:s,ctrlLineDash:o,ctrlBackground:r,ctrlWidth:a,ctrlHeight:l,ctrlBorderRadius:h}=this.container.context.parsedControlsStyle,{left:c,top:d}=this.container.getBoundingRect(),u=[...t,...e,i],p={background:r,borderColor:n,borderWidth:s,lineDash:o,width:a,height:l,roundedRadius:h};u.forEach((t=>{const e=new ja({style:{x:t.x,y:t.y,...p}});e.setLocalPosition(t.x-mr(a).value/2-c,t.y-mr(l).value/2-d),this.controlPoints||(this.controlPoints=[]),this.controlPoints.push(e),this.appendChild(e);}));}calculateMidpoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const s=new Vr((t[i].x+t[(i+1)%n].x)/2,(t[i].y+t[(i+1)%n].y)/2);e.push(s);}return e}calculateRotationPoint(t){const e=t[0].distanceTo(t[2]),i=this.rotationPointOffset/e+1;return t[2].lerpTo(t[0],i)}update(t){const{midpoints:e,rotationPoint:i,container:n}=this,{ctrlWidth:s,ctrlHeight:o,borderWidth:r}=this.container.context.parsedControlsStyle,a=[...t,...e,i],{left:l,top:h,width:c,height:d}=n.getBoundingRect(),u=r/2;this.controlPoints.forEach(((t,e)=>{const{x:i,y:n}=a[e];t.updateStyle({x:i,y:n}),t.setLocalPosition(i-s/2-l,n-o/2-h);})),this.borders.updateStyle({points:t}),this.borders.setLocalPosition(c<0?c:-u,d<0?d:-u);const p=Math.min(e[0].x,i.x),g=Math.min(e[0].y,i.y);this.rotationBorder.updateStyle({points:[e[0],i]}),this.rotationBorder.setLocalPosition(p-l-u,g-h);}updateOrigin(){const t=this.controlPoints[4].parsedStyle.x-this.controlPoints[0].parsedStyle.x,e=this.controlPoints[7].parsedStyle.y-this.controlPoints[0].parsedStyle.y;this.setOrigin(t,e);}updateControlPoints(t){this.vertexes=t,this.midpoints=this.calculateMidpoints(this.vertexes),this.rotationPoint=this.calculateRotationPoint(this.midpoints);}getLength(){const t=this.midpoints[2].y-this.midpoints[0].y;return {width:this.midpoints[1].x-this.midpoints[3].x,height:t}}setVisible(t){this.style.visibility=t;}setBoxVisible(t){this.borders.style.visibility=t;}setRotationPointVisible(t){this.rotationBorder.style.visibility=t,this.controlPoints[8].style.visibility=t;}setControlPointVisible(t){this.controlPoints.forEach(((e,i)=>{i<8&&(e.style.visibility=t);}));}checkHitArea(t,e){const i=this.getWorldTransform().inverse().transformPoint({x:t,y:e}),{x:n,y:s}=this.controlPoints[0].parsedStyle,o={x:i.x+n,y:i.y+s},{ctrlWidth:r,ctrlHeight:a}=this.container.context.parsedControlsStyle;i.x+=n+r/2,i.y+=s+a/2;const l=jn()?10:0;let h=-1;for(let t=0;t<this.controlPoints.length;t++){const e=this.controlPoints[t];if("visible"===e.style.visibility&&e.isPointInPath({x:i.x,y:i.y},l)){h=t;break}}return h>-1?h:this.borders.isPointInPath(o)?9:-1}destroy(){this.parentNode&&(this.parentNode.removeChild(this),this.container.controls=null);}}class ch{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,"shape",void 0),i(this,"referencePoint",void 0),i(this,"controlsStyle",void 0),i(this,"controlsFlags",void 0),i(this,"parsedControlsStyle",void 0),i(this,"tempData",{}),i(this,"keepAspectRatio",!1),i(this,"isInGroup",!1),i(this,"isGrouped",!1),i(this,"isActive",!1),i(this,"isStart",!1),i(this,"isHit",!1),i(this,"hitControlPoint",-1),i(this,"lastHitControlPoint",void 0),i(this,"lastHitControlPointCenter",void 0),i(this,"lastLocalTransform",void 0),i(this,"lastWorldTransform",void 0),i(this,"lastWorldPosition",void 0),i(this,"lastLocalScale",void 0),i(this,"lastOriginWorldPosition",void 0),i(this,"lastWorldAngle",void 0),i(this,"lastParentWorldAngle",void 0),i(this,"lastControlsWorldPosition",void 0),i(this,"lastControlsWidth",void 0),i(this,"lastControlsHeight",void 0),i(this,"lastShareAxisPoint",void 0),i(this,"lastShareAxisXPoint",void 0),i(this,"lastShareAxisYPoint",void 0),i(this,"lastShapeWidth",void 0),i(this,"lastShapeHeight",void 0),this.shape=t,this.controlsStyle={...nh,...e},this.controlsFlags={...rh},this.parseControlsStyle();}initReferenceBox(){if(this.referencePoint)return void this.updateReferenceBox();const{left:t,top:e}=this.shape.getBoundingRect(),i=t-this.shape.style.x,n=e-this.shape.style.y,s=new Ra({style:{x:i,y:n,r:0}});this.shape.appendChild(s),this.referencePoint=s;}updateReferenceBox(){if(!this.referencePoint)return;const{left:t,top:e}=this.shape.getBoundingRect(),i=t-this.shape.style.x,n=e-this.shape.style.y;this.referencePoint.updateStyle({x:i,y:n});}getControlVertexes(){const{shape:t}=this,{left:e,top:i,width:n,height:s}=t.getBoundingRect();return [new Vr(e,i),new Vr(e+n,i),new Vr(e+n,i+s),new Vr(e,i+s)]}getScaledControlVertexes(){const{shape:t}=this,{x:e,y:i}=t.getScale(),{left:n,top:s,width:o,height:r}=t.getBoundingRect(),a=o*Math.abs(e)||1,l=r*Math.abs(i)||1;return [new Vr(n,s),new Vr(n+a,s),new Vr(n+a,s+l),new Vr(n,s+l)]}showControls(){this.initReferenceBox();const{shape:t,referencePoint:e}=this,{x:i,y:n}=e.getPosition(),s=t.getAngle(),o=i,r=n;t.controls.setAngle(s),t.controls.setPosition({x:o,y:r});}parseControlsStyle(){if(!this.controlsStyle)return;this.parsedControlsStyle={};const{background:t,border:e,ctrlWidth:i,ctrlHeight:n,ctrlBackground:s,ctrlBorderRadius:o,ctrlBorder:r}=this.controlsStyle,a=e||nh.border,{borderColor:l,borderStyle:h,borderWidth:c}=ws(a),d=mr(c).value,u=r||nh.ctrlBorder,{borderColor:p,borderStyle:g,borderWidth:f}=ws(u),v=mr(f).value,m=mr(i).value,y=yr(o),x="%"===y.unit?y.value/100*m:y.value||nh.ctrlBorderRadius;this.parsedControlsStyle={background:t||nh.background,ctrlBackground:s||nh.ctrlBackground,ctrlBorderRadius:x,borderColor:l,borderWidth:d,lineDash:"solid"===h?[0,0]:[2*d,d],ctrlWidth:m,ctrlHeight:mr(n).value,ctrlBorderColor:p,ctrlBorderWidth:v,ctrlLineDash:"solid"===g?[0,0]:[2*v,v]};}updateControlsFlags(t){const{enableEdit:e,enableRotate:i,enableControl:n,isVisible:s}=t;this.shape.controls&&(zn(e)&&this.shape.controls.setControlPointVisible(e?"visible":"hidden"),zn(i)&&this.shape.controls.setRotationPointVisible(i?"visible":"hidden"),zn(n)&&!n&&this.destroyControls()),zn(s)&&(this.shape.style.visibility=s?"visible":"hidden"),this.controlsFlags={...this.controlsFlags,...t};}hitShape(){var t;const{shape:e}=this,{shapeType:i,controls:n}=e;this.isHit=!0,this.lastWorldPosition=e.getPosition(),this.lastLocalTransform=e.getLocalTransform(),this.lastWorldTransform=e.getLocalTransform(),this.lastLocalScale=e.getLocalScale(),this.lastControlsWorldPosition=n.getPosition(),this.lastControlsWidth=n.getLength().width,this.lastControlsHeight=n.getLength().height;const s=e.getBoundingRect();this.lastParentWorldAngle=Math.round(Math.abs(null==e||null===(t=e.parentNode)||void 0===t?void 0:t.getAngle())),this.lastWorldAngle=e.getAngle(),this.lastOriginWorldPosition=e.getWorldTransform().transformPoint({x:s.left-e.style.x+s.width/2,y:s.top-e.style.y+s.height/2});"annotationEllipse"===i&&(this.lastShapeWidth=2*e.parsedStyle.rx.value,this.lastShapeHeight=2*e.parsedStyle.ry.value),zl(this.shape)&&(this.lastShapeWidth=e.parsedStyle.width.value,this.lastShapeHeight=e.parsedStyle.height.value);}unHitShape(){const{context:t}=this.shape;t.isStart=!1,t.isHit=!1,t.isActive=!1,t.hitControlPoint=-1,jl(this.shape)&&this.shape.textEditEventHandler.disableEditMode(),$l(this.shape)&&this.shape.pointEventsHandler.disableEditMode(),Xl(this.shape)&&this.shape.textAssistEventHandler.disableEditMode();}initControls(){const{shape:t}=this,e=this.getControlVertexes(),i=new hh(t,{vertexes:e});t.controls=i,t.getRootNode().appendChild(i),this.updateControlsFlags(this.controlsFlags);}updateControls(){var t,e,i,n;const{shape:s}=this,o=this.getScaledControlVertexes();JSON.stringify(o)!==JSON.stringify(null===(t=s.controls)||void 0===t?void 0:t.vertexes)&&(null===(e=s.controls)||void 0===e||e.updateControlPoints(o),null===(i=s.controls)||void 0===i||i.update(o),null===(n=s.controls)||void 0===n||n.updateOrigin());}renderControls(){const{shape:t,isStart:e,isActive:i,controlsFlags:n,isInGroup:s}=this,{useDefaultControls:o}=n,{controls:r}=t;if(!r)return;let a="hidden";o&&(e||i||s)&&(a="visible"),r&&r.setVisible(a),this.updateControls(),this.showControls();}destroyControls(){var t,e;null===(t=this.referencePoint)||void 0===t||t.destroy(),this.referencePoint=null,null===(e=this.shape.controls)||void 0===e||e.destroy(),this.shape.controls=null;}getTransform(){const{parentNode:t}=this.shape,e=t instanceof wh&&this.shape.context.isGrouped;e&&t.delete(this.shape,!1);const i={...this.shape.getLocalPosition()},n=this.shape.getLocalAngle(),s={...this.shape.getLocalScale()};return e&&t.add(this.shape),{angle:n,scale:s,position:i}}setTransform(t){if(t){const{scale:e,angle:i,position:n}=t;n&&this.shape.setLocalPosition(n),_n(i)||this.shape.setLocalAngle(i),_n(e)||this.shape.setLocalScale(e);}}getCommonStyleConfig(){const{lineCap:t,lineJoin:e,lineDash:i,background:n,fillOpacity:s,opacity:o,visibility:r,miterLimit:a,borderColor:l,borderWidth:h,borderOpacity:c}=this.shape.attributes;return {lineCap:t,lineJoin:e,lineDash:i,background:n,opacity:o,borderColor:l,borderWidth:h,miterLimit:a}}getRealTimeBoundingBox(){this.shape.boundsDirty=!0;const{left:t,top:e,width:i,height:n}=this.shape.getBoundingRect(),s=[],{useDefaultControls:o,enableRotate:r}=this.shape.context.controlsFlags,a=o&&r?5:4;for(let o=0;o<a;o++){let r=t-this.shape.style.x,a=e-this.shape.style.y;1!==o&&2!==o||(r+=i),2!==o&&3!==o||(a+=n),4===o&&(r+=i/2,a-=30/this.shape.getScale().y);const l=new Ra({style:{x:r,y:a,r:0}});this.shape.appendChild(l);const{x:h,y:c}=l.getPosition();s.push({x:h,y:c}),l.destroy();}return aa(s)}}class dh extends Da{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationArc",...t}),i(this,"shapeType","annotationArc"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}getAnnotationConfig(){const t=this.context.getTransform(),{position:e}=t,{r:i,startAngle:n,endAngle:s}=this.attributes;return {type:"annotationArc",style:{x:e.x,y:e.y,r:i,startAngle:n,endAngle:s,...this.context.getCommonStyleConfig()},transform:t}}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}}class uh extends Ra{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationCircle",...t}),i(this,"shapeType","annotationCircle"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{position:e}=t,{r:i}=this.attributes;return {type:"annotationCircle",style:{x:e.x,y:e.y,r:i,...this.context.getCommonStyleConfig()},transform:t}}}class ph extends Ia{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationEllipse",...t}),i(this,"shapeType","annotationEllipse"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{rx:e,ry:i}=this.parsedStyle,{position:n}=t;return {type:"annotationEllipse",style:{x:n.x-e.value,y:n.y-i.value,width:2*e.value,height:2*i.value,...this.context.getCommonStyleConfig()},transform:t}}}class gh extends Ma{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationImage",...t}),i(this,"shapeType","annotationImage"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const{x:t,y:e,img:i,opacity:n,visibility:s,width:o,height:r}=this.attributes;return {type:"annotationImage",style:{x:t,y:e,width:o,height:r,img:i,opacity:n,visibility:s},meteData:this.meteData,transform:this.context.getTransform()}}}class fh extends Ba{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationInk",...t}),i(this,"shapeType","annotationInk"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t),this.update();}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}setUseDouglasPeucker(t){t&&(this.boundsDirty=!0,this.pathDirty=!0);}getAnnotationConfig(){var t;let e=this.attributes.segments;const i=this.context.getTransform(),n=this.getBoundingRect(),{position:s}=i;(s.x!==n.left||s.y!==n.top)&&(e=[],this.attributes.segments.forEach((t=>{const i=[];t.forEach((t=>{i.push({x:t.x-n.left+s.x,y:t.y-n.top+s.y});})),e.push(i);})),this.context.isGrouped||(this.style.segments=e));return {type:"annotationInk",style:{renderBlendMode:null==this||null===(t=this.style)||void 0===t?void 0:t.renderBlendMode,segments:e,...this.context.getCommonStyleConfig()},transform:i}}}class vh extends Fa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationRect",...t}),i(this,"shapeType","annotationRect"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{width:e,height:i}=this.attributes,{position:n}=t;return {type:"annotationRect",id:this.id,style:{x:n.x,y:n.y,width:e,height:i,...this.context.getCommonStyleConfig()},transform:t}}getPath(){if(!this.pathDirty)return this.path;const{width:t,height:e,borderWidth:i}=this.parsedStyle,n=.5*((null==i?void 0:i.value)||0),s=n,o=n,r=t.value-2*n,a=e.value-2*n;return this.path=[{x:s,y:o},{x:s+r,y:o},{x:s+r,y:o+a},{x:s,y:o+a}],this.steps=oa(this.path),this.pathDirty=!1,this.path}getStrokePath(){return this.strokePath=[],[]}}class mh{constructor(t){i(this,"shape",void 0),i(this,"textCursor",void 0),i(this,"textCursorInitCache",void 0),i(this,"inputComposition",!1),i(this,"startChar",void 0),i(this,"startDirection",void 0),i(this,"startPoint",void 0),i(this,"textRects",[]),i(this,"virtualChar",void 0),i(this,"isStart",!1),i(this,"canvas",void 0),i(this,"textClipboard",[]),i(this,"startTextContent",void 0),i(this,"lineChars",void 0),i(this,"flatChars",void 0),i(this,"editMode",void 0),i(this,"textarea",void 0),i(this,"textSelection",[]),this.shape=t,this.calculateCharPosition();}getLineIndexByMoved(t){const{lines:e,lineHeightOffset:i}=this.shape;let n=0;for(let s=0;s<e.length;s++){const{y:o,height:r}=e[s],a=o-r*(1-i);t.y>a&&(n=s);}return n}getLineIndexByPosition(t){const{lines:e,limitWidth:i,lineHeightOffset:n}=this.shape,{width:s}=this.shape.bounds;for(let i=0;i<e.length;i++){const o=e[i],{x:r,y:a,height:l,widthWithoutLF:h}=o,c=i===e.length-1?1:1+n;if(new Fa({style:{x:r,y:a-l*(1-n),width:Math.max(s,h),height:l*c,borderWidth:1,background:"transparent"}}).isPointInPath(t))return i}return -1}getCharByPosition(t,e){if(-1===e)return null;const{lineChars:i}=this,{lineHeightOffset:n}=this.shape,s=i[e];for(let e=0;e<s.length;e++){const o=s[e],{x:r,y:a,charWidth:l,charHeight:h}=o,c=o.lineIndex===i.length-1?1:1+n;if(new Fa({style:{x:r,y:a-h*(1-n),width:l,height:h*c,borderWidth:1,background:"transparent"}}).isPointInPath(t))return o}return null}getCharAndDirection(t){const e=this.getLineIndexByPosition(t);let i,n=1;if(-1===e)return i=this.flatChars[this.flatChars.length-1],n=1,{char:i,direction:n};const s="textBox"===this.shape.textType;if(i=this.getCharByPosition(t,e),i){const{x:e,charWidth:s}=i;n=t.x<e+s/2?0:1;}else {const o=this.lineChars[e];i=o[o.length-1],n=1,s&&t.x<o[0].x&&(i=o[0],n=0);}return "\r"!==i.text&&"\n"!==i.text&&"\r\n"!==i.text||(n=0),0===n&&0!==i.indexInLine&&(i=this.lineChars[i.lineIndex][i.indexInLine-1],n=1),{char:i,direction:n}}createCursor(t,e,i,n){if(!this.textCursor){const s=document.createElement("div");return s.className="ddv-annotation-cursor",s.style.left=t-.5+"px",s.style.top=`${e}px`,s.style.transform=`rotate(${i}deg)`,s.style.width="1px",s.style.height=`${n}px`,this.canvas.parentNode.appendChild(s),void(this.textCursor=s)}this.textCursor.style.left=t-.5+"px",this.textCursor.style.top=`${e}px`,this.textCursor.style.height=`${n}px`,this.textCursor.style.transform=`rotate(${i}deg)`,this.textCursor.style.animation="none",this.textCursor.offsetWidth,this.textCursor.style.animation="";}showTextCursor(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const{lineHeightOffset:n}=this.shape,s=(t,e)=>{const{x:i,y:s,charWidth:o,charHeight:r,lineIndex:a}=t,l=e?i+o:i,h=s-r*(1-n),c=a>=this.lineChars.length-1?1:1+n;return new Fa({style:{x:l-this.shape.style.x,y:h-this.shape.style.y,borderWidth:"1px",height:r*c}})},o=t=>{this.shape.appendChild(t);const e=this.shape.getScale().y,i=t.getAngle();t.setAngle(0);const{x:n,y:s}=t.getPosition();t.destroy(),this.createCursor(n,s,i,t.parsedStyle.height.value*e);};if(!this.editMode)return void(this.textCursor&&this.hideTextCursor());const{flatChars:r,shape:a}=this;if(!r.length&&this.virtualChar){const{fontSize:t}=this.shape.freeTextContentStyle,e=mr(t).value;if(e!==this.virtualChar.charHeight){const{borderOffset:t,padding:i}=this.shape,{y:s}=this.shape.style;this.virtualChar.charHeight=e,this.virtualChar.y=s+t+i+e*(1-n);}return o(s(this.virtualChar,1)),void(this.textCursorInitCache={char:{totalIndex:0},isBack:1})}let l=r[t];if(_n(t)&&(l=r[0],e=0),!r[t])return;"justify"===a.style.textAlign&&"textBox"===a.textType&&" "===l.text&&e&&r[l.totalIndex+1]&&(l=r[l.totalIndex+1],e=0);const h=r[l.totalIndex+1];let c;Zl(l.text)&&e&&h&&(l=h,e=0),c=Zl(l.text)&&e&&!h?s(this.virtualChar,1):s(l,e),o(c),this.startChar=l,this.startDirection=e,this.textCursorInitCache={char:l,isBack:e},i&&this.shape.hooks.selectTextChars.emit({startChar:l,endChar:l,isBack:!!e,needUpdate:!1});}moveTextCursor(t){const{textSelection:e}=this;let i,n;if(2===e.length){const[s,o]=e;switch(t){case"up":case"left":i=s.totalIndex,n=0;break;default:i=o.totalIndex,n=1;}return this.hideTextSelection(),this.shape.hooks.reRenderText.emit(),void this.showTextCursor(i,n)}const s=this.flatChars,o=s.length,{startChar:r,startDirection:a}=this;if(r){if("left"===t){const t=a?r.totalIndex-1:r.totalIndex-2;i=t>=0?t:0,n=t>=0?1:0;}else if("right"===t){const t=a?r.totalIndex+1:r.totalIndex;i=t>o-1?o-1:t,n=1;}else {const{x:e,charWidth:o,lineIndex:l}=r;if(0===l&&"up"===t)i=0,n=0;else if(l===this.lineChars.length-1&&"down"===t)i=s.length-1,n=1;else {const s=a?e+o:e,r="up"===t?this.lineChars[l-1]:this.lineChars[l+1];i=r[0].totalIndex,n=0,r.forEach((t=>{s>t.x+o/2&&!Zl(t.text)&&(i=t.totalIndex,n=1);}));}}this.showTextCursor(i,n);}}hideTextCursor(){this.textCursor&&(this.textCursor.remove(),this.textCursor=null);}showTextSelection(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=[],{lines:s,parsedStyle:o,textType:r,lineHeightOffset:a}=this.shape;if(this.hideTextSelection(),this.textSelection=[t,e],!t||!e)return;const l=["right","justify"].includes(o.textAlign)&&"textBox"===r;if(t.y===e.y){const i=Zl(t.text),o=Zl(e.text);if(i&&o)return;const r=t.x===e.x?t.charWidth:o?e.x-t.x:e.x-t.x+e.charWidth;n.push({left:t.x,top:t.y,lineIndex:t.lineIndex,width:r,height:s[t.lineIndex].height});}else {const i=this.shape.getTextAlignOffset(s[t.lineIndex]),{x:o,height:r}=s[t.lineIndex],a=l?s[t.lineIndex].widthWithoutLF:s[t.lineIndex].width;if(n.push({left:t.x,top:t.y,lineIndex:t.lineIndex,width:o+a+i-t.x,height:r}),e.lineIndex-t.lineIndex>1)for(let i=t.lineIndex+1;i<e.lineIndex;i++){const{x:t,y:e,height:o}=s[i],r=l?s[i].widthWithoutLF:s[i].width,a=this.shape.getTextAlignOffset(s[i]);n.push({left:t+a,top:e,width:r,height:o,lineIndex:i});}const h=this.shape.getTextAlignOffset(s[e.lineIndex]),{x:c,y:d,height:u}=s[e.lineIndex],p=l&&Zl(e.text)?0:e.charWidth;n.push({left:c+h,top:d,width:e.x+p-c-h,height:u,lineIndex:e.lineIndex});}const{x:h,y:c}=this.shape.style;this.hideTextCursor(),n.forEach((t=>{const e=t.lineIndex===this.lineChars.length-1?1:1+a,i=new Fa({style:{x:t.left-h,y:t.top-c-t.height*(1-a),width:t.width,height:t.height*e,background:"rgba(0, 123, 255, 0.5)"}});this.shape.appendChild(i),this.textRects.push(i);})),this.shape.hooks.selectTextChars.emit({startChar:t,endChar:e,isBack:!0,needUpdate:i});}hideTextSelection(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.textRects.forEach((t=>{t.destroy();})),this.textSelection=[],this.textRects=[],t){const{char:t,isBack:e}=this.textCursorInitCache;this.showTextCursor(t.totalIndex,e);}}addText(t,e,i){if(!i||""===i)return;if(!t){const t={...this.shape.freeTextContentStyle,content:i};return this.shape.context.updateControlsFlags({useDefaultControls:!1}),this.shape.updateStyle({textContents:[t]}),this.showTextCursor(i.length-1,1),void this.shape.hooks.textContentUpdatedByChar.emit()}const n=Nn(this.shape.style.textContents),{freeContentIndex:s,indexInFreeContent:o}=t,r=n[s],{content:a}=r,l=yh(this.shape.freeTextContentStyle,r),h=()=>({...this.shape.freeTextContentStyle,content:i});if(e&&o===a.length-1)l?r.content+=i:n.splice(s+1,0,h());else if(e||o)if(l){const t=0===e?o:o+1;r.content=a.slice(0,t)+i+a.slice(t);}else {const t=[],i=a.slice(0,e?o+1:o),l=a.slice(e?o+1:o);i&&t.push({...r,content:i}),t.push(h()),l&&t.push({...r,content:l}),n.splice(s,1,...t);}else if(s){const t=n[s-1];yh(this.shape.freeTextContentStyle,t)?n[s-1].content+=i:n.splice(s,0,h());}else l?r.content=i+r.content:n.unshift(h());this.shape.updateStyle({textContents:[...n]}),this.shape.hooks.textContentUpdatedByChar.emit();const{char:c,isBack:d}=this.textCursorInitCache;d?this.showTextCursor(c.totalIndex+i.length,1):this.showTextCursor(c.totalIndex+i.length-1,1);}deleteText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=Nn(this.shape.style.textContents);if(!i.length)return;let n=0;if(2===this.textSelection.length){const[t,e]=this.textSelection;if(t.freeContentIndex===e.freeContentIndex){const n=i[t.freeContentIndex];n.content=Ql(n.content,t.indexInFreeContent,e.indexInFreeContent);}else {const n=i[t.freeContentIndex],s=i[e.freeContentIndex];n.content=n.content.substring(0,t.indexInFreeContent),s.content=s.content.substring(e.indexInFreeContent+1);for(let n=t.freeContentIndex+1;n<e.freeContentIndex;n++)i[n].content="";}n=t.totalIndex-1;}else {const{startChar:t,startDirection:o}=this;if(!t)return;let r=o?t:this.flatChars[t.totalIndex-1];if(e){var s;const t=_n(null===(s=r)||void 0===s?void 0:s.totalIndex)?0:r.totalIndex+1;r=this.flatChars[t];}if(!r)return;const{freeContentIndex:a,indexInFreeContent:l}=r,h=i[a];if(!h.color)return;h.content=Ql(h.content,l,l),n=r.totalIndex-1;}this.hideTextSelection(),this.shape.updateStyle({textContents:[...i]}),t&&this.shape.hooks.textContentUpdatedByChar.emit(),-1===n?this.showTextCursor(0,0,!1):this.showTextCursor(n,1,!1),this.shape.hooks.reRenderText.emit();}copyText(){if(!this.textSelection.length)return;this.textClipboard=[];const{textContents:t}=this.shape.style,[e,i]=this.textSelection,n=[],s=e.freeContentIndex,o=i.freeContentIndex;if(s===o){const o=t[s],r=o.content.slice(e.indexInFreeContent,i.indexInFreeContent+1);n.push({...o,content:r});}else for(let r=s;r<=o;r++){const a={...t[r]},l=a.content;r===s?a.content=l.slice(e.indexInFreeContent):r===o&&(a.content=l.slice(0,i.indexInFreeContent+1)),n.push({...a});}this.textClipboard=[...n],function(t){let e="";t.forEach((t=>{e+=t.content;}));try{navigator.clipboard.writeText(e);}catch(t){}}(n);}pasteText(){this.textSelection.length&&this.deleteText(!1);const{isBack:t,char:e}=this.textCursorInitCache,{textContents:i}=this.shape.style,n=t?e:this.flatChars[e.totalIndex-1];let s=0,o=(null==n?void 0:n.totalIndex)||-1;if(this.textClipboard.forEach((t=>{s+=t.content.length;})),n)if(this.flatChars.length){const t=i[e.freeContentIndex];if(t.content.length===n.indexInFreeContent+1)i.splice(e.freeContentIndex+1,0,...Nn(this.textClipboard)),this.shape.updateStyle({textContents:[...i]});else {const{content:s}=t,{indexInFreeContent:o}=n,r=[{...t,content:s.slice(0,o+1)},...Nn(this.textClipboard),{...t,content:s.slice(o+1)}];i.splice(e.freeContentIndex,1,...r),this.shape.updateStyle({textContents:[...i]});}}else this.shape.updateStyle({textContents:Nn(this.textClipboard)}),o=-1;else i.unshift(...Nn(this.textClipboard)),this.shape.updateStyle({textContents:i});this.showTextCursor(o+s,1),this.shape.hooks.textContentUpdatedByChar.emit();}selectAllText(){if(!this.flatChars.length)return;const t=this.flatChars[0],e=this.flatChars[this.flatChars.length-1];this.showTextSelection(t,e),this.shape.hooks.reRenderText.emit();}updateTextSelection(){if(!this.textSelection.length)return;const[t,e]=this.textSelection,i=this.flatChars[t.totalIndex],n=this.flatChars[e.totalIndex];this.showTextSelection(i,n,!0),this.shape.hooks.reRenderText.emit();}calculateCharPosition(){const{borderOffset:t,padding:e,lineHeightOffset:i,lines:n}=this.shape,s=[];let o=0,r=0,a=0,l=0;n.forEach(((t,e)=>{const i=t.height,n=[],h=this.shape.getTextAlignOffset(t),c=(t,s,a,h,c)=>{const d={text:t,x:s,y:a,charWidth:h,charHeight:i,freeContentIndex:c,lineIndex:e,indexInLine:r,indexInFreeContent:o,totalIndex:l};n.push(d);};r=0,t.words.forEach((e=>{const{wordWidth:i,freeContentIndex:n,x:s,text:d}=e;if(n!==a&&(o=0,a=n),1===e.text.length)c(d,s+h,t.y,i,n),l+=1,r+=1,o+=1;else {let i=e.x+h;for(let s=0;s<d.length;s++){const a=d.charAt(s),h=Ga(a,e.style);c(a,i,t.y,h,n),i+=h,l+=1,o+=1,r+=1;}e.text.length!==e.originText.length&&(o+=e.originText.length-e.text.length);}})),s.push(n);}));const h=this.shape.getTextAlignOffset();if(this.flatChars=s.flat(),this.lineChars=s,this.virtualChar=null,!n.length){const{x:n,y:s,textAlign:o}=this.shape.parsedStyle,{fontSize:r}=this.shape.freeTextContentStyle,a=mr(r).value,l="right"===o?n+e+h:n+t+e+h;return void(this.virtualChar={x:l,y:s+t+e+a*(1-i),charWidth:1,charHeight:a,lineIndex:0})}const c=this.flatChars[this.flatChars.length-1];Zl(c.text)&&(this.virtualChar={x:this.shape.lines[0].x+h,y:c.y+n[c.lineIndex].height*(1+i),charWidth:1,charHeight:c.charHeight,lineIndex:c.lineIndex+1});}updateCursor(){if(!this.textCursor||!this.textCursorInitCache)return;const{char:t,isBack:e}=this.textCursorInitCache;this.showTextCursor(t.totalIndex,e);}enableEditMode(t,e){"freeTextWriter"===this.shape.textType&&(this.shape.pathDirty=!0,this.shape.boundsDirty=!0,this.shape.calculateTextLines(),this.shape.hooks.reRenderText.emit()),this.calculateCharPosition(),this.editMode=!0,this.canvas=e;let i=!1;if("textBox"===this.shape.textType){const{totalTextHeight:t,textMaxWidth:e}=this.shape,{height:i,width:n}=this.shape.parsedStyle;(t!==i.value||e>n.value)&&(this.shape.boundsDirty=!0,this.shape.pathDirty=!0);}if(this.flatChars.length){const e=Vl(this.shape,t),i=this.getCharAndDirection(e),{char:n,direction:s}=i;this.startChar=n,this.startDirection=s,this.showTextCursor(n.totalIndex,s);}else this.showTextCursor(void 0,void 0),"freeTextWriter"===this.shape.textType&&(i=!0);this.shape.context.updateControlsFlags({useDefaultControls:i,enableMove:!1}),this.openTextarea(t),this.resetStartTextContent(),this.shape.hooks.enableTextEditMode.emit();}disableEditMode(){if(this.editMode){if(this.textClipboard=[],this.editMode=!1,this.hideTextCursor(),this.hideTextSelection(),this.shape.lastIsBack=null,this.shape.lastSelectedEndChar=null,this.shape.context.updateControlsFlags({useDefaultControls:!0,enableMove:!0}),this.textarea&&this.textarea.blur(),"textBox"===this.shape.textType){const{totalTextHeight:t,textMaxWidth:e,maxEditWidth:i}=this.shape,{height:n,width:s}=this.shape.parsedStyle;(t!==n.value||e>s.value||i>s.value)&&(this.shape.boundsDirty=!0,this.shape.pathDirty=!0,this.shape.updateOrigin(),this.shape.hooks.reRenderText.emit());}this.shape.maxEditWidth=0,this.shape.hooks.disableTextEditMode.emit(),this.emitTextContentUpdated();}}editStartHandler(t){if(!this.editMode)return;if(!this.flatChars.length)return void this.showTextCursor(void 0,void 0);const e=Vl(this.shape,t),i=this.getCharAndDirection(e);this.hideTextSelection();const{char:n,direction:s}=i;this.showTextCursor(n.totalIndex,s),this.isStart=!0,this.startChar=n,this.startDirection=s,this.startPoint=e,this.shape.hooks.reRenderText.emit();}editMoveHandler(t){if(!this.editMode||!this.isStart)return;const{lineChars:e}=this,i=Vl(this.shape,t),n=this.getLineIndexByMoved(i);let{startChar:s,startDirection:o}=this,r=null;const a=e[n],l=n===this.startChar.lineIndex?i.x>this.startPoint.x:i.y>this.startPoint.y,{lineIndex:h,indexInLine:c}=this.startChar;if(!this.startDirection&&!l){if(0===s.totalIndex)return void this.hideTextSelection(!0);const t=s.lineIndex===e.length-1;if(t&&i.y<this.startPoint.y)s=this.flatChars[s.totalIndex-1],o=1;else if(t)return void this.hideTextSelection(!0)}if(l&&o&&(s=e[h][c+1],o=0,!s))return void this.hideTextSelection(!0);if(l&&i.x<a[0].x+a[0].charWidth/2&&s.lineIndex!==n){const t=e[n-1];return r=t[t.length-1],void this.showTextSelection(s,r)}if(l)a.forEach(((t,e)=>{const{x:n,charWidth:s}=t;i.x>n+s/2&&(r=a[e]);}));else for(let t=a.length-1;t>=0;t--){const{x:e,charWidth:n}=a[t];e+n/2>i.x&&(r=a[t]);}if(!r)return void this.hideTextSelection(!0);const{lineIndex:d,indexInLine:u}=s,{lineIndex:p,indexInLine:g}=r;l&&d===p&&u===g+1||!l&&d===p&&u===g-1?this.hideTextSelection(!0):l?this.showTextSelection(s,r):this.showTextSelection(r,s);}editEndHandler(){this.isStart=!1;}editClickHandler(t,e){this.editMode&&(this.canvas=e,this.openTextarea(t));}openTextarea(t){if(this.editMode){if(!this.textarea){const t=document.createElement("textarea");t.className="ddv-annotation-textarea",this.canvas.parentNode.appendChild(t),this.textarea=t,t.addEventListener("input",(t=>{this.inputComposition||this.textareaInput(t);}),!1),t.addEventListener("compositionstart",(t=>this.textareaCompositionstart(t)),!1),t.addEventListener("compositionend",(t=>{this.inputComposition=!1,this.textareaInput(t);}),!1),t.addEventListener("keydown",(t=>this.textareaKeydown(t)),!1);}if(t){const{x:e,y:i}=t;this.textarea.style.left=`${e}px`,this.textarea.style.top=`${i}px`;}this.textarea.value="",this.textarea.focus();}}destroyTextarea(){this.textarea&&(this.textarea.remove(),this.textarea=null);}emitTextContentUpdated(){(function(t,e){let i="",n="";for(let e=0;e<t.length;e++)i+=t[e].content;for(let t=0;t<e.length;t++)n+=e[t].content;return i===n})(this.startTextContent,this.shape.style.textContents)||(this.startTextContent=Nn(this.shape.style.textContents),this.shape.hooks.textContentUpdated.emit());}resetStartTextContent(){this.startTextContent=Nn(this.shape.style.textContents);}textareaInput(t){const e=this.textarea.value;if(2===this.textSelection.length&&this.deleteText(!1),this.flatChars.length){const{char:t,isBack:i}=this.textCursorInitCache;this.addText(t,i,e);}else this.addText(void 0,void 0,e);this.textarea.value="";}textareaCompositionstart(t){this.inputComposition=!0;}textareaKeydown(t){if(this.inputComposition||"Backspace"!==t.key||8!==t.keyCode)if(this.inputComposition||"Delete"!==t.key)switch(Ps(t)&&("c"===t.key||"C"===t.key?this.copyText():"x"===t.key||"X"===t.key?(this.copyText(),this.textSelection.length&&this.deleteText()):"v"!==t.key&&"V"!==t.key||!this.textClipboard.length?"z"===t.key||"Z"===t.key?(t.preventDefault(),t.stopPropagation()):"a"!==t.key&&"A"!==t.key||this.selectAllText():(t.preventDefault(),this.pasteText())),t.key){case"ArrowLeft":this.moveTextCursor("left");break;case"ArrowRight":this.moveTextCursor("right");break;case"ArrowUp":this.moveTextCursor("up");break;case"ArrowDown":this.moveTextCursor("down");}else this.deleteText(!0,!0);else this.deleteText();}}function yh(t,e){return t.color===e.color&&t.fontFamily===e.fontFamily&&t.fontSize===e.fontSize&&t.fontStyle===e.fontStyle&&t.fontWeight===e.fontWeight&&t.lineThrough===e.lineThrough&&t.underline===e.underline}class xh extends Xa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"textBox",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:sh;super({type:"annotationFreeText",id:t.id,style:{freeTextType:e,...t.style}}),i(this,"lastSelectedEndChar",void 0),i(this,"lastIsBack",void 0),i(this,"shapeType","annotationFreeText"),i(this,"textEditEventHandler",void 0),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"freeTextContentStyle",void 0),i(this,"inputModeTimer",void 0),i(this,"maxEditWidth",0),i(this,"hooks",{reRenderText:is(),selectTextChars:is(),enableTextEditMode:is(),disableTextEditMode:is(),textContentUpdated:is(),textContentUpdatedByChar:is()}),this.freeTextContentStyle=n,this.init(t.transform,t.selectableStyle),"freeTextWriter"===this.textType&&this.context.updateControlsFlags({enableEdit:!1,enableRotate:!1}),this.hooks.selectTextChars.on((t=>{const e=t.endChar;if(this.isSameChar(e,this.lastSelectedEndChar)&&t.isBack===this.lastIsBack&&!t.needUpdate)return;let i=e.freeContentIndex;e.indexInFreeContent||!e.freeContentIndex||t.isBack||(i-=1);const n=this.style.textContents[i];this.lastSelectedEndChar=e,this.lastIsBack=t.isBack,this.freeTextContentStyle={...n,content:this.freeTextContentStyle.content};}));}get isEditMode(){var t;return null===(t=this.textEditEventHandler)||void 0===t?void 0:t.editMode}get hasSelectedChars(){var t;return (null===(t=this.textEditEventHandler)||void 0===t?void 0:t.textSelection.length)>0}init(t,e){this.context=new ch(this,e),this.textEditEventHandler=new mh(this),this.eventHandler=new lh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.textEditEventHandler.disableEditMode(),this.textEditEventHandler.destroyTextarea(),this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t="textBox"===this.textType?"annotationTextBox":"annotationFreeText",e=this.getPosition();this.updateOrigin(),this.setPosition({...e});const i=this.context.getTransform(),{position:n}=i,{width:s,height:o,textContents:r}=this.attributes,a={type:t,style:{x:n.x,y:n.y,textContents:Nn(r),textAlign:this.style.textAlign,...this.context.getCommonStyleConfig(),width:s},transform:i};return "textBox"===this.textType&&(a.style.height=o),a}calculateTotalHeight(){var t,e;const i=mr((null===(t=this.freeTextContentStyle)||void 0===t?void 0:t.fontSize)||16);if(null!==(e=this.lines)&&void 0!==e&&e.length)super.calculateTotalHeight();else if("freeTextWriter"===this.textType)this.totalTextHeight=i.value+2*this.borderOffset;else {const{height:t}=this.parsedStyle;this.totalTextHeight=t.value>i.value+2*this.borderOffset?t.value:i.value+2*this.borderOffset+2*this.padding;}}getBoundingRect(){var t;if(!this.boundsDirty)return this.bounds;const{x:e,y:i}=this.parsedStyle;if("freeTextWriter"===this.textType&&(null===(t=this.lines)||void 0===t||!t.length)){var n;const t=mr((null===(n=this.freeTextContentStyle)||void 0===n?void 0:n.fontSize)||16);return this.boundsDirty=!1,this.bounds={left:e,top:i,width:Ga("  ",{...this.freeTextContentStyle,fontSize:t}),height:t.value+2*this.padding},this.bounds}return super.getBoundingRect(),"textBox"===this.textType&&this.isEditMode&&(this.bounds.height=this.totalTextHeight,this.textMaxWidth>this.bounds.width&&(this.bounds.width=this.textMaxWidth+2*this.borderOffset+2*this.padding),this.maxEditWidth=Math.max(this.maxEditWidth,this.bounds.width),this.maxEditWidth>this.bounds.width&&(this.bounds.width=this.maxEditWidth)),this.bounds}updateFreeTextContentStyle(t){this.freeTextContentStyle=t,this.textEditEventHandler.updateCursor();const{flatChars:e}=this.textEditEventHandler;this.isEditMode&&!e.length&&(this.pathDirty=!0,this.boundsDirty=!0,this.calculateTotalHeight(),this.hooks.reRenderText.emit(),this.hooks.enableTextEditMode.emit());}focusTexture(){const t=jn();this.isEditMode&&this.textEditEventHandler.textarea&&(t||this.textEditEventHandler.textarea.focus());}updateCursor(){this.textEditEventHandler.updateCursor();}isSameChar(t,e){return !(!t||!e)&&(t.charHeight===e.charHeight&&t.charWidth===e.charWidth&&t.freeContentIndex===e.freeContentIndex&&t.indexInFreeContent===e.indexInFreeContent&&t.indexInLine===e.indexInLine&&t.text===e.text&&t.totalIndex===e.totalIndex)}}class wh extends Fa{constructor(t){super({id:t,type:"annotationGroup",style:{visibility:"hidden",background:"transparent",borderColor:"transparent"}}),i(this,"shapeType","annotationGroup"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"parent",void 0),i(this,"parentPosition",void 0),i(this,"shapes",[]),i(this,"clickedShape",null),i(this,"state",!1),i(this,"groupMode",0),this.context=new ch(this),this.eventHandler=new lh(this),this.eventHandler.isHit=this.isHit.bind(this),this.groupMode?this.context.updateControlsFlags({enableEdit:!1}):this.context.updateControlsFlags({useDefaultControls:!1});}isHit(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{context:i,parsedStyle:n}=this;let{controls:s}=this;if(!this.state||"hidden"===n.visibility||!i.controlsFlags.enableControl)return this.clickedShape=null,-1;s||(i.initControls(),i.renderControls(),s=this.controls);let o=-1;if(this.groupMode)o=s.checkHitArea(t.x,t.y);else for(let e=0;e<this.shapes.length;e++)if(this.shapes[e].controls||(this.shapes[e].context.initControls(),this.shapes[e].context.renderControls()),this.shapes[e].controls.checkHitArea(t.x,t.y)>=0){this.clickedShape=this.shapes[e],o=9;break}return o<0&&e?(this.clickedShape=null,i.unHitShape(),this.context.destroyControls(),-1):o}init(){this.style.visibility="visible",this.parent.appendChild(this),this.shapes.forEach((t=>{t instanceof xh&&t.isEditMode&&t.textEditEventHandler.disableEditMode(),this.appendChild(t),t.context.isGrouped=!0;})),this.update(),this.context.initControls();}add(t){if(!this.parent){const e=t.parentNode;this.parent=e,this.parentPosition=e.getPosition();}if("hidden"!==t.parsedStyle.visibility&&-1===this.shapes.indexOf(t)){if(t.context.isInGroup=!0,this.shapes.push(t),this.state){const e=[];this.shapes.forEach((t=>{e.push(t.getWorldTransform().clone());})),t instanceof xh&&t.isEditMode&&t.textEditEventHandler.disableEditMode(),t.context.isGrouped=!0,this.appendChild(t),this.groupMode||this.showAllControls(t),this.shapes.forEach(((t,i)=>{const n=this.getWorldTransform().inverse().multiply(e[i]);t.setLocalTransform(n);})),this.update();}this.shapes.length>=2&&!1===this.state&&(this.state=!0,this.init());}}update(){const t=[],e=[],i=[];let n=!0;for(let s=0;s<this.shapes.length;s++){const o=this.shapes[s];let{controls:r}=o;r||(o.context.initControls(),r=o.controls),o.context.renderControls(),this.groupMode&&o.context.unHitShape(),o.context.controlsFlags.enableMove||(n=!1);const a=r.controlPoints.slice(0,4);for(let i=0;i<4;i++){const{x:n,y:s}=a[i].getCenterPosition();t.push(n),e.push(s);}i.push(this.shapes[s].getWorldTransform().clone());}const s=Math.max(...t),o=Math.min(...t),r=Math.max(...e),a=Math.min(...e);this.updateStyle({x:0,y:0,width:s-o,height:r-a}),this.context.updateControlsFlags({enableMove:n}),this.setAngle(180===this.parent.getAngle()?179.99:0),this.setLocalScale(1,1);const{x:l,y:h}=this.getScale();this.scale(1/Math.abs(l),1/Math.abs(h)),this.setPosition({x:o,y:a}),this.updateOrigin(),this.context.updateControls(),this.shapes.forEach(((t,e)=>{const n=this.getWorldTransform().inverse().multiply(i[e]);t.setLocalTransform(n);}));}delete(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.parent)return;if(-1===this.shapes.indexOf(t))return;const i=t.getWorldTransform().clone();this.parent.appendChild(t);const n=this.parent.getWorldTransform().inverse().multiply(i);t.setLocalTransform(n),t.context.isInGroup=!1,t.context.isGrouped=!1,t.context.isActive=!1,t.context.destroyControls(),"freeTextWriter"!==(null==t?void 0:t.textType)&&(t.context.updateControlsFlags({enableRotate:!zn(t.context.tempData.enableRotate)||t.context.tempData.enableRotate}),delete t.context.tempData.enableRotate),$l(t)&&t.pointEventsHandler.disableEditMode(),this.shapes.splice(this.shapes.indexOf(t),1),e&&this.update(),0===this.shapes.length&&this.clear();}clear(){const{length:t}=this.shapes;for(let e=t-1;e>=0;e--)this.delete(this.shapes[e],!1);this.context.destroyControls(),this.reset();}reset(){this.parent&&this.parent.removeChild(this),this.updateStyle({x:0,y:0,width:0,height:0}),this.resetLocalTransform(),this.shapes=[],this.parent=null,this.state=!1,this.style.visibility="hidden";}destroy(){const{length:t}=this.shapes;for(let e=t-1;e>=0;e--)this.shapes[e].destroy();this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.shapes=[],this.state=!1,this.parent=null,this.style.visibility="hidden",this.updateStyle({x:0,y:0,width:0,height:0});}showAllControls(t){if(!this.state)return;if(this.groupMode)return;const e=t=>{$l(t)&&t.pointEventsHandler.enableEditMode(),t.controls||t.context.initControls(),t.context.controlsFlags.enableRotate&&(t.context.tempData.enableRotate=t.context.controlsFlags.enableRotate,t.context.updateControlsFlags({enableRotate:!1})),t.context.isActive=!0,t.context.renderControls();};t?e(t):this.shapes.forEach((t=>{e(t);}));}getAnnotationConfig(){return {type:"annotationGroup"}}}class bh extends Fa{constructor(t){super(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),i(this,"shapeType","annotationLineControls"),i(this,"container",void 0),this.container=t;}get isVisible(){return "hidden"!==this.parsedStyle.visibility&&eh(null==this?void 0:this.container)}}class Sh{constructor(t){i(this,"shape",void 0),i(this,"editMode",void 0),i(this,"hitIndex",-1),i(this,"hitPointPos",void 0),i(this,"startPoint",void 0),i(this,"controlsBox",void 0),i(this,"controlsPoints",[]),this.shape=t;}getLineShapePoints(){const{shape:t}=this,{shapeType:e}=t;if("annotationLine"===e){const{startPoint:e,endPoint:i}=t.style;return [e,i]}const{points:i}=this.shape.parsedStyle;return i.slice(0,i.length)}initLineControls(){const{shape:t}=this;t.updatePoints();const{x:e,y:i}=this.shape.getScale(),{ctrlBorderColor:n,ctrlBorderWidth:s,ctrlLineDash:o,borderColor:r,borderWidth:a,lineDash:l,ctrlBorderRadius:h,ctrlWidth:c,ctrlHeight:d,background:u,ctrlBackground:p}=t.context.parsedControlsStyle,g={background:p,borderColor:n,borderWidth:s,lineDash:o},f=this.shape.getBoundingRect(),v=this.getLineShapePoints();this.controlsBox=new bh(this.shape,{style:{width:f.width*e,height:f.height*i,borderColor:r,borderWidth:a,background:u,lineDash:l}}),v.forEach((n=>{const s=new ja({style:{width:c,height:d,roundedRadius:h,...g,visibility:t.context.controlsFlags.enableEdit?"visible":"hidden"}}),o=(n.x-f.left)*e-mr(c).value/2,r=(n.y-f.top)*i-mr(d).value/2;s.setLocalPosition(o,r),this.controlsPoints.push(s),this.controlsBox.appendChild(s);})),this.controlsBox.setAngle(this.shape.getAngle()),this.controlsBox.setPosition(this.shape.getPosition()),this.shape.getRootNode().appendChild(this.controlsBox);}isHitPoint(t){if(!this.editMode)return -1;if(this.shape.context.controlsFlags.enableEdit)for(let e=0;e<this.controlsPoints.length;e++){const i=Vl(this.controlsPoints[e],t);if(this.controlsPoints[e].isPointInPath(i))return e}return -1}updateLineControls(){if(!this.controlsBox||0===this.controlsPoints.length)return;if(!this.editMode)return;const{ctrlWidth:t,ctrlHeight:e}=this.shape.context.parsedControlsStyle,{x:i,y:n}=this.shape.getScale(),s=this.shape.getBoundingRect(),o=this.getLineShapePoints();this.controlsPoints.length!==o.length&&(this.destroyLineControls(),this.initLineControls()),o.forEach(((o,r)=>{const a=(o.x-s.left)*i-t/2,l=(o.y-s.top)*n-e/2;this.controlsPoints[r].setLocalPosition(a,l);})),this.controlsBox.updateStyle({width:s.width*i,height:s.height*n}),this.controlsBox.setAngle(this.shape.getAngle()),this.controlsBox.setPosition(this.shape.getPosition()),this.shape.controls&&(this.shape.context.lastControlsWidth=this.shape.controls.getLength().width,this.shape.context.lastControlsHeight=this.shape.controls.getLength().height);}destroyLineControls(){var t;null===(t=this.controlsBox)||void 0===t||t.destroy(),this.controlsPoints.forEach((t=>{t.destroy(),t=null;})),this.controlsBox=null,this.controlsPoints=[];}enableEditMode(){if(this.shape.path||this.shape.getPath(),this.shape.path.length>this.shape.pointerLimitCount)return;if(this.controlsPoints.length>0)return;const{shape:t}=this;this.editMode||this.initLineControls(),this.editMode=!0,t.context.isHit=!0,t.controls&&(t.context.lastControlsWidth=t.controls.getLength().width,t.context.lastControlsHeight=t.controls.getLength().height);}disableEditMode(){this.destroyLineControls(),this.editMode=!1;}editStartHandler(t){if(!this.editMode)return;this.hitIndex=-1;const e=this.isHitPoint(t);-1!==e&&(this.hitIndex=e,this.hitPointPos={...this.shape.path[this.hitIndex]}),this.startPoint=t,this.shape.context.lastLocalTransform=this.shape.getLocalTransform();}editMoveHandler(t){if(!this.editMode||-1===this.hitIndex)return;const{shape:e}=this,i="annotationLine"===e.shapeType,n=i?[...e.path]:[...e.parsedStyle.points],s=Vl(e,t);n[this.hitIndex]=s,i?e.updateStyle({startPoint:{x:n[0].x,y:n[0].y},endPoint:{x:n[1].x,y:n[1].y}}):e.style.points=n,this.updateLineControls();}editEndHandler(){this.editMode&&this.shape.updatePoints();}}class Ch extends Na{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationPolygon",...t}),i(this,"shapeType","annotationPolygon"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),i(this,"pointerLimitCount",200),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.pointEventsHandler=new Sh(this),this.eventHandler=new lh(this),this.context.setTransform(t),this.parsedStyle.points.length<this.pointerLimitCount&&this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),e=this.getBoundingRect(),{position:i}=t,n=i.x!==e.left||i.y!==e.top;let s=this.attributes.points;n&&(s=[],this.attributes.points.forEach((t=>{s.push({x:t.x-e.left+i.x,y:t.y-e.top+i.y});})));return {type:"annotationPolygon",style:{points:s,...this.context.getCommonStyleConfig()},transform:t}}}class Ph extends _a{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationPolyline",...t}),i(this,"shapeType","annotationPolyline"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),i(this,"pointerLimitCount",200),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.pointEventsHandler=new Sh(this),this.eventHandler=new lh(this),this.context.setTransform(t),this.parsedStyle.points.length<this.pointerLimitCount&&this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),e=this.getBoundingRect(),{position:i}=t,n=i.x!==e.left||i.y!==e.top;let s=this.attributes.points;n&&(s=[],this.attributes.points.forEach((t=>{s.push({x:t.x-e.left+i.x,y:t.y-e.top+i.y});})));return {type:"annotationPolyline",style:{points:s,lineEnding:this.attributes.lineEnding,...this.context.getCommonStyleConfig()},transform:t}}}class Th extends Va{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationLine",...t}),i(this,"shapeType","annotationLine"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new ch(this,e),this.pointEventsHandler=new Sh(this),this.eventHandler=new lh(this),this.context.setTransform(t),this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),{left:e,top:i}=this.getBoundingRect(),{startPoint:n,endPoint:s,lineEnding:o}=this.attributes,{position:r}=t,a=r.x!==e||r.y!==i;return {type:"annotationLine",style:{startPoint:a?{x:n.x-e+r.x,y:n.y-i+r.y}:n,endPoint:a?{x:s.x-e+r.x,y:s.y-i+r.y}:s,lineEnding:o,...this.context.getCommonStyleConfig()},transform:t}}}const Ah=[{type:"path",stampPoints:[{x:417.4818115234375,y:261.32421875,step:2},{x:408.92578125,y:267.67313639322913,step:1},{x:404.0755208333333,y:276.6470947265625,step:1},{x:403.69010416666663,y:277.0937093098958,step:1},{x:403.40885416666663,y:276.3788655598958,step:1},{x:401.96875,y:272.3411458333333,step:1},{x:401.8802083333333,y:270.8835042317708,step:1},{x:399.3177083333333,y:272.16080729166663,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:399.7317708333333,y:277.8567708333333,step:1},{x:403.5690511067708,y:284.59375,step:1},{x:403.7773030598958,y:284.56766764322913,step:1},{x:406.17447916666663,y:274.89322916666663,step:1},{x:422.41666666666663,y:265.8476155598958,step:1},{x:418.98832194010413,y:263.60477701822913,step:1},{x:417.4140625,y:261.35746256510413,step:1},{x:417.4818115234375,y:261.32421875,step:1}],borderWidth:0,borderColor:"rgba(0,0,0,1)",background:"linear-gradient(to right bottom, #a9d776, #40691b)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:417.4818115234375,y:261.32421875,step:2},{x:408.92578125,y:267.67313639322913,step:1},{x:404.0755208333333,y:276.6470947265625,step:1},{x:403.69010416666663,y:277.0937093098958,step:1},{x:403.40885416666663,y:276.3788655598958,step:1},{x:401.96875,y:272.3411458333333,step:1},{x:401.8802083333333,y:270.8835042317708,step:1},{x:399.3177083333333,y:272.16080729166663,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:399.7317708333333,y:277.8567708333333,step:1},{x:403.5690511067708,y:284.59375,step:1},{x:403.7773030598958,y:284.56766764322913,step:1},{x:406.17447916666663,y:274.89322916666663,step:1},{x:422.41666666666663,y:265.8476155598958,step:1},{x:418.98832194010413,y:263.60477701822913,step:1},{x:417.4140625,y:261.35746256510413,step:1},{x:417.4818115234375,y:261.32421875,step:1}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"round",miterLimit:4}],kh=[{type:"path",stampPoints:[{x:424.45703125,y:294.07291666666663,step:2},{x:424.45703125,y:298.47265625,step:1},{x:420.83984375,y:302.07291666666663,step:1},{x:416.4192708333333,y:302.07291666666663,step:1},{x:222.49481201171875,y:302.07291666666663,step:0},{x:218.07421875,y:302.07291666666663,step:1},{x:214.45703125,y:298.47265625,step:1},{x:214.45703125,y:294.07291666666663,step:1},{x:214.45703125,y:252.07291666666666,step:0},{x:214.45703125,y:247.67313639322916,step:1},{x:218.07421875,y:244.07291666666666,step:1},{x:222.49481201171875,y:244.07291666666666,step:1},{x:416.4192708333333,y:244.07291666666666,step:0},{x:420.83984375,y:244.07291666666666,step:1},{x:424.45703125,y:247.67313639322916,step:1},{x:424.45703125,y:252.07291666666666,step:1},{x:424.45703125,y:294.07291666666663,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:424.0677083333333,y:293.9374593098958,step:2},{x:424.0677083333333,y:298.3358968098958,step:1},{x:420.45048014322913,y:301.9374593098958,step:1},{x:416.02994791666663,y:301.9374593098958,step:1},{x:222.10614013671875,y:301.9374593098958,step:0},{x:217.685546875,y:301.9374593098958,step:1},{x:214.06837972005206,y:298.3358968098958,step:1},{x:214.06837972005206,y:293.9374593098958,step:1},{x:214.06837972005206,y:251.93684895833331,step:0},{x:214.06837972005206,y:247.53715006510416,step:1},{x:217.685546875,y:243.93684895833331,step:1},{x:222.10614013671875,y:243.93684895833331,step:1},{x:416.02994791666663,y:243.93684895833331,step:0},{x:420.45048014322913,y:243.93684895833331,step:1},{x:424.0677083333333,y:247.53715006510416,step:1},{x:424.0677083333333,y:251.93684895833331,step:1},{x:424.0677083333333,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(41,66,18,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:234.81705729166666,y:280.5859375,step:2},{x:231.83074951171875,y:287.9374593098958,step:0},{x:226.009765625,y:287.9374593098958,step:0},{x:238.44596354166666,y:259.6288655598958,step:0},{x:245.4388224283854,y:259.6288655598958,step:0},{x:248.38736979166666,y:287.9374593098958,step:0},{x:242.67903645833331,y:287.9374593098958,step:0},{x:242.150390625,y:280.5859375,step:0},{x:234.81705729166666,y:280.5859375,step:0},{x:241.9238077799479,y:275.9661458333333,step:2},{x:241.43166097005206,y:269.8769124348958,step:0},{x:241.318359375,y:268.3229573567708,step:1},{x:241.205078125,y:266.0553792317708,step:1},{x:241.0917765299479,y:264.33268229166663,step:1},{x:240.978515625,y:264.33268229166663,step:0},{x:240.33528645833331,y:266.0553792317708,step:1},{x:239.6171671549479,y:268.2389729817708,step:1},{x:238.93684895833331,y:269.8769124348958,step:1},{x:236.44270833333331,y:275.9661458333333,step:0},{x:241.9238077799479,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:255.87109375,y:260.1335042317708,step:2},{x:257.5345052083333,y:259.67057291666663,step:1},{x:260.06705729166663,y:259.41861979166663,step:1},{x:262.52410888671875,y:259.41861979166663,step:1},{x:264.83009847005206,y:259.41861979166663,step:1},{x:267.43815104166663,y:259.8391927083333,step:1},{x:269.2903645833333,y:261.30924479166663,step:1},{x:271.02931722005206,y:262.56901041666663,step:1},{x:272.0501302083333,y:264.58463541666663,step:1},{x:272.0501302083333,y:267.314453125,step:1},{x:272.0501302083333,y:270.884765625,step:1},{x:270.5755208333333,y:273.6145833333333,step:1},{x:268.61002604166663,y:275.2942708333333,step:1},{x:266.5305989583333,y:277.1015625,step:1},{x:263.544921875,y:277.94010416666663,step:1},{x:260.4446818033854,y:277.94010416666663,step:1},{x:259.5384318033854,y:277.94010416666663,step:1},{x:258.78190104166663,y:277.81510416666663,step:1},{x:258.21486409505206,y:277.7734375,step:1},{x:256.4759114583333,y:287.9374593098958,step:0},{x:251.146484375,y:287.9374593098958,step:0},{x:255.87109375,y:260.1335042317708,step:0},{x:259.0462239583333,y:272.8170979817708,step:2},{x:259.61328125,y:272.9427083333333,step:1},{x:260.2181193033854,y:273.0266927083333,step:1},{x:261.1634318033854,y:273.0266927083333,step:1},{x:264.4140625,y:273.0266927083333,step:1},{x:266.56901041666663,y:270.6751302083333,step:1},{x:266.56901041666663,y:267.861328125,step:1},{x:266.56901041666663,y:265.130859375,step:1},{x:264.7923177083333,y:264.24869791666663,step:1},{x:262.712890625,y:264.24869791666663,step:1},{x:261.6927083333333,y:264.24869791666663,step:1},{x:260.9368489583333,y:264.33268229166663,step:1},{x:260.48307291666663,y:264.4167073567708,step:1},{x:259.0462239583333,y:272.8170979817708,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:277.19010416666663,y:260.1335042317708,step:2},{x:278.85353597005206,y:259.67057291666663,step:1},{x:281.3860677083333,y:259.41861979166663,step:1},{x:283.84246826171875,y:259.41861979166663,step:1},{x:286.14845784505206,y:259.41861979166663,step:1},{x:288.75651041666663,y:259.8391927083333,step:1},{x:290.6087239583333,y:261.30924479166663,step:1},{x:292.34765625,y:262.56901041666663,step:1},{x:293.3685099283854,y:264.58463541666663,step:1},{x:293.3685099283854,y:267.314453125,step:1},{x:293.3685099283854,y:270.884765625,step:1},{x:291.8938802083333,y:273.6145833333333,step:1},{x:289.92836507161456,y:275.2942708333333,step:1},{x:287.84962972005206,y:277.1015625,step:1},{x:284.86328125,y:277.94010416666663,step:1},{x:281.763671875,y:277.94010416666663,step:1},{x:280.8567708333333,y:277.94010416666663,step:1},{x:280.10028076171875,y:277.81510416666663,step:1},{x:279.533203125,y:277.7734375,step:1},{x:277.794921875,y:287.9374593098958,step:0},{x:272.4648234049479,y:287.9374593098958,step:0},{x:277.19010416666663,y:260.1335042317708,step:0},{x:280.36525472005206,y:272.8170979817708,step:2},{x:280.93229166666663,y:272.9427083333333,step:1},{x:281.537109375,y:273.0266927083333,step:1},{x:282.482421875,y:273.0266927083333,step:1},{x:285.732421875,y:273.0266927083333,step:1},{x:287.88736979166663,y:270.6751302083333,step:1},{x:287.88736979166663,y:267.861328125,step:1},{x:287.88736979166663,y:265.130859375,step:1},{x:286.1106974283854,y:264.24869791666663,step:1},{x:284.03192138671875,y:264.24869791666663,step:1},{x:283.0110677083333,y:264.24869791666663,step:1},{x:282.2552286783854,y:264.33268229166663,step:1},{x:281.80145263671875,y:264.4167073567708,step:1},{x:280.36525472005206,y:272.8170979817708,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:298.583984375,y:260.1335042317708,step:2},{x:300.2845052083333,y:259.67057291666663,step:1},{x:302.8548380533854,y:259.41861979166663,step:1},{x:305.3880208333333,y:259.41861979166663,step:1},{x:307.80731201171875,y:259.41861979166663,step:1},{x:310.3020833333333,y:259.79752604166663,step:1},{x:312.078125,y:261.056640625,step:1},{x:313.7415364583333,y:262.1491292317708,step:1},{x:314.9134318033854,y:263.91276041666663,step:1},{x:314.9134318033854,y:266.5592854817708,step:1},{x:314.9134318033854,y:270.7591145833333,step:1},{x:312.41861979166663,y:273.4049072265625,step:1},{x:309.1302083333333,y:274.58072916666663,step:1},{x:309.1302083333333,y:274.70703125,step:0},{x:310.642578125,y:275.46354166666663,step:1},{x:311.322265625,y:277.3098958333333,step:1},{x:311.54949951171875,y:279.8723958333333,step:1},{x:311.88930257161456,y:283.06510416666663,step:1},{x:312.078125,y:286.76041666666663,step:1},{x:312.53190104166663,y:287.9374593098958,step:1},{x:306.93752034505206,y:287.9374593098958,step:0},{x:306.7109375,y:287.18094889322913,step:1},{x:306.4466145833333,y:284.74479166666663,step:1},{x:306.21940104166663,y:281.2591145833333,step:1},{x:305.955078125,y:277.81510416666663,step:1},{x:304.89650472005206,y:276.765625,step:1},{x:302.7415364583333,y:276.765625,step:1},{x:301.07877604166663,y:276.765625,step:0},{x:299.1888020833333,y:287.9374593098958,step:0},{x:293.82096354166663,y:287.9374593098958,step:0},{x:298.583984375,y:260.1335042317708,step:0},{x:301.9101359049479,y:272.22855631510413,step:2},{x:304.1399739583333,y:272.22855631510413,step:0},{x:307.08917236328125,y:272.22855631510413,step:1},{x:309.24346923828125,y:270.25455729166663,step:1},{x:309.24346923828125,y:267.48246256510413,step:1},{x:309.24346923828125,y:265.1731770833333,step:1},{x:307.5423380533854,y:264.16471354166663,step:1},{x:305.35026041666663,y:264.16471354166663,step:1},{x:304.330078125,y:264.16471354166663,step:1},{x:303.6868693033854,y:264.24869791666663,step:1},{x:303.2337239583333,y:264.3749593098958,step:1},{x:301.9101359049479,y:272.22855631510413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:327.236328125,y:288.3984375,step:2},{x:320.6210734049479,y:288.3984375,step:1},{x:316.91668701171875,y:283.19010416666663,step:1},{x:316.91668701171875,y:276.59635416666663,step:1},{x:316.91668701171875,y:271.47330729166663,step:1},{x:318.61783854166663,y:266.39127604166663,step:1},{x:321.603515625,y:263.19921875,step:1},{x:323.98502604166663,y:260.6790364583333,step:1},{x:327.236328125,y:259.16666666666663,step:1},{x:330.90236409505206,y:259.16666666666663,step:1},{x:337.63087972005206,y:259.16666666666663,step:1},{x:341.18424479166663,y:264.20703125,step:1},{x:341.18424479166663,y:270.9693603515625,step:1},{x:341.18424479166663,y:276.1354573567708,step:1},{x:339.55859375,y:281.17447916666663,step:1},{x:336.6477864583333,y:284.3255208333333,step:1},{x:334.2669270833333,y:286.8880615234375,step:1},{x:331.0540364583333,y:288.3984375,step:1},{x:327.2734375,y:288.3984375,step:1},{x:327.236328125,y:288.3984375,step:0},{x:328.02994791666663,y:283.35941569010413,step:2},{x:329.6555989583333,y:283.35941569010413,step:1},{x:331.12957763671875,y:282.6028645833333,step:1},{x:332.30143229166663,y:281.3021240234375,step:1},{x:334.3040364583333,y:279.0755208333333,step:1},{x:335.40104166666663,y:274.41276041666663,step:1},{x:335.40104166666663,y:271.13736979166663,step:1},{x:335.40104166666663,y:267.6087239583333,step:1},{x:334.2669270833333,y:264.20703125,step:1},{x:330.2597452799479,y:264.20703125,step:1},{x:328.55922444661456,y:264.20703125,step:1},{x:327.04689534505206,y:265.0045166015625,step:1},{x:325.8749796549479,y:266.34891764322913,step:1},{x:323.83400472005206,y:268.57486979166663,step:1},{x:322.69986979166663,y:272.9849853515625,step:1},{x:322.69986979166663,y:276.3880208333333,step:1},{x:322.69986979166663,y:280.3775634765625,step:1},{x:324.3255208333333,y:283.35941569010413,step:1},{x:327.99151611328125,y:283.35941569010413,step:1},{x:328.02994791666663,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:347.61002604166663,y:287.9374593098958,step:2},{x:344.435546875,y:259.6288655598958,step:0},{x:350.06705729166663,y:259.6288655598958,step:0},{x:351.201171875,y:273.1106770833333,step:0},{x:351.4661458333333,y:276.1354573567708,step:1},{x:351.6549886067708,y:278.8646240234375,step:1},{x:351.80594889322913,y:281.8046468098958,step:1},{x:351.88151041666663,y:281.8046468098958,step:0},{x:352.82682291666663,y:279.03385416666663,step:1},{x:354.03641764322913,y:276.0091552734375,step:1},{x:355.283203125,y:273.068359375,step:1},{x:360.9915771484375,y:259.6288655598958,step:0},{x:367.07743326822913,y:259.6288655598958,step:0},{x:353.9232177734375,y:287.9374593098958,step:0},{x:347.61002604166663,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:381.7805989583333,y:275.88285319010413,step:2},{x:372.74674479166663,y:275.88285319010413,step:0},{x:371.5755208333333,y:282.7708333333333,step:0},{x:381.7434895833333,y:282.7708333333333,step:0},{x:380.87369791666663,y:287.9374593098958,step:0},{x:365.224609375,y:287.9374593098958,step:0},{x:370.06315104166663,y:259.6288655598958,step:0},{x:385.1451416015625,y:259.6288655598958,step:0},{x:384.2376708984375,y:264.79496256510413,step:0},{x:374.6366780598958,y:264.79496256510413,step:0},{x:373.57877604166663,y:270.8014729817708,step:0},{x:382.68815104166663,y:270.8014729817708,step:0},{x:381.7805989583333,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:389.52994791666663,y:260.048828125,step:2},{x:391.7220052083333,y:259.6288655598958,step:1},{x:394.103515625,y:259.41861979166663,step:1},{x:396.5989990234375,y:259.41861979166663,step:1},{x:400.5677083333333,y:259.41861979166663,step:1},{x:403.705078125,y:260.42704264322913,step:1},{x:405.8593343098958,y:262.4849853515625,step:1},{x:407.93876139322913,y:264.33268229166663,step:1},{x:409.22391764322913,y:267.146484375,step:1},{x:409.22391764322913,y:271.3470052083333,step:1},{x:409.22391764322913,y:276.8073323567708,step:1},{x:407.1444905598958,y:281.5521240234375,step:1},{x:404.0071614583333,y:284.3671875,step:1},{x:401.05924479166663,y:287.01298014322913,step:1},{x:397.3170166015625,y:288.1458333333333,step:1},{x:391.7981770833333,y:288.1458333333333,step:1},{x:388.73636881510413,y:288.1458333333333,step:1},{x:386.0904541015625,y:287.85282389322913,step:1},{x:384.80533854166663,y:287.5598958333333,step:1},{x:389.52994791666663,y:260.048828125,step:0},{x:391.080078125,y:283.1067708333333,step:2},{x:391.7220052083333,y:283.19010416666663,step:1},{x:392.5162353515625,y:283.2317708333333,step:1},{x:393.4609375,y:283.2317708333333,step:1},{x:396.40946451822913,y:283.2317708333333,step:1},{x:399.017578125,y:282.0573323567708,step:1},{x:400.6809895833333,y:279.9569905598958,step:1},{x:402.4198811848958,y:277.7317708333333,step:1},{x:403.32682291666663,y:274.7916259765625,step:1},{x:403.32682291666663,y:271.38871256510413,step:1},{x:403.32682291666663,y:266.8952229817708,step:1},{x:401.0970052083333,y:264.24869791666663,step:1},{x:396.5989990234375,y:264.24869791666663,step:1},{x:395.6536865234375,y:264.24869791666663,step:1},{x:394.8600667317708,y:264.33268229166663,step:1},{x:394.2923583984375,y:264.458984375,step:1},{x:391.080078125,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Eh=[{type:"path",stampPoints:[{x:523.234375,y:293.9374593098958,step:2},{x:523.234375,y:298.3358968098958,step:1},{x:519.3333333333333,y:301.9374593098958,step:1},{x:514.5638020833333,y:301.9374593098958,step:1},{x:305.404296875,y:301.9374593098958,step:0},{x:300.6360677083333,y:301.9374593098958,step:1},{x:296.73504638671875,y:298.3358968098958,step:1},{x:296.73504638671875,y:293.9374593098958,step:1},{x:296.73504638671875,y:251.93745930989581,step:0},{x:296.73504638671875,y:247.53645833333331,step:1},{x:300.6360677083333,y:243.93745930989581,step:1},{x:305.404296875,y:243.93745930989581,step:1},{x:514.5638020833333,y:243.93745930989581,step:0},{x:519.3333333333333,y:243.93745930989581,step:1},{x:523.234375,y:247.53645833333331,step:1},{x:523.234375,y:251.93745930989581,step:1},{x:523.234375,y:293.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:523.234375,y:293.9374593098958,step:2},{x:523.234375,y:298.3358968098958,step:1},{x:519.3333333333333,y:301.9374593098958,step:1},{x:514.5638020833333,y:301.9374593098958,step:1},{x:305.404296875,y:301.9374593098958,step:0},{x:300.6360677083333,y:301.9374593098958,step:1},{x:296.73504638671875,y:298.3358968098958,step:1},{x:296.73504638671875,y:293.9374593098958,step:1},{x:296.73504638671875,y:251.93745930989581,step:0},{x:296.73504638671875,y:247.53645833333331,step:1},{x:300.6360677083333,y:243.93745930989581,step:1},{x:305.404296875,y:243.93745930989581,step:1},{x:514.5638020833333,y:243.93745930989581,step:0},{x:519.3333333333333,y:243.93745930989581,step:1},{x:523.234375,y:247.53645833333331,step:1},{x:523.234375,y:251.93745930989581,step:1},{x:523.234375,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:329.54166666666663,y:287.13798014322913,step:2},{x:328.1810099283854,y:287.80985514322913,step:1},{x:325.91276041666663,y:288.35673014322913,step:1},{x:322.8515625,y:288.35673014322913,step:1},{x:316.0852864583333,y:288.35673014322913,step:1},{x:311.58660888671875,y:283.8203125,step:1},{x:311.58660888671875,y:276.3437093098958,step:1},{x:311.58660888671875,y:269.9609375,step:1},{x:314.15690104166663,y:265.046875,step:1},{x:318.0130411783854,y:262.1901448567708,step:1},{x:320.65885416666663,y:260.1745198567708,step:1},{x:323.75844319661456,y:259.2083333333333,step:1},{x:327.349609375,y:259.2083333333333,step:1},{x:330.1087443033854,y:259.2083333333333,step:1},{x:332.18817138671875,y:259.92191569010413,step:1},{x:332.943359375,y:260.38541666666663,step:1},{x:331.43166097005206,y:265.29947916666663,step:0},{x:330.71356201171875,y:264.8802490234375,step:1},{x:329.01236979166663,y:264.3749593098958,step:1},{x:326.8203125,y:264.3749593098958,step:1},{x:324.62760416666663,y:264.3749593098958,step:1},{x:322.5488077799479,y:265.1302083333333,step:1},{x:320.99867757161456,y:266.5598958333333,step:1},{x:318.8821614583333,y:268.4895833333333,step:1},{x:317.4837239583333,y:271.7239583333333,step:1},{x:317.4837239583333,y:275.6718343098958,step:1},{x:317.4837239583333,y:280.16666666666663,step:1},{x:319.78971354166663,y:283.19010416666663,step:1},{x:324.25002034505206,y:283.19010416666663,step:1},{x:326.064453125,y:283.19010416666663,step:1},{x:327.84051513671875,y:282.85416666666663,step:1},{x:329.087890625,y:282.265625,step:1},{x:329.54166666666663,y:287.13798014322913,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:342.9987386067708,y:288.3984375,step:2},{x:336.3841145833333,y:288.3984375,step:1},{x:332.67970784505206,y:283.19010416666663,step:1},{x:332.67970784505206,y:276.59635416666663,step:1},{x:332.67970784505206,y:271.4739990234375,step:1},{x:334.380859375,y:266.390625,step:1},{x:337.3665364583333,y:263.19791666666663,step:1},{x:339.74806722005206,y:260.6796875,step:1},{x:342.9987386067708,y:259.16666666666663,step:1},{x:346.6653645833333,y:259.16666666666663,step:1},{x:353.3938802083333,y:259.16666666666663,step:1},{x:356.94730631510413,y:264.2083333333333,step:1},{x:356.94730631510413,y:270.96875,step:1},{x:356.94730631510413,y:276.1354573567708,step:1},{x:355.3216145833333,y:281.17447916666663,step:1},{x:352.4107666015625,y:284.3255208333333,step:1},{x:350.0292561848958,y:286.8880615234375,step:1},{x:346.8170979817708,y:288.3984375,step:1},{x:343.0364583333333,y:288.3984375,step:1},{x:342.9987386067708,y:288.3984375,step:0},{x:343.79296875,y:283.35941569010413,step:2},{x:345.4185791015625,y:283.35941569010413,step:1},{x:346.892578125,y:282.6015625,step:1},{x:348.0638020833333,y:281.3021240234375,step:1},{x:350.06705729166663,y:279.0755208333333,step:1},{x:351.1634114583333,y:274.4140625,step:1},{x:351.1634114583333,y:271.13798014322913,step:1},{x:351.1634114583333,y:267.609375,step:1},{x:350.0292561848958,y:264.2083333333333,step:1},{x:346.0227864583333,y:264.2083333333333,step:1},{x:344.3216552734375,y:264.2083333333333,step:1},{x:342.8098958333333,y:265.00516764322913,step:1},{x:341.6380208333333,y:266.34891764322913,step:1},{x:339.5970052083333,y:268.5755208333333,step:1},{x:338.46291097005206,y:272.9843343098958,step:1},{x:338.46291097005206,y:276.3880208333333,step:1},{x:338.46291097005206,y:280.3775634765625,step:1},{x:340.087890625,y:283.35941569010413,step:1},{x:343.75455729166663,y:283.35941569010413,step:1},{x:343.79296875,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:379.5130208333333,y:287.9374593098958,step:2},{x:381.06315104166663,y:276.26041666666663,step:0},{x:381.478515625,y:273.1953125,step:1},{x:382.04557291666663,y:269.33072916666663,step:1},{x:382.76371256510413,y:265.2161865234375,step:1},{x:382.6503499348958,y:265.2161865234375,step:0},{x:381.2519124348958,y:268.8671875,step:1},{x:379.66471354166663,y:272.7734375,step:1},{x:378.26627604166663,y:275.88285319010413,step:1},{x:373.04886881510413,y:287.4739990234375,step:0},{x:368.8157958984375,y:287.4739990234375,step:0},{x:367.908203125,y:276.00785319010413,step:0},{x:367.68168131510413,y:272.90104166666663,step:1},{x:367.4928792317708,y:268.9948323567708,step:1},{x:367.34183756510413,y:265.2161865234375,step:1},{x:367.26627604166663,y:265.2161865234375,step:0},{x:366.54752604166663,y:268.953125,step:1},{x:365.79166666666663,y:273.2369384765625,step:1},{x:365.14908854166663,y:276.26041666666663,step:1},{x:362.6165364583333,y:287.9374593098958,step:0},{x:357.626953125,y:287.9374593098958,step:0},{x:364.0150146484375,y:259.6302083333333,step:0},{x:371.3105061848958,y:259.6302083333333,step:0},{x:372.10416666666663,y:270.42191569010413,step:0},{x:372.255859375,y:273.06766764322913,step:1},{x:372.5201416015625,y:276.26041666666663,step:1},{x:372.5579427083333,y:279.4114583333333,step:1},{x:372.708984375,y:279.4114583333333,step:0},{x:373.69205729166663,y:276.26041666666663,step:1},{x:375.052734375,y:272.9427083333333,step:1},{x:376.1491292317708,y:270.3802083333333,step:1},{x:380.87369791666663,y:259.6302083333333,step:0},{x:388.2447509765625,y:259.6302083333333,step:0},{x:384.80533854166663,y:287.9374593098958,step:0},{x:379.5130208333333,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:393.99027506510413,y:260.1328125,step:2},{x:395.6536865234375,y:259.6718343098958,step:1},{x:398.1862386067708,y:259.4192708333333,step:1},{x:400.64322916666663,y:259.4192708333333,step:1},{x:402.94921875,y:259.4192708333333,step:1},{x:405.5572509765625,y:259.83854166666663,step:1},{x:407.40946451822913,y:261.3098958333333,step:1},{x:409.1484375,y:262.56766764322913,step:1},{x:410.1692708333333,y:264.5859375,step:1},{x:410.1692708333333,y:267.31510416666663,step:1},{x:410.1692708333333,y:270.8854573567708,step:1},{x:408.6946614583333,y:273.6145833333333,step:1},{x:406.72855631510413,y:275.2942708333333,step:1},{x:404.6503499348958,y:277.1015625,step:1},{x:401.66410319010413,y:277.94010416666663,step:1},{x:398.5644124348958,y:277.94010416666663,step:1},{x:397.656982421875,y:277.94010416666663,step:1},{x:396.9010823567708,y:277.81510416666663,step:1},{x:396.333984375,y:277.7734375,step:1},{x:394.59574381510413,y:287.9374593098958,step:0},{x:389.26566569010413,y:287.9374593098958,step:0},{x:393.99027506510413,y:260.1328125,step:0},{x:397.1659749348958,y:272.8177083333333,step:2},{x:397.73246256510413,y:272.9427083333333,step:1},{x:398.337890625,y:273.02604166666663,step:1},{x:399.28251139322913,y:273.02604166666663,step:1},{x:402.5331624348958,y:273.02604166666663,step:1},{x:404.68815104166663,y:270.6745198567708,step:1},{x:404.68815104166663,y:267.859375,step:1},{x:404.68815104166663,y:265.1302083333333,step:1},{x:402.91141764322913,y:264.25,step:1},{x:400.8326416015625,y:264.25,step:1},{x:399.81180826822913,y:264.25,step:1},{x:399.05533854166663,y:264.3333333333333,step:1},{x:398.60221354166663,y:264.4167073567708,step:1},{x:397.1659749348958,y:272.8177083333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:415.421875,y:259.6302083333333,step:2},{x:420.8645833333333,y:259.6302083333333,step:0},{x:416.9348958333333,y:282.64579264322913,step:0},{x:426.7239583333333,y:282.64579264322913,step:0},{x:425.8177083333333,y:287.9374593098958,step:0},{x:410.58329264322913,y:287.9374593098958,step:0},{x:415.421875,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.54947916666663,y:275.88285319010413,step:2},{x:436.515625,y:275.88285319010413,step:0},{x:435.3437093098958,y:282.7708333333333,step:0},{x:445.51041666666663,y:282.7708333333333,step:0},{x:444.6419270833333,y:287.9374593098958,step:0},{x:428.9921875,y:287.9374593098958,step:0},{x:433.83072916666663,y:259.6302083333333,step:0},{x:448.9127197265625,y:259.6302083333333,step:0},{x:448.00516764322913,y:264.7942708333333,step:0},{x:438.4036458333333,y:264.7942708333333,step:0},{x:437.34635416666663,y:270.8021240234375,step:0},{x:446.45572916666663,y:270.8021240234375,step:0},{x:445.54947916666663,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:457.0780843098958,y:264.92191569010413,step:2},{x:450.3489990234375,y:264.92191569010413,step:0},{x:451.2942708333333,y:259.6302083333333,step:0},{x:470.2317708333333,y:259.6302083333333,step:0},{x:469.32548014322913,y:264.92191569010413,step:0},{x:462.5208333333333,y:264.92191569010413,step:0},{x:458.58988444010413,y:287.9374593098958,step:0},{x:453.1458333333333,y:287.9374593098958,step:0},{x:457.0780843098958,y:264.92191569010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:485.0130208333333,y:275.88285319010413,step:2},{x:475.97782389322913,y:275.88285319010413,step:0},{x:474.8059895833333,y:282.7708333333333,step:0},{x:484.9739583333333,y:282.7708333333333,step:0},{x:484.10416666666663,y:287.9374593098958,step:0},{x:468.45572916666663,y:287.9374593098958,step:0},{x:473.2942708333333,y:259.6302083333333,step:0},{x:488.37504069010413,y:259.6302083333333,step:0},{x:487.46875,y:264.7942708333333,step:0},{x:477.8671875,y:264.7942708333333,step:0},{x:476.8098958333333,y:270.8021240234375,step:0},{x:485.9192708333333,y:270.8021240234375,step:0},{x:485.0130208333333,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:492.76041666666663,y:260.04947916666663,step:2},{x:494.953125,y:259.6302083333333,step:1},{x:497.33463541666663,y:259.4192708333333,step:1},{x:499.8294270833333,y:259.4192708333333,step:1},{x:503.7981770833333,y:259.4192708333333,step:1},{x:506.9348958333333,y:260.42704264322913,step:1},{x:509.0911458333333,y:262.4843343098958,step:1},{x:511.1692708333333,y:264.3333333333333,step:1},{x:512.4544270833333,y:267.14579264322913,step:1},{x:512.4544270833333,y:271.34635416666663,step:1},{x:512.4544270833333,y:276.8073323567708,step:1},{x:510.37504069010413,y:281.5521240234375,step:1},{x:507.2382405598958,y:284.3671875,step:1},{x:504.28910319010413,y:287.01298014322913,step:1},{x:500.546875,y:288.1458333333333,step:1},{x:495.0286865234375,y:288.1458333333333,step:1},{x:491.9661458333333,y:288.1458333333333,step:1},{x:489.3203125,y:287.8515218098958,step:1},{x:488.03641764322913,y:287.5598958333333,step:1},{x:492.76041666666663,y:260.04947916666663,step:0},{x:494.3099365234375,y:283.1067708333333,step:2},{x:494.953125,y:283.19010416666663,step:1},{x:495.7473958333333,y:283.2317708333333,step:1},{x:496.6927083333333,y:283.2317708333333,step:1},{x:499.640625,y:283.2317708333333,step:1},{x:502.2473958333333,y:282.0573323567708,step:1},{x:503.91141764322913,y:279.95572916666663,step:1},{x:505.6510823567708,y:277.7317708333333,step:1},{x:506.5572509765625,y:274.7916259765625,step:1},{x:506.5572509765625,y:271.3880615234375,step:1},{x:506.5572509765625,y:266.8958740234375,step:1},{x:504.32816569010413,y:264.25,step:1},{x:499.8294270833333,y:264.25,step:1},{x:498.8841145833333,y:264.25,step:1},{x:498.0911458333333,y:264.3333333333333,step:1},{x:497.52347819010413,y:264.45829264322913,step:1},{x:494.3099365234375,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Dh=[{type:"path",stampPoints:[{x:545.5651041666666,y:293.9374593098958,step:2},{x:545.5651041666666,y:298.3358968098958,step:1},{x:540.8880615234375,y:301.9374593098958,step:1},{x:535.1718343098958,y:301.9374593098958,step:1},{x:284.4602864583333,y:301.9374593098958,step:0},{x:278.74416097005206,y:301.9374593098958,step:1},{x:274.06837972005206,y:298.3358968098958,step:1},{x:274.06837972005206,y:293.9374593098958,step:1},{x:274.06837972005206,y:251.93745930989581,step:0},{x:274.06837972005206,y:247.53645833333331,step:1},{x:278.74416097005206,y:243.93745930989581,step:1},{x:284.4602864583333,y:243.93745930989581,step:1},{x:535.1718343098958,y:243.93745930989581,step:0},{x:540.8880615234375,y:243.93745930989581,step:1},{x:545.5651041666666,y:247.53645833333331,step:1},{x:545.5651041666666,y:251.93745930989581,step:1},{x:545.5651041666666,y:293.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #e4f1ff, #c9cee2)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:545.5651041666666,y:293.9374593098958,step:2},{x:545.5651041666666,y:298.3358968098958,step:1},{x:540.8880615234375,y:301.9374593098958,step:1},{x:535.1718343098958,y:301.9374593098958,step:1},{x:284.4602864583333,y:301.9374593098958,step:0},{x:278.74416097005206,y:301.9374593098958,step:1},{x:274.06837972005206,y:298.3358968098958,step:1},{x:274.06837972005206,y:293.9374593098958,step:1},{x:274.06837972005206,y:251.93745930989581,step:0},{x:274.06837972005206,y:247.53645833333331,step:1},{x:278.74416097005206,y:243.93745930989581,step:1},{x:284.4602864583333,y:243.93745930989581,step:1},{x:535.1718343098958,y:243.93745930989581,step:0},{x:540.8880615234375,y:243.93745930989581,step:1},{x:545.5651041666666,y:247.53645833333331,step:1},{x:545.5651041666666,y:251.93745930989581,step:1},{x:545.5651041666666,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(24,37,100,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:306.875,y:287.13798014322913,step:2},{x:305.51434326171875,y:287.80985514322913,step:1},{x:303.24609375,y:288.35673014322913,step:1},{x:300.1848958333333,y:288.35673014322913,step:1},{x:293.41861979166663,y:288.35673014322913,step:1},{x:288.91994222005206,y:283.8203125,step:1},{x:288.91994222005206,y:276.3437093098958,step:1},{x:288.91994222005206,y:269.9609375,step:1},{x:291.490234375,y:265.046875,step:1},{x:295.34637451171875,y:262.1901448567708,step:1},{x:297.9921875,y:260.1745198567708,step:1},{x:301.0917765299479,y:259.2083333333333,step:1},{x:304.6829427083333,y:259.2083333333333,step:1},{x:307.44207763671875,y:259.2083333333333,step:1},{x:309.52150472005206,y:259.92191569010413,step:1},{x:310.2766927083333,y:260.38541666666663,step:1},{x:308.7649943033854,y:265.29947916666663,step:0},{x:308.04689534505206,y:264.8802490234375,step:1},{x:306.345703125,y:264.3749593098958,step:1},{x:304.1536458333333,y:264.3749593098958,step:1},{x:301.9609375,y:264.3749593098958,step:1},{x:299.88214111328125,y:265.1302083333333,step:1},{x:298.3320109049479,y:266.5598958333333,step:1},{x:296.21549479166663,y:268.4895833333333,step:1},{x:294.81705729166663,y:271.7239583333333,step:1},{x:294.81705729166663,y:275.6718343098958,step:1},{x:294.81705729166663,y:280.16666666666663,step:1},{x:297.123046875,y:283.19010416666663,step:1},{x:301.5833536783854,y:283.19010416666663,step:1},{x:303.3977864583333,y:283.19010416666663,step:1},{x:305.17384847005206,y:282.85416666666663,step:1},{x:306.4212239583333,y:282.265625,step:1},{x:306.875,y:287.13798014322913,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:320.3320109049479,y:288.3984375,step:2},{x:313.71744791666663,y:288.3984375,step:1},{x:310.0130411783854,y:283.19010416666663,step:1},{x:310.0130411783854,y:276.59635416666663,step:1},{x:310.0130411783854,y:271.4739990234375,step:1},{x:311.7141927083333,y:266.390625,step:1},{x:314.69986979166663,y:263.19791666666663,step:1},{x:317.0814005533854,y:260.6796875,step:1},{x:320.3320109049479,y:259.16666666666663,step:1},{x:323.99867757161456,y:259.16666666666663,step:1},{x:330.72721354166663,y:259.16666666666663,step:1},{x:334.28057861328125,y:264.2083333333333,step:1},{x:334.28057861328125,y:270.96875,step:1},{x:334.28057861328125,y:276.1354573567708,step:1},{x:332.65494791666663,y:281.17447916666663,step:1},{x:329.74416097005206,y:284.3255208333333,step:1},{x:327.3626505533854,y:286.8880615234375,step:1},{x:324.150390625,y:288.3984375,step:1},{x:320.36981201171875,y:288.3984375,step:1},{x:320.3320109049479,y:288.3984375,step:0},{x:321.1263020833333,y:283.35941569010413,step:2},{x:322.751953125,y:283.35941569010413,step:1},{x:324.2259114583333,y:282.6015625,step:1},{x:325.39711507161456,y:281.3021240234375,step:1},{x:327.400390625,y:279.0755208333333,step:1},{x:328.49676513671875,y:274.4140625,step:1},{x:328.49676513671875,y:271.13798014322913,step:1},{x:328.49676513671875,y:267.609375,step:1},{x:327.3626505533854,y:264.2083333333333,step:1},{x:323.35611979166663,y:264.2083333333333,step:1},{x:321.65494791666663,y:264.2083333333333,step:1},{x:320.14322916666663,y:265.00516764322913,step:1},{x:318.97135416666663,y:266.34891764322913,step:1},{x:316.93033854166663,y:268.5755208333333,step:1},{x:315.7962443033854,y:272.9843343098958,step:1},{x:315.7962443033854,y:276.3880208333333,step:1},{x:315.7962443033854,y:280.3775634765625,step:1},{x:317.4212239583333,y:283.35941569010413,step:1},{x:321.087890625,y:283.35941569010413,step:1},{x:321.1263020833333,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:335.56512451171875,y:287.9374593098958,step:2},{x:340.4036458333333,y:259.6302083333333,step:0},{x:346.79166666666663,y:259.6302083333333,step:0},{x:350.1556396484375,y:270.42191569010413,step:0},{x:351.17643229166663,y:274.03385416666663,step:1},{x:351.8573811848958,y:276.9739583333333,step:1},{x:352.46158854166663,y:280.0833740234375,step:1},{x:352.57486979166663,y:280.0833740234375,step:0},{x:352.6888427734375,y:277.18485514322913,step:1},{x:353.06640625,y:274.0755208333333,step:1},{x:353.74674479166663,y:269.9192708333333,step:1},{x:355.4857177734375,y:259.6302083333333,step:0},{x:360.58854166666663,y:259.6302083333333,step:0},{x:355.75,y:287.9374593098958,step:0},{x:350.11783854166663,y:287.9374593098958,step:0},{x:346.5650634765625,y:276.6380208333333,step:0},{x:345.4309895833333,y:272.7734375,step:1},{x:344.75065104166663,y:270.2135823567708,step:1},{x:344.0697021484375,y:266.7682698567708,step:1},{x:343.9563802083333,y:266.7682698567708,step:0},{x:343.69205729166663,y:269.54166666666663,step:1},{x:343.0872395833333,y:273.53129069010413,step:1},{x:342.3313802083333,y:278.0234375,step:1},{x:340.63087972005206,y:287.9374593098958,step:0},{x:335.56512451171875,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:365.57743326822913,y:259.6302083333333,step:2},{x:380.50846354166663,y:259.6302083333333,step:0},{x:379.6009521484375,y:264.7942708333333,step:0},{x:370.1516927083333,y:264.7942708333333,step:0},{x:368.9798177083333,y:271.42972819010413,step:0},{x:377.86258951822913,y:271.42972819010413,step:0},{x:376.9557698567708,y:276.51298014322913,step:0},{x:368.11063639322913,y:276.51298014322913,step:0},{x:366.1823323567708,y:287.9374593098958,step:0},{x:360.7395833333333,y:287.9374593098958,step:0},{x:365.57743326822913,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.22265625,y:259.6302083333333,step:2},{x:385.3847249348958,y:287.9374593098958,step:0},{x:379.94071451822913,y:287.9374593098958,step:0},{x:384.7792561848958,y:259.6302083333333,step:0},{x:390.22265625,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:395.1737874348958,y:260.04947916666663,step:2},{x:397.36649576822913,y:259.6302083333333,step:1},{x:399.748046875,y:259.4192708333333,step:1},{x:402.24283854166663,y:259.4192708333333,step:1},{x:406.21158854166663,y:259.4192708333333,step:1},{x:409.3489990234375,y:260.42704264322913,step:1},{x:411.50260416666663,y:262.4843343098958,step:1},{x:413.58329264322913,y:264.3333333333333,step:1},{x:414.8671875,y:267.14579264322913,step:1},{x:414.8671875,y:271.34635416666663,step:1},{x:414.8671875,y:276.8073323567708,step:1},{x:412.7890625,y:281.5521240234375,step:1},{x:409.6510823567708,y:284.3671875,step:1},{x:406.7030843098958,y:287.01298014322913,step:1},{x:402.9609375,y:288.1458333333333,step:1},{x:397.4420166015625,y:288.1458333333333,step:1},{x:394.380859375,y:288.1458333333333,step:1},{x:391.734375,y:287.8515218098958,step:1},{x:390.4491780598958,y:287.5598958333333,step:1},{x:395.1737874348958,y:260.04947916666663,step:0},{x:396.7239583333333,y:283.1067708333333,step:2},{x:397.36649576822913,y:283.19010416666663,step:1},{x:398.16015625,y:283.2317708333333,step:1},{x:399.10477701822913,y:283.2317708333333,step:1},{x:402.0540364583333,y:283.2317708333333,step:1},{x:404.662109375,y:282.0573323567708,step:1},{x:406.3249104817708,y:279.95572916666663,step:1},{x:408.0638020833333,y:277.7317708333333,step:1},{x:408.970703125,y:274.7916259765625,step:1},{x:408.970703125,y:271.3880615234375,step:1},{x:408.970703125,y:266.8958740234375,step:1},{x:406.74088541666663,y:264.25,step:1},{x:402.24283854166663,y:264.25,step:1},{x:401.2974853515625,y:264.25,step:1},{x:400.5038655598958,y:264.3333333333333,step:1},{x:399.9368489583333,y:264.45829264322913,step:1},{x:396.7239583333333,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:432.7096761067708,y:275.88285319010413,step:2},{x:423.67447916666663,y:275.88285319010413,step:0},{x:422.50260416666663,y:282.7708333333333,step:0},{x:432.6718343098958,y:282.7708333333333,step:0},{x:431.80204264322913,y:287.9374593098958,step:0},{x:416.1536865234375,y:287.9374593098958,step:0},{x:420.9921875,y:259.6302083333333,step:0},{x:436.07291666666663,y:259.6302083333333,step:0},{x:435.16666666666663,y:264.7942708333333,step:0},{x:425.56510416666663,y:264.7942708333333,step:0},{x:424.5077718098958,y:270.8021240234375,step:0},{x:433.61722819010413,y:270.8021240234375,step:0},{x:432.7096761067708,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:435.69535319010413,y:287.9374593098958,step:2},{x:440.53385416666663,y:259.6302083333333,step:0},{x:446.921875,y:259.6302083333333,step:0},{x:450.2864583333333,y:270.42191569010413,step:0},{x:451.3072509765625,y:274.03385416666663,step:1},{x:451.98697916666663,y:276.9739583333333,step:1},{x:452.59244791666663,y:280.0833740234375,step:1},{x:452.70572916666663,y:280.0833740234375,step:0},{x:452.8190511067708,y:277.18485514322913,step:1},{x:453.1978759765625,y:274.0755208333333,step:1},{x:453.87760416666663,y:269.9192708333333,step:1},{x:455.61722819010413,y:259.6302083333333,step:0},{x:460.71875,y:259.6302083333333,step:0},{x:455.8802083333333,y:287.9374593098958,step:0},{x:450.24869791666663,y:287.9374593098958,step:0},{x:446.6953125,y:276.6380208333333,step:0},{x:445.56119791666663,y:272.7734375,step:1},{x:444.8802083333333,y:270.2135823567708,step:1},{x:444.2005208333333,y:266.7682698567708,step:1},{x:444.0872395833333,y:266.7682698567708,step:0},{x:443.8228759765625,y:269.54166666666663,step:1},{x:443.21875,y:273.53129069010413,step:1},{x:442.4622802734375,y:278.0234375,step:1},{x:440.76041666666663,y:287.9374593098958,step:0},{x:435.69535319010413,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:469.4127197265625,y:264.92191569010413,step:2},{x:462.6848958333333,y:264.92191569010413,step:0},{x:463.6302490234375,y:259.6302083333333,step:0},{x:482.5677083333333,y:259.6302083333333,step:0},{x:481.65885416666663,y:264.92191569010413,step:0},{x:474.85550944010413,y:264.92191569010413,step:0},{x:470.92447916666663,y:287.9374593098958,step:0},{x:465.4818115234375,y:287.9374593098958,step:0},{x:469.4127197265625,y:264.92191569010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:490.9583740234375,y:259.6302083333333,step:2},{x:486.1197509765625,y:287.9374593098958,step:0},{x:480.67704264322913,y:287.9374593098958,step:0},{x:485.51566569010413,y:259.6302083333333,step:0},{x:490.9583740234375,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:498.1770833333333,y:280.5859375,step:2},{x:495.1913655598958,y:287.9374593098958,step:0},{x:489.3697509765625,y:287.9374593098958,step:0},{x:501.8072509765625,y:259.6302083333333,step:0},{x:508.79947916666663,y:259.6302083333333,step:0},{x:511.7473958333333,y:287.9374593098958,step:0},{x:506.0403645833333,y:287.9374593098958,step:0},{x:505.51041666666663,y:280.5859375,step:0},{x:498.1770833333333,y:280.5859375,step:0},{x:505.28385416666663,y:275.9661458333333,step:2},{x:504.79166666666663,y:269.87760416666663,step:0},{x:504.6796875,y:268.3229573567708,step:1},{x:504.5650634765625,y:266.05472819010413,step:1},{x:504.4530843098958,y:264.3333333333333,step:1},{x:504.3385009765625,y:264.3333333333333,step:0},{x:503.6966552734375,y:266.05472819010413,step:1},{x:502.9792073567708,y:268.2396240234375,step:1},{x:502.2981770833333,y:269.87760416666663,step:1},{x:499.80204264322913,y:275.9661458333333,step:0},{x:505.28385416666663,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:519.3463541666666,y:259.6302083333333,step:2},{x:524.7890625,y:259.6302083333333,step:0},{x:520.8568115234375,y:282.64579264322913,step:0},{x:530.6484375,y:282.64579264322913,step:0},{x:529.7395833333333,y:287.9374593098958,step:0},{x:514.5077718098958,y:287.9374593098958,step:0},{x:519.3463541666666,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Rh=[{type:"path",stampPoints:[{x:480.32816569010413,y:291.3645833333333,step:2},{x:480.32816569010413,y:297.2317708333333,step:1},{x:474.28125,y:302.03125,step:1},{x:466.8880615234375,y:302.03125,step:1},{x:350.91019694010413,y:302.03125,step:0},{x:343.51822916666663,y:302.03125,step:1},{x:337.4700724283854,y:297.2317708333333,step:1},{x:337.4700724283854,y:291.3645833333333,step:1},{x:337.4700724283854,y:254.3671875,step:0},{x:337.4700724283854,y:248.50069173177081,step:1},{x:343.51822916666663,y:243.70052083333331,step:1},{x:350.91019694010413,y:243.70052083333331,step:1},{x:466.8880615234375,y:243.70052083333331,step:0},{x:474.28125,y:243.70052083333331,step:1},{x:480.32816569010413,y:248.50069173177081,step:1},{x:480.32816569010413,y:254.3671875,step:1},{x:480.32816569010413,y:291.3645833333333,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #e4f1ff, #c9cee2)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:480.32816569010413,y:291.3645833333333,step:2},{x:480.32816569010413,y:297.2317708333333,step:1},{x:474.28125,y:302.03125,step:1},{x:466.8880615234375,y:302.03125,step:1},{x:350.91019694010413,y:302.03125,step:0},{x:343.51822916666663,y:302.03125,step:1},{x:337.4700724283854,y:297.2317708333333,step:1},{x:337.4700724283854,y:291.3645833333333,step:1},{x:337.4700724283854,y:254.3671875,step:0},{x:337.4700724283854,y:248.50069173177081,step:1},{x:343.51822916666663,y:243.70052083333331,step:1},{x:350.91019694010413,y:243.70052083333331,step:1},{x:466.8880615234375,y:243.70052083333331,step:0},{x:474.28125,y:243.70052083333331,step:1},{x:480.32816569010413,y:248.50069173177081,step:1},{x:480.32816569010413,y:254.3671875,step:1},{x:480.32816569010413,y:291.3645833333333,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(24,37,100,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:356.54886881510413,y:260.048828125,step:2},{x:358.7415364583333,y:259.6288655598958,step:1},{x:361.12308756510413,y:259.41861979166663,step:1},{x:363.61722819010413,y:259.41861979166663,step:1},{x:367.5865478515625,y:259.41861979166663,step:1},{x:370.7239583333333,y:260.42704264322913,step:1},{x:372.8782552083333,y:262.4849853515625,step:1},{x:374.9577229817708,y:264.33268229166663,step:1},{x:376.24283854166663,y:267.146484375,step:1},{x:376.24283854166663,y:271.3470052083333,step:1},{x:376.24283854166663,y:276.8073323567708,step:1},{x:374.1634114583333,y:281.5521240234375,step:1},{x:371.0267333984375,y:284.3671875,step:1},{x:368.07743326822913,y:287.01298014322913,step:1},{x:364.3352864583333,y:288.1458333333333,step:1},{x:358.8170979817708,y:288.1458333333333,step:1},{x:355.7552083333333,y:288.1458333333333,step:1},{x:353.10868326822913,y:287.85282389322913,step:1},{x:351.8235677083333,y:287.5598958333333,step:1},{x:356.54886881510413,y:260.048828125,step:0},{x:358.0989990234375,y:283.1067708333333,step:2},{x:358.7415364583333,y:283.19010416666663,step:1},{x:359.53515625,y:283.2317708333333,step:1},{x:360.47977701822913,y:283.2317708333333,step:1},{x:363.4284261067708,y:283.2317708333333,step:1},{x:366.0370686848958,y:282.0573323567708,step:1},{x:367.69986979166663,y:279.9569905598958,step:1},{x:369.4388020833333,y:277.7317708333333,step:1},{x:370.34574381510413,y:274.7916259765625,step:1},{x:370.34574381510413,y:271.38871256510413,step:1},{x:370.34574381510413,y:266.8952229817708,step:1},{x:368.1158447265625,y:264.24869791666663,step:1},{x:363.61722819010413,y:264.24869791666663,step:1},{x:362.67252604166663,y:264.24869791666663,step:1},{x:361.8782552083333,y:264.33268229166663,step:1},{x:361.31180826822913,y:264.458984375,step:1},{x:358.0989990234375,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:382.3288167317708,y:260.1335042317708,step:2},{x:384.0292561848958,y:259.67057291666663,step:1},{x:386.599609375,y:259.41861979166663,step:1},{x:389.1321614583333,y:259.41861979166663,step:1},{x:391.5520833333333,y:259.41861979166663,step:1},{x:394.0462239583333,y:259.79752604166663,step:1},{x:395.8228759765625,y:261.056640625,step:1},{x:397.48636881510413,y:262.1491292317708,step:1},{x:398.658203125,y:263.91276041666663,step:1},{x:398.658203125,y:266.5592854817708,step:1},{x:398.658203125,y:270.7591145833333,step:1},{x:396.1634114583333,y:273.4049072265625,step:1},{x:392.8743489583333,y:274.58072916666663,step:1},{x:392.8743489583333,y:274.70703125,step:0},{x:394.38671875,y:275.46354166666663,step:1},{x:395.06705729166663,y:277.3098958333333,step:1},{x:395.2942708333333,y:279.8723958333333,step:1},{x:395.6341145833333,y:283.06510416666663,step:1},{x:395.8228759765625,y:286.76041666666663,step:1},{x:396.2766927083333,y:287.9374593098958,step:1},{x:390.6823323567708,y:287.9374593098958,step:0},{x:390.45572916666663,y:287.18094889322913,step:1},{x:390.1907552083333,y:284.74479166666663,step:1},{x:389.96415201822913,y:281.2591145833333,step:1},{x:389.69921875,y:277.81510416666663,step:1},{x:388.6412353515625,y:276.765625,step:1},{x:386.486328125,y:276.765625,step:1},{x:384.8236083984375,y:276.765625,step:0},{x:382.9329427083333,y:287.9374593098958,step:0},{x:377.5657958984375,y:287.9374593098958,step:0},{x:382.3288167317708,y:260.1335042317708,step:0},{x:385.6549886067708,y:272.22855631510413,step:2},{x:387.88541666666663,y:272.22855631510413,step:0},{x:390.833984375,y:272.22855631510413,step:1},{x:392.9876708984375,y:270.25455729166663,step:1},{x:392.9876708984375,y:267.48246256510413,step:1},{x:392.9876708984375,y:265.1731770833333,step:1},{x:391.287109375,y:264.16471354166663,step:1},{x:389.0950520833333,y:264.16471354166663,step:1},{x:388.07421875,y:264.16471354166663,step:1},{x:387.431640625,y:264.24869791666663,step:1},{x:386.978515625,y:264.3749593098958,step:1},{x:385.6549886067708,y:272.22855631510413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:406.9739583333333,y:280.5859375,step:2},{x:403.9876302083333,y:287.9374593098958,step:0},{x:398.1659749348958,y:287.9374593098958,step:0},{x:410.6028645833333,y:259.6288655598958,step:0},{x:417.59635416666663,y:259.6288655598958,step:0},{x:420.5442708333333,y:287.9374593098958,step:0},{x:414.8359375,y:287.9374593098958,step:0},{x:414.30729166666663,y:280.5859375,step:0},{x:406.9739583333333,y:280.5859375,step:0},{x:414.08072916666663,y:275.9661458333333,step:2},{x:413.58854166666663,y:269.8769124348958,step:0},{x:413.4753011067708,y:268.3229573567708,step:1},{x:413.36197916666663,y:266.0553792317708,step:1},{x:413.24869791666663,y:264.33268229166663,step:1},{x:413.1353759765625,y:264.33268229166663,step:0},{x:412.4921468098958,y:266.0553792317708,step:1},{x:411.7734375,y:268.2389729817708,step:1},{x:411.0937093098958,y:269.8769124348958,step:1},{x:408.599609375,y:275.9661458333333,step:0},{x:414.08072916666663,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:428.1419677734375,y:259.6288655598958,step:2},{x:443.07291666666663,y:259.6288655598958,step:0},{x:442.1653645833333,y:264.79496256510413,step:0},{x:432.71610514322913,y:264.79496256510413,step:0},{x:431.5442708333333,y:271.4309895833333,step:0},{x:440.42704264322913,y:271.4309895833333,step:0},{x:439.51822916666663,y:276.51298014322913,step:0},{x:430.67447916666663,y:276.51298014322913,step:0},{x:428.7460530598958,y:287.9374593098958,step:0},{x:423.3033447265625,y:287.9374593098958,step:0},{x:428.1419677734375,y:259.6288655598958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:451.1614583333333,y:264.9206136067708,step:2},{x:444.43229166666663,y:264.9206136067708,step:0},{x:445.37760416666663,y:259.6288655598958,step:0},{x:464.3151448567708,y:259.6288655598958,step:0},{x:463.40885416666663,y:264.9206136067708,step:0},{x:456.6041259765625,y:264.9206136067708,step:0},{x:452.6731770833333,y:287.9374593098958,step:0},{x:447.22916666666663,y:287.9374593098958,step:0},{x:451.1614583333333,y:264.9206136067708,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Ih=[{type:"path",stampPoints:[{x:470.0130208333333,y:291.0103759765625,step:2},{x:470.0130208333333,y:296.87760416666663,step:1},{x:464.83203125,y:301.67704264322913,step:1},{x:458.4973958333333,y:301.67704264322913,step:1},{x:359.1308186848958,y:301.67704264322913,step:0},{x:352.7974853515625,y:301.67704264322913,step:1},{x:347.61588541666663,y:296.87760416666663,step:1},{x:347.61588541666663,y:291.0103759765625,step:1},{x:347.61588541666663,y:254.01236979166666,step:0},{x:347.61588541666663,y:248.14583333333331,step:1},{x:352.7974853515625,y:243.345703125,step:1},{x:359.1308186848958,y:243.345703125,step:1},{x:458.4973958333333,y:243.345703125,step:0},{x:464.83203125,y:243.345703125,step:1},{x:470.0130208333333,y:248.14583333333331,step:1},{x:470.0130208333333,y:254.01236979166666,step:1},{x:470.0130208333333,y:291.0103759765625,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:470.0130208333333,y:291.0103759765625,step:2},{x:470.0130208333333,y:296.87760416666663,step:1},{x:464.83203125,y:301.67704264322913,step:1},{x:458.4973958333333,y:301.67704264322913,step:1},{x:359.1308186848958,y:301.67704264322913,step:0},{x:352.7974853515625,y:301.67704264322913,step:1},{x:347.61588541666663,y:296.87760416666663,step:1},{x:347.61588541666663,y:291.0103759765625,step:1},{x:347.61588541666663,y:254.01302083333331,step:0},{x:347.61588541666663,y:248.14652506510416,step:1},{x:352.7974853515625,y:243.34635416666666,step:1},{x:359.1308186848958,y:243.34635416666666,step:1},{x:458.4973958333333,y:243.34635416666666,step:0},{x:464.83203125,y:243.34635416666666,step:1},{x:470.0130208333333,y:248.14652506510416,step:1},{x:470.0130208333333,y:254.01302083333331,step:1},{x:470.0130208333333,y:291.0103759765625,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:365.95768229166663,y:259.62955729166663,step:2},{x:380.888671875,y:259.62955729166663,step:0},{x:379.9810791015625,y:264.79496256510413,step:0},{x:370.5318603515625,y:264.79496256510413,step:0},{x:369.36002604166663,y:271.431640625,step:0},{x:378.24283854166663,y:271.431640625,step:0},{x:377.3359375,y:276.51298014322913,step:0},{x:368.4908447265625,y:276.51298014322913,step:0},{x:366.5625,y:287.9374593098958,step:0},{x:361.1197509765625,y:287.9374593098958,step:0},{x:365.95768229166663,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.6028645833333,y:259.62955729166663,step:2},{x:385.76493326822913,y:287.9374593098958,step:0},{x:380.3210042317708,y:287.9374593098958,step:0},{x:385.1595052083333,y:259.62955729166663,step:0},{x:390.6028645833333,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.79166666666663,y:287.9374593098958,step:2},{x:395.62955729166663,y:259.62955729166663,step:0},{x:402.01822916666663,y:259.62955729166663,step:0},{x:405.3822021484375,y:270.423828125,step:0},{x:406.4030354817708,y:274.03641764322913,step:1},{x:407.0833333333333,y:276.9739583333333,step:1},{x:407.68815104166663,y:280.0833740234375,step:1},{x:407.8013916015625,y:280.0833740234375,step:0},{x:407.91471354166663,y:277.18485514322913,step:1},{x:408.29300944010413,y:274.078125,step:1},{x:408.97330729166663,y:269.91861979166663,step:1},{x:410.7109375,y:259.62955729166663,step:0},{x:415.81510416666663,y:259.62955729166663,step:0},{x:410.97660319010413,y:287.9374593098958,step:0},{x:405.34440104166663,y:287.9374593098958,step:0},{x:401.79166666666663,y:276.6380208333333,step:0},{x:400.6569417317708,y:272.775390625,step:1},{x:399.9771728515625,y:270.212890625,step:1},{x:399.2962239583333,y:266.7689208984375,step:1},{x:399.18290201822913,y:266.7689208984375,step:0},{x:398.9185791015625,y:269.541015625,step:1},{x:398.31315104166663,y:273.53129069010413,step:1},{x:397.5579427083333,y:278.0260823567708,step:1},{x:395.8567708333333,y:287.9374593098958,step:0},{x:390.79166666666663,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:422.9974365234375,y:280.5859375,step:2},{x:420.0103759765625,y:287.9374593098958,step:0},{x:414.1888427734375,y:287.9374593098958,step:0},{x:426.625,y:259.62955729166663,step:0},{x:433.61722819010413,y:259.62955729166663,step:0},{x:436.5677083333333,y:287.9374593098958,step:0},{x:430.859375,y:287.9374593098958,step:0},{x:430.3294270833333,y:280.5859375,step:0},{x:422.9974365234375,y:280.5859375,step:0},{x:430.1028645833333,y:275.9661458333333,step:2},{x:429.61197916666663,y:269.8769124348958,step:0},{x:429.4973958333333,y:268.322265625,step:1},{x:429.38541666666663,y:266.0553792317708,step:1},{x:429.27079264322913,y:264.33268229166663,step:1},{x:429.15751139322913,y:264.33268229166663,step:0},{x:428.515625,y:266.0553792317708,step:1},{x:427.796875,y:268.2389729817708,step:1},{x:427.1171468098958,y:269.8769124348958,step:1},{x:424.6223958333333,y:275.9661458333333,step:0},{x:430.1028645833333,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:444.1640625,y:259.62955729166663,step:2},{x:449.6068115234375,y:259.62955729166663,step:0},{x:445.67704264322913,y:282.64579264322913,step:0},{x:455.4661458333333,y:282.64579264322913,step:0},{x:454.5598958333333,y:287.9374593098958,step:0},{x:439.32548014322913,y:287.9374593098958,step:0},{x:444.1640625,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Mh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,50,130,1)",background:"linear-gradient(to right bottom, #ccc2ff, #8677c7)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:386.35221354166663,y:267.82421875,step:2},{x:384.50846354166663,y:278.6067708333333,step:0},{x:382.435546875,y:278.6067708333333,step:0},{x:384.27799479166663,y:267.82421875,step:0},{x:386.35221354166663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:386.4237874348958,y:278.6067708333333,step:2},{x:388.2669677734375,y:267.82421875,step:0},{x:390.7005208333333,y:267.82421875,step:0},{x:391.982421875,y:271.935546875,step:0},{x:392.37113444010413,y:273.3118489583333,step:1},{x:392.6302490234375,y:274.4322509765625,step:1},{x:392.8606770833333,y:275.6145833333333,step:1},{x:392.9036458333333,y:275.6145833333333,step:0},{x:392.94730631510413,y:274.51298014322913,step:1},{x:393.0911458333333,y:273.32816569010413,step:1},{x:393.3503011067708,y:271.744140625,step:1},{x:394.0124104817708,y:267.82421875,step:0},{x:395.9563802083333,y:267.82421875,step:0},{x:394.1132405598958,y:278.6067708333333,step:0},{x:391.9680989583333,y:278.6067708333333,step:0},{x:390.61393229166663,y:274.3046468098958,step:0},{x:390.1823323567708,y:272.83203125,step:1},{x:389.9232177734375,y:271.8561604817708,step:1},{x:389.66410319010413,y:270.5435791015625,step:1},{x:389.6204833984375,y:270.5435791015625,step:0},{x:389.52018229166663,y:271.599609375,step:1},{x:389.28971354166663,y:273.11979166666663,step:1},{x:389.0013020833333,y:274.83203125,step:1},{x:388.353515625,y:278.6067708333333,step:0},{x:386.4237874348958,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:399.88736979166663,y:267.82421875,step:2},{x:398.0442708333333,y:278.6067708333333,step:0},{x:395.970703125,y:278.6067708333333,step:0},{x:397.8138020833333,y:267.82421875,step:0},{x:399.88736979166663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:403.2141927083333,y:269.83984375,step:2},{x:400.65104166666663,y:269.83984375,step:0},{x:401.0110677083333,y:267.82421875,step:0},{x:408.22526041666663,y:267.82421875,step:0},{x:407.87955729166663,y:269.83984375,step:0},{x:405.28776041666663,y:269.83984375,step:0},{x:403.7897542317708,y:278.6067708333333,step:0},{x:401.71610514322913,y:278.6067708333333,step:0},{x:403.2141927083333,y:269.83984375,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:411.421875,y:267.82421875,step:2},{x:409.5780843098958,y:278.6067708333333,step:0},{x:407.50455729166663,y:278.6067708333333,step:0},{x:409.3489990234375,y:267.82421875,step:0},{x:411.421875,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:414.1718343098958,y:275.80729166666663,step:2},{x:413.0338948567708,y:278.6067708333333,step:0},{x:410.8177490234375,y:278.6067708333333,step:0},{x:415.55472819010413,y:267.82421875,step:0},{x:418.21875,y:267.82421875,step:0},{x:419.3411458333333,y:278.6067708333333,step:0},{x:417.16666666666663,y:278.6067708333333,step:0},{x:416.9661458333333,y:275.80729166666663,step:0},{x:414.1718343098958,y:275.80729166666663,step:0},{x:416.8802083333333,y:274.04691569010413,step:2},{x:416.6927083333333,y:271.7278645833333,step:0},{x:416.6484375,y:271.1360677083333,step:1},{x:416.6054280598958,y:270.2714436848958,step:1},{x:416.5625,y:269.61588541666663,step:1},{x:416.5181884765625,y:269.61588541666663,step:0},{x:416.27347819010413,y:270.2714436848958,step:1},{x:416,y:271.1034749348958,step:1},{x:415.7421875,y:271.7278645833333,step:1},{x:414.79166666666663,y:274.04691569010413,step:0},{x:416.8802083333333,y:274.04691569010413,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:422.2357177734375,y:267.82421875,step:2},{x:424.3099365234375,y:267.82421875,step:0},{x:422.81254069010413,y:276.5911458333333,step:0},{x:426.5417073567708,y:276.5911458333333,step:0},{x:426.19535319010413,y:278.6067708333333,step:0},{x:420.39322916666663,y:278.6067708333333,step:0},{x:422.2357177734375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:433.97135416666663,y:267.82421875,step:2},{x:433.25260416666663,y:272.0163167317708,step:0},{x:436.76566569010413,y:272.0163167317708,step:0},{x:437.48441569010413,y:267.82421875,step:0},{x:439.5729573567708,y:267.82421875,step:0},{x:437.7292073567708,y:278.6067708333333,step:0},{x:435.65629069010413,y:278.6067708333333,step:0},{x:436.4192708333333,y:274.0638020833333,step:0},{x:432.8905843098958,y:274.0638020833333,step:0},{x:432.12760416666663,y:278.6067708333333,step:0},{x:430.05472819010413,y:278.6067708333333,step:0},{x:431.8983968098958,y:267.82421875,step:0},{x:433.97135416666663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.9530843098958,y:274.015625,step:2},{x:442.5103759765625,y:274.015625,step:0},{x:442.06510416666663,y:276.640625,step:0},{x:445.9374593098958,y:276.640625,step:0},{x:445.6068115234375,y:278.6067708333333,step:0},{x:439.6458740234375,y:278.6067708333333,step:0},{x:441.48832194010413,y:267.82421875,step:0},{x:447.234375,y:267.82421875,step:0},{x:446.8880615234375,y:269.7916259765625,step:0},{x:443.23173014322913,y:269.7916259765625,step:0},{x:442.828125,y:272.08011881510413,step:0},{x:446.29691569010413,y:272.08011881510413,step:0},{x:445.9530843098958,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:448.9192708333333,y:268.0163167317708,step:2},{x:449.5677490234375,y:267.83984375,step:1},{x:450.546875,y:267.744140625,step:1},{x:451.51041666666663,y:267.744140625,step:1},{x:452.43229166666663,y:267.744140625,step:1},{x:453.3827718098958,y:267.8880615234375,step:1},{x:454.0598958333333,y:268.36783854166663,step:1},{x:454.6927083333333,y:268.78385416666663,step:1},{x:455.1405843098958,y:269.45572916666663,step:1},{x:455.1405843098958,y:270.46354166666663,step:1},{x:455.1405843098958,y:272.0638020833333,step:1},{x:454.1888427734375,y:273.07157389322913,step:1},{x:452.9375,y:273.5208333333333,step:1},{x:452.9375,y:273.5677083333333,step:0},{x:453.5130208333333,y:273.8567708333333,step:1},{x:453.77079264322913,y:274.5598958333333,step:1},{x:453.8580322265625,y:275.5364583333333,step:1},{x:453.98697916666663,y:276.75260416666663,step:1},{x:454.0598958333333,y:278.1588948567708,step:1},{x:454.2317708333333,y:278.6067708333333,step:1},{x:452.1015625,y:278.6067708333333,step:0},{x:452.01566569010413,y:278.3203125,step:1},{x:451.9140625,y:277.3919270833333,step:1},{x:451.828125,y:276.0638020833333,step:1},{x:451.7265625,y:274.75260416666663,step:1},{x:451.32291666666663,y:274.3515218098958,step:1},{x:450.50260416666663,y:274.3515218098958,step:1},{x:449.86979166666663,y:274.3515218098958,step:0},{x:449.1484375,y:278.6067708333333,step:0},{x:447.1041259765625,y:278.6067708333333,step:0},{x:448.9192708333333,y:268.0163167317708,step:0},{x:450.1862386067708,y:272.6236572265625,step:2},{x:451.0364583333333,y:272.6236572265625,step:0},{x:452.15885416666663,y:272.6236572265625,step:1},{x:452.9792073567708,y:271.87174479166663,step:1},{x:452.9792073567708,y:270.8157958984375,step:1},{x:452.9792073567708,y:269.935546875,step:1},{x:452.3307698567708,y:269.5521240234375,step:1},{x:451.4973958333333,y:269.5521240234375,step:1},{x:451.1067708333333,y:269.5521240234375,step:1},{x:450.8620198567708,y:269.583984375,step:1},{x:450.69010416666663,y:269.6314697265625,step:1},{x:450.1862386067708,y:272.6236572265625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:461.79166666666663,y:274.015625,step:2},{x:458.3515625,y:274.015625,step:0},{x:457.90360514322913,y:276.640625,step:0},{x:461.77860514322913,y:276.640625,step:0},{x:461.44657389322913,y:278.6067708333333,step:0},{x:455.48441569010413,y:278.6067708333333,step:0},{x:457.328125,y:267.82421875,step:0},{x:463.07291666666663,y:267.82421875,step:0},{x:462.7292073567708,y:269.7916259765625,step:0},{x:459.0703125,y:269.7916259765625,step:0},{x:458.66666666666663,y:272.08011881510413,step:0},{x:462.1380208333333,y:272.08011881510413,step:0},{x:461.79166666666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Bh=[{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f8eae7, #ffc6c6)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,0.2)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:281.60611979166663,y:288,step:2},{x:286.44403076171875,y:259.69205729166663,step:0},{x:292.83270263671875,y:259.69205729166663,step:0},{x:296.1966145833333,y:270.4856770833333,step:0},{x:297.21744791666663,y:274.0989583333333,step:1},{x:297.89711507161456,y:277.0377197265625,step:1},{x:298.50260416666663,y:280.1458333333333,step:1},{x:298.61588541666663,y:280.1458333333333,step:0},{x:298.72914632161456,y:277.2473958333333,step:1},{x:299.10744222005206,y:274.14066569010413,step:1},{x:299.78774007161456,y:269.9817708333333,step:1},{x:301.52604166666663,y:259.69205729166663,step:0},{x:306.62957763671875,y:259.69205729166663,step:0},{x:301.791015625,y:288,step:0},{x:296.15887451171875,y:288,step:0},{x:292.60546875,y:276.70182291666663,step:0},{x:291.47137451171875,y:272.837890625,step:1},{x:290.791015625,y:270.27604166666663,step:1},{x:290.1106974283854,y:266.83203125,step:1},{x:289.99737548828125,y:266.83203125,step:0},{x:289.73305257161456,y:269.6041259765625,step:1},{x:289.12760416666663,y:273.59375,step:1},{x:288.3724161783854,y:278.0885823567708,step:1},{x:286.67057291666663,y:288,step:0},{x:281.60611979166663,y:288,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:318.19596354166663,y:288.4622395833333,step:2},{x:311.58074951171875,y:288.4622395833333,step:1},{x:307.8763020833333,y:283.25394694010413,step:1},{x:307.8763020833333,y:276.66015625,step:1},{x:307.8763020833333,y:271.5364583333333,step:1},{x:309.57682291666663,y:266.4544270833333,step:1},{x:312.56378173828125,y:263.26236979166663,step:1},{x:314.9446614583333,y:260.7421875,step:1},{x:318.19596354166663,y:259.2298177083333,step:1},{x:321.86195882161456,y:259.2298177083333,step:1},{x:328.5911458333333,y:259.2298177083333,step:1},{x:332.14322916666663,y:264.27018229166663,step:1},{x:332.14322916666663,y:271.0325520833333,step:1},{x:332.14322916666663,y:276.1979573567708,step:1},{x:330.51822916666663,y:281.2369384765625,step:1},{x:327.60805257161456,y:284.3880208333333,step:1},{x:325.2265421549479,y:286.9505615234375,step:1},{x:322.0136515299479,y:288.4622395833333,step:1},{x:318.23307291666663,y:288.4622395833333,step:1},{x:318.19596354166663,y:288.4622395833333,step:0},{x:318.9895833333333,y:283.42191569010413,step:2},{x:320.6145833333333,y:283.42191569010413,step:1},{x:322.08854166666663,y:282.66666666666663,step:1},{x:323.26041666666663,y:281.3645833333333,step:1},{x:325.26430257161456,y:279.13798014322913,step:1},{x:326.3606974283854,y:274.4765218098958,step:1},{x:326.3606974283854,y:271.2005208333333,step:1},{x:326.3606974283854,y:267.6718343098958,step:1},{x:325.2265421549479,y:264.27018229166663,step:1},{x:321.2200520833333,y:264.27018229166663,step:1},{x:319.51822916666663,y:264.27018229166663,step:1},{x:318.00649007161456,y:265.06766764322913,step:1},{x:316.83465576171875,y:266.412109375,step:1},{x:314.79361979166663,y:268.6380208333333,step:1},{x:313.65948486328125,y:273.0481770833333,step:1},{x:313.65948486328125,y:276.4505208333333,step:1},{x:313.65948486328125,y:280.44010416666663,step:1},{x:315.28515625,y:283.42191569010413,step:1},{x:318.95182291666663,y:283.42191569010413,step:1},{x:318.9895833333333,y:283.42191569010413,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:340.64906819661456,y:264.98368326822913,step:2},{x:333.92055257161456,y:264.98368326822913,step:0},{x:334.865234375,y:259.69205729166663,step:0},{x:353.8033447265625,y:259.69205729166663,step:0},{x:352.8958740234375,y:264.98368326822913,step:0},{x:346.091796875,y:264.98368326822913,step:0},{x:342.16080729166663,y:288,step:0},{x:336.71744791666663,y:288,step:0},{x:340.64906819661456,y:264.98368326822913,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:366.0124104817708,y:280.64969889322913,step:2},{x:363.02604166666663,y:288,step:0},{x:357.2044270833333,y:288,step:0},{x:369.640625,y:259.69205729166663,step:0},{x:376.6341145833333,y:259.69205729166663,step:0},{x:379.58203125,y:288,step:0},{x:373.8743489583333,y:288,step:0},{x:373.3450520833333,y:280.64969889322913,step:0},{x:366.0124104817708,y:280.64969889322913,step:0},{x:373.11844889322913,y:276.0299886067708,step:2},{x:372.626953125,y:269.94010416666663,step:0},{x:372.513671875,y:268.38602701822913,step:1},{x:372.400390625,y:266.1184895833333,step:1},{x:372.2864583333333,y:264.3958333333333,step:1},{x:372.1731770833333,y:264.3958333333333,step:0},{x:371.5305989583333,y:266.1184895833333,step:1},{x:370.81254069010413,y:268.3020833333333,step:1},{x:370.1321614583333,y:269.94010416666663,step:1},{x:367.63736979166663,y:276.0299886067708,step:0},{x:373.11844889322913,y:276.0299886067708,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:387.06640625,y:260.1966552734375,step:2},{x:388.7292073567708,y:259.7337239583333,step:1},{x:391.2624104817708,y:259.4818115234375,step:1},{x:393.71940104166663,y:259.4818115234375,step:1},{x:396.0247395833333,y:259.4818115234375,step:1},{x:398.63346354166663,y:259.90234375,step:1},{x:400.4856770833333,y:261.3723958333333,step:1},{x:402.22391764322913,y:262.6321614583333,step:1},{x:403.2447509765625,y:264.6477864583333,step:1},{x:403.2447509765625,y:267.37760416666663,step:1},{x:403.2447509765625,y:270.94791666666663,step:1},{x:401.77079264322913,y:273.6783447265625,step:1},{x:399.8052978515625,y:275.35807291666663,step:1},{x:397.7259114583333,y:277.1640625,step:1},{x:394.7395833333333,y:278.00394694010413,step:1},{x:391.6399739583333,y:278.00394694010413,step:1},{x:390.73307291666663,y:278.00394694010413,step:1},{x:389.9771728515625,y:277.87760416666663,step:1},{x:389.41015625,y:277.8359375,step:1},{x:387.6712239583333,y:288,step:0},{x:382.3411458333333,y:288,step:0},{x:387.06640625,y:260.1966552734375,step:0},{x:390.2415364583333,y:272.8802490234375,step:2},{x:390.80863444010413,y:273.0058186848958,step:1},{x:391.4134114583333,y:273.0898030598958,step:1},{x:392.35807291666663,y:273.0898030598958,step:1},{x:395.609375,y:273.0898030598958,step:1},{x:397.763671875,y:270.7382405598958,step:1},{x:397.763671875,y:267.92447916666663,step:1},{x:397.763671875,y:265.19401041666663,step:1},{x:395.98697916666663,y:264.3118489583333,step:1},{x:393.908203125,y:264.3118489583333,step:1},{x:392.8880615234375,y:264.3118489583333,step:1},{x:392.13151041666663,y:264.3958333333333,step:1},{x:391.67838541666663,y:264.4798177083333,step:1},{x:390.2415364583333,y:272.8802490234375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:408.3847249348958,y:260.1966552734375,step:2},{x:410.0481770833333,y:259.7337239583333,step:1},{x:412.58072916666663,y:259.4818115234375,step:1},{x:415.0378011067708,y:259.4818115234375,step:1},{x:417.3437093098958,y:259.4818115234375,step:1},{x:419.9517822265625,y:259.90234375,step:1},{x:421.8033447265625,y:261.3723958333333,step:1},{x:423.5417073567708,y:262.6321614583333,step:1},{x:424.5638020833333,y:264.6477864583333,step:1},{x:424.5638020833333,y:267.37760416666663,step:1},{x:424.5638020833333,y:270.94791666666663,step:1},{x:423.08854166666663,y:273.6783447265625,step:1},{x:421.12369791666663,y:275.35807291666663,step:1},{x:419.0442708333333,y:277.1640625,step:1},{x:416.05729166666663,y:278.00394694010413,step:1},{x:412.9583740234375,y:278.00394694010413,step:1},{x:412.0520833333333,y:278.00394694010413,step:1},{x:411.2956136067708,y:277.87760416666663,step:1},{x:410.7292073567708,y:277.8359375,step:1},{x:408.9896240234375,y:288,step:0},{x:403.66019694010413,y:288,step:0},{x:408.3847249348958,y:260.1966552734375,step:0},{x:411.5598958333333,y:272.8802490234375,step:2},{x:412.12760416666663,y:273.0058186848958,step:1},{x:412.7317708333333,y:273.0898030598958,step:1},{x:413.67704264322913,y:273.0898030598958,step:1},{x:416.9270833333333,y:273.0898030598958,step:1},{x:419.08203125,y:270.7382405598958,step:1},{x:419.08203125,y:267.92447916666663,step:1},{x:419.08203125,y:265.19401041666663,step:1},{x:417.3059895833333,y:264.3118489583333,step:1},{x:415.2265625,y:264.3118489583333,step:1},{x:414.20572916666663,y:264.3118489583333,step:1},{x:413.45048014322913,y:264.3958333333333,step:1},{x:412.9974365234375,y:264.4798177083333,step:1},{x:411.5598958333333,y:272.8802490234375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:429.77860514322913,y:260.1966552734375,step:2},{x:431.4792073567708,y:259.7337239583333,step:1},{x:434.0494384765625,y:259.4818115234375,step:1},{x:436.58329264322913,y:259.4818115234375,step:1},{x:439.00260416666663,y:259.4818115234375,step:1},{x:441.4973958333333,y:259.8606770833333,step:1},{x:443.2734375,y:261.11979166666663,step:1},{x:444.9362386067708,y:262.2122395833333,step:1},{x:446.10807291666663,y:263.9759114583333,step:1},{x:446.10807291666663,y:266.6223958333333,step:1},{x:446.10807291666663,y:270.82230631510413,step:1},{x:443.6145833333333,y:273.46879069010413,step:1},{x:440.3255208333333,y:274.64322916666663,step:1},{x:440.3255208333333,y:274.7708333333333,step:0},{x:441.83719889322913,y:275.5260823567708,step:1},{x:442.5181884765625,y:277.37369791666663,step:1},{x:442.7447509765625,y:279.93619791666663,step:1},{x:443.08463541666663,y:283.12760416666663,step:1},{x:443.2734375,y:286.82425944010413,step:1},{x:443.7265625,y:288,step:1},{x:438.1328125,y:288,step:0},{x:437.90625,y:287.24479166666663,step:1},{x:437.640625,y:284.8073323567708,step:1},{x:437.4140625,y:281.3229573567708,step:1},{x:437.1497395833333,y:277.87760416666663,step:1},{x:436.0911458333333,y:276.82816569010413,step:1},{x:433.9374593098958,y:276.82816569010413,step:1},{x:432.27347819010413,y:276.82816569010413,step:0},{x:430.3841145833333,y:288,step:0},{x:425.01566569010413,y:288,step:0},{x:429.77860514322913,y:260.1966552734375,step:0},{x:433.1054280598958,y:272.2916259765625,step:2},{x:435.3359375,y:272.2916259765625,step:0},{x:438.2838948567708,y:272.2916259765625,step:1},{x:440.43876139322913,y:270.31766764322913,step:1},{x:440.43876139322913,y:267.54557291666663,step:1},{x:440.43876139322913,y:265.2362874348958,step:1},{x:438.73697916666663,y:264.2279052734375,step:1},{x:436.5442708333333,y:264.2279052734375,step:1},{x:435.5247395833333,y:264.2279052734375,step:1},{x:434.88151041666663,y:264.3118489583333,step:1},{x:434.42838541666663,y:264.4381103515625,step:1},{x:433.1054280598958,y:272.2916259765625,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:458.43094889322913,y:288.4622395833333,step:2},{x:451.81510416666663,y:288.4622395833333,step:1},{x:448.1119384765625,y:283.25394694010413,step:1},{x:448.1119384765625,y:276.66015625,step:1},{x:448.1119384765625,y:271.5364583333333,step:1},{x:449.8125,y:266.4544270833333,step:1},{x:452.79947916666663,y:263.26236979166663,step:1},{x:455.1796468098958,y:260.7421875,step:1},{x:458.43094889322913,y:259.2298177083333,step:1},{x:462.09765625,y:259.2298177083333,step:1},{x:468.8255208333333,y:259.2298177083333,step:1},{x:472.3802083333333,y:264.27018229166663,step:1},{x:472.3802083333333,y:271.0325520833333,step:1},{x:472.3802083333333,y:276.1979573567708,step:1},{x:470.75390625,y:281.2369384765625,step:1},{x:467.8437093098958,y:284.3880208333333,step:1},{x:465.4622802734375,y:286.9505615234375,step:1},{x:462.24869791666663,y:288.4622395833333,step:1},{x:458.4687093098958,y:288.4622395833333,step:1},{x:458.43094889322913,y:288.4622395833333,step:0},{x:459.22391764322913,y:283.42191569010413,step:2},{x:460.85026041666663,y:283.42191569010413,step:1},{x:462.32421875,y:282.66666666666663,step:1},{x:463.49609375,y:281.3645833333333,step:1},{x:465.5,y:279.13798014322913,step:1},{x:466.59635416666663,y:274.4765218098958,step:1},{x:466.59635416666663,y:271.2005208333333,step:1},{x:466.59635416666663,y:267.6718343098958,step:1},{x:465.4622802734375,y:264.27018229166663,step:1},{x:461.45572916666663,y:264.27018229166663,step:1},{x:459.75390625,y:264.27018229166663,step:1},{x:458.2421875,y:265.06766764322913,step:1},{x:457.0703125,y:266.412109375,step:1},{x:455.0286865234375,y:268.6380208333333,step:1},{x:453.8958333333333,y:273.0481770833333,step:1},{x:453.8958333333333,y:276.4505208333333,step:1},{x:453.8958333333333,y:280.44010416666663,step:1},{x:455.5208740234375,y:283.42191569010413,step:1},{x:459.1875,y:283.42191569010413,step:1},{x:459.22391764322913,y:283.42191569010413,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:478.8046875,y:288,step:2},{x:475.6302490234375,y:259.69205729166663,step:0},{x:481.2630208333333,y:259.69205729166663,step:0},{x:482.3958740234375,y:273.1737874348958,step:0},{x:482.6614583333333,y:276.1979573567708,step:1},{x:482.8489990234375,y:278.9284261067708,step:1},{x:483.0013020833333,y:281.8684895833333,step:1},{x:483.07682291666663,y:281.8684895833333,step:0},{x:484.0208740234375,y:279.09635416666663,step:1},{x:485.23173014322913,y:276.07291666666663,step:1},{x:486.47916666666663,y:273.13151041666663,step:1},{x:492.1862386067708,y:259.69205729166663,step:0},{x:498.27213541666663,y:259.69205729166663,step:0},{x:485.1171468098958,y:288,step:0},{x:478.8046875,y:288,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:512.9766031901041,y:275.9466145833333,step:2},{x:503.94266764322913,y:275.9466145833333,step:0},{x:502.7708333333333,y:282.8333333333333,step:0},{x:512.9388020833333,y:282.8333333333333,step:0},{x:512.0690104166666,y:288,step:0},{x:496.4192708333333,y:288,step:0},{x:501.2578125,y:259.69205729166663,step:0},{x:516.3411458333333,y:259.69205729166663,step:0},{x:515.4323323567708,y:264.85807291666663,step:0},{x:505.83203125,y:264.85807291666663,step:0},{x:504.7734375,y:270.8646240234375,step:0},{x:513.8828125,y:270.8646240234375,step:0},{x:512.9766031901041,y:275.9466145833333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:520.7252604166666,y:260.1119384765625,step:2},{x:522.9166259765625,y:259.69205729166663,step:1},{x:525.2994791666666,y:259.4818115234375,step:1},{x:527.7942708333333,y:259.4818115234375,step:1},{x:531.7630208333333,y:259.4818115234375,step:1},{x:534.8997395833333,y:260.4901936848958,step:1},{x:537.0547281901041,y:262.5482177734375,step:1},{x:539.1340738932291,y:264.3958333333333,step:1},{x:540.4192708333333,y:267.20963541666663,step:1},{x:540.4192708333333,y:271.4101155598958,step:1},{x:540.4192708333333,y:276.86979166666663,step:1},{x:538.33984375,y:281.61588541666663,step:1},{x:535.203125,y:284.4296875,step:1},{x:532.25390625,y:287.0755208333333,step:1},{x:528.5116780598958,y:288.20963541666663,step:1},{x:522.9935302734375,y:288.20963541666663,step:1},{x:519.9309895833333,y:288.20963541666663,step:1},{x:517.2851155598958,y:287.91666666666663,step:1},{x:516,y:287.6223958333333,step:1},{x:520.7252604166666,y:260.1119384765625,step:0},{x:522.2747802734375,y:283.1692708333333,step:2},{x:522.9166259765625,y:283.25394694010413,step:1},{x:523.7109375,y:283.29557291666663,step:1},{x:524.65625,y:283.29557291666663,step:1},{x:527.6041666666666,y:283.29557291666663,step:1},{x:530.2135416666666,y:282.11979166666663,step:1},{x:531.8763020833333,y:280.0208333333333,step:1},{x:533.6145833333333,y:277.7942708333333,step:1},{x:534.5221354166666,y:274.85416666666663,step:1},{x:534.5221354166666,y:271.45182291666663,step:1},{x:534.5221354166666,y:266.95829264322913,step:1},{x:532.2917073567708,y:264.3118489583333,step:1},{x:527.7942708333333,y:264.3118489583333,step:1},{x:526.8489990234375,y:264.3118489583333,step:1},{x:526.0547281901041,y:264.3958333333333,step:1},{x:525.4870198567708,y:264.52213541666663,step:1},{x:522.2747802734375,y:283.1692708333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Uh=[{type:"path",stampPoints:[{x:420.5598958333333,y:265.5247395833333,step:2},{x:416.81119791666663,y:261.8561604817708,step:0},{x:409.3333333333333,y:269.3333333333333,step:0},{x:401.9127197265625,y:261.912109375,step:0},{x:398.3177490234375,y:265.50846354166663,step:0},{x:405.7382405598958,y:272.9290364583333,step:0},{x:398.3151448567708,y:280.3515218098958,step:0},{x:402.0638020833333,y:284.01822916666663,step:0},{x:409.48832194010413,y:276.5989583333333,step:0},{x:416.95703125,y:284.06766764322913,step:0},{x:420.5520833333333,y:280.4713134765625,step:0},{x:413.08203125,y:273.0032552083333,step:0},{x:420.5598958333333,y:265.5247395833333,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,1)",background:"linear-gradient(to right bottom, #f89077, #b21f10)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:420.5598958333333,y:265.5247395833333,step:2},{x:416.81119791666663,y:261.8561604817708,step:0},{x:409.3333333333333,y:269.3333333333333,step:0},{x:401.9127197265625,y:261.912109375,step:0},{x:398.3177490234375,y:265.50846354166663,step:0},{x:405.7382405598958,y:272.9290364583333,step:0},{x:398.3151448567708,y:280.3515218098958,step:0},{x:402.0638020833333,y:284.01822916666663,step:0},{x:409.48832194010413,y:276.5989583333333,step:0},{x:416.95703125,y:284.06766764322913,step:0},{x:420.5520833333333,y:280.4713134765625,step:0},{x:413.08203125,y:273.0032552083333,step:0},{x:420.5598958333333,y:265.5247395833333,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Lh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(110,0,5,1)",background:"linear-gradient(to right bottom, #f89077, #cc4a31)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:397.2669270833333,y:276.1119384765625,step:2},{x:397.8430989583333,y:276.4791259765625,step:1},{x:398.64908854166663,y:276.78385416666663,step:1},{x:399.556640625,y:276.78385416666663,step:1},{x:400.3483479817708,y:276.78385416666663,step:1},{x:401.08268229166663,y:276.3671875,step:1},{x:401.08268229166663,y:275.5364583333333,step:1},{x:401.08268229166663,y:274.9114583333333,step:1},{x:400.6653645833333,y:274.5286458333333,step:1},{x:399.77274576822913,y:274,step:1},{x:398.75,y:273.3919270833333,step:1},{x:397.77079264322913,y:272.5598958333333,step:1},{x:397.77079264322913,y:271.16796875,step:1},{x:397.77079264322913,y:268.9921875,step:1},{x:399.4700520833333,y:267.6640625,step:1},{x:401.5865478515625,y:267.6640625,step:1},{x:402.75321451822913,y:267.6640625,step:1},{x:403.44462076822913,y:267.95182291666663,step:1},{x:403.86258951822913,y:268.1920979817708,step:1},{x:403.2141927083333,y:270.111328125,step:0},{x:402.8977864583333,y:269.919921875,step:1},{x:402.220703125,y:269.6314697265625,step:1},{x:401.4140625,y:269.6477864583333,step:1},{x:400.4491780598958,y:269.6477864583333,step:1},{x:399.9452718098958,y:270.17582194010413,step:1},{x:399.9452718098958,y:270.767578125,step:1},{x:399.9452718098958,y:271.3919270833333,step:1},{x:400.53580729166663,y:271.775390625,step:1},{x:401.35611979166663,y:272.28776041666663,step:1},{x:402.53776041666663,y:272.9759114583333,step:1},{x:403.2720947265625,y:273.83984375,step:1},{x:403.2720947265625,y:275.13541666666663,step:1},{x:403.2720947265625,y:277.5364583333333,step:1},{x:401.48636881510413,y:278.7682698567708,step:1},{x:399.34049479166663,y:278.7682698567708,step:1},{x:398.0013020833333,y:278.75260416666663,step:1},{x:397.0221761067708,y:278.3671875,step:1},{x:396.5755208333333,y:278,step:1},{x:397.2669270833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:408.052734375,y:267.82421875,step:2},{x:406.20963541666663,y:278.6067708333333,step:0},{x:404.1361083984375,y:278.6067708333333,step:0},{x:405.97916666666663,y:267.82421875,step:0},{x:408.052734375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:416.1302083333333,y:278.1119384765625,step:2},{x:415.3958740234375,y:278.3827718098958,step:1},{x:414.2161458333333,y:278.71879069010413,step:1},{x:412.9921875,y:278.71879069010413,step:1},{x:411.66666666666663,y:278.71879069010413,step:1},{x:410.5572509765625,y:278.3358968098958,step:1},{x:409.765625,y:277.5364583333333,step:1},{x:408.98832194010413,y:276.78385416666663,step:1},{x:408.5423177083333,y:275.5833333333333,step:1},{x:408.5423177083333,y:274.2083333333333,step:1},{x:408.5423177083333,y:272.1920979817708,step:1},{x:409.27665201822913,y:270.44791666666663,step:1},{x:410.515625,y:269.279296875,step:1},{x:411.609375,y:268.2714436848958,step:1},{x:413.12109375,y:267.7115478515625,step:1},{x:414.8059895833333,y:267.7115478515625,step:1},{x:416.05859375,y:267.7115478515625,step:1},{x:416.9948323567708,y:267.98368326822913,step:1},{x:417.3697509765625,y:268.1920979817708,step:1},{x:416.75,y:270.1438802083333,step:0},{x:416.3177490234375,y:269.919921875,step:1},{x:415.55472819010413,y:269.69596354166663,step:1},{x:414.69010416666663,y:269.69596354166663,step:1},{x:413.7265625,y:269.69596354166663,step:1},{x:412.8763020833333,y:270,step:1},{x:412.2292073567708,y:270.5598958333333,step:1},{x:411.37890625,y:271.29557291666663,step:1},{x:410.8177490234375,y:272.57621256510413,step:1},{x:410.8177490234375,y:274.04691569010413,step:1},{x:410.8177490234375,y:275.8567708333333,step:1},{x:411.7812093098958,y:276.7682698567708,step:1},{x:413.3072509765625,y:276.7682698567708,step:1},{x:413.796875,y:276.7682698567708,step:1},{x:414.12894694010413,y:276.6875,step:1},{x:414.37504069010413,y:276.5755208333333,step:1},{x:414.7630615234375,y:274.3046468098958,step:0},{x:413.2499593098958,y:274.3046468098958,step:0},{x:413.58203125,y:272.46354166666663,step:0},{x:417.109375,y:272.46354166666663,step:0},{x:416.1302083333333,y:278.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:417.81510416666663,y:278.6067708333333,step:2},{x:419.65885416666663,y:267.82421875,step:0},{x:422.09244791666663,y:267.82421875,step:0},{x:423.37504069010413,y:271.935546875,step:0},{x:423.7630208333333,y:273.3118489583333,step:1},{x:424.0221761067708,y:274.4322509765625,step:1},{x:424.25260416666663,y:275.6145833333333,step:1},{x:424.2956136067708,y:275.6145833333333,step:0},{x:424.3385009765625,y:274.51298014322913,step:1},{x:424.4817708333333,y:273.32816569010413,step:1},{x:424.7421875,y:271.744140625,step:1},{x:425.4036458333333,y:267.82421875,step:0},{x:427.3489990234375,y:267.82421875,step:0},{x:425.50516764322913,y:278.6067708333333,step:0},{x:423.359375,y:278.6067708333333,step:0},{x:422.00516764322913,y:274.3046468098958,step:0},{x:421.5729573567708,y:272.83203125,step:1},{x:421.31510416666663,y:271.8561604817708,step:1},{x:421.05472819010413,y:270.5435791015625,step:1},{x:421.0130208333333,y:270.5435791015625,step:0},{x:420.91141764322913,y:271.599609375,step:1},{x:420.6809895833333,y:273.11979166666663,step:1},{x:420.39322916666663,y:274.83203125,step:1},{x:419.7447509765625,y:278.6067708333333,step:0},{x:417.81510416666663,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:433.97135416666663,y:267.82421875,step:2},{x:433.25260416666663,y:272.0163167317708,step:0},{x:436.76566569010413,y:272.0163167317708,step:0},{x:437.48441569010413,y:267.82421875,step:0},{x:439.5729573567708,y:267.82421875,step:0},{x:437.7292073567708,y:278.6067708333333,step:0},{x:435.65629069010413,y:278.6067708333333,step:0},{x:436.4192708333333,y:274.0638020833333,step:0},{x:432.8905843098958,y:274.0638020833333,step:0},{x:432.12760416666663,y:278.6067708333333,step:0},{x:430.05472819010413,y:278.6067708333333,step:0},{x:431.8983968098958,y:267.82421875,step:0},{x:433.97135416666663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.9530843098958,y:274.015625,step:2},{x:442.5103759765625,y:274.015625,step:0},{x:442.06510416666663,y:276.640625,step:0},{x:445.9374593098958,y:276.640625,step:0},{x:445.6068115234375,y:278.6067708333333,step:0},{x:439.6458740234375,y:278.6067708333333,step:0},{x:441.48832194010413,y:267.82421875,step:0},{x:447.234375,y:267.82421875,step:0},{x:446.8880615234375,y:269.7916259765625,step:0},{x:443.23173014322913,y:269.7916259765625,step:0},{x:442.828125,y:272.08011881510413,step:0},{x:446.29691569010413,y:272.08011881510413,step:0},{x:445.9530843098958,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:448.9192708333333,y:268.0163167317708,step:2},{x:449.5677490234375,y:267.83984375,step:1},{x:450.546875,y:267.744140625,step:1},{x:451.51041666666663,y:267.744140625,step:1},{x:452.43229166666663,y:267.744140625,step:1},{x:453.3827718098958,y:267.8880615234375,step:1},{x:454.0598958333333,y:268.36783854166663,step:1},{x:454.6927083333333,y:268.78385416666663,step:1},{x:455.1405843098958,y:269.45572916666663,step:1},{x:455.1405843098958,y:270.46354166666663,step:1},{x:455.1405843098958,y:272.0638020833333,step:1},{x:454.1888427734375,y:273.07157389322913,step:1},{x:452.9375,y:273.5208333333333,step:1},{x:452.9375,y:273.5677083333333,step:0},{x:453.5130208333333,y:273.8567708333333,step:1},{x:453.77079264322913,y:274.5598958333333,step:1},{x:453.8580322265625,y:275.5364583333333,step:1},{x:453.98697916666663,y:276.75260416666663,step:1},{x:454.0598958333333,y:278.1588948567708,step:1},{x:454.2317708333333,y:278.6067708333333,step:1},{x:452.1015625,y:278.6067708333333,step:0},{x:452.01566569010413,y:278.3203125,step:1},{x:451.9140625,y:277.3919270833333,step:1},{x:451.828125,y:276.0638020833333,step:1},{x:451.7265625,y:274.75260416666663,step:1},{x:451.32291666666663,y:274.3515218098958,step:1},{x:450.50260416666663,y:274.3515218098958,step:1},{x:449.86979166666663,y:274.3515218098958,step:0},{x:449.1484375,y:278.6067708333333,step:0},{x:447.1041259765625,y:278.6067708333333,step:0},{x:448.9192708333333,y:268.0163167317708,step:0},{x:450.1862386067708,y:272.6236572265625,step:2},{x:451.0364583333333,y:272.6236572265625,step:0},{x:452.15885416666663,y:272.6236572265625,step:1},{x:452.9792073567708,y:271.87174479166663,step:1},{x:452.9792073567708,y:270.8157958984375,step:1},{x:452.9792073567708,y:269.935546875,step:1},{x:452.3307698567708,y:269.5521240234375,step:1},{x:451.4973958333333,y:269.5521240234375,step:1},{x:451.1067708333333,y:269.5521240234375,step:1},{x:450.8620198567708,y:269.583984375,step:1},{x:450.69010416666663,y:269.6314697265625,step:1},{x:450.1862386067708,y:272.6236572265625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:461.79166666666663,y:274.015625,step:2},{x:458.3515625,y:274.015625,step:0},{x:457.90360514322913,y:276.640625,step:0},{x:461.77860514322913,y:276.640625,step:0},{x:461.44657389322913,y:278.6067708333333,step:0},{x:455.48441569010413,y:278.6067708333333,step:0},{x:457.328125,y:267.82421875,step:0},{x:463.07291666666663,y:267.82421875,step:0},{x:462.7292073567708,y:269.7916259765625,step:0},{x:459.0703125,y:269.7916259765625,step:0},{x:458.66666666666663,y:272.08011881510413,step:0},{x:462.1380208333333,y:272.08011881510413,step:0},{x:461.79166666666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Oh=[{type:"path",stampPoints:[{x:465.87760416666663,y:290.62760416666663,step:2},{x:465.87760416666663,y:296.4948323567708,step:1},{x:461.0780843098958,y:301.2942708333333,step:1},{x:455.2109375,y:301.2942708333333,step:1},{x:363.1640625,y:301.2942708333333,step:0},{x:357.2974853515625,y:301.2942708333333,step:1},{x:352.4973958333333,y:296.4948323567708,step:1},{x:352.4973958333333,y:290.62760416666663,step:1},{x:352.4973958333333,y:253.63081868489581,step:0},{x:352.4973958333333,y:247.7642822265625,step:1},{x:357.2974853515625,y:242.96415201822916,step:1},{x:363.1640625,y:242.96415201822916,step:1},{x:455.2109375,y:242.96415201822916,step:0},{x:461.0780843098958,y:242.96415201822916,step:1},{x:465.87760416666663,y:247.7642822265625,step:1},{x:465.87760416666663,y:253.63081868489581,step:1},{x:465.87760416666663,y:290.62760416666663,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f8eae7, #ffc6c6)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:465.87760416666663,y:290.62760416666663,step:2},{x:465.87760416666663,y:296.4948323567708,step:1},{x:461.0780843098958,y:301.2942708333333,step:1},{x:455.2109375,y:301.2942708333333,step:1},{x:363.1640625,y:301.2942708333333,step:0},{x:357.2974853515625,y:301.2942708333333,step:1},{x:352.4973958333333,y:296.4948323567708,step:1},{x:352.4973958333333,y:290.62760416666663,step:1},{x:352.4973958333333,y:253.63081868489581,step:0},{x:352.4973958333333,y:247.7642822265625,step:1},{x:357.2974853515625,y:242.96415201822916,step:1},{x:363.1640625,y:242.96415201822916,step:1},{x:455.2109375,y:242.96415201822916,step:0},{x:461.0780843098958,y:242.96415201822916,step:1},{x:465.87760416666663,y:247.7642822265625,step:1},{x:465.87760416666663,y:253.63081868489581,step:1},{x:465.87760416666663,y:290.62760416666663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:371.2519124348958,y:286.9765625,step:2},{x:368.0761311848958,y:258.6692708333333,step:0},{x:373.708984375,y:258.6692708333333,step:0},{x:374.84183756510413,y:272.15043131510413,step:0},{x:375.1073811848958,y:275.17447916666663,step:1},{x:375.2962239583333,y:277.90360514322913,step:1},{x:375.447265625,y:280.8450520833333,step:1},{x:375.5228271484375,y:280.8450520833333,step:0},{x:376.46805826822913,y:278.07291666666663,step:1},{x:377.677734375,y:275.0494384765625,step:1},{x:378.923828125,y:272.1087239583333,step:1},{x:384.6321614583333,y:258.6692708333333,step:0},{x:390.71805826822913,y:258.6692708333333,step:0},{x:377.564453125,y:286.9765625,step:0},{x:371.2519124348958,y:286.9765625,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:399.7519124348958,y:287.4388427734375,step:2},{x:393.1373291015625,y:287.4388427734375,step:1},{x:389.4329427083333,y:282.2318115234375,step:1},{x:389.4329427083333,y:275.63798014322913,step:1},{x:389.4329427083333,y:270.51298014322913,step:1},{x:391.1347249348958,y:265.4309895833333,step:1},{x:394.1204427083333,y:262.2389729817708,step:1},{x:396.501953125,y:259.7193603515625,step:1},{x:399.7519124348958,y:258.20768229166663,step:1},{x:403.4185791015625,y:258.20768229166663,step:1},{x:410.14847819010413,y:258.20768229166663,step:1},{x:413.7005615234375,y:263.2473958333333,step:1},{x:413.7005615234375,y:270.0091552734375,step:1},{x:413.7005615234375,y:275.17447916666663,step:1},{x:412.0755208333333,y:280.2161865234375,step:1},{x:409.1634114583333,y:283.3645833333333,step:1},{x:406.7831624348958,y:285.9270833333333,step:1},{x:403.5697021484375,y:287.4388427734375,step:1},{x:399.791015625,y:287.4388427734375,step:1},{x:399.7519124348958,y:287.4388427734375,step:0},{x:400.5462239583333,y:282.3984375,step:2},{x:402.1712239583333,y:282.3984375,step:1},{x:403.646484375,y:281.64322916666663,step:1},{x:404.818359375,y:280.3411458333333,step:1},{x:406.8210042317708,y:278.1145833333333,step:1},{x:407.91727701822913,y:273.453125,step:1},{x:407.91727701822913,y:270.1771240234375,step:1},{x:407.91727701822913,y:266.64908854166663,step:1},{x:406.7831624348958,y:263.2473958333333,step:1},{x:402.7753499348958,y:263.2473958333333,step:1},{x:401.0761311848958,y:263.2473958333333,step:1},{x:399.5631917317708,y:264.044921875,step:1},{x:398.39127604166663,y:265.38871256510413,step:1},{x:396.3509114583333,y:267.6145833333333,step:1},{x:395.21683756510413,y:272.0247395833333,step:1},{x:395.21683756510413,y:275.4270833333333,step:1},{x:395.21683756510413,y:279.4167073567708,step:1},{x:396.84183756510413,y:282.3984375,step:1},{x:400.50846354166663,y:282.3984375,step:1},{x:400.5462239583333,y:282.3984375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:425.1536458333333,y:258.6692708333333,step:2},{x:420.3151448567708,y:286.9765625,step:0},{x:414.8723958333333,y:286.9765625,step:0},{x:419.7109375,y:258.6692708333333,step:0},{x:425.1536458333333,y:258.6692708333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:430.10416666666663,y:259.0892333984375,step:2},{x:432.29691569010413,y:258.6692708333333,step:1},{x:434.6796875,y:258.458984375,step:1},{x:437.1744384765625,y:258.458984375,step:1},{x:441.1431884765625,y:258.458984375,step:1},{x:444.2786458333333,y:259.46683756510413,step:1},{x:446.43485514322913,y:261.5247395833333,step:1},{x:448.51298014322913,y:263.373046875,step:1},{x:449.79947916666663,y:266.1868896484375,step:1},{x:449.79947916666663,y:270.38736979166663,step:1},{x:449.79947916666663,y:275.8463134765625,step:1},{x:447.71875,y:280.59375,step:1},{x:444.58072916666663,y:283.40625,step:1},{x:441.6328125,y:286.0521240234375,step:1},{x:437.8905843098958,y:287.1874593098958,step:1},{x:432.3724365234375,y:287.1874593098958,step:1},{x:429.3098958333333,y:287.1874593098958,step:1},{x:426.6640625,y:286.89322916666663,step:1},{x:425.3802083333333,y:286.5989583333333,step:1},{x:430.10416666666663,y:259.0892333984375,step:0},{x:431.6536865234375,y:282.1458333333333,step:2},{x:432.29691569010413,y:282.2318115234375,step:1},{x:433.0911458333333,y:282.2734375,step:1},{x:434.03641764322913,y:282.2734375,step:1},{x:436.98441569010413,y:282.2734375,step:1},{x:439.59375,y:281.09635416666663,step:1},{x:441.2552083333333,y:278.9973958333333,step:1},{x:442.9948323567708,y:276.7708333333333,step:1},{x:443.90104166666663,y:273.83072916666663,step:1},{x:443.90104166666663,y:270.42899576822913,step:1},{x:443.90104166666663,y:265.9348958333333,step:1},{x:441.6718343098958,y:263.28971354166663,step:1},{x:437.1744384765625,y:263.28971354166663,step:1},{x:436.2292073567708,y:263.28971354166663,step:1},{x:435.4348958333333,y:263.373046875,step:1},{x:434.8671875,y:263.4993489583333,step:1},{x:431.6536865234375,y:282.1458333333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Wh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(213,177,66,1)",background:"linear-gradient(to right bottom, #f7fc93, #f8fb4f)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:409.1328125,y:278.6067708333333,step:2},{x:408.75846354166663,y:267.82421875,step:0},{x:410.8606770833333,y:267.82421875,step:0},{x:410.8606770833333,y:272.6236572265625,step:0},{x:410.8606770833333,y:273.9348958333333,step:1},{x:410.83203125,y:275.1510009765625,step:1},{x:410.80338541666663,y:276.12760416666663,step:1},{x:410.83203125,y:276.12760416666663,step:0},{x:411.17704264322913,y:275.07157389322913,step:1},{x:411.52347819010413,y:273.9674886067708,step:1},{x:411.96875,y:272.6555989583333,step:1},{x:413.7109375,y:267.82421875,step:0},{x:415.98697916666663,y:267.82421875,step:0},{x:415.9583333333333,y:272.6399739583333,step:0},{x:415.9439697265625,y:273.9348958333333,step:1},{x:415.9140625,y:275.0078125,step:1},{x:415.8567708333333,y:276.0638020833333,step:1},{x:415.88541666666663,y:276.0638020833333,step:0},{x:416.21744791666663,y:274.9427083333333,step:1},{x:416.5780843098958,y:273.7916259765625,step:1},{x:416.9661458333333,y:272.6236572265625,step:1},{x:418.6366780598958,y:267.82421875,step:0},{x:420.8255208333333,y:267.82421875,step:0},{x:416.54947916666663,y:278.6067708333333,step:0},{x:414.28910319010413,y:278.6067708333333,step:0},{x:414.23050944010413,y:274.1927490234375,step:0},{x:414.2161458333333,y:272.912109375,step:1},{x:414.2447509765625,y:271.82421875,step:1},{x:414.3020833333333,y:270.607421875,step:1},{x:414.27347819010413,y:270.607421875,step:0},{x:413.9270833333333,y:271.759765625,step:1},{x:413.58203125,y:272.927734375,step:1},{x:413.1067708333333,y:274.2396240234375,step:1},{x:411.4375,y:278.6067708333333,step:0},{x:409.1328125,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:424.0234375,y:267.82421875,step:2},{x:422.1796875,y:278.6067708333333,step:0},{x:420.10546875,y:278.6067708333333,step:0},{x:421.9478759765625,y:267.82421875,step:0},{x:424.0234375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:427.3489990234375,y:269.83984375,step:2},{x:424.7851155598958,y:269.83984375,step:0},{x:425.1458333333333,y:267.82421875,step:0},{x:432.359375,y:267.82421875,step:0},{x:432.01432291666663,y:269.83984375,step:0},{x:429.421875,y:269.83984375,step:0},{x:427.92447916666663,y:278.6067708333333,step:0},{x:425.8515218098958,y:278.6067708333333,step:0},{x:427.3489990234375,y:269.83984375,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:431.6823323567708,y:278.6067708333333,step:2},{x:433.52604166666663,y:267.82421875,step:0},{x:435.95963541666663,y:267.82421875,step:0},{x:437.2421875,y:271.935546875,step:0},{x:437.6302490234375,y:273.3118489583333,step:1},{x:437.88932291666663,y:274.4322509765625,step:1},{x:438.1197509765625,y:275.6145833333333,step:1},{x:438.16276041666663,y:275.6145833333333,step:0},{x:438.20572916666663,y:274.51298014322913,step:1},{x:438.3503011067708,y:273.32816569010413,step:1},{x:438.6093343098958,y:271.744140625,step:1},{x:439.27079264322913,y:267.82421875,step:0},{x:441.2161458333333,y:267.82421875,step:0},{x:439.3723958333333,y:278.6067708333333,step:0},{x:437.2265625,y:278.6067708333333,step:0},{x:435.8723958333333,y:274.3046468098958,step:0},{x:435.44010416666663,y:272.83203125,step:1},{x:435.18229166666663,y:271.8561604817708,step:1},{x:434.921875,y:270.5435791015625,step:1},{x:434.8802083333333,y:270.5435791015625,step:0},{x:434.77860514322913,y:271.599609375,step:1},{x:434.5481770833333,y:273.11979166666663,step:1},{x:434.26041666666663,y:274.83203125,step:1},{x:433.61197916666663,y:278.6067708333333,step:0},{x:431.6823323567708,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:447.58072916666663,y:274.015625,step:2},{x:444.1380208333333,y:274.015625,step:0},{x:443.6927083333333,y:276.640625,step:0},{x:447.56510416666663,y:276.640625,step:0},{x:447.234375,y:278.6067708333333,step:0},{x:441.2734375,y:278.6067708333333,step:0},{x:443.1171468098958,y:267.82421875,step:0},{x:448.8620198567708,y:267.82421875,step:0},{x:448.515625,y:269.7916259765625,step:0},{x:444.859375,y:269.7916259765625,step:0},{x:444.45572916666663,y:272.08011881510413,step:0},{x:447.92578125,y:272.08011881510413,step:0},{x:447.58072916666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:449.1497395833333,y:276.1119384765625,step:2},{x:449.7265625,y:276.4791259765625,step:1},{x:450.5312093098958,y:276.78385416666663,step:1},{x:451.44010416666663,y:276.78385416666663,step:1},{x:452.2317708333333,y:276.78385416666663,step:1},{x:452.9661458333333,y:276.3671875,step:1},{x:452.9661458333333,y:275.5364583333333,step:1},{x:452.9661458333333,y:274.9114583333333,step:1},{x:452.546875,y:274.5286458333333,step:1},{x:451.65629069010413,y:274,step:1},{x:450.6328125,y:273.3919270833333,step:1},{x:449.6536865234375,y:272.5598958333333,step:1},{x:449.6536865234375,y:271.16796875,step:1},{x:449.6536865234375,y:268.9921875,step:1},{x:451.3529052734375,y:267.6640625,step:1},{x:453.46875,y:267.6640625,step:1},{x:454.63541666666663,y:267.6640625,step:1},{x:455.328125,y:267.95182291666663,step:1},{x:455.7447509765625,y:268.1920979817708,step:1},{x:455.09635416666663,y:270.111328125,step:0},{x:454.7812093098958,y:269.919921875,step:1},{x:454.10416666666663,y:269.6314697265625,step:1},{x:453.29691569010413,y:269.6477864583333,step:1},{x:452.33207194010413,y:269.6477864583333,step:1},{x:451.828125,y:270.17582194010413,step:1},{x:451.828125,y:270.767578125,step:1},{x:451.828125,y:271.3919270833333,step:1},{x:452.4192708333333,y:271.775390625,step:1},{x:453.2395833333333,y:272.28776041666663,step:1},{x:454.4192708333333,y:272.9759114583333,step:1},{x:455.1536458333333,y:273.83984375,step:1},{x:455.1536458333333,y:275.13541666666663,step:1},{x:455.1536458333333,y:277.5364583333333,step:1},{x:453.3697509765625,y:278.7682698567708,step:1},{x:451.22391764322913,y:278.7682698567708,step:1},{x:449.8841145833333,y:278.75260416666663,step:1},{x:448.90494791666663,y:278.3671875,step:1},{x:448.4583333333333,y:278,step:1},{x:449.1497395833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:456.4934895833333,y:276.1119384765625,step:2},{x:457.0703125,y:276.4791259765625,step:1},{x:457.87504069010413,y:276.78385416666663,step:1},{x:458.7838134765625,y:276.78385416666663,step:1},{x:459.5755208333333,y:276.78385416666663,step:1},{x:460.3099365234375,y:276.3671875,step:1},{x:460.3099365234375,y:275.5364583333333,step:1},{x:460.3099365234375,y:274.9114583333333,step:1},{x:459.8919270833333,y:274.5286458333333,step:1},{x:459,y:274,step:1},{x:457.9765625,y:273.3919270833333,step:1},{x:456.9974365234375,y:272.5598958333333,step:1},{x:456.9974365234375,y:271.16796875,step:1},{x:456.9974365234375,y:268.9921875,step:1},{x:458.6966145833333,y:267.6640625,step:1},{x:460.81254069010413,y:267.6640625,step:1},{x:461.97916666666663,y:267.6640625,step:1},{x:462.6718343098958,y:267.95182291666663,step:1},{x:463.08854166666663,y:268.1920979817708,step:1},{x:462.44010416666663,y:270.111328125,step:0},{x:462.125,y:269.919921875,step:1},{x:461.4478759765625,y:269.6314697265625,step:1},{x:460.6405843098958,y:269.6477864583333,step:1},{x:459.67704264322913,y:269.6477864583333,step:1},{x:459.1718343098958,y:270.17582194010413,step:1},{x:459.1718343098958,y:270.767578125,step:1},{x:459.1718343098958,y:271.3919270833333,step:1},{x:459.7630208333333,y:271.775390625,step:1},{x:460.58329264322913,y:272.28776041666663,step:1},{x:461.7642822265625,y:272.9759114583333,step:1},{x:462.49869791666663,y:273.83984375,step:1},{x:462.49869791666663,y:275.13541666666663,step:1},{x:462.49869791666663,y:277.5364583333333,step:1},{x:460.71354166666663,y:278.7682698567708,step:1},{x:458.5677083333333,y:278.7682698567708,step:1},{x:457.22782389322913,y:278.75260416666663,step:1},{x:456.2499593098958,y:278.3671875,step:1},{x:455.80204264322913,y:278,step:1},{x:456.4934895833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}];class Nh extends $a{constructor(t){var e;super({type:"annotationStamp",...t,style:{...t.style,stampConfig:(null==t||null===(e=t.style)||void 0===e?void 0:e.stampConfig)||_h(null==t?void 0:t.style.iconName)}}),i(this,"shapeType","annotationStamp"),i(this,"stampType","base"),i(this,"controls",void 0),i(this,"eventHandler",void 0),i(this,"context",void 0),i(this,"renderClipStep",void 0),i(this,"shapes",[]),i(this,"initialRect",void 0),i(this,"iconName",void 0),i(this,"imageLoadedByDraw",!1),i(this,"initByDraw",!1),i(this,"hooks",{reRenderImage:is()}),this.initByDraw=(null==t?void 0:t.initByDraw)||!1,this.initStamp(),this.init(t.transform,t.selectableStyle),this.initSize(t.style,t.transform);}init(t,e){this.eventHandler=new lh(this),this.context=new ch(this,e),this.context.setTransform(t),this.initialRect=this.getBoundingRect();}initStamp(){var t;const{imageData:e,width:i,height:n}=this.style;if(this.stampItemShapes.forEach((t=>{t.destroy();})),this.stampItemShapes=[],(null==this||null===(t=this.style)||void 0===t?void 0:t.img)instanceof HTMLImageElement&&this.style.img.src&&URL.revokeObjectURL(this.style.img.src),e){this.renderType="image",this.imageLoadedByDraw=!1;const t=e instanceof Blob?URL.createObjectURL(e):e,s=new Image;s.src=t,this.style.img=s,s.onload=()=>{if(this.initByDraw||!Xn(i)||!Xn(n)){const{width:t,height:e}=s;let i=t,n=e;if(t>400||e>400){const s=Math.max(t/400,e/400);i/=s,n/=s;}this.updateStyle({width:i,height:n}),this.setLocalScale(1,1),this.initialWidth=i,this.initialHeight=n,this.initByDraw=!1,this.imageLoadedByDraw=!0;}this.hooks.reRenderImage.emit();};}else this.initByDraw=!1,super.initStamp();this.getPath(),this.renderClipStep=this.steps;}initSize(t,e){if("image"===this.renderType){const{x:t,y:e}=this.getLocalScale();1===t&&1===e||this.updateSize(this.parsedStyle.width.value,this.parsedStyle.height.value);}const i={},n=this.getAnnotationConfig(),{x:s,y:o}=(null==e?void 0:e.scale)||{x:1,y:1};var r;Xn(null==t?void 0:t.x)&&(null==t?void 0:t.x)!==n.style.x&&(i.x=t.x),Xn(null==t?void 0:t.y)&&(null==t?void 0:t.y)!==n.style.y&&(i.y=t.y),Xn(null==t?void 0:t.width)&&t.width*s!==n.style.width&&(i.width=t.width),Xn(null==t?void 0:t.height)&&t.height*o!==n.style.height&&(i.height=t.height),r=i,(0!==Object.keys(r).length||r.constructor!==Object)&&this.updateStampStyle(i);}update(){this.updateOrigin(),this.context.updateControls();}updateSize(t,e){const{x:i,y:n}=this.getLocalScale(),{x:s,y:o}=this.getPosition();if("image"===this.renderType){const{x:s,y:o}=this.getLocalPosition(),r=this.getAngle(),a=t*i,l=e*n;this.setAngle(0),this.setLocalScale(1,1),this.updateStyle({width:a,height:l});const h=s+(t-a)/2,c=o+(e-l)/2;return this.initialWidth=a,this.initialHeight=l,this.setLocalPosition({x:h,y:c}),void this.setAngle(r)}const{width:r,height:a}=this.parsedStyle,l=t||r.value*i,h=e||a.value*n;this.setLocalScale(l/r.value,h/a.value),this.setPosition({x:s,y:o});}updateStampStyle(t){const{x:e,y:i}=this.getLocalPosition(),{x:n,y:s}=this.getLocalScale(),{width:o,height:r}=this.parsedStyle,{width:a,height:l}=t,{imageData:h,iconName:c}=this.style;let d=e,u=i;h||_n(null==t?void 0:t.imageData)||this.setLocalScale(1),null!=t&&t.imageData&&t.imageData!==h?(this.style.imageData=t.imageData,this.initStamp()):null!=t&&t.iconName&&t.iconName!==c&&(this.style.imageData=null,this.style.iconName=t.iconName,this.stampConfig=_h(t.iconName),this.initStamp()),Xn(null==t?void 0:t.opacity)&&(null==t?void 0:t.opacity)!==this.style.opacity&&(this.style.opacity=t.opacity),this.updateSize(Xn(a)?a:o.value*n,Xn(l)?l:r.value*s);const{x:p,y:g}=this.getLocalScale();if(Xn(null==t?void 0:t.x)){const e=this.initialWidth*p;d=t.x-(this.initialWidth-e)/2;}if(Xn(null==t?void 0:t.y)){const e=this.initialHeight*g;u=t.y-(this.initialHeight-e)/2;}this.setLocalPosition(d,u);}getAnnotationConfig(){const t=this.context.getTransform(),{x:e,y:i}=this.style,n=Nn(t);if(n.position.x===e&&n.position.y===i&&1===n.scale.x&&1===n.scale.y&&(delete n.position,delete n.scale),this.style.imageData)return {type:"annotationStamp",style:{x:t.position.x,y:t.position.y,width:this.style.width,height:this.style.height,opacity:this.style.opacity,imageData:this.style.imageData},transform:{...n}};const{initialWidth:s,initialHeight:o}=this,r=s*t.scale.x,a=o*t.scale.y;return {type:"annotationStamp",style:{x:t.position.x+(s-r)/2,y:t.position.y+(o-a)/2,width:r,height:a,opacity:this.style.opacity,stampConfig:[...this.stampConfig],iconName:this.style.iconName},transform:{...n}}}destroy(){var t;(null==this||null===(t=this.style)||void 0===t?void 0:t.img)instanceof HTMLImageElement&&this.style.img.src&&(this.style.img.complete?URL.revokeObjectURL(this.style.img.src):this.style.img.onload=()=>{URL.revokeObjectURL(this.style.img.src);}),this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}}function _h(t){const e=[ih.REJECTED,ih.ACCEPTED,ih.APPROVED,ih.NOT_APPROVED,ih.COMPLETED,ih.DRAFT,ih.FINAL,ih.VOID,ih.CONFIDENTIAL,ih.INITIAL_HERE,ih.SIGN_HERE,ih.WITNESS];return [Uh,Ah,kh,Bh,Eh,Rh,Ih,Oh,Dh,Mh,Lh,Wh][e.indexOf(t)]}class Fh extends Nh{constructor(t){super({...t}),i(this,"stampType","raw"),i(this,"annotationRaw",void 0),this.annotationRaw=t.style.annotationRaw,this.context.updateControlsFlags({enableControl:!1});}getAnnotationConfig(){const t=super.getAnnotationConfig();return this.annotationRaw&&(t.style.annotationRaw=this.annotationRaw),t}}class Hh{constructor(t){i(this,"shape",void 0),i(this,"isEditMode",void 0),i(this,"controlsBox",void 0),i(this,"controlsPoints",[]),this.shape=t;}isHitPoint(t){return this.shape.outCtx.isHitPoint(t)}enableEditMode(){this.isEditMode=!0,this.shape.context.isHit=!0,this.shape.outCtx.isCtrlPointOoutOfCropBox();}disableEditMode(){this.destroyControls(),this.isEditMode=!1,this.shape.context.isHit=!1;}editStartHandler(t){this.isEditMode&&this.shape.context.isActive&&this.shape.outCtx.startHandler(t);}editMoveHandler(t){this.isEditMode&&this.shape.outCtx.moveHandler(t);}editEndHandler(){this.isEditMode&&this.shape.outCtx.endHandler();}destroyControls(){var t;null===(t=this.controlsBox)||void 0===t||t.destroy(),this.controlsPoints.forEach((t=>{t.destroy(),t=null;})),this.controlsBox=null,this.controlsPoints=[];}}class Vh extends ka{constructor(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n.style={visibility:"visible",borderWidth:"annotationHighlight"===t?0:1,renderBlendMode:"multiply",lineCap:"butt",lineJoin:"miter",lineDash:[0,0],miterLimit:10,...n.style},super({type:t,name:e,...n}),i(this,"lines",[]),i(this,"textAssistEventHandler",void 0),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"isBlankTextAssist",!1),i(this,"isMatchText",!1),i(this,"outCtx",void 0),i(this,"isOutOfCropBox",!1),this.outCtx=s,this.outCtx&&this.outCtx.setShape(this),this.shapeType=t,this.init(n.transform,n.selectableStyle),this.updateLines(n.style.lines),this.updatePosition(0,0);}init(t,e){this.context=new ch(this,e),this.textAssistEventHandler=new Hh(this),this.eventHandler=new lh(this),this.context.updateControlsFlags({useDefaultControls:!1,enableMove:!1});}update(){}updateStyle(t){super.updateStyle(t),this.updateLines(this.style.lines);}getAnnotationConfig(){const t=this.context.getTransform();return {type:this.shapeType,style:{lines:this.style.lines,...this.context.getCommonStyleConfig()},transform:t,startCharRect:this.startCharRect,endCharRect:this.endCharRect,startTextPosition:this.startTextPosition,endTextPosition:this.endTextPosition}}updateLines(t){this.lines=t,this.updateBoundingBox();}getBoundingRect(){return this.bounds}updateBoundingBox(){let t=1/0,e=1/0,i=-1/0,n=-1/0;for(let s=0;s<this.lines.length;s++){const o=this.lines[s];t=Math.min(t,o.left),e=Math.min(e,o.top),i=Math.max(i,o.left+o.width),n=Math.max(n,o.top+o.height);}this.bounds={left:t,top:e,width:i-t,height:n-e};}isPointInPath(t){var e;return !(null===(e=this.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}isPointOnActiveShape(t){if(this.context.isActive)if(this.startCharRect){if(this.isPointOnStartCtrl(t))return !0}else if(this.endCharRect&&this.isPointOnEndCtrl(t))return !0;return this.isPointOnBody(t)}isPointOnBody(t){return t.x>=this.bounds.left&&t.x<=this.bounds.left+this.bounds.width&&t.y>=this.bounds.top&&t.y<=this.bounds.top+this.bounds.height}isPointOnStartCtrl(t){if(!this.startCharRect)return !1;if(!this.context.controlsFlags.enableEdit)return !1;if(zh(t,this.startCharRect))return !0;const e=this.getScale().x,i=this.context.parsedControlsStyle.ctrlBorderRadius/e;return jr({x:this.startCharRect.left+this.startCharRect.width/2,y:this.startCharRect.top-i},t)<=i}isPointOnEndCtrl(t){if(!this.endCharRect)return !1;if(!this.context.controlsFlags.enableEdit)return !1;if(zh(t,this.endCharRect))return !0;const e=this.getScale().x,i=this.context.parsedControlsStyle.ctrlBorderRadius/e;return jr({x:this.endCharRect.left+this.endCharRect.width/2,y:this.endCharRect.top+this.endCharRect.height+i},t)<=i}}function zh(t,e){return t.x>=e.left&&t.x<=e.left+e.width&&t.y>=e.top&&t.y<=e.top+e.height}class $h extends Vh{constructor(){super("annotationHighlight","AnnotationHighlight",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationHighlight"),i(this,"textAssistType",Gh.HIGHLIGHT);}}class jh extends Vh{constructor(){super("annotationStrikeout","AnnotationStrikeout",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationStrikeout"),i(this,"textAssistType",Gh.STRIKEOUT);}}class Xh extends Vh{constructor(){super("annotationUnderline","AnnotationUnderline",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationUnderline"),i(this,"textAssistType",Gh.UNDERLINE);}updateLines(t){this.lines=t,this.updateBoundingBoxForUnderline();}updateBoundingBoxForUnderline(){this.parsedStyle;let t=1/0,e=1/0,i=-1/0,n=-1/0;for(let s=0;s<this.lines.length;s++){const o=this.lines[s];t=Math.min(t,o.left),e=Math.min(e,o.top),i=Math.max(i,o.left+o.width),n=Math.max(n,o.top+o.height);}this.bounds={left:t,top:e,width:i-t,height:n-e};}}var Gh;function Yh(t,e,i){var n;(i instanceof uh||i instanceof ph||i instanceof dh)&&t!==e&&(null===(n=i.context)||void 0===n||n.updateControls());}function qh(t,e,i){t!==e&&i.childNodes.length>0&&i.childNodes.forEach((t=>{t&&t.style&&(t.style.opacity=e);}));}function Jh(t,e,i){var n;(i instanceof fh||i instanceof Ch||i instanceof Ph)&&t!==e&&(null===(n=i.context)||void 0===n||n.updateControls());}function Zh(t,e,i){if(!(i instanceof Ch||i instanceof Ph||i instanceof Th||i instanceof fh))return;if(t===e)return;const{left:n,top:s}=i.getBoundingRect();i.updatePosition(n,s),i.updateOrigin();}function Qh(t,e,i){var n;(i instanceof vh||i instanceof xh)&&t!==e&&(null===(n=i.context)||void 0===n||n.updateControls());}function Kh(t,e,i){var n;i instanceof Th&&t!==e&&(null==i||null===(n=i.context)||void 0===n||n.updateControls());}function tc(t,e,i){i instanceof xh&&t!==e&&(i.textEditEventHandler.calculateCharPosition(),i.textEditEventHandler.updateTextSelection(),i.updateCursor(),i.hooks.reRenderText.emit());}function ec(t,e,i){i instanceof xh&&t!==e&&(i.textEditEventHandler.calculateCharPosition(),i.textEditEventHandler.updateTextSelection(),i.hooks.reRenderText.emit());}!function(t){t.HIGHLIGHT="highlight",t.UNDERLINE="underline",t.STRIKEOUT="strikeout";}(Gh||(Gh={}));const ic={annotationRect:"rectangle",annotationEllipse:"ellipse",annotationPolygon:"polygon",annotationPolyline:"polyline",annotationLine:"line",annotationInk:"ink",annotationTextBox:"textBox",annotationFreeText:"textTypewriter",annotationStamp:"stamp"};class nc{constructor(t){i(this,"eraserPath",void 0),i(this,"erasedShapeIds",[]),i(this,"selectionBox",void 0),i(this,"startCanvasPoint",void 0),i(this,"startLocalPoint",void 0),i(this,"lastMovePoint",void 0),i(this,"resetActivatedZIndex",!0),i(this,"isSeparateText",!1),i(this,"lastClickPointerType",""),i(this,"drawType","annotationRect"),i(this,"isStartEdit",!1),i(this,"isStartDraw",!1),i(this,"controller",void 0),i(this,"eventArea",void 0),i(this,"eventMode","none"),i(this,"defaultGroup",void 0),i(this,"activatedShape",void 0),i(this,"activatedZIndex",0),i(this,"drawLineShape",!1),i(this,"stampPreview",void 0),i(this,"inkDelayTimeout",void 0),i(this,"drawInkShape",!1),i(this,"isArrowKeyDown",!1),i(this,"arrowKeyDownSuccessful",!1),this.controller=t,this.defaultGroup=new wh("ddvDefaultGroup"),this.defaultGroup.style.zIndex=1e5;}isDefaultGroup(t){return t===this.defaultGroup}getDrawInitStyle(t,e){var i,n;const{defaultStyleConfig:s,eraserStyle:o,selectionStyle:r}=this.controller.interactiveConfig,a={x:e.x,y:e.y};let l=[{...oh.textContent,..."annotationFreeText"===t?null==s||null===(i=s.textTypewriter)||void 0===i?void 0:i.textContent:null==s||null===(n=s.textBox)||void 0===n?void 0:n.textContent}];""===l[0].content&&(l=[]);let h={};switch(t){case"annotationInk":h={lineCap:"round",lineJoin:"round",segments:[[e]]};break;case"annotationPolygon":case"annotationPolyline":h={points:[e]};break;case"annotationLine":h={startPoint:e,endPoint:e};break;case"annotationFreeText":case"annotationTextBox":h={...a,textContents:l};break;default:h=a;}let c={...oh,...s[ic[t]]||{}};return "select"===this.eventMode?c={...r,zIndex:999}:"erase"===this.eventMode&&(c=o),{...c,...h}}getDrawUpdateStyle(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=(e.x+this.startLocalPoint.x)/2,s=(e.y+this.startLocalPoint.y)/2,o=e.x-this.startLocalPoint.x,r=e.y-this.startLocalPoint.y;const a=["annotationCircle","annotationEllipse"].includes(t),l=Math.min(Math.abs(o),Math.abs(r));i&&(o=e.x>=this.startLocalPoint.x?l:-l,r=e.y>=this.startLocalPoint.y?l:-l,a&&(n=(2*this.startLocalPoint.x+o)/2,s=(2*this.startLocalPoint.y+r)/2));let h={};switch(t){case"annotationFreeText":break;case"annotationCircle":case"annotationArc":h={x:n,y:s,r:l};break;case"annotationEllipse":h={x:n,y:s,rx:Math.abs(o)/2,ry:Math.abs(r)/2};break;case"annotationLine":h={endPoint:e};break;default:h={width:o,height:r};}return h}limitPointToEventArea(t,e){if(!this.eventArea)return;const i=this.activatedShape,{left:n,top:s,width:o,height:r}=this.eventArea;let a=0,l=0,h=0;if(e){const{lastHitControlPoint:t,lastHitControlPointCenter:e}=i.context;t&&e&&(l=t.x-e.x,h=t.y-e.y);}else {const{borderWidth:t}=i.parsedStyle;a=zl(i)?t.value*i.getScale().x:0;}t.x<n+a+l&&(t.x=n+a+l),t.y<s+a+h&&(t.y=s+a+h),t.x>n+o+l&&(t.x=n+o+l),t.y>s+r+h&&(t.y=s+r+h);}executeErase(){var t;"erase"===this.eventMode&&(this.erasedShapeIds.length>0&&this.controller.deleteShape(this.erasedShapeIds),this.controller.deleteShape([null===(t=this.eraserPath)||void 0===t?void 0:t.id],!1),this.eraserPath=null,this.activatedShape=null,this.erasedShapeIds=[]);}executeBoxSelect(){if("select"!==this.eventMode)return;const{shapeArrMap:t,containerId:e}=this.controller,{width:i,height:n}=this.selectionBox.parsedStyle,s=i.value<2&&n.value<2,o=[],r=t.get(e);if(s){const t=[];r.forEach((e=>{if(!e.isVisible||!e.context.controlsFlags.enableControl||e===this.selectionBox||"annotationGroup"===e.shapeType)return;const i=Vl(e,this.startCanvasPoint);e.isPointInPath(i,this.getHitBorderOffset(e))&&!e.context.isGrouped&&t.push(e);})),t.length&&(t.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),o.push(t[t.length-1]));}else r.forEach((t=>{"annotationGroup"!==t.shapeType&&t.isVisible&&t.context.controlsFlags.enableControl&&t!==this.selectionBox&&Gl(this.selectionBox,t)&&o.push(t);}));1===o.length?this.selectShapes([o[0]]):o.length>1?this.selectShapes(o):(this.activatedShape=null,this.controller.hooks.emitSelectAnnotation(null)),this.controller.deleteShape([this.selectionBox.id],!1),this.selectionBox=null,this.controller.hooks.emitAnnotationRender();}activateShape(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!t.isVisible||!t.context.controlsFlags.enableControl)return;const n=this.activatedShape===t,{showOnTopWhenSelected:s}=this.controller.interactiveConfig;if(!n||!t.context.isActive){var o;if(this.activatedShape&&!n)if(e){if(s&&(this.activatedShape.style.zIndex=this.activatedZIndex),this.defaultGroup.parent&&this.defaultGroup.parent!==this.controller.container&&this.defaultGroup.clear(),!this.isDefaultGroup(this.activatedShape)&&!this.defaultGroup.shapes.includes(this.activatedShape))(null===(o=this.activatedShape)||void 0===o?void 0:o.parentNode)===(null==t?void 0:t.parentNode)?this.defaultGroup.add(this.activatedShape):this.inactivateShape();}else this.inactivateShape();this.activatedShape=t,this.activatedShape.context.isActive=!0,s&&(this.resetActivatedZIndex&&(this.activatedZIndex=this.activatedShape.style.zIndex),this.resetActivatedZIndex=!0,this.activatedShape.style.zIndex=99999),this.activatedShape.eventHandler.setLimitArea(this.eventArea),this.activatedShape.controls||t.context.initControls(),t.context.renderControls(),$l(t)&&t.pointEventsHandler.enableEditMode(),Xl(t)&&t.textAssistEventHandler.enableEditMode(),this.isDefaultGroup(t)&&t.showAllControls(),e||this.controller.hooks.emitSelectAnnotation(t),i&&this.controller.hooks.emitAnnotationRender();}}inactivateShape(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.activatedShape)return;const{showOnTopWhenSelected:i}=this.controller.interactiveConfig;if(i&&!this.isDefaultGroup(this.activatedShape)&&(this.activatedShape.style.zIndex=this.activatedZIndex),this.drawInkShape&&this.activatedShape instanceof fh&&(this.drawInkShape=!1,clearTimeout(this.inkDelayTimeout)),this.activatedShape.context.unHitShape(),this.activatedShape.context.destroyControls(),this.isDefaultGroup(this.activatedShape)&&this.activatedShape.clear(),this.activatedShape instanceof xh&&"freeTextWriter"===this.activatedShape.textType){const{textContents:t}=this.activatedShape.style;let e="";t.forEach((t=>{e+=(null==t?void 0:t.content)||"";})),0===e.length&&this.controller.deleteShape([this.activatedShape.id],!0);}this.isArrowKeyDown&&(this.isArrowKeyDown=!1,this.controller.hooks.emitModifyAnnotation(["moved"],[this.activatedShape]),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape)),this.activatedShape=null,this.controller.hooks.emitAnnotationRender(),t&&this.controller.hooks.emitSelectAnnotation(null,e);}setEventArea(t){this.eventArea=t,this.activatedShape&&this.activatedShape.eventHandler.setLimitArea(this.eventArea);}setEventMode(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"annotationRect";if("draw"===this.eventMode&&this.activatedShape&&("annotationInk"===this.drawType&&this.activatedShape instanceof fh&&this.activatedShape.setUseDouglasPeucker(!0),this.drawLineShape)){const t=[...this.activatedShape.style.points];jn()||t.pop(),this.activatedShape.style.points=t;}this.drawLineShape&&this.controller.hooks.emitAddAnnotation("draw",[this.activatedShape]),(this.drawInkShape||this.drawLineShape)&&(clearTimeout(this.inkDelayTimeout),this.inactivateShape(!1)),this.isStartDraw=!1,this.drawLineShape=!1,this.drawInkShape=!1,this.eventMode=t,this.drawType=e,this.stampPreview&&(this.controller.deleteShape([this.stampPreview.id],!1),this.stampPreview=null,this.controller.hooks.emitAnnotationRender()),"none"!==t&&(this.inactivateShape(!0),"erase"===t&&(this.drawType="annotationInk"),"select"===t&&(this.drawType="annotationRect"));}getFreeTextLimitWidth(t,e,i,n,s,o,r,a){const l=t,h=e,c=Math.round(i),d=Math.round(o);if(!l)return 0;let u=l,p=n;if(d!==c){if(0===d)switch(c){case 90:return s+a/2+r/2;case 180:return n+r;case-90:u=h,p=s+a/2-r/2;}if(-90===d)switch(c){case 0:return s+a/2+r/2;case 90:return n+r;case 180:u=h,p=s+a/2-r/2;}if(180===d||-180===d)switch(c){case 0:return n+r;case-90:return s+a/2+r/2;case 90:u=h,p=s+a/2-r/2;}if(90===d)switch(c){case 180:return s+a/2+r/2;case-90:return n+r;case 0:u=h,p=s+a/2-r/2;}}let g=u-p;return g<0&&(g=u),g}selectShapes(t){const e=[];return t.forEach((t=>{"visible"===t.parsedStyle.visibility&&t.context.controlsFlags.enableControl&&e.push(t);})),this.inactivateShape(!t.length),!!e.length&&(this.defaultGroup.clear(),1===e.length?this.activateShape(e[0],!1,!0):(e.forEach((t=>{this.defaultGroup.add(t);})),this.activateShape(this.defaultGroup,!1,!0)),!0)}editStartHandler(t){if("none"!==this.eventMode)return;if(!this.activatedShape)return;const{offsetX:e,offsetY:i}=ql(this.controller.canvas,t),n={x:e,y:i};this.isStartEdit=!0,180===this.activatedShape.getAngle()&&this.activatedShape.setAngle(179.99),this.activatedShape.eventHandler.startHandler(n,!0),this.controller.hooks.emitBeforeAnnotationEdit(this.activatedShape);}editMoveHandler(t){if(!this.activatedShape||"none"!==this.eventMode||!this.isStartEdit)return;const{offsetX:e,offsetY:i}=ql(this.controller.canvas,t),n={x:e,y:i};this.limitPointToEventArea(n,!0),this.activatedShape.eventHandler.moveHandler(n,As(t)),this.controller.hooks.emitAnnotationRender();}editEndHandler(t){this.isStartEdit=!1,this.activatedShape&&"none"===this.eventMode&&(this.activatedShape.eventHandler.endHandler(this.controller.hooks),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape));}drawStartHandler(t){if(!this.controller.container||"none"===this.eventMode)return;if("draw"===this.eventMode&&"annotationStamp"===this.drawType)return void("touch"!==t.pointerType&&"pen"!==t.pointerType||this.drawStampMoveHandler(t,!1));if(!this.eventArea)return;const{controller:e}=this,{drawType:i,drawLineShape:n,eventMode:s}=this,{offsetX:o,offsetY:r}=ql(e.canvas,t),{left:a,top:l,width:h,height:c}=this.eventArea;if(o<a||o>a+h||r<l||r>l+c)return;const d={x:o,y:r},u=e.container.getWorldTransform().inverse().transformPoint(d);if(this.isStartDraw=!0,this.startCanvasPoint=d,this.startLocalPoint=u,this.lastMovePoint=null,"select"===s&&(this.inactivateShape(),this.controller.hooks.emitBeforeAnnotationEdit(null)),this.drawInkShape&&clearTimeout(this.inkDelayTimeout),"draw"===s&&(n||this.drawInkShape)){const e=this.activatedShape instanceof fh;return e&&this.activatedShape.addSegment(),this.activatedShape.addPoint(u),void(e||"touch"!==t.pointerType&&"pen"!==t.pointerType||this.controller.hooks.emitAnnotationRender())}-1!==["annotationPolyline","annotationPolygon"].indexOf(i)&&(this.drawLineShape=!0),"draw"===s&&-1!==["annotationInk"].indexOf(i)&&(this.drawInkShape=!0);const p={style:this.getDrawInitStyle(this.drawType,u)};if("annotationFreeText"===this.drawType){const{cropBoxRect:t}=this.controller.container.parentNode.parentNode.parentNode,e=this.getFreeTextLimitWidth(t.width,t.height,this.controller.container.getAngle(),p.style.x-t.left||0,p.style.y-t.top||0,0,0,0);p.style.width=e||p.style.width;}const g=this.controller.addShape(this.drawType,p,!1);g.style.zIndex=999;const f=()=>{0!==this.controller.container.getAngle()&&sc(g)&&(g.setAngle(0),g.setPosition(d));},{container:v}=this.controller;if("draw"===s)this.controller.hooks.emitBeforeAnnotationDraw(g),f();else if("erase"===s){if(g.style.background=null,v){const t=g.style.borderWidth/v.getScale().x;g.style.borderWidth=t;}this.eraserPath=g;}else {if(v){const t=g.style.borderWidth/v.getScale().x;g.style.borderWidth=t;}this.selectionBox=g,f();}this.activatedShape=g,this.controller.hooks.emitAnnotationRender();}drawMoveHandler(t,e){const{activatedShape:i,eventMode:n,isStartDraw:s,drawType:o}=this;if("none"===n)return;if("draw"===n&&"annotationStamp"===o)return void this.drawStampMoveHandler(t,e);if("draw"===n&&"annotationFreeText"===o)return;if(!s)return;const{offsetX:r,offsetY:a}=ql(this.controller.canvas,t),l={x:r,y:a};this.limitPointToEventArea(l,!1);const h=this.controller.container.getWorldTransform().inverse().transformPoint(l);if("annotationPolyline"===o||"annotationPolygon"===o){const t=Nn(i.parsedStyle.points),e=t.length;1===e?t[e]=h:t[e-1]=h,i.style.points=t;}else if("annotationInk"===o)i.addPoint(h);else {const e=this.getDrawUpdateStyle(this.drawType,h,As(t)),n=this.controller.container.getAngle();if(0!==n&&sc(i)){if(90===Math.abs(Math.round(n))){const t=e.width;e.width=e.height,e.height=t;}e.width=l.x-this.startCanvasPoint.x>0?Math.abs(e.width):-Math.abs(e.width),e.height=l.y-this.startCanvasPoint.y>0?Math.abs(e.height):-Math.abs(e.height),i.updateStyle(e),i.setPosition({...this.startCanvasPoint});}else i.updateStyle(e);}this.controller.hooks.emitAnnotationRender();}drawStampMoveHandler(t,e){const{offsetX:i,offsetY:n}=ql(this.controller.canvas,t),s={x:i,y:n},o=this.controller.container.getRootNode(),r=o.getWorldTransform().inverse().transformPoint(s),a=()=>{if(!this.stampPreview)return;const i=this.stampPreview.getBoundingRect(),n=(null==t?void 0:t.target)instanceof HTMLCanvasElement;this.stampPreview.style.visibility=!e&&n?"visible":"hidden",this.stampPreview.setLocalPosition(r.x-i.width/2,r.y-i.height/2);};if(!this.stampPreview){const{defaultStyleConfig:t}=this.controller.interactiveConfig,{stamp:e}=t,i=(null==e?void 0:e.stampIcon)||(null==oh?void 0:oh.stampIcon),n=(null==e?void 0:e.imageData)||(null==oh?void 0:oh.imageData),s=(null==e?void 0:e.stampConfig)||null;if(this.stampPreview=this.controller.createShape("annotationStamp",{style:{iconName:s?null:i,imageData:n,stampConfig:s,opacity:Xn(e.opacity)?e.opacity:.5,zIndex:9999},initByDraw:!0}),o.appendChild(this.stampPreview),!n&&i){const{width:t,height:e}=this.stampPreview.parsedStyle;if(e.value>60){const i=e.value/60;this.stampPreview.updateSize(t.value/i,e.value/i);}this.stampPreview.hooks.reRenderImage.on((()=>{this.controller.hooks.emitAnnotationRender();}));}else this.stampPreview.hooks.reRenderImage.on((()=>{"visible"===this.stampPreview.style.visibility&&a(),this.controller.hooks.emitAnnotationRender();}));}a(),this.controller.hooks.emitAnnotationRender();}eraseMoveHandler(t){const{eraserStyle:e}=this.controller.interactiveConfig,{eventMode:i,isStartDraw:n,erasedShapeIds:s,controller:o}=this;if("erase"!==i||!o.container||!n)return;const r=o.shapeArrMap.get(o.containerId);if(!r.size)return;const{offsetX:a,offsetY:l}=ql(o.canvas,t),h={x:a,y:l};this.lastMovePoint||(this.lastMovePoint=h),r.forEach((t=>{t!==this.eraserPath&&-1===s.indexOf(t.id)&&"visible"===t.parsedStyle.visibility&&t.context.controlsFlags.enableControl&&function(t,e,i,n){const s=Vl(t,e),o=as(e,i),r=t.isPointInPath(s,5);if(r||o<=.9)return r;const a=o/1,l=(e.x-i.x)/a,h=(e.y-i.y)/a;for(let e=0;e<Math.abs(a);e++){const n=Vl(t,{x:i.x+l*e,y:i.y+h*e});if(t.isPointInPath(n,5))return !0}return !1}(t,h,this.lastMovePoint,e.borderWidth)&&(t.style.opacity=.5,s.push(t.id));})),this.lastMovePoint=h;}drawEndHandler(t){const{eventMode:e,isStartDraw:i,drawLineShape:n,drawType:s,activatedShape:o,controller:r}=this;if("draw"===e&&"annotationStamp"===s)return void this.drawStampEndHandler(t);if("none"===e||!i||n)return;this.isStartDraw=!1;if(["annotationRect","annotationTextBox"].includes(s)){const{width:t,height:e,borderWidth:i}=o.parsedStyle,{x:n,y:s}=o.getPosition(),{x:r,y:a}=o.getScale(),l=(null==i?void 0:i.value)||0;let h=n,c=s;t.value<0&&(h=n-(-t.value+l)*r,o.style.width=-t.value+2*l),e.value<0&&(c=s-(-e.value+l)*a,o.style.height=-e.value+2*l),o.setPosition({x:h,y:c});}if("draw"===e&&this.drawInkShape)return o.setUseDouglasPeucker(!0),this.controller.hooks.emitAnnotationRender(),1===this.activatedShape.style.segments.length?r.hooks.emitAddAnnotation("draw",[this.activatedShape]):r.hooks.emitModifyAnnotation(["resized"],[this.activatedShape]),void(this.inkDelayTimeout=setTimeout((()=>{this.drawInkShape&&(this.drawInkShape=!1,this.activatedShape&&this.activatedShape instanceof fh&&(this.activatedShape.setUseDouglasPeucker(!0),this.inactivateShape(!1,!1)));}),this.controller.interactiveConfig.inkCreateDelay));if("draw"===e&&"annotationFreeText"!==s&&"annotationStamp"!==s){const{offsetX:e,offsetY:i}=ql(r.canvas,t);((this.startCanvasPoint.x-e)**2+(this.startCanvasPoint.y-i)**2)**.5<2&&"annotationStamp"!==o.shapeType&&(r.deleteShape([o.id],!1),r.hooks.emitAfterAnnotationDraw(null),this.activatedShape=null);}const a=(t,e)=>{if(t instanceof xh){const{enableControl:i}=t.context.controlsFlags;if(!i)return;t.textEditEventHandler.enableEditMode(this.startCanvasPoint,e),"textBox"===t.textType&&this.controller.hooks.emitAnnotationRender(),"freeTextWriter"===t.textType&&setTimeout((()=>{document.activeElement instanceof HTMLTextAreaElement||t.textEditEventHandler.enableEditMode(this.startCanvasPoint,e);}),10);}};if("draw"===e&&this.activatedShape){const t=this.activatedShape,{canvas:e}=this.controller;r.hooks.emitAddAnnotation("draw",[this.activatedShape]),r.interactiveConfig.enableContinuousDrawing?o instanceof xh?(this.eventMode="none",this.resetActivatedZIndex=!1,this.activateShape(this.activatedShape,!1,!0),a(o,e)):this.activatedShape=null:(this.controller.setAnnotationMode("none",!0),r.hooks.emitAfterAnnotationDraw(t),this.resetActivatedZIndex=!1,this.activateShape(this.activatedShape,!1,!0),a(o,e));}"erase"===e&&this.executeErase(),"select"===e&&this.executeBoxSelect();}drawStampEndHandler(t){const{offsetX:e,offsetY:i}=ql(this.controller.canvas,t);if(!this.stampPreview)return;if(!this.eventArea)return;if(this.stampPreview&&"image"===this.stampPreview.renderType&&!this.stampPreview.imageLoadedByDraw)return void(this.stampPreview.style.visibility="hidden");const{left:n,top:s,width:o,height:r}=this.eventArea;if(e<n||e>o+n||i<s||i>r+s)return;const{defaultStyleConfig:a}=this.controller.interactiveConfig,{stamp:l}=a,h=Xn(null==l?void 0:l.opacity)?null==l?void 0:l.opacity:null==oh?void 0:oh.opacity,c=this.stampPreview;c.style.opacity=h;const{containerId:d,container:u,shapeArrMap:p}=this.controller,g={...c.getPosition()},f={...c.getScale()},v=u.getScale(),m=f.x/v.x,y=f.y/v.y;if(p.get(d).set(c.id,c),c.index=p.get(d).size,c.pageUid=d,u.appendChild(c),c.style.imageData){const{width:t,height:e}=c.parsedStyle;c.updateStyle({width:t.value*m,height:e.value*y}),c.setLocalScale(1,1);}else c.setLocalScale(m,y);c.setAngle(0),c.setPosition(g),this.stampPreview=null,this.activatedShape=c,this.controller.hooks.emitBeforeAnnotationDraw(c),this.controller.hooks.emitAddAnnotation("draw",[c]),this.controller.interactiveConfig.enableContinuousDrawing?jn()&&this.createStampPreviewForMobile():(this.resetActivatedZIndex=!1,this.controller.setAnnotationMode("none",!0),this.activateShape(c,!1,!0),this.controller.hooks.emitAfterAnnotationDraw(c));}dblClickHandler(t){const{activatedShape:e,controller:i}=this;if(!e)return;const{shapeType:n}=e;if(this.drawLineShape&&("annotationPolygon"===n||"annotationPolyline"===n)){const t=[...e.style.points],n=t.length;return jn()?as(t[n-1],t[n-2])<=15&&t.pop():t.pop(),"mouse"===this.lastClickPointerType&&(t.pop(),this.lastClickPointerType=""),t.length<2?(i.deleteShape([e.id],!1),this.activatedShape=null):(e.style.points=t,this.controller.hooks.emitAddAnnotation("draw",[this.activatedShape])),this.isStartDraw=!1,this.drawLineShape=!1,void(!i.interactiveConfig.enableContinuousDrawing&&this.activatedShape?(this.controller.setAnnotationMode("none",!0),this.controller.hooks.emitAfterAnnotationDraw(e),this.resetActivatedZIndex=!1,this.activateShape(e,!1,!0)):this.activatedShape=null)}if("annotationFreeText"===n&&!this.isSeparateText){const{offsetX:i,offsetY:n}=ql(this.controller.canvas,t),{textEditEventHandler:s}=e,o={x:i,y:n};if(this.activatedShape instanceof xh&&"freeTextWriter"===this.activatedShape.textType&&!this.activatedShape.isEditMode){const{cropBoxRect:t}=this.controller.container.parentNode.parentNode.parentNode,e=this.activatedShape.getBoundingRect(),i=this.getFreeTextLimitWidth(t.width,t.height,this.controller.container.getAngle(),this.activatedShape.getLocalPosition().x-t.left,this.activatedShape.getLocalPosition().y-t.top,this.activatedShape.getAngle(),e.width,e.height);if(i!==this.activatedShape.style.width){this.activatedShape.style.width=i;const t=this.activatedShape.getBoundingRect();e.width!==t.width&&this.controller.hooks.emitModifyAnnotation(["appearanceChanged"],[this.activatedShape]);}}s.enableEditMode(o,this.controller.canvas),this.controller.hooks.emitAnnotationRender();}}clickHandler(t,e){const{activatedShape:i,eventMode:n}=this;if(!i)return;const{shapeType:s}=i,o=()=>{if("annotationFreeText"===s){const{offsetX:e,offsetY:n}=ql(this.controller.canvas,t),{textEditEventHandler:s}=i,o={x:e,y:n};s.editClickHandler(o,this.controller.canvas);}};if(this.lastClickPointerType=null==t?void 0:t.pointerType,this.isSeparateText=!1,"none"===n){const n=Ps(t);if((n||e&&!n)&&this.controller.interactiveConfig.enableMultipleSelectWidthCtrl){if(this.isDefaultGroup(i)){const{clickedShape:t}=i;this.defaultGroup.delete(t);const{shapes:e}=this.defaultGroup;if(e.length<2&&(this.defaultGroup.context.isActive=!1),1===e.length){const t=e[0];this.activateShape(t,!1,!1),this.isSeparateText=t instanceof xh;}}else this.defaultGroup.parent&&this.defaultGroup.parent!==this.controller.container&&this.defaultGroup.clear(),this.defaultGroup.add(this.activatedShape),this.defaultGroup.shapes.length>=2?(this.defaultGroup.context.isActive=!0,this.activateShape(this.defaultGroup,!1,!1)):(this.controller.hooks.emitSelectAnnotation(i),o());return void this.controller.hooks.emitAnnotationRender()}o();}}keyDownHandler(t,e){const{activatedShape:i}=this;if(!i)return;const n=()=>{if(this.isStartDraw&&(this.isStartDraw=!1),this.drawLineShape)return this.drawLineShape=!1,this.controller.deleteShape([this.activatedShape.id]),void this.controller.hooks.emitAnnotationRender();this.inactivateShape(!0),this.defaultGroup.clear();};switch(t.key){case"Escape":n();break;case"Delete":case"Backspace":if(jl(i)&&i.textEditEventHandler.editMode)return;if(!this.controller.interactiveConfig.enableDeleteWithKeyboard)return;if(this.drawInkShape||this.drawLineShape)return;t.preventDefault(),this.controller.deleteShape([i.id]),this.inactivateShape();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":if(!this.controller.interactiveConfig.enableMoveWithKeyboard)return;if(i instanceof xh&&i.isEditMode)return;if(this.drawInkShape||this.drawLineShape)return;this.isArrowKeyDown=!0;i.eventHandler.moveByKeyboard(t,e)&&(this.arrowKeyDownSuccessful=!0,this.controller.hooks.emitBeforeAnnotationEdit(i),this.controller.hooks.emitAnnotationRender());break}}keyUpHandler(t){this.isArrowKeyDown&&(this.isArrowKeyDown=!1,["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(t.key)&&this.arrowKeyDownSuccessful&&(this.arrowKeyDownSuccessful=!1,this.controller.hooks.emitModifyAnnotation(["moved"],[this.activatedShape]),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape)));}getHitBorderOffset(t){if(!t)return 10;const e=t.getScale();if(e.x<1||e.y<1){const t=Math.min(e.x,e.y);return Math.round(Math.abs(10/t))}return 10}createStampPreviewForMobile(){if(this.stampPreview)return;const{defaultStyleConfig:t}=this.controller.interactiveConfig,{stamp:e}=t,i=(null==e?void 0:e.stampIcon)||(null==oh?void 0:oh.stampIcon),n=(null==e?void 0:e.imageData)||(null==oh?void 0:oh.imageData),s=(null==e?void 0:e.stampConfig)||null,o=this.controller.container.getRootNode();if(this.stampPreview=this.controller.createShape("annotationStamp",{style:{iconName:s?null:i,imageData:n,stampConfig:s,opacity:Xn(e.opacity)?e.opacity:.5,zIndex:9999,visibility:!1},initByDraw:!0}),o.appendChild(this.stampPreview),!n&&i){const{width:t,height:e}=this.stampPreview.parsedStyle;if(e.value>60){const i=e.value/60;this.stampPreview.updateSize(t.value/i,e.value/i);}}}}function sc(t){return ["annotationFreeText","annotationTextBox","annotationRect"].includes(t.shapeType)}var oc,rc,ac=new WeakMap;class lc extends js{constructor(){super(...arguments),i(this,"renderAnnotation",Gs(this)),i(this,"addAnnotation",Gs(this)),i(this,"deleteAnnotation",Gs(this)),i(this,"selectAnnotation",Gs(this)),i(this,"modifyAnnotation",Gs(this)),i(this,"annotationModeChanged",Gs(this)),i(this,"beforeAnnotationEdit",Gs(this)),i(this,"afterAnnotationEdit",Gs(this)),i(this,"beforeAnnotationDraw",Gs(this)),i(this,"afterAnnotationDraw",Gs(this)),i(this,"annotationTextContentUpdated",Gs(this)),i(this,"selectAnnotationTextChars",Gs(this)),i(this,"enableAnnotationTextEditMode",Gs(this)),i(this,"disableAnnotationTextEditMode",Gs(this)),f(this,ac,{writable:!0,value:[]}),i(this,"renderTimer",null);}emitAddAnnotation(t,e){const i=[];e.forEach((t=>{i.push({uid:t.id,shape:t});})),this.addAnnotation.emit({action:t,shapes:i});}emitDeleteAnnotation(t){const e=[];t.forEach((t=>{e.push({uid:t.id,shape:t});})),this.deleteAnnotation.emit({shapes:e});}emitSelectAnnotation(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[];t instanceof wh?t.shapes.forEach((t=>{i.push(t.id);})):t&&i.push(t.id),(i.length||n(this,ac).length)&&(this.selectAnnotation.emit({newAnnotationUids:[...i],oldAnnotationsUids:[...n(this,ac)],emitSelected:e}),s(this,ac,i));}emitModifyAnnotation(t,e){const i=[];e.forEach((t=>{t instanceof wh?t.shapes.forEach((t=>{i.push({uid:t.id,shape:t});})):i.push({uid:t.id,shape:t});})),this.modifyAnnotation.emit({actions:t,shapes:i});}emitAnnotationModeChanged(t){this.annotationModeChanged.emit(t);}emitBeforeAnnotationEdit(t){t instanceof xh&&t.textEditEventHandler.editMode||this.beforeAnnotationEdit.emit(t);}emitAfterAnnotationEdit(t){this.afterAnnotationEdit.emit(t);}emitAnnotationRender(){this.renderTimer||(this.renderTimer=setTimeout((()=>{this.renderTimer=null,this.renderAnnotation.emit();}),17));}emitSelectAnnotationTextChar(t){this.selectAnnotationTextChars.emit(t);}emitBeforeAnnotationDraw(t){this.beforeAnnotationDraw.emit(t);}emitAfterAnnotationDraw(t){this.afterAnnotationDraw.emit(t);}emitEnableAnnotationTextEditMode(t){this.enableAnnotationTextEditMode.emit(t);}emitDisableAnnotationTextEditMode(t){this.disableAnnotationTextEditMode.emit(t);}emitAnnotationTextContentUpdated(t){this.annotationTextContentUpdated.emit(t);}}class hc{constructor(t){i(this,"shapeArrMap",void 0),i(this,"shapeMap",void 0),i(this,"annotationMode","none"),i(this,"brush","annotationRect"),i(this,"tempTextStyle",void 0),i(this,"isEnterCtrl",!1),i(this,"canvas",void 0),i(this,"hooks",void 0),i(this,"interactiveConfig",Nn(ah)),i(this,"eventService",void 0),i(this,"containerId",void 0),i(this,"container",void 0),Aa.bindHandler(["opacity"],void 0,qh),Aa.bindHandler(["width","height","borderWidth"],void 0,Qh),Aa.bindHandler(["startPoint","endPoint","lineEnding"],void 0,Kh),Aa.bindHandler(["r","rx","ry","borderWidth"],void 0,Yh),Aa.bindHandler(["points","segments"],void 0,Jh),Aa.bindHandler(["borderWidth"],void 0,Zh),Aa.bindHandler(["textContents","borderWidth","textAlign"],void 0,tc),Aa.bindHandler(["textAlign"],void 0,ec),this.canvas=t,this.eventService=new nc(this),this.hooks=new lc,this.shapeArrMap=new Map,this.shapeMap=new Map;}set drawType(t){this.brush=t,"draw"===this.annotationMode&&this.eventService.setEventMode("draw",t);}get drawType(){return this.brush}clearShapeArrMap(){this.shapeArrMap.forEach((t=>{t.clear();})),this.shapeArrMap.clear();}deleteShapeArrMap(t){this.shapeArrMap.has(t)&&(this.shapeArrMap.get(t).clear(),this.shapeArrMap.delete(t));}bindFreeTextHooks(t){if(!(t instanceof xh))return;const e=t.hooks;let i;e.reRenderText.on((()=>{this.hooks.emitAnnotationRender();})),e.textContentUpdated.on((()=>{this.hooks.emitModifyAnnotation(["contentChanged"],[t]);})),e.textContentUpdatedByChar.on((()=>{this.hooks.emitAnnotationTextContentUpdated(t);})),e.selectTextChars.on((e=>{var n;if(e.startChar===e.endChar&&t.isSameChar(i,e.endChar)&&!e.needUpdate)return;const{freeTextContentStyle:s}=t,o="freeTextWriter"===t.textType?"textTypewriter":"textBox",{defaultStyleConfig:r}=this.interactiveConfig;r[o]||(r[o]={}),r[o].textContent={...s,content:null===(n=r[o])||void 0===n||null===(n=n.textContent)||void 0===n?void 0:n.content},i=e.endChar,this.hooks.emitSelectAnnotationTextChar(t);})),e.enableTextEditMode.on((e=>{this.tempTextStyle=Nn(this.interactiveConfig.defaultStyleConfig["textBox"===t.textType?"textBox":"textTypewriter"]),this.hooks.emitEnableAnnotationTextEditMode(t);})),e.disableTextEditMode.on((e=>{this.interactiveConfig.defaultStyleConfig["textBox"===t.textType?"textBox":"textTypewriter"]=this.tempTextStyle,this.tempTextStyle=null,i=null,this.hooks.emitDisableAnnotationTextEditMode(t);}));}bindStampHooks(t){t instanceof Nh&&t.hooks.reRenderImage.on((()=>{this.hooks.emitAnnotationRender();}));}isHitShape(t){const{offsetX:e,offsetY:i}=ql(this.canvas,t),{activatedShape:n,defaultGroup:s}=this.eventService,o={x:e,y:i},{shapeArrMap:r,shapeMap:a,containerId:l}=this,h=r.get(l)||a,c=s===this.eventService.activatedShape&&(null==s?void 0:s.parentNode)===this.container;if(n&&(c||h.has(n.id))){const t=n.eventHandler.isHit(o,!1);if(-1!==t)return {isHit:!0,isHitSelected:!0,hitControlPointIndex:t,shape:n}}const d=[];let u=!1,p=null;return h.forEach((t=>{if("hidden"===t.style.visibility||!t.context.controlsFlags.enableControl||t===n)return;const e=Vl(t,o);!t.context.isGrouped&&t.isPointInPath(e,this.eventService.getHitBorderOffset(t))&&(u=!0,d.push(t));})),u&&(d.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),p=d[d.length-1]),{isHit:u,shape:p,isHitSelected:!1,hitControlPointIndex:-1}}isInTextEditMode(){return !!(this.eventService.activatedShape&&this.eventService.activatedShape instanceof xh)&&this.eventService.activatedShape.isEditMode}setAnnotationMode(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.annotationMode=t,this.eventService.setEventMode(t,this.drawType),jn()&&"draw"===t&&"annotationStamp"===this.drawType&&this.eventService.createStampPreviewForMobile(),"none"!==t&&this.eventService.inactivateShape(),e&&this.hooks.emitAnnotationModeChanged(t);}setAnnotationContainer(t,e){if(e!==this.container){const{activatedShape:t,drawLineShape:e,drawInkShape:i,drawType:n}=this.eventService;if("draw"===this.eventService.eventMode&&t){if(i&&t instanceof fh&&(clearTimeout(this.eventService.inkDelayTimeout),t.setUseDouglasPeucker(!0),this.eventService.drawInkShape=!1),e){const e=[...t.style.points];t.style.points=e,this.eventService.drawLineShape=!1,this.eventService.isStartDraw=!1;}"annotationInk"!==n&&(this.hooks.emitAddAnnotation("draw",[t]),this.interactiveConfig.enableContinuousDrawing||(this.setAnnotationMode("none",!0),this.hooks.emitAfterAnnotationDraw(t)),this.eventService.activatedShape=null);}}this.containerId=t,this.container=e,this.shapeArrMap.get(t)||this.shapeArrMap.set(t,new Map);}setAnnotationInteractiveConfig(t){if(this.tempTextStyle){const e=this.eventService.activatedShape;if(e instanceof xh){const i=t.defaultStyleConfig["textBox"===e.textType?"textBox":"textTypewriter"];if(i){const t=this.tempTextStyle.textContent;this.tempTextStyle={...this.tempTextStyle,...i},this.tempTextStyle.textContent={...t,...i.textContent};}}}const e=Nn(t),{controlsStyle:i,defaultStyleConfig:n,eraserStyle:s,selectionStyle:o}=this.interactiveConfig;e.defaultStyleConfig=(null==e?void 0:e.defaultStyleConfig)||{};const{stamp:r}=n,{stamp:a}=e.defaultStyleConfig,l=(null==r?void 0:r.stampIcon)||oh.stampIcon,h=null==r?void 0:r.stampConfig,c=(null==r?void 0:r.imageData)||oh.imageData,d=null==a?void 0:a.stampIcon,u=null==a?void 0:a.stampConfig,p=null==a?void 0:a.imageData;this.interactiveConfig={...this.interactiveConfig,...e,controlsStyle:Ws((null==e?void 0:e.controlsStyle)||{},i),defaultStyleConfig:Ws((null==e?void 0:e.defaultStyleConfig)||{},n),eraserStyle:Ws((null==e?void 0:e.eraserStyle)||{},s),selectionStyle:Ws((null==e?void 0:e.selectionStyle)||{},o)},(d||u||p)&&(p||(this.interactiveConfig.defaultStyleConfig.stamp.imageData=null),u||(this.interactiveConfig.defaultStyleConfig.stamp.stampConfig=null)),null!=e&&e.controlsStyle&&this.updateAllShapeControlsStyle(this.interactiveConfig.controlsStyle);const{stampPreview:g}=this.eventService;var f;(g&&g.style.opacity!==(null==a?void 0:a.opacity)&&(this.eventService.stampPreview.style.opacity=null==a?void 0:a.opacity),l===d&&c===p&&h===u||!this.eventService.stampPreview)||(null===(f=this.eventService.stampPreview)||void 0===f||f.destroy(),this.eventService.stampPreview=null);}setAnnotationFlags(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const n=this.getShape(t);if(!(n instanceof Fh)&&n){n!==this.eventService.activatedShape||!1!==e.enableControl&&!1!==e.isVisible||this.eventService.drawInkShape||this.eventService.inactivateShape(!0),n.context.updateControlsFlags({...e});const{isVisible:t,enableControl:s,enableEdit:o}=n.context.controlsFlags;if(n.context.isInGroup&&(!t||!s)){const{defaultGroup:t,activatedShape:e}=this.eventService;t.delete(n),e===t&&1===t.shapes.length&&this.eventService.activateShape(t.shapes[0],!1,!0);}$l(n)&&n.pointEventsHandler.editMode&&!o&&(n.pointEventsHandler.disableEditMode(),n.pointEventsHandler.enableEditMode()),i&&this.hooks.emitAnnotationRender();}}getShape(t){if("ddvDefaultGroup"===t)return this.eventService.defaultGroup;const e=this.shapeMap.get(t);return e||null}getSelectedShapeUids(){const{activatedShape:t}=this.eventService;if(!t)return [];const e=[];return t instanceof wh?t.shapes.forEach((t=>{e.push(t.id);})):e.push(t.id),e}createShape(t,e,i){var n,s;let o;if(e.selectableStyle={...this.interactiveConfig.controlsStyle,...e.selectableStyle},"annotationEllipse"===t){const{style:t}=e;t.x+=t.width/2||0,t.y+=t.height/2||0,t.rx=t.width/2||t.rx,t.ry=t.height/2||t.ry;}const{defaultStyleConfig:r}=this.interactiveConfig;switch(t){case"annotationRect":o=new vh(e);break;case"annotationGroup":o=new wh(null==e?void 0:e.id);break;case"annotationArc":o=new dh(e);break;case"annotationCircle":o=new uh(e);break;case"annotationEllipse":o=new ph(e);break;case"annotationLine":o=new Th(e);break;case"annotationInk":o=new fh(e);break;case"annotationPolygon":o=new Ch(e);break;case"annotationPolyline":o=new Ph(e);break;case"annotationFreeText":o=new xh(e,"freeTextWriter",{...oh.textContent,...null===(n=r.textTypewriter)||void 0===n?void 0:n.textContent});break;case"annotationTextBox":o=new xh(e,"textBox",{...oh.textContent,...null===(s=r.textBox)||void 0===s?void 0:s.textContent});break;case"annotationImage":o=new gh(e);break;case"annotationStamp":o=new Nh(e);break;case"annotationHighlight":o=new $h(e,i);break;case"annotationUnderline":o=new Xh(e,i);break;case"annotationStrikeout":o=new jh(e,i);break;default:o=new Fh(e);}return o?(o.id||(o.id=Jn()),this.shapeMap.set(o.id,o),o):null}addShape(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null!=e&&e.id){const t=this.getShape(null==e?void 0:e.id);if(t)return t}const s=this.createShape(t,e,n);return this.containerId&&this.shapeArrMap.get(this.containerId).set(s.id,s),this.container&&(s.index=this.shapeArrMap.get(this.containerId).size,s.pageUid=this.containerId,this.container.appendChild(s),i&&this.hooks.emitAddAnnotation("data",[s])),this.bindFreeTextHooks(s),this.bindStampHooks(s),s}updateShape(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const n=this.getShape(t);if(!n)return !1;const{isGrouped:s}=n.context;if(s&&this.eventService.defaultGroup.delete(n),null!=e&&e.style)if(n instanceof Nh)n.updateStampStyle({...e.style});else {if(n instanceof ph){const{x:t,y:i,width:s,height:o}=e.style,{x:r,y:a}=n.getLocalPosition(),l=s?mr(s).value/2:0,h=o?mr(o).value/2:0,c=Xn(t)?t+l:r,d=Xn(i)?i+h:a,u=l||n.style.rx,p=h||n.style.ry;e.style={...e.style,x:c,y:d,rx:u,ry:p};}n.updateStyle({...e.style}),n instanceof xh&&n.updateOrigin();}if(null!=e&&e.transform){const{angle:t,scale:i}=e.transform;_n(t)||n.setLocalAngle(t),_n(i)||n instanceof Nh||n.setLocalScale(i);}return i&&this.hooks.emitModifyAnnotation(["appearanceChanged"],[n]),s&&this.eventService.defaultGroup.add(n),!0}updateAllShapeControlsStyle(t){let e=!1;this.shapeMap.forEach((i=>{if(i.context.controlsStyle=t,i.context.parseControlsStyle(),i.controls){i.controls.isVisible&&(e=!0),i.context.destroyControls(),i.context.initControls(),i.context.renderControls();}})),e&&this.hooks.emitAnnotationRender();}updateFreeTextDefaultConfig(){const{defaultStyleConfig:t}=this.interactiveConfig;this.shapeMap.forEach((e=>{if(e instanceof xh){const i=oh.textContent,n="freeTextWriter"===e.textType?"textTypewriter":"textBox",{textContent:s}=t[n]||{};e.updateFreeTextContentStyle({...i,...s,content:i.content});}}));}updateLayer(t,e){const i=this.getShape(t);return !!i&&(this.interactiveConfig.showOnTopWhenSelected&&this.eventService.activatedShape===i?this.eventService.activatedZIndex=e:i.updateStyle({zIndex:e}),this.interactiveConfig.showOnTopWhenSelected&&this.interactiveConfig.enableContinuousDrawing&&"draw"===this.eventService.eventMode&&i.updateStyle({zIndex:e}),!0)}deleteShape(t){var e;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const s=[],{eventService:o}=this,r=t.includes(null==o||null===(e=o.activatedShape)||void 0===e?void 0:e.id);if(t.forEach((t=>{const e=this.getShape(t);e&&(e instanceof wh?(s.push(...e.shapes),e.clear()):s.push(e));})),!s.length)return !1;i&&this.hooks.emitDeleteAnnotation(s),s.forEach((t=>{t.context.isInGroup&&this.eventService.defaultGroup.delete(t),this.shapeMap.delete(t.id),this.shapeArrMap.get(t.pageUid)&&this.shapeArrMap.get(t.pageUid).delete(t.id),t.destroy();}));const{activatedShape:a,defaultGroup:l}=o,h=a===l&&!l.state;return (r||h)&&this.eventService.inactivateShape(!0,n),!0}selectShape(t){const e=[];return t.forEach((t=>{e.push(this.getShape(t));})),this.eventService.selectShapes(e)}moveShape(t,e,i){t.forEach((t=>{const n=this.getShape(t);if(!n)return;const s=n.pageUid,o=this.shapeArrMap.get(s);o&&o.delete(t),this.shapeArrMap.get(e)||this.shapeArrMap.set(e,new Map),this.shapeArrMap.get(e).set(t,n),n.context.isGrouped&&n.parentNode.delete(n,!0),i.appendChild(n);}));}setShapeLayout(t,e){var i;if(!t.parentNode)return;const n=t.parentNode;let s,o;if(n instanceof Ma)s=n.width,o=n.height;else {const{width:t,height:e}=Jl(n);s=t,o=e;}const{x:r,y:a}=n.getLocalScale();n.scale(r<0?-1:1,a<0?-1:1);const l=n.getAngle(),{width:h,height:c}=Jl(t),{x:d,y:u}=n.getPosition(),{x:p,y:g}=t.getPosition(),{shapeType:f}=t;let v,m;if(n.setAngle(0),null!=n&&null!==(i=n.context)&&void 0!==i&&i.referencePoint){const{x:t,y:e}=n.context.referencePoint.getPosition();v=t,m=e;}else v=d,m=u;switch(e){case"left":m=g;break;case"top":v=p;break;case"right":v+=s-h,m=g;break;case"bottom":v=p,m+=o-c;break;case"center":v+=s/2-h/2,m+=o/2-c/2;break;case"horizontal-center":v+=s/2-h/2,m=g;break;case"vertical-center":v=p,m+=o/2-c/2;}const y=t.getAngle();t.setAngle(0),["annotationCircle","annotationArc","annotationEllipse"].includes(f)&&(["left","right","horizontal-center"].includes(e)?v+=h/2:(["top","bottom","vertical-center"].includes(e)||(v+=h/2),m+=c/2)),t.setPosition({x:v,y:m}),t.setAngle(y),n.setAngle(l),n.scale(r<0?-1:1,a<0?-1:1),this.hooks.emitAnnotationRender();}clickHandler(t){this.eventService.clickHandler(t,this.isEnterCtrl);}dblClickHandler(t){this.eventService.dblClickHandler(t);}keyDownHandler(t,e){this.eventService.keyDownHandler(t,e);}keyUpHandler(t){this.eventService.keyUpHandler(t);}startHandler(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.isHitShape(t);this.isEnterCtrl=Ps(t);const n=this.isEnterCtrl&&this.interactiveConfig.enableMultipleSelectWidthCtrl;if("none"===this.annotationMode&&e&&(i.isHit?this.eventService.activateShape(i.shape,n,!0):this.eventService.inactivateShape()),"draw"!==this.annotationMode||i.isHit||this.annotationMode===this.eventService.eventMode){if("draw"===this.annotationMode&&!this.eventService.drawLineShape&&"annotationInk"!==this.brush&&"annotationStamp"!==this.brush&&i.isHit)this.eventService.setEventMode("none"),this.eventService.activateShape(i.shape,n,!0);else if("select"===this.annotationMode){const{isHitSelected:t,isHit:e}=i;t?this.eventService.setEventMode("none"):!t&&e&&n?(this.eventService.setEventMode("none"),this.eventService.activateShape(i.shape,n,!0)):(this.eventService.setEventMode("select"),this.eventService.defaultGroup.clear());}}else this.eventService.setEventMode(this.annotationMode,this.brush);this.eventService.editStartHandler(t),this.eventService.drawStartHandler(t);}moveHandler(t,e){this.eventService.editMoveHandler(t),this.eventService.drawMoveHandler(t,e),this.eventService.eraseMoveHandler(t);}endHandler(t){this.eventService.editEndHandler(t),this.eventService.drawEndHandler(t);}cursorHandler(t){if(!this.container)return null;if(!(t.target instanceof HTMLCanvasElement))return null;if("erase"===this.annotationMode)return 12;if("draw"===this.annotationMode){if("annotationInk"===this.drawType)return 3;if(["annotationHighlight","annotationUnderline","annotationStrikeout"].includes(this.drawType))return 16}const e=this.isHitShape(t);if(e.isHit){if(e.isHitSelected){let t=null;switch(e.hitControlPointIndex){case 8:t=11;break;case 9:t=e.shape instanceof xh&&e.shape.isEditMode?16:e.shape.context.controlsFlags.enableMove?4:1;break;case 10:t=16;break;default:t=1;}return t}return 13}return "select"===this.annotationMode?2:"draw"===this.annotationMode?3:"none"===this.annotationMode?14:null}}class cc extends bl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class dc extends cc{constructor(t){super(t),this.close=!1;}}class uc extends cc{render(t,e){super.render(t,e);}}class pc extends cc{}class gc extends Ml{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class fc extends cc{}class vc extends Al{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class mc extends kl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class yc extends cc{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class xc extends Dl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class wc extends cc{}class bc extends bl{render(t,e){if("hidden"!==t.parsedStyle.visibility){if("stamp"===t.renderType)t.renderClipStep&&(e.beginPath(),t.renderClipStep.forEach((t=>{ra(e,t);})),e.closePath(),e.clip()),super.render(t,e);else {const{width:i,height:n,img:s,opacity:o}=t.parsedStyle;if(Gn(s))return;e.save(),e.globalAlpha=o,e.imageSmoothingEnabled=!0,e.imageSmoothingQuality&&(e.imageSmoothingQuality="high"),e.drawImage(s,0,0,i.value,n.value),e.restore();}t.controls&&t.context.renderControls();}}}class Sc extends Ul{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class Cc extends bl{render(t,e){"hidden"!==t.parsedStyle.visibility&&Pc(t,e);}}function Pc(t,e){const{container:i}=t,n=t.parentNode;if(!n)return;const s=n.getLocalTransform(),{a:o,b:r,c:a,d:l,e:h,f:c}=s;let d=null,u=i.parentNode;for(;!d&&u;)"pageCropBox"===u.name&&(d=u),u=u.parentNode;if(d){const{x:t,y:i,width:n,height:s}=function(t){let{x:e,y:i}=t.getPosition(),{width:n,height:s}=t;const o=t.parentNode.parentNode,r=(o.rotation%360+360)%360/90,a=devicePixelRatio;1===r?e-=s:2===r?(e-=n,i-=s):3===r&&(i-=n);if(1===r||3===r){const t=n;n=s,s=t;}return {x:e*a,y:i*a,width:n*a,height:s*a}}(d);e.save(),e.setTransform(o,r,a,l,h,c),e.beginPath(),e.moveTo(t,i),e.lineTo(t+n,i),e.lineTo(t+n,i+s),e.lineTo(t,i+s),e.closePath(),e.restore(),e.clip();}}class Tc extends bl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(Pc(t,e),super.render(t,e));}}class Ac{constructor(t){i(this,"rCanvas",void 0),this.rCanvas=t;}render(t,e){"hidden"!==t.parsedStyle.visibility&&(this.renderTextAssist(t,e),t.controls&&t.context.renderControls());}renderTextAssist(t,e){e.save(),e.globalCompositeOperation=t.parsedStyle.renderBlendMode,e.globalAlpha=t.parsedStyle.opacity;const{background:i,borderColor:n,borderWidth:s}=t.parsedStyle;if("annotationHighlight"===t.shapeType?(e.fillStyle=i.formatted,e.beginPath(),t.lines.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath()):(e.lineWidth=s.value,e.strokeStyle=n.formatted,"annotationStrikeout"===t.shapeType?(e.beginPath(),t.lines.forEach((t=>{let{left:i,top:n,width:s,height:o}=t;e.moveTo(i,n+o/2),e.lineTo(i+s,n+o/2);})),e.closePath(),e.stroke()):(e.beginPath(),t.lines.forEach((t=>{let{left:i,top:n,width:o,height:r}=t;e.moveTo(i,n+r-s.value/2),e.lineTo(i+o,n+r-s.value/2);})),e.closePath(),e.stroke())),t.context.isActive){e.globalAlpha=1;const{ctrlBorderRadius:i,ctrlBorderWidth:n,ctrlBorderColor:s,ctrlHeight:o,ctrlWidth:r,ctrlBackground:a,ctrlLineDash:l}=t.context.parsedControlsStyle,h=t.getScale().x,{left:c,top:d,width:u,height:p}=t.bounds;if(e.strokeStyle=s,e.fillStyle=a,e.lineWidth=n/h,e.setLineDash(Sl(l)?[0,0]:l),e.strokeRect(c,d,u,p),t.context.controlsFlags.enableEdit&&!t.context.isGrouped){const n=i/h,s=[];if(!t.isOutOfCropBox){if(t.startCharRect){const{startCharRect:e}=t;s.push({x:e.left+e.width/2-r/2/h,y:e.top-o/h});}if(t.endCharRect){const{endCharRect:e}=t;s.push({x:e.left+e.width/2-r/2/h,y:e.top+e.height});}}0===i?s.forEach((t=>{e.beginPath(),e.rect(t.x,t.y,r/h,o/h),e.closePath(),a&&e.fill(),e.stroke();})):s.forEach((t=>{e.beginPath();const{PI:i}=Math;e.arc(t.x+n,t.y+n,n,i,3*i/2),e.arc(t.x+r/h-n,t.y+n,n,3*i/2,2*i),e.arc(t.x+r/h-n,t.y+o/h-n,n,0,i/2),e.arc(t.x+n,t.y+o/h-n,n,i/2,i),e.closePath(),a&&e.fill(),e.stroke();}));}}e.restore();}}class kc{init(t){[{name:"annotationArc",renderer:new dc(t)},{name:"annotationCircle",renderer:new uc(t)},{name:"annotationEllipse",renderer:new pc(t)},{name:"annotationLine",renderer:new gc(t)},{name:"annotationImage",renderer:new vc(t)},{name:"annotationInk",renderer:new mc(t)},{name:"annotationPolygon",renderer:new yc(t)},{name:"annotationPolyline",renderer:new xc(t)},{name:"annotationRect",renderer:new wc(t)},{name:"annotationFreeText",renderer:new Sc(t)},{name:"annotationGroup",renderer:new fc(t)},{name:"annotationStamp",renderer:new bc(t)},{name:"annotationControls",renderer:new Cc(t)},{name:"annotationLineControls",renderer:new Tc(t)},{name:"annotationHighlight",renderer:new Ac(t)},{name:"annotationUnderline",renderer:new Ac(t)},{name:"annotationStrikeout",renderer:new Ac(t)}].forEach((e=>{let{name:i,renderer:n}=e;t.contextService.registerShapeRenderer(i,n);}));}destroy(){}}function Ec(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ko.displayResolution;const i={left:0,top:0,width:t.imageWidth/t.imageXResolution*e,height:t.imageHeight/t.imageYResolution*e};return {fileIndex:0,mediaBox:i,cropBox:{...i},resource:{data:t.imageData,width:t.imageWidth,height:t.imageHeight,resolutionX:t.imageXResolution,resolutionY:t.imageYResolution,bitDepth:t.imageBitDepth}}}class Dc extends Go{constructor(){super(),i(this,"type","imageParser"),i(this,"once",!1),i(this,"imgReader",void 0),i(this,"isDestroy",!1),i(this,"source",void 0),i(this,"parserOptions",void 0),this.imgReader=new wo;}initParser(t,e){this.source={fileSource:t},e&&(this.parserOptions=e);}async getPageCount(){return 1}destroy(){var t;null===(t=this.imgReader)||void 0===t||t.destroy(),this.imgReader=null,this.source=null,this.isDestroy=!0;}async parse(){if(this.isDestroy)return null;return [Ec(await this.imgReader.readImageInfo(this.source))]}async parseAnnotations(t,e){return []}async getPage(){var t;if(this.isDestroy)return null;const e={"image/jpeg":uo.IT_JPG,"image/png":uo.IT_PNG,"image/bmp":uo.IT_BMP},{outputType:i,jpegQuality:n,returnBase64:s}=null!==(t=this.parserOptions)&&void 0!==t?t:{},o=await this.imgReader.readImage({source:this.source,outputType:null!=i?i:e[this.source.fileSource.type],jpegQuality:n,returnBase64:s});if(o){return Ec(o)}return null}cancelGetPage(t){var e;if(this.isDestroy)return;const{outputType:i}=null!==(e=this.parserOptions)&&void 0!==e?e:{};this.imgReader.cancelReadImage(this.source,i);}getPageTexts(t){return null}}class Rc{constructor(){i(this,"type","tiffParser"),i(this,"once",!1),i(this,"imgReader",void 0),i(this,"parserOptions",void 0),i(this,"source",void 0),i(this,"isDestroy",!1),this.imgReader=new wo;}initParser(t,e){this.source={fileSource:t},e&&(this.parserOptions=e);}async getPageCount(){return this.imgReader.getTiffPageCount(this.source)}destroy(){var t;null===(t=this.imgReader)||void 0===t||t.destroy(),this.imgReader=void 0,this.source=null,this.isDestroy=!0;}async parse(t){if(this.isDestroy||!this.source)return null;return (await this.imgReader.readTiffPageInfo(this.source,t)).map((t=>{const e=Ec(t);return e.fileIndex=t.pageIndex,e}))}async parseAnnotations(t,e){return []}async getPage(t){var e;if(this.isDestroy||!this.source)return null;const{outputType:i,returnBase64:n}=null!==(e=this.parserOptions)&&void 0!==e?e:{},s=await this.imgReader.readTiffPage({source:this.source,index:t,outputType:i,returnBase64:n});if(s){const t=Ec(s);return t.fileIndex=s.pageIndex,t}return null}cancelGetPage(t){!this.isDestroy&&this.source&&this.imgReader.cancelReadTiffPage(this.source,t);}getPageTexts(t){return null}}function Ic(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=kr(t),s=e||1;if(On(n)&&n[0]&&n[0]instanceof br){const t=n[0].value.steps,{length:e}=n[0].value.steps,s=[0,0,0];t.forEach((t=>{const e=kr(t.color);s[0]+=e.r,s[1]+=e.g,s[2]+=e.b;}));const o=[s[0]/e,s[1]/e,s[2]/e];return i&&(o[3]=255),o}const{r:o,g:r,b:a,alpha:l}=n,h=[o,r,a];return i&&(h[3]=Math.floor(l*s*255+.5)),h}function Mc(t,e){return {strokeColor:t?Ic(t,1,!1):null,fillColor:e?Ic(e,1,!1):null}}function Bc(t,e,i){let n,s;return n=t?Ic(t,i,!0):null,s=e?Ic(e,i,!0):null,{apStrokeColor:n,apFillColor:s}}function Uc(t,e,i){const n=t.value?t.value/i:0,s=Fc(e||[],i);return s.length?{width:n,style:"D",dash:s}:{width:n}}function Lc(t){const e=t.getLocalTransform().clone(),{a:i,b:n,c:s,d:o}=e;return [Zc(i),-Zc(n),-Zc(s),Zc(o),0,0]}function Oc(t,e){const{min:i,max:n}=Math;let s=t[0][0],o=t[0][1],r=t[0][0],a=t[0][1];for(let e=1;e<t.length;e++){const l=t[e];s=i(s,l[0]),r=n(r,l[0]),a=i(a,l[1]),o=n(o,l[1]);}return s===r&&(s-=1,r+=1),a===o&&(a-=1,o+=1),[s-e/2,a-e/2,r+e/2,o+e/2]}function Wc(t,e,i,n,s,o){const r=[],a=aa(e),l=i/2,h=[{x:a.left-l*n,y:a.bottom+l*s},{x:a.right+l*n,y:a.bottom+l*s},{x:a.right+l*n,y:a.top-l*s},{x:a.left-l*n,y:a.top-l*s}],c=t.getLocalTransform();return h.forEach((t=>{const e=c.transformPoint({x:t.x,y:t.y});r.push([e.x/n,o-e.y/s]);})),Oc(r,0)}function Nc(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[],{length:n}=t;if(n>50&&e){const e=Math.floor(n/2),s=Math.floor(n/4);i.push(t[0][0],t[0][1]),i.push(t[s][0],t[s][1]),i.push(t[e][0],t[e][1]),i.push(t[n-s][0],t[n-s][1]),i.push(t[n-1][0],t[n-1][1]),i.push(t[0][0],t[0][1]);}else t.forEach((t=>{i.push(t[0],t[1]);}));return i}function _c(t){const e=[];for(let i=0;i<t.length;i++){const n=[];t[i].forEach((t=>{n.push(t[0],t[1]);})),e.push(n);}return e}function Fc(t,e){if(!t)return [];if(2===t.length&&0===t[0]&&0===t[1])return [];return t.map((t=>t/e))}function Hc(t){return Math.max(["butt","round","square"].indexOf(t),0)}function Vc(t){return Math.max(["miter","round","bevel"].indexOf(t),0)}function zc(t){const e=[],i=t.getLocalTransform();return t.renderPath.forEach((t=>{const n=i.transformPoint({x:t.x,y:t.y});e.push({x:n.x,y:n.y});})),e}function $c(t,e){const i=kr(t);let n=0,s=0,o=99999,r=99999;if(On(i)&&i[0]&&i[0]instanceof br){const i=(t=>{const e=t.match(/(to\s+\w+\s+\w+)|(#\w+)/g);if(!e)return null;const i=e[0],n=e.slice(1);return {direction:i.replace(/\s+/g," ").trim(),colors:n.map((t=>t.trim()))}})(t);e.forEach((t=>{n=Math.max(n,t[0]),o=Math.min(o,t[0]),s=Math.max(s,t[1]),r=Math.min(r,t[1]);}));const a=[o,s,n,r];i.direction.includes("left")&&(a[0]=n,a[2]=o),i.direction.includes("top")&&(a[1]=r,a[3]=s);const l=kr(i.colors[0]),h=kr(i.colors[1]);return {coords:a,extend:[!0,!0],function:[{bounds:[],domain:[0,1],encode:[0,1],functions:[{c0:[l.r/255,l.g/255,l.b/255],c1:[h.r/255,h.g/255,h.b/255],domain:[0,1],n:1,type:"exponentialInterpolation"}],type:"stitching"}],shadingType:"axial",type:"shading"}}return null}function jc(t){const e=t.map((t=>t.toLowerCase())),i=[];return e.includes("print")&&i.push("print"),e.includes("noview")&&i.push("noview"),e.includes("readonly")&&i.push("readonly"),i}function Xc(t,e,i,n,s){const{width:o,height:r}=t.parsedStyle;let a=o.value,l=r.value;if(t instanceof xh){const{width:e,height:i}=t.getBoundingRect();a=e,l=i;}const{x:h,y:c}=t.getLocalPosition(),d=e/2,u=h/i,p=s-c/n,g=a/i,f=l/n;return [[u+d,p-f+d,2,!1],[u+g-d,p-f+d,0,!1],[u+g-d,p-d,0,!1],[u+d,p-d,0,!1],[u+d,p-f+d,0,!0]]}function Gc(t,e,i,n){t.renderPath||t.getPath();const{renderPath:s}=t,o=[],{x:r,y:a}=t.getLocalPosition();let l=[];for(let t=0;t<s.length;t++){const{step:h,close:c}=s[t],d=(s[t].x+r)/e,u=n-(s[t].y+a)/i;0!==t?0!==h||0===t?2===h?l.push([d,u,1,c]):l.push([d,u,0,c]):(o.push(l),l=[],l.push([d,u,2,c])):l.push([d,u,2,c]);}return o.push(l),o}function Yc(t,e,i,n,s,o,r){let a=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const{lineDash:l}=t.parsedStyle,h=Lc(t),c=Oc(o,s),d=[];a&&d.push(qc(t,o,e,i,s,Fc(l,r)));return {bbox:c,matrix:h,transform:c,objs:d,blendMode:td(t.style.renderBlendMode)||"Normal"}}function qc(t,e,i,n,s,o){const{miterLimit:r,lineCap:a,lineJoin:l}=t.parsedStyle;return {dashArray:o,dashPhase:0,fillColor:i||[0,0,0,0],fillType:i?2:0,isStroke:s>0,lineCap:Hc(a),lineJoin:Vc(l),blendMode:td(t.style.renderBlendMode)||"Normal",lineWidth:s,miterLimit:r,objMatrix:[1,0,0,1,0,0],segments:e,strokeColor:n||[0,0,0,0],type:"path"}}function Jc(t,e,i,n){const{fontSize:s,fontFamily:o,fontWeight:r,fontStyle:a,opacity:l,text:h}=t.parsedStyle,{color:c,borderColor:d}=t.style,{x:u,y:p}=t.getLocalPosition(),{apStrokeColor:g,apFillColor:f}=Bc(d,c,l);return {type:"text",charSpace:0,wordSpace:0,fillColor:f||[0,0,0,255],strokeColor:g||[0,0,0,255],fontName:o,renderMode:0,fontIsBold:Qc(r),fontIsItalic:"italic"===a,fontSize:s.value/e,fontPitchFamily:16,text:h,position:[u/e,p/i],objMatrix:[1,0,0,1,u/e,n-p/i],blendMode:td(t.style.renderBlendMode)||"Normal"}}function Zc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;const i=t.toFixed(e);return Number.parseFloat(i)}function Qc(t){return "bold"===t||Xn(t)&&t>=600}function Kc(t,e,i){return t.replace(new RegExp(e,"g"),i)}function td(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}function ed(t,e,i,n,s){const{segments:o,lineWidth:r,strokeColor:a,fillType:l,fillColor:h,dashArray:c,lineCap:d,lineJoin:u,miterLimit:p,isStroke:g,pattern:f}=t,v={type:"path",stampPoints:ad(o,i,n,s),borderWidth:g?(r||1)*i:0,borderColor:cd(a,e),background:l>0?cd(h,e):null,lineDash:dd(c,i),lineCap:ld(d),lineJoin:hd(u),miterLimit:p};return f&&(v.background=function(t,e,i,n){var s,o,r,a;const{coords:l,type:h}=t;if("shading"!==h)return null;const c={x:l[0]*e,y:n-l[1]*i},d={x:l[2]*e,y:n-l[3]*i},u=c.x<d.x?"right":"left",p=c.y===d.y?"":c.y<d.y?"bottom":"top";if(!t||null==t||!t.function||null==t||null===(s=t.function[0])||void 0===s||!s.functions)return null;let g=null==t||null===(o=t.function[0])||void 0===o||null===(o=o.functions[0])||void 0===o?void 0:o.c0,f=null==t||null===(r=t.function[0])||void 0===r||null===(r=r.functions[0])||void 0===r?void 0:r.c1;if(!g||!f)return null;const v=(null==t||null===(a=t.function[0])||void 0===a?void 0:a.encode)||[1,0];if(v[0]>v[v.length-1]){const t=f;f=g,g=t;}const m=`rgb(${255*g[0]},${255*g[1]},${255*g[2]})`,y=`rgb(${255*f[0]},${255*f[1]},${255*f[2]})`;return `linear-gradient(to ${u} ${p}, ${Tr(m)}, ${Tr(y)})`}(f,i,n,s)||v.background),v}function id(t,e,i,n,s){const{text:o,renderMode:r,fontIsBold:a,fontIsItalic:l,fillColor:h,fontSize:c,fontName:d,strokeColor:u,objMatrix:p}=t,g=rr.create(p),{scale:f}=g.decompose(),v=function(t,e,i,n,s,o){const r=sd(t,e,o),a=r[0],l=r[1];return [a*i,(s-l)*n]}(p[4],p[5],i,n,s,[1,0,0,1,0,0]);return {type:"text",text:o,color:cd(h,e),borderWidth:r?i:"0px",borderColor:cd(u,e),fontWeight:a?"bold":"normal",fontStyle:l?"italic":"normal",fontSize:c*i*Math.abs(f.x),fontFamily:d,textBaseLine:"alphabetic",x:v[0],y:v[1]}}function nd(t,e,i){const n=function(t,e){const i=t.replace(/[^A-Za-z0-9\+\/]/g,""),n=i.length,s=e?Math.ceil((3*n+1>>>2)/e)*e:3*n+1>>>2,o=new Uint8Array(s);for(let t,e,r=0,a=0,l=0;l<n;l++)if(e=3&l,r|=pd(i.charCodeAt(l))<<18-6*e,3===e||n-l==1){for(t=0;t<3&&a<s;t++,a++)o[a]=r>>>(16>>>t&24)&255;r=0;}return o}(t),s=new ImageData(new Uint8ClampedArray(n),e,i);let o=document.createElement("canvas");o.width=e,o.height=i;o.getContext("2d").putImageData(s,0,0);const r=o.toDataURL();return o=null,r}function sd(t,e,i){return [i[0]*t+i[2]*e+i[4],i[1]*t+i[3]*e+i[5]]}function od(t,e,i,n,s,o){let r=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const a=rr.create(i),l=a.decompose(),h={x:(e[2]+e[0])/2,y:(e[1]+e[3])/2},c=(e[2]-e[0])/2,d=(e[1]-e[3])/2,u=a.transformPoint(h),p={x:(u.x-c)*n,y:(o-u.y+d)*s},g=-l.rotation,f={x:l.scale.x,y:l.scale.y};let v=p;var m;r&&(v=null!==(m=function(t,e,i,n,s,o){const r=[];let a=!0;if(t.forEach((t=>{let e;"path"===t.type?(e=ed(t,1,n,s,o),a=!1):"text"===t.type&&(e=id(t,1,n,s,o),a=!1),e&&r.push(e);})),a)return null;if(r.length){const t=function(t,e,i,n,s){const o={x:e[0]*i,y:(s-e[3])*n},r=[],a=[];if(t.forEach((t=>{if("path"!==t.type)return;const{borderWidth:e,stampPoints:i,lineCap:n}=t;if(2===i.length){const t=pa(i[0],i[1],mr(e).value,n);r.push(t.left,t.left+t.width),a.push(t.top,t.top+t.height);}else {const t=aa(i),n=mr(e).value/2,s=t.left-n,o=t.top-n,l=t.width+2*n,h=t.height+2*n;r.push(s,s+l),a.push(o,o+h);}})),0===r.length)return {offsetX:0,offsetY:0};const l=Math.min(...r),h=Math.min(...a);return {offsetX:l-o.x,offsetY:h-o.y}}(r,e,n,s,o);i.x+=t.offsetX,i.y+=t.offsetY;}return i}(t,e,{...p},n,s,o))&&void 0!==m?m:v);return {position:v,angle:g,scale:f}}function rd(t,e,i,n){const s=[];return t.forEach((t=>{s.push({x:t[0]*e,y:(n-t[1])*i});})),s}function ad(t,e,i,n){const s=[];return t.forEach((t=>{const o=t[0],r=t[1];s.push({x:o*e,y:(n-r)*i,step:t[2],close:t[3]});})),s}function ld(t){return ["butt","round","square"][null!=t?t:0]}function hd(t){return ["miter","round","bevel"][null!=t?t:0]}function cd(t,e){if(!t)return null;if((null==t?void 0:t.length)<3)return null;if(4===(null==t?void 0:t.length)){const i=0===e?255:t[3];return `rgba(${t.slice(0,3).join()},${i/255/(e||1)})`}return `rgb(${t.join()})`}function dd(t,e){if(!t||0===t.length)return [0,0];return t.map((t=>t*e))}function ud(t){if(!On(t))return [null];let e=[];for(let i=0;i<t.length;i++)t[i]instanceof Array?e=e.concat(ud(t[i])):e.push(Nn(t[i]));return e}function pd(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:43===t?62:47===t?63:0}function gd(t,e){if(!t)return "";let i="";return t.split(";").forEach((t=>{const n=t.split(":");n[0].trim()===e&&(i=n[1].trim());})),i}function fd(t){if(!t)return {contents:[],textStyle:{}};const e=new DOMParser,i='xmlns="http://www.w3.org/1999/xhtml"';let n=t;t.includes('xmlns="')||(n=t.replace(/<body/,`<body ${i}`)),n=Kc(n,'xmlns=""',i);const s=e.parseFromString(n,"text/xml"),o=s.getElementsByTagName("body")[0],r=s.getElementsByTagName("span"),a=s.getElementsByTagName("p"),l=t=>{for(const e in t)null!==t[e]&&void 0!==t[e]&&""!==t[e]||delete t[e];return t},{color:h,fontFamily:c,fontSize:d,fontWeight:u,fontStyle:p,textDecoration:g}=o.style,f=l({color:h,fontFamily:c,fontSize:d,fontWeight:u,fontStyle:p,lineThrough:g.includes("line-through"),underline:g.includes("word")||g.includes("underline")}),v=[],m=t=>{for(let e=0;e<t.length;e++){const i=t[e],{color:n,fontFamily:s,fontSize:o,fontStyle:r,fontWeight:a}=i.style||{},h=gd(i.getAttribute("style"),"text-decoration"),c=l({content:i.textContent,color:n,fontFamily:s,fontSize:o,fontWeight:a,fontStyle:r,lineThrough:h.includes("line-through")||void 0,underline:h.includes("word")||h.includes("underline")||void 0});v.push(c);}};return r.length?m(r):m(a),{textStyle:f,contents:v}}function vd(t,e,i){if(1!==Math.abs(e[0])||1!==Math.abs(e[3])||0!==Math.abs(e[4])||0!==Math.abs(e[5])){const n=sd(i[0],i[1],e),s=sd(i[2],i[3],e);t.forEach((t=>{t.segments.forEach((t=>{const i=sd(t[0],t[1],e);t[0]=i[0],t[1]=i[1];}));})),i[0]=n[0],i[1]=n[1],i[2]=s[0],i[3]=s[1];for(let t=0;t<6;t++)e[t]=0===t||3===t?1:0;}}function md(t,e,i,n,s,o){var r;const{objs:a}=t||{},l=t&&(null==a?void 0:a.length)>0&&"path"===a[0].type,h=l?a[0]:null,c=(l?h.strokeColor:e)||[0,0,0],d=(l?h.fillColor:i)||null,u=l?h.fillType>0:!Us(d),p=cd(c,n),g=d?cd(d,n):"",f=dd(l?h.dashArray:null==s?void 0:s.dash,o),v=ld(l?h.lineCap:0),m=hd(l?h.lineJoin:0),y=l?h.miterLimit:10;let x=(null!==(r=null==s?void 0:s.width)&&void 0!==r?r:1)*o||0;var w;l&&(x=(null!==(w=null==h?void 0:h.lineWidth)&&void 0!==w?w:1)*o||0);return {useObj:l,hasFill:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,borderWidth:x}}class yd{constructor(){i(this,"pageWidth",void 0),i(this,"pageHeight",void 0),i(this,"ratioX",0),i(this,"ratioY",0);}setParserConfig(t,e,i,n){this.pageWidth=t,this.pageHeight=e,this.ratioX=i,this.ratioY=n;}parseAnnotation(t){let e=null;switch(t.type){case"Square":e=this.parseRect(t);break;case"Circle":e=this.parseCircle(t);break;case"Line":e=this.parseLine(t);break;case"Polygon":e=this.parsePolygon(t);break;case"PolyLine":e=this.parsePolyline(t);break;case"Ink":e=this.parseInk(t);break;case"FreeText":e=t.intent&&"freetext"!==t.intent.toLocaleLowerCase()?"freetexttypewriter"===t.intent.toLocaleLowerCase()?this.parseFreeText(t):this.parseIncomplete(t):this.parseTextBox(t);break;case"Stamp":e=this.parseStamp(t);break;case"Highlight":e=this.parseTextAssist(t,"highlight");break;case"StrikeOut":e=this.parseTextAssist(t,"strikeout");break;case"Underline":e=this.parseTextAssist(t,"underline");break;case"Widget":e=this.parseUnknown(t);break;default:e=t.normalAppearance?this.parseIncomplete(t):this.parseUnknown(t);}if(e||(t.normalAppearance?(e=this.parseIncomplete(t),e||(e=this.parseUnknown(t))):e=this.parseUnknown(t)),e){var i;const{opacity:n}=t,s=e.style;if(e.raw=t,s.opacity=Xn(s.opacity)?s.opacity:null!=n?n:1,null!=t&&t.normalAppearance){const{blendMode:i}=t.normalAppearance;e.style.renderBlendMode=i.toLowerCase();}null!==(i=e)&&void 0!==i&&i.transform&&e.transform.angle<0&&(e.transform.angle+=360),e.uid=Jn();}return e}isSegmentsRect(t){if(5!==t.length&&4!==t.length)return !1;if(5===t.length&&(t[0][0]!==t[4][0]||t[0][1]!==t[4][1]))return !1;if(t[0][0]===t[2][0]&&t[0][1]===t[2][1]||t[1][0]===t[3][0]&&t[1][1]===t[3][1])return !1;for(let e=1;e<t.length;e++)if(0!==t[e][2])return !1;for(let e=1;e<t.length;e++)if(t[e][0]!==t[e-1][0]&&t[e][1]!==t[e-1][1])return !1;return t[0][0]===t[3][0]||t[0][1]===t[3][1]}parseRect(t){const{normalAppearance:e,interiorColor:i,borderStyle:n,opacity:s,color:o,rect:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this,{useObj:c,hasFill:d,borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,borderWidth:m}=md(e,o,i,s,n,a);let y=null,x=0,w=0,b=0,S=0;if(e){const{bbox:t,objs:i,transform:s}=e,{position:o,angle:r,scale:d}=od(i||null,t,s,a,l,h,!(null==i||!i.length));if(b=o.x,S=o.y,y={angle:r,scale:d},c){const{lineWidth:t,segments:e}=i[0];if(!this.isSegmentsRect(e))return null;x=(e[1][0]-e[0][0]+t)*this.ratioX,w=(e[2][1]-e[0][1]+t)*this.ratioY;}else {var C,P;x=(t[2]-t[0]-(null!==(C=null==n?void 0:n.width)&&void 0!==C?C:1))*this.ratioX,w=(t[3]-t[1]-(null!==(P=null==n?void 0:n.width)&&void 0!==P?P:1))*this.ratioY;}}else {var T,A,k,E;b=(r[0]+(null!==(T=null==n?void 0:n.width)&&void 0!==T?T:1)/2)*this.ratioX,S=(h-r[3]+(null!==(A=null==n?void 0:n.width)&&void 0!==A?A:1)/2)*this.ratioY,x=(r[2]-r[0]-(null!==(k=null==n?void 0:n.width)&&void 0!==k?k:1))*this.ratioX,w=(r[3]-r[1]-(null!==(E=null==n?void 0:n.width)&&void 0!==E?E:1))*this.ratioY;}return {type:"rectangle",style:{x:b,y:S,width:x,height:w,borderWidth:m,borderColor:u,background:d?p:"",lineDash:g,lineCap:f,lineJoin:v},iconColor:d?p:u,transform:y}}parseCircle(t){const{normalAppearance:e,interiorColor:i,borderStyle:n,opacity:s,color:o,rect:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this,{objs:c}=e||{},{hasFill:d,borderColor:u,background:p,lineDash:g,borderWidth:f}=md(e,o,i,s,n,a);let v=null,m=0,y=0,x=0,w=0;if(e){const{bbox:t,transform:i}=e,{position:n,angle:s,scale:o}=od(c||null,t,i,a,l,h,!(null==c||!c.length));x=n.x,w=n.y,v={angle:s,scale:o},m=(t[2]-t[0])*this.ratioX,y=(t[3]-t[1])*this.ratioY;}else x=r[0]*this.ratioX,w=(h-r[3])*this.ratioY,m=(r[2]-r[0])*this.ratioX,y=(r[3]-r[1])*this.ratioY;return {type:"ellipse",style:{x:x,y:w,width:m,height:y,borderWidth:f,borderColor:u,background:d?p:"",lineDash:g},transform:v,iconColor:d?p:u}}parseLine(t){if(null!=t&&t.intent&&"linedimension"===t.intent.toLocaleLowerCase())return null;const{normalAppearance:e,interiorColor:i,borderStyle:n,lineEnding:s,opacity:o,color:r,line:a}=t,{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{useObj:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,borderWidth:x}=md(e,r,i,o,n,l);let w,b={x:a[0]*this.ratioX,y:(this.pageHeight-a[1])*this.ratioY},S={x:a[2]*this.ratioX,y:(this.pageHeight-a[3])*this.ratioY};if(e){const{bbox:t}=e,{transform:i}=e;if(u){const{segments:e,lineWidth:n}=d[0];vd(d,i,t),b={x:e[0][0]*this.ratioX,y:(this.pageHeight-e[0][1])*this.ratioY},S={x:e[1][0]*this.ratioX,y:(this.pageHeight-e[1][1])*this.ratioY};}const{position:n,angle:s,scale:o}=od(ud(d),t,i,l,h,c,!(null==d||!d.length));w={position:n,scale:o,angle:s};}return {type:"line",style:{startPoint:b,endPoint:S,lineEnding:s||["None","None"],borderColor:p,borderWidth:x,background:g||"",lineCap:v,lineJoin:m,lineDash:f,miterLimit:y},transform:w,iconColor:p}}parsePolygon(t){const{normalAppearance:e,interiorColor:i,borderStyle:n,opacity:s,color:o,vertices:r,intent:a}=t;if(a&&["polygondimension","polygoncloud"].includes(a.toLocaleLowerCase()))return null;const{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{hasFill:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,useObj:x,borderWidth:w}=md(e,o,i,s,n,this.ratioX);let b,S;if(x){const{bbox:t}=e,{transform:i}=e;vd(d,i,t),b=od(ud(d),t,i,l,h,c,!(null==d||!d.length));const{segments:n}=d[0];S=rd(n,this.ratioX,this.ratioY,this.pageHeight);}else {const t=[];for(let e=0;e<r.length;e+=2)t.push([r[e],r[e+1]]);S=rd(t,this.ratioX,this.ratioY,this.pageHeight);}var C,P;return S.length>2&&(C=S[0],P=S[S.length-1],C.x===P.x&&C.y===P.y)&&S.pop(),{type:"polygon",style:{points:S,borderWidth:w,borderColor:p,background:u?g:"",lineDash:f,lineCap:v,lineJoin:m,miterLimit:y},transform:b,iconColor:u?g:p}}parsePolyline(t){const{normalAppearance:e,interiorColor:i,opacity:n,color:s,vertices:o,borderStyle:r,intent:a}=t;if(a&&"polylinedimension"===a.toLocaleLowerCase())return null;const{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,miterLimit:m,useObj:y,borderWidth:x}=md(e,s,i,n,r,this.ratioX);let w,b;if(y){const{bbox:t}=e,{transform:i}=e;vd(d,i,t),w=od(ud(d),t,i,l,h,c,!(null==d||!d.length));const{segments:n}=d[0];b=rd(n,this.ratioX,this.ratioY,this.pageHeight);}else {const t=[];for(let e=0;e<o.length;e+=2)t.push([o[e],o[e+1]]);b=rd(t,this.ratioX,this.ratioY,this.pageHeight);}return {type:"polyline",style:{points:b,borderWidth:x,borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,lineEnding:t.lineEnding||["None","None"],miterLimit:m},transform:w,iconColor:u}}parseInk(t){const{normalAppearance:e,inkList:i,opacity:n,borderStyle:s,interiorColor:o,color:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this;if(!i)return null;const{borderColor:c,background:d,lineDash:u,lineCap:p,lineJoin:g,miterLimit:f,borderWidth:v}=md(e,r,o,n,s,this.ratioX),m=[];for(let t=0;t<i.length;t++){const e=i[t],n=[];for(let t=0;t<e.length;t+=2){const i=e[t],s=e[t+1];n.push([i,s,1,!1]);}const s=rd(n,this.ratioX,this.ratioY,this.pageHeight);m.push(s);}let y=null;if(e){const{objs:t,transform:i,bbox:n}=e;y=od(ud(t),n,i,a,l,h,!(null==t||!t.length));}return {type:"ink",style:{segments:m,borderWidth:v,borderColor:c,background:d,lineDash:u,lineCap:p,lineJoin:g,miterLimit:f},transform:y,iconColor:c}}parseFreeText(t){const{normalAppearance:e,richText:i,rect:n,defaultAppearanceData:s,defaultStyle:o}=t,{ratioX:r,ratioY:a,pageHeight:l}=this;let h,c,d,u,p=0;if(e){const{bbox:t,transform:i,objs:n}=e,{position:s,angle:o,scale:u}=od(ud(n),t,i,r,a,l,n.length&&"path"===n[0].type);p=o,c=s.x,d=s.y,h={angle:p,scale:u};}else c=n[0]*this.ratioX,d=(l-n[3])*this.ratioY;(Math.round(p)+360)/90%2==0?(u=(n[2]-n[0])*this.ratioX,0===p&&(u+=12),u+c>this.pageWidth*this.ratioX&&(u=this.pageWidth*this.ratioX-c)):(u=(n[3]-n[1])*this.ratioY,u+c>this.pageHeight*this.ratioY&&(u=this.pageHeight*this.ratioY-c));const{fontName:g,fontSize:f,fontColor:v}=s,m={content:"",fontFamily:g,color:gd(o,"color")||`rgb(${v[0]},${v[1]},${v[2]})`,fontSize:f},y=fd(i),x=[];y.contents.forEach((t=>{const e={...m,...y.textStyle,...t},i=mr(e.fontSize);e.fontFamily=e.fontFamily.replace(/^"|"$/g,""),(Xn(e.fontSize)||"pt"===i.unit)&&(e.fontSize=i.value*this.ratioX),x.push(e);}));return {type:"textTypewriter",style:{x:c,y:d,width:u,textContents:x},transform:h,iconColor:m.color}}parseTextBox(t){const{normalAppearance:e,richText:i,defaultAppearanceData:n,defaultStyle:s,opacity:o,borderStyle:r,color:a,rect:l}=t,{ratioX:h,ratioY:c,pageHeight:d}=this,{hasFill:u,borderColor:p,background:g,borderWidth:f,lineDash:v,useObj:m}=md(e,null==n?void 0:n.fontColor,a,o,r,h);let y,x,w,b,S;if(e&&e.objs.length){var C,P;const{bbox:t,transform:i,objs:n}=e,{position:s,angle:o,scale:a}=od(ud(n),t,i,h,c,d,"path"===n[0].type);y=s.x,x=s.y,S={angle:o,scale:a};const{segments:l,lineWidth:u}=n[0];w=m&&"path"===n[0].type?(l[1][0]-l[0][0]+u)*this.ratioX:(t[2]-t[0]-(null!==(C=null==r?void 0:r.width)&&void 0!==C?C:1))*this.ratioX,b="path"===n[0].type?(l[2][1]-l[0][1]+u)*this.ratioY:(t[3]-t[1]-(null!==(P=null==r?void 0:r.width)&&void 0!==P?P:1))*this.ratioY;}else {var T,A,k,E;y=(l[0]+(null!==(T=null==r?void 0:r.width)&&void 0!==T?T:1)/2)*this.ratioX,x=(d-l[3]+(null!==(A=null==r?void 0:r.width)&&void 0!==A?A:1)/2)*this.ratioY,w=(l[2]-l[0]-(null!==(k=null==r?void 0:r.width)&&void 0!==k?k:1))*this.ratioX,b=(l[3]-l[1]-(null!==(E=null==r?void 0:r.width)&&void 0!==E?E:1))*this.ratioY;}const{fontName:D,fontSize:R}=n,I={content:"",fontFamily:D,fontSize:R},M=fd(i);let B=gd(i,"text-align")||gd(s,"text-align");"justify-center"===B&&(B="justify");const U=[];if(M.contents.forEach((t=>{const e={...I,...M.textStyle,...t},i=mr(e.fontSize);e.fontFamily=e.fontFamily.replace(/^"|"$/g,""),(Xn(e.fontSize)||"pt"===i.unit)&&(e.fontSize=i.value*this.ratioX),U.push(e);})),0===U.length&&t.contents){const e={...I,content:t.contents};Xn(e.fontSize)&&(e.fontSize*=this.ratioX),U.push(e);}return {type:"textBox",style:{x:y,y:x,width:w,height:b,borderWidth:f,borderColor:p,background:u?g:"",lineDash:v,textContents:U,textAlign:B},transform:S,iconColor:I.color}}parseStamp(t){const{icon:e,opacity:i,normalAppearance:n}=t;if(!n)return null;const{objs:s,transform:o,bbox:r}=t.normalAppearance;if(0===s.length)return null;const a=ud(s),l=[],{ratioX:h,ratioY:c,pageHeight:d}=this,{position:u,angle:p,scale:g}=od(a,r,o,h,c,d),f={position:u,angle:p,scale:g};for(let t=0;t<a.length;t++){let e;if("path"===a[t].type&&(e=ed(a[t],i,this.ratioX,this.ratioY,this.pageHeight)),"text"===a[t].type&&(e=id(a[t],i,this.ratioX,this.ratioY,this.pageHeight)),"image"===a[t].type){const e={type:"stamp",style:{imageData:a[t].jpegBase64?`data:image/jpeg;base64,${a[t].jpegBase64}`:nd(a[t].RGBABase64,a[t].width,a[t].height),width:(a[t].rect[2]-a[t].rect[0])*this.ratioX,height:(a[t].rect[3]-a[t].rect[1])*this.ratioY},transform:f};return e.transform.position.x+=(a[t].rect[0]-r[0])*this.ratioX,e.transform.position.y-=(a[t].rect[3]-r[3])*this.ratioY,e}e&&l.push(e);}return {type:"stamp",style:{iconName:e,stampConfig:l},transform:f,iconColor:"#868E96"}}parseTextAssist(t,e){const{normalAppearance:i,opacity:n,color:s}=t;if(!i)return null;const o=1e-6;if(t.quadPoints)for(let e=0;e<t.quadPoints.length;e++)if(8===t.quadPoints[e].length&&(Math.abs(t.quadPoints[e][1]-t.quadPoints[e][3])>o||Math.abs(t.quadPoints[e][5]-t.quadPoints[e][7])>o))return null;const{objs:r,transform:a,bbox:l}=t.normalAppearance;if(!r||0===r.length){const i=cd(s,1);return {type:e,style:{annotationRaw:t,lines:[],borderColor:i,borderWidth:1,background:i,lineCap:"butt",lineJoin:"miter",lineDash:[0,0],miterLimit:10,opacity:n},transform:{angle:0,position:{x:0,y:0},scale:{x:1,y:1}}}}vd(r,a,l);const h=ud(r),c=[],{ratioX:d,ratioY:u,pageHeight:p}=this,g=od(h,l,a,d,u,p,!1);for(let t=0;t<h.length;t++)if("path"===h[t].type){const e=ed(h[t],n,d,u,p);c.push(e);}if(0===c.length)return null;const f=[];let v=0;if(c.forEach((i=>{const n=[];let s=[];for(let t=0;t<i.stampPoints.length;t++)2===i.stampPoints[t].step&&s.length>0&&(n.push(s),s=[]),s.push(i.stampPoints[t]);s.length>0&&(n.push(s),s=[]);const r=i.borderWidth;for(let s=0;s<n.length;s++){const a=n[s],l=t.quadPoints[v];v+=1;const h=l[0]*d,c=(p-l[1])*u,g=l[2]*d,m=(p-l[5])*u;let y;if(i.quadPointsRect={left:h,top:c,width:g-h,height:m-c},"highlight"===e){const t=[];for(let e=0;e<a.length;e++)2===a[e].step?t.push({x:a[e].x,y:a[e].y}):1===a[e].step?e+2<a.length&&1===a[e+2].step&&(t.push({x:a[e+2].x,y:a[e+2].y}),e+=2):e>0&&!(Math.abs(a[e].x-a[e-1].x)<=o&&Math.abs(a[e].y-a[e-1].y)<=o)&&t.push({x:a[e].x,y:a[e].y});if(t.length>=4){let e=1/0,i=1/0,n=-1/0,s=-1/0;t.forEach((t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),s=Math.max(s,t.y);})),y={left:e,top:i,width:n-e,height:s-i};}}else if("strikeout"===e){if(a.length>=2){const t=i.quadPointsRect.top,e=a[1].y;y={left:a[1].x>a[0].x?a[0].x:a[1].x,top:t,width:a[1].x>a[0].x?a[1].x-a[0].x:a[0].x-a[1].x,height:2*Math.abs(e-t)};}}else if("underline"===e&&a.length>=2){const t=2*(i.quadPointsRect.top+i.quadPointsRect.height/2)-(a[0].y+r/2);y={left:a[1].x>a[0].x?a[0].x:a[1].x,top:t,width:a[1].x>a[0].x?a[1].x-a[0].x:a[0].x-a[1].x,height:a[0].y+r/2-t};}y&&f.push(y);}})),0===f.length)return null;const m=c[0];return {type:e,style:{annotationRaw:t,lines:f,borderColor:m.borderColor,borderWidth:m.borderWidth,background:m.background||"",lineCap:m.lineCap,lineJoin:m.lineJoin,lineDash:m.lineDash,miterLimit:m.miterLimit},transform:g}}parseIncomplete(t){const{normalAppearance:e,opacity:i}=t;if(!e)return null;const{objs:n,transform:s,bbox:o}=t.normalAppearance;if(!n||0===n.length)return null;const r=ud(n),a=[],{ratioX:l,ratioY:h,pageHeight:c}=this,{position:d,angle:u,scale:p}=od(r,o,s,l,h,c),g={position:d,angle:u,scale:p};for(let e=0;e<r.length;e++){let n;if("path"===r[e].type)n=ed(r[e],i,l,h,c);else if("text"===r[e].type)n=id(r[e],i,l,h,c);else if("image"===r[e].type){let i;i=r[e].jpegBase64?`data:image/jpeg;base64,${r[e].jpegBase64}`:nd(r[e].RGBABase64,r[e].width,r[e].height);const n={type:"incomplete",style:{imageData:i,width:(r[e].rect[2]-r[e].rect[0])*this.ratioX,height:(r[e].rect[3]-r[e].rect[1])*this.ratioY,annotationRaw:t},transform:g};return n.transform.position.x+=(r[e].rect[0]-o[0])*this.ratioX,n.transform.position.y-=(r[e].rect[3]-o[3])*this.ratioY,n}n&&a.push(n);}return {type:"incomplete",style:{stampConfig:a,annotationRaw:t},transform:g}}parseUnknown(t){return {type:"unknown",style:{annotationRaw:t}}}}class xd{constructor(){i(this,"map",new Map),i(this,"ratioX",ko.displayResolution/ko.pdfResolution),i(this,"ratioY",ko.displayResolution/ko.pdfResolution);}async toPdfAnnotations(t,e){const i=[],n=[...t];n.sort(((t,e)=>t.layer-e.layer));for(let t=0;t<n.length;t++){const s=n[t];if(s){const t=await this.toPdfAnnotation(s,{width:e.width/this.ratioX,height:e.height/this.ratioY});if(t){t.oriIndex=s.oriIndex,t.modified=s.modified;const{flags:e}=s,n=[];["noResize","noMove","noRotate"].forEach((t=>{e.includes(t)&&n.push(t);})),n.length&&(t.customData={...s.customData||{},dynamsoftFlags:n}),i.push(t);}}}return i}async toPdfAnnotation(t,e){if("stamp"===t.type&&t.style.imageData&&(!Xn(t.style.width)||!Xn(t.style.height))){const e=new wo,i=await e.readImageInfo({fileSource:t.style.imageData});let n=i.imageWidth,s=i.imageHeight;if(n>400||s>400){const t=Math.max(n/400,s/400);n/=t,s/=t;}t.style.width=n,t.style.height=s;}const i=this.createShape(t);if(i instanceof xh&&"freeTextWriter"===i.textType){const{width:t,height:e}=i.getBoundingRect();i.setOrigin(t/2,e/2);}let n=null;switch(t.type){case"rectangle":case"ellipse":n=this.toPdfRectOrEllipse(t,e,i);break;case"polyline":case"polygon":n=this.toPdfPolygonal(t,e,i);break;case"line":n=this.toPdfLine(t,e,i);break;case"ink":n=this.toPdfInk(t,e,i);break;case"stamp":n=await this.toPdfStamp(t,e,i);break;case"textBox":n=this.toPdfFreeText(t,e,i,"textBox");break;case"textTypewriter":n=this.toPdfFreeText(t,e,i,"freeTextWriter");break;case"highlight":n=this.toPdfTextAssist(t,"Highlight",e,i);break;case"underline":n=this.toPdfTextAssist(t,"Underline",e,i);break;case"strikeout":n=this.toPdfTextAssist(t,"StrikeOut",e,i);break;case"incomplete":case"unknown":n=t.style.annotationRaw;}return n&&(n.title=t.comment.author,n.subject=t.comment.subject,n.creationdate=t.comment.creationDate),i&&i.destroy(),n}toPdfRectOrEllipse(t,e,i){const{borderColor:n,background:s,lineDash:o}=t.style,{borderWidth:r,opacity:a}=i.parsedStyle,{strokeColor:l,fillColor:h}=Mc(n,s),{apStrokeColor:c,apFillColor:d}=Bc(n,s,a),u=Uc(r,o,this.ratioX),p=u.width,g="rectangle"===t.type?Xc(i,p,this.ratioX,this.ratioY,e.height):function(t,e,i,n){const{x:s,y:o}=t.getLocalPosition();t.path||t.getPath();const{path:r}=t,a=[];for(let t=0;t<r.length;t++){const l=(r[t].x+s)/e,h=n-(r[t].y+o)/i;0===t?(a.push([l,h,2,!1]),a.push([l,h,0,!1])):t===r.length-1?a.push([l,h,1,!0]):a.push([l,h,1,!1]);}return a}(i,this.ratioX,this.ratioY,e.height),f=Yc(i,d,c,a,p,g,this.ratioX);i.path||i.getPath();return {type:"rectangle"===t.type?"Square":"Circle",normalAppearance:f,interiorColor:h,color:l,borderStyle:u,opacity:a,rect:Wc(i,i.path,p,this.ratioX,this.ratioY,e.height),flags:jc([...t.flags]),date:t.comment.modificationDate,name:t.uid,contents:""}}toPdfPolygonal(t,e,i){const{borderWidth:n,opacity:s}=i.parsedStyle,{borderColor:o,background:r,lineEnding:a,lineDash:l}=t.style,h="polyline"===t.type,{strokeColor:c,fillColor:d}=Mc(o,r),{apStrokeColor:u,apFillColor:p}=Bc(o,r,s),g=Uc(n,l,this.ratioX),f=g.width;let v,m,y;h?(v=Gc(i,this.ratioX,this.ratioY,e.height),m=v.flat(),y=Nc(v[0])):(v=function(t,e,i,n){t.renderPath||t.getPath();const{x:s,y:o}=t.getLocalPosition(),{renderPath:r}=t,a=[];for(let t=0;t<r.length;t++){const l=(r[t].x+s)/e,h=n-(r[t].y+o)/i;if(0!==t){if(t===r.length-1){a.push([l,h,0,!0]);break}a.push([l,h,0,!1]);}else a.push([l,h,2,!1]);}return a}(i,this.ratioX,this.ratioY,e.height),m=v,y=Nc(m));const x=Yc(i,p,u,s,f,m,this.ratioX,!h);if(h){const t=[];v.forEach((e=>{t.push(qc(i,e,p,u,f,Fc(l,this.ratioX)));})),x.objs=t;}const w={type:h?"PolyLine":"Polygon",borderStyle:g,color:c,interiorColor:d,normalAppearance:x,vertices:y,opacity:s,rect:Wc(i,i.renderPath,f,this.ratioX,this.ratioY,e.height),name:t.uid,contents:"",flags:jc([...t.flags]),date:t.comment.modificationDate};return h&&i.isLineArrow()&&(w.lineEnding=a),w}toPdfLine(t,e,i){const{borderWidth:n,opacity:s}=i.parsedStyle,{borderColor:o,background:r,lineEnding:a,lineDash:l}=t.style,{strokeColor:h,fillColor:c}=Mc(o,r),{apStrokeColor:d,apFillColor:u}=Bc(o,r,s),p=Uc(n,l,this.ratioX),g=p.width,f=Gc(i,this.ratioX,this.ratioY,e.height),v=f.flat(),m=[];f.forEach((t=>{m.push(qc(i,t,u,d,g,Fc(l,this.ratioX)));}));const y=Yc(i,u,d,s,g,v,this.ratioX,!1);y.objs=m;const x={type:"Line",line:[v[0][0],v[0][1],v[1][0],v[1][1]],interiorColor:c,color:h,normalAppearance:y,borderStyle:p,opacity:s,rect:Wc(i,i.renderPath,g,this.ratioX,this.ratioY,e.height),name:t.uid,contents:"",flags:jc([...t.flags]),date:t.comment.modificationDate,toJsonString:()=>""};return i.isLineArrow()&&(x.lineEnding=a,x.intent="LineArrow"),x}toPdfInk(t,e,i){const{borderWidth:n,opacity:s}=i.parsedStyle,{borderColor:o,background:r,lineDash:a}=t.style,{strokeColor:l}=Mc(o,r),{apStrokeColor:h,apFillColor:c}=Bc(o,r,s),d=Uc(n,a,this.ratioX),u=d.width,p=function(t,e,i,n){t.inkOriginalRenderPath||t.getInkOriginalRenderPath();const{x:s,y:o}=t.getLocalPosition(),{inkOriginalRenderPath:r}=t,a=[];for(let t=0;t<r.length;t++){const l=r[t],h=[];for(let t=0;t<l.length;t++){const r=(l[t].x+s)/e,a=n-(l[t].y+o)/i;0===t?h.push([r,a,2,!1]):h.push([r,a,1,!1]);}if(h.length&&h.length<4)for(;h.length<4;){const t=h[h.length-1];h.push([...t]);}a.push(h);}return a}(i,this.ratioX,this.ratioY,e.height),g=p.flat(),f=[],{x:v,y:m}=i.getLocalPosition();i.getPath();const{inkRenderSteps:y}=i,x=[];y.forEach((t=>{const i=[];t.forEach(((t,n)=>{if(0===n){const n=(t.data[0].x+v)/this.ratioX,s=e.height-(t.data[0].y+m)/this.ratioY;i.push([n,s,2,!1]);}else t.data.forEach((t=>{const n=(t.x+v)/this.ratioX,s=e.height-(t.y+m)/this.ratioY;i.push([n,s,1,!1]);}));})),x.push(i);})),x.forEach((t=>{f.push(qc(i,t,c,h,u,Fc(a,this.ratioX)));}));const w=Yc(i,c,h,s,u,g,this.ratioX,!1);w.objs=f;return {type:"Ink",color:l,normalAppearance:w,borderStyle:d,opacity:s,inkList:_c(p),rect:Wc(i,i.inkOriginalRenderPath.flat(),u,this.ratioX,this.ratioY,e.height),name:t.uid,contents:"",flags:jc([...t.flags]),date:t.comment.modificationDate}}async toPdfStamp(t,e,i){const{imageData:n,iconName:s,opacity:o}=t.style;if(n){return await this.toPdfStampImage(t,e,i)}const r=i.childNodes,a=function(t,e,i,n){const s=t.childNodes,o=[];for(let t=0;t<s.length;t++){if(!(s[t]instanceof Ha))continue;const r=[],{renderPath:a}=s[t],{x:l,y:h}=s[t].getLocalPosition();a.forEach(((t,s)=>{const o=[(t.x+l)/e,n-(t.y+h)/i,t.step,!1];s===a.length-1&&(o[3]=!0),r.push(o);})),o.push(r);}return o}(i,this.ratioX,this.ratioY,e.height),l=[],h=[];let c=0,d=0;for(let i=0;i<r.length;i++){let n;const s=r[i].parsedStyle.opacity;if(r[i].style.opacity=s/(t.style.opacity||1),r[i]instanceof Ha){const t=zc(r[i]);h.push(...t);const{borderWidth:e,lineDash:s}=r[i].parsedStyle,{borderColor:u,background:p}=r[i].style,{apStrokeColor:g,apFillColor:f}=Bc(u,p,o),v=Uc(e,s,this.ratioX).width,m=$c(p,a[c]);d=Math.max(v,d),n=qc(r[i],a[c],f,g,v,Fc(s,this.ratioX)),m&&(n.pattern=m),c+=1,l.push(n);}r[i]instanceof za&&(n=Jc(r[i],this.ratioX,this.ratioY,e.height),l.push(n));}const u=Yc(i,null,null,o,d,a.flat(),this.ratioX,!1);u.objs=l;return {type:"Stamp",icon:s,rect:Wc(i,h,d,this.ratioX,this.ratioY,e.height),normalAppearance:u,opacity:o,name:t.uid,contents:"",flags:jc([...t.flags]),date:t.comment.modificationDate}}async toPdfStampImage(t,e,i){const{imageData:n,opacity:s}=t.style;let o=n,r=[];Gn(n)&&(r=n.split(","),r[0].match(/:(.*?);/)[1],o=function(t){let e=null;const i=t.split(","),n=i[0].match(/:(.*?);/)[1],s=window.atob(i[1]);let o=s.length;const r=new Uint8Array(o);for(;o--;)r[o]=s.charCodeAt(o);return e=new Blob([r],{type:n}),e}(n));const{width:a,height:l}=i.parsedStyle,h=Lc(i),c=[0,0,a.value/this.ratioX,l.value/this.ratioY],d=await async function(t,e,i,n){const{width:s,height:o}=t.parsedStyle,r=s.value/i,a=o.value/n;let l;if("image/jpeg"===e.type){const t=new wo,i=await t.readImage({source:{fileSource:e},outputType:1,returnBase64:!0});t.destroy(),l={type:"image",jpegBase64:i.imageData,objMatrix:[r,0,0,a,0,0],rect:[0,0,r,a]};}else {const t=new wo,i=await t.readImage({source:{fileSource:e},outputType:-2,returnBase64:!0});t.destroy(),l={type:"image",RGBABase64:i.imageData,height:i.imageHeight,width:i.imageWidth,objMatrix:[r,0,0,a,0,0],rect:[0,0,r,a]};}return l}(i,o,this.ratioX,this.ratioY),u=function(t,e,i,n){const{width:s,height:o}=t.parsedStyle,{x:r,y:a}=t.getLocalScale(),{x:l,y:h}=t.getLocalPosition(),c=t.getAngle(),d=l+s.value/2,u=h+o.value/2,p=s.value*r*.5,g=n*i-o.value*a*.5-u;let f=new Fa({style:{x:d-p,y:n*i-o.value*a-g,width:s.value*r,height:o.value*a}});f.setAngle(c),f.getPath();const v=Wc(f,f.path,0,e,i,n);return f=null,v}(i,this.ratioX,this.ratioY,e.height);return {type:"Stamp",normalAppearance:{bbox:c,matrix:h,objs:[d],transform:h},rect:u,opacity:s,name:t.uid,contents:"",flags:jc([...t.flags]),date:t.comment.modificationDate}}toPdfFreeText(t,e,i,n){const{opacity:s,textContents:o,borderColor:r,background:a,lineDash:l,textAlign:h}=t.style;"freeTextWriter"===n&&(i.style.borderWidth=0);const{borderWidth:c}=i.parsedStyle,{strokeColor:d,fillColor:u}=Mc(r,a),{apStrokeColor:p,apFillColor:g}=Bc(r,a,s),f="textBox"===n?Uc(c,l,this.ratioX):{width:0},v=f.width,m=Yc(i,g,p,s,v,Xc(i,v,this.ratioX,this.ratioY,e.height),this.ratioX,"textBox"===n),y=function(t,e,i,n){const{lines:s}=t,{opacity:o}=t.parsedStyle,r=[],a=(t,e,i)=>({type:"path",strokeColor:t,fillColor:t,fillType:0,isStroke:!0,lineCap:0,lineJoin:0,miterLimit:10,lineWidth:i,objMatrix:[1,0,0,1,0,0],segments:e,dashArray:[],dashPhase:0});return s.forEach((s=>{const l=s.height/30,h=t.getTextAlignOffset(s);s.words.forEach((c=>{const{fontFamily:d,fontSize:u,fontStyle:p,fontWeight:g,color:f,underline:v,lineThrough:m}=c.style,y=Ic(f,1,!1),x=y?[...y,255*o]:[0,0,0,255],w=(c.x+h)/e,b=n-s.y/i,S={type:"text",charSpace:0,wordSpace:0,renderMode:0,fontPitchFamily:0,strokeColor:[0,0,0,255],fillColor:x,fontName:d,fontIsBold:Qc(g),fontIsItalic:"italic"===p,fontSize:u.value/e,text:(C=c.text,C.replace(/\r?\n?$/,"")),objMatrix:[1,0,0,1,w,b],position:[w,b],blendMode:td(t.style.renderBlendMode)||"Normal"};var C;if(r.push(S),v){const t=n-(s.y+l)/i,o=a(x,[[w,t,2,!1],[w+c.widthWithoutLf/e,t,0,!1]],l/i);r.push(o);}if(m){const t=n-(s.y-c.wordHeight/3)/i,o=a(x,[[w,t,2,!1],[w+c.widthWithoutLf/e,t,0,!1]],l/i);r.push(o);}}));})),r}(i,this.ratioX,this.ratioY,e.height);"textBox"===n?m.objs.push(...y):m.objs=y;const{defaultAppearance:x,defaultAppearanceData:w,defaultStyle:b}=function(t,e,i,n,s){const o=i[0]||{color:"rgb(0,0,0)",fontFamily:"Times Roman",fontStyle:"normal",fontWeight:"normal",fontSize:"12px"},{fontFamily:r,fontSize:a,fontStyle:l,fontWeight:h,color:c}=o,d=Ic(c,1,!1),u=Tr(`rgb(${d[0]}, ${d[1]}, ${d[2]})`),p=mr(a).value/s,g=Kc(r," ","");return {defaultAppearance:"textBox"===t?`${e[0]/255} ${e[1]/255} ${e[2]/255} rg /${g} ${p} Tf`:`${d[0]/255} ${d[1]/255} ${d[2]/255} rg /${g} ${p} Tf`,defaultStyle:`font:${"bold"===h?"bold":""} ${"italic"===l?"italic":""} '${r}' ${p}pt; text-align:${"justify"===n?"justify-center":n}; color:${u.toLocaleUpperCase()}`,defaultAppearanceData:{fontColor:d,fontSize:p,fontName:r}}}(n,d||[0,0,0],o,"freeTextWriter"===n?"left":h,this.ratioX);i.getPath();const S=Wc(i,i.path,v,this.ratioX,this.ratioY,e.height);let C="";o.forEach((t=>{C+=t.content;}));const P=function(t,e,i){if(!t||!t.length)return null;const n=document.implementation.createDocument(null,"body",null),s=n.documentElement;s.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),s.setAttribute("xmlns:xfa","http://www.xfa.org/schema/xfa-data/1.0/"),s.setAttribute("xfa:APIVersion","Acrobat:18.11.0"),s.setAttribute("xfa:spec","2.0.2");const o=t=>`font-size:${mr(t).value/i}pt;`,r=t=>`font-weight:${"bold"===t?"bold":"normal"};`,a=t=>`font-style:${"italic"===t?"italic":"normal"};`,l=t=>`color:${Tr(kr(t).formatted)};`,h=t=>`font-family:'${t}';`,c=t[0],{fontFamily:d,fontSize:u,fontStyle:p,fontWeight:g,color:f}=c,v=kr(f),m=`${o(u)}text-align:${"justify"===e?"justify-center":e};${l(v.formatted)}${r(g)}${a(p)}${h(d)}font-stretch:normal;`;s.setAttribute("style",m);const y=n.createElement("p");y.setAttribute("dir","ltr"),t.forEach((t=>{if(!t.content.length)return;const e=n.createElement("span"),i=n.createTextNode(t.content);e.appendChild(i);let s="";d!==t.fontFamily&&(s+=h(t.fontFamily)),u!==t.fontSize&&(s+=o(t.fontSize)),p!==t.fontStyle&&(s+=a(t.fontStyle)),g!==t.fontWeight&&(s+=r(t.fontWeight)),f!==t.color&&(s+=l(t.color)),(t.lineThrough||t.underline)&&(s+=`text-decoration:${t.underline?"word":""} ${t.lineThrough?"line-through":""}`),s&&e.setAttribute("style",s),y.appendChild(e);})),s.appendChild(y);const x=`<?xml version="1.0"?>${(new XMLSerializer).serializeToString(n)}`,w='xmlns="http://www.w3.org/1999/xhtml"';return x.includes(w)?Kc(x,'xmlns=""',w):Kc(x.replace(/<body/,`<body ${w}`),'xmlns=""',w)}(o,h,this.ratioX),T={borderStyle:f,type:"FreeText",color:u,normalAppearance:m,defaultAppearance:x,defaultAppearanceData:w,defaultStyle:b,rect:S,name:t.uid,contents:C,opacity:s,flags:jc([...t.flags]),date:t.comment.modificationDate};return "freeTextWriter"===n&&(T.intent="FreeTextTypeWriter"),P&&(T.richText=P),T}toPdfTextAssist(t,e,i,n){const{opacity:s,borderColor:o,background:r}=t.style,{lineDash:a,borderWidth:l,lineCap:h,lineJoin:c,miterLimit:d}=n.parsedStyle,{strokeColor:u,fillColor:p}=Mc(o,r),{apStrokeColor:g,apFillColor:f}=Bc(o,r,s),v="Highlight"===e?0:Uc(l,a,this.ratioX).width,m={blendMode:td(n.style.renderBlendMode),dashArray:Fc(a,this.ratioX),dashPhase:0,fillColor:f||[0,0,0,0],fillType:f||"Highlight"===e?2:0,isStroke:"Highlight"!==e&&v>0,lineCap:Hc(h),lineJoin:Vc(c),lineWidth:v,miterLimit:d,objMatrix:[1,0,0,1,0,0],segments:void 0,strokeColor:g||[0,0,0,0],type:"path"},y=[],x=[],w=[1/0,1/0,-1/0,-1/0],b=[];n.lines.forEach((t=>{const e=t.left/this.ratioX,s=(t.left+t.width)/this.ratioX,o=i.height-t.top/this.ratioY,r=i.height-(t.top+t.height)/this.ratioY;let a;"annotationHighlight"===n.shapeType?a=[[e,o,2,!1],[s,o,0,!1],[s,r,0,!1],[e,r,0,!1],[e,o,0,!0]]:"annotationUnderline"===n.shapeType?a=[[e,r+v/2,2,!1],[s,r+v/2,0,!1]]:"annotationStrikeout"===n.shapeType&&(a=[[e,(o+r)/2,2,!1],[s,(o+r)/2,0,!1]]),w[0]=Math.min(w[0],e),w[1]=Math.min(w[1],r),w[2]=Math.max(w[2],s),w[3]=Math.max(w[3],o),b.push(...a),x.push([e,o,s,o,e,r,s,r]);}));const S=Nn(m);S.segments=b,y.push(S);return {type:e,color:"Highlight"===e?p:u,rect:[...w],normalAppearance:{bbox:w,blendMode:td(n.style.renderBlendMode),matrix:[1,0,0,1,-w[0],-w[1]],objs:y,transform:[1,0,0,1,0,0]},opacity:s,quadPoints:x,name:t.uid,flags:jc([...t.flags]),date:t.comment.modificationDate}}createShape(t){const{type:e,transform:i,style:n}=Nn(t),s={id:t.uid,style:n,transform:i};let o;switch("ellipse"===e&&(n.x+=n.width/2||0,n.y+=n.height/2||0,n.rx=n.width/2||n.rx,n.ry=n.height/2||n.ry),e){case"rectangle":o=new vh(s);break;case"ellipse":o=new ph(s);break;case"line":o=new Th(s);break;case"ink":o=new fh(s);break;case"polygon":o=new Ch(s);break;case"polyline":o=new Ph(s);break;case"textTypewriter":o=new xh(s,"freeTextWriter",{});break;case"textBox":o=new xh(s,"textBox");break;case"stamp":o=new Nh(s);break;case"highlight":o=new $h(s);break;case"underline":o=new Xh(s);break;case"strikeout":o=new jh(s);}return o}}class wd{constructor(){i(this,"annotationParser",new yd),i(this,"annotationWriter",new xd);}getParsedAnnotations(t,e,i){const n=ko.displayResolution/ko.pdfResolution;t=t.filter((t=>null!==t)),this.annotationParser.setParserConfig(e,i,n,n),this.moveReplyToAnnotation(t);const s=[];return t.forEach(((t,e)=>{var i;if(t){const r=this.annotationParser.parseAnnotation(t);if(r){var n,o;switch(r.flags=this.parseFlags(t.flags||[]),null!=t&&null!==(n=t.customData)&&void 0!==n&&null!==(n=n.dynamsoftFlags)&&void 0!==n&&n.length&&r.flags.push(...t.customData.dynamsoftFlags),r.customData={...t.customData},t.type){case"Underline":case"Highlight":case"StrikeOut":r.flags.push("noMove","noRotate");break;case"FreeText":"freetexttypewriter"===(null==t||null===(i=t.intent)||void 0===i?void 0:i.toLocaleLowerCase())&&r.flags.push("noRotate","noResize");break;case"Line":case"Polygon":case"Polyline":r.flags.push("noRotate");}const a=this.parseReply(t);null!==(o=t.replies)&&void 0!==o&&o.length&&(a.replies=t.replies.map((t=>this.parseReply(t)))||[]),r.parsedOriIndex=e,r.comment=a,s.push(r);}}})),s}moveReplyToAnnotation(t){t.forEach((e=>{if(e&&"Text"===e.type&&!_n(e.inreplyto)){const i=t[e.inreplyto];"Review"===e.statemodel?(i.reviewStates||(i.reviewStates=[]),i.reviewStates.push(e)):"Marked"===e.statemodel?(i.markedStates||(i.markedStates=[]),i.markedStates.push(e)):(i.replies||(i.replies=[]),i.replies.push(e));}})),t.slice().forEach((e=>{if(!e||"Popup"===e.type||!_n(e.inreplyto)){const i=t.findIndex((t=>t===e));t.splice(i,1);}}));}parseReply(t){var e,i;const n=this.parseCommon(t);return n.subject=t.subject,null!==(e=t.reviewStates)&&void 0!==e&&e.length&&(n.reviewStates=t.reviewStates.map((t=>this.parseState(t)))),null!==(i=t.markedStates)&&void 0!==i&&i.length&&(n.markedStates=t.markedStates.map((t=>this.parseState(t)))),n}parseFlags(t){const e=[],i={readonly:"readOnly",noview:"noView"};return t.forEach((t=>{e.push(i[t]||t);})),t.includes("hidden")&&!e.includes("noView")&&e.push("noView"),e}parseState(t){return {...this.parseCommon(t),state:t.state,stateModel:t.statemodel}}parseCommon(t){const e=t.creationdate,i=t.date;return {uid:Jn(),author:t.title,contents:t.contents,type:t.type,creationDate:e||i,modifiedDate:i||e,flags:t.flags?[...t.flags]:[]}}parseDate(t){if(!t)return;let e=2;if(!t)return "";const i=[4,2,2,2,2,2].map((i=>{const n=t.slice(e,e+i);return e+=i,parseInt(n,10)}));i[1]-=1;const n=new Date(...i).getTime();return Fn("yyyy.MM.dd hh:mm:ss",n)}async getOriginalAnnotations(t,e){return await this.annotationWriter.toPdfAnnotations(t,e)}}function bd(t){return {left:t[0],top:t[1],width:t[2]-t[0],height:t[3]-t[1]}}!function(t){t.CM_RENDERALL="cm/renderall",t.CM_IMAGEONLY="cm/imageonly",t.CM_AUTO="cm/auto";}(oc||(oc={})),function(t){t.NO_ANNOTATIONS="noAnnotations",t.RENDER_ANNOTATIONS="renderAnnotations",t.LOAD_ANNOTATIONS="loadAnnotations";}(rc||(rc={}));var Sd=new WeakSet;class Cd{constructor(){v(this,Sd),i(this,"type","pdfParser"),i(this,"once",!1),i(this,"pdfReader",void 0),i(this,"parserOptions",{convertMode:oc.CM_AUTO}),i(this,"source",void 0),i(this,"isDestroy",!1),i(this,"annotationMapper",void 0),this.pdfReader=new So,this.annotationMapper=new wd;}initParser(t,e){this.parserOptions=null!=e?e:{convertMode:oc.CM_AUTO},this.source={fileSource:t,password:this.parserOptions.password};}async getPageCount(){return this.pdfReader.getPdfPageCount(this.source,p(this,Sd,Pd).call(this))}destroy(){var t;null===(t=this.pdfReader)||void 0===t||t.destroy(),this.pdfReader=null,this.source=null,this.parserOptions=null,this.isDestroy=!0;}splitArrayIntoChunks(t,e){const i=[];for(let n=0;n<t.length;n+=e){const s=t.slice(n,n+e);i.push(s);}return i}async parseAnnotations(t,e){var i;const n=[];if(this.parserOptions.convertMode===oc.CM_IMAGEONLY||(null===(i=this.parserOptions.renderOptions)||void 0===i?void 0:i.renderAnnotations)!==rc.LOAD_ANNOTATIONS)return n;for(let i=0;i<t.length;i++){const s=e[t[i]],o=s.nativeMediaBox;if(1===s.realReadMode&&s.pdfOptions.annotCount>0){if(this.isDestroy)return [];const e=await this.pdfReader.readAnnotations(this.source,t[i]),r={pageUid:s.pageUid,fileIndex:t[i],annotations:[]};e.length&&(r.annotations=this.annotationMapper.getParsedAnnotations(e,2*o.left+o.width,2*o.top+o.height),s.pdfOptions.parsedAnnotCount=r.annotations.length,s.annotations=r.annotations),n.push(r);}}return n}async parse(t){const e=[],i=this.parserOptions.convertMode===oc.CM_RENDERALL?[t]:this.splitArrayIntoChunks(t,100);for(let t=0;t<i.length;t++){const o=await this.pdfReader.readPageImageInfos({source:this.source,indices:i[t],readOptions:p(this,Sd,Pd).call(this),outputType:uo.IT_JPG,isInfoOnly:!1,returnBase64:!1}),{displayResolution:r,pdfResolution:a}=ko;for(let t=0;t<o.length;++t){var n,s;const i=o[t];i.mediaBox[0]>i.mediaBox[2]&&([i.mediaBox[0],i.mediaBox[2]]=[i.mediaBox[2],i.mediaBox[0]]),i.mediaBox[1]>i.mediaBox[3]&&([i.mediaBox[1],i.mediaBox[3]]=[i.mediaBox[3],i.mediaBox[1]]),i.cropBox[0]>i.cropBox[2]&&([i.cropBox[0],i.cropBox[2]]=[i.cropBox[2],i.mediaBox[0]]),i.cropBox[1]>i.cropBox[3]&&([i.cropBox[1],i.cropBox[3]]=[i.cropBox[3],i.cropBox[1]]);const l=1===i.realReadMode,h=l?bd(i.mediaBox):{left:0,top:0,width:i.imageWidth/i.imageXResolution*a,height:i.imageHeight/i.imageYResolution*a},c=l?bd([i.cropBox[0],i.mediaBox[1]+i.mediaBox[3]-i.cropBox[3],i.cropBox[2],i.mediaBox[1]+i.mediaBox[3]-i.cropBox[1]]):{...h},d=Hs(h,a,r),u=Hs(c,a,r),p={fileIndex:i.pageIndex,rotation:i.rotation,mediaBox:d,cropBox:u,nativeMediaBox:h,nativeCropBox:c,resource:{width:i.imageWidth,height:i.imageHeight,resolutionX:i.imageXResolution,resolutionY:i.imageYResolution,bitDepth:i.imageBitDepth},pdfOptions:{convertMode:l?oc.CM_RENDERALL:oc.CM_IMAGEONLY,renderOptions:{renderAnnotations:null===(n=this.parserOptions.renderOptions)||void 0===n?void 0:n.renderAnnotations,renderGrayscale:null===(s=this.parserOptions.renderOptions)||void 0===s?void 0:s.renderGrayscale},rotation:i.rotation,mediaBox:{...d},cropBox:{...u},annotCount:i.annotCount},realReadMode:i.realReadMode,annotations:[]};e.push(p);}}return e}async getPage(t){if(this.isDestroy||!this.source)return null;const e=await this.pdfReader.readPage({source:this.source,index:t,readOptions:p(this,Sd,Pd).call(this),outputType:uo.IT_JPG,isInfoOnly:!1,returnBase64:!1});if(e&&0===e.code){const{displayResolution:t,pdfResolution:i}=ko,n=e.imageInfos[0];return {fileIndex:e.pageIndex,rotation:e.rotation,mediaBox:Hs(bd(e.mediaBox),i,t),cropBox:Hs(bd(e.cropBox),i,t),resource:{data:e.imageData,width:n.imageWidth,height:n.imageHeight,resolutionX:n.imageXResolution,resolutionY:n.imageYResolution,bitDepth:n.imageBitDepth}}}return null}async getPageTexts(t){if(this.isDestroy||!this.source)return null;return await this.pdfReader.getCharInfos(this.source,(null==t?void 0:t.slice())||[])}cancelGetPage(t){!this.isDestroy&&this.source&&this.pdfReader.cancelReadPage(this.source,t);}}function Pd(){var t,e;if(this.isDestroy)return null;if(!this.parserOptions)return null;const i={[rc.NO_ANNOTATIONS]:0,[rc.RENDER_ANNOTATIONS]:1,[rc.LOAD_ANNOTATIONS]:2};return {convertMode:{[oc.CM_IMAGEONLY]:2,[oc.CM_RENDERALL]:1,[oc.CM_AUTO]:3}[(null===(t=this.parserOptions)||void 0===t?void 0:t.convertMode)||oc.CM_AUTO],renderOptions:{...this.parserOptions.renderOptions||{},renderAnnotations:i[null===(e=this.parserOptions.renderOptions)||void 0===e?void 0:e.renderAnnotations]||0,renderIgnoreCrop:!0,ignorePageRotation:!0}}}class Td{constructor(){i(this,"type","rgbaParser"),i(this,"once",!1),i(this,"processor",void 0),i(this,"cachePage",[]),i(this,"source",void 0),i(this,"parserOptions",void 0),this.processor=new xo;}initParser(t,e){this.source=t,this.parserOptions=e;}async getPageCount(){return 1}destroy(){var t;null===(t=this.processor)||void 0===t||t.terminate(),this.processor=void 0,this.source=null;}async parse(){var t;const{outputType:e,jpegQuality:i,returnBase64:n,width:s,height:o,bitDepth:r,xResolution:a,yResolution:l}=null!==(t=this.parserOptions)&&void 0!==t?t:{},h=await this.source.arrayBuffer();await this.processor.initImage({source:h,isRGBA:!0,width:s,height:o,isBGRA:!1});const c=await this.processor.getImage({jpegQuality:i,ifDeleteObject:!0,isRGBA:!0,bitDepth:r,xDpi:a,yDpi:l,returnBlob:!0,returnType:e}),d=Ec(c);return c.srcBuffer,this.cachePage=[d],this.cachePage}async parseAnnotations(t,e){return []}async getPage(){return Promise.resolve(this.cachePage[0])}cancelGetPage(t){}getPageTexts(t){return null}}class Ad{constructor(){i(this,"db",void 0),this.db=new Map;}saveByMime(t,e){this.db.set(t,e);}hasByMime(t){return this.db.has(t)}deleteConstructorByMime(t){return !!this.hasByMime(t)&&(this.db.delete(t),!0)}getConstructorByMime(t){return this.db.get(t)}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}}const kd=new class{constructor(){i(this,"db",void 0),this.db=new Map;}saveByFileUid(t,e){this.db.set(t,e);}getParserByFileUid(t){return this.db.get(t)}deleteParserByFileUid(t){return this.db.delete(t)}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}getAllParsers(){return Array.from(this.db.values())}},Ed=new Ad,Dd=new Ad,Rd=new class{constructor(){i(this,"db",void 0),this.db=new Map;}getDefaultOptionsByMime(t){return this.db.get(t)}deleteDefaultOptionsByMime(t){return this.db.delete(t)}saveDefaultOptionsByMime(t,e){this.db.set(t,e);}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}};const Id=new class{constructor(t,e,n){i(this,"parserRepo",void 0),i(this,"parserConstructorRepo",void 0),i(this,"customParserConstructorRepo",void 0),this.parserRepo=t,this.parserConstructorRepo=e,this.customParserConstructorRepo=n;}getParser(t,e){let i=this.parserRepo.getParserByFileUid(t);if(i)return i;return i=new(this.customParserConstructorRepo.getConstructorByMime(e)||this.parserConstructorRepo.getConstructorByMime(e)),i.once||this.parserRepo.saveByFileUid(t,i),i}}(kd,Ed,Dd);const Md=new class{constructor(t){i(this,"parserRepo",void 0),this.parserRepo=t;}execute(t){let{fileIndex:e,fileUid:i}=t;const n=this.parserRepo.getParserByFileUid(i);n&&n.cancelGetPage(e);}}(kd),Bd=new class{constructor(t){i(this,"parserRepo",void 0),this.parserRepo=t;}execute(t){const e=this.parserRepo.getParserByFileUid(t);e&&(e.destroy(),this.parserRepo.deleteParserByFileUid(t));}}(kd),Ud=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"parserRepo",void 0),this.parserService=t,this.parserRepo=e;}execute(t){const{fileData:e,mime:i,fileUid:n,indices:s}=t;let o=this.parserRepo.getParserByFileUid(n);return o||(o=this.parserService.getParser(n,i),o.initParser(e)),o.getPageTexts(s)}}(Id,kd),Ld=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"parserRepo",void 0),this.parserService=t,this.parserRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:n,fileIndex:s}=t;let o=this.parserRepo.getParserByFileUid(n);return o||(o=this.parserService.getParser(n,i),o.initParser(e)),o.getPage(s)}}(Id,kd),Od=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:n,indices:s}=t;let{parseOptions:o}=t;o=o||this.defaultParserOptionsRepo.getDefaultOptionsByMime(i);const r=this.parserService.getParser(n,i);return r.initParser(e,o),r.parse(s)}}(Id,Rd),Wd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:n,indices:s,parsedPages:o}=t;let{parseOptions:r}=t;r=r||this.defaultParserOptionsRepo.getDefaultOptionsByMime(i);return this.parserService.getParser(n,i).parseAnnotations(s,o)}}(Id,Rd),Nd=new class{constructor(t){i(this,"parserConstructorRepo",void 0),this.parserConstructorRepo=t;}execute(t){let{mime:e,parser:i}=t;this.parserConstructorRepo.saveByMime(e,i);}}(Ed),_d=new class{constructor(t){i(this,"parserConstructorRepo",void 0),this.parserConstructorRepo=t;}execute(t){this.parserConstructorRepo.deleteConstructorByMime(t);}}(Dd),Fd=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){let{mime:e,parser:i}=t;this.customParserConstructorRepo.saveByMime(e,i);}}(Ed),Hd=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){this.customParserConstructorRepo.deleteConstructorByMime(t);}}(Dd),Vd=new class{constructor(t){i(this,"defaultParserOptionsRepo",void 0),this.defaultParserOptionsRepo=t;}execute(t){return this.defaultParserOptionsRepo.getDefaultOptionsByMime(t)}}(Rd),zd=new class{constructor(t,e,n){i(this,"defaultParserOptionsRepo",void 0),i(this,"parserConstructorRepo",void 0),i(this,"customParserConstructorRepo",void 0),this.defaultParserOptionsRepo=t,this.parserConstructorRepo=e,this.customParserConstructorRepo=n;}execute(t){let{mime:e,options:i}=t;return !(!i||!Wn(i)||!this.customParserConstructorRepo.hasByMime(e)&&!this.parserConstructorRepo.hasByMime(e))&&(this.defaultParserOptionsRepo.saveDefaultOptionsByMime(e,Nn(i)),!0)}}(Rd,Ed,Dd),$d=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){return this.customParserConstructorRepo.getConstructorByMime(t)}}(Dd),jd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){var e,i;let{fileData:n,mime:s,fileUid:o,options:r}=t;r=r||this.defaultParserOptionsRepo.getDefaultOptionsByMime(s);const a=this.parserService.getParser(o,s);a.initParser(n,r);return {pageCount:await a.getPageCount(),batchSize:null!==(e=null===(i=r)||void 0===i?void 0:i.batchSize)&&void 0!==e?e:0}}}(Id,Rd);class Xd{constructor(){i(this,"type",void 0),i(this,"once",!1),i(this,"cachedPage",void 0),i(this,"parserOptions",void 0);}initParser(t,e){this.parserOptions=e;}async getPageCount(){return Promise.resolve(1)}destroy(){}async parse(){const{width:t,height:e,bitDepth:i,resolutionX:n,resolutionY:s}=this.parserOptions,o=Ec({imageBitDepth:i,imageHeight:e,imageWidth:t,imageXResolution:n,imageYResolution:s});return this.cachedPage=o,[this.cachedPage]}async parseAnnotations(t,e){return []}async getPage(){const t=await this.createBlankPage(this.parserOptions.width,this.parserOptions.height);return this.cachedPage.resource.data=t,this.cachedPage}cancelGetPage(){}async createBlankPage(t,e){var i,n,s;const o=new Uint8Array([255,255,255,255]),r=new xo;await r.initImage({source:o,isRGBA:!0,width:1,height:1,isBGRA:!1}),await r.resize(t,e);const a=await r.getImage({jpegQuality:null!==(i=this.parserOptions.jpegQuality)&&void 0!==i?i:80,ifDeleteObject:!0,isRGBA:!0,bitDepth:24,xDpi:null!==(n=this.parserOptions.resolutionX)&&void 0!==n?n:96,yDpi:null!==(s=this.parserOptions.resolutionY)&&void 0!==s?s:96,returnBlob:!1,returnType:To[co.JPEG]});return new Blob([a.imageData],{type:a.blobType})}getPageTexts(t){return null}}var Gd;!function(t){t.GOOD="Good",t.AUTO_CAPTURE="AutoCaptured",t.SMALL_SIZE="SmallSize",t.OFF_CENTER="OffCenter",t.SKEW="Skew",t.NOTHING_DETECTED="NothingDetected";}(Gd||(Gd={}));var Yd,qd=new WeakSet,Jd=new WeakSet,Zd=new WeakSet,Qd=new WeakSet,Kd=new WeakSet,tu=new WeakSet,eu=new WeakSet,iu=new WeakSet,nu=new WeakSet,su=new WeakSet;class ou{constructor(){v(this,su),v(this,nu),v(this,iu),v(this,eu),v(this,tu),v(this,Kd),v(this,Qd),v(this,Zd),v(this,Jd),v(this,qd),i(this,"detector",void 0),i(this,"succeedDetect",0),i(this,"failedDetect",0),i(this,"autoCaptureStartTime",0),this.succeedDetect=0,this.failedDetect=0;}destroy(){this.clear();}clear(){var t;null===(t=this.detector)||void 0===t||t.terminate(),this.detector=void 0;}async detect(t,e){return Promise.resolve({success:!1})}getStatusMsg(t){switch(t){case Gd.AUTO_CAPTURE:return "Auto capture completed.";case Gd.GOOD:return "Capturing your document... Please do not move the camera.";case Gd.SMALL_SIZE:return "The document is too small. Try moving closer.";case Gd.OFF_CENTER:return "Try holding the device at the center of the document.";case Gd.SKEW:return "Please hold the device over a document to start scanning.";case Gd.NOTHING_DETECTED:return "No document is detected."}}processDetectResult(t){if([].concat(...t.location).every((t=>0===t)))return {success:!1,confidence:0,status:Gd.NOTHING_DETECTED};let e;const i=this.calculateConfidence(t.location,t.width,t.height);e=_n(t.confidence)?this.calculateTotalConfidence(i):t.confidence;const n={success:!0,location:t.location,confidence:e},{angleConfidence:s,areaConfidence:o,centerConfidence:r}=i,{config:a}=t;if(e>=(null==a?void 0:a.acceptedPolygonConfidence))if(this.succeedDetect+=1,n.status=Gd.GOOD,this.succeedDetect,5===this.succeedDetect||this.succeedDetect,null!=a&&a.enableAutoCapture)if(this.autoCaptureStartTime<=0)this.autoCaptureStartTime=(new Date).getTime();else {(new Date).getTime()-this.autoCaptureStartTime>a.autoCaptureDelay&&(this.autoCaptureStartTime=0,n.status=Gd.AUTO_CAPTURE);}else this.autoCaptureStartTime=0;else .45*s+.45*r+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),n.status=Gd.SMALL_SIZE):.45*s+.45*o+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),n.status=Gd.OFF_CENTER):.45*o+.45*r+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),n.status=Gd.SKEW):(n.success=!1,n.status=Gd.NOTHING_DETECTED,this.failedDetect+=1,this.autoCaptureStartTime=0);return this.failedDetect>5&&this.reset(),n.statusMsg=this.getStatusMsg(n.status),n}calculateConfidence(t,e,i){return p(this,Zd,au).call(this,p(this,qd,ru).call(this,t),e,i)}calculateTotalConfidence(t){const{angleConfidence:e,areaConfidence:i,centerConfidence:n}=t;return e&&i&&n?.3*e+.3*i+.3*n+10:0}reset(){this.succeedDetect=0,this.failedDetect=0,this.autoCaptureStartTime=0;}}function ru(t){if(!t)return [0,0,0,0,0,0,0,0];return [t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1],t[3][0],t[3][1]]}function au(t,e,i){return {angleConfidence:p(this,Qd,lu).call(this,t),areaConfidence:p(this,Kd,hu).call(this,t,e,i),centerConfidence:p(this,tu,cu).call(this,t,e,i)}}function lu(t){let e=0;const i=p(this,iu,uu).call(this,[t[0],t[1]],[t[2],t[3]],[t[4],t[5]]),n=p(this,iu,uu).call(this,[t[2],t[3]],[t[4],t[5]],[t[6],t[7]]),s=p(this,iu,uu).call(this,[t[4],t[5]],[t[6],t[7]],[t[0],t[1]]),o=p(this,iu,uu).call(this,[t[6],t[7]],[t[0],t[1]],[t[2],t[3]]);return e+=Math.abs(i-90),e+=Math.abs(n-90),e+=Math.abs(s-90),e+=Math.abs(o-90),Math.max(0,100*Math.min(1,1-.025*e))}function hu(t,e,i){const n=p(this,su,gu).call(this,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]);return Math.min(100,400*Math.max(0,n/(e*i)))}function cu(t,e,i){const n=[(t[0]+t[2]+t[4]+t[6])/4,(t[1]+t[3]+t[5]+t[7])/4],s=p(this,eu,du).call(this,n,[e/2,i/2]);return Math.max(0,100*Math.min(1,1-s/Math.min(e,i)))}function du(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function uu(t,e,i){const n=p(this,eu,du).call(this,e,t),s=p(this,eu,du).call(this,e,i),o=p(this,eu,du).call(this,t,i);return 0===n||0===s?0:Math.acos((n*n+s*s-o*o)/(2*n*s))/Math.PI*180}function pu(t,e,i,n,s,o){return (t*n+e*s+i*o-s*n-o*t-i*e)/2}function gu(t,e,i,n,s,o,r,a){return p(this,nu,pu).call(this,t,e,i,n,s,o)+p(this,nu,pu).call(this,t,e,s,o,r,a)}!function(t){t.NONE="none",t.BLACK_AND_WHITE="blackAndWhite",t.GRAY="gray",t.REMOVE_SHADOW="removeShadow",t.SAVE_INK="saveInk",t.ENHANCE="enhance",t.INVERT="invert",t.BRIGHTNESS="brightness",t.CONTRAST="contrast",t.BRIGHTNESS_AND_CONTRAST="brightnessAndContrast";}(Yd||(Yd={}));var fu=new WeakMap,vu=new WeakMap,mu=new WeakSet,yu=new WeakSet,xu=new WeakSet;async function wu(t,e,i,n){var s;return await(null===(s=this.filter)||void 0===s?void 0:s.applyFilter(t,e))}function bu(t){return n(this,fu).push(t),n(this,vu)||(s(this,vu,!0),p(this,xu,Su).call(this)),t.promise}async function Su(){do{if(n(this,fu).isEmpty())break;const t=n(this,fu).pop();try{let e;if("filter"===(null==t?void 0:t.api))e=await p(this,mu,wu).apply(this,t.params);null==t||t.resolve(e);}catch(e){t.retry<1?(t.retry+=1,n(this,fu).push(t)):null==t||t.reject(e);}}while(!n(this,fu).isEmpty());s(this,vu,!1);}const Cu=new Map([[Yd.NONE,"None"],[Yd.BLACK_AND_WHITE,"toBW"],[Yd.GRAY,"toGray"],[Yd.REMOVE_SHADOW,"removeShadow"],[Yd.SAVE_INK,"toBW"],[Yd.ENHANCE,"enhance"],[Yd.INVERT,"invert"],[Yd.CONTRAST,"brightnessAndContrast"],[Yd.BRIGHTNESS,"brightnessAndContrast"],[Yd.BRIGHTNESS_AND_CONTRAST,"brightnessAndContrast"]]);var Pu,Tu=new WeakSet,Au=new WeakSet;function ku(t,e){const i={...e||{}};return t===Yd.SAVE_INK&&(i.method="adaptiveThreshold"),i}function Eu(t){var e,i;(t.returnType=To[t.outputType],t.bRGBA=t.outputType===co.RGBA,t.returnBlob=null!==(e=t.returnBlob)&&void 0!==e&&e,t.bRGBA&&void 0===t.returnType)?t.returnType=uo.IT_JPG:t.returnType=null!==(i=t.returnType)&&void 0!==i?i:uo.IT_ALL;return t.is1BitTo8Bit=no.isApple,t}class Du{static replaceMessage(t,e,i){let n=t;return e&&(n=n.replace("<%api%>",e)),i&&(n=n.replace("<%param%>",i)),n}static getLastError(){return this.lastError}static clearLastError(){this.lastError=null;}static buildError(t,e,i){if(t&&!t.code&&t.cause&&t.cause.code&&t.cause.message)return Gn(t.message)&&(t.message=this.replaceMessage(t.message,e,i)),t;const n={code:t.code,message:t.message};null!=t&&t.details&&(n.details=t.details);let s={...t};return n.code>-8e4&&0!==n.code?n.code<=-2e4||(n.code=Du.WASM_ERR.code,n.message=Du.WASM_ERR.message,s.actualCode=s.code,s.code=n.code):n.code?(n.message=this.replaceMessage(n.message,e,i),s={...n},Array.isArray(n.details)&&0!==n.details.length&&(s.details=n.details)):(n.code=Du.EXTERNAL_ERR.code,n.message=Du.EXTERNAL_ERR.message,s.actualCode=t.code,s.message=t.message,t.name&&(s.name=t.name),t.stack&&(s.stack=t.stack),s.code=n.code,s.actualError=t),new Error(n.message,{cause:s})}static warning(t,e,i){const n=Du.buildError(t,e,i);this.lastError=n,this.onWarning.emit(n);}static error(t,e,i){const n=Du.buildError(t,e,i);throw this.lastError=n,this.onError.emit(n),n}static verbose(t,e,i){this.onVerbose.emit(t);}static throw(t,e,i){const n=Du.buildError(t,e,i);throw this.lastError=n,this.onError.emit(n),n}static reject(t,e,i){const n=Du.buildError(t,e,i);return this.lastError=n,this.onError.emit(n),Promise.reject(n)}static buildInfo(t,e){const i={details:e,id:Du.infoObjCount,status:"Pending",timestamp:Date.now(),type:t};return Du.infoObjCount+=1,i}static info(t){t.timestamp=Date.now(),this.onInfo.emit(Nn(t));}static on(t,e){"error"===t?this.onError.on(e):"verbose"===t?(this.onVerbose.on(e),0!==this.verboseListenerCount&&no.hasDebugOutput()||(no.enableDebugOutput(!0,(t=>{this.verbose(t);})),this.verboseListenerCount+=1)):"warning"===t?this.onWarning.on(e):"info"===t&&this.onInfo.on(e);}static off(t,e){"error"===t?this.onError.off(e):"verbose"===t?(this.onVerbose.off(e),this.verboseListenerCount-=1,0===this.verboseListenerCount&&no.enableDebugOutput(!1,void 0)):"warning"===t?this.onWarning.off(e):"info"===t&&this.onInfo.off(e);}}function Ru(t,e,i,n){return e?i?`${e}${n?"":"."}${i}`:`${e}`:i?`${t}${n?"":"."}${i}`:`${t}`}i(Du,"onError",new es),i(Du,"onWarning",new es),i(Du,"onVerbose",new es),i(Du,"onInfo",new es),i(Du,"verboseListenerCount",0),i(Du,"infoObjCount",0),i(Du,"lastError",void 0),i(Du,"LIC_EMPTY",{code:-8e4,message:"No license."}),i(Du,"LIC_INVALID",{code:-80001,message:"License string is invalid."}),i(Du,"LIC_EXPIRED",{code:-80002,message:"XXX module license has expired."}),i(Du,"LIC_MISS_MODULE",{code:-80003,message:"XXX module license is missing."}),i(Du,"LIC_VER_NOT_MATCHED",{code:-80004,message:"XXX module license version does not match."}),i(Du,"LIC_DOMAIN_NOT_MATCHED",{code:-80005,message:"Domain does not match the domain bound to the XXX module license."}),i(Du,"INIT_SHOULD_SET_CONFIG",{code:-80050,message:"DDV.Core.init() has not been set up yet."}),i(Du,"INIT_CONFIG_NOT_DONE",{code:-80051,message:"DDV.Core.init() has not been completed."}),i(Du,"RESOURCE_NOT_FOUND",{code:-80052,message:"<%api%>: Resource is not found from the specified engineResourcePath."}),i(Du,"WASM_ERR",{code:-81e3,message:"WASM Error"}),i(Du,"PARAM_INVALID",{code:-80100,message:"<%api%>: '<%param%>' is invalid."}),i(Du,"PARAM_OUT_OF_RANGE",{code:-80101,message:"<%api%>: '<%param%>' is out of range."}),i(Du,"PARAM_MISS",{code:-80102,message:"<%api%>: '<%param%>' is missing."}),i(Du,"PARAM_NOT_SUPPORT",{code:-80103,message:"<%api%>: The value for '<%param%>' is not supported."}),i(Du,"DOC_NOT_EXIST",{code:-80104,message:"<%api%>: The specified document(s) do not exist."}),i(Du,"PAGE_NOT_EXIST",{code:-80105,message:"<%api%>: The specified page(s) do not exist."}),i(Du,"ANNOTATION_NOT_EXIST",{code:-80106,message:"<%api%>: The specified annotation does not exist."}),i(Du,"DOC_DESTROYED",{code:-80108,message:"The document has been destroyed."}),i(Du,"PAGE_DESTROYED",{code:-80109,message:"The page has been destroyed."}),i(Du,"FILE_NOT_SUPPORT",{code:-80200,message:"File type is not supported."}),i(Du,"DOC_UID_DUPLICATE",{code:-80201,message:"DocUid does not allow duplicate."}),i(Du,"PAGEDATA_DESTROYED",{code:-80205,message:"The pageData has been destroyed."}),i(Du,"SEARCHER_DESTROYED",{code:-80206,message:"The DocTextSearcher has been destroyed."}),i(Du,"CONTAINER_NOT_EXIST",{code:-80301,message:"The specified container does not exist."}),i(Du,"MIN_ZOOM_INVALID",{code:-80302,message:"minZoom value cannot be larger than maxZoom value."}),i(Du,"MAX_ZOOM_INVALID",{code:-80303,message:"maxZoom value cannot be smaller than minZoom value."}),i(Du,"DOC_NOT_OPEN",{code:-80304,message:"No document opened."}),i(Du,"DOC_NO_IMAGE",{code:-80305,message:"There is no image in the current document."}),i(Du,"ZOOM_TOO_LARGE",{code:-80306,message:"The value for zoom is larger than maxZoom value."}),i(Du,"ZOOM_TOO_SMALL",{code:-80307,message:"The value for zoom is smaller than minZoom value."}),i(Du,"ROW_COLUMN_CAN_NOT_CHANGE",{code:-80308,message:"<%api%>: Not available in current displayMode."}),i(Du,"RECT_EXCEED_PAGE_BOUND",{code:-80309,message:"The specified rect exceeds the bounds of the current page."}),i(Du,"UNDO_NOOP",{code:-80310,message:"No operations to undo."}),i(Du,"REDO_NOOP",{code:-80311,message:"No operations to redo."}),i(Du,"QUAD_EXCEED_PAGE_BOUND",{code:-80312,message:"The specified quad exceeds the bounds of the current page."}),i(Du,"ELEMENT_UNSUPPORTED",{code:-80313,message:"The element '<%param%>' is not supported in <%api%> class."}),i(Du,"TOOL_MODE_NOT_AVAILABLE",{code:-80314,message:"<%api%>: Not available in current toolMode."}),i(Du,"DOC_DETECT_MISS",{code:-80315,message:"DocumentDetect needs to be configured by Dynamsoft.DDV.setProcessingHandler to enable the document detection feature."}),i(Du,"IMG_FILTER_MISS",{code:-80316,message:"ImageFilter needs to be configured by Dynamsoft.DDV.setProcessingHandler to enable the image filter feature."}),i(Du,"ANNOTATION_SELECT",{code:-80317,message:"The specified annotation(s) is not on the current page or does not exist."}),i(Du,"WASM_FONT_LOSS",{code:-80318,message:"The document contains unsupported fonts, which may result in font loss after saving."}),i(Du,"UNSELECTED_READONLY",{code:-80319,message:"ReadOnly annotation or noView annotation cannot be selected."}),i(Du,"UNSELECTED_UNKNOWN",{code:-80320,message:"Unknown annotation or incomplete annotation cannot be selected."}),i(Du,"UNSELECTED_FLATTENED",{code:-80321,message:"Flattened annotation cannot be selected."}),i(Du,"NO_RESULTS_FOUND",{code:-80322,message:"No results found."}),i(Du,"CAMERA_NOT_EXIST",{code:-80400,message:"The specified camera does not exist."}),i(Du,"CAMERA_OCCUPIED",{code:-80401,message:"The specified camera is occupied."}),i(Du,"CAMERA_NO_VIDEO",{code:-80402,message:"No video stream is played."}),i(Du,"CAMERA_NEED_HTTPS",{code:-80403,message:"Not HTTPS, failed to play the video stream."}),i(Du,"CAMERA_NOT_SUPPORT_TORCH",{code:-80404,message:"The camera does not support a flashlight."}),i(Du,"CAMERA_NO_CAMERA",{code:-80405,message:"No camera available."}),i(Du,"CAMERA_DENIED",{code:-80406,message:"The selected camera is denied by browser."}),i(Du,"CONTAINER_NO_BOUND",{code:-80407,message:"No bound container."}),i(Du,"EXTERNAL_ERR",{code:-81100,message:"External Error"});class Iu{static makeSureValid(t,e,i,n){const s=this.composeError(i,n);Du.throw(s,t,e);}static output(t,e,i,n,s){let o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const r=this.composeError(n,s);return 2===t?Du.reject(r,e,i):1===t?(Du.warning(r,e,i),o):0===t?Du.error(r,e,i):3===t?Du.verbose(r,e,i):void 0}static error(t,e,i,n){const s=this.composeError(i,n);Du.throw(s,t,e);}static warning(t,e,i,n){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=this.composeError(i,n);return Du.warning(o,t,e),s}static verbose(t,e,i,n){const s=this.composeError(i,n);Du.verbose(s,t,e);}static reject(t,e,i,n){const s=this.composeError(i,n);return Du.reject(s,t,e)}static composeError(t,e){const i={..._n(e)?Du.PARAM_INVALID:e};return t&&(i.details=t),i}static formatDetails(t,e){const i=[];if(zn(e))e||i.push(`'${t}' is invalid.`);else {const{isValid:n,isInRange:s,isSupported:o}=e;!1===n&&i.push(`'${t}' is invalid.`),!1===s&&i.push(`'${t}' is out of range.`),!1===o&&i.push(`'${t}' is not supported.`);}return i}static formatError(t,e){const{isValid:i,isInRange:n,isSupported:s}=t;if(!1===i||!1===n||!1===s){if(e)return e;if(!i)return Du.PARAM_INVALID;if(!n)return Du.PARAM_OUT_OF_RANGE;if(!s)return Du.PARAM_NOT_SUPPORT}return null}static isArrayBufferOrBlob(t){return Hn(t)||Vn(t)}static isArrayAndMeetMinLength(t,e){return On(t)?Xn(e)?{isValid:0!==t.length,isInRange:t.length>=e}:{isValid:!0}:{isValid:!1}}static isNumberAndIsInRange(t,e,i){return Xn(t)?{isValid:!0,isInRange:!(!_n(e)&&t<e||!_n(i)&&t>i)}:{isValid:!1}}static isStringAndNotEmpty(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Gn(t)?e?{isValid:!0}:{isValid:0!==t.trim().length}:{isValid:!1}}static isPdfDate(t){if(!Gn(t))return {isValid:!1};const e=t.match(/^D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(?:([+-])(\d{2})['’](\d{2})['’]|)$/);let i=!1;if(e){const[,t,n,s,o,r,a,l,h,c]=e,d=new Date(`${t}-${n}-${s}T${o}:${r}:${a}`);if(i=!0,d.getFullYear()===parseInt(t,10)&&d.getMonth()+1===parseInt(n,10)&&d.getDate()===parseInt(s,10)&&d.getHours()===parseInt(o,10)&&d.getMinutes()===parseInt(r,10)&&d.getSeconds()===parseInt(a,10)||(i=!1),i&&l){const t=parseInt(h,10),e=parseInt(c,10);(t<0||t>12||e<0||e>59||"+"!==l&&"-"!==l)&&(i=!1);}}return {isSupported:i}}}!function(t){t[t.BlackAndWhite=1]="BlackAndWhite",t[t.Gray=2]="Gray",t[t.RemoveShadow=3]="RemoveShadow",t[t.Enhance=4]="Enhance",t[t.Invert=5]="Invert",t[t.Brightness=6]="Brightness",t[t.Contrast=7]="Contrast",t[t.BrightnessAndContrast=8]="BrightnessAndContrast",t[t.Perspective=9]="Perspective",t[t.Deskew=10]="Deskew",t[t.Rotate=11]="Rotate",t[t.Flip=12]="Flip",t[t.Resize=13]="Resize",t[t.SetHeight=14]="SetHeight",t[t.SetWidth=15]="SetWidth",t[t.SetDPI=16]="SetDPI",t[t.Crop=17]="Crop",t[t.Erase=18]="Erase",t[t.DrawPolygon=19]="DrawPolygon";}(Pu||(Pu={}));var Mu=new WeakSet,Bu=new WeakSet;class Uu{constructor(){v(this,Bu),v(this,Mu);}async process(t,e,i){On(e)||(e=[e]),p(this,Mu,Lu).call(this,e);const n=new xo,s={inputImageInfo:null,output:null,outputImageInfo:null,outputContentType:"",outputType:null};try{var o,r,a,l;const h=await n.initImage({source:t.data,isRGBA:t.type===co.RGBA,width:t.width,height:t.height,isBGRA:t.type===co.BGRA});h.srcBuffer&&(t.data=h.srcBuffer);for(const t of e)p(this,Bu,Ou).call(this,n,t);const c=await n.getImage({jpegQuality:null==i||null===(o=i.params)||void 0===o?void 0:o.jpegQuality,ifDeleteObject:!0,isRGBA:t.type===co.RGBA,bitDepth:null==i||null===(r=i.params)||void 0===r?void 0:r.bitDepth,xDpi:null==i||null===(a=i.params)||void 0===a?void 0:a.xDpi,yDpi:null==i||null===(l=i.params)||void 0===l?void 0:l.yDpi,returnBlob:!1,returnType:To[null==i?void 0:i.type]});await n.freeReservedData(),s.output=c.imageData,s.outputContentType=c.blobType,s.outputImageInfo={width:c.imageWidth,height:c.imageHeight,bitDepth:c.imageBitDepth,resolutionX:c.imageXResolution,resolutionY:c.imageYResolution},s.outputType=Ao[c.imageType];}finally{try{await n.terminate();}catch(t){Du.warning(t);}}return s}}function Lu(t){for(const e of t)e.type&&(e.type<=0||(e.type,Pu.DrawPolygon),e.params);}async function Ou(t,e){var i;const n=null!==(i=e.params)&&void 0!==i?i:{};switch(e.type){case Pu.BlackAndWhite:return t.toBinaryLevel(n.saveInk,n.level);case Pu.Gray:return t.toGrayscale(n.level);case Pu.RemoveShadow:return t.removeShadowLevel(n.level,n.alpha);case Pu.Enhance:return t.brighten();case Pu.Invert:return t.invert();case Pu.Contrast:return t.changeBrightnessAndContrast(void 0,n.contrast);case Pu.Brightness:return t.changeBrightnessAndContrast(n.brightness,void 0);case Pu.BrightnessAndContrast:return t.changeBrightnessAndContrast(n.brightness,n.contrast);case Pu.Perspective:return t.perspective(n.location);case Pu.Deskew:{var s;const e=await t.getSkewAngle(n.options);return t.rotate({angle:e,fillColor:n.fillColor,keepSize:null===(s=n.keepSize)||void 0===s||s,mode:n.mode})}case Pu.Rotate:return t.rotate({angle:n.angle,fillColor:n.fillColor,keepSize:n.keepSize,mode:n.mode});case Pu.Flip:return t.flip();case Pu.Resize:{const{newWidth:e,newHeight:i,mode:s}=n;return t.resize(e,i,s)}case Pu.SetHeight:{const{newHeight:e,fillColor:i}=n;return t.setImageHeight(e,i)}case Pu.SetWidth:{const{newWidth:e,fillColor:i}=n;return t.setImageWidth(e,i)}case Pu.SetDPI:return t.setDpi({rawResolutionX:0,rawResolutionY:0,resolutionX:n.xRes,resolutionY:n.yRes,resample:!1});case Pu.Crop:return t.crop({left:n.left,top:n.top,width:n.right-n.left,height:n.bottom-n.top});case Pu.Erase:return t.erase({left:n.left,top:n.top,width:n.right-n.left,height:n.bottom-n.top},n.fillColor);case Pu.DrawPolygon:return t.drawQuadrangle({location:n.location,strokeColor:n.strokeColor,lineWidth:n.lineWidth})}}!ln&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID")),!ln&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword");const Wu=function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=t;if(i._pLoad.isEmpty){let t,n,s,o=i._license||"",r=JSON.parse(JSON.stringify(i._licenseServer)),a=i._sessionPassword,l=0;if(o.startsWith("t")||o.startsWith("f"))l=0;else if(0===o.length||o.startsWith("P")||o.startsWith("L")||o.startsWith("Y")||o.startsWith("A"))l=1;else {l=2;const e=o.indexOf(":");-1!=e&&(o=o.substring(e+1));const i=o.indexOf("?");if(-1!=i&&(n=o.substring(i+1),o=o.substring(0,i)),o.startsWith("DLC2"))l=0;else {if(o.startsWith("DLS2")){let e;try{let t=o.substring(4);t=atob(t),e=JSON.parse(t);}catch(t){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}if(o=e.handshakeCode?e.handshakeCode:e.organizationID?e.organizationID:"","number"==typeof o&&(o=JSON.stringify(o)),0===r.length){let t=[];e.mainServerURL&&(t[0]=e.mainServerURL),e.standbyServerURL&&(t[1]=e.standbyServerURL),r=(t=>{if(null==t)t=[];else {t=t instanceof Array?[...t]:[t];for(let e=0;e<t.length;++e){if(!ln){let i=document.createElement("a");i.href=t[e],t[e]=i.href;}t[e].endsWith("/")||(t[e]+="/");}}return t})(t);}!a&&e.sessionPassword&&(a=e.sessionPassword),t=e.remark;}o&&"200001"!==o&&!o.startsWith("200001-")||(l=1);}}if(l&&(e||(hn.crypto||(s="Please upgrade your browser to support online key."),hn.crypto.subtle||(s="Require https to use online key in this browser."))),s){if(1!==l)throw new Error(s);l=0,i._lastErrorCode=-1,i._lastErrorString=s;}return 1===l&&(o=""),{lt:l,l:o,ls:r,sp:a,rmk:t,cv:n}}throw new Error("Can't preprocess license again is not allowed to change after `createInstance` or `loadWasm` is called.")},Nu=async(t,e,i)=>{if(!t._bNeverShowDialog)try{let n=await fetch(t.engineResourcePath+"dls.license.dialog.html");if(!n.ok)throw Error("Get license dialog fail. Network Error: "+n.statusText);let s=await n.text();if(!s.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let o=document.createElement("div");o.innerHTML=s;let r=[];for(let t=0;t<o.childElementCount;++t){let e=o.children[t];e instanceof HTMLStyleElement&&(r.push(e),document.head.append(e));}let a=1==o.childElementCount?o.children[0]:o;a.remove();let l,h,c,d,u,p=[a],g=a.children;for(let t of g)p.push(t);for(let t=0;t<p.length;++t)for(let e of p[t].children)p.push(e);for(let t of p)if(!l&&t.classList.contains("dls-license-mask"))l=t,t.addEventListener("click",(e=>{if(t==e.target){a.remove();for(let t of r)t.remove();}}));else if(!h&&t.classList.contains("dls-license-icon-close"))h=t,t.addEventListener("click",(()=>{a.remove();for(let t of r)t.remove();}));else if(!c&&t.classList.contains("dls-license-icon-error"))c=t,"error"!=e&&t.remove();else if(!d&&t.classList.contains("dls-license-icon-warn"))d=t,"warn"!=e&&t.remove();else if(!u&&t.classList.contains("dls-license-msg-content")){u=t;let e=i;for(;e;){let i=e.indexOf("["),n=e.indexOf("]",i),s=e.indexOf("(",n),o=e.indexOf(")",s);if(-1==i||-1==n||-1==s||-1==o){t.appendChild(new Text(e));break}i>0&&t.appendChild(new Text(e.substring(0,i)));let r=document.createElement("a"),a=e.substring(i+1,n);r.innerText=a;let l=e.substring(s+1,o);r.setAttribute("href",l),r.setAttribute("target","_blank"),t.appendChild(r),e=e.substring(o+1);}}document.body.appendChild(a);}catch(e){t._onLog&&t._onLog(e.message||e);}};var _u=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(t){return}}();function Fu(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(s){if("TypeError"!==s.name)throw s;for(var i=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<t.length;n+=1)i.append(t[n]);return i.getBlob(e.type)}}function Hu(t,e){e&&t.then((function(t){e(null,t);}),(function(t){e(t);}));}function Vu(t,e,i){"function"==typeof e&&t.then(e),"function"==typeof i&&t.catch(i);}function zu(t){return "string"!=typeof t&&(t=String(t)),t}function $u(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}const ju="local-forage-detect-blob-support";let Xu;const Gu={},Yu=Object.prototype.toString,qu="readonly",Ju="readwrite";function Zu(t){return "boolean"==typeof Xu?Promise.resolve(Xu):function(t){return new Promise((function(e){var i=t.transaction(ju,Ju),n=Fu([""]);i.objectStore(ju).put(n,"key"),i.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1);},i.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),i=navigator.userAgent.match(/Edge\//);e(i||!t||parseInt(t[1],10)>=43);};})).catch((function(){return !1}))}(t).then((function(t){return Xu=t,Xu}))}function Qu(t){var e=Gu[t.name],i={};i.promise=new Promise((function(t,e){i.resolve=t,i.reject=e;})),e.deferredOperations.push(i),e.dbReady?e.dbReady=e.dbReady.then((function(){return i.promise})):e.dbReady=i.promise;}function Ku(t){var e=Gu[t.name].deferredOperations.pop();if(e)return e.resolve(),e.promise}function tp(t,e){var i=Gu[t.name].deferredOperations.pop();if(i)return i.reject(e),i.promise}function ep(t,e){return new Promise((function(i,n){if(Gu[t.name]=Gu[t.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},t.db){if(!e)return i(t.db);Qu(t),t.db.close();}var s=[t.name];e&&s.push(t.version);var o=_u.open.apply(_u,s);e&&(o.onupgradeneeded=function(e){var i=o.result;try{i.createObjectStore(t.storeName),e.oldVersion<=1&&i.createObjectStore(ju);}catch(t){if("ConstraintError"!==t.name)throw t}}),o.onerror=function(t){t.preventDefault(),n(o.error);},o.onsuccess=function(){var e=o.result;e.onversionchange=function(t){t.target.close();},i(e),Ku(t);};}))}function ip(t){return ep(t,!1)}function np(t){return ep(t,!0)}function sp(t,e){if(!t.db)return !0;var i=!t.db.objectStoreNames.contains(t.storeName),n=t.version<t.db.version,s=t.version>t.db.version;if(n&&(t.version,t.version=t.db.version),s||i){if(i){var o=t.db.version+1;o>t.version&&(t.version=o);}return !0}return !1}function op(t){var e=function(t){for(var e=t.length,i=new ArrayBuffer(e),n=new Uint8Array(i),s=0;s<e;s++)n[s]=t.charCodeAt(s);return i}(atob(t.data));return Fu([e],{type:t.type})}function rp(t){var e=this,i=e._initReady().then((function(){var t=Gu[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}));return Vu(i,t,t),i}function ap(t,e,i,n){void 0===n&&(n=1);try{var s=t.db.transaction(t.storeName,e);i(null,s);}catch(s){if(n>0&&(!t.db||"InvalidStateError"===s.name||"NotFoundError"===s.name))return Promise.resolve().then((()=>{if(!t.db||"NotFoundError"===s.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),np(t)})).then((()=>function(t){Qu(t);for(var e=Gu[t.name],i=e.forages,n=0;n<i.length;n++){const t=i[n];t._dbInfo.db&&(t._dbInfo.db.close(),t._dbInfo.db=null);}return t.db=null,ip(t).then((e=>(t.db=e,sp(t)?np(t):e))).then((n=>{t.db=e.db=n;for(var s=0;s<i.length;s++)i[s]._dbInfo.db=n;})).catch((e=>{throw tp(t,e),e}))}(t).then((function(){ap(t,e,i,n-1);})))).catch(i);i(s);}}var lp={_driver:"asyncStorage",_initStorage:function(t){var e=this,i={db:null};if(t)for(var n in t)i[n]=t[n];var s=Gu[i.name];s||(s={forages:[],db:null,dbReady:null,deferredOperations:[]},Gu[i.name]=s),s.forages.push(e),e._initReady||(e._initReady=e.ready,e.ready=rp);var o=[];function r(){return Promise.resolve()}for(var a=0;a<s.forages.length;a++){var l=s.forages[a];l!==e&&o.push(l._initReady().catch(r));}var h=s.forages.slice(0);return Promise.all(o).then((function(){return i.db=s.db,ip(i)})).then((function(t){return i.db=t,sp(i,e._defaultConfig.version)?np(i):t})).then((function(t){i.db=s.db=t,e._dbInfo=i;for(var n=0;n<h.length;n++){var o=h[n];o!==e&&(o._dbInfo.db=i.db,o._dbInfo.version=i.version);}}))},_support:function(){try{if(!_u||!_u.open)return !1;var t="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),e="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return (!t||e)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(t){return !1}}(),getItem:function(t,e){var i=this;t=zu(t);var n=new Promise((function(e,n){i.ready().then((function(){ap(i._dbInfo,qu,(function(s,o){if(s)return n(s);try{var r=o.objectStore(i._dbInfo.storeName).get(t);r.onsuccess=function(){var t=r.result;void 0===t&&(t=null),function(t){return t&&t.__local_forage_encoded_blob}(t)&&(t=op(t)),e(t);},r.onerror=function(){n(r.error);};}catch(t){n(t);}}));})).catch(n);}));return Hu(n,e),n},setItem:function(t,e,i){var n=this;t=zu(t);var s=new Promise((function(i,s){var o;n.ready().then((function(){return o=n._dbInfo,"[object Blob]"===Yu.call(e)?Zu(o.db).then((function(t){return t?e:(i=e,new Promise((function(t,e){var n=new FileReader;n.onerror=e,n.onloadend=function(e){var n=btoa(e.target.result||"");t({__local_forage_encoded_blob:!0,data:n,type:i.type});},n.readAsBinaryString(i);})));var i;})):e})).then((function(e){ap(n._dbInfo,Ju,(function(o,r){if(o)return s(o);try{var a=r.objectStore(n._dbInfo.storeName);null===e&&(e=void 0);var l=a.put(e,t);r.oncomplete=function(){void 0===e&&(e=null),i(e);},r.onabort=r.onerror=function(){var t=l.error?l.error:l.transaction.error;s(t);};}catch(t){s(t);}}));})).catch(s);}));return Hu(s,i),s},removeItem:function(t,e){var i=this;t=zu(t);var n=new Promise((function(e,n){i.ready().then((function(){ap(i._dbInfo,Ju,(function(s,o){if(s)return n(s);try{var r=o.objectStore(i._dbInfo.storeName).delete(t);o.oncomplete=function(){e();},o.onerror=function(){n(r.error);},o.onabort=function(){var t=r.error?r.error:r.transaction.error;n(t);};}catch(t){n(t);}}));})).catch(n);}));return Hu(n,e),n},clear:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){ap(e._dbInfo,Ju,(function(n,s){if(n)return i(n);try{var o=s.objectStore(e._dbInfo.storeName).clear();s.oncomplete=function(){t();},s.onabort=s.onerror=function(){var t=o.error?o.error:o.transaction.error;i(t);};}catch(t){i(t);}}));})).catch(i);}));return Hu(i,t),i},length:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){ap(e._dbInfo,qu,(function(n,s){if(n)return i(n);try{var o=s.objectStore(e._dbInfo.storeName).count();o.onsuccess=function(){t(o.result);},o.onerror=function(){i(o.error);};}catch(t){i(t);}}));})).catch(i);}));return Hu(i,t),i},keys:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){ap(e._dbInfo,qu,(function(n,s){if(n)return i(n);try{var o=s.objectStore(e._dbInfo.storeName).openKeyCursor(),r=[];o.onsuccess=function(){var e=o.result;e?(r.push(e.key),e.continue()):t(r);},o.onerror=function(){i(o.error);};}catch(t){i(t);}}));})).catch(i);}));return Hu(i,t),i},dropInstance:function(t,e){e=$u.apply(this,arguments);var i,n=this.config();if((t="function"!=typeof t&&t||{}).name||(t.name=t.name||n.name,t.storeName=t.storeName||n.storeName),t.name){const e=t.name===n.name&&this._dbInfo.db?Promise.resolve(this._dbInfo.db):ip(t).then((e=>{const i=Gu[t.name],n=i.forages;i.db=e;for(var s=0;s<n.length;s++)n[s]._dbInfo.db=e;return e}));i=t.storeName?e.then((e=>{if(!e.objectStoreNames.contains(t.storeName))return;const i=e.version+1;Qu(t);const n=Gu[t.name],s=n.forages;e.close();for(let t=0;t<s.length;t++){const e=s[t];e._dbInfo.db=null,e._dbInfo.version=i;}const o=new Promise(((e,n)=>{const s=_u.open(t.name,i);s.onerror=t=>{s.result.close(),n(t);},s.onupgradeneeded=()=>{s.result.deleteObjectStore(t.storeName);},s.onsuccess=()=>{const t=s.result;t.close(),e(t);};}));return o.then((t=>{n.db=t;for(let e=0;e<s.length;e++){const i=s[e];i._dbInfo.db=t,Ku(i._dbInfo);}})).catch((e=>{throw (tp(t,e)||Promise.resolve()).catch((()=>{})),e}))})):e.then((e=>{Qu(t);const i=Gu[t.name],n=i.forages;e.close();for(var s=0;s<n.length;s++){n[s]._dbInfo.db=null;}const o=new Promise(((e,i)=>{var n=_u.deleteDatabase(t.name);n.onerror=()=>{const t=n.result;t&&t.close(),i(n.error);},n.onblocked=()=>{},n.onsuccess=()=>{const t=n.result;t&&t.close(),e(t);};}));return o.then((t=>{i.db=t;for(var e=0;e<n.length;e++){Ku(n[e]._dbInfo);}})).catch((e=>{throw (tp(t,e)||Promise.resolve()).catch((()=>{})),e}))}));}else i=Promise.reject("Invalid arguments");return Hu(i,e),i}};const hp=new Map;function cp(t,e){let i=t.name+"/";return t.storeName!==e.storeName&&(i+=t.storeName+"/"),i}var dp={_driver:"tempStorageWrapper",_initStorage:async function(t){const e={};if(t)for(let i in t)e[i]=t[i];const i=e.keyPrefix=cp(t,this._defaultConfig);this._dbInfo=e,hp.has(i)||hp.set(i,new Map);},getItem:function(t,e){t=zu(t);const i=this.ready().then((()=>hp.get(this._dbInfo.keyPrefix).get(t)));return Hu(i,e),i},setItem:function(t,e,i){t=zu(t);const n=this.ready().then((()=>(void 0===e&&(e=null),hp.get(this._dbInfo.keyPrefix).set(t,e),e)));return Hu(n,i),n},removeItem:function(t,e){t=zu(t);const i=this.ready().then((()=>{hp.get(this._dbInfo.keyPrefix).delete(t);}));return Hu(i,e),i},clear:function(t){const e=this.ready().then((()=>{const t=this._dbInfo.keyPrefix;hp.has(t)&&hp.delete(t);}));return Hu(e,t),e},length:function(t){const e=this.ready().then((()=>hp.get(this._dbInfo.keyPrefix).size));return Hu(e,t),e},keys:function(t){const e=this.ready().then((()=>[...hp.get(this._dbInfo.keyPrefix).keys()]));return Hu(e,t),e},dropInstance:function(t,e){if(e=$u.apply(this,arguments),!(t="function"!=typeof t&&t||{}).name){const e=this.config();t.name=t.name||e.name,t.storeName=t.storeName||e.storeName;}let i;return i=t.name?new Promise((e=>{t.storeName?e(cp(t,this._defaultConfig)):e(`${t.name}/`);})).then((t=>{hp.delete(t);})):Promise.reject("Invalid arguments"),Hu(i,e),i}};const up=(t,e)=>t===e||"number"==typeof t&&"number"==typeof e&&isNaN(t)&&isNaN(e),pp=(t,e)=>{const i=t.length;let n=0;for(;n<i;){if(up(t[n],e))return !0;n++;}return !1},gp=Array.isArray||function(t){return "[object Array]"===Object.prototype.toString.call(t)},fp={},vp={},mp={INDEXEDDB:lp,TEMPSTORAGE:dp},yp=[mp.INDEXEDDB._driver,mp.TEMPSTORAGE._driver],xp=["dropInstance"],wp=["clear","getItem","keys","length","removeItem","setItem"].concat(xp),bp={description:"",driver:yp.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Sp(t,e){t[e]=function(){const i=arguments;return t.ready().then((function(){return t[e].apply(t,i)}))};}function Cp(){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(e)for(let t in e)e.hasOwnProperty(t)&&(gp(e[t])?arguments[0][t]=e[t].slice():arguments[0][t]=e[t]);}return arguments[0]}class Pp{constructor(t){for(let t in mp)if(mp.hasOwnProperty(t)){const e=mp[t],i=e._driver;this[t]=i,fp[i]||this.defineDriver(e);}this._defaultConfig=Cp({},bp),this._config=Cp({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((()=>{}));}config(t){if("object"==typeof t){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(let e in t){if("storeName"===e&&(t[e]=t[e].replace(/\W/g,"_")),"version"===e&&"number"!=typeof t[e])return new Error("Database version must be a number.");this._config[e]=t[e];}return !("driver"in t)||!t.driver||this.setDriver(this._config.driver)}return "string"==typeof t?this._config[t]:this._config}defineDriver(t,e,i){const n=new Promise((function(e,i){try{const n=t._driver,s=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver)return void i(s);const o=wp.concat("_initStorage");for(let e=0,n=o.length;e<n;e++){const n=o[e];if((!pp(xp,n)||t[n])&&"function"!=typeof t[n])return void i(s)}const r=function(){const e=function(t){return function(){const e=new Error(`Method ${t} is not implemented by the current driver`),i=Promise.reject(e);return Hu(i,arguments[arguments.length-1]),i}};for(let i=0,n=xp.length;i<n;i++){const n=xp[i];t[n]||(t[n]=e(n));}};r();const a=function(i){fp[n],fp[n]=t,vp[n]=i,e();};"_support"in t?t._support&&"function"==typeof t._support?t._support().then(a,i):a(!!t._support):a(!0);}catch(t){i(t);}}));return Vu(n,e,i),n}driver(){return this._driver||null}getDriver(t,e,i){const n=fp[t]?Promise.resolve(fp[t]):Promise.reject(new Error("Driver not found."));return Vu(n,e,i),n}ready(t){const e=this,i=e._driverSet.then((()=>(null===e._ready&&(e._ready=e._initDriver()),e._ready)));return Vu(i,t,t),i}setDriver(t,e,i){const n=this;gp(t)||(t=[t]);const s=this._getSupportedDrivers(t);function o(){n._config.driver=n.driver();}function r(t){return n._extend(t),o(),n._ready=n._initStorage(n._config),n._ready}const a=null!==this._driverSet?this._driverSet.catch((()=>Promise.resolve())):Promise.resolve();return this._driverSet=a.then((()=>{const t=s[0];return n._dbInfo=null,n._ready=null,n.getDriver(t).then((t=>{n._driver=t._driver,o(),n._wrapLibraryMethodsWithReady(),n._initDriver=function(t){return function(){let e=0;return function i(){for(;e<t.length;){let s=t[e];return e++,n._dbInfo=null,n._ready=null,n.getDriver(s).then(r).catch(i)}o();const s=new Error("No available storage method found.");return n._driverSet=Promise.reject(s),n._driverSet}()}}(s);}))})).catch((()=>{o();const t=new Error("No available storage method found.");return n._driverSet=Promise.reject(t),n._driverSet})),Vu(this._driverSet,e,i),this._driverSet}supports(t){return !!vp[t]}_extend(t){Cp(this,t);}_getSupportedDrivers(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];this.supports(n)&&e.push(n);}return e}_wrapLibraryMethodsWithReady(){for(let t=0,e=wp.length;t<e;t++)Sp(this,wp[t]);}createInstance(t){return new Pp(t)}}var Tp=new Pp;Date.prototype.kUtilFormat=function(t){const e={"M+":this.getUTCMonth()+1,"d+":this.getUTCDate(),"H+":this.getUTCHours(),"h+":this.getUTCHours()%12||12,"m+":this.getUTCMinutes(),"s+":this.getUTCSeconds(),"q+":Math.floor((this.getUTCMonth()+3)/3),"S+":this.getUTCMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getUTCFullYear()+"").substr(4-RegExp.$1.length)));for(let i in e)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[i]:("000"+e[i]).substr(("000"+e[i]).length-RegExp.$1.length)));return t},String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0==this.indexOf(t)});let Ap=t=>{let e,i,n,s,o,r,a,l,h,c,d,u,p,g,f,v,m,y,x,w,b,S,C=t.fetch||hn.fetch,P=t.btoa||hn.btoa,T=t.atob||hn.atob,A=t.bd,k=t.dm,E=["https://mlts.dynamsoft.com/","https://slts.dynamsoft.com/"],D=!1,R=Promise.resolve(),I=t.lf,M=t.log&&function(){try{for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];t.log.apply(null,i);}catch(t){setTimeout((()=>{throw t}),0);}}||(()=>{}),B=A&&M||(()=>{}),U=t.fol,L=t.sutlcb,O=t.feab,W=t=>T(T(t.replace(/\n/g,"+").replace(/\s/g,"=")).substring(1)),N=t=>P(String.fromCharCode(97+25*Math.random())+P(t)).replace(/\+/g,"\n").replace(/=/g," "),_=()=>{if(S)return S;if(hn.crypto){let t=new Uint8Array(36);hn.crypto.getRandomValues(t);let e="";for(let i=0;i<36;++i){let n=t[i]%36;e+=n<10?n:String.fromCharCode(n+87);}return e}return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return ("x"==t?e:3&e|8).toString(16)}))};const F=" Check your Internet connection or contact Dynamsoft Support (support@dynamsoft.com) to acquire an offline license.";let H,V,z,$,j={dlsErrorAndCacheExpire:"Failed to connect to the Dynamsoft License Server. The cached license has expired. Please get connected to the network as soon as possible or contact the site administrator for more information.",publicTrialNetworkTimeout:"Failed to connect to the Dynamsoft License Server: network timed out."+F,networkTimeout:"Failed to connect to the Dynamsoft License Server: network timed out. Check your Internet connection or contact the site administrator for more information.",publicTrialFailConnect:"Failed to connect to the Dynamsoft License Server: network connection error."+F,failConnect:"Failed to connect to the Dynamsoft License Server: network connection error. Check your Internet connection or contact the site administrator for more information.",checkLocalTime:"Your system date and time appear to have been changed, causing the license to fail. Please correct the system data and time and try again."},X=async()=>(H=H||(async()=>{await(async()=>{I||(I=Tp);})();{let t=await I.createInstance({name:"dynamjssdkhello"});await t.setItem("dynamjssdkhello","available");}if(v=await I.createInstance({name:"dynamdlsinfo"}),m=S?null:P(P("v2")+String.fromCharCode(k.charCodeAt(k.length/2)+1)+P(k)),!S){try{let t=await v.getItem(m);if(!t){let e=await I.createInstance({name:"dynamltsinfo"});t=await e.getItem(m),t&&await v.setItem(m,t);}t&&([a,p]=JSON.parse(await W(t)));}catch(t){}try{null==a&&(a=_(),v.setItem(m,await N(JSON.stringify([a,null]))));}catch(t){}}})(),H),G=async t=>{z=Date.now(),V||(V=(async()=>{try{let g={pd:e,vm:n,v:i,dt:r||"browser",ed:"javascript",cu:a,ad:k,os:l,fn:h};u&&(g.rmk=u),s&&(-1!=s.indexOf("-")?g.hs=s:g.og=s);let f={};if(p&&!S){let t=await v.getItem(m);t&&([a,p]=JSON.parse(await W(t))),f["lts-time"]=p;}d&&(g.sp=d);let x=await Promise.race([(async()=>{let e,i=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ");p&&!S&&(v.setItem(m,await N(JSON.stringify([a,i]))),p=i);let n,s="auth/?ext="+encodeURIComponent(P(JSON.stringify(g))),r=!1,l=!1,h=async t=>{if(t&&!t.ok)try{let e=await t.text();if(e){let t=JSON.parse(e);t.errorCode&&(n=t,t.errorCode>100&&t.errorCode<200&&(o=null,r=!0,l=!0));}}catch(t){}};try{e=await C(E[0]+s,{headers:f,cache:t?"reload":"default",mode:"cors",timeout:1e4}),await h(e);}catch(t){}if(!(o||e&&e.ok||r))try{e=await C(E[1]+s,{headers:f,mode:"cors",timeout:3e4});}catch(t){}if(!(o||e&&e.ok||r))try{e=await C(E[0]+s,{headers:f,mode:"cors",timeout:3e4}),await h(e);}catch(t){}n&&151==n.errorCode&&!S&&(v.removeItem(m),v.removeItem(y),a=_(),g.cu=a,p=void 0,s="auth/?ext="+encodeURIComponent(P(JSON.stringify(g))),e=await C(E[0]+s,{headers:f,mode:"cors",timeout:3e4}),await h(e)),(()=>{if(!e||!e.ok){let t;l&&v.setItem(y,""),n?111==n.errorCode?t=n.message:(t=n.message.trim(),t.endsWith(".")||(t+="."),t=c?`An error occurred during authorization: ${t} [Contact Dynamsoft](https://www.dynamsoft.com/company/contact/) for more information.`:`An error occurred during authorization: ${t} Contact the site administrator for more information.`):t=c?j.publicTrialFailConnect:j.failConnect;let e=Error(t);throw n&&n.errorCode&&(e.ltsErrorCode=n.errorCode),e}})();let d=await e.text();try{p||S||(v.setItem(m,await N(JSON.stringify([a,i]))),p=i),v.setItem(y,d);}catch(t){}return d})(),new Promise(((t,e)=>{let i;i=c?j.publicTrialNetworkTimeout:j.networkTimeout,setTimeout((()=>e(new Error(i))),o?3e3:15e3);}))]);o=x;}catch(t){g=t;}V=null;})()),await V;},Y=async()=>{$||($=(async()=>{if(B(a),!o){if(!D)throw M(g.message),g;return}let t={dm:k};A&&(t.bd=!0),t.brtk=!0,t.ls=E[0],s&&(-1!=s.indexOf("-")?t.hs=s:t.og=s),t.cu=a,h&&(t.fn=h),e&&(t.pd=e),i&&(t.v=i),r&&(t.dt=r),l&&(t.os=l),u&&(t.rmk=u),B(o);try{t.ar=o,t.bafc=!!g;}catch(t){}B(t);try{await x(t);}catch(t){B("error updl");}await q(),D||(D=!0),$=null;})()),await $;},q=async()=>{let t=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),e=await b();if(B(e),e&&e<t)throw g?new Error(j.dlsErrorAndCacheExpire):new Error(j.checkLocalTime)},J=null;const Z=new Promise((t=>{J=()=>{Z.isPending=!1,Z.isFulfilled=!0,t();};}));let Q=null,K=async(t,e)=>(R=R.then((async()=>{try{let i=await f.keys();if(e||(Z.isFulfilled?t&&(i=i.filter((e=>e<t))):t&&i.includes(t)?i=[t]:(i=[],B("Unexpected null key"))),!i.length)return;for(let t=0;t<i.length/1e3;++t){let e=i.slice(1e3*t,1e3*(t+1)),n=[];for(let t=0;t<e.length;++t)n.push(await f.getItem(e[t]));if(p=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),!S){let t=await v.getItem(m);t&&([a]=JSON.parse(await W(t))),v.setItem(m,await N(JSON.stringify([a,p])));}try{let t,i,s=E[0]+"verify/v2";p&&!S&&(s+="?ltstime="+encodeURIComponent(p));try{t=C(s,{method:"POST",body:n.join(";"),keepalive:!0});}finally{!Z.isFulfilled&&fn&&J();}try{i=await t;}finally{Z.isFulfilled||J();}if(!i.ok)throw new Error("verify failed. Status Code: "+i.status);for(let t=0;t<e.length;++t)await f.removeItem(e[t]);}catch(t){throw Z.isFulfilled||J(),U&&(U(t),U=null),t}}L&&L();}catch(t){}})),await R);return {i:async t=>(e=t.pd,i=t.v,n=i.split(".")[0],t.dt&&(r=t.dt),s=t.l||"",l="string"!=typeof t.os?JSON.stringify(t.os):t.os,h=t.fn,"string"==typeof h&&(h=h.substring(0,255)),t.ls&&t.ls.length&&(E=t.ls,1==E.length&&E.push(E[0])),c=!s||"200001"===s||s.startsWith("200001-"),d=t.sp,u=t.rmk,"string"==typeof u&&(u=u.substring(0,255)),t.lf&&(I=t.lf),t.lsu&&(a=S=t.lsu),t.feab&&(O=t.feab),x=t.updl,w=t.mnet,b=t.mxet,t.sutlcb&&(L=t.sutlcb),await X(),await(async()=>{y=P(String.fromCharCode(s.charCodeAt(0)+10)+P(e)+P(s)+n+P(""+r)),f=await I.createInstance({name:"dynamdlsuns"+P(P("v2"))+P(String.fromCharCode(s.charCodeAt(0)+10)+P(e)+P(s)+n+P(""+r))});try{o=await v.getItem(y);}catch(t){}})(),await G(),await Y(),(!g||g.ltsErrorCode>=102&&g.ltsErrorCode<=120)&&K(null,!0),{ar:o,cu:a}),c:async()=>{let t=new Date;if(t.getTime()<z+36e4)return;let e=t.kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),i=await w(),n=await b();if(n&&n<e)await G(!0),await Y();else if(i&&i<e){let e=new Date(t.getTime());e.setMinutes(t.getMinutes()-6);let i=e.kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ");p<i&&G().then((()=>Y()));}},s:async(t,e,i,n)=>{if(e){try{let t;t=e.startsWith("{")&&e.endsWith("}")?await O(e):e,t?(B("bs "+i),await f.setItem(i,t),B("ss "+i)):B("ept ecpt");}catch(t){}n&&(B("bd "+i),await K(i,2==n),B("sd "+i)),Q&&clearTimeout(Q),Q=setTimeout((async()=>{await K();}),36e4);}else await K(i);},p:Z,u:async()=>(await X(),a),caret:q}};var kp;class Ep{static init(){a(this,Ep,Mp,void 0),a(this,Ep,Bp,void 0),a(this,Ep,Up,"init");}static reset(){a(this,Ep,Mp,void 0),a(this,Ep,Bp,void 0),a(this,Ep,Up,"");}static setLicenseInfo(t){var e;a(this,Ep,Up,"done"),a(this,Ep,Mp,[]),a(this,Ep,Mp,null!==(e=null==t?void 0:t.modules)&&void 0!==e?e:[]);}static setLicenseErr(t){a(this,Ep,Bp,t),a(this,Ep,Up,"done");}static makeSureLoadLicenseExist(){return l(this,Ep,Rp).call(this,3101,5001)}static makeSureCoreLicenseExist(){return l(this,Ep,Rp).call(this,3101)}static makeSureCameraLicenseExist(){return l(this,Ep,Rp).call(this,3006,8002)}static makeSureAnnotationLicenseExist(){return l(this,Ep,Rp).call(this,15)}static annotationLicenseModuleIsExist(){return l(this,Ep,Ip).call(this,15)}static pdfRLicenseModuleIsExist(){return l(this,Ep,Ip).call(this,5001)}}function Dp(t){for(const e of r(this,kp,Mp))if(e.module===t)return e;return {code:Du.LIC_MISS_MODULE.code,message:Du.LIC_MISS_MODULE.message,module:t}}function Rp(t,e){""===r(this,kp,Up)&&Du.throw(Du.INIT_SHOULD_SET_CONFIG),"done"!==r(this,kp,Up)&&Du.throw(Du.INIT_CONFIG_NOT_DONE),r(this,kp,Bp)&&Du.throw(r(this,kp,Bp));const i=l(this,kp,Dp).call(this,t);0!==i.code&&(!e||e&&0!==l(this,kp,Dp).call(this,e).code)&&Du.throw({code:i.code,message:i.message});}function Ip(t){return 0===l(this,kp,Dp).call(this,t).code}kp=Ep;var Mp={writable:!0,value:void 0},Bp={writable:!0,value:void 0},Up={writable:!0,value:""};function Lp(t){let e;if(t){let i;const n=t.message;i=t.ltsErrorCode,Xn(i)?111===i?i=Du.LIC_EXPIRED.code:106===i||108===i?i=Du.LIC_INVALID.code:i>0&&(i=-(2e4+i)):i=Du.LIC_INVALID.code,e={code:i,message:n};}else e=Du.LIC_INVALID;return e}const Op="3.0.0";var Wp;!function(t){t[t.publicTrial=0]="publicTrial",t[t.privateTrial=1]="privateTrial",t[t.normal=2]="normal";}(Wp||(Wp={}));var Np,_p=new WeakMap,Fp=new WeakMap,Hp=new WeakMap,Vp=new WeakMap,zp=new WeakMap,$p=new WeakMap,jp=new WeakMap,Xp=new WeakMap,Gp=new WeakSet,Yp=new WeakSet,qp=new WeakSet,Jp=new WeakSet,Zp=new WeakSet,Qp=new WeakSet;class Kp{constructor(t){v(this,Qp),v(this,Zp),v(this,Jp),v(this,qp),v(this,Yp),v(this,Gp),f(this,_p,{writable:!0,value:void 0}),f(this,Fp,{writable:!0,value:void 0}),f(this,Hp,{writable:!0,value:void 0}),f(this,Vp,{writable:!0,value:void 0}),f(this,zp,{writable:!0,value:void 0}),f(this,$p,{writable:!0,value:void 0}),f(this,jp,{writable:!0,value:void 0}),f(this,Xp,{writable:!0,value:void 0}),s(this,Fp,void 0),s(this,_p,void 0),s(this,Hp,""),s(this,Vp,""),s(this,$p,Wp.publicTrial),s(this,Xp,void 0),s(this,jp,"");const e=Wu({_pLoad:{isEmpty:!0},_license:t,_licenseServer:[]},!0);let i;if(e&&Gn(e.l)?(i=e.l.trim(),1===e.lt?s(this,$p,Wp.publicTrial):2===e.lt?s(this,$p,Wp.privateTrial):s(this,$p,Wp.normal)):(i="",s(this,$p,Wp.publicTrial)),""===i?s(this,_p,i):i.includes("-")?s(this,Fp,i):s(this,_p,i),On(e.ls)){e.ls.length>0&&s(this,Xp,e.ls);const t=n(this,Xp);let o,r;if(t&&t.length>0){for(o=0;o<t.length;o++)r=t[o],r.endsWith("/")||(t[o]=`${r}/`);p(this,Gp,tg).call(this,t,i)&&s(this,$p,Wp.publicTrial);}}s(this,jp,e.sp);}async init(t,e,i){let s=t;s.endsWith("/")||(s=`${s}/`),n(this,zp)||await p(this,qp,ig).call(this,i);try{await p(this,Qp,og).call(this,e);}catch(t){const e=Lp(t);let i=!1;e.code===Du.LIC_EXPIRED.code?-1!==e.message.toLowerCase().indexOf("trial license")&&(i=!0):this.isPublicTrial()&&(i=!0),i&&Nu({_bNeverShowDialog:!1,engineResourcePath:s,_onLog:console.log},"error",e.message),Du.throw(e);}}getClientUUID(){return n(this,Vp)}getAuthResult(){return n(this,Hp)}isPublicTrial(){return n(this,$p)===Wp.publicTrial}setClientUUID(t){s(this,Vp,t);}setAuthResult(t){s(this,Hp,t);}}function tg(t,e){let i=!0;if(On(t)&&t.length>0){const e=t[0];if(Gn(e)&&""!==e){"mlts.dynamsoft.com"!==new URL(e).hostname&&(i=!1);}}return i&&(!e||"200001"===e||e.startsWith("200001-"))}function eg(){return window.location.origin?window.location.origin.startsWith("http")?window.location.origin:"https://localhost":window.location.href.startsWith("http")?window.location.href:"https://localhost"}function ig(t){const e={dm:p(this,Yp,eg).call(this),fetch:window.fetch};t&&(e.bd=!0,e.log=console.log),s(this,zp,Ap(e));}function ng(){return this.isPublicTrial()?"":n(this,Fp)||n(this,_p)}function sg(){const t=[];return t.push(gn.browser),t.push(gn.version.toString()),t.push(gn.OS),t.join(" ")}async function og(t){if(this.getAuthResult()&&this.getClientUUID())return {ar:this.getAuthResult(),cu:this.getClientUUID()};const e={pd:"ddv",dt:"browser",v:Op,os:p(this,Zp,sg).call(this),l:p(this,Jp,ng).call(this),ls:n(this,Xp),sp:n(this,jp),fn:t||"",mnet(){},mxet(){}};""!==this.getClientUUID()&&(e.lsu=this.getClientUUID()),e.updateLicense=t=>{this.setAuthResult(t.ar),this.getClientUUID()||this.setClientUUID(t.cu);};const i=await n(this,zp).i(e);return this.getAuthResult()||this.setAuthResult(i.ar),this.getClientUUID()||this.setClientUUID(i.cu),i}async function rg(e){const i=Du.buildInfo("init",{});Du.info(i);let n=e.engineResourcePath.trim();n.endsWith("/")||(n=`${n}/`),no.resourceDir=n,Ep.init();if(!await no.isResourceDirValid())return Ep.reset(),i.status="Failed",Du.info(i),Du.reject(Du.RESOURCE_NOT_FOUND,"DDV.Core.init");let s=function(){var e;let i=null;var n;if(mapPackageRegister&&mapPackageRegister.license)i=null===(n=mapPackageRegister.license.LicenseManager)||void 0===n?void 0:n.license;else if(null!==(e=window)&&void 0!==e&&null!==(e=e.Dynamsoft)&&void 0!==e&&null!==(e=e.Core)&&void 0!==e&&null!==(e=e.mapPackageRegister)&&void 0!==e&&e.license){var s;i=null===(s=window.Dynamsoft.Core.mapPackageRegister.license.LicenseManager)||void 0===s?void 0:s.license;}return null!==i?""===i?"":(Gn(i)&&(i=i.trim()),i):null}();null!==s&&""!==s||(s=e.license.trim());let o,r,a=s.startsWith("DLS")||0===s.length,l=!1,h=!1;if(a)try{var c;let i;if(null!=mapPackageRegister&&mapPackageRegister.license?i=await mapPackageRegister.license.getAR():null!==(c=window)&&void 0!==c&&null!==(c=c.Dynamsoft)&&void 0!==c&&null!==(c=c.Core)&&void 0!==c&&null!==(c=c.mapPackageRegister)&&void 0!==c&&c.license&&(i=await window.Dynamsoft.Core.mapPackageRegister.license.getAR()),i)o=i.ar,r=i.u,l=i.pt,i.pk?(o=i.pk,a=!1):h=!0,_n(o)&&i.ae&&Du.throw(Lp(i.ae));else {const t=await async function(t,e,i,n){const s=new Kp(t);return await s.init(e,i,n),{authResult:s.getAuthResult(),clientUUID:s.getClientUUID(),bPublicTrial:s.isPublicTrial()}}(s,n,e.deviceFriendlyName||"");o=t.authResult,r=t.clientUUID,l=t.bPublicTrial;}}catch(t){throw Ep.setLicenseErr(t),i.status="Failed",Du.info(i),t}else o=s,r="";const d={licenseInfo:null};try{const t=await no.getLicenseInfo(o,a,r);d.licenseInfo=t,Ep.setLicenseInfo(t),!h&&l&&t.trial&&t.msg&&Nu({_bNeverShowDialog:!1,engineResourcePath:n,_onLog:console.log},"warn",t.msg);}catch(t){throw t&&t.code<=-8e4&&Ep.setLicenseErr(t),i.status="Failed",Du.info(i),t}return a&&(d.deviceUuid=r),i.status="Completed",Du.info(i),d}const ag={scrollToLatest:!1};class lg{constructor(t){i(this,"viewerUids",void 0),i(this,"groupUid",void 0),i(this,"config",void 0),i(this,"isSetScrollToLatest",!1),this.groupUid=t,this.viewerUids=new Set,this.config=Nn(ag);}getViewerUids(){return [...this.viewerUids.values()]}updateConfig(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this.config,t);}}class hg{constructor(t){i(this,"canvas",void 0),i(this,"style",{type:"rect",size:100,borderColor:"#323232",borderWidth:3,magnification:3}),Object.assign(this.style,t||{}),this.canvas=document.createElement("canvas");}render(t){const{type:e,size:i,borderColor:n,borderWidth:s,magnification:o}=this.style,r=i/2*devicePixelRatio,a=i*devicePixelRatio,l=2*Math.PI,h=t.canvas.getContext("2d",{willReadFrequently:!0});h.save(),h.setTransform(1,0,0,1,0,0),t.fromX*devicePixelRatio<a&&t.fromY*devicePixelRatio<a?h.translate(t.canvas.width-r,r):h.translate(r,r),h.beginPath(),"circle"===e?h.arc(0,0,r,0,l):h.rect(-r,-r,a,a),h.clip(),h.scale(o,o),h.clearRect(-r,-r,2*r,2*r);const c=h.getImageData(t.fromX*devicePixelRatio-r,t.fromY*devicePixelRatio-r,a,a);this.canvas.width=a,this.canvas.height=a;this.canvas.getContext("2d").putImageData(c,0,0),h.drawImage(this.canvas,-r,-r,a,a),h.closePath(),h.strokeStyle=n,h.lineWidth=s,h.stroke(),h.restore();}}var cg,dg;!function(t){t.LEFT="left",t.TOP="top",t.RIGHT="right",t.BOTTOM="bottom";}(cg||(cg={})),function(t){t.DEFAULT="default",t.CAPTURE="capture",t.PERSPECTIVE="perspective",t.THUMBNAIL="thumbnail";}(dg||(dg={}));class ug{constructor(){i(this,"db",void 0),this.db=new Map;}async set(t,e){return new Promise(((i,n)=>{this.db.has(t)?n(new Error(`The item ${t} already exists.`)):(this.db.set(t,e),i(`Save ${t} to database successful.`));}))}async get(t){return new Promise(((e,i)=>{this.db.has(t)?e(this.db.get(t)):i(new Error(`The item ${t} does not exist.`));}))}async remove(t){return new Promise(((e,i)=>{const n=this.db.get(t);this.db.delete(t),e(n);}))}async update(t,e){return new Promise(((i,n)=>{this.db.has(t)?(this.db.set(t,e),i(`Update ${t} successful.`)):n(new Error(`The item ${t} does not exist.`));}))}dispose(){this.db.clear();}reset(){this.db.clear();}}class pg extends js{constructor(){super(),i(this,"openDocument",void 0),i(this,"closeDocument",void 0),i(this,"syncDocument",void 0),i(this,"addPagesToDoc",void 0),i(this,"deletePages",void 0),i(this,"updatePage",void 0),i(this,"reorderPages",void 0),i(this,"movePages",void 0),i(this,"swapPages",void 0),i(this,"selectedPageChanged",void 0),i(this,"pageChanged",void 0),i(this,"pageChangedAfterRender",void 0),i(this,"pageExistenceChanged",void 0),i(this,"currentPageChanged",void 0),i(this,"currentIndexChanged",void 0),i(this,"pageRendered",void 0),i(this,"pagesDropped",void 0),i(this,"pagesDragged",void 0),i(this,"tabChanged",void 0),i(this,"displayModeChanged",void 0),i(this,"fitModeChanged",void 0),i(this,"filterChanged",void 0),i(this,"toolModeChanged",void 0),i(this,"zoomChanged",void 0),i(this,"visibleChanged",void 0),i(this,"beforeLayout",void 0),i(this,"afterLayout",void 0),i(this,"beforeRender",void 0),i(this,"afterRender",void 0),i(this,"destroy",void 0),i(this,"resize",void 0),i(this,"scroll",void 0),i(this,"cropRectDrawn",void 0),i(this,"cropRectDeleted",void 0),i(this,"cropRectModified",void 0),i(this,"cropModeChanged",void 0),i(this,"beforeCropPages",void 0),i(this,"afterCropPages",void 0),i(this,"operationsChanged",void 0),i(this,"perspectiveQuadChanged",void 0),i(this,"quadSelectionStyleChanged",void 0),i(this,"autoCaptureChanged",void 0),i(this,"autoDetectChanged",void 0),i(this,"torchChanged",void 0),i(this,"cameraPlayed",void 0),i(this,"cameraClosed",void 0),i(this,"cameraInit",void 0),i(this,"cameraChanged",void 0),i(this,"cameraCaptured",void 0),i(this,"annotationsUpdated",void 0),i(this,"annotationModeChanged",void 0),i(this,"annotationDefaultStyleChanged",void 0),i(this,"selectedAnnotationsChanged",void 0),i(this,"annotationLayerStateChanged",void 0),i(this,"beforeAnnotationEdit",void 0),i(this,"afterAnnotationEdit",void 0),i(this,"beforeAnnotationDraw",void 0),i(this,"afterAnnotationDraw",void 0),i(this,"annotationTextCharsSelected",void 0),i(this,"annotationTextContentUpdated",void 0),i(this,"searchTextChanged",void 0),i(this,"searchTextSelected",void 0),i(this,"searchTextCleared",void 0),i(this,"textSelected",void 0),i(this,"beforeTextSelected",void 0),i(this,"afterTextSelected",void 0),this.openDocument=Gs(this),this.closeDocument=Gs(this),this.syncDocument=Gs(this),this.addPagesToDoc=Gs(this),this.deletePages=Gs(this),this.updatePage=Gs(this),this.reorderPages=Gs(this),this.movePages=Gs(this),this.swapPages=Gs(this),this.selectedPageChanged=Gs(this),this.pageChanged=Gs(this),this.pageChangedAfterRender=Gs(this),this.pageExistenceChanged=Gs(this),this.currentPageChanged=Gs(this),this.currentIndexChanged=Gs(this),this.pageRendered=Gs(this),this.pagesDragged=Gs(this),this.pagesDropped=Gs(this),this.tabChanged=Gs(this),this.displayModeChanged=Gs(this),this.fitModeChanged=Gs(this),this.filterChanged=Gs(this),this.toolModeChanged=Gs(this),this.zoomChanged=Gs(this),this.visibleChanged=Gs(this),this.beforeLayout=Gs(this),this.afterLayout=Gs(this),this.beforeRender=Gs(this),this.afterRender=Gs(this),this.resize=Gs(this),this.scroll=Gs(this),this.destroy=Gs(this),this.cropRectDrawn=Gs(this),this.cropRectDeleted=Gs(this),this.cropRectModified=Gs(this),this.cropModeChanged=Gs(this),this.beforeCropPages=Gs(this),this.afterCropPages=Gs(this),this.operationsChanged=Gs(this),this.perspectiveQuadChanged=Gs(this),this.quadSelectionStyleChanged=Gs(this),this.autoCaptureChanged=Gs(this),this.autoDetectChanged=Gs(this),this.torchChanged=Gs(this),this.cameraPlayed=Gs(this),this.cameraClosed=Gs(this),this.cameraInit=Gs(this),this.cameraChanged=Gs(this),this.cameraCaptured=Gs(this),this.annotationModeChanged=Gs(this),this.selectedAnnotationsChanged=Gs(this),this.annotationLayerStateChanged=Gs(this),this.annotationDefaultStyleChanged=Gs(this),this.beforeAnnotationEdit=Gs(this),this.afterAnnotationEdit=Gs(this),this.beforeAnnotationDraw=Gs(this),this.afterAnnotationDraw=Gs(this),this.annotationsUpdated=Gs(this),this.annotationTextCharsSelected=Gs(this),this.annotationTextContentUpdated=Gs(this),this.searchTextChanged=Gs(this),this.searchTextSelected=Gs(this),this.searchTextCleared=Gs(this),this.textSelected=Gs(this),this.beforeTextSelected=Gs(this),this.afterTextSelected=Gs(this);}}class gg{static numberArrayIsValid(t,e,i,n,s){return l(this,gg,fg).call(this,t,1,e,i,s,n)}static stringArrayIsValid(t,e){return l(this,gg,fg).call(this,t,2,void 0,void 0,0,e)}static blobArrayIsValid(t,e){return l(this,gg,fg).call(this,t,4,void 0,void 0,void 0,e)}static quadIsValid(t,e){const i=[],n="Quad";l(this,gg,xg).call(this,i,t,6,l(this,gg,mg).call(this,n,e,void 0),4);let s=0;for(const o of t){const t=`[${s}]`;i.push(...l(this,gg,fg).call(this,o,1,void 0,void 0,2,l(this,gg,mg).call(this,n,e,t,!0))),s+=1;}return i}static docDetectConfigIsValid(t,e){const i=[],n="DocumentDetectConfig";return l(this,gg,xg).call(this,i,t,5,l(this,gg,mg).call(this,n,e)),l(this,gg,xg).call(this,i,t.autoCaptureDelay,1,l(this,gg,mg).call(this,n,e,"autoCaptureDelay")),_n(t.acceptedPolygonConfidence)||l(this,gg,xg).call(this,i,t.acceptedPolygonConfidence,1,l(this,gg,mg).call(this,n,e,"acceptedPolygonConfidence")),_n(t.enableAutoCapture)||l(this,gg,xg).call(this,i,t.enableAutoCapture,3,l(this,gg,mg).call(this,n,e,"enableAutoCapture")),i}static docDetectConfIsValid(t,e){const i=[],n="DocumentDetectConfidence";return l(this,gg,xg).call(this,i,t,5,l(this,gg,mg).call(this,n,e)),l(this,gg,xg).call(this,i,t.angleConfidence,1,l(this,gg,mg).call(this,n,e,"angleConfidence"),0,100),l(this,gg,xg).call(this,i,t.areaConfidence,1,l(this,gg,mg).call(this,n,e,"areaConfidence"),0,100),l(this,gg,xg).call(this,i,t.centerConfidence,1,l(this,gg,mg).call(this,n,e,"centerConfidence"),0,100),i}static imageDataIsValid(t,e){const i=[],n="VImageData";return l(this,gg,xg).call(this,i,t,5,l(this,gg,mg).call(this,n,e)),l(this,gg,xg).call(this,i,t.data,8,l(this,gg,mg).call(this,n,e,"data")),l(this,gg,xg).call(this,i,t.type,9,l(this,gg,mg).call(this,n,e,"type")),_n(t.height)||l(this,gg,xg).call(this,i,t.height,1,l(this,gg,mg).call(this,n,e,"height")),_n(t.width)||l(this,gg,xg).call(this,i,t.width,1,l(this,gg,mg).call(this,n,e,"width")),i}static filterTypeIsValid(t,e){const i=[];return l(this,gg,xg).call(this,i,t,10,l(this,gg,mg).call(this,"EnumImageFilterType",e)),i}static imageEncodeOptionIsValid(t,e){const i=[],n="ImageEncodeOption";return l(this,gg,xg).call(this,i,t,5,l(this,gg,mg).call(this,n,e)),l(this,gg,xg).call(this,i,t.type,9,l(this,gg,mg).call(this,n,e,"type")),_n(t.params)||l(this,gg,xg).call(this,i,t.params,5,l(this,gg,mg).call(this,n,e,"params")),i}static makeSureNumberValid(t,e,i,n,s,o){return l(this,gg,vg).call(this,l(this,gg,Dg).call(this,t,e,i),n,s,o)}static makeSureStringValid(t,e,i,n){return l(this,gg,vg).call(this,{isValid:l(this,gg,Rg).call(this,t)},e,i,n)}static makeSureDetectResultValid(t,e,i,n){const s=[],o="DetectResult";l(this,gg,xg).call(this,s,t,5,l(this,gg,mg).call(this,o,n)),s.push(...gg.quadIsValid(null==t?void 0:t.location,o)),l(this,gg,xg).call(this,s,null==t?void 0:t.width,1,l(this,gg,mg).call(this,o,n,"width"),1,void 0),l(this,gg,xg).call(this,s,null==t?void 0:t.height,1,l(this,gg,mg).call(this,o,n,"height"),1,void 0),s.push(...gg.docDetectConfigIsValid(null==t?void 0:t.config,o)),null!=t&&t.confidence&&l(this,gg,xg).call(this,s,t.confidence,1,l(this,gg,mg).call(this,o,n,"confidence")),this.makeSureValid(s,e,i);}static makeSureValid(t,e,i,n){0!==t.length&&l(this,gg,yg).call(this,t,e,i,n);}static makeSureMissing(t,e,i){_n(t)&&l(this,gg,yg).call(this,void 0,e,i,Du.PARAM_MISS);}static makeSureCameraObject(t,e,i){const n=[],s=i;this.makeSureMissing(t,e,i),Gn(t)?this.makeSureStringValid(t,e,i):(l(this,gg,xg).call(this,n,t,5,l(this,gg,mg).call(this,s)),l(this,gg,xg).call(this,n,t.deviceId,2,l(this,gg,mg).call(this,s,void 0,"deviceId")),l(this,gg,xg).call(this,n,t.label,2,l(this,gg,mg).call(this,s,void 0,"label")),this.makeSureValid(n,e,i));}static initTypeCheckMap(){r(this,gg,Bg)[7]=Hn,r(this,gg,Bg)[15]=Gn,r(this,gg,Bg)[3]=zn,r(this,gg,Bg)[5]=Wn,r(this,gg,Bg)[4]=Vn,r(this,gg,Bg)[2]=l(this,gg,Rg),r(this,gg,Bg)[8]=l(this,gg,bg),r(this,gg,Bg)[11]=l(this,gg,Tg),r(this,gg,Bg)[12]=l(this,gg,Ag),r(this,gg,Bg)[13]=l(this,gg,kg),r(this,gg,Bg)[14]=l(this,gg,Eg),r(this,gg,Bg)[1]=l(this,gg,Dg),r(this,gg,Bg)[6]=l(this,gg,Sg),r(this,gg,Bg)[9]=l(this,gg,Cg),r(this,gg,Bg)[10]=l(this,gg,Pg),r(this,gg,Bg)[16]=l(this,gg,Ig);}}function fg(t,e,i,n,s,o){const r=[],a="Array";if(l(this,Np,xg).call(this,r,t,6,l(this,Np,mg).call(this,a,o),s),r.length>0)return r;let h=0;for(const s of t){const t=`[${h}]`;l(this,Np,xg).call(this,r,s,e,l(this,Np,mg).call(this,a,o,t,!0),i,n),h+=1;}return r}function vg(t,e,i,n){const{isValid:s,isInRange:o,isSupported:r}=t,a=!!_n(s)||s,h=!!_n(o)||o,c=!!_n(r)||r;a&&h&&c||(n||(n=a?h?Du.PARAM_NOT_SUPPORT:Du.PARAM_OUT_OF_RANGE:Du.PARAM_INVALID),l(this,Np,yg).call(this,void 0,e,i,n));}function mg(t,e,i,n){return e?i?`${e}${n?"":"."}${i}`:`${e}`:i?`${t}${n?"":"."}${i}`:`${t}`}function yg(t,e,i,n){const s=_n(n)?{...Du.PARAM_INVALID}:{...n};t&&(s.details=t),Du.throw(s,e,i);}function xg(t,e,i,n,s,o){const r=l(this,Np,wg).call(this,e,i,n,s,o);r&&t.push(r);}function wg(t,e,i,n,s){if(_n(t))return `${i} is missing.`;const o=r(this,Np,Bg)[e];if(o){const e=o.bind(this)(t,n,s);if(zn(e)){if(!e)return `${i} is invalid.`}else if(Wn(e)){const{isValid:t,isInRange:n,isSupported:s}=e;if(!1===t)return `${i} is invalid.`;if(!1===n)return `${i} is out of range.`;if(!1===s)return `${i} is not supported.`}}}function bg(t){return Hn(t)||Vn(t)}function Sg(t,e){return On(t)?Xn(e)&&0===t.length||!_n(e)&&t.length<e?{isValid:!1}:{isValid:!0,isInRange:!!_n(e)||t.length>=e}:{isValid:!1}}function Cg(t){return Xn(t)?{isValid:!0,isInRange:t>=co.RGBA&&t<=co.PNG}:{isValid:!1}}function Pg(t){return Gn(t)?{isValid:!0,isInRange:(e=t,!!Cu.get(e))}:{isValid:!1};var e;}function Tg(t){return void 0!==_o.get(t)}function Ag(t){return void 0!==Fo.get(t)}function kg(t){return void 0!==No.get(t)}function Eg(t){if(Gn(t)){const e=t.trim();return -1!==r(this,Np,Mg).indexOf(e)}return !1}function Dg(t,e,i){let n=!0;return Xn(t)?(_n(e)||(n=t>=e),!_n(i)&&n&&(n=t<=i),{isValid:!0,isInRange:n}):{isValid:!1}}function Rg(t){return !!Gn(t)&&0!==t.trim().length}function Ig(t){if(!l(this,Np,Rg).call(this,t))return {isValid:!1};const e=t.match(/^D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(?:([+-])(\d{2})['’](\d{2})['’]|)$/);let i=!1;if(e){const[,t,n,s,o,r,a,l,h,c]=e,d=new Date(`${t}-${n}-${s}T${o}:${r}:${a}`);if(i=!0,d.getFullYear()===parseInt(t,10)&&d.getMonth()+1===parseInt(n,10)&&d.getDate()===parseInt(s,10)&&d.getHours()===parseInt(o,10)&&d.getMinutes()===parseInt(r,10)&&d.getSeconds()===parseInt(a,10)||(i=!1),i&&l){const t=parseInt(h,10),e=parseInt(c,10);("+"===l&&(t<0||t>12||e<0||e>59)||"-"===l&&(t<0||t>12||e<0||e>59))&&(i=!1);}}return {isSupported:i}}Np=gg;var Mg={writable:!0,value:["1.1","1.2","1.3","1.4","1.5","1.6","1.7"]},Bg={writable:!0,value:Object.create(null)};gg.initTypeCheckMap();class Ug{constructor(t){i(this,"maxConcurrency",void 0),i(this,"currentConcurrency",void 0),i(this,"queue",void 0),this.maxConcurrency=t,this.currentConcurrency=0,this.queue=[];}async acquire(){return new Promise((t=>{this.currentConcurrency<this.maxConcurrency?(this.currentConcurrency+=1,t(!0)):this.queue.push(t);}))}release(){if(this.queue.length>0){this.queue.shift()();}else this.currentConcurrency-=1;}}class Lg{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;i(this,"tasks",void 0),i(this,"semaphore",void 0),this.tasks=[],this.semaphore=new Ug(t);}async process(t){await this.semaphore.acquire();let e=null;try{t.cancelled||(e=await this.handler(t.taskUid));}catch(t){e=null;}if(t.completed=!0,this.tasks.includes(t)){const e=this.tasks.indexOf(t);this.tasks.splice(e,1);}t.emitter.emit(t.taskUid,e),this.semaphore.release();}async executeTask(t){return new Promise(((e,i)=>{let n=this.tasks.find((e=>e.taskUid===t));n||(n={taskUid:t,emitter:new Kn,completed:!1,cancelled:!1,running:!1},this.tasks.push(n)),n.cancelled=!1,n.emitter.on(t,(t=>{e(t);})),n.running||(n.running=!0,this.process(n));}))}cancel(t){const e=this.tasks.find((e=>e.taskUid===t));e&&(e.cancelled=!0);}destroy(){this.tasks=[];}async handler(t){return Promise.resolve(null)}}class Og extends Lg{async handler(t){return new Promise(((e,i)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{n.onload=null,n.onerror=null,e(n);},n.onerror=t=>{n.onload=null,n.onerror=null,e(null);},n.src=t;}))}}class Wg extends Og{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){let e=this.core.pageService.getPage(t);if(!e||e.isDestroyed)return null;let{img:i}=e.raw;if(!i){let{url:n}=e.raw;if(!n){let i=e.raw.data;if(!i){let n=await this.core.imageDataService.getRaw(t);const s=this.core.pageService.getPage(t);if(!s)return null;if(e.isDestroyed&&!s.isDestroyed&&(n=await this.core.imageDataService.getRaw(t,!0)),!n||s.isDestroyed)return null;i=n.data;}n=URL.createObjectURL(i),e.raw.url=n;}if(i=await this.imageLoader.executeTask(n),e=this.core.pageService.getPage(t),!e||e.isDestroyed)return null;e.raw.img=i;}return i}}class Ng extends Og{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let n=null===(e=i.original)||void 0===e?void 0:e.img;if(!n){var s;let e=null===(s=i.original)||void 0===s?void 0:s.url;if(!e){var o;let n=null===(o=i.original)||void 0===o?void 0:o.data;if(!n){let e=await this.core.imageDataService.getOriginal(t);const s=this.core.pageService.getPage(t);if(!s)return null;if(i.isDestroyed&&!s.isDestroyed&&(e=await this.core.imageDataService.getRaw(t,!0)),!e||s.isDestroyed)return null;n=e.data;}e=URL.createObjectURL(n),i.original.url=e;}if(n=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),!i||i.isDestroyed)return null;i.original.img=n;}return n}}class _g extends Og{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let n=null===(e=i.display)||void 0===e?void 0:e.img;if(!n){var s;let e=null===(s=i.display)||void 0===s?void 0:s.url;if(!e){var o;let n=null===(o=i.display)||void 0===o?void 0:o.data;if(!n){let e=await this.core.imageDataService.getDisplay(t,!0);const s=this.core.pageService.getPage(t);if(!s)return null;if(i.isDestroyed&&!s.isDestroyed&&(e=await this.core.imageDataService.getDisplay(t,!0)),!e||s.isDestroyed)return null;n=e.data;}e=URL.createObjectURL(n),i.display.url=e;}const{filter:r}=i;if(n=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),!i||i.isDestroyed)return null;if(r!==i.filter)return this.handler(i.uid);i.display.img=n;}return n}}class Fg extends Og{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let n=null===(e=i.thumbnail)||void 0===e?void 0:e.img;if(!n){var s;let e=null===(s=i.thumbnail)||void 0===s?void 0:s.url;if(!e){var o;let n=null===(o=i.thumbnail)||void 0===o?void 0:o.data;if(!n){const e=await this.core.imageDataService.getThumbnail(t);if(i=this.core.pageService.getPage(t),!e||i.isDestroyed)return null;n=e.data;}e=URL.createObjectURL(n),i.thumbnail.url=e;}if(n=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),i.isDestroyed)return null;i.thumbnail.img=n;}return n}}class Hg{constructor(t){i(this,"rawImageLoader",void 0),i(this,"originalImageLoader",void 0),i(this,"displayImageLoader",void 0),i(this,"thumbnailImageLoader",void 0);const e=new Og;this.rawImageLoader=new Wg(t,e),this.originalImageLoader=new Ng(t,e),this.displayImageLoader=new _g(t,e),this.thumbnailImageLoader=new Fg(t,e);}async loadRawImage(t){return this.rawImageLoader.executeTask(t)}cancelLoadRawImage(t){this.rawImageLoader.cancel(t);}async loadOriginalImage(t){return this.originalImageLoader.executeTask(t)}cancelLoadOriginalImage(t){this.originalImageLoader.cancel(t);}async loadDisplayImage(t){return this.displayImageLoader.executeTask(t)}cancelLoadDisplayImage(t){this.displayImageLoader.cancel(t);}async loadThumbnailImage(t){return this.thumbnailImageLoader.executeTask(t)}cancelLoadThumbnailImage(t){this.thumbnailImageLoader.cancel(t);}}class Vg{constructor(t,e,n){i(this,"worker",void 0),i(this,"id",void 0),i(this,"manager",void 0),i(this,"callbacks",{}),i(this,"busy",!1),i(this,"counter",0),i(this,"tasks",[]),this.worker=t,this.id=e,this.manager=n,this.worker.addEventListener("message",(t=>{this.onMessage(t);}),!1);}cancel(t){const e=this.tasks.findIndex((e=>{var i;return (null===(i=e.data)||void 0===i?void 0:i.taskUid)===t}));if(e>=0){const t=this.tasks.splice(e,1)[0];this.callbacks[t.callbackId]&&delete this.callbacks[t.callbackId],this.setBusy(!1);}}setBusy(t){if(this.busy=t,!t)if(this.tasks.length){const t=this.tasks.shift();this.send(t);}else this.worker.terminate(),this.manager.removeActor(this);}isBusy(){return this.busy}getWorker(){return this.worker}onMessage(t){this.setBusy(!1);const{callbackId:e}=t.data,i=e?this.callbacks[e]:null;i&&i(t.data),delete this.callbacks[e];}send(t,e){if(this.busy)return void this.tasks.push({...t});this.setBusy(!0);const i=`${this.id}-${t.action}-cb-${this.counter}`;t.callback&&(this.callbacks[i]=t.callback,this.counter+=1),t.callbackId=i;const n={...t.data,callbackId:i};e?this.worker.postMessage(n,[e.data.buffer]):this.worker.postMessage(n);}}class zg{constructor(t,e){i(this,"concurrency",1),i(this,"actors",[]),i(this,"workerUrl",void 0),this.workerUrl=t,this.concurrency=e;}send(t,e){this.getActor().send(t,e);}getActor(){const t=this.actors.filter((t=>!t.isBusy()))[0];if(t)return t;if(this.actors.length<this.concurrency){const t=new Worker(this.workerUrl),e=new Vg(t,this.actors.length,this);return this.actors.push(e),e}const e=Math.floor(Math.random()*this.concurrency);return this.actors[e]}removeActor(t){const e=this.actors.indexOf(t);this.actors.splice(e,1);}cancel(t){for(const e of this.actors)e.cancel(t);}clear(){for(const t of this.actors)t.getWorker().terminate();this.actors=[];}}function $g(){onmessage=t=>{const{index:e}=t.data,i=t.data.sourceWidth,n=t.data.sourceHeight,s=t.data.width,o=t.data.height,r=t.data.source.data,a=s*o*4,l=new ArrayBuffer(a);let h=null;try{h=new Uint8ClampedArray(l,0,a);}catch(t){h=new Uint8Array(l,0,a);}for(let t=0;t<o;t++){const e=t*n/o,a=Math.floor(e),l=1-(e-a),c=a,d=(t+1)*n/o,u=Math.floor(d-1e-5),p=d-u,g=u;let f=t*s*4;for(let t=0;t<s;t++){const e=t*i/s,n=Math.floor(e),o=1-(e-n),a=n,d=(t+1)*i/s,u=Math.floor(d-1e-5),v=d-u,m=u;let y=0,x=0,w=0,b=0,S=0;const C=255;let P,T,A=(c+1)*i*4+4*a;for(P=c+1;P<g;++P){const t=C;y+=r[A+2]*o*t,x+=r[A+1]*o*t,w+=r[A]*o*t,b+=r[A+3]*o*t,S+=C*o,A+=4*i;}let k=(c+1)*i*4+4*m;for(P=c+1;P<g;++P){const t=C;y+=r[k+2]*v*t,x+=r[k+1]*v*t,w+=r[k]*v*t,b+=r[k+3]*v*t,S+=C*v,k+=4*i;}let E=c*i*4+4*(a+1);for(T=a+1;T<m;++T){const t=C;y+=r[E+2]*l*t,x+=r[E+1]*l*t,w+=r[E]*l*t,b+=r[E+3]*l*t,S+=C*l,E+=4;}let D=g*i*4+4*(a+1);for(T=a+1;T<m;++T){const t=C;y+=r[D+2]*p*t,x+=r[D+1]*p*t,w+=r[D]*p*t,b+=r[D+3]*p*t,S+=C*p,D+=4;}for(P=c+1;P<g;++P){let t=P*i*4+4*(a+1);for(T=a+1;T<m;++T){const e=C;y+=r[t+2]*e,x+=r[t+1]*e,w+=r[t]*e,b+=r[t+3]*e,S+=e,t+=4;}}let R=c*i*4+4*a;const I=C;y+=r[R+2]*(l*o)*I,x+=r[R+1]*(l*o)*I,w+=r[R]*(l*o)*I,b+=r[R+3]*(l*o)*I,S+=C*(l*o),R=c*i*4+4*m;const M=C;y+=r[R+2]*(l*v)*M,x+=r[R+1]*(l*v)*M,w+=r[R]*(l*v)*M,b+=r[R+3]*(l*v)*M,S+=C*(l*v),R=g*i*4+4*a;const B=C;y+=r[R+2]*(p*o)*B,x+=r[R+1]*(p*o)*B,w+=r[R]*(p*o)*B,b+=r[R+3]*(p*o)*B,S+=C*(p*o),R=g*i*4+4*m;const U=C;y+=r[R+2]*(p*v)*U,x+=r[R+1]*(p*v)*U,w+=r[R]*(p*v)*U,b+=r[R+3]*(p*v)*U,S+=C*(p*v);let L=b/S,O=0,W=0,N=0;0!==L&&(O=y/S,W=x/S,N=w/S),O+=.5,W+=.5,N+=.5,L+=.5,h[f]=Math.floor(N),f+=1,h[f]=Math.floor(W),f+=1,h[f]=Math.floor(O),f+=1,h[f]=Math.floor(L),f+=1;}}const c={index:e,target:h,taskUid:t.data.taskUid,callbackId:t.data.callbackId};try{postMessage(c,[h.buffer]);}catch(t){postMessage(c,null);}h=null;};}let jg=class{constructor(){i(this,"actorSystem",void 0),i(this,"concurrency",3);const t=window.URL.createObjectURL(new Blob(["(",$g.toString(),")()"],{type:"text/plain"}));this.actorSystem=new zg(t,this.concurrency);}cancel(t){this.actorSystem.cancel(t);}optimize(t,e,i,n,s,o){return new Promise(((r,a)=>{const l=t.getContext("2d"),h=Math.floor(e)||1,c=Math.floor(i)||1,d=l.getImageData(0,0,h,c),u={action:"optimize",data:{taskUid:o,sourceWidth:h,sourceHeight:c,width:Math.ceil(n)||1,height:Math.ceil(s)||1,source:d},callback(t){r(t);}};this.actorSystem.send(u,u.data.source);}))}};class Xg{constructor(){}reset(){}async perspectivePreview(t,e,i,n){var s,o,r;let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const l=new xo,h=await l.initImage({source:t,isRGBA:e===co.RGBA,width:n.width,height:n.height,isBGRA:e===co.BGRA});h.srcBuffer&&(t=h.srcBuffer);let c=n.width,d=n.height;const u=null!==(s=n.angle)&&void 0!==s?s:0;90!==u&&270!==u||(c=n.height,d=n.width);const p=Math.min((null!==(o=a.width)&&void 0!==o?o:c)/c,(null!==(r=a.height)&&void 0!==r?r:d)/d),g=Math.floor(c*p+.5),f=Math.floor(d*p+.5);await l.resize(g,f,a.mode),null!=n&&n.angle&&await l.rotate({angle:n.angle});const v=[[Math.floor(i[0][0]*p+.5),Math.floor(i[0][1]*p+.5)],[Math.floor(i[1][0]*p+.5),Math.floor(i[1][1]*p+.5)],[Math.floor(i[2][0]*p+.5),Math.floor(i[2][1]*p+.5)],[Math.floor(i[3][0]*p+.5),Math.floor(i[3][1]*p+.5)]];await l.drawQuadrangle({location:v,strokeColor:a.strokeColor,lineWidth:a.lineWidth});const m=await l.getImage({ifDeleteObject:!0,isRGBA:e===co.RGBA,returnBlob:!1});await l.freeReservedData();const y={data:new Blob([m.imageData],{type:m.blobType}),width:m.imageWidth,height:m.imageHeight,resolutionX:m.imageXResolution,resolutionY:m.imageYResolution};return l.terminate(),y}async resize(t,e,i,n,s){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const r=new xo,a=await r.initImage({source:t,isRGBA:e===co.RGBA,width:i,height:n,isBGRA:e===co.BGRA});if(a.srcBuffer&&(t=a.srcBuffer),s>0){let t=1;t=i>n?i/s:n/s;const e=Math.floor(i/t+.5),a=Math.floor(n/t+.5);await r.resize(e,a,o.mode);}const l=await r.getImage({ifDeleteObject:!0,isRGBA:e===co.RGBA,returnBlob:!1});await r.freeReservedData();const h={data:new Blob([l.imageData],{type:l.blobType}),width:l.imageWidth,height:l.imageHeight,resolutionX:l.imageXResolution,resolutionY:l.imageYResolution};return r.terminate(),h}}class Gg extends qo{static create(t,e,i){return new Gg(t,e,i)}constructor(t,e,n){super("renameDocument"),i(this,"docUid",void 0),i(this,"oldName",void 0),i(this,"newName",void 0),this.docUid=t,this.oldName=e,this.newName=n;}}class Yg extends qo{static create(t,e){return new Yg(t,e)}constructor(t,e){super("paginationChanged"),i(this,"current",void 0),i(this,"total",void 0),this.current=t,this.total=e;}}class qg extends qo{static create(t,e){return new qg(t,e)}constructor(t,e){super("visibleChanged"),i(this,"newVisibility",void 0),i(this,"oldVisibility",void 0),this.newVisibility=t,this.oldVisibility=e;}}class Jg extends qo{static create(t,e,i){return new Jg(t,e,i)}constructor(t,e,n){super("openDocument"),i(this,"doc",void 0),i(this,"viewerUid",void 0),i(this,"groupUid",void 0),this.doc=t,this.viewerUid=e,this.groupUid=n;}}class Zg extends qo{static create(t,e,i){return new Zg(t,e,i)}constructor(t,e,n){super("closeDocument"),i(this,"doc",void 0),i(this,"viewerUid",void 0),i(this,"groupUid",void 0),this.doc=t,this.viewerUid=e,this.groupUid=n;}}class Qg extends qo{static create(t,e,i,n){return new Qg(t,e,i,n)}constructor(t,e,n,s){super("gotoPage"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"index",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=n,this.index=s;}}class Kg extends qo{static create(t,e,i){return new Kg(t,e,i)}constructor(t,e,n){super("filterChanged"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"filterType",void 0),this.docUid=t,this.pageUids=e,this.filterType=n;}}class tf extends qo{static create(t,e,i,n){return new tf(t,e,i,n)}constructor(t,e,n,s){super("currentChangedByScroll"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"current",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=n,this.current=s;}}class ef extends qo{static create(t,e,i){return new ef(t,e,i)}constructor(t,e,n){super("perspectiveQuadChanged"),i(this,"newQuad",void 0),i(this,"oldQuad",void 0),i(this,"isFull",void 0),this.newQuad=t,this.oldQuad=e,this.isFull=n;}}class nf extends qo{static create(t,e,i){return new nf(t,e,i)}constructor(t,e,n){super("operationsChanged"),i(this,"docUid",void 0),i(this,"undo",void 0),i(this,"redo",void 0),this.docUid=t,this.undo=e,this.redo=n;}}class sf extends qo{static create(t,e,i,n,s){return new sf(t,e,i,n,s)}constructor(t,e,n,s,o){super("perspective"),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"quad",void 0),i(this,"width",void 0),i(this,"height",void 0),this.docUid=t,this.pageUid=e,this.quad=n,this.width=s,this.height=o;}}class of extends qo{static create(t){return new of(t)}constructor(t){super("deleteDocs"),i(this,"docUids",void 0),this.docUids=t;}}class rf extends qo{static create(t){return new rf(t)}constructor(t){super("viewerCreated"),i(this,"viewer",void 0),this.viewer=t;}}class af extends qo{static create(t,e){return new af(t,e)}constructor(t,e){super("textSelected"),i(this,"text",void 0),i(this,"detail",void 0),this.text=t,this.detail=e;}}class lf extends qo{static create(t,e,i,n,s,o,r,a){return new lf(t,e,i,n,s,o,r,a)}constructor(t,e,n,s,o,r){let a=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7&&void 0!==arguments[7]&&arguments[7];super("textSearchChanged"),i(this,"text",void 0),i(this,"searchConfig",void 0),i(this,"searchResults",void 0),i(this,"searchUid",void 0),i(this,"searchType",void 0),i(this,"addedResults",void 0),i(this,"isLastPage",void 0),i(this,"isEditPages",void 0),this.text=t,this.searchConfig=e,this.searchResults=n,this.searchUid=s,this.searchType=o,this.addedResults=r,this.isLastPage=a,this.isEditPages=l;}}class hf extends qo{static create(t){return new hf(t)}constructor(t){super("cropRectDeleted"),i(this,"rect",void 0),this.rect=t;}}class cf extends qo{static create(t){return new cf(t)}constructor(t){super("cropRectDrawn"),i(this,"rect",void 0),this.rect=t;}}class df extends qo{static create(t,e){return new df(t,e)}constructor(t,e){super("cropRectModified"),i(this,"oldRect",void 0),i(this,"newRect",void 0),this.oldRect=t,this.newRect=e;}}class uf extends qo{static create(t,e){return new uf(t,e)}constructor(t,e){super("currentIndexChanged"),i(this,"oldIndex",void 0),i(this,"newIndex",void 0),this.oldIndex=t,this.newIndex=e;}}class pf extends qo{static create(t,e){return new pf(t,e)}constructor(t,e){super("displayModeChanged"),i(this,"oldDisplayMode",void 0),i(this,"newDisplayMode",void 0),this.oldDisplayMode=t,this.newDisplayMode=e;}}class gf extends qo{static create(t,e){return new gf(t,e)}constructor(t,e){super("fitModeChanged"),i(this,"oldFitMode",void 0),i(this,"newFitMode",void 0),this.oldFitMode=t,this.newFitMode=e;}}class ff extends qo{static create(t,e){return new ff(t,e)}constructor(t,e){super("toolModeChanged"),i(this,"oldToolMode",void 0),i(this,"newToolMode",void 0),this.oldToolMode=t,this.newToolMode=e;}}class vf extends qo{static create(t,e){return new vf(t,e)}constructor(t,e){super("zoomChanged"),i(this,"oldZoomRatio",void 0),i(this,"newZoomRatio",void 0),this.oldZoomRatio=t,this.newZoomRatio=e;}}class mf extends qo{static create(t,e,i,n){return new mf(t,e,i,n)}constructor(t,e,n,s){super("resized"),i(this,"oldWidth",void 0),i(this,"oldHeight",void 0),i(this,"newWidth",void 0),i(this,"newHeight",void 0),this.oldWidth=t,this.oldHeight=e,this.newWidth=n,this.newHeight=s;}}class yf extends qo{static create(t,e){return new yf(t,e)}constructor(t,e){super("document"),i(this,"docUid",void 0),i(this,"docName",void 0),this.docUid=t,this.docName=e;}}class xf extends qo{static create(t){return new xf(t)}constructor(t){super("captured"),i(this,"pageUid",void 0),this.pageUid=t;}}class wf extends qo{static create(t,e){return new wf(t,e)}constructor(t,e){super("cameraChanged"),i(this,"oldDeviceId",void 0),i(this,"newDeviceId",void 0),this.oldDeviceId=t,this.newDeviceId=e;}}class bf extends qo{static create(t){return new bf(t)}constructor(t){super("autoDetectChanged"),i(this,"enableAutoDetect",void 0),this.enableAutoDetect=t;}}class Sf extends qo{static create(t){return new Sf(t)}constructor(t){super("autoCaptureChanged"),i(this,"enableAutoCapture",void 0),this.enableAutoCapture=t;}}class Cf extends qo{static create(t){return new Cf(t)}constructor(t){super("cameraPlayed"),i(this,"resolution",void 0),this.resolution=t;}}class Pf extends qo{static create(t){return new Pf(t)}constructor(t){super("cameraInit"),i(this,"enableConvert",void 0),this.enableConvert=t;}}class Tf extends qo{static create(t){return new Tf(t)}constructor(t){super("torchChanged"),i(this,"torchState",void 0),this.torchState=t;}}class Af extends qo{static create(t,e){return new Af(t,e)}constructor(t,e){super("annotationModeChanged"),i(this,"oldAnnotationMode",void 0),i(this,"newAnnotationMode",void 0),this.oldAnnotationMode=t,this.newAnnotationMode=e;}}class kf extends qo{static create(t){return new kf(t)}constructor(t){super("annotationLayerStateChanged"),i(this,"state",void 0),this.state=t;}}class Ef extends qo{static create(t,e){return new Ef(t,e)}constructor(t,e){super("annotationsUpdated"),i(this,"uids",void 0),i(this,"actions",void 0),this.uids=t,this.actions=e;}}class Df extends qo{static create(t,e){return new Df(t,e)}constructor(t,e){super("selectedAnnotationsChanged"),i(this,"oldAnnotationUids",void 0),i(this,"newAnnotationUids",void 0),this.oldAnnotationUids=t,this.newAnnotationUids=e;}}class Rf extends qo{static create(t,e,i){return new Rf(t,e,i)}constructor(t,e,n){super("cropPages"),i(this,"docUid",void 0),i(this,"rect",void 0),i(this,"pageUids",void 0),this.docUid=t,this.rect=e,this.pageUids=n;}}class If extends qo{static create(t,e,i,n){return new If(t,e,i,n)}constructor(t,e,n,s){super("copyPage"),i(this,"pageUid",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),i(this,"annotations",void 0),this.pageUid=t,this.fileUid=e,this.fileIndex=n,this.annotations=s;}}class Mf extends qo{static create(t,e,i,n){return new Mf(t,e,i,n)}constructor(t,e,n,s){super("pagePreloadChanged"),i(this,"docUid",void 0),i(this,"viewerUid",void 0),i(this,"viewerMode",void 0),i(this,"changes",void 0),this.docUid=t,this.viewerUid=e,this.viewerMode=n,this.changes=s;}}class Bf extends qo{static create(t){return new Bf(t)}constructor(t){super("pageExistenceChanged"),i(this,"pageCount",void 0),this.pageCount=t;}}class Uf extends qo{static create(t,e){return new Uf(t,e)}constructor(t,e){super("deletePages"),i(this,"pageUids",void 0),i(this,"docUid",void 0),this.pageUids=t,this.docUid=e;}}class Lf extends qo{static create(t,e,i){return new Lf(t,e,i)}constructor(t,e,n){super("rotatePages"),i(this,"docUid",void 0),i(this,"angle",void 0),i(this,"pageUids",void 0),this.docUid=t,this.angle=e,this.pageUids=n;}}class Of extends qo{static create(t,e,i,n){return new Of(t,e,i,n)}constructor(t,e,n,s){super("selectPages"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"indices",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=n,this.indices=s;}}class Wf extends qo{static create(t,e){return new Wf(t,e)}constructor(t,e){super("reorderPages"),i(this,"docUid",void 0),i(this,"indices",void 0),this.docUid=t,this.indices=e;}}class Nf extends qo{static create(t,e,i){return new Nf(t,e,i)}constructor(t,e,n){super("switchPage"),i(this,"docUid",void 0),i(this,"one",void 0),i(this,"another",void 0),this.docUid=t,this.one=e,this.another=n;}}class _f extends qo{static create(t,e,i){return new _f(t,e,i)}constructor(t,e,n){super("createPage"),i(this,"pageUid",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),this.pageUid=t,this.fileUid=e,this.fileIndex=n;}}class Ff extends qo{static create(t,e){return new Ff(t,e)}constructor(t,e){super("pageRendered"),i(this,"index",void 0),i(this,"pageUid",void 0),this.index=t,this.pageUid=e;}}class Hf extends qo{static create(t,e){return new Hf(t,e)}constructor(t,e){super("pagesDragged"),i(this,"indices",void 0),i(this,"pageUids",void 0),this.indices=t,this.pageUids=e;}}class Vf extends qo{static create(t,e,i){return new Vf(t,e,i)}constructor(t,e,n){super("pagesDropped"),i(this,"indicesBefore",void 0),i(this,"indicesAfter",void 0),i(this,"pageUids",void 0),this.indicesBefore=t,this.indicesAfter=e,this.pageUids=n;}}class zf extends qo{static create(t,e,i,n){return new zf(t,e,i,n)}constructor(t,e,n,s){super("selectedPagesChanged"),i(this,"oldIndices",void 0),i(this,"newIndices",void 0),i(this,"oldPageUids",void 0),i(this,"newPageUids",void 0),this.oldIndices=t,this.newIndices=e,this.oldPageUids=n,this.newPageUids=s;}}class $f extends qo{static create(t,e,i){return new $f(t,e,i)}constructor(t,e,n){super("pagesAdded"),i(this,"docUid",void 0),i(this,"indices",void 0),i(this,"pageUids",void 0),this.docUid=t,this.indices=e,this.pageUids=n;}}class jf extends qo{static create(t,e,i){return new jf(t,e,i)}constructor(t,e,n){super("pagesDeleted"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"indices",void 0),this.docUid=t,this.pageUids=e,this.indices=n;}}class Xf extends qo{static create(t,e,i,n){return new Xf(t,e,i,n)}constructor(t,e,n,s){super("addPagesToDoc"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"indices",void 0),i(this,"index",void 0),this.docUid=t,this.pageUids=e,this.indices=n,this.index=s;}}class Gf extends qo{static create(t,e,i){return new Gf(t,e,i)}constructor(t,e,n){super("updatePage"),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"data",void 0),this.docUid=t,this.pageUid=e,this.data=n;}}class Yf extends qo{static create(t,e,i){return new Yf(t,e,i)}constructor(t,e,n){super("movePages"),i(this,"docUid",void 0),i(this,"indices",void 0),i(this,"insertBeforeIndex",void 0),this.docUid=t,this.indices=e,this.insertBeforeIndex=n;}}let qf=0;const Jf=()=>{const t=`doc-${Date.now().toString()}-${qf.toString()}`;return qf+=1,t};function Zf(t){t||(t=`D:${Fn("yyyyMMddhhmmss")}`);if(/[+-]\d{2}'\d{2}'$/.test(t))return t;const e=-(new Date).getTimezoneOffset();return `${t}${e>=0?"+":"-"}${String(Math.floor(Math.abs(e)/60)).padStart(2,"0")}'${String(Math.abs(e)%60).padStart(2,"0")}'`}class Qf{constructor(){var t,e;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"type",void 0),i(this,"uid",void 0),i(this,"name",void 0),i(this,"pages",void 0),i(this,"tags",void 0),i(this,"creationDate",void 0),i(this,"author",void 0),i(this,"isDestroyed",void 0),i(this,"pageSize",void 0),this.uid=Jn(),this.name=null!==(t=n.name)&&void 0!==t?t:Jf(),this.type=n.type||"document",this.pages=[],this.tags=n.tags||[],this.creationDate=Zf(n.creationDate),this.author=null!==(e=n.author)&&void 0!==e?e:"",this.pageSize="none";}dispose(){this.isDestroyed=!0;}}class Kf{constructor(){i(this,"users",void 0),this.users=[];}addUser(t){this.users.push(t);}deleteUser(t){const e=this.users.indexOf(t);e>-1&&this.users.splice(e,1);}}var tv;!function(t){t.IMAGE_PNG="image/png",t.IMAGE_JPEG="image/jpeg",t.IMAGE_BMP="image/bmp",t.IMAGE_TIFF="image/tiff",t.IMAGE_JP2="image/jp2",t.APPLICATION_PDF="application/pdf";}(tv||(tv={}));class ev{constructor(t){let{uid:e,mime:n,pageCount:s}=t;i(this,"uid",void 0),i(this,"mime",void 0),i(this,"pageCount",void 0),i(this,"name",void 0),i(this,"count",void 0),i(this,"pages",void 0),this.uid=e,this.mime=n,this.count=0,this.pages=[],this.pageCount=s;for(let t=0;t<s;t++){const t=new Kf;this.pages.push(t);}}getPageByIndex(t){return this.pages[t]}addUser(t,e){const i=this.pages[t];return !!i&&(i.addUser(e),this.count+=1,!0)}deleteUser(t,e){const i=this.pages[t];return !!i&&(i.deleteUser(e),this.count-=1,!0)}}function iv(t,e,i,n){if(0===(e=(e%360+360)%360))return t;const s=e/90;for(let e=0;e<4;e++){const o=t[2*e],r=t[2*e+1];1===s?(t[2*e]=r,t[2*e+1]=n-o):2===s?(t[2*e]=i-o,t[2*e+1]=n-r):3===s&&(t[2*e]=i-r,t[2*e+1]=o);}return ov(t,8-2*s),t}function nv(t,e,i,n){if(0===(e=(e%360+360)%360))return t;const s=e/90;for(let e=0;e<4;e++){const o=t[2*e],r=t[2*e+1];1===s?(t[2*e]=n-r,t[2*e+1]=o):2===s?(t[2*e]=i-o,t[2*e+1]=n-r):3===s&&(t[2*e]=r,t[2*e+1]=i-o);}return ov(t,2*s),t}function sv(t,e,i){for(;e<i;){const n=t[e];t[e]=t[i],t[i]=n,e+=1,i-=1;}}function ov(t,e){const i=e%t.length;0!==i&&(sv(t,0,t.length-1),sv(t,0,i-1),sv(t,i,t.length-1));}const rv=t=>Array(4).fill(0).map(((e,i)=>[t[2*i],t[2*i+1]])),av=(t,e,i)=>0===t[0][0]&&0===t[0][1]&&t[1][0]===e&&0===t[1][1]&&t[2][0]===e&&t[2][1]===i&&0===t[3][0]&&t[3][1]===i;class lv{constructor(t){i(this,"data",void 0),i(this,"width",void 0),i(this,"height",void 0),i(this,"url",void 0),i(this,"img",void 0),i(this,"users",void 0),i(this,"isDestroyed",void 0),i(this,"isAvailable",void 0),i(this,"pageWidth",void 0),i(this,"pageHeight",void 0),i(this,"docPage",void 0),this.isDestroyed=!1,this.users=[],this.isAvailable=!1,this.docPage=t;}getImageDetail(){const{docPage:t}=this;return {data:this.data,width:this.width,height:this.height,pageWidth:this.pageWidth,pageHeight:this.pageHeight,resolutionX:t.resolutionX,resolutionY:t.resolutionY,url:this.url,img:this.img}}getPageSize(){return {width:this.pageWidth,height:this.pageHeight}}updateImageDetail(t){if(!t)return;t.data&&(this.isAvailable=!0,this.data=t.data);const{docPage:e}=this;this.width=t.width,this.height=t.height,this.pageWidth=t.width/e.resolutionX*ko.displayResolution,this.pageHeight=t.height/e.resolutionY*ko.displayResolution;}addUser(t){this.getUserIndex(t)<0&&this.users.push(t);}deleteUser(t){const e=this.getUserIndex(t);e>-1&&this.users.splice(e,1);}hasUser(){return !!this.users.length}reset(){this.resetBlob(),this.resetImg();}resetBlob(){this.isAvailable=!1,this.data=null,this.url&&URL.revokeObjectURL(this.url),this.url=null;}resetImg(){this.img&&(this.img.src&&URL.revokeObjectURL(this.img.src),this.img.src=""),this.img=null;}getUserIndex(t){return this.users.findIndex((e=>{let{viewerUid:i,docUid:n,pageUid:s}=e;return i===t.viewerUid&&n===t.docUid&&s===t.pageUid}))}dispose(){this.isDestroyed=!0,this.isAvailable=!1,this.reset();}}function hv(t){const e=function(t){const e=[...t];e.sort(((t,e)=>e[1]-t[1]));let i=Number.MAX_SAFE_INTEGER,n=0;t.forEach(((t,e)=>{t[1]<i&&([,i]=t,n=e);}));const s=(n+3)%4,o=(n+1)%4,r=cv(t[s],t[n]),a=cv(t[o],t[n]);if(a>r)return s;return n}(t),i=t.map(((e,i)=>{let n=t[i+1];return 3===i&&([n]=t),dv(n,e)}));let n=Math.max(i[e],i[(e+2)%4]),s=Math.max(i[(e+1)%4],i[(e+3)%4]);return n=Math.round(n),s=Math.round(s),{width:n,height:s}}function cv(t,e){const i=Math.abs(t[0]-e[0]),n=dv(t,e);return Math.acos(i/n)}function dv(t,e){return ((t[0]-e[0])**2+(t[1]-e[1])**2)**.5}const uv=t=>{if(!t)return;t.forEach((t=>{const e=Math.ceil(t[0]);e-t[0]<=1e-7?t[0]=e:t[0]=Math.floor(t[0]);const i=Math.ceil(t[1]);i-t[1]<=1e-7?t[1]=i:t[1]=Math.floor(t[1]);}));};function pv(t,e,i,n){e=(e%360+360)%360;const s={...t},{left:o,top:r,width:a,height:l}=t,h=Math.floor(e/90);return 1===h?(s.left=n-r-l,s.top=o):2===h?(s.left=i-o-a,s.top=n-r-l):3===h&&(s.left=r,s.top=i-o-a),h%2>0&&(s.width=l,s.height=a),s}function gv(t,e){return t.left<e.left+e.width&&t.left+t.width>e.left&&t.top<e.top+e.height&&t.top+t.height>e.top}function fv(t,e){return t.x>=e.left&&t.x<=e.left+e.width&&t.y>=e.top&&t.y<=e.top+e.height}var vv;!function(t){t.NONE="none",t.LTR="ltr",t.RTL="rtl",t.TTB="ttb",t.BTT="btt";}(vv||(vv={}));class mv{constructor(t,e){let{fileIndex:n,pageUid:s,fileUid:o,rotation:r,filter:a,perspectiveQuad:l,annotations:h,pdfOptions:c,resource:d,cropBox:u,mediaBox:p,pageSize:g}=t;i(this,"uid",void 0),i(this,"doc",void 0),i(this,"metadata",void 0),i(this,"customData",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),i(this,"resolutionX",void 0),i(this,"resolutionY",void 0),i(this,"filter",void 0),i(this,"rotation",void 0),i(this,"quad",void 0),i(this,"activeQuad",void 0),i(this,"isFull",void 0),i(this,"raw",void 0),i(this,"original",void 0),i(this,"display",void 0),i(this,"thumbnail",void 0),i(this,"editedDisplay",void 0),i(this,"initRotation",void 0),i(this,"editRotation",void 0),i(this,"actionRotation",void 0),i(this,"actions",void 0),i(this,"pActions",void 0),i(this,"actionResult",void 0),i(this,"pActionResult",void 0),i(this,"isDestroyed",void 0),i(this,"annotations",void 0),i(this,"pageSize",void 0),i(this,"cropBox",void 0),i(this,"mediaBox",void 0),i(this,"resource",void 0),i(this,"editCaches",void 0),i(this,"pdfOptions",void 0),i(this,"initState",void 0),i(this,"oriTexts",void 0),i(this,"parsedTexts",void 0),i(this,"oriTextSegments",void 0),i(this,"visibleLines",void 0),i(this,"lines",[]),i(this,"textBlocks",void 0),i(this,"textRect",void 0),i(this,"curTextRect",void 0),i(this,"textStr",void 0),i(this,"textStrWithoutWrap",void 0),i(this,"textStrInSearch",void 0),i(this,"isTextPage",!0),i(this,"isUpdated",!1),this.uid=s,this.doc=e,this.annotations=h||[],this.resolutionX=d.resolutionX,this.resolutionY=d.resolutionY,this.fileIndex=n,this.fileUid=o,this.pageSize=null!=g?g:"none",this.resource=d,"none"===this.pageSize?(this.mediaBox={...p},this.cropBox={...u}):this.pageSize,this.filter=a,this.rotation=r||0,this.initRotation=r||0,this.editRotation=r||0,this.actionRotation=0,this.isFull=!0,this.pdfOptions=c,this.raw=new lv(this),this.original=new lv(this),this.display=new lv(this),this.thumbnail=new lv(this),this.editedDisplay=new lv(this);let f={width:d.width,height:d.height};if(this.raw.updateImageDetail(f),this.initState={mediaBox:this.mediaBox,cropBox:this.cropBox,rotation:r},l){f=hv(l),this.mediaBox={left:0,top:0,width:Hs(f.width,d.resolutionX,ko.displayResolution),height:Hs(f.height,d.resolutionY,ko.displayResolution)},this.cropBox={...this.mediaBox};const t=this.quadToDisplayPPI(l);this.setQuad(t);}this.original.updateImageDetail(f),this.display.updateImageDetail(f),this.actions=[],this.pActions=[],this.actionResult=new Map,this.pActionResult=new Map;}textStyleEqual(t,e){if(!t||!e)return !1;return Math.abs(Math.abs(t.fontSize)-Math.abs(e.fontSize))<1e-4&&t.fontName===e.fontName&&t.fontWeight===e.fontWeight&&t.renderMode===e.renderMode&&t.fillColor[0]===e.fillColor[0]&&t.fillColor[1]===e.fillColor[1]&&t.fillColor[2]===e.fillColor[2]&&t.fillColor[3]===e.fillColor[3]&&t.strokeColor[0]===e.strokeColor[0]&&t.strokeColor[1]===e.strokeColor[1]&&t.strokeColor[2]===e.strokeColor[2]&&t.strokeColor[3]===e.strokeColor[3]&&t.isItalic===e.isItalic&&t.isBold===e.isBold}isUnicodeWhiteSpace(t){return -1!==[...[...[9,11,12,32,10,13],133,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8232,8233,8239,8287,12288],0].indexOf(t)}getDirectionFromAngle(t){const e=Math.PI/4,i=Math.PI/2,n=Math.PI,s=Math.PI/2*3,o=(t+e)%(2*Math.PI);return o>=0&&o<=i?vv.LTR:o>i&&o<=n?vv.TTB:o>n&&o<=s?vv.RTL:vv.BTT}getAngleFromCharBox(t,e){const i=t.left+t.width/2,n=t.top+t.height/2,s=e.left+e.width/2,o=e.top+e.height/2;let r=Math.atan2(o-n,s-i);return r<0&&(r+=2*Math.PI),r}setParsedTexts(t){if(null===t)return void(this.isTextPage=!1);if(this.visibleLines)return;const e=t.charInfos;this.oriTexts=Nn(e);const{top:i,height:n}=this.mediaBox,s=[];let o=0,r=null,a=-1;const l=[],h=[];e.forEach(((e,c)=>{const d=Hs(e.looseCharBox,72,ko.displayResolution),u=d[0],p=d[2],g=i+n-d[3],f=i+n-d[1],v={indexWithoutWrap:o,indexWithWrap:c,oriIndex:c,unicode:e.unicode,charBox:{left:u,top:g,width:p-u,height:f-g},objId:e.objId};if(s.push(v),this.isUnicodeWhiteSpace(v.unicode))l.length>0&&(13!==e.unicode&&10!==e.unicode&&(l[l.length-1].isWrap?h.push(v):(o+=1,l[l.length-1].chars.push(v))),10===e.unicode&&(l[l.length-1].isWrap=!0));else {let i=!1;if(r===e.objId||this.textStyleEqual(t.textStyleInfos[r],t.textStyleInfos[e.objId]))if(l[l.length-1].charDirection!==this.getDirectionFromAngle(e.angle))i=!0;else {const t=this.getAngleFromCharBox(l[l.length-1].chars[a].charBox,v.charBox);if(a>0){const e=this.getAngleFromCharBox(l[l.length-1].chars[0].charBox,l[l.length-1].chars[a].charBox);l[l.length-1].direction===vv.NONE&&(l[l.length-1].direction=this.getDirectionFromAngle(e));const n=Math.PI,s=2*Math.PI;let o=Math.abs(t-e)%s;o=o>n?s-o:o,o>Math.PI/2&&(i=!0);}if(!i){Math.sqrt((v.charBox.left-l[l.length-1].chars[a].charBox.left)**2+(v.charBox.top-l[l.length-1].chars[a].charBox.top)**2)>2.5*(Math.abs(Math.cos(t))*l[l.length-1].avgCharSize.width+Math.abs(Math.sin(t))*l[l.length-1].avgCharSize.height)&&(i=!0);}}else i=!0;if(i)if(2===v.unicode);else {o+=1;let i=0;t.textStyleInfos[e.objId]&&(i=Hs(t.textStyleInfos[e.objId].fontSize,72,ko.displayResolution)/3);let n={width:i,height:i},s=1;v.charBox.width>0&&v.charBox.height>0&&(n={width:(n.width*s+v.charBox.width)/(s+1),height:(n.height*s+v.charBox.height)/(s+1)},s+=1),l.push({chars:[v],isWrap:!1,charDirection:this.getDirectionFromAngle(e.angle),direction:vv.NONE,avgCharSize:n,nonWhitespaceCharsCount:s,textStyle:t.textStyleInfos[e.objId]}),h.splice(0,h.length),a=0;}else l[l.length-1].isWrap&&(l[l.length-1].isWrap=!1,h.forEach((t=>{o+=1,l[l.length-1].chars.push(t);})),h.splice(0,h.length)),o+=1,l[l.length-1].avgCharSize={width:(l[l.length-1].avgCharSize.width*l[l.length-1].nonWhitespaceCharsCount+v.charBox.width)/(l[l.length-1].nonWhitespaceCharsCount+1),height:(l[l.length-1].avgCharSize.height*l[l.length-1].nonWhitespaceCharsCount+v.charBox.height)/(l[l.length-1].nonWhitespaceCharsCount+1)},l[l.length-1].nonWhitespaceCharsCount+=1,l[l.length-1].chars.push(v),a=l[l.length-1].chars.length-1;r=e.objId;}})),this.parsedTexts=s,this.oriTextSegments=l,this.lines=l.map((t=>{const e=yv(t.chars.map((t=>t.charBox)));return {...e,isRow:e.width>e.height,chars:t.chars,right:e.left+e.width,bottom:e.top+e.height,startIndex:0,endIndex:t.chars.length-1,visibleRect:e,isWrap:t.isWrap}})),this.lines.length&&this.handleCropBoxForText();}handleCropBoxForText(){const{cropBox:t}=this;this.visibleLines=this.lines.filter((e=>gv(e,t))),this.visibleLines.forEach((e=>{e.startIndex=e.chars.findIndex((e=>gv(e.charBox,t))),e.endIndex=-1;for(let i=e.chars.length-1;i>=0;i--)if(gv(e.chars[i].charBox,t)){e.endIndex=i;break}const i=e.chars.slice(e.startIndex,e.endIndex+1).map((t=>t.charBox));e.visibleRect=yv(i);}));let e="",i="",n="",s=-1,o=-1,r=-1;this.visibleLines.forEach(((t,a)=>{t.chars.slice(t.startIndex,t.endIndex+1).forEach((t=>{e+=String.fromCharCode(t.unicode),i+=String.fromCharCode(t.unicode),2!==t.unicode&&(n+=String.fromCharCode(t.unicode),r+=1),s+=1,o+=1,t.indexWithWrap=s,t.indexWithoutWrap=o,t.indexInSearch=r;})),t.isWrap&&(e+="\r\n",s+=2,n+=" ",r+=1);})),this.textStr=e,this.textStrWithoutWrap=i,this.textStrInSearch=n;const a=[];let l=this.visibleLines[0],h={lines:[{index:0,line:l}],...l};a.push(h);for(let t=1;t<this.visibleLines.length;t++){const e=this.visibleLines[t],{visibleRect:i}=e;let n=!1;if(n=e.isRow!==l.isRow||(l.isRow?i.left>h.right||i.left+i.width<h.left:i.top>h.bottom||i.top+i.height<h.top),n)h={lines:[{index:t,line:e}],...e,...i,right:i.left+i.width,bottom:i.top+i.height},a.push(h);else {h.lines.push({index:t,line:e});const i=yv([e,h]);Object.assign(h,i),h.right=h.left+h.width,h.bottom=h.top+h.height;}l=e;}this.textBlocks=a,this.textRect=yv(a);}getHoveredTextLine(t){if(!this.visibleLines)return -1;return this.visibleLines.findIndex((e=>fv(t,e.visibleRect)))}getSelectedTextLineIndex(t,e){const{x:i,y:n}=e;{let t=-1,s=Number.MAX_VALUE;for(let o=0;o<this.visibleLines.length;o++){const r=this.visibleLines[o];for(let a=r.startIndex;a<=r.endIndex;a++){const{charBox:l}=r.chars[a];if(fv(e,l))return o;const h=Math.min(Math.abs(l.top-n),Math.abs(l.top+l.height-n))+Math.min(Math.abs(l.left-i),Math.abs(l.left+l.width-i));h<s&&(s=h,t=o);}}return t}}getSelectedTextCharIndex(t,e){if(!this.visibleLines)return -1;let i=-1;const n=this.visibleLines[t];let s=1/0,o=-1;for(let t=n.startIndex;t<=n.endIndex;t++){const{charBox:r}=n.chars[t];if(fv(e,r)){i=t;break}{let i=0;i=n.isRow?Math.min(Math.abs(r.left-e.x),Math.abs(r.left+r.width-e.x)):Math.min(Math.abs(r.top+r.height-e.y),Math.abs(r.top-e.y)),i<s&&(s=i,o=t);}}return -1===i&&(i=o),i}getSelectedTextWord(t,e){const i=this.visibleLines[t],n=this.getSelectedTextCharIndex(t,e),{startIndex:s,endIndex:o}=i;let r=n,a=n;if(32===i.chars[n].unicode)return null;if(this.isMultipleClickBoundarySelf(i.chars[n].unicode))return {start:{lineIndex:t,charIndex:n},end:{lineIndex:t,charIndex:n}};for(let t=n;t>=s;t--){if(this.isMultipleClickBoundary(i.chars[t].unicode)){r=t+1,t===a&&(r=t);break}r=t;}for(let t=n;t<=o;t++){if(this.isMultipleClickBoundary(i.chars[t].unicode)){a=t-1,t===r&&(a=t);break}a=t;}return {start:{lineIndex:t,charIndex:r},end:{lineIndex:t,charIndex:a}}}isMultipleClickBoundary(t){return !(t>=48&&t<=57)&&(!(t>=65&&t<=90)&&(!(t>=97&&t<=122)&&(95!==t&&t<128)))}isMultipleClickBoundarySelf(t){return !(t>=48&&t<=57)&&(!(t>=65&&t<=90)&&(!(t>=97&&t<=122)&&(95!==t&&(32!==t&&t<128))))}getSelectedTextSegment(t,e){let i=0,n=this.visibleLines.length-1;for(let e=t-1;e>=0;e--)if(this.visibleLines[e].isWrap){i=e+1;break}for(let e=t;e<this.visibleLines.length;e++)if(this.visibleLines[e].isWrap){n=e;break}return {start:{lineIndex:i,charIndex:this.visibleLines[n].startIndex},end:{lineIndex:n,charIndex:this.visibleLines[n].endIndex}}}getSelectedTextLine(t,e,i){const n=this.visibleLines[t];let s,o=[],r=!0;if(void 0===e&&void 0===i)s={...n.visibleRect},o=n.chars.slice(n.startIndex,n.endIndex+1);else {s=yv(n.chars.slice(e,i+1).map((t=>t.charBox))),o=n.chars.slice(e,i+1),i!==n.endIndex&&(r=!1);}let a=o.map((t=>2===t.unicode?"":String.fromCharCode(t.unicode))).join("");return n.isWrap&&r&&(a+="\r\n"),{...n,selectedRect:s,text:a}}rectUnion(t,e){const i=Math.min(t.left,e.left),n=Math.min(t.top,e.top);return {left:i,top:n,width:Math.max(t.left+t.width,e.left+e.width)-i,height:Math.max(t.top+t.height,e.top+e.height)-n}}rectIntersection(t,e){const i=Math.max(t.left,e.left),n=Math.max(t.top,e.top),s=Math.min(t.left+t.width,e.left+e.width),o=Math.min(t.top+t.height,e.top+e.height);return {left:i,top:n,width:s>i?s-i:0,height:o>n?o-n:0}}getVerticalOverlap(t,e){const i=this.rectUnion(t,e),n=1e-6;if(Math.abs(i.height-t.height)<n||Math.abs(i.height-e.height)<n)return 1;return this.rectIntersection(t,e).height/i.height}shouldMergeHorizonLines(t,e){if(0!==e.startIndex)return !1;const i=t.selectedRect,n=e.selectedRect;if(this.getVerticalOverlap(i,n)<.7)return !1;const s=i.width/(t.endIndex-t.startIndex+1)*1,o=n.width/(e.endIndex-e.startIndex+1)*1,r=i.left-s,a=i.left+i.width+s,l=n.left-o;return r<n.left+n.width+o&&a>l}mergeAdjacentLines(t){const e=[];let i=null;for(let n=0;n<t.length;n++){const s=t[n];i?this.shouldMergeHorizonLines(i,s)?(i.chars.push(...s.chars),i.text+=s.text,i.endIndex+=s.endIndex+1,i.selectedRect=this.rectUnion(i.selectedRect,s.selectedRect),i.visibleRect=this.rectUnion(i.visibleRect,s.visibleRect),i.left=i.visibleRect.left,i.top=i.visibleRect.top,i.width=i.visibleRect.width,i.height=i.visibleRect.height,i.right=i.visibleRect.left+i.visibleRect.width,i.bottom=i.visibleRect.top+i.visibleRect.height):(e.push(i),i=Nn(s)):i=Nn(s);}return i&&e.push(i),e}doMergeAdjacentLines(t){let e=this.mergeAdjacentLines(t);for(;;){const t=this.mergeAdjacentLines(e);if(t.length===e.length)break;e=t;}return e}getSelectedTextLines(t,e){const i=[];for(let n=t.lineIndex;n<=e.lineIndex;n++){const s=this.visibleLines[n];let o=s.startIndex,r=s.endIndex;n===t.lineIndex&&void 0!==t.charIndex&&(o=t.charIndex),n===e.lineIndex&&void 0!==e.charIndex&&(r=e.charIndex);const a=this.getSelectedTextLine(n,o,r);i.push(a);}return this.doMergeAdjacentLines(i)}getSelectedTextsStr(t,e,i){let n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=this.visibleLines[t];let o=[];void 0===e&&void 0===i?o=s.chars.slice(s.startIndex,s.endIndex+1):(o=s.chars.slice(e,i+1),i!==s.endIndex&&(n=!1));let r=o.map((t=>2===t.unicode?"":String.fromCharCode(t.unicode))).join("");return s.isWrap&&n&&(r+="\r\n"),r}getEndCharRect(t,e){const i=this.visibleLines[t].chars[e].charBox;return {...i,top:i.top,height:i.height}}getSearchedText(t){var e;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:50;if(this.isDestroyed||null===(e=this.visibleLines)||void 0===e||!e.length)return [];const o=[];let r,a=0;for(;null!==r;)if(r=t.exec(this.textStrInSearch),null!==r){let t=r[0],e=r.index;if(i){const[,i,n]=r;t=n,e=r.index+i.length;}let l=-1,h=this.visibleLines.findIndex((t=>(l=t.chars.slice(t.startIndex,t.endIndex+1).findIndex((t=>t.indexInSearch===e)),l>-1)));-1===h&&(h=this.visibleLines.findIndex((t=>(l=t.chars.slice(t.startIndex,t.endIndex+1).findIndex((t=>t.indexInSearch===e+1)),l>-1))));let c=-1,d=this.visibleLines.findIndex((i=>(c=i.chars.slice(i.startIndex,i.endIndex+1).findIndex((i=>i.indexInSearch===e+t.length-1)),c>-1)));if(-1===d&&t.length>1&&(d=this.visibleLines.findIndex((i=>(c=i.chars.slice(i.startIndex,i.endIndex+1).findIndex((i=>i.indexInSearch===e+t.length-2)),c>-1)))),-1===l||-1===c)continue;const u=this.getSelectedTextLines({lineIndex:h,charIndex:l+this.visibleLines[h].startIndex},{lineIndex:d,charIndex:c+this.visibleLines[d].startIndex}),p=[];for(let t=0;t<u.length;t++){const e=u[t];p.push({lineIndex:h,text:e.text,box:{...e.selectedRect}});}o.push({textUid:`${this.uid}_${a}`,pageUid:this.uid,text:t,context:this.textStrInSearch.substring(Math.max(e-n,0),Math.min(e+t.length+s,this.textStrInSearch.length)),startIndex:Math.min(e,n),lines:p}),a+=1;}return o}getHitSearchTextInfo(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=-1,n=-1;return {lineIndex:this.visibleLines.findIndex((s=>(i=s.chars.findIndex((i=>{let s=i.indexWithoutWrap;return e&&(s=i.indexWithWrap),s===t&&(n=i.oriIndex,!0)})),i>-1))),charIndex:i,oriIndex:n}}getHitSearchTextLines(t,e){const i=[];return t.forEach(((t,n)=>{const s=this.getSearchTextLine(t.lineIndex,t.charIndex,e),{charIndex:o}=t,r={lines:s,startIndex:o};i.push(r);})),i}getSearchTextLine(t,e,i){const n={lineIndex:t,charIndex:e},s=[];let o=this.visibleLines.length-1,r=this.visibleLines[o].endIndex;for(let n=t;n<this.visibleLines.length&&i>0;n++){const t=this.visibleLines[n].endIndex-e+1;if(t>=i){o=n,r=e+i-1;break}i-=t,e=0;}const a={lineIndex:o,charIndex:r},l=this.getSelectedTextLines(n,a);for(let e=0;e<l.length;e++){const i=l[e];s.push({lineIndex:t,text:i.text,box:{...i.selectedRect}});}return s}isMediaBoxEqualCropBox(){const{mediaBox:t,cropBox:e}=this;return t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height}getPageSize(){return "inherit"===this.pageSize?this.doc.pageSize:this.pageSize}copy(t,e){const i=new mv({pageSize:this.getPageSize(),fileIndex:this.fileIndex,pageUid:t,fileUid:this.fileUid,rotation:this.rotation,filter:this.filter,pdfOptions:this.pdfOptions&&Nn(this.pdfOptions),mediaBox:Nn(this.mediaBox),cropBox:Nn(this.cropBox),resource:Nn(this.resource),annotations:[]},e),n=Nn(this.actions);n.forEach((t=>{t.docUid=e.uid;}));const s=Nn(this.pActions);s.forEach((t=>{t.docUid=e.uid;})),i.actions=n,i.pActions=s,i.initRotation=this.initRotation,i.actionRotation=this.actionRotation,i.editRotation=this.editRotation,i.quad=Nn(this.quad),i.activeQuad=Nn(this.activeQuad),i.isFull=this.isFull,i.actionResult=new Map(this.actionResult),i.pActionResult=new Map(this.pActionResult);const o={width:this.mediaBox.width||this.display.width||i.raw.width,height:this.mediaBox.height||this.display.height||i.raw.height};return i.original.updateImageDetail(o),i.display.updateImageDetail(o),i}setQuad(t){const e=this.isQuadFull(t);let i=!1;if(this.isFull=e,e)this.quad&&(i=!0,this.editRotation=this.rotation),this.quad=null,this.activeQuad=null;else {const{width:e,height:n}=this.raw.getPageSize(),s=iv(t.flat(),this.rotation,e,n),o=rv(s);let r,a;this.quad&&(a=this.quadToPixelPPI(o),r=this.quadToPixelPPI(this.quad),uv(r),uv(a)),this.quad&&Vs(r,a)||(this.quad=o,this.activeQuad=o,i=!0),this.editRotation=this.actionRotation;}return i&&this.clearActions(),i}isQuadChanged(t){let e=!1;if(this.isQuadFull(t))this.quad&&(e=!0);else {const{width:i,height:n}=this.raw.getPageSize(),s=iv(t.flat(),this.rotation,i,n),o=rv(s);let r,a;this.quad&&(a=this.quadToPixelPPI(o),r=this.quadToPixelPPI(this.quad),uv(r),uv(a)),this.quad&&Vs(r,a)||(e=!0);}return e}setActiveQuad(t){const{width:e,height:i}=this.raw.getPageSize();if(!this.isFull){const n=iv(t.flat(),this.rotation,e,i),s=rv(n);this.activeQuad=s;}}getQuadVertices(){let t;const{width:e,height:i}=this.raw.getPageSize();return t=this.isFull?[0,0,e,0,e,i,0,i]:this.activeQuad.flat(),t=nv(t,this.rotation,e,i),t}getProcessedQuad(){if(this.quad){let{width:t,height:e}=this.raw.getPageSize(),{quad:i}=this;i=this.quad.map((t=>[this.toPixelPPI(t[0],!1),this.toPixelPPI(t[1],!0)])),t=this.toPixelPPI(t,!1),e=this.toPixelPPI(e,!0);const n=nv(i.flat(),this.initRotation,t,e);return rv(n)}return null}toggleFull(){let t=!1;return this.isFull&&this.activeQuad?(this.isFull=!1,t=!0):this.isFull||(this.isFull=!0,t=!0),t}isQuadFull(t){let{width:e,height:i}=this.raw.getPageSize();const n=Math.abs((this.rotation%360+360)%360);if(90===n||270===n){const t=e;e=i,i=t;}return av(t,e,i)}getEditResultForPixel(){const t=this.getEditResult();return {rWidth:this.toPixelPPI(t.rWidth,!1),rHeight:this.toPixelPPI(t.rHeight,!0),cropLeft:this.toPixelPPI(t.cropLeft,!1),cropTop:this.toPixelPPI(t.cropTop,!0),cropWidth:this.toPixelPPI(t.cropWidth,!1),cropHeight:this.toPixelPPI(t.cropHeight,!0),rotation:t.rotation}}getEditResult(){if(!this.actions.length){const t=pv(this.cropBox,this.rotation,this.mediaBox.width,this.mediaBox.height);return {rWidth:t.width,rHeight:t.height,cropLeft:this.cropBox.left,cropTop:this.cropBox.top,cropWidth:this.cropBox.width,cropHeight:this.cropBox.height,rotation:this.rotation,mediaBox:{...this.mediaBox},cropBox:{...this.cropBox}}}const t=this.actions[this.actions.length-1],{rotatedCropBox:e,cropBox:i,rotation:n}=this.actionResult.get(t.actionUid).to;return {rWidth:e.width,rHeight:e.height,cropLeft:i.left,cropTop:i.top,cropWidth:i.width,cropHeight:i.height,rotation:n,mediaBox:{...this.mediaBox},cropBox:{...i}}}getEditResultForPerspective(){const t=this.raw.getPageSize(),e={left:0,top:0,width:t.width,height:t.height};if(!this.pActions.length){const i=pv(e,this.rotation,e.width,e.height);return {rWidth:i.width,rHeight:i.height,cropLeft:0,cropTop:0,cropWidth:t.width,cropHeight:t.height,rotation:this.rotation,cropBox:{...e},mediaBox:e}}const i=this.pActions[this.pActions.length-1],{rotatedCropBox:n,cropBox:s,rotation:o}=this.pActionResult.get(i.actionUid).to;return {rWidth:n.width,rHeight:n.height,cropLeft:s.left,cropTop:s.top,cropWidth:s.width,cropHeight:s.height,rotation:o,mediaBox:e,cropBox:{...s}}}getActions(){return [...this.actions]}getPerspectiveActions(){return this.pActions}addAction(t){let e=null;if(this.actions.length){const t=this.actionResult.get(this.actions[this.actions.length-1].actionUid);e={mediaBox:{...t.to.mediaBox},cropBox:{...t.to.cropBox},rotation:t.to.rotation,rotatedCropBox:{...t.to.rotatedCropBox}};}else e={mediaBox:{...this.mediaBox},cropBox:{...this.cropBox},rotation:this.rotation,rotatedCropBox:{...this.cropBox}};if(this.actions.push(t),!this.actionResult.has(t.actionUid)){const i=function(t,e,i,n){let s={...t};const o=e.left+e.width,r=e.top+e.height;let a=i,l=pv(t,a,o,r);if("rotate"===n.type)a+=n.angle,l=pv(t,a,o,r);else if("crop"===n.type){const t=n.rect;l={left:t.left+l.left,top:t.top+l.top,width:t.width,height:t.height},s=function(t,e,i,n){e=(e%360+360)%360;const s={...t},{left:o,top:r,width:a,height:l}=t,h=Math.floor(e/90);return 1===h?(s.left=r,s.top=n-a-o):2===h?(s.left=i-a-o,s.top=n-l-r):3===h&&(s.left=i-l-r,s.top=o),h%2>0&&(s.width=l,s.height=a),s}(l,a,o,r);}return {rotatedCropBox:l,cropBox:s,mediaBox:e,rotation:a}}(e.cropBox,this.mediaBox,this.rotation,t);this.actionResult.set(t.actionUid,{from:e,to:i}),this.cropBox={...i.cropBox},this.mediaBox={...i.mediaBox};}if("rotate"===t.type){let e=null;const{width:i,height:n}=this.raw.getPageSize(),s={left:0,top:0,width:i,height:n};if(this.pActions.length){const t=this.pActionResult.get(this.pActions[this.pActions.length-1].actionUid);e={mediaBox:{...t.to.mediaBox},cropBox:{...t.to.cropBox},rotation:t.to.rotation,rotatedCropBox:{...t.to.rotatedCropBox}};}else e={mediaBox:{...s},cropBox:{...s},rotation:this.rotation,rotatedCropBox:{...s}};if(this.pActions.push(t),!this.pActionResult.has(t.actionUid)){const s=function(t,e,i,n){const s=i+n.angle;return {rotatedCropBox:pv(t,s,e.left+e.width,e.top+e.height),cropBox:t,mediaBox:e,rotation:s}}({left:0,top:0,width:i,height:n},{left:0,top:0,width:i,height:n},this.rotation,t);this.pActionResult.set(t.actionUid,{from:e,to:s});}this.rotation+=t.angle;}}deleteAction(t){var e,i;if((null===(e=this.actions[this.actions.length-1])||void 0===e?void 0:e.actionUid)===t){this.actions.pop();const e=this.actionResult.get(t);this.cropBox={...e.from.cropBox},this.mediaBox={...e.from.mediaBox},this.rotation=e.from.rotation,this.actionResult.delete(t);}(null===(i=this.pActions[this.pActions.length-1])||void 0===i?void 0:i.actionUid)===t&&(this.pActions.pop(),this.pActionResult.delete(t));}clearActions(){this.actions=[];}toDisplayPPI(t,e){const{resolutionX:i,resolutionY:n}=this;return e?t/n*ko.displayResolution:t/i*ko.displayResolution}toPixelPPI(t,e){const{resolutionX:i,resolutionY:n}=this;return e?t*n/ko.displayResolution:t*i/ko.displayResolution}quadToDisplayPPI(t){const e=Nn(t);for(let t=0;t<4;t++)e[t][0]=this.toDisplayPPI(e[t][0],!1),e[t][1]=this.toDisplayPPI(e[t][1],!0);return e}quadToPixelPPI(t){const e=Nn(t);for(let t=0;t<4;t++)e[t][0]=this.toPixelPPI(e[t][0],!1),e[t][1]=this.toPixelPPI(e[t][1],!0);return e}rectToDisplayPPI(t){const e={...t};return e.left=this.toDisplayPPI(t.left,!1),e.top=this.toDisplayPPI(t.top,!0),e.width=this.toDisplayPPI(t.width,!1),e.height=this.toDisplayPPI(t.height,!0),e}rectToPixelPPI(t){const e={...t};return e.left=this.toPixelPPI(t.left,!1),e.top=this.toPixelPPI(t.top,!0),e.width=this.toPixelPPI(t.width,!1),e.height=this.toPixelPPI(t.height,!0),e}dispose(){this.raw.reset(),this.original.reset(),this.display.reset(),this.thumbnail.reset(),this.isDestroyed=!0;}getAnnotationUids(){return [...this.annotations]}}function yv(t){let e=1/0,i=1/0,n=-1/0,s=-1/0;return t.forEach((t=>{t.width>0&&t.height>0&&(e=Math.min(e,t.left),i=Math.min(i,t.top),n=Math.max(n,t.left+t.width),s=Math.max(s,t.top+t.height));})),{left:e,top:i,width:n-e,height:s-i}}class xv extends js{constructor(){super(),i(this,"uid",void 0),i(this,"emitter",void 0),i(this,"repo",void 0),i(this,"onDocumentCreated",Gs(this)),i(this,"onDocumentDeleted",Gs(this)),i(this,"onDocumentRenamed",Gs(this)),i(this,"onPagesAddedOut",Gs(this)),i(this,"onAddPagesToDoc",Gs(this)),i(this,"onBeforeDeletePagesFromDoc",Gs(this)),i(this,"onDeletePagesFromDoc",Gs(this)),i(this,"onBeforeDeleteAllPagesFromDoc",Gs(this)),i(this,"onDeleteAllPagesFromDoc",Gs(this)),i(this,"onMovePages",Gs(this)),i(this,"onSwitchPage",Gs(this)),i(this,"onReorderPages",Gs(this)),i(this,"onBeforeDeleteDocs",Gs(this)),i(this,"onAfterDeleteDocs",Gs(this)),i(this,"onOpenDocument",Gs(this)),i(this,"onCloseDocument",Gs(this)),this.emitter=new Kn,this.uid=Jn(),this.repo=new Map;}dispose(){this.repo.forEach((t=>t.dispose())),this.repo.clear(),super.dispose();}reset(){this.repo.clear();}createDocument(){const t=new Qf(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});this.repo.set(t.uid,t);const e=yf.create(t.uid,t.name);return this.onDocumentCreated.emit(e),t}getDocument(t){return this.repo.get(t)}getAllDocuments(){return Array.from(this.repo.values())}renameDocument(t,e){const i=this.repo.get(t);if(!i)return !1;const n=Gg.create(t,i.name,e);return i.name=e,this.onDocumentRenamed.emit(n),!0}deleteDocuments(t){return t.forEach((t=>{const e=this.getDocument(t);e.dispose(),this.repo.delete(t);const i=yf.create(t,e.name);this.onDocumentDeleted.emit(i);})),!0}addPagesToDocument(t,e,i){const n=this.repo.get(t);if(!n)return !1;const{length:s}=e,o=[];let r=n.pages.length;Xn(i)?(n.pages.splice(i,0,...e),r=i):n.pages.push(...e);for(let t=0;t<s;t++)o.push(r+t);const a=Xf.create(t,e,o,i);return this.onAddPagesToDoc.emit(a),!0}removePagesFromDocument(t,e){const i=this.getDocument(t);if(!i)return !1;const n=e.map((t=>i.pages.indexOf(t)));e.forEach((t=>{Rs(i.pages,t);}));const s=jf.create(t,e,n);return this.onBeforeDeletePagesFromDoc.emit(s),this.onDeletePagesFromDoc.emit(s),!0}removeAllPagesFromDocument(t){const e=this.getDocument(t);if(!e)return !1;const i=[...e.pages.keys()],n=[...e.pages];e.pages.length=0;const s=jf.create(t,n,i);return this.onBeforeDeleteAllPagesFromDoc.emit(s),this.onDeleteAllPagesFromDoc.emit(s),!0}movePages(t,e,i){const n=this.repo.get(t);if(!n)return !1;Is(n.pages,e,i);const s=Yf.create(t,e,i);return this.onMovePages.emit(s),!0}swapPages(t,e,i){const n=this.repo.get(t);if(!n)return !1;Ms(n.pages,e,i);const s=Nf.create(t,e,i);return this.onSwitchPage.emit(s),!0}reorderPages(t,e){const i=this.repo.get(t);if(!i)return !1;Bs(i.pages,e);const n=Wf.create(t,e);return this.onReorderPages.emit(n),!0}}class wv{on(t,e){}emit(t){}}(new wv).on("debug",(function(){}));var bv=new WeakMap,Sv=new WeakMap,Cv=new WeakMap,Pv=new WeakMap,Tv=new WeakMap,Av=new WeakSet;class kv{constructor(t,e){v(this,Av),f(this,bv,{writable:!0,value:void 0}),f(this,Sv,{writable:!0,value:void 0}),f(this,Cv,{writable:!0,value:!1}),f(this,Pv,{writable:!0,value:void 0}),f(this,Tv,{writable:!0,value:void 0}),s(this,Sv,t),s(this,Pv,t.core),s(this,Tv,e),s(this,bv,Jn()),t.taskResponses.set(n(this,bv),this);}get uid(){return n(this,Tv)}get fileIndex(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);return p(this,Av,Ev).call(this).fileIndex}get filter(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);return p(this,Av,Ev).call(this).filter}get perspectiveQuad(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);const t=p(this,Av,Ev).call(this);let{quad:e}=t;return e&&(e=t.quadToPixelPPI(e),uv(e)),e}get rotation(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);return p(this,Av,Ev).call(this).rotation%360}get mediaBox(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);return Dv(Hs(p(this,Av,Ev).call(this).mediaBox,ko.displayResolution,ko.dataResolution),2)}get cropBox(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);return Dv(Hs(p(this,Av,Ev).call(this).cropBox,ko.displayResolution,ko.dataResolution),2)}async fileData(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED);const t=p(this,Av,Ev).call(this);if(!t)return null;const e=await n(this,Sv).core.sourceStore.get(t.fileUid);return "application/ddv-blank-image"!==e.fileData.type?e.fileData:null}async raw(){n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED),p(this,Av,Ev).call(this);const t=await n(this,Pv).imageDataService.getRaw(n(this,Tv));return {data:t.data,width:t.width,height:t.height}}async display(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED),p(this,Av,Ev).call(this),t={getPng:!1,isGetPrintPageData:!1,renderAnnotation:!1,...t};const e=await n(this,Pv).imageDataService.getEditedDisplay(n(this,Tv),t.renderAnnotation,t.isGetPrintPageData,t.getPng);return {data:null==e?void 0:e.data,width:null==e?void 0:e.width,height:null==e?void 0:e.height}}async thumbnail(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,Cv)&&Du.throw(Du.PAGEDATA_DESTROYED),p(this,Av,Ev).call(this),t={getPng:!1,isGetPrintPageData:!1,renderAnnotation:!1,...t};const e=await n(this,Pv).imageDataService.getEditedDisplay(n(this,Tv),t.renderAnnotation,t.isGetPrintPageData,t.getPng);return {data:e.data,width:e.width,height:e.height}}destroy(){n(this,Sv).deleteResponse(n(this,bv)),s(this,Sv,null),s(this,Cv,!0);}}function Ev(){const t=n(this,Pv).pageService.getPage(n(this,Tv));return t||Du.throw(Du.PAGE_DESTROYED),t}function Dv(t,e){let i=!0;const n=zs(t.left,e),s=zs(t.top,e),o=zs(t.width,e),r=zs(t.height,e),a=1e-7;return (Math.abs(n-t.left)>a||Math.abs(s-t.top)>a||Math.abs(o-t.width)>a||Math.abs(r-t.height)>a)&&(i=!1),i?{left:n,top:s,width:o,height:r}:t}class Rv extends js{constructor(t){super(),i(this,"core",void 0),i(this,"taskResponses",new Map),this.core=t,this.listenEvents();}listenEvents(){}requestPageData(t){this.core.pageService.getPage(t);return new kv(this,t)}deleteResponse(t){this.taskResponses.delete(t);}dispose(){this.taskResponses.forEach((t=>{t.destroy();})),this.taskResponses=null,super.dispose();}}class Iv{constructor(t){i(this,"undoStack",void 0),i(this,"redoStack",void 0),i(this,"maxTimes",void 0),this.maxTimes=t||100,this.undoStack=[],this.redoStack=[];}getOperation(){return {undo:this.undoStack.length,redo:this.redoStack.length}}execute(t){return !!t.execute()&&(this.undoStack.push(t),this.checkMaxSize(this.undoStack),this.redoStack.length>0&&(this.redoStack.forEach((t=>{t.dispose();})),this.redoStack.length=0),!0)}undo(){const t=this.undoStack.pop();return t&&(t.undo(),this.redoStack.push(t),this.checkMaxSize(this.undoStack)),!!t}redo(){const t=this.redoStack.pop();return t&&(t.execute(),this.undoStack.push(t),this.checkMaxSize(this.undoStack)),!!t}checkMaxSize(t){if(t.length>this.maxTimes){var e;null===(e=t.splice(0,1)[0])||void 0===e||e.dispose();}}removeUidsFromCommand(t){this.removeFromStack(this.undoStack,t),this.removeFromStack(this.redoStack,t);}removeFromStack(t,e){t.slice().forEach((e=>{if(!e.isValid){const i=t.indexOf(e);t.splice(i,1),e.dispose();}}));}reset(){this.undoStack.forEach((t=>{t.dispose();})),this.redoStack.forEach((t=>{t.dispose();})),this.undoStack=[],this.redoStack=[];}}class Mv extends js{constructor(){super(),i(this,"invokers",void 0),i(this,"onOperationsChanged",Gs(this)),i(this,"onBeforeRefreshCommands",Gs(this)),i(this,"onRefreshCommands",Gs(this)),i(this,"maxUndoRedoTimes",void 0),this.invokers=new Map,this.maxUndoRedoTimes=100;}setMaxUndoRedoTimes(t){this.maxUndoRedoTimes=t,this.invokers.forEach((e=>{e.maxTimes=t;}));}createInvoker(t){if(!this.invokers.has(t)){const e=new Iv(this.maxUndoRedoTimes);this.invokers.set(t,e);}}deleteInvokers(t){t.forEach((t=>{if(this.invokers.has(t)){const e=this.invokers.get(t);null==e||e.reset(),this.invokers.delete(t);}}));}execute(t,e){const i=this.invokers.get(e);!(null==i||!i.execute(t))&&this.emitOperationsChanged(e);}undo(t){const e=this.invokers.get(t),i=!(null==e||!e.undo());return i&&this.emitOperationsChanged(t),i}redo(t){const e=this.invokers.get(t),i=!(null==e||!e.redo());return i&&this.emitOperationsChanged(t),i}saveOperations(t){const e=this.invokers.get(t);return !!e&&(e.reset(),this.emitOperationsChanged(t),!0)}getOperationState(t){return this.invokers.get(t).getOperation()}removePageFromCommand(t,e){this.onBeforeRefreshCommands.emit({docUid:t,pageUids:e});this.invokers.get(t).removeUidsFromCommand(e),this.emitOperationsChanged(t);}emitOperationsChanged(t){const e=this.invokers.get(t);let i=0,n=0;if(e){const t=e.getOperation();i=t.undo,n=t.redo;}const s=nf.create(t,i,n);this.onOperationsChanged.emit(s);}dispose(){this.invokers.clear(),super.dispose();}reset(){this.invokers.forEach((t=>{t.reset();})),this.invokers.clear();}}class Bv extends js{constructor(){super(),i(this,"files",void 0),i(this,"onDeleteFileData",void 0),this.files=new Map,this.onDeleteFileData=Gs(this);}dispose(){this.files.clear(),super.dispose();}reset(){this.files.clear();}addFile(t,e,i){const n=new ev({uid:t,mime:e,pageCount:i});this.files.set(t,n);}getByUid(t){return this.files.get(t)}addUser(t,e,i){const n=this.getByUid(t);return null==n?void 0:n.addUser(e,i)}addUsersByParsedPages(t,e){e.forEach((e=>{this.addUser(t,e.fileIndex,e.pageUid);}));}deleteUser(t,e,i){const n=this.getByUid(t);return n&&(n.deleteUser(e,i),n.count||(this.onDeleteFileData.emit(t),this.files.delete(t))),!1}}class Uv extends js{constructor(t){super(),i(this,"pages",void 0),i(this,"core",void 0),i(this,"onUpdatePage",Gs(this)),i(this,"onCreatePage",Gs(this)),i(this,"onCopyPage",Gs(this)),i(this,"onDeletePages",Gs(this)),i(this,"onBeforeDeletePages",Gs(this)),i(this,"onAfterDeletePages",Gs(this)),i(this,"onBeforeCopyPages",Gs(this)),i(this,"onCopyPages",Gs(this)),this.core=t,this.pages=new Map;}handlePagePreloadChange(t){let{viewerUid:e,viewerMode:i,docUid:n,changes:s}=t;s.forEach((t=>{let{pageUid:s,from:o,to:r}=t;const a=this.getPage(s),l={viewerUid:e,docUid:n,pageUid:s},{autoReleaseBlob:h,autoReleaseImg:c}=ko;o&&!r?(a.raw.deleteUser(l),a.raw.hasUser()||(this.core.imageLoadService.cancelLoadRawImage(s),this.core.parserService.cancelGetPage(a.fileUid,a.fileIndex),h&&a.raw.resetBlob(),c&&a.raw.resetImg()),i!==dg.DEFAULT&&i!==dg.THUMBNAIL||(a.original.deleteUser(l),a.original.hasUser()||(this.core.imageLoadService.cancelLoadOriginalImage(s),h&&a.original.resetBlob(),c&&a.original.resetImg()),a.display.deleteUser(l),a.display.hasUser()||(this.core.imageLoadService.cancelLoadDisplayImage(s),h&&a.display.resetBlob(),c&&a.display.resetImg())),i===dg.THUMBNAIL&&(a.thumbnail.deleteUser(l),a.thumbnail.hasUser()||(this.core.imageLoadService.cancelLoadThumbnailImage(s),h&&a.thumbnail.resetBlob(),c&&a.thumbnail.resetImg())),a.raw.hasUser()||this.core.parserService.cancelGetPage(a.fileUid,a.fileIndex)):(a.raw.addUser(l),i!==dg.DEFAULT&&i!==dg.THUMBNAIL||(a.original.addUser(l),a.display.addUser(l)),i===dg.THUMBNAIL&&a.thumbnail.addUser(l));}));}dispose(){this.pages.forEach((t=>{t.dispose();})),this.pages.clear(),super.dispose();}reset(){this.pages.forEach((t=>{t.dispose();})),this.pages.clear();}getPage(t){return this.pages.get(t)}startCreatePagesByParsedPages(t,e,i){t.forEach(((t,n)=>{var s;this.createPage({...t,fileUid:e,annotations:(null===(s=t.annotations)||void 0===s?void 0:s.map((t=>t.uid)))||[]},i);}));}endCreatePagesByParsedPages(t,e){t.forEach((t=>{let{pageUid:i,fileIndex:n}=t;const s=_f.create(i,e,n);this.onCreatePage.emit(s);}));}createPage(t,e){const i=new mv(t,e);return this.pages.set(i.uid,i),i}copyPage(t,e,i){const n=i.copy(t,e);return this.pages.set(n.uid,n),If.create(t,n.fileUid,n.fileIndex,i.annotations.slice()),n}deletePages(t){const e=Uf.create(t);this.onBeforeDeletePages.emit(e),t.forEach((t=>{const e=this.pages.get(t);e&&e.dispose(),this.pages.delete(t);})),this.onDeletePages.emit(e),this.onAfterDeletePages.emit(e);}updatePage(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=this.pages.get(t);if(n){const{doc:s,customData:o}=n;n.dispose();const r=new mv({...i,pageUid:t},s);r.customData=o,this.pages.set(t,r);const a=Gf.create(s.uid,t,e);this.onUpdatePage.emit(a);}}getPageCount(){return this.pages.size}}var Lv=new WeakSet,Ov=new WeakSet;class Wv{constructor(t){v(this,Ov),v(this,Lv),i(this,"core",void 0),i(this,"annotationMapper",void 0),this.core=t,this.annotationMapper=new wd;}reset(){}async saveToPng(t,e,i){var n;const s=this.core.pageService.getPage(t);if(!s)return Promise.resolve(null);const o=await this.core.sourceStore.get(s.fileUid);if("image/png"===(null===(n=o.fileData)||void 0===n?void 0:n.type)){if(!((null==e?void 0:e.saveAnnotation)&&s.annotations.length>0||p(this,Lv,Nv).call(this,s)))return i&&(i.details.current=i.details.total,i.status="InProgress",Du.info(i),i.status="Completed",Du.info(i)),o.fileData}const r=this.core.getPageData(t),a=await r.display({renderAnnotation:!(null==e||!e.saveAnnotation),getPng:!0});r.destroy();const l=no.isApple&&!(null!=e&&e.saveAnnotation&&s.annotations.length>0)&&p(this,Ov,_v).call(this,s);if(!l){if("image/png"===await Fs(a.data))return i&&(i.details.current=i.details.total,i.status="InProgress",Du.info(i),i.status="Completed",Du.info(i)),a.data}const h=this.core.saverService.getSaver("image/png");try{const t=await h.save(a.data,{outputType:3,is1Bit:l});return i&&(i.details.current=i.details.total,i.status="InProgress",Du.info(i),i.status="Completed",Du.info(i)),t}finally{h.destroy();}}async saveToJpeg(t,e,i){var n;const s=this.core.pageService.getPage(t);if(!s)return Promise.resolve(null);const o=await this.core.sourceStore.get(s.fileUid);if("image/jpeg"===(null===(n=o.fileData)||void 0===n?void 0:n.type)&&void 0===(null==e?void 0:e.quality)){if(!((null==e?void 0:e.saveAnnotation)&&s.annotations.length>0||p(this,Lv,Nv).call(this,s)))return i&&(i.details.current=i.details.total,i.status="InProgress",Du.info(i),i.status="Completed",Du.info(i)),o.fileData}const r=this.core.saverService.getSaver("image/jpeg");try{const n=this.core.getPageData(t),s=await n.display({renderAnnotation:!(null==e||!e.saveAnnotation)});n.destroy();const o=await r.save(s.data,{outputType:1,jpegQuality:null==e?void 0:e.quality});return i&&(i.details.current=i.details.total,i.status="InProgress",Du.info(i),i.status="Completed",Du.info(i)),o}finally{r.destroy();}}async saveToTiff(t,e,i){const n=this.core.saverService.getSaver("image/tiff"),s=!(null==e||!e.saveAnnotation);try{await n.init(e);for(let o=0;o<t.length;o++){const r=t[o],a=this.core.pageService.getPage(r);if(!a)break;const l=this.core.getPageData(r),h=await l.display({renderAnnotation:s});l.destroy();const c=no.isApple&&!(null!=e&&e.saveAnnotation&&a.annotations.length>0)&&p(this,Ov,_v).call(this,a);await n.appendPage(h.data,{is1Bit:c}),i&&(i.details.current=o+1,i.status="InProgress",Du.info(i));}const o=await n.getTiff();return i&&(i.details.current=i.details.total,i.status="Completed",Du.info(i)),o}finally{n.destroy();}}isPdfInfoChanged(t){return !!t.pdfOptions&&(t.rotation%360!==t.pdfOptions.rotation||(t.mediaBox.left!==t.pdfOptions.mediaBox.left||t.mediaBox.width!==t.pdfOptions.mediaBox.width||t.mediaBox.height!==t.pdfOptions.mediaBox.height||t.mediaBox.top!==t.pdfOptions.mediaBox.top||(t.cropBox.left!==t.pdfOptions.cropBox.left||t.cropBox.width!==t.pdfOptions.cropBox.width||t.cropBox.height!==t.pdfOptions.cropBox.height||t.cropBox.top!==t.pdfOptions.cropBox.top)))}async saveToPdf(t,e,i){var n;null!=e&&e.creationDate&&(e.creationDate=Zf(e.creationDate)),null!=e&&e.modifiedDate&&(e.modifiedDate=Zf(e.modifiedDate)),!e||"annotation"!==e.saveAnnotation&&"flatten"!==e.saveAnnotation||Ep.makeSureAnnotationLicenseExist();const s=null!==(n=null==e?void 0:e.quality)&&void 0!==n?n:80,o=this.core.saverService.getSaver("application/pdf");try{await o.init(e);const n=new Map,f=e&&e.pageType&&e.pageType!==Oo.PAGE_DEFAULT;await o.appendBlankPages(595,842,t.length);const v=[];for(let d=0;d<t.length;d++){var r,a;if(v.includes(d))continue;const u=t[d],g=this.core.pageService.getPage(u);if(!g)break;const m=await this.core.sourceStore.get(g.fileUid),y=f||(null===(r=g.pdfOptions)||void 0===r?void 0:r.convertMode)===oc.CM_IMAGEONLY||(null===(a=g.pdfOptions)||void 0===a?void 0:a.renderOptions.renderGrayscale),x=[],w=[],b=[];if(m.fileData&&"application/pdf"===m.fileData.type&&!y)for(let i=d;i<t.length;i++){var l,h;if(d!==i&&!w.includes(d))break;const s=t[i],o=this.core.pageService.getPage(s);if(!o)continue;if(o.fileUid!==g.fileUid)continue;if(!o.isFull)continue;if("image"===(null==e?void 0:e.saveAnnotation)&&o.annotations.length>0)continue;if((null===(l=o.pdfOptions)||void 0===l?void 0:l.convertMode)===oc.CM_IMAGEONLY||null!==(h=o.pdfOptions)&&void 0!==h&&h.renderOptions.renderGrayscale)continue;let r=!1;o.filter&&"none"!==o.filter&&(r=!0);const a=o.getActions(),c=o.getPerspectiveActions();a.every((t=>"rotate"===t.type||"crop"===t.type))&&c.every((t=>"rotate"===t.type||"crop"===t.type))||(r=!0);let u=!1;if(r){this.core.getAnnotationsByPageUid(t[d]).forEach((t=>{t.oriIndex>=0&&!t.modified&&(u=!0);}));}r&&!u||(this.isPdfInfoChanged(o)&&n.set(i,{mediaBox:o.mediaBox,cropBox:o.cropBox,rotation:o.rotation}),x.push(o.fileIndex),w.push(i),u&&b.push({pageUid:s,pageIndex:i,fileIndex:o.fileIndex}));}if(x.length>0){var c;const t=null===(c=m.loadOptions)||void 0===c?void 0:c.password,n=[];if(b.forEach((t=>{n.push(t.pageIndex);})),await o.replaceRawPdfPages(m.fileData,t,x,w),i){i.status="InProgress";for(let t=0;t<w.length;t++)n.includes(w[t])||(v.push(w[t]),i.details.current=v.length,Du.info(i));}for(let t=0;t<b.length;t++){const n=await this.core.imageDataService.getNotRotatedDisplay(b[t].pageUid,"image"===(null==e?void 0:e.saveAnnotation),!1,s);await o.changePageImage(b[t].pageIndex,n.data,{cropBox:g.cropBox,mediaBox:g.mediaBox,rotation:g.rotation,width:n.width,height:n.height}),i&&(i.status="InProgress",v.push(b[t].pageIndex),i.details.current=v.length,Du.info(i));}}else {let t;const n=1e-6;let r=!0;Math.abs(g.cropBox.left-g.mediaBox.left)<n&&Math.abs(g.cropBox.top-g.mediaBox.top)<n&&Math.abs(g.cropBox.width-g.mediaBox.width)<n&&Math.abs(g.cropBox.height-g.mediaBox.height)<n&&(r=!1),t=f&&r?await this.core.imageDataService.getNotRotatedCroppedDisplay(u,"image"===(null==e?void 0:e.saveAnnotation),!1,s):await this.core.imageDataService.getNotRotatedDisplay(u,"image"===(null==e?void 0:e.saveAnnotation),!1,s);const a=no.isApple&&!("image"===(null==e?void 0:e.saveAnnotation)&&g.annotations.length>0)&&p(this,Ov,_v).call(this,g);await o.applyImageToPage(d,t.data,{cropBox:g.cropBox,mediaBox:g.mediaBox,rotation:g.rotation,width:t.width,height:t.height,bitDepth:a?1:void 0}),i&&(v.push(d),i.details.current=v.length,i.status="InProgress",Du.info(i));}}n.size>0&&await o.setPageInfo(n);const m=[];for(let i=0;i<t.length;i++){var d;const n=this.core.pageService.getPage(t[i]);if(n)if(e&&"image"===e.saveAnnotation)(null===(d=n.pdfOptions)||void 0===d?void 0:d.annotCount)>0&&await o.removePageAnnotations(i);else {const s=n.pdfOptions&&n.pdfOptions.convertMode===oc.CM_RENDERALL&&n.pdfOptions.renderOptions.renderAnnotations===rc.RENDER_ANNOTATIONS,r=this.core.getAnnotationsByPageUid(t[i]);if(!r.length){!s&&n.pdfOptions&&n.pdfOptions.annotCount>0&&await o.removePageAnnotations(i);continue}e&&"none"===e.saveAnnotation&&r.forEach((t=>{!["textBox","textTypewriter"].includes(t.type)||!t.modified&&Xn(null==t?void 0:t.oriIndex)||t.style.textContents.forEach((t=>{m.push({family:t.fontFamily,isBlob:"bold"===t.fontWeight,isItalic:"italic"===t.fontStyle});}));}));const a=[];for(let t=0;t<r.length;t++)!0===r[t].flattened&&(a.push(r[t]),r.splice(t,1),t-=1);if(a.length>0){const t=await this.annotationMapper.getOriginalAnnotations(a,{width:n.mediaBox.left+n.mediaBox.width,height:2*n.mediaBox.top+n.mediaBox.height});await o.flattenPageAnnotations(i,t);}if(e&&"none"!==e.saveAnnotation){const t=await this.annotationMapper.getOriginalAnnotations(r,{width:n.mediaBox.left+n.mediaBox.width,height:2*n.mediaBox.top+n.mediaBox.height});var u;if(await o.setPageAnnotations(i,t,s),"flatten"===e.saveAnnotation)(t.length>0||s&&null!==(u=n.pdfOptions)&&void 0!==u&&u.annotCount)&&await o.flattenPage(i);}else {var g;(null===(g=n.pdfOptions)||void 0===g?void 0:g.annotCount)>0&&await o.removePageAnnotations(i);}}}if(m.length){await o.ifFontsExist(m)||Du.warning(Du.WASM_FONT_LOSS);}const y=await o.getPdf(po.RT_BINARY);return i&&(i.details.current=i.details.total,i.status="Completed",Du.info(i)),y}catch(t){throw Du.EXTERNAL_ERR}finally{o.destroy();}}}function Nv(t){if(!t.isFull)return !0;if(t.filter&&"none"!==t.filter)return !0;if(t.getActions().some((t=>"rotate"!==t.type)))return !0;if(t.getPerspectiveActions().some((t=>"rotate"!==t.type)))return !0;const e=this.core.getAnnotationsByPageUid(t.uid);let i=!1;return e.forEach((t=>{t.flattened&&(i=!0);})),!!i||0!==t.rotation}function _v(t){if(1!==t.resource.bitDepth)return !1;if(t.filter&&t.filter!==Yd.NONE&&t.filter!==Yd.BLACK_AND_WHITE&&t.filter!==Yd.SAVE_INK)return !1;const e=this.core.getAnnotationsByPageUid(t.uid);let i=!1;return e.forEach((t=>{t.flattened&&(i=!0);})),!i}const Fv=t=>{const e=new Set(t);return Array.from(e.values())};class Hv extends js{constructor(){super(),i(this,"observer",void 0),i(this,"onResizeObserver",Gs(this)),this.observer=new ResizeObserver((t=>{t.forEach((t=>{this.onResizeObserver.emit(t);}));}));}observe(t){this.observer.observe(t);}unobserve(t){this.observer.unobserve(t);}reset(){this.observer.disconnect();}dispose(){this.observer.disconnect(),this.observer=null,super.dispose();}}class Vv{constructor(){i(this,"canvas",void 0),i(this,"renderer",void 0),i(this,"root",void 0),this.renderer=new _l,this.canvas=new xl({renderer:this.renderer,width:10,height:10,canvas:document.createElement("canvas"),dpr:1,willReadFrequently:!0}),this.root=this.canvas.document.documentElement,(new kc).init(this.canvas);}render(t,e,i){this.root.children.slice().forEach((t=>{this.root.removeChild(t);})),this.root.appendChild(t),this.canvas.resize(e||t.width,i||t.height),this.canvas.render();}reset(){this.root.children.slice().forEach((t=>{this.root.removeChild(t);})),this.root.sortable.sorted=[];}getCanvas(){return this.canvas.contextService.getDomElement()}}let zv;function $v(t){let e=-1;zv||(zv=function(){const t=new Int32Array(256);for(let e=0;e<256;e++){let i=e;for(let t=0;t<8;t++)i=1&i?3988292384^i>>>1:i>>>1;t[e]=i;}return t}());for(let i=0;i<t.length;i++)e=zv[255&(e^t[i])]^e>>>8;return -1^e}const jv="image/png",Xv="image/jpeg",Gv="p".charCodeAt(0),Yv="H".charCodeAt(0),qv="Y".charCodeAt(0),Jv="s".charCodeAt(0);function Zv(t,e){const i=t.slice(0,33);return new Promise(((n,s)=>{const o=new FileReader;o.onload=()=>{const i=new Uint8Array(o.result),s=t.slice(33),r=function(t,e,i,n){if(i===Xv)return t[13]=1,t[14]=e>>8,t[15]=255&e,t[16]=e>>8,t[17]=255&e,t;if(i===jv){const i=new Uint8Array(13);e*=39.3701,i[0]=Gv,i[1]=Yv,i[2]=qv,i[3]=Jv,i[4]=e>>>24,i[5]=e>>>16,i[6]=e>>>8,i[7]=255&e,[i[8],i[9],i[10],i[11]]=[i[4],i[5],i[6],i[7]],i[12]=1;const s=$v(i),o=new Uint8Array(4);if(o[0]=s>>>24,o[1]=s>>>16,o[2]=s>>>8,o[3]=255&s,n){const e=function(t){for(let e=t.length-1;e>=4;e--)if(9===t[e-4]&&t[e-3]===Gv&&t[e-2]===Yv&&t[e-1]===qv&&t[e]===Jv)return e-3;return -1}(t);return t.set(i,e),t.set(o,e+13),t}const r=new Uint8Array(4);r[0]=0,r[1]=0,r[2]=0,r[3]=9;const a=new Uint8Array(54);return a.set(t,0),a.set(r,33),a.set(i,37),a.set(o,50),a}throw new Error(`The format ${i} is not supported.`)}(i,e,t.type),a=new Blob([r,s],{type:t.type});n(a);},o.onerror=t=>{s(t);},o.readAsArrayBuffer(i);}))}class Qv{constructor(t){i(this,"core",void 0),this.core=t;}async getRaw(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.raw.isAvailable)return i.raw.getImageDetail();const{fileUid:n,fileIndex:s}=i,o=await this.core.sourceStore.get(n);let r;return r=this.core.parserService.getCustomParserClasses(o.fileData.type)?o.fileData.type:await Fs(o.fileData),r||Du.throw(Du.FILE_NOT_SUPPORT),new Promise(((t,a)=>{let l=!1;const h=setTimeout((()=>{l=!0,t(null);}),ko.loadRawPageTimeout);this.core.parserService.getPage(o.fileData,r,n,s).then((n=>{if(l)return;if(clearTimeout(h),!n)return void t(null);let{raw:s}=i;e||(s=new lv(i)),s.updateImageDetail(n.resource),t(s.getImageDetail());})).catch((e=>{l||(clearTimeout(h),Du.error(e),t(null));}));}))}catch(t){return Du.error(t),null}}async getOriginal(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;const{original:n}=i;if(n.isAvailable)return n.getImageDetail();const s=await this.getRaw(t);if(!s)return null;const o=await this.handlePerspectiveQuad(t,s);return e&&o&&i.original.updateImageDetail(o),o}async handlePerspectiveQuad(t,e){const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let n=e;const s=i.getProcessedQuad();if(s){const o=Du.buildInfo("perspective",{pageUid:t,perspectiveQuad:s});if(Du.info(o),n=await this.core.perspectiveService.perspective({data:e.data,type:co.JPEG},s,{angle:i.initRotation}),!n)return o.status="Failed",Du.info(o),null;o.status="Completed",Du.info(o);}const o=new lv(i);return o.updateImageDetail(n),o.getImageDetail()}async getDisplay(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.display.isAvailable)return i.display.getImageDetail();const n=await this.getOriginal(t);if(!n)return null;const{filter:s}=i,o=await this.handleFilter(t,n);return i.filter!==s?this.getDisplay(t):(e&&o&&i.display.updateImageDetail(o),o)}async handleFilter(t,e){const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;const n=e,{filter:s}=i;if(s&&"none"!==s){const i=Du.buildInfo("filter",{pageUid:t,filterType:s});Du.info(i);const o=await this.core.filterService.applyFilter({data:e.data,type:co.JPEG,width:e.width,height:e.height},s);if(!Vn(o))return i.status="Failed",Du.info(i),null;i.status="Completed",Du.info(i),n.data=o;}const o=new lv(i);return o.updateImageDetail(n),o.getImageDetail()}async getEditedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=this.core.pageService.getPage(t);if(!s||s.isDestroyed)return null;const o=await this.getDisplay(t,!1),r=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));if(s.getActions().length||0!==s.rotation||!s.isMediaBoxEqualCropBox()||e&&s.annotations.length||r){const o=await this.applyEditToDisplay(t,e,i,!0,n),r=new lv(s);return r.updateImageDetail(o),r.getImageDetail()}return o}async getNotRotatedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;const s=this.core.pageService.getPage(t);if(!s||s.isDestroyed)return null;const o=await this.getOriginal(t);if(!o)return null;const r=await this.handleFilter(t,o);if(e&&s.annotations.length){const o=await this.applyEditToDisplay(t,e,!1,!1,i,n),r=new lv(s);return r.updateImageDetail(o),r.getImageDetail()}return r}async getNotRotatedCroppedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;const s=this.core.pageService.getPage(t);if(!s||s.isDestroyed)return null;const o=await this.getOriginal(t);if(!o)return null;await this.handleFilter(t,o);const r=await this.applyCropToDisplay(t,e,!1,i,n),a=new lv(s);return a.updateImageDetail(r),a.getImageDetail()}async getThumbnail(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.thumbnail.isAvailable)return i.thumbnail.getImageDetail();const n=await this.getDisplay(t,!0);if(!n)return null;const s=await this.displayToThumbnail(n.data);return s?(e&&i.thumbnail.updateImageDetail(s),s):null}async displayToThumbnail(t){return t}async applyEditToDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:100;const r=await this.core.imageLoadService.loadDisplayImage(t),a=this.core.pageService.getPage(t),l=await this.getDisplay(t,!1);let h;if(n)h=a.getEditResultForPixel();else {const[t,e]=Hs([a.initState.mediaBox.width,a.initState.mediaBox.height],ko.displayResolution,a.resource.resolutionX);h={rWidth:t,rHeight:e,cropLeft:0,cropTop:0,cropWidth:t,cropHeight:e,rotation:0};}const c={width:Math.round(h.rWidth)||1,height:Math.round(h.rHeight)||1,data:null},d=new Ma({style:{x:-h.cropLeft,y:-h.cropTop,img:r,width:l.width,height:l.height}}),u=new Fa({style:{x:-(h.cropWidth-h.rWidth)/2,y:-(h.cropHeight-h.rHeight)/2,width:h.cropWidth,height:h.cropHeight}});u.appendChild(d),u.setLocalAngle(h.rotation);let p=null;if(this.core.annotationService&&a.annotations.length){const n=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));(e||!e&&n)&&(p=new Fa({style:{x:-h.cropLeft,y:-h.cropTop,width:a.original.pageWidth,height:a.original.pageHeight}}),await this.applyAnnotationToPage(p,t,i,!e&&n),u.appendChild(p));}this.core.commonCanvas.render(u,Math.max(1/devicePixelRatio,h.rWidth),Math.max(1/devicePixelRatio,h.rHeight)),this.core.commonCanvas.reset();const g=this.core.commonCanvas.getCanvas();return new Promise(((t,e)=>{g.toBlob((async e=>{p&&p.children.forEach((t=>{t instanceof Nh&&t.destroy();})),null!=r&&r.src&&URL.revokeObjectURL(r.src),e=await Zv(e,a.resolutionX||ko.displayResolution),c.data=e,t(c);}),s?"image/png":"image/jpeg",o/100);}))}async applyCropToDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100;const o=await this.core.imageLoadService.loadDisplayImage(t),r=this.core.pageService.getPage(t),a=await this.getDisplay(t,!1),l=r.toPixelPPI(r.cropBox.width,!1),h=r.toPixelPPI(r.cropBox.height,!0),c={rWidth:Math.round(l),rHeight:Math.round(h),cropLeft:r.toPixelPPI(r.cropBox.left,!1),cropTop:r.toPixelPPI(r.cropBox.top,!0),cropWidth:l,cropHeight:h,rotation:0},d={width:Math.round(c.rWidth)||1,height:Math.round(c.rHeight)||1,data:null},u=new Ma({style:{x:-c.cropLeft,y:-c.cropTop,img:o,width:a.width,height:a.height}}),p=new Fa({style:{x:-(c.cropWidth-c.rWidth)/2,y:-(c.cropHeight-c.rHeight)/2,width:c.cropWidth,height:c.cropHeight}});p.appendChild(u),p.setLocalAngle(c.rotation);let g=null;if(this.core.annotationService&&r.annotations.length){const n=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));(e||!e&&n)&&(g=new Fa({style:{x:-c.cropLeft,y:-c.cropTop,width:r.original.pageWidth,height:r.original.pageHeight}}),await this.applyAnnotationToPage(g,t,i,!e&&n),p.appendChild(g));}this.core.commonCanvas.render(p,Math.max(1/devicePixelRatio,c.rWidth),Math.max(1/devicePixelRatio,c.rHeight)),this.core.commonCanvas.reset();const f=this.core.commonCanvas.getCanvas();return new Promise(((t,e)=>{f.toBlob((async e=>{g&&g.children.forEach((t=>{t instanceof Nh&&t.destroy();})),null!=o&&o.src&&URL.revokeObjectURL(o.src),e=await Zv(e,r.resolutionX||ko.displayResolution),d.data=e,t(d);}),n?"image/png":"image/jpeg",s/100);}))}async applyAnnotationToPage(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=this.core.pageService.getPage(e),o=[];s.annotations.forEach((t=>{const e=this.core.annotationService.getAnnotationByUid(t);o.push(e);})),o.sort(((t,e)=>t.layer-e.layer));for(let e=0;e<o.length;e++){if(i&&!o[e].flags.includes("print"))continue;if(n&&!o[e].flattened)return;if("stamp"===o[e].type&&o[e].style.imageData&&(!Xn(o[e].style.width)||!Xn(o[e].style.height))){const t=new wo,i=await t.readImageInfo({fileSource:o[e].style.imageData});let n=i.imageWidth,s=i.imageHeight;if(n>400||s>400){const t=Math.max(n/400,s/400);n/=t,s/=t;}o[e].style.width=n,o[e].style.height=s;}const r=this.core.annotationService.createAnnotationShape(o[e],s);r instanceof Nh&&r.style.imageData&&r.style.img instanceof HTMLImageElement&&await new Promise((t=>{r.style.img.onload=()=>{t();};})),r&&t.appendChild(r);}}}class Kv{constructor(t){i(this,"name",void 0),this.name=t||"Guest";}getUser(){return this.name}setUser(t){this.name=t;}}class tm extends qo{static create(t){return new tm(t)}constructor(t){super("setExternalHandler"),i(this,"handlerType",void 0),this.handlerType=t;}}class em{static makeSureSourcesTypeSupported(t,e,i,n,s){const o=[];if(On(e))e.forEach(((t,e)=>{if(!t||0===t.length){const t=Ru("Source[]",i,`[${e}].fileData`,!0);o.push(`${t}: ${Du.FILE_NOT_SUPPORT.message}`);}}));else if(!e||0===e.length){const t=Ru("Source",i,"fileData");o.push(`${t}: ${Du.FILE_NOT_SUPPORT.message}`);}if(o.length>0){if(!t){throw Du.buildError({...Du.FILE_NOT_SUPPORT,details:o},n,s)}Du.throw({...Du.FILE_NOT_SUPPORT,details:o},n,s);}}}class im{constructor(t){i(this,"core",void 0),this.core=t;}async loadText(t){for(const n of t){var e,i;const t=this.core.pageService.getPage(n);if(!t||!t.isTextPage||t.parsedTexts)continue;if((null===(e=t.pdfOptions)||void 0===e?void 0:e.convertMode)!==oc.CM_RENDERALL){t.setParsedTexts(null);continue}const{fileUid:s,fileIndex:o}=t,r=await this.core.sourceStore.get(s);let a;a=this.core.parserService.getCustomParserClasses(r.fileData.type)?r.fileData.type:await Fs(r.fileData),a||Du.throw(Du.FILE_NOT_SUPPORT);const l=await this.core.parserService.getPageTexts(r.fileData,a,s,[o]);null!=l&&null!==(i=l[0].charInfos)&&void 0!==i&&i.length?t.setParsedTexts(l[0]):t.setParsedTexts(null);}}}var nm=new WeakMap,sm=new WeakMap,om=new WeakMap,rm=new WeakMap,am=new WeakMap,lm=new WeakMap,hm=new WeakMap;class cm{constructor(t,e,i,o){f(this,nm,{writable:!0,value:void 0}),f(this,sm,{writable:!0,value:Jn()}),f(this,om,{writable:!0,value:!1}),f(this,rm,{writable:!0,value:void 0}),f(this,am,{writable:!0,value:void 0}),f(this,lm,{writable:!0,value:void 0}),f(this,hm,{writable:!0,value:new Map}),s(this,nm,t),s(this,rm,e),s(this,am,i),s(this,lm,o),t.searchers.set(n(this,sm),this);}get docUid(){return n(this,rm)}async getResults(t){const e="DocTextSearcher.getResults";n(this,om)&&Du.error(Du.SEARCHER_DESTROYED),_n(t)&&Du.error(Du.PARAM_MISS,e,"pageIndex"),(!Xn(t)||Xn(t)&&t<0)&&Du.error(Du.PARAM_INVALID,e,"pageIndex");const i=n(this,nm).core.getDocument(n(this,rm));i||Du.error(Du.DOC_NOT_EXIST,e);const s=i.pages[t];if(s||Du.error(Du.PAGE_NOT_EXIST,e),n(this,hm).has(s))return n(this,hm).get(s);const o=await n(this,nm).core.getSearchedTextsByPageUid(s,n(this,am),n(this,lm)),r=ko.displayResolution,a=ko.dataResolution,l=o.map((t=>{let{text:e,lines:i,context:o}=t;return {pageUid:s,text:n(this,am),rects:i.map((t=>({x:Ks(Hs(t.box.left,r,a),2),y:Ks(Hs(t.box.top,r,a),2),width:Ks(Hs(t.box.width,r,a),2),height:Ks(Hs(t.box.height,r,a),2)}))),context:o}}));return n(this,hm).set(s,l),l}clearCache(t){n(this,om)||t.forEach((t=>{n(this,hm).has(t)&&n(this,hm).delete(t);}));}clearAllCache(){n(this,om)||n(this,hm).clear();}destroy(){n(this,nm).searchers.delete(n(this,sm)),s(this,nm,null),n(this,hm).clear(),s(this,om,!0);}}class dm extends js{constructor(t){super(),i(this,"searchers",new Map),i(this,"core",void 0),this.core=t,this.listenEvents();}getSearchersByDocUid(t){const e=[];return this.searchers.forEach((i=>{i.docUid===t&&e.push(i);})),e}listenEvents(){const{documentService:t}=this.core;t.onBeforeDeleteDocs.on((t=>{t.docUids.forEach((t=>{const e=this.getSearchersByDocUid(t);null!=e&&e.length&&e.forEach((t=>{t.destroy();}));}));}),this),t.onDeletePagesFromDoc.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),t.onDeleteAllPagesFromDoc.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((t=>{t.clearAllCache();}));}),this),this.core.pageService.onUpdatePage.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache([t.pageUid]);}));}),this),this.core.editService.onAfterCropPages.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),this.core.onFilterChanged.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),this.core.onAfterPerspective.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache([t.pageUid]);}));}),this);}createDocTextSearcher(t,e,i){return new cm(this,t,e,i)}dispose(){this.searchers.forEach((t=>{t.destroy();})),this.searchers.clear(),super.dispose();}}const um=new Map,pm=[];let gm=class t extends js{constructor(t,e,n,s,o){super(),i(this,"parserService",void 0),i(this,"saverService",void 0),i(this,"perspectiveService",void 0),i(this,"filterService",void 0),i(this,"detectorService",void 0),i(this,"viewerService",void 0),i(this,"editService",void 0),i(this,"annotationService",void 0),i(this,"documentService",void 0),i(this,"trackerService",void 0),i(this,"imageLoadService",void 0),i(this,"optimizationService",void 0),i(this,"processService",void 0),i(this,"commandService",void 0),i(this,"fileSaveService",void 0),i(this,"fileService",void 0),i(this,"pageService",void 0),i(this,"resizeService",void 0),i(this,"imageDataService",void 0),i(this,"userService",void 0),i(this,"textLoadService",void 0),i(this,"pageDataService",void 0),i(this,"docTextSearchService",void 0),i(this,"sourceStore",void 0),i(this,"commonCanvas",void 0),i(this,"onBeforeGetPageData",void 0),i(this,"onBeforeLoadSource",void 0),i(this,"onAfterLoadSource",void 0),i(this,"onSetExternalHandler",void 0),i(this,"onAfterPerspective",void 0),i(this,"onFilterChanged",void 0),i(this,"onUnload",void 0),i(this,"removeAllDocUid",void 0),this.parserService=t,this.saverService=e,this.perspectiveService=n,this.filterService=s,this.detectorService=o,this.onBeforeGetPageData=Gs(this),this.onBeforeLoadSource=Gs(this),this.onAfterLoadSource=Gs(this),this.onSetExternalHandler=Gs(this),this.onUnload=Gs(this),this.onAfterPerspective=Gs(this),this.onFilterChanged=Gs(this),this.commonCanvas=new Vv,this.sourceStore=new ug,this.trackerService=new wv,this.documentService=new xv,this.fileService=new Bv,this.pageService=new Uv(this),this.imageLoadService=new Hg(this),this.optimizationService=new jg,this.processService=new Xg,this.commandService=new Mv,this.fileSaveService=new Wv(this),this.resizeService=new Hv,this.imageDataService=new Qv(this),this.userService=new Kv("Guest"),this.textLoadService=new im(this),this.pageDataService=new Rv(this),pm.forEach((t=>{var e;null===(e=t.apply)||void 0===e||e.call(t,this);})),this.docTextSearchService=new dm(this),this.initServiceEvent();}initServiceEvent(){const{documentService:t,commandService:e,pageService:i,viewerService:n,fileService:s,parserService:o}=this;t.onDocumentCreated.on((t=>{e.createInvoker(t.docUid);}),e),t.onDocumentDeleted.on((t=>{e.deleteInvokers([t.docUid]);}),e),n.onPagePreloadChanged.on((t=>{i.handlePagePreloadChange(t);}),i),s.onDeleteFileData.on((t=>{this.sourceStore.remove(t);})),s.onDeleteFileData.on((t=>{o.freeParserByFileUid(t);}),o),this.editService.onAfterCropPages.on((t=>{t.pageUids.forEach((t=>{const e=i.getPage(t);e&&e.isTextPage&&!e.parsedTexts?this.textLoadService.loadText([e.uid]).then((()=>{e.handleCropBoxForText();})):e&&e.handleCropBoxForText();}));}));}static getClass(t){return um.get(t)}static setClass(t,e){um.set(t,e);}static registerPlugin(e){pm.includes(e)||pm.push(e),e.install&&e.install(t);}getClass(t){return um.get(t)}createAsyncRepository(){return new ug}createViewer(e){const i=t.getClass("Viewer"),n={...e,core:this,groupUid:e.groupUid||Jn()},s=this.viewerService.createViewer(i,n);return s.context.isInitialized=!0,s}removeViewer(t){this.viewerService.removeViewer(t.uid);}getViewer(t){return this.viewerService.getViewer(t)}getViewers(){return this.viewerService.getAllViewers()}getFileParserDefaultOptions(t){return this.parserService.getDefaultParserOptions(t)}setFileParserDefaultOptions(t,e){return this.parserService.setDefaultParserOptions(t,e)}setFileParser(t,e){this.parserService.registerCustomParser(t,e);}getSourceParseOptions(t,e){if("application/pdf"===e){var i;const e=t;return e.convertMode=null!==(i=e.convertMode)&&void 0!==i?i:oc.CM_AUTO,Nn(e)}if("width"in t){return Nn(t)}}async loadSource(t,e,i,n){On(t)||(t=[t]),this.removeAllDocUid===e&&(this.removeAllDocUid=null);const s=this.documentService.getDocument(e);if(!s)return n&&(n.status="Failed",Du.info(n)),[];const o=Xn(i)?{insertBeforeIndex:i}:{...i},r="ignore"===o.exception,a=await this.getSourcesMimeTypes(t);if(this.removeAllDocUid===e)return this.removeAllDocUid=null,[];r||em.makeSureSourcesTypeSupported(!1,a,"sources");const l=[],h=async(t,i)=>{const n=a[i];r&&em.makeSureSourcesTypeSupported(!1,n,`sources[${i}]`);const h=[],c=Jn(),d=this.getSourceParseOptions(t,n),{fileData:u}=t,{pageCount:p,batchSize:g}=await this.parserService.getParseInfo(u,n,c,d);if(this.removeAllDocUid===e)return [];this.sourceStore.set(c,{fileData:n===u.type?u:u.slice(0,u.size,n),loadOptions:d,pageCount:p}),this.fileService.addFile(c,n,p);const f=this.getBatchIndices(g,p);for(const i of f){var v;const r=await this.parserService.parse(u,n,c,i,d).catch((t=>{throw t}));if(this.removeAllDocUid===e)return [];null===(v=t.extraPageData)||void 0===v||v.forEach((t=>{const e=r.find((e=>e.fileIndex===t.index));if(e){const i={...t};delete i.index,Xn(e.rotation)&&Xn(i.rotation)&&(i.rotation+=e.rotation),_n(i.filter)||(e.filter=i.filter),_n(i.rotation)||(e.rotation=i.rotation),_n(i.perspectiveQuad)||(e.perspectiveQuad=i.perspectiveQuad),_n(i.index)||(e.index=i.index);}}));const a=r.map((t=>{var e;const i=Jn();return t.pageUid=i,null!==(e=t.filter)&&void 0!==e||(t.filter=this.filterService.getDefaultFilterType()||"none"),i}));l.push({fileData:u,mimeType:n,fileUid:c,parsedPages:r,indices:i,parseOptions:d}),this.fileService.addUsersByParsedPages(c,r),this.pageService.startCreatePagesByParsedPages(r,c,s),this.documentService.addPagesToDocument(e,a,o.insertBeforeIndex),_n(o.insertBeforeIndex)||(o.insertBeforeIndex+=r.length),h.push(...a);}return h};this.onBeforeLoadSource.emit({docUid:e});const c=[];for(const[i,s]of t.entries())try{const t=await h(s,i);if(this.removeAllDocUid===e)return this.removeAllDocUid=null,[];c.push(...t),n&&(n.status="InProgress",n.details.current=i+1,Du.info(n));}catch(t){if(!r)throw t;Du.warning(t);}for(let t=0;t<l.length;t++){const i=l[t];if(await this.parserService.parseAnnotation(i.fileData,i.mimeType,i.fileUid,i.parsedPages,i.indices,i.parseOptions),this.removeAllDocUid===e)return this.removeAllDocUid=null,[];this.annotationService.createAnnotationsByParsedPages(e,i.parsedPages),i.parsedPages.forEach((t=>{const e=this.pageService.getPage(t.pageUid);e&&t.annotations&&(e.annotations=t.annotations.map((t=>t.uid)));}));}const d=c.map((t=>s.pages.indexOf(t)));return this.onAfterLoadSource.emit($f.create(e,d,c)),this.documentService.onPagesAddedOut.emit($f.create(e,[...d],[...c])),n&&(n.details.current=n.details.total,n.status="Completed",Du.info(n)),c}async getSourcesMimeTypes(t){const e=[];for(const i of t){const t=this.parserService.getCustomParserClasses(i.fileData.type)?i.fileData.type:await Fs(i.fileData);e.push(t);}return e}getAnnotationsByPageUid(t){const e=this.pageService.getPage(t);return e?e.annotations.map((t=>this.annotationService.getAnnotationByUid(t))):[]}getBatchIndices(t,e){const i=[];for(let n=0;n<e;){const s=t>0?Math.min(t,e-n):e;i.push(Array.from({length:s},((t,e)=>n+e))),n+=s;}return i}getPageData(t){return this.pageDataService.requestPageData(t)}async setCustomData(t,e){const i=this.pageService.getPage(t);return i?(i.customData=Nn(e),!0):Promise.reject()}async getCustomData(t){const e=this.pageService.getPage(t);if(!e)return Promise.reject();return Nn(e.customData)}async updatePage(t,e){var i,n;const s=this.pageService.getPage(t);if(!s)return !1;const{fileData:o}=e,r=Jn(),a=this.parserService.getCustomParserClasses(o.type)?o.type:await Fs(o);em.makeSureSourcesTypeSupported(!0,[a],"data");const l=this.getSourceParseOptions(e,a),{pageCount:h}=await this.parserService.getParseInfo(o,a,r,l).catch((t=>{throw t}));if(Xn(e.fileIndex)&&(e.fileIndex>=h||e.fileIndex<0)){const t=["UpdateSource.fileIndex is out of range"];throw {...Du.PARAM_INVALID,details:t}}this.sourceStore.set(r,{fileData:o,loadOptions:l,pageCount:h}),this.fileService.addFile(r,a,h);const[c]=await this.parserService.parse(o,a,r,[e.fileIndex||0],l).catch((t=>{throw t}));c.pageUid=t,null!==(i=c.filter)&&void 0!==i||(c.filter=this.filterService.getDefaultFilterType()||"none"),await this.parserService.parseAnnotation(o,a,r,[c],[e.fileIndex||0],l),this.commandService.removePageFromCommand(s.doc.uid,[t]),this.fileService.addUser(r,e.fileIndex||0,t),this.fileService.deleteUser(s.fileUid,s.fileIndex,t),null===(n=this.annotationService)||void 0===n||n.deleteAnnotations(s.annotations,!1),this.pageService.updatePage(t,o,{...c,...e,fileUid:r,annotations:[]}),this.annotationService.createAnnotationsByParsedPages(s.doc.uid,[c]);return this.pageService.getPage(t).isUpdated=!0,!0}async getPerspectivePreviewData(t,e,i){const n=this.pageService.getPage(t);if(!n)return null;const s=await this.imageDataService.getRaw(t);if(!s)return null;let{quad:o}=n;o=o?o.map((t=>Hs(t,ko.displayResolution,n.resource.resolutionX))):[[0,0],[s.width,0],[s.width,s.height],[0,s.height]];const r=await this.processService.perspectivePreview(s.data,4,o,{width:s.width,height:s.height},{...e,...i});return Promise.resolve(r)}createDocument(t){return this.documentService.createDocument(t)}getDocument(t){return this.documentService.getDocument(t)}deleteDocuments(t){const{documentService:e,pageService:i}=this;if(t.map((t=>e.getDocument(t))).includes(void 0))return !1;const n=of.create(t);e.onBeforeDeleteDocs.emit(n),t.forEach((t=>{const n=e.getDocument(t);var s;n&&(n.pages.forEach((t=>{const e=i.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(s=this.annotationService)||void 0===s||s.deleteAnnotationPages([...n.pages]),i.deletePages(n.pages));}));const s=e.deleteDocuments(t);return e.onAfterDeleteDocs.emit(n),s}renameDocument(t,e){this.documentService.renameDocument(t,e);}transferDocument(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{documentService:n}=this,s=n.getDocument(t),o=n.getDocument(e);if(!s||!o)return !1;if(t===e&&!i.copy)return !i.sourceIndices||this.movePages(t,i.sourceIndices,i.insertBeforeIndex);let r=[];if(null!=i&&i.sourceIndices){r=Fv(i.sourceIndices).map((t=>s.pages[t]));}else r=[...s.pages];if(!r.length)return !0;i.copy?r.forEach(((t,e,n)=>{const s=this.pageService.getPage(t),r=Jn();if(this.fileService.addUser(s.fileUid,s.fileIndex,r),this.pageService.copyPage(r,o,s),!1!==(null==i?void 0:i.includeAnnotations)&&this.annotationService){this.annotationService.annotationApp.createAnnotationPage(r);const t=s.annotations.map((t=>({...this.annotationService.getAnnotationByUid(t).getConfig(),docUid:o.uid,pageUid:r,uid:Jn()})));t.length&&this.annotationService.annotationApp.createAnnotations(t);}n[e]=r;})):(n.removePagesFromDocument(s.uid,r),r.forEach((t=>{const e=this.pageService.getPage(t);var n;(e.doc=o,!1===(null==i?void 0:i.includeAnnotations))&&(null===(n=this.annotationService)||void 0===n||n.deleteAnnotations(e.annotations),e.annotations=[]);}))),n.addPagesToDocument(o.uid,r,i.insertBeforeIndex);const a=r.map((t=>o.pages.indexOf(t)));return n.onPagesAddedOut.emit($f.create(o.uid,a,r)),!0}mergeDocuments(t,e){const{documentService:i}=this,n=i.createDocument(e);if(!t.length)return n;t=Fv(t);const s=[];if(t.forEach((t=>{const e=i.getDocument(t);s.push(...e.pages);})),null!=e&&e.deleteOriginal?(i.deleteDocuments(t),s.forEach((t=>{const i=this.pageService.getPage(t);var s;(i.doc=n,!1===(null==e?void 0:e.includeAnnotations))&&(null===(s=this.annotationService)||void 0===s||s.deleteAnnotations(i.annotations),i.annotations=[]);}))):s.forEach(((t,i,s)=>{const o=this.pageService.getPage(t),r=Jn();if(this.fileService.addUser(o.fileUid,o.fileIndex,r),this.pageService.copyPage(r,n,o),!1!==(null==e?void 0:e.includeAnnotations)&&this.annotationService){this.annotationService.annotationApp.createAnnotationPage(r);const t=o.annotations.map((t=>({...this.annotationService.getAnnotationByUid(t).getConfig(),docUid:n.uid,pageUid:r,uid:Jn()})));t.length&&this.annotationService.annotationApp.createAnnotations(t);}s[i]=r;})),s.length){i.addPagesToDocument(n.uid,s);const t=s.map((t=>n.pages.indexOf(t)));i.onPagesAddedOut.emit($f.create(n.uid,t,s));}return n}openDocument(t,e){return this.openOrCloseDocument(t,e)}closeDocument(t,e){return this.openOrCloseDocument(t,e,!0)}openOrCloseDocument(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=this.documentService.getDocument(t);if(!n||!this.viewerService.hasViewer(e))return !1;const s=this.viewerService.getViewer(e);return i?this.documentService.onCloseDocument.emit(Zg.create(n,e,s.groupUid)):this.documentService.onOpenDocument.emit(Jg.create(n,e,s.groupUid)),this.commandService.emitOperationsChanged(t),!0}deletePages(t,e){var i;return e=Fv(e),this.commandService.removePageFromCommand(t,[...e]),e.forEach((t=>{const e=this.pageService.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(i=this.annotationService)||void 0===i||i.deleteAnnotationPages(e),this.documentService.removePagesFromDocument(t,[...e]),this.pageService.deletePages(e),!0}deleteAllPages(t){var e;this.removeAllDocUid=t;const i=this.documentService.getDocument(t),n=[...i.pages];return this.commandService.removePageFromCommand(t,n),i.pages.forEach((t=>{const e=this.pageService.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(e=this.annotationService)||void 0===e||e.deleteAnnotationPages(i.pages),this.documentService.removeAllPagesFromDocument(t),this.pageService.deletePages(n),!0}movePages(t,e,i){return e=Fv(e),this.documentService.movePages(t,e,i)}swapPages(t,e,i){return this.documentService.swapPages(t,e,i)}reorderPages(t,e){return e=Fv(e),this.documentService.reorderPages(t,e)}async printPages(t,e,i){const n=this.documentService.getDocument(t);if(!n)return Promise.reject(Du.DOC_NOT_EXIST);const s=e||Array.from(Array(n.pages.length).keys()),o=[];for(let t=0;t<s.length;t++){var r;const e=this.getPageData(n.pages[s[t]]),a=await e.display({renderAnnotation:null===(r=null==i?void 0:i.printAnnotation)||void 0===r||r,isGetPrintPageData:!0});e.destroy(),o.push(a);}if(0===o.length)return Promise.reject();const a=[];return o.forEach((t=>{a.push({data:t.data,width:t.width,height:t.height});})),function(t){let e="",i=0,n=0;const s=[];t.forEach(((t,o)=>{let r=1120,a=850;const l=a/t.width,h=r/t.height;l<h?r=Math.floor(t.height*l):l>h&&(a=Math.floor(t.width*h));const c=Zn(t.data).data;s.push(c),e+=`<div class="imageContainer"><img id="DDV_Image${o}" src='${c}' referrerpolicy='strict-origin-when-cross-origin'"/></div>`,i+=a,n+=r;}));const o=`alwaysRaised=yes, z-look=yes, top=0, left=0, toolbar=no, menubar=no, location=no, status=no,width=${i}, height=${n}`,r=window.open("about:blank","_blank",o),a=`<html><head>\n                    <style>\n                        @page {\n                            margin: 0mm;\n                        }\n                        @media print {\n                            body, html {\n                                margin: 0;\n                                padding: 0;\n                                width: 100%;\n                                height: 100%;\n                            }\n\n                            .imageContainer {\n                                break-after: page;\n                                position: relative;\n                                width: 100%;\n                                height: 100%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center\n                            }\n\n                            img {\n                                object-fit: contain;\n                                max-width: 100%;\n                                max-height: 100%;\n                            }\n                        }\n                    </style>\n                </head><body id='DDV_body'>${e}</body></html>`;if(r){r.document.write(a),r.document.close(),r.focus();const t=r.document.getElementById("DDV_body");t&&(t.onload=()=>{r&&r.print(),s.forEach(((t,e)=>{URL.revokeObjectURL(t);}));});}}(a),!0}setDetectHandler(t,e){this.onSetExternalHandler.emit(tm.create("detect")),this.detectorService.setDetector(e);}setImageFilterHandler(t){this.onSetExternalHandler.emit(tm.create("filter")),this.filterService.setImageFilter(t);}clearExternalHandler(t){if(Gn(t))switch(t){case"documentBoundariesDetect":this.setDetectHandler(t,null);break;case"imageFilter":this.setImageFilterHandler(null);}}unload(){var t;this.viewerService.reset(),this.commonCanvas.reset(),this.sourceStore.reset(),this.documentService.reset(),this.fileService.reset(),this.pageService.reset(),this.commandService.reset(),this.resizeService.reset(),this.processService.reset(),this.detectorService.reset(),this.parserService.reset(),this.fileSaveService.reset(),null===(t=this.annotationService)||void 0===t||t.reset(),Ep.reset(),no.unload();}preloadModule(t){no.preloadModule(t);}async perspectivePage(t,e,i){let n,s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const o=this.pageService.getPage(e);if(o.setQuad(i)){if(o.isTextPage=!1,this.annotationService.deleteAnnotations(o.annotations),this.commandService.removePageFromCommand(t,[e]),o.quad){const{width:t,height:e}=hv(o.quad);o.original.updateImageDetail({width:t,height:e}),o.display.updateImageDetail({width:t,height:e});}this.imageLoadService.cancelLoadOriginalImage(e),o.original.reset(),s||(n=await this.imageDataService.getOriginal(e)),this.imageLoadService.cancelLoadDisplayImage(e),this.imageLoadService.cancelLoadThumbnailImage(e),o.display.reset(),o.thumbnail.reset();let{width:r,height:a}=o.original.getPageSize();o.isFull?(o.mediaBox={...o.initState.mediaBox},o.cropBox={...o.initState.cropBox}):(s&&({width:r,height:a}=hv(o.quad)),o.mediaBox={left:0,top:0,width:r,height:a},o.cropBox={...o.mediaBox}),this.onAfterPerspective.emit(sf.create(o.doc.uid,e,i,r,a));}return s?null:n||this.imageDataService.getOriginal(e)}async filterPages(t,e,i){e.forEach((t=>{const e=this.pageService.getPage(t);e.filter!==i&&(e.filter=i,e.display.reset(),e.thumbnail.reset());}));const n=Kg.create(t,e,i);return this.onFilterChanged.emit(n),!0}insertBlankPage(t,e,i,n,s,o){const r=this.documentService.getDocument(t);if(!r)return "";this.onBeforeLoadSource.emit({docUid:t});const a=Jn(),l={fileData:new Blob([""],{type:"application/ddv-blank-image"}),width:null!=e?e:816,height:null!=i?i:1056,resolutionX:null!=n?n:96,resolutionY:null!=s?s:96},h=this.getSourceParseOptions(l,"application/ddv-blank-image");this.sourceStore.set(a,{fileData:l.fileData,loadOptions:h,pageCount:1}),this.fileService.addFile(a,"application/ddv-blank-image",1),this.parserService.parse(l.fileData,"application/ddv-blank-image",a,[0],h);const{displayResolution:c}=ko,d=Jn();this.fileService.addUser(a,0,d);const u={resource:{data:l.fileData,width:l.width,height:l.height,resolutionX:l.resolutionX,resolutionY:l.resolutionY},mediaBox:{left:0,top:0,width:l.width/l.resolutionX*c,height:l.height/l.resolutionY*c},cropBox:{left:0,top:0,width:l.width/l.resolutionX*c,height:l.height/l.resolutionY*c},annotations:[],fileIndex:0,pageUid:d,fileUid:a};return this.pageService.createPage(u,r),this.annotationService.createAnnotationsByParsedPages(t,[u]),this.documentService.addPagesToDocument(t,[d],o),this.onAfterLoadSource.emit($f.create(t,[r.pages.indexOf(d)],[d])),this.documentService.onPagesAddedOut.emit($f.create(t,[r.pages.indexOf(d)],[d])),d}async getPageSourceInfo(t){const e=this.pageService.getPage(t),i={};i.bitDepth=e.resource.bitDepth,i.resolutionX=e.resource.resolutionX,i.resolutionY=e.resource.resolutionY;const n=await this.sourceStore.get(e.fileUid);if("application/pdf"!==n.fileData.type)return i.pageContentType=n.fileData.type,i;if(e.pdfOptions&&e.pdfOptions.pageContentType)return i.pageContentType=e.pdfOptions.pageContentType,i;const s=new So;try{const t=await s.getPdfPageContentType({fileSource:n.fileData,password:n.loadOptions.password},e.fileIndex);return e.pdfOptions&&(e.pdfOptions.pageContentType=t),i.pageContentType=t,i}finally{s.destroy();}}isPageModified(t){var e;const i=this.pageService.getPage(t);if(!i)return !1;if(!i.isFull)return !0;if(i.filter&&"none"!==i.filter)return !0;if(i.isUpdated)return !0;const{cropBox:n,initState:s}=i;if(n.left!==s.cropBox.left||n.top!==s.cropBox.top||n.width!==s.cropBox.width||n.height!==s.cropBox.height)return !0;const o=i.getActions(),r=i.getPerspectiveActions();let a=0;if(o.forEach((t=>{"rotate"===t.type&&(a+=t.angle);})),r.forEach((t=>{"rotate"===t.type&&(a+=t.angle);})),a%360!=0)return !0;if(this.fileSaveService.isPdfInfoChanged(i))return !0;const l=this.getAnnotationsByPageUid(t);if(l.length!==((null==i||null===(e=i.pdfOptions)||void 0===e?void 0:e.parsedAnnotCount)||0))return !0;const h=[...l];h.sort(((t,e)=>t.layer-e.layer));for(let t=0;t<h.length;t++)if(_n(h[t].oriIndex)||h[t].modified||t!==h[t].parsedOriIndex)return !0;return !1}async isPdfEncrypted(t){const e=await this.getSourcesMimeTypes([{fileData:t}]);if(!e.length||"application/pdf"!==e[0])return !1;const i=Jn();let n=!1;return await this.parserService.getParseInfo(t,e[0],i).catch((t=>{-80202===t.code&&(n=!0);})),this.parserService.freeParserByFileUid(i),n}async getSearchedTextsByPageUid(t,e,i){if(0===e.length)return [];const n=this.pageService.getPage(t);if(null==n||!n.isTextPage)return [];if(await new Promise((t=>{setTimeout((()=>{t(1);}),0);})),await this.textLoadService.loadText([t]),null==n||!n.isTextPage)return [];let s=e;return e.trim().length>0&&(s=e.trim()),s=s.replace(/\s+/g,"<<WHITESPACE>>"),s=fm(s),s=s.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(s=`(^|\\W)(${s})($|\\W)`),n.getSearchedText(new RegExp(s,"gm"+(null!=i&&i.caseSensitive?"":"i")),null==i?void 0:i.wholeWord)}async getSearchedTexts(t,e,i){if(0===e.length)return null;const n=this.documentService.getDocument(t);if(!n)return null;await this.textLoadService.loadText(n.pages);const s=[];let o=e;e.trim().length>0&&(o=e.trim()),o=o.replace(/\s+/g,"<<WHITESPACE>>"),o=fm(o),o=o.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(o=`(^|\\W)(${o})($|\\W)`);const r=new RegExp(o,"gm"+(null!=i&&i.caseSensitive?"":"i"));return n.pages.forEach(((t,e)=>{const n=this.pageService.getPage(t);if(n.isTextPage){const t=n.getSearchedText(r,null==i?void 0:i.wholeWord);s.push(...t);}})),s}async getSearchedTextPage(t,e,i){if(0===e.length)return null;const n=this.documentService.getDocument(t);if(!n)return null;await this.textLoadService.loadText(n.pages);let s=e;e.trim().length>0&&(s=e.trim()),s=s.replace(/\s+/g,"<<WHITESPACE>>"),s=fm(s),s=s.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(s=`(^|\\W)(${s})($|\\W)`);const o=[],r=new RegExp(s,"gm"+(null!=i&&i.caseSensitive?"":"i"));return n.pages.forEach(((t,e)=>{const n=this.pageService.getPage(t);if(n.isTextPage){const e=n.getSearchedText(r,null==i?void 0:i.wholeWord);e.length&&o.push({pageUid:t,texts:e});}})),o}createTextSearcher(t,e,i){return this.docTextSearchService.createDocTextSearcher(t,e,i)}};function fm(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function vm(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const{tag:i,style:n,id:s,className:o,children:r}=t,a=document.createElement(i);return s&&(a.id=s+e),o&&(a.className=o),n&&function(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(Gn(e))t.style.cssText=e;else if(i){let i="";Object.keys(e).forEach((t=>{i+=`${t}:${e[t]};`;})),t.style.cssText=i;}else Object.keys(e).forEach((i=>{t.style[i]=e[i];}));}(a,n),r&&r.forEach((t=>{const i=vm(t,e);a.appendChild(i);})),a}function mm(t){t&&(t.style.display="none");}function ym(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t&&(t.style.display=e);}const xm=t=>parseFloat(Number(t).toFixed(4));function wm(t){let e=1;return t.forEach((t=>{if(t.height>18){const i=t.height/18;e=Math.max(e,i);}})),Math.min(e,8)}function bm(t){return !!t&&("mouse"===t.pointerType||!jn()&&"pen"===t.pointerType)}class Sm extends js{constructor(){super(),i(this,"uid",void 0),i(this,"type",void 0),i(this,"action",void 0),i(this,"isValid",void 0),this.isValid=!0,this.uid=Jn();}execute(){return null}undo(){return null}}new class extends js{constructor(){super(...arguments),i(this,"docCreated",Gs(this)),i(this,"docDeleted",Gs(this)),i(this,"pageAdded",Gs(this)),i(this,"pageDeleted",Gs(this)),i(this,"annotationCreated",Gs(this)),i(this,"annotationDeleted",Gs(this)),i(this,"annotationUpdated",Gs(this)),i(this,"replyToAnnotation",Gs(this)),i(this,"commentDeleted",Gs(this)),i(this,"commentUpdated",Gs(this));}};class Cm extends Yo{static create(t){return new Cm(t,t.uid)}constructor(t,e){super(e),i(this,"type",void 0),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"style",void 0),i(this,"transform",void 0),i(this,"flags",void 0),i(this,"comment",void 0),i(this,"layer",void 0),i(this,"creationDate",void 0),i(this,"modified",!1),i(this,"flattened",!1),i(this,"oriIndex",void 0),i(this,"customData",{}),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"lines",void 0),i(this,"isBlankTextAssist",!1),i(this,"isMatchText",!1),i(this,"isPageTextLoaded",!1),i(this,"source",void 0),i(this,"parsedOriIndex",void 0),this.type=t.type,this.docUid=t.docUid,this.pageUid=t.pageUid,this.style=t.style,this.flags=t.flags||["print"],this.transform=t.transform,this.oriIndex=t.oriIndex,_n(null==t?void 0:t.modified)||(this.modified=t.modified),this.customData=t.customData||{},this.source=t.source||"file",this.parsedOriIndex=t.parsedOriIndex,this.initTextAssistCtrl(t);}initTextAssistCtrl(t){var e;if(["highlight","underline","strikeout"].includes(this.type))if(null!=t&&t.startCharRect&&null!=t&&t.endCharRect)this.startCharRect=t.startCharRect,this.endCharRect=t.endCharRect;else if(null!==(e=this.style.lines)&&void 0!==e&&e.length)if("api"===this.source||"file"===this.source){const t=16,e=this.style.lines[0],i=this.style.lines[this.style.lines.length-1];this.startCharRect={left:e.left,top:e.top,width:t,height:t},this.endCharRect={left:i.left+i.width-t,top:i.top,width:t,height:i.height};}else "user"===this.source&&(this.isMatchText=!0,this.isBlankTextAssist=!1,this.isPageTextLoaded=!0);}getConfig(){return {uid:this.uid,docUid:this.docUid,pageUid:this.pageUid,type:this.type,style:Nn(this.style),transform:Nn(this.transform),flags:Nn(this.flags),comment:Nn(this.comment),creationDate:this.comment.creationDate,modificationDate:this.comment.modificationDate,oriIndex:this.oriIndex,modified:this.modified,customData:Nn(this.customData),source:this.source,parsedOriIndex:this.parsedOriIndex,startCharRect:this.startCharRect,endCharRect:this.endCharRect}}clone(t,e){const i=Cm.create({docUid:this.docUid,pageUid:t,type:this.type,style:Nn(this.style),transform:Nn(this.transform),flags:this.flags.slice(),comment:this.comment,oriIndex:this.oriIndex,modified:this.modified,customData:Nn(this.customData),source:this.source,parsedOriIndex:this.parsedOriIndex}),n=this.comment.clone(i.uid,e);return i.comment=n,i.layer=this.layer,i}updateStyle(t){Object.assign(this.style,t);}updateComment(t){this.comment.updateComment(t);}addReplies(t){this.comment.replies.push(...t);}deleteReplies(t){const e=this.comment.replies;t.forEach((t=>{if(e.includes(t)){const i=e.findIndex((e=>e.uid===t.uid));e.splice(i,1);}}));}updateReply(t){const e=this.comment.replies.findIndex((e=>e.uid===t.uid));this.comment.replies[e]=t;}getAllReplies(){return [...this.comment.replies]}deleteReplyReviewSate(t){const e=this.comment.getReply(t);e&&e.deleteReviewState();}setReplyReviewState(t,e){const i=this.comment.getReply(t);i&&i.setReviewState(e);}deleteReplyMarkedSate(t){const e=this.comment.getReply(t);e&&e.deleteMarkedState();}setReplyMarkedState(t,e){const i=this.comment.getReply(t);i&&i.setMarkedState(e);}}class Pm{static create(t){return new Pm(t)}constructor(t){i(this,"uid",void 0),i(this,"author",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"state",void 0),this.uid=t.uid,this.author=t.author,this.contents=t.contents,this.creationDate=t.creationDate,this.state=t.state;}}class Tm{static create(t){return new Tm(t)}constructor(t){i(this,"uid",void 0),i(this,"author",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"state",void 0),this.uid=t.uid,this.author=t.author,this.contents=t.contents,this.creationDate=t.creationDate,this.state=t.state;}}class Am extends Go{static create(t,e){return new Am(t,e)}constructor(t,e){var n,s;super(e),i(this,"annotationUid",void 0),i(this,"author",void 0),i(this,"subject",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"modificationDate",void 0),i(this,"markedStates",void 0),i(this,"reviewStates",void 0),this.annotationUid=t.annotationUid,this.author=t.author,this.subject=t.subject,this.contents=t.contents,this.creationDate=t.creationDate,this.modificationDate=t.modificationDate,this.markedStates=[],this.reviewStates=[],null!==(n=t.markedStates)&&void 0!==n&&n.length&&t.markedStates.forEach((t=>{const e=Tm.create(t);this.markedStates.push(e);})),null!==(s=t.reviewStates)&&void 0!==s&&s.length&&t.reviewStates.forEach((t=>{const e=Pm.create(t);this.reviewStates.push(e);}));}updateReply(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,t);}setMarkedState(t){const e=this.markedStates.length,i=this.markedStates[e-1];if((null==i?void 0:i.state)!==t.state||!i&&"marked"===t.state){const e=Tm.create(t);return this.markedStates.push(e),!0}return !1}deleteMarkedState(){this.markedStates.pop();}setReviewState(t){const e=Pm.create(t);this.reviewStates.push(e);}deleteReviewState(){this.reviewStates.pop();}clone(t,e){const i=Am.create({annotationUid:t,author:this.author,subject:this.subject,contents:this.contents,creationDate:e,modificationDate:e});return this.cloneStates(i),i}cloneStates(t){this.markedStates.forEach((e=>{const i=Tm.create({...e,uid:Jn()});t.markedStates.push(i);})),this.reviewStates.forEach((e=>{const i=Pm.create({...e,uid:Jn()});t.reviewStates.push(i);}));}}class km extends Am{static create(t,e){return new km(t,e)}constructor(t,e){super(t,e),i(this,"replies",void 0),this.replies=[];}updateComment(t){Object.assign(this,t);}getReply(t){return this.replies.find((e=>e.uid===t.uid))}clone(t,e){const i=km.create({annotationUid:t,author:this.author,subject:this.subject,contents:this.contents,creationDate:e,modificationDate:e});return this.cloneStates(i),this.replies.forEach((n=>{i.replies.push(n.clone(t,e));})),i}}class Em extends Go{static create(t){return new Em(t)}constructor(t){super(t),i(this,"bottom",void 0),i(this,"top",void 0),i(this,"annotations",void 0),i(this,"layers",void 0),this.annotations=[],this.bottom=-1,this.top=0,this.layers=[];}clone(t){const e=Em.create(t);return e.top=this.top,e.bottom=this.bottom,e.annotations=this.annotations.slice(),e.layers=Nn(this.layers),e}createTop(){const{top:t}=this;return this.top+=1,t}addAnnotation(t,e){if(!this.annotations.includes(t)){this.annotations.push(t);const i={annotationUid:t,layer:e};return this.layers.push(i),_n(e)?(i.layer=this.top,this.top+=1):this.sortLayers(),i}return null}sortLayers(){this.layers.sort(((t,e)=>t.layer-e.layer));}deleteAnnotations(t){t.forEach((t=>{const e=this.annotations.indexOf(t);e>-1&&this.annotations.splice(e,1);const i=this.layers.findIndex((e=>e.annotationUid===t));i>-1&&this.layers.splice(i,1);}));}moveAnnotation(t){const e=this.annotations.indexOf(t);if(e<0)return null;const i=this.layers.findIndex((e=>e.annotationUid===t));if(i<0)return null;const n={annotationUid:t,index:e,layerIndex:i,layer:this.layers[i].layer};return this.deleteAnnotations([t]),n}undoMoveAnnotation(t){const{annotationUid:e}=t;this.annotations.includes(e)||this.layers.find((t=>t.annotationUid===e))||(this.annotations.splice(t.index,0,e),this.layers.splice(t.layerIndex,0,{annotationUid:e,layer:t.layer}));}bringForward(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e],n=this.layers[e+1];return n&&(this.switchLayer(i,n),this.sortLayers()),{curLayer:i,forward:n}}switchLayer(t,e){const i=t.layer;t.layer=e.layer,e.layer=i;}sendBackward(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e],n=this.layers[e-1];return n&&(this.switchLayer(i,n),this.sortLayers()),{curLayer:i,backward:n}}bringToFront(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e];return e<this.layers.length-1&&(i.layer=this.top,this.top+=1,this.sortLayers()),i}sendToBack(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e];return e>0&&(i.layer=this.bottom,this.bottom-=1,this.sortLayers()),i}restoreLayer(t,e){const i=this.layers.findIndex((e=>e.annotationUid===t));if(i<0)return null;return this.layers[i].layer=e,this.sortLayers(),!0}getLayerState(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return {back:!1,front:!1,forward:!1,backward:!1};const i={back:!0,front:!0,forward:!0,backward:!0};return 0===e&&(i.back=!1,i.backward=!1),e===this.layers.length-1&&(i.front=!1,i.forward=!1),1===this.layers.length&&(i.front=!1,i.forward=!1,i.back=!1,i.backward=!1),i}getAnnotationUidListByLayer(){return this.layers.slice().sort(((t,e)=>t.layer-e.layer)).map((t=>t.annotationUid))}}const Dm=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findAnnotationByUid(t){return this.db.get(t)}deleteAnnotation(t){return !!this.db.has(t.uid)&&(this.db.delete(t.uid),!0)}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}},Rm=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findCommentByUid(t){return this.db.get(t)}deleteComment(t){this.db.has(t.uid)&&this.db.delete(t.uid);}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}},Im=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findPageByUid(t){return this.db.get(t)}deletePagesByUids(t){t.forEach((t=>{this.db.delete(t);}));}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}};const Mm=new class extends js{constructor(){super(...arguments),i(this,"annotationCreated",Gs(this)),i(this,"annotationDeleted",Gs(this)),i(this,"annotationUpdated",Gs(this)),i(this,"commentDeleted",Gs(this)),i(this,"commentUpdated",Gs(this)),i(this,"replyToAnnotation",Gs(this)),i(this,"replyDeleted",Gs(this)),i(this,"replyUpdated",Gs(this)),i(this,"setReplyReviewState",Gs(this)),i(this,"deleteReplyReviewState",Gs(this)),i(this,"bringFroward",Gs(this)),i(this,"sendBackward",Gs(this)),i(this,"bringToFront",Gs(this)),i(this,"sendToBack",Gs(this)),i(this,"restoreLayer",Gs(this)),i(this,"annotationPageSwitched",Gs(this));}};class Bm extends qo{static create(t){return new Bm(t)}constructor(t){super("annotationCreatedDomainEvent"),i(this,"annotations",void 0),this.annotations=t;}}const Um=new class{constructor(t,e,n,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.annotationPageRepo=n,this.eventHooks=s;}execute(t){const e=t.map((t=>{const e=Cm.create({...t}),i=this.annotationPageRepo.findPageByUid(e.pageUid).addAnnotation(e.uid,t.layer);if(i&&(e.layer=i.layer),this.annotationRepo.save(e),t.comment){var n;const i=km.create(t.comment);e.comment=i,null!==(n=t.comment.replies)&&void 0!==n&&n.length&&t.comment.replies.forEach((t=>{const e=Am.create(t);i.replies.push(e),this.replyRepo.save(e);}));}return _n(null==t?void 0:t.flattened)||(e.flattened=t.flattened),e})),i=Bm.create(e);return this.eventHooks.annotationCreated.emit(i),e}}(Dm,Rm,Im,Mm);class Lm extends qo{static create(t,e){return new Lm(t,e)}constructor(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];super("annotationDeletedDomainEvent"),i(this,"annotations",void 0),i(this,"emitEvent",void 0),this.annotations=t,this.emitEvent=e;}}const Om=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHooks=n;}execute(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];for(const e of t){if(!this.annotationRepo.has(e))return !1}t.forEach((t=>{this.annotationRepo.deleteAnnotation(t);this.annotationPageRepo.findPageByUid(t.pageUid).deleteAnnotations([t.uid]);}));const i=Lm.create(t,e);return this.eventHooks.annotationDeleted.emit(i),!0}}(Dm,Im,Mm);const Wm=new class{constructor(t){i(this,"annotationRepo",void 0),this.annotationRepo=t;}execute(t){return this.annotationRepo.findAnnotationByUid(t)}}(Dm);class Nm extends qo{static create(t){return new Nm(t)}constructor(t){super("replyToAnnotationDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const _m=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=n;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid),i=Am.create({annotationUid:t.annotationUid,author:t.author,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modifiedDate,subject:""});e.addReplies([i]),this.replyRepo.save(i);const n=Nm.create(i);return this.eventHooks.replyToAnnotation.emit(n),!0}}(Dm,Rm,Mm);class Fm extends qo{static create(t,e,i){return new Fm(t,e,i)}constructor(t,e,n){super("annotationUpdatedDomainEvent"),i(this,"updateDetails",void 0),i(this,"updatedBy",void 0),i(this,"updateActions",void 0),this.updateDetails=t,this.updatedBy=e,this.updateActions=n;}}const Hm=new class{constructor(t,e){i(this,"annotationRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.eventHooks=e;}execute(t){const e=[],i=t.updateDetails.map((t=>{const i=this.annotationRepo.findAnnotationByUid(t.uid);if(!i)return null;const n=i.getConfig();t.style&&i.updateStyle(t.style),t.transform&&Ws(t.transform,i.transform),t.flags&&(i.flags=[...t.flags]),_n(t.flattened)||(i.flattened=t.flattened),_n(t.layer)||(i.layer=t.layer),_n(t.startCharRect)||(i.startCharRect=t.startCharRect),_n(t.endCharRect)||(i.endCharRect=t.endCharRect),_n(t.startTextPosition)||(i.startTextPosition=t.startTextPosition),_n(t.endTextPosition)||(i.endTextPosition=t.endTextPosition),i.modified=t.modified,t.comment&&Object.assign(i.comment,t.comment),this.annotationRepo.save(i);const s=i.getConfig();return e.push({annotationUid:i.uid,from:n,to:s}),i})),n=Fm.create(e,t.updatedBy,t.updateActions);return this.eventHooks.annotationUpdated.emit(n),i}}(Dm,Mm);class Vm extends qo{static create(t){return new Vm(t)}constructor(t){super("replyUpdatedDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const zm=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=n;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;const i=this.replyRepo.findCommentByUid(t.replyUid);if(!i)return !1;i.updateReply({author:t.author,contents:t.contents,modifiedDate:t.modifiedDate}),e.updateReply(i),this.annotationRepo.save(e),this.replyRepo.save(i);const n=Vm.create(i);return this.eventHooks.replyUpdated.emit(n),!0}}(Dm,Rm,Mm);class $m extends qo{static create(t){return new $m(t)}constructor(t){super("replyDeletedDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const jm=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=n;}execute(t){if(!this.replyRepo.has(t))return !1;const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;e.deleteReplies([t]),this.replyRepo.deleteComment(t);const i=$m.create(t);return this.eventHooks.replyDeleted.emit(i),!0}}(Dm,Rm,Mm);class Xm extends qo{static create(t,e,i){return new Xm(t,e,i)}constructor(t,e,n){super("bringToFrontDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=n;}}const Gm=new class{constructor(t,e,n){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=n;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),n=i.getAnnotationUidListByLayer(),s=i.bringToFront(t);if(!s)return !1;e.layer=s.layer;const o=i.getAnnotationUidListByLayer(),r=Xm.create(t,n,o);return this.eventHooks.bringToFront.emit(r),!0}}(Dm,Im,Mm);class Ym extends qo{static create(t,e,i){return new Ym(t,e,i)}constructor(t,e,n){super("sendToBackDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=n;}}const qm=new class{constructor(t,e,n){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=n;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),n=i.getAnnotationUidListByLayer(),s=i.sendToBack(t);if(!s)return !1;e.layer=s.layer;const o=i.getAnnotationUidListByLayer(),r=Ym.create(t,n,o);return this.eventHooks.sendToBack.emit(r),!0}}(Dm,Im,Mm);class Jm extends qo{static create(t,e,i,n){return new Jm(t,e,i,n)}constructor(t,e,n,s){super("bringForwardDomainEvent"),i(this,"annotationUid",void 0),i(this,"forwardUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.forwardUid=e,this.from=n,this.to=s;}}const Zm=new class{constructor(t,e,n){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=n;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),n=i.getAnnotationUidListByLayer(),s=i.bringForward(t);if(!s)return !1;const{curLayer:o,forward:r}=s;if(e.layer=o.layer,r){this.annotRepo.findAnnotationByUid(r.annotationUid).layer=r.layer;}const a=i.getAnnotationUidListByLayer(),l=Jm.create(t,null==r?void 0:r.annotationUid,n,a);return this.eventHooks.bringFroward.emit(l),!0}}(Dm,Im,Mm);class Qm extends qo{static create(t,e,i,n){return new Qm(t,e,i,n)}constructor(t,e,n,s){super("sendBackwardDomainEvent"),i(this,"annotationUid",void 0),i(this,"backwardUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.backwardUid=e,this.from=n,this.to=s;}}const Km=new class{constructor(t,e,n){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=n;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),n=i.getAnnotationUidListByLayer(),s=i.sendBackward(t);if(!s)return !1;const{curLayer:o,backward:r}=s;if(e.layer=o.layer,r){this.annotRepo.findAnnotationByUid(r.annotationUid).layer=r.layer;}const a=i.getAnnotationUidListByLayer(),l=Qm.create(t,null==r?void 0:r.annotationUid,n,a);return this.eventHooks.sendBackward.emit(l),!0}}(Dm,Im,Mm);class ty extends qo{static create(t){return new ty(t)}constructor(t){super("commentUpdatedDomainEvent"),i(this,"comment",void 0),this.comment=t;}}const ey=new class{constructor(t,e){i(this,"annotationRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.eventHooks=e;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;e.updateComment(t);const i=ty.create(e.comment);return this.eventHooks.commentUpdated.emit(i),!0}}(Dm,Mm);class iy extends qo{static create(t){return new iy(t)}constructor(t){super("deleteReplyReviewStateDomainEvent"),i(this,"replyUid",void 0),this.replyUid=t;}}const ny=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=n;}execute(t){const e=this.replyRepo.findCommentByUid(t);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.deleteReplyReviewSate(e),this.annotationRepo.save(i);const n=iy.create(t);return this.eventHooks.deleteReplyReviewState.emit(n),!0}}(Dm,Rm,Mm);class sy extends qo{static create(t){return new sy(t)}constructor(t){super("setReplyReviewStateDomainEvent"),i(this,"author",void 0),i(this,"creationDate",void 0),i(this,"contents",void 0),i(this,"state",void 0),i(this,"replyUid",void 0),this.author=t.author,this.creationDate=t.creationDate,this.contents=t.contents,this.state=t.state,this.replyUid=t.replyUid;}}const oy=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=n;}execute(t){const e=this.replyRepo.findCommentByUid(t.replyUid);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.setReplyReviewState(e,t),this.annotationRepo.save(i);const n=sy.create(t);return this.eventHooks.setReplyReviewState.emit(n),!0}}(Dm,Rm,Mm);const ry=new class{constructor(t){i(this,"annotationPageRepo",void 0),this.annotationPageRepo=t;}execute(t){let e=this.annotationPageRepo.findPageByUid(t);return e||(e=Em.create(t),this.annotationPageRepo.save(e)),e}}(Im);const ay=new class{constructor(t,e,n){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e,this.replyRepo=n;}execute(t){const e=this.annotationPageRepo.findPageByUid(t.pageUid);if(!e)return null;const i=e.clone(t.newPageUid),n=new Map;return e.annotations.forEach(((e,s)=>{const o=this.annotationRepo.findAnnotationByUid(e).clone(t.newPageUid,"");o.comment.replies.forEach((t=>{this.replyRepo.save(t);})),this.annotationRepo.save(o),i.annotations[s]=o.uid,n.set(e,o.uid);})),i.layers.forEach((t=>{t.annotationUid=n.get(t.annotationUid);})),this.annotationPageRepo.save(i),i}}(Im,Dm,Rm);const ly=new class{constructor(t){i(this,"annotationPageRepo",void 0),this.annotationPageRepo=t;}execute(t){this.annotationPageRepo.deletePagesByUids(t);}}(Im);const hy=new class{constructor(t,e,n){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e,this.replyRepo=n;}execute(t){const e=this.annotationPageRepo.findPageByUid(t.pageUid);if(!e)return null;const i=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!i)return null;const n=i.clone(t.pageUid," ");return n.comment.replies.forEach((t=>{this.replyRepo.save(t);})),e.addAnnotation(n.uid),this.annotationRepo.save(n),n}}(Im,Dm,Rm);class cy extends qo{static create(t,e,i){return new cy(t,Nn(e),Nn(i))}constructor(t,e,n){super("annotationPageSwitchedDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=n;}}const dy=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHook",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHook=n;}execute(t){const{annotationUid:e,pageUid:i,x:n,y:s,layer:o}=t,r=this.annotationRepo.findAnnotationByUid(e);if(!r)return !1;const a=this.annotationPageRepo.findPageByUid(r.pageUid);if(!a)return !1;const l=this.annotationPageRepo.findPageByUid(i);if(!l)return !1;const h={pageUid:r.pageUid,x:r.style.x,y:r.style.y,layer:r.layer};a.deleteAnnotations([e]),l.addAnnotation(e,o),r.updateStyle({x:n,y:s}),r.layer=o,r.pageUid=i;const c=cy.create(r.uid,h,{pageUid:i,x:n,y:s,layer:o});return this.eventHook.annotationPageSwitched.emit(c),!0}}(Dm,Im,Mm);class uy extends qo{static create(t,e){return new uy(t,e)}constructor(t,e){super("restoreLayerDomainEvent"),i(this,"annotationUid",void 0),i(this,"layer",void 0),this.annotationUid=t,this.layer=e;}}const py=new class{constructor(t,e,n){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHooks=n;}execute(t){let{annotationUid:e,layer:i}=t;const n=this.annotationRepo.findAnnotationByUid(e);if(!n)return !1;this.annotationPageRepo.findPageByUid(n.pageUid).restoreLayer(e,i),n.layer=i;const s=uy.create(e,i);return this.eventHooks.restoreLayer.emit(s),!0}}(Dm,Im,Mm);const gy=new class{constructor(t,e){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e;}execute(t){let e={back:!1,front:!1,forward:!1,backward:!1};const i=this.annotationRepo.findAnnotationByUid(t);if(!i)return e;const n=this.annotationPageRepo.findPageByUid(i.pageUid);return n?(e=n.getLayerState(t),e):e}}(Im,Dm);class fy extends js{constructor(){super(),i(this,"annotationRepo",Dm),i(this,"annotationReplyRepo",Rm),i(this,"annotationPageRepo",Im),i(this,"hooks",Mm),this.register(Mm);}dispose(){this.reset(),this.hooks.dispose(),super.dispose();}reset(){this.annotationPageRepo.clear(),this.annotationReplyRepo.clear(),this.annotationRepo.clear();}createAnnotationPage(t){return ry.execute(t)}copyAnnotationPage(t,e){return ay.execute({pageUid:t,newPageUid:e})}deleteAnnotationPage(t){return ly.execute(t)}createAnnotations(t){return Um.execute(t)}copyAnnotation(t,e){return hy.execute({annotationUid:t,pageUid:e})}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=t.map((t=>(Gn(t)&&(t=Dm.findAnnotationByUid(t)),t)));return Om.execute(i,e)}updateAnnotation(t){return Hm.execute(t)}switchAnnotationPage(t,e){return dy.execute({annotationUid:Wn(t)?t.uid:t,...e})}getAnnotationByUid(t){return Wm.execute(t)}getAnnotationLayerState(t){return gy.execute(t)}replyToAnnotation(t){return _m.execute(t)}deleteReply(t){return Gn(t)&&(t=Rm.findCommentByUid(t)),jm.execute(t)}updateReply(t){return zm.execute(t)}updateComment(t){return ey.execute(t)}deleteReplyReviewState(t){return ny.execute(t)}setReplyReviewState(t){return oy.execute(t)}bringToFront(t){return Gm.execute(t)}sendToBack(t){return qm.execute(t)}bringForward(t){return Zm.execute(t)}sendBackward(t){return Km.execute(t)}restoreLayer(t,e){return py.execute({annotationUid:t,layer:e})}}const vy=["enableContinuousDrawing","controlsStyle","inkCreateDelay","showOnTopWhenSelected","defaultStyleConfig","eraserStyle","selectionStyle","enableMoveWithKeyboard","enableDeleteWithKeyboard","enableMultipleSelectWidthCtrl"];class my extends js{constructor(t){super(),i(this,"context",void 0),this.context=t;}updateConfig(t){for(const[e,i]of Object.entries(t))vy.includes(e)&&this[e](i);}defaultStyleConfig(t){if(!Wn(t))return;const{annotationController:e}=this.context,{viewer:i}=this.context;e.setAnnotationInteractiveConfig({defaultStyleConfig:t}),e.updateFreeTextDefaultConfig(),i.hooks.annotationDefaultStyleChanged.emit(i.getAnnotationConfig().defaultStyleConfig);}enableContinuousDrawing(t){const{annotationController:e}=this.context;e.interactiveConfig.enableContinuousDrawing=t;}enableMoveWithKeyboard(t){const{annotationController:e}=this.context;e.interactiveConfig.enableMoveWithKeyboard=t;}enableDeleteWithKeyboard(t){const{annotationController:e}=this.context;e.interactiveConfig.enableDeleteWithKeyboard=t;}enableMultipleSelectWidthCtrl(t){const{annotationController:e}=this.context;e.interactiveConfig.enableMultipleSelectWidthCtrl=t;}controlsStyle(t){if(!Wn(t))return;const{annotationController:e}=this.context;e.setAnnotationInteractiveConfig({controlsStyle:t});}inkCreateDelay(t){const{annotationController:e}=this.context;e.interactiveConfig.inkCreateDelay=t;}showOnTopWhenSelected(t){const{annotationController:e}=this.context;e.interactiveConfig.showOnTopWhenSelected=t;}}class yy{constructor(t,e){i(this,"shape",void 0),i(this,"ctx",void 0),i(this,"page",void 0),i(this,"isHitStartCtrl",!1),i(this,"isHitEndCtrl",!1),i(this,"oldStartTextPosition",void 0),i(this,"oldEndTextPosition",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"lines",void 0),i(this,"startPoint",void 0),i(this,"isPointerdown",void 0),i(this,"isEditing",!1),i(this,"isEdited",!1),i(this,"isMatchText",!1),this.ctx=t,this.page=e;}setShape(t){this.shape=t;}isHitPoint(t){const e=this.canvasToMediaBox(t);return this.isHitStartCtrl=this.shape.isPointOnStartCtrl(e),this.isHitEndCtrl=this.shape.isPointOnEndCtrl(e),!this.isHitStartCtrl&&!this.isHitEndCtrl||this.isCtrlPointOoutOfCropBox()?this.shape.isPointOnBody(e)?(this.isCtrlPointOoutOfCropBox(),9):-1:10}isCtrlPointOoutOfCropBox(){const t=this.ctx.context.core.pageService.getPage(this.page.uid);if(null==t||!t.isTextPage)return !0;let e=!1;const{bounds:i}=this.shape,{cropBox:n}=t;if((i.left<n.left||i.top<n.top||i.left+i.width>n.left+n.width||i.top+i.height>n.top+n.height)&&(e=!0),this.shape.startCharRect){fv({x:this.shape.startCharRect.left,y:this.shape.startCharRect.top},t.cropBox)||(e=!0);}else e=!0;if(this.shape.endCharRect){fv({x:this.shape.endCharRect.left,y:this.shape.endCharRect.top},t.cropBox)||(e=!0);}else e=!0;return this.shape.isOutOfCropBox=e,e}startHandler(t){const e=this.ctx.context.core.annotationService.getAnnotationByUid(this.shape.id);if(e.isBlankTextAssist)return;const i=this.ctx.context.core.pageService.getPage(this.page.uid);if(null==i||!i.isTextPage)return;if(this.isCtrlPointOoutOfCropBox())return;const n=this.canvasToMediaBox(t);if(this.isHitStartCtrl=this.shape.isPointOnStartCtrl(n),this.isHitEndCtrl=this.shape.isPointOnEndCtrl(n),!this.isHitStartCtrl&&!this.isHitEndCtrl)return;const{annotationEditService:s}=this.ctx.context;if(s.isPointerType&&s.renderMagnifier(t),this.shape.startTextPosition)this.oldStartTextPosition={...this.shape.startTextPosition},this.oldEndTextPosition={...this.shape.endTextPosition},this.startTextPosition={...this.shape.startTextPosition},this.endTextPosition={...this.shape.endTextPosition};else if(e.isMatchText){const t=this.ctx.context.getActiveTab(),e=this.ctx.context.calcTextStartPosition({x:this.shape.startCharRect.left+8,y:this.shape.startCharRect.top+8},this.page,t,!0),i=this.ctx.context.calcTextStartPosition({x:this.shape.endCharRect.left+8,y:this.shape.endCharRect.top+8},this.page,t,!0);this.oldStartTextPosition={...e},this.oldEndTextPosition={...i},this.startTextPosition={...e},this.endTextPosition={...i},this.shape.startTextPosition={...e},this.shape.endTextPosition={...i};}else {const t=this.ctx.matchText(e);if(!t)return;this.isMatchText=!0;const{startTextPosition:i,endTextPosition:n}=t;this.oldStartTextPosition={...i},this.oldEndTextPosition={...n},this.startTextPosition={...i},this.endTextPosition={...n},this.shape.startTextPosition={...i},this.shape.endTextPosition={...n};}this.startPoint=t,this.isPointerdown=!0;}moveHandler(t){if(!this.isPointerdown)return;const e=this.ctx.context.getActiveTab();if(null==e||!e.total)return;const{page:i}=this,n=this.ctx.context.core.pageService.getPage(i.uid);if(this.ctx.context.core.annotationService.getAnnotationByUid(this.shape.id),null!=n&&n.isTextPage)if(this.isHitStartCtrl)this.isEditing=!0,this.isHitStartCtrl=!1,this.startTextPosition={...this.shape.endTextPosition};else if(this.isHitEndCtrl)this.isEditing=!0,this.isHitEndCtrl=!1,this.startTextPosition={...this.shape.startTextPosition};else if(this.isEditing){if(null==n||!n.visibleLines)return;const s=this.ctx.context.calcTextEndPosition(t,i,e,this.startTextPosition.mediaBoxPoint);if(s){this.endTextPosition=s;const{textPages:t,startCharRect:e,endCharRect:i,startTextPosition:n,endTextPosition:o}=this.ctx.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);this.isEdited=!0,this.startCharRect=e,this.endCharRect=i,this.shape.startCharRect=e,this.shape.endCharRect=i,this.shape.startTextPosition=n,this.shape.endTextPosition=o;const r=t[0].lines.map((t=>t.selectedRect));this.lines=r,this.shape.updateStyle({lines:r});}const{annotationEditService:o}=this.ctx.context;o.isPointerType&&(o.isRenderMagnifier=!0,o.magnifierPoint=t);}}endHandler(){if(this.isEdited){const t=this.isSameTextSelectedPosition(this.startTextPosition,this.oldStartTextPosition),e=this.isSameTextSelectedPosition(this.endTextPosition,this.oldEndTextPosition);if(!t||!e||this.isMatchText){const t=wm(this.lines);this.shape.style.borderWidth=t,this.ctx.annotationController.hooks.emitModifyAnnotation(["resized"],[this.shape]);}}this.isEdited=!1,this.isPointerdown=!1,this.isHitStartCtrl=!1,this.isHitEndCtrl=!1,this.isEditing=!1,this.isMatchText=!1,this.ctx.context.render("endEditTextAssist");}canvasToMediaBox(t){const{page:e}=this,i=this.ctx.context.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);return {x:i.pointerX,y:i.pointerY}}isSameTextSelectedPosition(t,e){return t.pageUid===e.pageUid&&t.lineIndex===e.lineIndex&&t.charIndex===e.charIndex}}const xy={arc:"annotationArc",circle:"annotationCircle",ellipse:"annotationEllipse",image:"annotationImage",ink:"annotationInk",rectangle:"annotationRect",line:"annotationLine",polyline:"annotationPolyline",polygon:"annotationPolygon",textTypewriter:"annotationFreeText",textBox:"annotationTextBox",stamp:"annotationStamp",textAssist:"annotationTextAssist",highlight:"annotationHighlight",underline:"annotationUnderline",strikeout:"annotationStrikeout",incomplete:"annotationIncomplete"},wy={annotationArc:"arc",annotationCircle:"circle",annotationEllipse:"ellipse",annotationImage:"image",annotationInk:"ink",annotationRect:"rectangle",annotationLine:"line",annotationPolyline:"polyline",annotationPolygon:"polygon",annotationFreeText:"textTypewriter",annotationTextBox:"textBox",annotationStamp:"stamp",annotationTextAssist:"textAssist",annotationHighlight:"highlight",annotationUnderline:"underline",annotationStrikeout:"strikeout"};class by extends js{constructor(t){super(),i(this,"viewer",void 0),i(this,"annotationConfigService",void 0),i(this,"annotationController",void 0),i(this,"context",void 0),this.viewer=t,this.context=t.context,this.annotationConfigService=new my(this),this.initAnnotationController(),this.listenViewerEventsForAnnotation(),this.context.core.editService.onAfterCropPages.on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&t.pageUids.forEach((t=>{const i=e.getPageByUid(t);i&&i.mediaBox.childNodes.forEach((t=>{this.isTextAssistType(t.textAssistType)&&(t.startTextPosition=null);}));}));}),this);}isTextAssistType(t){return ["highlight","underline","strikeout"].includes(t)}initAnnotationController(){(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&((new kc).init(this.context.rendererService.docRenderer.canvas),this.annotationController=new hc(this.context.rendererService.getCanvasDom()),this.listenViewerNativeEventsForAnnotation(),this.annotationController.hooks.deleteAnnotation.on((t=>{const e=new Set(t.shapes.map((t=>t.uid)));this.context.core.annotationService.deleteAnnotations([...e]);}),this),this.annotationController.hooks.selectAnnotation.on((t=>{const e=Df.create(t.oldAnnotationsUids,t.newAnnotationUids);this.syncAnnotationLayerState(),this.viewer.hooks.selectedAnnotationsChanged.emit(e),t.emitSelected&&this.viewer.emit("selectedAnnotationsChanged",{newAnnotationUids:[...t.newAnnotationUids],oldAnnotationUids:[...t.oldAnnotationsUids]});}),this),this.annotationController.hooks.modifyAnnotation.on((t=>{const e=t.shapes.map((t=>{const e=t.shape.getAnnotationConfig();return {annotationUid:t.uid,options:{transform:Nn(e.transform),style:e.style,selectableStyle:e.selectableStyle,startCharRect:e.startCharRect,endCharRect:e.endCharRect,startTextPosition:e.startTextPosition,endTextPosition:e.endTextPosition}}}),this);this.context.core.annotationService.updateAnnotations(e,this.context.uid,t.actions);}),this),this.annotationController.hooks.addAnnotation.on((t=>{const e=this.context.getActiveTab();if(!e)return;const{annotationService:i}=this.context.core;t.shapes.forEach((t=>{const n=t.shape.getAnnotationConfig(),s=Zf(),o=["print"];t.shape instanceof xh&&"freeTextWriter"===t.shape.textType&&o.push("noRotate","noResize"),(t.shape instanceof Th||t.shape instanceof Ch||t.shape instanceof Ph)&&o.push("noRotate");const r=i.createAnnotation(e.uid,{uid:t.uid,docUid:e.uid,pageUid:t.shape.pageUid,type:wy[n.type],transform:Nn(n.transform),style:Nn(n.style),flags:o,comment:{annotationUid:t.uid,author:"",subject:"",contents:"",creationDate:s,modificationDate:s,markedStates:[],reviewStates:[],replies:[]},source:"user"});this.annotationController.updateLayer(t.uid,r.layer);}));}),this),this.annotationController.hooks.annotationModeChanged.on((t=>{"none"===t&&this.exitAnnotationMode();}),this),this.annotationController.hooks.beforeAnnotationEdit.on((t=>{this.viewer.hooks.beforeAnnotationEdit.emit(t);}),this),this.annotationController.hooks.afterAnnotationEdit.on((t=>{this.viewer.hooks.afterAnnotationEdit.emit(t);}),this),this.annotationController.hooks.beforeAnnotationDraw.on((t=>{this.viewer.hooks.beforeAnnotationDraw.emit(t);}),this),this.annotationController.hooks.afterAnnotationDraw.on((t=>{this.viewer.hooks.afterAnnotationDraw.emit(t);}),this),this.annotationController.hooks.renderAnnotation.on((()=>{var t;null===(t=this.context)||void 0===t||t.render("renderAnnotationFromController");}),this),this.annotationController.hooks.selectAnnotationTextChars.on((t=>{this.viewer.hooks.annotationTextCharsSelected.emit(t);}),this),this.annotationController.hooks.annotationTextContentUpdated.on((t=>{this.viewer.hooks.annotationTextContentUpdated.emit(t);}),this));}exitAnnotationMode(){"annotation"===this.viewer.getViewerConfig().toolMode&&this.viewer.updateViewerConfig({toolMode:"pan"});}listenViewerNativeEventsForAnnotation(){const t=this.context.rendererService.getCanvasDom();Ys(t,jn()?"click":"pointerup",this).on((t=>{t.preventDefault(),this.annotationController.clickHandler(t);})),Ys(t,"dblclick",this).on((t=>{this.annotationController.dblClickHandler(t);}));}listenViewerEventsForAnnotation(){const{context:t,context:{hooks:e,tabService:i}}=this;(t.isDefaultViewer||t.isThumbnailViewer)&&(e.pageExistenceChanged.on((t=>{0===t.pageCount&&(this.annotationController.container=null,this.annotationController.containerId=null,this.context.annotationEditService.containerPage=null,this.annotationController.clearShapeArrMap());}),this),e.toolModeChanged.on((e=>{const{annotationMode:i}=t.viewerConfig;if("annotation"!==e.newToolMode)this.annotationController.setAnnotationMode("none"),"crop"!==e.newToolMode&&"textSelection"!==e.newToolMode||this.selectAnnotations([]);else {let t="draw";"select"===i?t="select":"erase"===i&&(t="erase"),this.annotationController.setAnnotationMode(t);}}),this),e.annotationModeChanged.on((e=>{const{toolMode:i}=t.viewerConfig;if("select"===e.newAnnotationMode||"erase"===e.newAnnotationMode){const t=e.newAnnotationMode;"annotation"===i&&this.annotationController.setAnnotationMode(t);}else {const t=xy[e.newAnnotationMode];this.annotationController.drawType=t,"annotation"===i&&this.annotationController.setAnnotationMode("draw");}}),this),e.addPagesToDoc.on((t=>{i.getTab(t.docUid)&&this.addAnnotationByPageUids(t.pageUids);}),this),e.openDocument.on((t=>{i.getTab(t.uid)&&(this.selectAnnotations([]),this.addAnnotationByPageUids(t.pages));}),this),e.closeDocument.on((t=>{t.pages.forEach((t=>{const e=this.context.core.pageService.getPage(t);this.annotationController.deleteShape(e.annotations,!1,!1);})),this.annotationController.clearShapeArrMap();}),this),e.deletePages.on((t=>{t.pageUids.forEach((t=>{const e=this.context.core.pageService.getPage(t);this.annotationController.deleteShape(e.annotations,!1,!1),this.annotationController.deleteShapeArrMap(t);}));}),this),e.syncDocument.on((t=>{i.getTab(t.uid)&&(this.selectAnnotations([]),this.addAnnotationByPageUids(t.pages));}),this),e.afterRender.on((e=>{if(null==e||!e.total)return;const i=t.annotationEditService.containerPage;if(!i)return;if(!e.getPageByUid(i.uid))return;let{x:n,y:s}=i.cropBox.getPosition(),{width:o,height:r}=i.cropBox;const a=(i.rotation%360+360)%360/90;if(1===a?n-=r:2===a?(n-=o,s-=r):3===a&&(s-=o),1===a||3===a){const t=o;o=r,r=t;}this.annotationController.eventService.setEventArea({left:n,top:s,width:o,height:r});}),this));}disableTextEditMode(){const{eventService:t}=this.annotationController;null!=t&&t.activatedShape&&(null==t?void 0:t.activatedShape)instanceof xh&&null!=t&&t.activatedShape.isEditMode&&(null==t||t.activatedShape.textEditEventHandler.disableEditMode(),this.context.render("disableTextEditMode"));}addAnnotationByPageUids(t){t.forEach((t=>{const e=this.context.core.pageService.getPage(t);if(e.annotations.forEach((t=>{const e=this.context.core.annotationService.annotationApp.getAnnotationByUid(t);this.addAnnotationByAnnotationData(e);})),0===e.annotations.length){const t=this.context.tabService.getTab(e.doc.uid);if(!t)return;const i=t.getPageByUid(e.uid);if(!i)return;this.annotationController.setAnnotationContainer(e.uid,i.mediaBox);}}));}addAnnotationByAnnotationData(t){if("unknown"===t.type)return !0;const e=this.context.core.pageService.getPage(t.pageUid);if(!e)return !1;const i=this.context.tabService.getTab(e.doc.uid);if(!i)return !1;const n=i.getPageByUid(t.pageUid);if(!n)return !1;let s=t.getConfig();this.annotationController.setAnnotationContainer(t.pageUid,n.mediaBox);const o=this.isTextAssistType(t.type),r=this.annotationController.addShape(xy[t.type],{id:t.uid,style:{...s.style,zIndex:t.layer},transform:s.transform},!1,o?new yy(this,n):void 0);o&&(r.startCharRect=t.startCharRect,r.endCharRect=t.endCharRect),s=t.getConfig();const a={enableControl:!s.flags.includes("readOnly")&&!s.flags.includes("flattened"),isVisible:!s.flags.includes("noView"),enableEdit:!s.flags.includes("noResize"),enableRotate:!s.flags.includes("noRotate"),enableMove:!s.flags.includes("noMove")};if(r instanceof xh&&"freeTextWriter"===r.textType){a.enableEdit=!1,a.enableRotate=!1;const e=r.getAnnotationConfig();t.style.width=e.style.width;}if(r.context.isInGroup&&(a.enableRotate=!1),this.annotationController.setAnnotationFlags(t.uid,a,!1),r instanceof Nh&&"base"===r.stampType||r instanceof fh){const e=r.getAnnotationConfig();t.transform.position=e.transform.position,t.transform.scale=e.transform.scale,t.style=e.style;}return this.syncAnnotationLayerState(),!0}updateAnnotations(t,e,i,n){if(e===this.context.uid)return !0;const s=t.reduce(((t,e)=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(e);if(i){const n=this.context.core.pageService.getPage(i.pageUid);if(n){if(this.context.tabService.getTab(n.doc.uid)){const n=i.getConfig();t.push({annotationUid:e,config:n}),this.viewer.context.core.annotationService.annotationApp.restoreLayer(e,i.layer);}}}return t}),[]);return s.length===t.length&&(s.forEach(((t,e)=>{var s,o;let{annotationUid:r,config:a}=t;const l=this.annotationController.getShape(r),h={enableControl:!a.flags.includes("readOnly")&&!a.flags.includes("flattened"),isVisible:!a.flags.includes("noView"),enableEdit:!a.flags.includes("noResize"),enableRotate:!a.flags.includes("noRotate"),enableMove:!a.flags.includes("noMove")};if(l&&l.context.isInGroup&&(l.context.tempData.enableRotate=h.enableRotate,h.enableRotate=!1),this.annotationController.setAnnotationFlags(r,h,!1),i||this.annotationController.updateShape(r,{id:r,style:a.style,transform:a.transform},!1),!l)return;const c=this.context.core.annotationService.annotationApp.getAnnotationByUid(r),d=l.getAnnotationConfig();if(this.isTextAssistType(c.type)){const t=n[e].to;l.startCharRect=t.startCharRect,l.endCharRect=t.endCharRect,l.startTextPosition=t.startTextPosition,l.endTextPosition=t.endTextPosition;}null!=d&&null!==(s=d.transform)&&void 0!==s&&s.position&&(c.transform.position=d.transform.position),null!=d&&null!==(o=d.transform)&&void 0!==o&&o.scale&&(c.transform.scale=d.transform.scale),l instanceof Nh&&"stamp"===l.renderType&&(c.style.stampConfig=d.style.stampConfig);})),!0)}updateAnnotationPage(t,e){const i=this.context.core.annotationService.getAnnotationByUid(t);if(!i)return;const n=this.context.core.pageService.getPage(i.pageUid);if(!n)return;const s=this.context.tabService.getTab(n.doc.uid);if(!s)return;const o=s.getPageByUid(e);o&&(this.annotationController.moveShape([t],e,o.mediaBox),this.syncAnnotationLayerState());}updateLayer(t){const e=t.reduce(((t,e)=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(e);if(i){const e=this.context.core.pageService.getPage(i.pageUid);if(e){this.context.tabService.getTab(e.doc.uid)&&t.push(i);}}return t}),[]);return e.length===t.length&&(e.forEach((t=>{this.annotationController.updateLayer(t.uid,t.layer);})),this.syncAnnotationLayerState(),!0)}syncAnnotationLayerState(){let t={back:!1,front:!1,forward:!1,backward:!1};const e=this.annotationController.getSelectedShapeUids();return 1===e.length&&(t=this.context.core.annotationService.getAnnotationLayerState(e[0])),this.viewer.hooks.annotationLayerStateChanged.emit(kf.create(t)),t}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.annotationController.deleteShape(t,!1,e),this.syncAnnotationLayerState();}selectAnnotations(t){return this.annotationController.selectShape(t)}getSelectedAnnotations(){const t=this.annotationController.getSelectedShapeUids();if(!t.length)return [];const e=[];return t.forEach((t=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(t);i&&e.push(i);})),e}matchText(t){var e;const i=this.context.core.pageService.getPage(t.pageUid);if(!i)return null;const{lines:n}=t.style;if(!i.isTextPage||null===(e=i.visibleLines)||void 0===e||!e.length||null==n||!n.length)return t.isMatchText=!0,t.isBlankTextAssist=!0,null;let s,o,r=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,l=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;if(n.forEach((t=>{i.visibleLines.forEach(((e,i)=>{if(gv(e,t)){if(l>i){l=i,r=Number.MAX_SAFE_INTEGER;const n=e.chars.findIndex((e=>gv(e.charBox,t)));r>n&&(r=n,s=e.chars[n].charBox);}if(h<i){h=i,a=Number.MIN_SAFE_INTEGER;let n=-1;for(let i=e.chars.length-1;i>=0;i--)if(gv(e.chars[i].charBox,t)){n=i;break}n>a&&(a=n,o=e.chars[n].charBox);}}}));})),!s)return t.isMatchText=!0,t.isBlankTextAssist=!0,null;return {startTextPosition:{lineIndex:l,charIndex:r,pageUid:i.uid,mediaBoxPoint:{x:s.left+s.width/2,y:s.top+s.height/2}},endTextPosition:{lineIndex:h,charIndex:a,pageUid:i.uid,mediaBoxPoint:{x:o.left+o.width/2,y:o.top+o.height/2}},startCharRect:s,endCharRect:o}}}const Sy={highlight:"highlight",underline:"underline",strikeout:"strikeout"};class Cy extends js{constructor(t){super(),i(this,"containerPage",void 0),i(this,"context",void 0),i(this,"isEditTextAssist",!1),i(this,"isStartDrawTextAssist",!1),i(this,"textAssistTimer",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionThreshold",1),i(this,"startPoint",void 0),i(this,"isMovedForTextSelection",void 0),i(this,"isPointerdown",!1),i(this,"opPageUid",null),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"isEditTextAssistStart",!1),i(this,"isEditTextAssistEnd",!1),i(this,"magnifier",void 0),i(this,"canvas",void 0),i(this,"isPointerType",!1),i(this,"isRenderMagnifier",!1),i(this,"magnifierPoint",null),i(this,"needRenderMagnifier",!1),i(this,"isMouseOverText",!1),this.context=t,this.magnifier=new hg(this.context.context.viewerConfig.textMagnifierStyle),this.canvas=this.context.context.rendererService.getCanvasDom(),this.context.context.hooks.afterRender.on((()=>{this.needRenderMagnifier&&this.renderMagnifier(this.magnifierPoint);}),this),(this.context.context.isDefaultViewer||this.context.context.isThumbnailViewer)&&this.context.context.core.editService.onAfterCropPages.on((t=>{this.deactivateAnnotation();}),this);}renderMagnifier(t){this.context.context.viewerConfig.enableTextMagnifier&&this.magnifier.render({from:this.canvas,fromX:t.x,fromY:t.y,canvas:this.canvas,canvasX:t.x,canvasY:t.y});}isHitAnnotation(t){return this.context.annotationController.isHitShape(t)}isTextAssistMode(){return ["highlight","underline","strikeout"].includes(this.context.context.viewerConfig.annotationMode)}startHandler(t,e){if(this.isPointerdown)return;const{context:i}=this.context,[n]=i.toCanvas(t),{page:s}=i.getPointerOverPageInfo(n.pageX,n.pageY).pageInfo;if(!s)return;const o=!bm(t);this.isPointerType=o,this.isPointerdown=!0,this.startPoint={x:n.pageX,y:n.pageY};const r=this.context.context.getActiveTab(),{isHit:a,shape:l,isHitSelected:h}=this.isHitAnnotation(t);if("annotation"===this.context.context.viewerConfig.toolMode&&this.isTextAssistMode()){if(!this.context.context.core.pageService.getPage(s.uid).isTextPage)return;const e=this.context.context.getPointerOverMediaBoxInfo(s.mediaBox,n.pageX,n.pageY,s.rotation),{start:i,end:a}=this.isHitTextAssistCtrlPoint(s,{x:e.pointerX,y:e.pointerY});if(i||a)this.isEditTextAssistStart=i,this.isEditTextAssistEnd=a,o&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:n.pageX,y:n.pageY},this.context.context.render("annotationEditStart"));else if(bm(t)){if(!this.isStartDrawTextAssist){const t=this.context.context.calcTextStartPosition({x:n.pageX,y:n.pageY},this.containerPage,r);t&&(this.startTextPosition=t,this.isStartDrawTextAssist=!0,this.context.context.hooks.beforeTextSelected.emit());}}else o&&(this.textAssistTimer=setTimeout((()=>{clearTimeout(this.textAssistTimer),this.textAssistTimer=null;const[e]=this.context.context.toCanvas(t),{page:i}=this.context.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo,s=this.context.context.calcTextStartPosition({x:e.pageX,y:e.pageY},i,r);if(s){this.isStartDrawTextAssist=!0,this.startTextPosition=s;const{textPages:t,startCharRect:e,endCharRect:i,startTextPosition:o,endTextPosition:a}=this.context.context.textSelectionService.calcSelectedText(this.startTextPosition,s);r.setTextSelection(t,e,i,o,a),this.needRenderMagnifier=!0,this.magnifierPoint={x:n.pageX,y:n.pageY},this.context.context.render("annotationEditStart"),this.context.context.hooks.beforeTextSelected.emit();}}),this.context.context.viewerConfig.enterTextModeTimeMobile));}else {if(a&&this.context.isTextAssistType(l.textAssistType))return this.context.annotationController.startHandler(t,e),void this.loadTextForAnnotation(l);this.context.annotationController.startHandler(t,e);}}cursorHandler(t){const e=this.context.annotationController.eventService,{cursorService:i}=this.context.context;if(e.isStartDraw)return void i.lockCursor();if(e.isStartEdit)return void i.lockCursor();const n=this.context.annotationController.cursorHandler(t);this.context.context.applyCursorState(n);}moveHandler(t,e){const{context:i}=this.context,[n]=i.toCanvas(t),{page:s}=i.getPointerOverPageInfo(n.pageX,n.pageY).pageInfo;if("annotation"===this.context.context.viewerConfig.toolMode&&this.isTextAssistMode()){if(this.opPageUid=null==s?void 0:s.uid,this.isPointerdown){as(this.startPoint,{x:n.pageX,y:n.pageY})>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0);}if(s){const e=i.getActiveTab(),o=this.context.context.core.pageService.getPage(s.uid);if(this.isStartDrawTextAssist){if(null==o||!o.isTextPage)return;i.cursorService.lockCursor();const r=this.context.context.calcTextEndPosition({x:n.pageX,y:n.pageY},s,e,this.startTextPosition.mediaBoxPoint);if(r){this.endTextPosition=r;const{textPages:s,startCharRect:o,endCharRect:a,startTextPosition:l,endTextPosition:h}=i.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);this.startCharRect=o,this.endCharRect=a,e.setTextSelection(s,o,a,l,h);!bm(t)&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:n.pageX,y:n.pageY}),i.render("annotationEditMove");}}else if(o.visibleLines&&null!=o&&o.isTextPage){const t=this.context.context.getPointerOverMediaBoxInfo(s.mediaBox,n.pageX,n.pageY,s.rotation),e={x:t.pointerX,y:t.pointerY},i=o.getHoveredTextLine(e);this.isMouseOverText=-1!==i;}}}else this.isRenderMagnifier&&i.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:n.pageX,y:n.pageY}),this.context.annotationController.moveHandler(t,!s);}endHandler(t){const{context:e}=this.context;if(this.textAssistTimer&&(clearTimeout(this.textAssistTimer),this.textAssistTimer=null),this.isStartDrawTextAssist){const t=this.applyTextSelectionToAnnotation(Sy[e.viewerConfig.annotationMode]);if(t&&t.length){const i=t[t.length-1];e.clearSelectedTexts(),this.context.context.hooks.afterTextSelected.emit(),this.context.annotationController.interactiveConfig.enableContinuousDrawing||(this.context.annotationController.setAnnotationMode("none",!0),this.activateAnnotation(i,!1),i.textAssistEventHandler.enableEditMode()),this.context.context.render("annotationEditEnd");}}else this.isMovedForTextSelection||e.clearSelectedTexts();this.context.context.cursorService.unlockCursor(),this.context.annotationController.endHandler(t),this.isStartDrawTextAssist=!1,this.isPointerdown=!1,this.isMovedForTextSelection=!1,this.opPageUid=null,this.isPointerType=!1,this.isRenderMagnifier=!1,this.magnifierPoint=null,this.needRenderMagnifier=!1,this.magnifierPoint=null,this.isMouseOverText=!1;}applyTextSelectionToAnnotation(t){const e=this.context.context.textSelectionService.getTextSelectionLines();if(e){return e.map(((i,n)=>{const s=this.context.context.getActiveTab();let{startCharRect:o,startTextPosition:r}=s;n>0&&(o=i.lines[0].chars[0].charBox,r={lineIndex:0,charIndex:0,pageUid:i.pageUid,mediaBoxPoint:{x:o.left,y:o.top}});let{endCharRect:a,endTextPosition:l}=s;if(n<e.length-1){const t=i.lines[i.lines.length-1].chars;a=t[t.length-1].charBox,l={lineIndex:i.lines.length-1,charIndex:t.length-1,pageUid:i.pageUid,mediaBoxPoint:{x:a.left,y:a.top}};}const h=this.createTextAssist(i,t,{startCharRect:o,endCharRect:a,startTextPosition:r,endTextPosition:l});h.startCharRect=o,h.endCharRect=a,h.startTextPosition=r,h.endTextPosition=l;const c=this.context.annotationController.getShape(h.uid);return c&&(c.startCharRect=o,c.endCharRect=a,c.startTextPosition=r,c.endTextPosition=l),c}))}return null}activateAnnotation(t,e){this.context.annotationController.eventService.activateShape(t,e),this.loadTextForAnnotation(t);}loadTextForAnnotation(t){if(t.context.isActive&&this.context.isTextAssistType(t.textAssistType)){const{core:e}=this.context.context,i=e.annotationService.getAnnotationByUid(t.id);i&&!i.isPageTextLoaded&&e.textLoadService.loadText([i.pageUid]).then((()=>{i.isPageTextLoaded=!0;}));}}deactivateAnnotation(){this.context.annotationController.eventService.inactivateShape(!0),this.context.annotationController.eventService.defaultGroup.clear();}hasActiveAnnotation(){return this.context.annotationController.getSelectedShapeUids().length>0}keydownHandler(t){const e=this.context.context.getActiveTab();this.context.annotationController.keyDownHandler(t,e.context.zoom);}keyupHandler(t){this.context.annotationController.keyUpHandler(t);}setAnnotationContainer(t){this.containerPage=t,this.context.annotationController.setAnnotationContainer(t.uid,t.mediaBox);}setAnnotationInteractionArea(t){this.context.annotationController.eventService.setEventArea({left:t.left,top:t.top,width:t.width,height:t.height});}copyAnnotations(){const t=this.context.annotationController.getSelectedShapeUids();0===t.length||this.context.annotationController.isInTextEditMode()?this.context.viewer.clearAnnotationClipboard():this.context.viewer.copyAnnotations(t);}cutAnnotations(){const t=this.context.annotationController.getSelectedShapeUids();0===t.length||this.context.annotationController.isInTextEditMode()?this.context.viewer.clearAnnotationClipboard():this.context.viewer.cutAnnotations(t);}pasteAnnotations(){this.context.annotationController.isInTextEditMode()||this.context.viewer.pasteAnnotations();}initTextAssist(){}createTextAssist(t,e,i){const{context:n}=this.context,s=n.getActiveTab(),o=Jn(),r=Zf(),{defaultStyleConfig:a}=this.context.viewer.getAnnotationConfig(),{opacity:l}=a[e];let h=a.highlight.background,c=1;"underline"===e?h=a.underline.borderColor:"strikeout"===e&&(h=a.strikeout.borderColor);const d=t.lines.map((t=>{let{selectedRect:e}=t;return {...e}}));c=wm(d);const u=n.core.annotationService.createAnnotation(s.uid,{uid:o,docUid:s.uid,pageUid:t.pageUid,type:e,style:{opacity:l,borderColor:h,background:h,borderWidth:c,lines:d},flags:["print","noMove"],comment:{annotationUid:o,author:"",subject:"",contents:"",creationDate:r,modificationDate:r,markedStates:[],reviewStates:[],replies:[]},transform:{},source:"user",...i});return Object.assign(u.customData,{isDDVTextAssist:!0}),this.context.annotationController.updateLayer(o,u.layer),u}updateTextAssist(t,e){}isHitTextAssistCtrlPoint(t,e){const{core:i}=this.context.context,n={start:!1,end:!1,annotationUid:""};return t.mediaBox.childNodes.some((t=>{if(this.context.isTextAssistType(t.textAssistType)){const s=i.annotationService.getAnnotationByUid(t.id),o=t.getScale().x,r=this.context.context.viewerConfig.textSelectionStyle.ctrlBorderRadius/o,{startCharRect:a,endCharRect:l}=s;if(a){if(as({x:a.left+a.width/2,y:a.top-r},e)<=r)return n.start=!0,n.annotationUid=t.id,!0}if(l){if(as({x:l.left+l.width/2,y:l.top+l.height+r},e)<=r)return n.end=!0,n.annotationUid=t.id,!0}}return !1})),n}dispose(){super.dispose(),this.containerPage=null;}}function Py(t){return class extends t{constructor(t){super(t),i(this,"annotationViewerContext",void 0),this.annotationViewerContext=this.register(new by(this)),this.listenGlobalEventForAnnotation(),this.listenHooksForAnnotation(),this.listenNativeEventsForAnnotation(),this.context.hasAnnotationModule=!0,this.context.annotationEditService=this.register(new Cy(this.annotationViewerContext));const e=this.getViewerConfig();this.context.isDefaultViewer&&this.updateAnnotationConfig({enableDeleteWithKeyboard:e.enableDeleteWithKeyboard,enableMoveWithKeyboard:e.enableMoveAnnotationWithKeyboard,enableMultipleSelectWidthCtrl:e.enableMultipleSelectAnnotationWithKeyboard});}listenHooksForAnnotation(){const t=()=>{const t=this.getSelectedAnnotations();if(1!==t.length)return;if(!t[0])return;const e=this.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.updateCursor();};this.hooks.scroll.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.resize.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.zoomChanged.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.pageChanged.on((t=>{if(this.context.isDefaultViewer||this.context.isThumbnailViewer){const t=this.getActiveTab();if(null!=t&&t.total){const e=t.getCurrentPage();this.context.annotationEditService.setAnnotationContainer(e);}t&&"single"===t.context.displayMode&&this.annotationViewerContext.disableTextEditMode();}}),this),this.hooks.currentPageChanged.on((t=>{if(this.context.isDefaultViewer||this.context.isThumbnailViewer){const t=this.getActiveTab();if(null!=t&&t.total){const e=t.getCurrentPage();this.context.annotationEditService.setAnnotationContainer(e);}}}),this);}listenGlobalEventForAnnotation(){if(!this.context.isDefaultViewer&&!this.context.isThumbnailViewer)return;const{core:t}=this.context,e=t.annotationService.annotationApp.hooks;t.onBeforeGetPageData.on((t=>{const{activatedShape:e}=this.annotationViewerContext.annotationController.eventService;(null==e?void 0:e.pageUid)===t.pageUid&&e instanceof xh&&e.isEditMode&&e.textEditEventHandler.emitTextContentUpdated();}),this),e.annotationCreated.on((t=>{let e=!1;var i;(t.annotations.forEach((t=>{if(this.annotationViewerContext.addAnnotationByAnnotationData(t),!e){this.annotationIsVisible(t.uid)&&(e=!0);}})),e)&&(null===(i=this.context)||void 0===i||i.render("annotationCreatedEvent"));}),this),e.annotationDeleted.on((t=>{var e;this.annotationViewerContext.deleteAnnotations(t.annotations.map((t=>t.uid)),t.emitEvent),null===(e=this.context)||void 0===e||e.render("annotationDeletedEvent");}),this),e.annotationUpdated.on((t=>{var e;const i=t.updateDetails.map((t=>t.annotationUid)),n=function(t){const e=new Set(["flagsChanged","flattenedChanged"]);let i=!1;for(const n of t){if(!e.has(n))return !1;i=!0;}return i}(t.updateActions);this.annotationViewerContext.updateAnnotations(i,t.updatedBy,n,t.updateDetails),this.hooks.annotationsUpdated.emit(new Ef(i,t.updateActions)),null===(e=this.context)||void 0===e||e.render("annotationUpdatedEvent");}),this),e.bringFroward.on((t=>{var e;(this.annotationViewerContext.updateLayer([t.annotationUid,t.forwardUid]),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("bringForward"));}),this),e.bringToFront.on((t=>{var e;(this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("bringToFront"));}),this),e.sendBackward.on((t=>{var e;(this.annotationViewerContext.updateLayer([t.annotationUid,t.backwardUid]),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("sendBackward"));}),this),e.sendToBack.on((t=>{var e;(this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("sendToBack"));}),this),e.restoreLayer.on((t=>{var e;(this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("restoreLayer"));}),this),e.annotationPageSwitched.on((t=>{var e;(this.annotationViewerContext.updateAnnotationPage(t.annotationUid,t.to.pageUid),this.annotationIsVisible(t.annotationUid))&&(null===(e=this.context)||void 0===e||e.render("annotationPageSwitchedEvent"));}),this);}listenNativeEventsForAnnotation(){(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&Ys(document,"click",this).on((t=>{const e=this.getActiveTab(),i="visible"===this.context.viewerConfig.visibility;e&&i&&(this.context.viewService.mainContainer.contains(null==t?void 0:t.target)||this.annotationViewerContext.disableTextEditMode());}));}getAnnotationConfig(){return Nn(this.annotationViewerContext.annotationController.interactiveConfig)}updateAnnotationConfig(t){this.annotationViewerContext.annotationConfigService.updateConfig(t);}selectAnnotations(t){return this.annotationViewerContext.selectAnnotations(t)}deleteAnnotations(t){this.context.core.annotationService.deleteAnnotations(t),this.context.render("deleteAnnotations");}updateAnnotation(t,e,i){const n=this.getAnnotationObject(t);n instanceof xh&&n.isEditMode&&n.textEditEventHandler.emitTextContentUpdated(),this.context.core.annotationService.updateAnnotations([{annotationUid:t,options:e}],void 0,i);}getSelectedAnnotations(){return this.annotationViewerContext.getSelectedAnnotations()}bringForward(t){return this.context.core.annotationService.bringForward(t)}bringToFront(t){return this.context.core.annotationService.bringToFront(t)}sendBackward(t){return this.context.core.annotationService.sendBackward(t)}sendToBack(t){return this.context.core.annotationService.sendToBack(t)}getAnnotationObject(t){return this.annotationViewerContext.annotationController.getShape(t)}copyAnnotations(t){t||(t=this.getSelectedAnnotations().map((t=>t.uid))),t.length&&this.context.core.annotationService.copyAnnotations(t);}cutAnnotations(t){t||(t=this.getSelectedAnnotations().map((t=>t.uid))),t.length&&this.context.core.annotationService.cutAnnotations(t);}pasteAnnotations(t,e){const i=this.context.getActiveTab();if(null==i||!i.total)return;const n=i.getCurrentPage();if(!n)return;const s=this.context.viewerConfig.copyAnnotationOffset;this.context.core.annotationService.pasteAnnotations(t||i.uid,e||n.uid,s);}clearAnnotationClipboard(){this.context.core.annotationService.clearAnnotationClipboard();}undo(){const{activatedShape:t}=this.annotationViewerContext.annotationController.eventService;if(!this.context.getActiveTab())return !1;const e=t instanceof xh&&t.isEditMode;e&&t.textEditEventHandler.emitTextContentUpdated();const i=super.undo();return e&&t.textEditEventHandler.resetStartTextContent(),i}redo(){const{activatedShape:t}=this.annotationViewerContext.annotationController.eventService;if(!this.context.getActiveTab())return !1;const e=t instanceof xh&&t.isEditMode;e&&t.textEditEventHandler.emitTextContentUpdated();const i=super.redo();return e&&t.textEditEventHandler.resetStartTextContent(),i}annotationIsVisible(t){const e=this.context.core.annotationService.annotationApp.getAnnotationByUid(t),i=this.context.core.pageService.getPage(e.pageUid);if(i){const t=this.context.tabService.getTab(i.doc.uid);if(null!=t&&t.isActive){if(t.getPageByUid(e.pageUid).isVisible)return !0}}return !1}}}class Ty extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="createAnnotation",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{action:t}=this,{annotationApp:e}=this.core.annotationService,{annotationConfig:i}=this.action;return !!e.createAnnotations([{docUid:t.docUid,uid:i.uid,pageUid:t.pageUid,type:i.type,style:i.style,transform:i.transform,flags:i.flags,comment:i.comment,layer:i.layer,flattened:i.flattened,source:i.source,oriIndex:i.oriIndex,parsedOriIndex:i.parsedOriIndex,startCharRect:i.startCharRect,endCharRect:i.endCharRect}])}undo(){this.core.annotationService.annotationApp.deleteAnnotations([this.action.annotationConfig.uid]);}}class Ay extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="deleteAnnotation",e.commandService.onBeforeRefreshCommands.on((e=>{t.docUid===e.docUid&&(t.deleteConfigs.slice().forEach((i=>{if(e.pageUids.includes(i.pageUid)){const e=t.deleteConfigs.findIndex((t=>t.pageUid===i.pageUid));t.deleteConfigs.splice(e,1);}})),this.isValid=t.deleteConfigs.length>0);}),this);}execute(){const{action:t}=this,e=t.deleteConfigs.map((t=>t.uid));return this.core.annotationService.annotationApp.deleteAnnotations(e),!0}undo(){const{annotationApp:t}=this.core.annotationService,e=this.action.deleteConfigs.map((t=>({docUid:this.action.docUid,uid:t.uid,type:t.type,pageUid:t.pageUid,style:t.style,transform:t.transform,flags:t.flags,comment:t.comment,layer:t.layer,oriIndex:t.oriIndex,modified:t.modified,flattened:t.flattened,parsedOriIndex:t.parsedOriIndex,source:t.source,startCharRect:t.startCharRect,endCharRect:t.endCharRect})));t.createAnnotations(e);}}class ky extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="bringAnnotationToFront",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.bringToFront(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Ey extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="bringAnnotationForward",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.bringForward(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Dy extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="sendAnnotationBackward",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.sendBackward(this.action.annotationUid)}undo(){this.core.annotationService.annotationApp.bringForward(this.action.annotationUid);}}class Ry extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="sendAnnotationToBack",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.sendToBack(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Iy extends Sm{constructor(t,e,n){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"updatedBy",void 0),this.action=t,this.core=e,this.updatedBy=n,this.type="updateAnnotation",e.commandService.onBeforeRefreshCommands.on((e=>{if(t.docUid!==e.docUid)return;const{pageUid:i}=t;e.pageUids.includes(i)&&(this.isValid=!1);}),this);}execute(){return this.update(!0),this.updatedBy=null,!0}undo(){this.update(!1);}update(t){const{annotationApp:e}=this.core.annotationService,i=this.action.updateDetails.map((e=>{const i=Nn(t?e.to:e.from);return {uid:e.annotationUid,...i}}));e.updateAnnotation({updateDetails:i,updatedBy:this.updatedBy,updateActions:[...this.action.updateActions]});}}class My extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="switchAnnotationPage",e.commandService.onBeforeRefreshCommands.on((e=>{t.docUid===e.docUid&&t.moveConfigs.slice().every((t=>((e.pageUids.includes(t.from.pageUid)||e.pageUids.includes(t.to.pageUid))&&(this.isValid=!1),this.isValid)));}),this);}execute(){const{annotationApp:t}=this.core.annotationService;return this.action.moveConfigs.forEach((e=>{if(_n(e.to.layer)){const i=t.annotationPageRepo.findPageByUid(e.to.pageUid).createTop();e.to.layer=i;}t.switchAnnotationPage(e.annotationUid,{...e.to});})),!0}undo(){const{annotationApp:t}=this.core.annotationService;this.action.moveConfigs.forEach((e=>{t.switchAnnotationPage(e.annotationUid,{...e.from});}));}}class By extends js{constructor(t){super(),i(this,"core",void 0),i(this,"annotationApp",void 0),i(this,"hooks",void 0),i(this,"enableEmitLayerChanged",!0),i(this,"pasteConfig",{pasteComment:!1,pasteReply:!0,updateDate:!0}),i(this,"clipboard",[]),i(this,"currentClipboard",[]),i(this,"currentPastePageUid",null),i(this,"flattenedAnnotData",{}),this.core=t,this.annotationApp=new fy,this.hooks=this.annotationApp.hooks,this.bindAnnotationFlattenEvent();}bindAnnotationFlattenEvent(){this.hooks.annotationCreated.on((t=>{t.annotations.forEach((t=>{t.flattened&&(this.flattenedAnnotData[t.pageUid]?this.flattenedAnnotData[t.pageUid].push(t.uid):this.flattenedAnnotData[t.pageUid]=[t.uid]);}));}),this),this.hooks.annotationDeleted.on((t=>{t.annotations.forEach((t=>{if(t.flattened){const e=this.flattenedAnnotData[t.pageUid],i=e.indexOf(t.uid);-1!==i&&e.splice(i,1);}}));}),this),this.hooks.annotationUpdated.on((t=>{t.updateActions.includes("flattenedChanged")&&t.updateDetails.forEach((t=>{const e=this.getAnnotationByUid(t.annotationUid);if(this.flattenedAnnotData[e.pageUid]&&this.flattenedAnnotData[e.pageUid].includes(e.uid)&&!e.flattened){const t=this.flattenedAnnotData[e.pageUid].indexOf(e.uid);-1!==t&&this.flattenedAnnotData[e.pageUid].splice(t,1);}e.flattened&&(this.flattenedAnnotData[e.pageUid]&&!this.flattenedAnnotData[e.pageUid].includes(e.uid)&&this.flattenedAnnotData[e.pageUid].push(e.uid),this.flattenedAnnotData[e.pageUid]||(this.flattenedAnnotData[e.pageUid]=[e.uid]));}));}),this);}reset(){this.annotationApp.reset();}getAnnotationByUid(t){return this.annotationApp.getAnnotationByUid(t)}deleteAnnotationPages(t){const e=t.reduce(((t,e)=>{const i=this.core.pageService.getPage(e);return i&&t.push(...i.annotations),t}),[]);this.deleteAnnotations(e,!1),this.annotationApp.annotationPageRepo.deletePagesByUids(t);}createAnnotationsByParsedPages(t,e){const i=Zf();return e.reduce(((e,n)=>{var s;this.annotationApp.createAnnotationPage(n.pageUid);const o=null===(s=n.annotations)||void 0===s?void 0:s.reduce(((e,s)=>{var o,r,a,l,h;Oy(s);const c={uid:s.uid,docUid:t,pageUid:n.pageUid,type:s.type,style:s.style,transform:s.transform,flags:s.flags,comment:Uy(s.comment),creationDate:null!==(o=null===(r=s.comment)||void 0===r?void 0:r.creationDate)&&void 0!==o?o:i,modificationDate:null!==(a=null===(l=s.comment)||void 0===l?void 0:l.modifiedDate)&&void 0!==a?a:i,oriIndex:null===(h=s.raw)||void 0===h?void 0:h.oriIndex,parsedOriIndex:s.parsedOriIndex,customData:{...s.customData||{}},source:"file"};return e.push(c),e}),[]);return null!=o&&o.length?(this.annotationApp.createAnnotations(o),e.push(o.map((t=>t.uid)))):e.push([]),e}),[])}createAnnotation(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(Oy(e),i){const i=new Ty({actionUid:Jn(),type:"createAnnotation",docUid:t,pageUid:e.pageUid,annotationConfig:{uid:e.uid,type:e.type,style:e.style,transform:e.transform,flags:e.flags,comment:e.comment,layer:e.layer,modified:e.modified,oriIndex:e.oriIndex,flattened:e.flattened,source:e.source,parsedOriIndex:e.parsedOriIndex,startCharRect:e.startCharRect,endCharRect:e.endCharRect}},this.core);this.core.commandService.execute(i,t);}else this.annotationApp.createAnnotations([e]);return this.annotationApp.getAnnotationByUid(e.uid)}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{pageService:i,commandService:n}=this.core,s=t.reduce(((t,e)=>{const n=this.annotationApp.getAnnotationByUid(e);if(n){const e=i.getPage(n.pageUid),s=t.get(e.doc.uid)||{uid:e.doc.uid,annotationConfigs:[]};t.set(s.uid,s);const o=n.getConfig();o.layer=n.layer,o.flattened=n.flattened,null!=o&&o.flattened&&!o.flags.includes("flattened")&&o.flags.push("flattened"),s.annotationConfigs.push(o);}return t}),new Map);if(e)for(const[t,e]of s){const i=e.annotationConfigs.map((t=>({uid:t.uid,type:t.type,pageUid:t.pageUid,style:t.style,transform:t.transform,flags:t.flags,comment:t.comment,layer:t.layer,oriIndex:t.oriIndex,parsedOriIndex:t.parsedOriIndex,modified:t.modified,flattened:t.flattened,source:t.source,startCharRect:t.startCharRect,endCharRect:t.endCharRect}))),s=new Ay({actionUid:Jn(),type:"createAnnotation",docUid:t,deleteConfigs:i},this.core);n.execute(s,e.uid);}else this.annotationApp.deleteAnnotations(t,!1);}updateAnnotations(t,e,i,n){let s,o;const r=t.reduce(((t,e)=>{const{annotationUid:i}=e,n=this.annotationApp.getAnnotationByUid(i);var r,a,l;n&&(s=n.pageUid,o=n.docUid,null==n||!n.flattened||null==e||null===(r=e.options)||void 0===r||!r.flags||null!=e&&null!==(a=e.options)&&void 0!==a&&null!==(a=a.flags)&&void 0!==a&&a.includes("flattened")||!1===(null==e||null===(l=e.options)||void 0===l?void 0:l.flattened)||e.options.flags.push("flattened"),t.push({annotation:n,options:e.options}));return t}),[]);if(null==r||!r.length||r.length!==t.length)return;const a=Zf(),l=r.map((t=>{let{annotation:e,options:i}=t;i.comment||(i.comment={}),i.comment.modificationDate=a;const s=e.getConfig();return i.startTextPosition&&(e.startTextPosition=i.startTextPosition),i.endTextPosition&&(e.endTextPosition=i.endTextPosition),i.startCharRect&&(e.startCharRect=i.startCharRect),i.endCharRect&&(e.endCharRect=i.endCharRect),{annotationUid:e.uid,from:{...s,modified:e.modified,flattened:e.flattened,layer:e.layer},to:{...i,modified:!n||e.modified,flattened:zn(null==i?void 0:i.flattened)?null==i?void 0:i.flattened:e.flattened,layer:(null==i?void 0:i.layer)||e.layer}}})),h=new Iy({actionUid:Jn(),type:"updateAnnotation",docUid:o,pageUid:s,updateDetails:l,updateActions:i||[]},this.core,e);this.core.commandService.execute(h,o);}switchAnnotationPage(t){const e=t.map((t=>({annotation:this.annotationApp.getAnnotationByUid(t.annotationUid),...t}))),i=this.core.pageService.getPage(e[0].annotation.pageUid);if(!i)return;const n=e.map((t=>{let{annotationUid:e,annotation:i,pageUid:n,x:s,y:o}=t;return {annotationUid:e,from:{pageUid:i.pageUid,x:i.style.x,y:i.style.y,layer:i.layer},to:{pageUid:n,x:_n(s)?i.style.x:s,y:_n(o)?i.style.y:o,layer:void 0}}})),s=new My({actionUid:Jn(),type:"switchAnnotationPage",docUid:i.doc.uid,moveConfigs:n},this.core);this.core.commandService.execute(s,i.doc.uid);}duplicateAnnotation(t,e){const i=this.annotationApp.getAnnotationByUid(t);if(!i)return null;const n=i.getConfig();n.uid=Jn(),e&&(n.pageUid=e),n.comment.creationDate=Zf(),n.comment.modificationDate=n.comment.creationDate;return this.createAnnotation(n.docUid,n)}copyAnnotations(t){t.length&&(this.clipboard=[],this.currentClipboard=[],this.currentPastePageUid=null),t.forEach((t=>{const e=this.annotationApp.getAnnotationByUid(t);if(e&&!["highlight","strikeout","underline"].includes(e.type)){const t=e.getConfig();this.clipboard.push(t),this.currentClipboard.push(Nn(t));}}));}cutAnnotations(t){const e=[];t.forEach((t=>{const i=this.annotationApp.getAnnotationByUid(t);i&&!["highlight","strikeout","underline"].includes(i.type)&&e.push(t);})),this.copyAnnotations(t),this.deleteAnnotations(e);}pasteAnnotations(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;if(!this.clipboard.length)return;const n=this.core.pageService.getPage(e);this.currentPastePageUid&&this.currentPastePageUid!==e&&(this.currentClipboard=Nn(this.clipboard)),this.currentPastePageUid=e,this.currentClipboard.forEach((s=>{var o,r,a,l;const h=Zf();let{x:c,y:d}=s.style;const u=!_n(null==s||null===(o=s.style)||void 0===o?void 0:o.x)&&!_n(null==s||null===(r=s.style)||void 0===r?void 0:r.y);!u&&null!=s&&null!==(a=s.transform)&&void 0!==a&&a.position&&(c=s.transform.position.x,d=s.transform.position.y),c+=i,d+=i,(c>n.cropBox.left+n.cropBox.width-i||d>n.cropBox.top+n.cropBox.height-i||c<n.cropBox.left||d<n.cropBox.top)&&(c=n.cropBox.left,d=n.cropBox.top),u?(s.style.x=c,s.style.y=d,delete s.transform.position):!u&&null!=s&&null!==(l=s.transform)&&void 0!==l&&l.position&&(s.transform.position={x:c,y:d});const p=Nn(s),g=Jn();Object.assign(p,{uid:g,docUid:t,pageUid:e,creationDate:h,modificationDate:h});const f={annotationUid:g,creationDate:h,modificationDate:h,markedStates:[],reviewStates:[],replies:[]};this.pasteConfig.pasteComment?this.pasteConfig.pasteReply||Object.assign(p.comment,f):Object.assign(p.comment,f,{contents:""}),this.createAnnotation(s.docUid,p);}));}clearAnnotationClipboard(){this.clipboard=[],this.currentClipboard=[],this.currentPastePageUid=null;}bringToFront(t){return this.handleLayer(t,"f")}bringForward(t){return this.handleLayer(t,"fw")}sendToBack(t){const e=this.getAnnotationByUid(t),i=this.flattenedAnnotData[e.pageUid];if(!i||i&&0===i.length)return this.handleLayer(t,"b");if(!this.getAnnotationLayerState(t).back)return !0;this.enableEmitLayerChanged=!1;const n=i.length,s=e.layer;this.annotationApp.sendToBack(t);for(let i=0;i<n;i++)i===n-1?(e.layer=s,this.enableEmitLayerChanged=!0,this.bringForward(t)):this.annotationApp.bringForward(t);return !0}sendBackward(t){return this.handleLayer(t,"bw")}handleLayer(t,e){const i=this.annotationApp.getAnnotationByUid(t);if(!i)return !1;const n=this.core.pageService.getPage(i.pageUid);if(!n)return !1;const s={actionUid:Jn(),type:e,annotationUid:t,docUid:n.doc.uid,pageUid:n.uid},o=this.annotationApp.getAnnotationLayerState(t);let r;return "f"===e&&o.front?r=new ky(s,this.core):"fw"===e&&o.forward?r=new Ey(s,this.core):"bw"===e&&o.backward?r=new Dy(s,this.core):"b"===e&&o.back&&(r=new Ry(s,this.core)),r&&this.core.commandService.execute(r,n.doc.uid),!0}getAnnotationLayerState(t){const e=this.annotationApp.getAnnotationLayerState(t),i=this.getAnnotationByUid(t);if(!i)return e;const n=this.flattenedAnnotData[i.pageUid];if(!n||n&&0===n.length)return e;const s=[...this.core.getAnnotationsByPageUid(i.pageUid)];s.sort(((t,e)=>t.layer-e.layer));return s.indexOf(i)===n.length&&(e.back=!1,e.backward=!1),e}updateComment(){}addReply(){}deleteReply(){}updateReply(){}addReviewState(){}deleteReviewState(){}addCheckMarkState(){}deleteCheckMarkState(){}createAnnotationShape(t,e){const{type:i,transform:n,style:s}=t.getConfig(),o=s,r=n;e&&!["highlight","underline","strikeout","incomplete"].includes(t.type)&&function(t,e){const i=["rx","x","width","borderWidth","fontSize"],n=["ry","y","height"],s=["startPoint","endPoint"];Object.keys(t).forEach((o=>{const r=t[o];if(i.includes(o)||n.includes(o)){const i=mr(r);t[o]=e.toPixelPPI(i.value,n.includes(o));}else s.includes(o)?t[o]={x:e.toPixelPPI(r.x,!1),y:e.toPixelPPI(r.y,!0)}:"lineDash"===o?t[o]=r.map((t=>e.toPixelPPI(t,!1))):"points"===o?t[o]=r.map((t=>({x:e.toPixelPPI(t.x,!1),y:e.toPixelPPI(t.y,!0)}))):"segments"===o?t[o]=r.map((t=>t.map((t=>({x:e.toPixelPPI(t.x,!1),y:e.toPixelPPI(t.y,!0)}))))):"textContents"===o&&(t[o]=r.map((t=>({...t,fontSize:e.toPixelPPI(mr(t.fontSize).value,!1)}))));}));}(o,e),"ellipse"===i&&(o.x+=o.width/2||0,o.y+=o.height/2||0,o.rx=o.width/2||o.rx,o.ry=o.height/2||o.ry),r&&null!=r&&r.position&&(r.position={x:e.toPixelPPI(r.position.x,!1),y:e.toPixelPPI(r.position.y,!0)});const a={id:t.uid,style:o,transform:r};let l;switch(i){case"rectangle":l=new vh(a);break;case"ellipse":l=new ph(a);break;case"line":l=new Th(a);break;case"ink":l=new fh(a);break;case"polygon":l=new Ch(a);break;case"polyline":l=new Ph(a);break;case"textTypewriter":l=new xh(a,"freeTextWriter",{});break;case"textBox":l=new xh(a,"textBox");break;case"stamp":l=new Nh(a);break;case"highlight":l=new $h(a);break;case"underline":l=new Xh(a);break;case"strikeout":l=new jh(a);break;case"incomplete":l=new Fh(a);}if(l instanceof Nh&&!l.style.imageData&&l.updateStampStyle({x:o.x,y:o.y,width:o.width,height:o.height}),["highlight","underline","strikeout","incomplete"].includes(i)){const{resolutionX:t,resolutionY:i}=e,{displayResolution:n}=ko,s=t/n,o=i/n;l.setOrigin(0,0),l.scaleLocal(s,o);}return l}getAnnotationUidsByLayer(t){const e=this.annotationApp.annotationPageRepo.findPageByUid(t);return null==e?void 0:e.getAnnotationUidListByLayer()}flattenAnnotations(t){const e=t.map((t=>this.getAnnotationByUid(t))),i=[],n=[];this.enableEmitLayerChanged=!1,e.forEach((t=>{var e;const s=t.layer;if(this.core.annotationService.annotationApp.sendToBack(t.uid),null!==(e=this.flattenedAnnotData[t.pageUid])&&void 0!==e&&e.length){var o;const e=null===(o=this.flattenedAnnotData[t.pageUid])||void 0===o?void 0:o.length;for(let i=0;i<e;i++)this.core.annotationService.annotationApp.bringForward(t.uid);}n.push(s),i.push({annotationUid:t.uid,options:{flags:[...t.flags,"flattened"],flattened:!0}}),this.flattenedAnnotData[t.pageUid]?this.flattenedAnnotData[t.pageUid].push(t.uid):this.flattenedAnnotData[t.pageUid]=[t.uid];})),this.enableEmitLayerChanged=!0,e.forEach(((t,e)=>{i[e].options.layer=t.layer,t.layer=n[e];})),this.updateAnnotations(i,void 0,["flattenedChanged"],!0);}unFlattenAnnotation(t){const e=this.getAnnotationByUid(t),i=this.flattenedAnnotData[e.pageUid];if(!i||0===i.length)return !1;const n=i.indexOf(e.uid);if(-1===n)return !1;this.enableEmitLayerChanged=!1;const s=i.length-(n+1),o=e.layer;for(let t=0;t<s;t++)this.core.annotationService.annotationApp.bringForward(e.uid);const r=e.layer,a=e.flags.filter((t=>"flattened"!==t));return e.layer=o,this.updateAnnotations([{annotationUid:e.uid,options:{flags:a,flattened:!1,layer:r}}],void 0,["flattenedChanged"],!0),i.includes(e.uid)&&i.splice(n,1),this.enableEmitLayerChanged=!0,!0}}function Uy(t){return {annotationUid:t.uid,author:t.author,subject:t.subject,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modifiedDate,markedStates:Ly(t.markedStates||[]),reviewStates:Ly(t.reviewStates||[])}}function Ly(t){return t.map((t=>({uid:t.uid,author:t.author,contents:t.contents,creationDate:t.creationDate,state:t.state})))}function Oy(t){if("stamp"===t.type){const e=new Nh({style:t.style,transform:t.transform}),i=e.getAnnotationConfig();t.style=i.style,t.transform={...t.transform,position:i.transform.position,scale:i.transform.scale},e.destroy();}}var Wy=new WeakMap,Ny=new WeakMap,_y=new WeakMap,Fy=new WeakMap,Hy=new WeakSet,Vy=new WeakSet,zy=new WeakSet;class $y{constructor(t,e){v(this,zy),v(this,Vy),v(this,Hy),f(this,Wy,{writable:!0,value:void 0}),f(this,Ny,{writable:!0,value:void 0}),f(this,_y,{writable:!0,value:void 0}),f(this,Fy,{writable:!0,value:void 0}),p(this,Hy,jy).call(this,t,e);}getCanvas(){return n(this,Wy).contextService.getDomElement()}getInkOptions(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!n(this,Fy))return null;const{x:e,y:i}=n(this,Fy).getLocalPosition();n(this,Fy).setLocalPosition(0,0);const s=n(this,Fy).getAnnotationConfig(),o={borderWidth:s.style.borderWidth,borderColor:s.style.borderColor,opacity:s.style.opacity};if(t){const{displayResolution:t,dataResolution:r}=ko,a=s.style.segments.map((e=>e.map((e=>({x:Hs(e.x,t,r),y:Hs(e.y,t,r)})))));return o.borderWidth=Hs(o.borderWidth,t,r),n(this,Fy).setLocalPosition(e,i),n(this,Fy).getAnnotationConfig(),{points:a,...o}}return {segments:s.style.segments,...o}}getSignatureImage(){if(!n(this,Fy))return Promise.resolve(null);const t=n(this,Fy).getBoundingRect(),e=document.createElement("canvas");e.width=t.width,e.height=t.height;return e.getContext("2d").drawImage(this.getCanvas(),t.left*devicePixelRatio,t.top*devicePixelRatio,t.width*devicePixelRatio,t.height*devicePixelRatio,0,0,t.width,t.height),new Promise((t=>{e.toBlob(t,"image/png");}))}updateSignatureStyle(t){s(this,_y,{...n(this,_y),...t}),n(this,Fy)&&(n(this,Fy).updateStyle({...t}),n(this,Wy).render());}clearSignature(){n(this,Ny).children.slice().forEach((t=>{n(this,Ny).removeChild(t);})),s(this,Fy,null),n(this,Wy).render();}}function jy(t,e){const i=document.createElement("canvas");i.style.touchAction="none",s(this,Wy,new xl({renderer:new _l,width:t,height:e,canvas:i,dpr:window.devicePixelRatio,willReadFrequently:!0})),i.style.width=`${t}px`,i.style.height=`${e}px`,s(this,Ny,n(this,Wy).document.documentElement),(new kc).init(n(this,Wy)),p(this,Vy,Xy).call(this);}function Xy(){let t=!1;const e=this.getCanvas();e.addEventListener("pointerdown",(e=>{const i={x:e.offsetX,y:e.offsetY};t=!0,n(this,Fy)?(n(this,Fy).addSegment(),n(this,Fy).addPoint(i)):(s(this,Fy,new fh({style:{segments:[[i]],...n(this,_y),lineCap:"round",lineJoin:"round"}})),n(this,Ny).appendChild(n(this,Fy))),n(this,Wy).render();})),e.addEventListener("pointermove",(e=>{if(!t)return;const i={x:e.offsetX,y:e.offsetY};n(this,Fy).addPoint(i),n(this,Wy).render();})),document.addEventListener("pointerup",(()=>{t&&(t=!1,n(this,Fy).pathDirty=!0,n(this,Fy).boundsDirty=!0,n(this,Wy).render());}));}const Gy={stampText:"Draft",fontSize:32,fontFamily:"Arial",fontWeight:"bold",fontStyle:"normal",underline:!1,strikeout:!1,color:"#182564",borderColor:"#182564",background:"#c7d2e4",timeStampFontSize:16,userName:"Guest",hasUserName:!0,hasDate:!0,hasTime:!0};var Yy=new WeakMap,qy=new WeakMap,Jy=new WeakMap,Zy=new WeakMap,Qy=new WeakMap,Ky=new WeakMap,tx=new WeakSet,ex=new WeakSet;class ix{constructor(t,e){v(this,ex),v(this,tx),f(this,Yy,{writable:!0,value:void 0}),f(this,qy,{writable:!0,value:void 0}),f(this,Jy,{writable:!0,value:void 0}),f(this,Zy,{writable:!0,value:void 0}),f(this,Qy,{writable:!0,value:void 0}),f(this,Ky,{writable:!0,value:{...Gy}}),s(this,Jy,t),s(this,Zy,e),p(this,tx,nx).call(this,t,e);}get signatureStyle(){return {...n(this,Ky)}}getStampConfig(){const{background:t,borderColor:e,stampText:i}=n(this,Ky),s=[],o=function(t,e){const i=t-1,n=e-1;return [{x:i,y:n-10.6,step:2},{x:i,y:n-4.8,step:1},{x:i-6,y:n,step:1},{x:i-13.4,y:n,step:1},{x:14.4,y:n,step:0},{x:7,y:n,step:1},{x:1,y:n-4.8,step:1},{x:1,y:n-10.6,step:1},{x:1,y:11.6,step:0},{x:1,y:5.8,step:1},{x:7,y:1,step:1},{x:14.4,y:1,step:1},{x:i-13.4,y:1,step:0},{x:i-6,y:1,step:1},{x:i,y:5.8,step:1},{x:i,y:11.6,step:1},{x:i,y:n-10.6,step:0}]}(n(this,Jy),n(this,Zy));s.push({type:"path",stampPoints:o,borderWidth:1.3333333333333333,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4,background:t,borderColor:e});const{color:r,fontFamily:a,fontSize:l,fontStyle:h,fontWeight:c}=n(this,Ky),d=null!=a&&a.includes(" ")?`'${a}'`:a,u=document.createElement("canvas").getContext("2d"),{hasUserName:p,hasDate:g,hasTime:f,timeStampFontSize:v,userName:m}=n(this,Ky),y=p||g||f;if(y){let t="";t+=p?`${m} `:"",t+=g?`${function(){const t=new Date,e=t.getFullYear(),i=(t.getMonth()+1).toString().padStart(2,"0");return `${t.getDate().toString().padStart(2,"0")}/${i}/${e}`}()} `:"",t+=f?`${function(){const t=new Date;let e=t.getHours();const i=t.getMinutes().toString().padStart(2,"0"),n=e>=12?"PM":"AM";return e%=12,e=e||12,`${e}:${i} ${n}`}()}`:"";const e=`${h} ${c} ${v}px ${d}`;u.font=e;const{width:i,actualBoundingBoxAscent:o,actualBoundingBoxDescent:l}=u.measureText(t.trim()),y=o+l;s.push({type:"text",text:t,x:(n(this,Jy)-i)/2,y:n(this,Zy)/2+n(this,Zy)/4+y/2,color:r,fontFamily:a,fontSize:v,fontStyle:h,fontWeight:c});}if(i){const t=`${h} ${c} ${l}px ${d}`;u.font=t;const{underline:e,strikeout:o}=this.signatureStyle,{width:p,actualBoundingBoxAscent:g,actualBoundingBoxDescent:f}=u.measureText(i),v=g+f;if(s.push({type:"text",text:i,x:(n(this,Jy)-p)/2,y:y?n(this,Zy)/2:n(this,Zy)/2+v/2,color:r,fontFamily:a,fontSize:l,fontStyle:h,fontWeight:c}),o){const t=y?n(this,Zy)/2-v/3:n(this,Zy)/2+v/2-v/3,e=(n(this,Jy)-p)/2;s.push({type:"path",stampPoints:[{x:e,y:t,step:2},{x:e+p,y:t,step:0}],borderWidth:2,borderColor:r});}if(e){const t=y?n(this,Zy)/2+v/10:n(this,Zy)/2+v/2+v/10,e=(n(this,Jy)-p)/2;s.push({type:"path",stampPoints:[{x:e,y:t,step:2},{x:e+p,y:t,step:0}],borderWidth:2,borderColor:r});}}return s}getCanvas(){return n(this,qy).contextService.getDomElement()}updateSignatureStyle(t){s(this,Ky,{...n(this,Ky),...t});const e=this.getStampConfig();n(this,Qy).stampConfig=e,n(this,Qy).initStamp(),n(this,qy).render();}getSignatureImage(){if(!n(this,Qy))return Promise.resolve(null);const t=document.createElement("canvas");t.width=n(this,Jy),t.height=n(this,Zy);return t.getContext("2d").drawImage(this.getCanvas(),-.65*devicePixelRatio,-.65*devicePixelRatio,(n(this,Jy)+1.3)*devicePixelRatio,(n(this,Zy)+1.3)*devicePixelRatio,0,0,n(this,Jy),n(this,Zy)),new Promise((e=>{t.toBlob(e,"image/png");}))}}function nx(t,e){const i=document.createElement("canvas");s(this,qy,new xl({renderer:new _l,width:t,height:e,canvas:i,dpr:window.devicePixelRatio,willReadFrequently:!0})),i.style.width=`${t}px`,i.style.height=`${e}px`,s(this,Yy,n(this,qy).document.documentElement),s(this,Qy,new Nh({style:{stampConfig:this.getStampConfig()}})),n(this,Yy).appendChild(n(this,Qy)),(new kc).init(n(this,qy)),n(this,qy).render();}const sx={install(t){const e=Py(t.getClass("Viewer"));t.setClass("Viewer",e);},apply(t){const e=new By(t);t.annotationService=e;const{pageService:i}=t;e.hooks.annotationCreated.on((t=>{t.annotations.forEach((t=>{const e=i.getPage(t.pageUid);e&&e.annotations.push(t.uid);}));}),i),e.hooks.annotationDeleted.on((t=>{t.annotations.forEach((t=>{const e=i.getPage(t.pageUid);if(e){const i=e.annotations.indexOf(t.uid);e.annotations.splice(i,1);}}));}),i),e.hooks.annotationPageSwitched.on((t=>{const e=i.getPage(t.from.pageUid),n=i.getPage(t.to.pageUid);if(e){const i=e.annotations.indexOf(t.annotationUid);e.annotations.splice(i,1);}n&&n.annotations.push(t.annotationUid);}),i);}},ox={canvasStyle:{cursor:"default"},currentPageStyle:{border:""},pageStyle:{border:"2px solid #707070",background:"#e2e2e2"},selectedPageStyle:{background:"#6f76ff",border:"2px solid #e98b1f"},hoveredPageStyle:{background:"#a5a9fb",border:"2px solid #e98b1f"},placeholderStyle:{background:"#b5b5b5",border:"0px solid #f00"},pageNumberStyle:{width:24,height:24,left:"50%",top:"",right:"",bottom:"0px",translateX:"-50%",translateY:0,border:"0px solid #000",borderRadius:0,background:"#fff",opacity:1,visibility:"visible",onPage:!1,color:"#000",fontSize:12,fontFamily:"sans-serif",textAlign:"center",textBaseline:"middle"},checkboxStyle:{width:24,height:24,left:0,top:0,right:"",bottom:"",translateX:0,translateY:0,border:"1px solid #000",borderRadius:0,background:"#fff",opacity:1,visibility:"visible",visibleByHover:!0,checkMarkColor:"#000",checkMarkLineWidth:2},removeBtnStyle:{visibility:"visible",width:24,height:24,background:"#fff",border:"1px solid #515151",borderRadius:"50%",opacity:1,left:"",top:-8,right:-8,bottom:"",checkMarkColor:"#ea2e2e"},quadSelectionStyle:{border:"1px dashed #fe8e14",ctrlBorderRadius:0,ctrlBorder:"1px dashed #fe8e14",ctrlWidth:10,ctrlHeight:10,invalidCtrlBorderColor:"#fe8e14",invalidBorderColor:"#fe8e14"},textSelectionStyle:{background:"rgba(51,103,209,0.5)",ctrlBackground:"rgba(51,103,209,0.8)",ctrlBorderRadius:8,ctrlBorderWidth:1,ctrlBorderColor:"rgba(51,103,209,0.8)"},textSearchStyle:{background:"rgba(248, 245, 33, 0.8)",currentBackground:"rgba(255, 174, 0, 0.8)"},croppingMagnifierStyle:{type:"circle",size:100,borderColor:"#323232",borderWidth:3,crosshairWidth:1,crosshairColor:"#323232",magnification:3},textMagnifierStyle:{type:"circle",size:100,borderColor:"#323232",borderWidth:3,magnification:3},cursorStyle:{default:"default",annotationSelect:"crosshair",annotationDraw:"crosshair",annotationMove:"move",annotationNSResize:"ns-resize",annotationEWResize:"ew-resize",annotationNWResize:"nw-resize",annotationNEResize:"ne-resize",annotationSWResize:"sw-resize",annotationSEResize:"se-resize",annotationRotate:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAsUlEQVR4nOXSwXHCMBQG4VVHdBC5g5TgVJASonTgVJCUkBJEBVACJUAHrHh4gAFmEFd25rNP/qWDE6cWysCkh5sH3vWrHxU6agOfmtSqhPO2Wmqtq5JG4vTWUpXLFsrASh/acFZSayRGvlW4XSFuO2itQ0lzmTht0r0K8KZBh5J62ypzvMUzAxX416SnBgpRwV5s4EutTFSBXc/ASPxsczvlnoHWyGlkUE0+evvDD4k3ex4wI7FMVvTgAAAAAElFTkSuQmCC) -15 15, auto",annotationErase:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAATtJREFUOE+Vk8ErRFEUxs93/gXZUUrNhiRFWUkWVpaWSomlpaVkaUlZ2CiWllZKjbJQVqQokaYspPwL5+e9aeb15s17z7i7273nd77v3O/KBliSrs1sycxugMV8if6ql3RpZiPAvaR5M/vJQ2oBki7MbBR47DYqQioB7n4OjAHPRZV5SCnA3U+AceCtyqKkZTP76AO4+yHQAFoDzGerB+DuB8DUgMXpQL8zgLvvA3P/KG4BK13AnqQFMxsC7uqkS5o1s3dgNb0ndz9ON8BwAmnWQSRNS3qNiLXcswogs1IFSTIxIeklIjZ7kij1AtqyCkokNSQ9RcR2Xybc/QyYASYL5LYdM/uS9BARO2WzaUvvdLS+jyI1Jd1GxG5loHLDSDtmEEmfSWSvImKj9lXyh+5+Cqx3VB2VeS7CfgHdAKKUgZXPMQAAAABJRU5ErkJggg==) 10 10,auto",annotationActivable:"pointer",pan:"grab",panning:"grabbing",text:"text",textHover:"default",cropDraw:"crosshair",cropMove:"move",cropNSResize:"ns-resize",cropEWResize:"ew-resize",cropNWResize:"nw-resize",cropNEResize:"ne-resize",cropSWResize:"sw-resize",cropSEResize:"se-resize",zoomIn:"zoom-in",zoomOut:"zoom-out"},enableDragPage:!0,dragThreshold:3,dragStartTimeThreshold:500,enablePanX:!0,enablePanY:!0,panThreshold:3,enableZoom:!0,enableZoomWithCtrl:!0,enableZoomWithTouch:!0,zoom:1,minZoom:.02,maxZoom:8,wheelZoomFactor:1.2,tapZoomFactor:1.2,zoomOrigin:{x:"center",y:"center"},enableZoomInCropMode:!0,enableZoomInPanMode:!0,enableZoomInAnnotationMode:!0,enableSlide:!0,startSlideThreshold:20,slideThreshold:.2,startSlideThresholdForPerspective:30,slideThresholdForPerspective:.2,multiselectMode:!1,enableSelectWithShift:!0,enableSelectWithCtrl:!0,enableTextSelection:!0,enableTextMagnifier:!0,enableEditCropBoxVertices:!0,enableEditCropBoxMidpoints:!0,enableHideEditingCropBoxVertex:!0,enableHideEditingCropBoxMidpoint:!0,enableMagnifier:!0,scrollDirection:"vertical",displayMode:"single",fitMode:"window",margin:10,rows:4,columns:1,maxRows:20,maxColumns:20,hasThb:!1,visibility:"visible",viewerMode:dg.DEFAULT,toolMode:"pan",annotationMode:"select",enableMultiTab:!1,scrollToLatest:!1,autoScroll:!0,autoChangeIndex:!0,enableLoadSourceByDrag:!0,enterTextModeTime:150,enterTextModeTimeMobile:500,multipleClickTimeout:500,textSearchDelay:500,enableCursorService:!0,maxUndoRedoTimes:1e3,enableFillColor:!0,blankFillColor:"#fff",maxOptimizationSize:7e3,enableOptimizePage:!1,enableAnnotationInteraction:!0,enableSelectAnnotation:!0,enableRotateAnnotation:!0,enableMoveAnnotation:!0,enableResizeAnnotation:!0,copyAnnotationOffset:10,enableKeyboardInteraction:!0,enableZoomInWithKeyboard:!0,enableZoomOutWithKeyboard:!0,enableUndoWithKeyboard:!0,enableRedoWithKeyboard:!0,enableDeleteWithKeyboard:!0,enableSelectAllWithKeyboard:!0,enableMoveAnnotationWithKeyboard:!0,enableSaveWithKeyboard:!0,enableLoadSourceWithKeyboard:!0,enablePrintWithKeyboard:!0,enableSelectPageWithKeyboard:!0,enableCopyCutPasteWithKeyboard:!0,enableMultipleSelectAnnotationWithKeyboard:!0,moveAnnotationStepSize:2,moveAnnotationAcceleration:1};class rx extends ka{constructor(){super({name:"Checkbox"}),i(this,"shapeType","checkbox"),i(this,"checkboxStyle",void 0),i(this,"parsedCheckboxStyle",void 0),i(this,"isChecked",!1);}get checked(){return this.isChecked}set checked(t){this.isChecked=t;}updateStyle(t){Object.assign(this.style,t);}}class ax extends ka{constructor(){super({name:"PageNumber"}),i(this,"shapeType","pageNumber"),i(this,"text",void 0),i(this,"parsedPageNumberStyle",void 0),this.text="0";}updateText(t){this.text=t;}updateStyle(t){Object.assign(this.style,t);}}class lx extends ka{constructor(){super({name:"TextSelection"}),i(this,"shapeType","textSelection"),i(this,"lines",void 0),i(this,"parsedTextSelectionStyle",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0);}updateLines(t){this.lines=t;}updateStyle(t){Object.assign(this.style,t);}isPointOnTextSelection(t){var e;return !(null===(e=this.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}hasSelectedText(){var t;return !(null===(t=this.lines)||void 0===t||!t.length)}}class hx extends ka{constructor(){super({name:"SearchedText"}),i(this,"shapeType","textSearch"),i(this,"lines",void 0),i(this,"selectedTextUid",void 0);}update(t){this.lines=t;}updateStyle(t){Object.assign(this.style,t);}setCurrent(t){this.selectedTextUid=t;}clear(){this.selectedTextUid=null,this.lines=null,this.style.lines=null;}}class cx extends Fa{constructor(t){super({...t,name:"TabPage"}),i(this,"uid",void 0),i(this,"tab",void 0),i(this,"isSelected",!1),i(this,"isHovered",!1),i(this,"isDragging",!1),i(this,"isLoading",!1),i(this,"isPreload",!1),i(this,"isLoaded",!1),i(this,"rWidth",void 0),i(this,"rHeight",void 0),i(this,"rotation",0),i(this,"cropLeft",void 0),i(this,"cropTop",void 0),i(this,"cropWidth",void 0),i(this,"cropHeight",void 0),i(this,"mediaBoxRect",void 0),i(this,"cropBoxRect",void 0),i(this,"isOptimized",!1),i(this,"optimizedUid","1"),i(this,"optimizationUid","2"),i(this,"editUid",void 0),i(this,"editedUid",void 0),i(this,"zoom",1),i(this,"image",void 0),i(this,"borderBox",void 0),i(this,"checkbox",void 0),i(this,"pageNumber",void 0),i(this,"curBox",void 0),i(this,"mediaBox",void 0),i(this,"cropBox",void 0),i(this,"realTimeBox",void 0),i(this,"textSelection",void 0),i(this,"textSearch",void 0),this.tab=t.tab,this.uid=t.uid,this.rWidth=t.style.width,this.rHeight=t.style.height,this.initSubShapes(t);}initSubShapes(t){this.updateStyle({visibility:"hidden"});const e=new Ma({name:"pageImage",id:this.uid,style:{x:0,y:0,zIndex:-99999}}),i=new Fa({name:"pageOptimizedBox",style:{x:0,y:0}}),n=new Fa({name:"pageCropBox"});n.clippable=!0;const s=new Fa({name:"pageMediaBox"}),o=new Fa({name:"pageBorderBox",style:{...t.style,...t.formattedPageStyle}}),r=new Fa({name:"currentStyleBox",style:{visibility:"hidden"}}),a=new rx,l=new ax,h=new lx,{textSelectionStyle:c,textSearchStyle:d}=this.tab.viewerContext.viewerConfig;h.updateStyle({x:0,y:0,visibility:"visible",zIndex:9999,...c});const u=new hx;u.updateStyle({x:0,y:0,visibility:"visible",zIndex:9999,...d}),s.appendChild(e),s.appendChild(h),s.appendChild(u),n.appendChild(s),o.appendChild(i),o.appendChild(n),o.appendChild(r),o.appendChild(a),this.appendChild(l),this.appendChild(o),this.image=e,this.borderBox=o,this.realTimeBox=i,this.pageNumber=l,this.checkbox=a,this.curBox=r,this.cropBox=n,this.mediaBox=s,this.textSelection=h,this.textSearch=u;}getRotation(){let t=this.rotation%360;return t<0&&(t+=360),90*Math.round(t/90)}getRect(){const t=this.realTimeBox.getPosition();return {left:t.x,top:t.y,width:this.rWidth,height:this.rHeight}}setImgDom(t){this.image.style.img=t;}getImgDom(){return this.image.style.img}clearOptimization(){this.isOptimized=!1,this.realTimeBox.imageData=null,this.image.updateStyle({visibility:"visible"}),this.optimizationUid=Jn();}destroy(){this.image.style.img=null,this.image=null,this.realTimeBox=null;}setPage(t,e,i,n){this.updateStyle({x:t,y:e,width:i,height:n});}setBorderBox(t,e,i,n,s){_n(s)?this.borderBox.updateStyle({x:t,y:e,width:i,height:n}):this.borderBox.updateStyle({x:t,y:e,width:i,height:n,borderWidth:s});}setCropBox(t,e,i,n,s){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this.cropBox.setLocalScale(1),this.cropBox.updateStyle({x:t,y:e,width:i,height:n}),this.cropBox.setLocalScale(s),this.cropBox.setLocalAngle(o),180===this.cropBox.getAngle()&&this.cropBox.setLocalAngle(179.9);}setRealTimeBox(t,e,i,n,s){this.realTimeBox.setLocalScale(1),this.realTimeBox.updateStyle({x:t,y:e,width:i,height:n}),this.realTimeBox.setLocalScale(s,s);}setMediaBox(t,e,i,n){this.mediaBox.updateStyle({x:t,y:e,width:i,height:n});}setCurBox(t,e,i,n){this.curBox.updateStyle({x:t,y:e,width:i,height:n});}setImage(t,e,i,n){this.image.updateStyle({x:t,y:e,width:i,height:n});}setTextSelection(t){this.textSelection&&this.textSelection.updateLines(t);}setTextSelectionStyle(t){this.textSelection&&this.textSelection.updateStyle(t);}setStartCharRect(t){this.textSelection&&(this.textSelection.startCharRect=t);}setEndCharRect(t){this.textSelection&&(this.textSelection.endCharRect=t);}isPointOnTextSelection(t){var e;return !(null===(e=this.textSelection.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}isPointOnTextStart(t){var e,i;if(null===(e=this.textSelection)||void 0===e||null===(e=e.lines)||void 0===e||!e.length)return !1;const n=null===(i=this.textSelection)||void 0===i?void 0:i.startCharRect;if(!n)return !1;if(fv(t,this.textSelection.startCharRect))return !0;const s=this.textSelection.getScale().x,o=this.textSelection.style.ctrlBorderRadius/s;return as({x:n.left+n.width/2,y:n.top-o},t)<=o}isPointOnTextEnd(t){var e,i;if(null===(e=this.textSelection)||void 0===e||null===(e=e.lines)||void 0===e||!e.length)return !1;const n=null===(i=this.textSelection)||void 0===i?void 0:i.endCharRect;if(!n)return !1;if(fv(t,this.textSelection.endCharRect))return !0;const s=this.textSelection.getScale().x,o=this.textSelection.style.ctrlBorderRadius/s;return as({x:n.left+n.width/2,y:n.top+n.height+o},t)<=o}setSearchedText(t){const e=t.texts.map((t=>({textUid:t.textUid,boxes:t.lines.map((t=>t.box))})));this.textSearch.update(e);}selectSearchedText(t){this.textSearch.setCurrent(t);}clearSearchedText(){this.textSearch.clear();}getTextSelectionBoundingForCanvas(){var t;if(null===(t=this.textSelection)||void 0===t||null===(t=t.lines)||void 0===t||!t.length)return null;const{lines:e}=this.textSelection;let i=e[0].left,n=e[0].top,s=e[0].left+e[0].width,o=e[0].top+e[0].height;e.forEach((t=>{const e=t.left+t.width,r=t.top+t.height;i=Math.min(i,t.left),n=Math.min(n,t.top),s=Math.max(s,e),o=Math.max(o,r);}));const{x:r,y:a}=this.textSelection.getScale(),{x:l,y:h}=this.textSelection.getPosition();return {left:i*r+l,top:n*a+h,width:(s-i)*r,height:(o-n)*a}}getTextSelectionControlPointsRect(){const{startCharRect:t,endCharRect:e}=this.textSelection,i=[],{ctrlBorderRadius:n}=this.textSelection.style,{x:s,y:o}=this.textSelection.getScale(),{x:r,y:a}=this.textSelection.getPosition(),{width:l,height:h}=this,c=this.getRotation(),d=90===c||180===c?r-l:r,u=180===c||270===c?a-h:a;if(t){const{left:e,top:r,width:a}=t;let p=e+a/2,g=r,f=p*s+d-n,v=g*o+u-2*n;90===c?(p=l/s-r,g=e+a/2,f=p*s+d,v=g*o+u-n):180===c?(p=l/s-e-a/2,g=h/o-r,f=p*s+d-n,v=g*o+u):270===c&&(p=r,g=h/o-e-a/2,f=p*s+d-2*n,v=g*o+u-n);const m={left:f,top:v,width:2*n,height:2*n};i.push(m);}if(e){const{left:t,top:r,width:a,height:p}=e;let g=t+a/2,f=r+p,v=g*s+d-n,m=f*o+u;90===c?(g=l/s-r-p,f=t+a/2,v=g*s+d-2*n,m=f*o+u-n):180===c?(g=l/s-t-a/2,f=h/o-r-p,v=g*s+d-n,m=f*o+u-2*n):270===c&&(g=r+p,f=h/o-t-a/2,v=g*s+d,m=f*o+u-n/2);const y={left:v,top:m,width:2*n,height:2*n};i.push(y);}return i}}function dx(t){const{borderWidth:e,borderColor:i,borderStyle:n}=ws(t),s=parseInt(e||"0px",10);let o=[0,0];return "dashed"===n&&(o=[2*s,s]),{borderWidth:s,borderStyle:o,borderColor:i||"",lineDash:o}}const ux=t=>{const{border:e}=t;if(!e)return 0;const i=e.match(/[0-9]+/g)[0];return parseInt(i||"0",10)};function px(t,e){if(_n(t)||""===t)return null;const i=yr(t);return "%"===i.unit?e*i.value/100:i.value}function gx(t,e,i){t.style.width=`${e}px`,t.style.height=`${i}px`;}function fx(t){const e=devicePixelRatio;return Xn(t)&&t>0?(t=Math.floor(t*e)/e)||(t=1/e):t=0,t}function vx(t){const e=devicePixelRatio;return Xn(t)?(t=Math.round(t*e)/e)||(t=1/e):t=0,t}function mx(t){return vx(t)}const yx=()=>{const t=document.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",document.body.appendChild(t);const e=t.offsetWidth-t.clientWidth;return document.body.removeChild(t),e};function xx(t,e,i,n){const s={isOver:!1,pointerX:-1,pointerY:-1,page:t};if(t){const{x:o,y:r}=t.getPosition(),{width:a,height:l}=t,h=(n%360+360)%360/90,c=t.getScale();let d=-1,u=-1;0===h?(d=(e-o)/c.x,u=(i-r)/c.y,s.isOver=e>=o&&i>=r&&e<=o+a&&i<=r+l):1===h?(d=(i-r)/c.x,u=(o-e)/c.y,s.isOver=e>=o-l&&i>=r&&e<=o&&i<=r+a):2===h?(d=(o-e)/c.x,u=(r-i)/c.y,s.isOver=e>=o-a&&i>=r-l&&e<=o&&i<=r):3===h&&(d=(r-i)/c.y,u=(e-o)/c.x,s.isOver=e>=o&&i>=r-l&&e<=o+a&&i<=r),s.pointerX=d,s.pointerY=u;}return s}function wx(t,e,i,n){const s={isOver:!1,pointerX:-1,pointerY:-1,page:t};if(t&&n){const{x:n,y:o}=t.getPosition(),{width:r,height:a}=t;s.isOver=e>=n&&i>=o&&e<=n+r&&i<=o+a;const l=t.getScale();s.pointerX=(e-n)/l.x,s.pointerY=(i-o)/l.y;}return s}class bx{constructor(t,e){i(this,"tab",void 0),i(this,"viewerContext",void 0),i(this,"viewportWidth",600),i(this,"viewportHeight",800),i(this,"currentViewportWidth",0),i(this,"currentViewportHeight",0),i(this,"currentLayoutWidth",0),i(this,"currentLayoutHeight",0),i(this,"placeholderPages",[]),i(this,"scrollLeft",0),i(this,"scrollTop",0),i(this,"maxScrollLeft",0),i(this,"maxScrollTop",0),i(this,"startRow",0),i(this,"endRow",0),i(this,"startColumn",0),i(this,"endColumn",0),i(this,"preloadCount",1),i(this,"pagePreloadChanges",[]),i(this,"direction","vertical"),i(this,"displayMode",void 0),i(this,"fitMode",void 0),i(this,"rows",void 0),i(this,"columns",void 0),i(this,"zoom",void 0),i(this,"defaultReference",void 0),i(this,"zoomReference",void 0),i(this,"resizeReference",void 0),i(this,"oldZoom",void 0),i(this,"isZoomChanged",void 0),i(this,"isOutOfBounds",void 0),i(this,"isScrollbarResized",!0),i(this,"scrollbarWidthCache",void 0),i(this,"defaultWidth",void 0),i(this,"defaultHeight",void 0),this.tab=t,this.viewerContext=e;const{viewerConfig:n}=e;this.rows=n.rows,this.columns=n.columns,this.zoom=n.zoom,this.oldZoom=n.zoom,this.displayMode=n.displayMode,this.fitMode=n.fitMode,this.direction=n.scrollDirection,this.isZoomChanged=!1,this.isOutOfBounds=!1;}get isVertical(){return "vertical"===this.direction}get isContinuousDisplay(){return "continuous"===this.displayMode}get isSingleDisplay(){return "single"===this.displayMode}get scrollbarWidth(){if(!this.isScrollbarResized&&this.scrollbarWidthCache)return this.scrollbarWidthCache;const t=yx();return this.scrollbarWidthCache=t,this.isScrollbarResized=!1,t}getRealRowAndColumnContinuous(){const{rows:t,columns:e,isVertical:i}=this,{total:n}=this.tab;let s=t,o=e;return i?(s=Math.ceil(n/e),n<=e&&(o=Math.max(1,n),s=1)):(o=Math.ceil(n/t),n<=t&&(s=Math.max(1,n),o=1)),{realRow:s,realColumn:o}}getRealRowAndColumnThumbnail(){const{total:t}=this.tab,{rows:e,columns:i,isVertical:n}=this,s=n?i:Math.ceil(t/e);return {realRow:n?Math.ceil(t/i):e,realColumn:s}}getZoomOriginCord(){const{zoomOrigin:t}=this.viewerContext.viewerConfig,e={start:0,center:.5,end:1};return {originX:this.currentViewportWidth*e[t.x],originY:this.currentViewportHeight*e[t.y]}}getMargin(){return this.formatMarginAndGap(this.viewerContext.viewerConfig.margin)}getPageBorderWidth(){const{styleService:t}=this.viewerContext,{borderWidth:e}=t.getParsedPageStyle();return {borderWidth:e,selectedBorderWidth:t.getParsedSelectedPageStyle().borderWidth,hoveredBorderWidth:t.getParsedHoveredPageStyle().borderWidth}}getPages(){return this.tab.pages}getParsedPageNumberStyle(t,e){return this.viewerContext.styleService.getParsedPageNumberStyle({width:t,height:e})}getPageNumberStyle(){return this.viewerContext.viewerConfig.pageNumberStyle}getParsedCheckboxStyle(t,e){return this.viewerContext.styleService.getParsedCheckboxStyle({width:t,height:e})}getParsedPageStyle(){return this.viewerContext.styleService.getParsedPageStyle()}getParsedCurrentPageStyle(){return this.viewerContext.styleService.getParsedCurrentPageStyle()}getParsedSelectedPageStyle(){return this.viewerContext.styleService.getParsedSelectedPageStyle()}getParsedHoveredPageStyle(){return this.viewerContext.styleService.getParsedHoveredPageStyle()}getParsedPlaceholderStyle(){return this.viewerContext.styleService.getParsedPlaceholderStyle()}getParsedCanvasStyle(){return this.viewerContext.styleService.getParsedCanvasStyle()}formatMarginAndGap(t){if(Gn(t)){if(/px/.test(t)){const[e]=t.match(/(\d+)/);return parseInt(e,10)}const e=this.viewerContext.rendererService.getCanvasDom();if(/%/.test(t)){const i=e.width/xs(),[n]=t.match(/(\d+)/);return i*parseInt(n,10)/100}if(/em/.test(t)){const i=getComputedStyle(e).fontSize,[n]=i.match(/(\d+)/),[s]=t.match(/(\d+)/);return parseInt(n,10)*parseInt(s,10)}}return Xn(t)?t:parseInt(t,10)}setZoom(t){this.oldZoom=this.zoom,this.zoom=t,this.tab.pages.forEach((e=>{e.zoom=t;}));}getTabOffset(){const{maxScrollLeft:t,maxScrollTop:e,currentLayoutWidth:i,currentLayoutHeight:n,currentViewportWidth:s,currentViewportHeight:o,scrollLeft:r,scrollTop:a}=this;let l=0,h=0;const c=this.getParsedCanvasStyle().borderWidth||0;return l=t>0?-r:(s-(i-2*c))/2,h=e>0?-a:(o-(n-2*c))/2,{offsetX:l,offsetY:h}}parseReferenceDefault(){const{tab:t,maxScrollLeft:e,maxScrollTop:i}=this,n=t.current,s=this.placeholderPages[n];if(!s)return {scrollLeft:0,scrollTop:0};const o=this.getMargin();let r=s.x-o,a=s.y-o;return this.isContinuousDisplay&&(r=s.pageX-o,a=s.pageY-o),r=Yn(r,0,e),a=Yn(a,0,i),{scrollLeft:r,scrollTop:a}}parseReferenceZoom(t,e,i){if(_n(t)&&(t=this.zoomReference),_n(e)||_n(i)){const{originX:t,originY:n}=this.getZoomOriginCord();e=t,i=n;}let{scrollLeft:n,scrollTop:s}=this.parseReference(t,e,i);const{maxScrollLeft:o,maxScrollTop:r}=this;return n=Yn(n,0,o),s=Yn(s,0,r),{scrollLeft:n,scrollTop:s}}parseReferenceResize(){const{resizeReference:t}=this;let{scrollLeft:e,scrollTop:i}=this.parseReference(t,0,0);const{maxScrollLeft:n,maxScrollTop:s}=this;return e=Math.min(e,n),i=Math.min(i,s),{scrollLeft:e,scrollTop:i}}updateReference(){const{currentViewportWidth:t,currentViewportHeight:e}=this,i=this.generateReference(0,0),n=this.generateReference(t/2,e/2),{originX:s,originY:o}=this.getZoomOriginCord(),r=this.generateReference(s,o);this.defaultReference=n,this.resizeReference=i,this.zoomReference=r;}generateReference(t,e){let i,n,s,o,r=null,a=Number.MAX_VALUE;const{offsetX:l,offsetY:h}=this.getTabOffset(),{zoom:c}=this;this.placeholderPages.forEach((d=>{if(d&&("single"===this.displayMode&&d.uid===this.tab.currentUid||"continuous"===this.displayMode)){const u=d.x+l,p=d.y+h,g=new os(u+d.width/2,p+d.height/2).distanceTo({x:t,y:e});g<a&&(a=g,r=d.uid,t<u?(i="start",s=u-t):t>u+d.width?(i="end",s=t-(u+d.width)):(i="center",s=(t-u)/c),e<p?(n="start",o=p-e):e>p+d.height?(n="end",o=e-(p+d.height)):(n="center",o=(e-p)/c));}}));return {pageX:s,pageY:o,positionX:i,positionY:n,pageUid:r}}parseReference(t,e,i){const{pageX:n,pageY:s,positionX:o,positionY:r,pageUid:a}=t,l=this.placeholderPages.find((t=>t.uid===a)),{zoom:h}=this;let c,d,u=0,p=0;return l&&("start"===o?c=l.x-n:"center"===o?c=l.x+n*h:"end"===o&&(c=l.x+l.width+n),"start"===r?d=l.y-s:"center"===r?d=l.y+s*h:"end"===r&&(d=l.y+l.height+s)),u=c-e,p=d-i,{scrollLeft:u,scrollTop:p}}getScrollValuesByCurrentChanged(){const{placeholderPages:t,currentViewportWidth:e,currentViewportHeight:i,startRow:n,endRow:s,startColumn:o,endColumn:r,isVertical:a}=this,{current:l}=this.tab,h=this.getMargin(),{realRow:c,realColumn:d}=this.getRealRowAndColumnThumbnail();let u=l,p=l;a?(u=n*d+o,p=s*d+r):(u=o*c+n,p=r*c+r);let g=Yn(this.scrollLeft,0,this.maxScrollLeft),f=Yn(this.scrollTop,0,this.maxScrollTop);if(l>=u&&l<=p)return {scrollLeft:g,scrollTop:f};const v=t[l];return v&&(a?(g=0,l<u?f=v.y-h:l>p&&(f=v.y+v.height+h-i)):(f=0,l<u?g=v.x-h:l>p&&(g=v.x+v.width+h-e))),g=Yn(g,0,this.maxScrollLeft),f=Yn(f,0,this.maxScrollTop),{scrollLeft:g,scrollTop:f}}getCurrentByScroll(){let t=this.tab.current;const{placeholderPages:e,currentViewportWidth:i,currentViewportHeight:n,startRow:s,endRow:o,startColumn:r,endColumn:a,isVertical:l}=this,{realRow:h,realColumn:c}=this.getRealRowAndColumnContinuous(),d=i/2,u=n/2,{offsetX:p,offsetY:g}=this.getTabOffset(),{current:f}=this.tab;let v=Number.MAX_VALUE,m=Number.MAX_VALUE,y=l?Math.floor(f/c):f%h,x=l?f%c:Math.floor(f/h);for(let t=s;t<=o;t++){const i=e[t*c];if(!i)continue;const{y:n,height:s}=i,o=n+g,r=o-u,a=u-o-s;if(r<=0&&a<=0){y=t;break}r>0&&r<m?(m=r,y=t):a>0&&a<m&&(m=a,y=t);}for(let t=r;t<=a;t++){const i=e[r];if(!i)continue;const{x:n,width:s}=i,o=n+p,a=o-d,l=d-o-s;if(a<=0&&l<=0){x=t;break}a>0&&a<v?(v=a,x=t):l>0&&l<v&&(v=l,x=t);}return t=y*c+x,t===this.tab.current?null:t}setTabScrollValue(t,e){this.scrollLeft=t,this.scrollTop=e;const{offsetX:i,offsetY:n}=this.getTabOffset();this.tab.setPosition({x:i,y:n});}}class Sx extends ka{constructor(t,e){super({name:"DocTab"}),i(this,"uid",void 0),i(this,"docType",void 0),i(this,"docName",void 0),i(this,"doc",void 0),i(this,"isActive",!1),i(this,"currentUid",void 0),i(this,"total",void 0),i(this,"selected",void 0),i(this,"context",void 0),i(this,"viewerContext",void 0),i(this,"shiftReference",void 0),i(this,"oldCurrentUid",void 0),i(this,"oldCurrent",void 0),i(this,"oldTotal",void 0),i(this,"pageMap",new Map),i(this,"textPages",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"selectedTextsCache",void 0),i(this,"visibleChildren",[]),i(this,"isTab",!0),this.doc=t,this.uid=t.uid,this.docName=t.name,this.docType=t.type,this.total=0,this.selected=[],this.viewerContext=e,this.context=new bx(this,e),this.oldCurrent=-1,this.oldCurrentUid=void 0,t.pages.forEach((t=>{const e=this.createPage(t);this.pageMap.set(t,e),this.appendChild(e);})),this.total=t.pages.length,this.total>0&&(this.updateOldInfo(),this.currentUid=this.pages[this.scrollToLatest?this.total-1:0].uid),this.oldTotal=0;}get scrollToLatest(){let{scrollToLatest:t}=this.viewerContext.viewer.group.config;return _n(t)&&(t=this.viewerContext.viewerConfig.scrollToLatest),t}get pages(){return this.childNodes}get current(){return this.currentUid?this.uidToIndex(this.currentUid):-1}get isDocType(){return "document"===this.docType}createPage(t){const{pageStyle:e,pageNumberStyle:i,checkboxStyle:n,removeBtnStyle:s,blankFillColor:o}=this.viewerContext.viewerConfig,r=function(t){const{border:e,background:i}=t;let n={};e&&(n=dx(e));return {background:i,...n}}(e),{width:a,height:l}=this.viewerContext.getPageRenderSize(t);return new cx({tab:this,uid:t,formattedPageStyle:r,pageNumberStyle:i,checkboxStyle:n,removeBtnStyle:s,blankFillColor:o,style:{pointerEvents:"auto",width:a,height:l}})}updateOldInfo(){this.oldCurrentUid=this.currentUid,this.oldCurrent=this.current,this.oldTotal=this.total;}updateViewportSize(t,e){this.context.viewportWidth=t,this.context.viewportHeight=e;}rename(t){this.docName=t;}getCurrentPage(){return this.getPageByUid(this.currentUid)}getAllPageUids(){return this.pages.map((t=>t.uid))}appendPages(t,e,i){const n=t.length;if(!n)return;const s=Xn(i);if(t.forEach(((t,e)=>{const n=this.createPage(t);this.pageMap.set(t,n),this.appendChild(n,s?i+e:void 0);})),this.total=this.pages.length,e)this.currentUid=this.indexToUid(s?i+n-1:this.total-1),this.updateDefaultReference();else if(!this.currentUid){var o;this.currentUid=null===(o=this.pages[0])||void 0===o?void 0:o.uid,this.updateDefaultReference();}}deletePages(t){this.updateOldInfo();const e=[...t],i=t.includes(this.currentUid);if(i){const i=t.indexOf(this.currentUid);e.splice(i,1),e.push(this.currentUid);}e.forEach((t=>{const e=this.getPageByUid(t);if(i&&e.uid===this.currentUid){if(1===this.total)this.currentUid=null;else {const{current:t}=this,e=t===this.total-1?-1:1;this.currentUid=this.indexToUid(t+e);}this.updateDefaultReference();}if(Rs(this.selected,t),this.removeChild(e),this.pageMap.delete(e.uid),this.total-=1,this.textPages){const t=this.textPages.findIndex((t=>t.pageUid===e.uid));t>-1&&this.textPages.splice(t,1);}})),0===this.total&&(this.oldTotal=0,this.currentUid=null,this.selected=[],this.visibleChildren=[],this.context.placeholderPages=[]);}deleteAllPages(){this.updateOldInfo();[...this.pages].forEach((t=>{this.removeChild(t),this.pageMap.delete(t.uid);})),this.visibleChildren=[],this.currentUid=null,this.selected=[],this.context.placeholderPages=[],this.total=0,this.oldTotal=0;}movePages(t,e){return this.updateOldInfo(),Is(this.pages,t,e)}switchPage(t,e){return this.updateOldInfo(),Ms(this.pages,t,e)}reorderPages(t){return (!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.updateOldInfo(),Bs(this.pages,t)}gotoPage(t){return 0===this.total?-1:(this.updateOldInfo(),t!==this.current&&(t=Yn(t,0,this.total-1),this.currentUid=this.indexToUid(t),this.updateDefaultReference()),this.updateShiftReference(),t)}selectPages(t){this.pages.forEach((e=>{e.isSelected=t.includes(e.uid);})),this.selected=t;}selectPagesByIndices(t){const e=this.indicesToUids(t);this.selectPages(e);}getSelected(){return this.selected.slice()}getSelectedIndices(){return this.selected.map((t=>this.uidToIndex(t)))}getPageByIndex(t){return this.pages[t]}getPageByUid(t){return this.pageMap.get(t)}getPageIndex(t){return this.pages.findIndex((e=>e.uid===t.uid))}uidToIndex(t){return this.pages.findIndex((e=>e.uid===t))}uidsToIndices(t){return t.map((t=>this.uidToIndex(t)))}indexToUid(t){var e;return null===(e=this.pages[t])||void 0===e?void 0:e.uid}indicesToUids(t){return t.map((t=>this.indexToUid(t)))}updateShiftReference(){this.shiftReference=this.currentUid;}updateDefaultReference(){this.context.defaultReference={pageUid:this.currentUid};}setTextSelection(t,e,i,n,s){var o;null===(o=this.textPages)||void 0===o||o.forEach((e=>{const i=this.getPageByUid(e.pageUid);if(i){t.find((t=>t.pageUid===e.pageUid))||i.setTextSelection(null);}})),this.selectedTextsCache=null,this.textPages=t,this.startTextPosition=n,this.endTextPosition=s,this.startCharRect=e,this.endCharRect=i,t.forEach(((n,s)=>{const o=this.getPageByUid(n.pageUid);o.setTextSelection(n.lines.map((t=>t.selectedRect))),o.setStartCharRect(0===s?e:null),o.setEndCharRect(s===t.length-1?i:null);}));}clearTextSelection(){var t;return !(null===(t=this.textPages)||void 0===t||!t.length)&&(this.textPages.forEach((t=>{const e=this.getPageByUid(t.pageUid);e&&(e.setTextSelection([]),e.setStartCharRect(null),e.setEndCharRect(null));})),this.textPages=null,this.startTextPosition=null,this.endTextPosition=null,this.selectedTextsCache=null,!0)}hasSelectedTexts(){return !!this.textPages}getTextSelectionLines(){return this.textPages?this.textPages:null}getTextSelectionControlPointsRect(){if(!this.textPages)return [];const t=[];return this.textPages.forEach((e=>{const i=this.getPageByUid(e.pageUid);t.push(...i.getTextSelectionControlPointsRect());})),t}destroy(){super.destroy(),this.deleteAllPages(),this.isActive=!1,this.doc=null,this.context=null,this.viewerContext=null,this.isDestroyed=!0;}}class Cx extends js{constructor(t){super(),i(this,"tabActivationStack",void 0),i(this,"tabs",void 0),i(this,"activeTabUid",void 0),i(this,"context",void 0),this.tabActivationStack=[],this.tabs=new Map,this.context=t;}dispose(){this.clearTabs(),this.tabActivationStack.length=0,super.dispose();}updateViewportSize(t,e){const i=this.getActiveTab();null!=i&&i.isDocType&&i.updateViewportSize(t,e);}createTab(t){if(this.tabs.has(t.uid))return this.tabs.get(t.uid);let e=null;return "document"===t.type&&(e=new Sx(t,this.context)),this.context.viewerConfig.enableMultiTab||this.clearTabs(),this.tabs.set(e.uid,e),e}closeTab(t){if(!this.tabs.has(t))return !1;const{tabActivationStack:e}=this;if(e.includes(t)){const i=e.indexOf(t);e.splice(i,1);}return this.getTab(t).isActive=!1,this.tabs.delete(t),this.activeTabUid===t&&(this.activeTabUid=e[e.length-1]),!0}getTab(t){return this.tabs.get(t)}getDocTab(t){const e=this.getTab(t);return null!=e&&e.isDocType?e:null}hasTab(t){return this.tabs.has(t)}getActiveTab(){return this.tabs.get(this.activeTabUid)}getActiveTabUid(){return this.activeTabUid}getAllTabs(){return Array.from(this.tabs.values())}activateTab(t){if(!this.tabs.has(t))return !1;const{tabActivationStack:e}=this;if(this.context.viewerConfig.enableMultiTab){if(e.includes(t)){const i=e.indexOf(t);e.splice(i,1);}}else e.length=0;return e.push(t),this.activeTabUid=t,this.tabs.forEach((e=>{e.isActive=e.uid===t;})),!0}clearTabs(){this.getAllTabs().forEach((t=>{t.destroy();})),this.tabs.clear();}resizeScrollbar(){this.tabs.forEach((t=>{t.context.isScrollbarResized=!0;}));}}class Px{constructor(t){i(this,"parsedPageStyleCache",void 0),i(this,"parsedCurrentPageStyleCache",void 0),i(this,"parsedSelectedPageStyleCache",void 0),i(this,"parsedHoveredPageStyleCache",void 0),i(this,"parsedPlaceholderStyleCache",void 0),i(this,"parsedCheckboxStyleCache",void 0),i(this,"parsedPageNumberStyleCache",void 0),i(this,"parsedQuadSelectionStyleCache",void 0),i(this,"parsedCanvasStyleCache",void 0),i(this,"context",void 0),i(this,"isPageStyleChanged",void 0),i(this,"isCurrentPageStyleChanged",void 0),i(this,"isSelectedPageStyleChanged",void 0),i(this,"isHoveredPageStyleChanged",void 0),i(this,"isPlaceholderStyleChanged",void 0),i(this,"isCheckboxStyleChanged",void 0),i(this,"isPageNumberStyleChanged",void 0),i(this,"isQuadSelectionStyleChanged",void 0),i(this,"isCanvasStyleChanged",void 0),this.context=t;}getParsedCanvasStyle(){return !this.isCanvasStyleChanged&&this.parsedCanvasStyleCache||(this.parsedCanvasStyleCache=Tx(this.context.viewerConfig.canvasStyle),this.isCanvasStyleChanged=!1),this.parsedCanvasStyleCache}getParsedCheckboxStyle(t){return !this.isCheckboxStyleChanged&&this.parsedCheckboxStyleCache||(this.parsedCheckboxStyleCache=Tx(this.context.viewerConfig.checkboxStyle,t),this.isCheckboxStyleChanged=!1),this.parsedCheckboxStyleCache}getParsedPageNumberStyle(t){return !this.isPageNumberStyleChanged&&this.parsedPageNumberStyleCache||(this.parsedPageNumberStyleCache=Tx(this.context.viewerConfig.pageNumberStyle,t),this.isPageStyleChanged=!1),this.parsedPageNumberStyleCache}getParsedPageStyle(){return !this.isPageStyleChanged&&this.parsedPageStyleCache||(this.parsedPageStyleCache=Tx(this.context.viewerConfig.pageStyle),this.isPageStyleChanged=!1),this.parsedPageStyleCache}getParsedCurrentPageStyle(){return !this.isCurrentPageStyleChanged&&this.parsedCurrentPageStyleCache||(this.parsedCurrentPageStyleCache=Tx(this.context.viewerConfig.currentPageStyle),this.isCurrentPageStyleChanged=!1),this.parsedCurrentPageStyleCache}getParsedSelectedPageStyle(){return !this.isSelectedPageStyleChanged&&this.parsedSelectedPageStyleCache||(this.parsedSelectedPageStyleCache=Tx(this.context.viewerConfig.selectedPageStyle),this.isSelectedPageStyleChanged=!1),this.parsedSelectedPageStyleCache}getParsedHoveredPageStyle(){return !this.isHoveredPageStyleChanged&&this.parsedHoveredPageStyleCache||(this.parsedHoveredPageStyleCache=Tx(this.context.viewerConfig.hoveredPageStyle),this.isHoveredPageStyleChanged=!1),this.parsedHoveredPageStyleCache}getParsedPlaceholderStyle(){return !this.isPlaceholderStyleChanged&&this.parsedPlaceholderStyleCache||(this.parsedPlaceholderStyleCache=Tx(this.context.viewerConfig.placeholderStyle),this.isPlaceholderStyleChanged=!1),this.parsedPlaceholderStyleCache}getParsedQuadSelectionStyle(){return !this.isQuadSelectionStyleChanged&&this.parsedQuadSelectionStyleCache||(this.parsedQuadSelectionStyleCache=Tx(this.context.viewerConfig.quadSelectionStyle),this.isQuadSelectionStyleChanged=!1),this.parsedQuadSelectionStyleCache}isBorderWidthEqualHovered(){const{viewerConfig:t}=this.context;return ux(t.pageStyle)===ux(t.hoveredPageStyle)}isSelectedBorderWidthEqualHovered(){const{viewerConfig:t}=this.context;return ux(t.selectedPageStyle)===ux(t.hoveredPageStyle)}isSelectedBorderWidthEqualNormal(){const{viewerConfig:t}=this.context;return ux(t.pageStyle)===ux(t.selectedPageStyle)}}function Tx(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{width:0,height:0};const i={};if(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{border:i,ctrlBorder:n}=t;if(!_n(i)){const t=dx(i);Object.assign(e,t);}if(!_n(n)){const t=dx(n);Object.assign(e,{ctrlBorderWidth:t.borderWidth,ctrlBorderColor:t.borderColor,ctrlBorderStyle:t.borderStyle});}}(t,i),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ax.forEach((i=>{_n(t[i])||(e[i]=mr(t[i]).value||0);}));}(t,i),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};kx.forEach((i=>{_n(t[i])||(e[i]=t[i]);}));}(t,i),function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!_n(t.width)&&(i.width=px(t.width,e.width),_n(t.translateX)||(i.translateX=px(t.translateX,i.width)),!_n(t.borderRadius))){const e=px(t.borderRadius,i.width);i.borderRadiusX=Math.max(0,Math.min(e,i.width/2));}if(!_n(t.height)&&(i.height=px(t.height,e.height),_n(t.translateY)||(i.translateY=px(t.translateY,i.height)),!_n(t.borderRadius))){const e=px(t.borderRadius,i.height);i.borderRadiusY=Math.max(0,Math.min(e,i.height/2));}if(!_n(t.borderRadius)){const n=px(t.borderRadius,e.width);i.borderRadius=Math.max(0,Math.min(n,e.height/2,e.width/2));}if(!_n(t.ctrlBorderRadius)){const e=px(t.ctrlBorderRadius,i.ctrlWidth);i.ctrlBorderRadius=Math.max(0,Math.min(e,i.ctrlWidth/2,i.ctrlHeight/2));}Ex.forEach((n=>{const s=["left","right"].includes(n)?e.width:e.height,o=yr(t[n]);let r=o.value;"%"===o.unit&&(r=s*o.value/100),i[n]=r;}));}(t,e,i),t.left||t.right||t.bottom||t.top){const{left:n,top:s,right:o,bottom:r,width:a,height:l,translateX:h,translateY:c}=i;""!==t.left?i.x=n+h||0:""!==t.right&&Xn(a)?i.x=e.width-a-o+h||0:i.x=0,""!==t.top?i.y=s+c||0:""!==t.bottom&&Xn(l)?i.y=e.height-l-r+c||0:i.y=0;}return i}const Ax=["borderWidth","ctrlBorderWidth","checkMarkLineWidth","fontSize","ctrlWidth","ctrlHeight"],kx=["background","maskColor","color","borderColor","borderStyle","invalidBorderColor","ctrlBorderColor","ctrlBackground","ctrlBorderStyle","invalidCtrlBorderColor","checkMarkColor","onPage","opacity","visibility","visibleByHover","fontFamily","textAlign","textBaseline","lineJoin","lineCap"],Ex=["left","top","right","bottom"];const Dx="visible",Rx="hidden";class Ix{constructor(t){i(this,"context",void 0),this.context=t;}handleVisibility(t){if(this.context.isDestroyed||t.isDestroyed||!t.total||!t.isActive)return;const{context:e}=this;if(e.isDefaultViewer?t.context.isContinuousDisplay?this.continuousVisibility(t):t.context.isSingleDisplay&&this.singleVisibility(t):e.isThumbnailViewer?this.thumbnailVisibility(t):e.isPerspectiveViewer&&t.context.isSingleDisplay&&this.singleVisibility(t),t.context.pagePreloadChanges.length){t.context.pagePreloadChanges.forEach((e=>{if(e.from&&!e.to){const i=t.getPageByUid(e.pageUid);i&&(i.isLoaded=!1);}}));const i=Mf.create(t.uid,e.uid,e.viewerConfig.viewerMode,t.context.pagePreloadChanges);e.core.viewerService.onPagePreloadChanged.emit(i);}}thumbnailVisibility(t){const{total:e}=t;if(!e)return;const i=t.context;if(i.isOutOfBounds)return void t.pages.forEach((t=>{t.updateStyle({visibility:"hidden"});}));const{rows:n,columns:s,placeholderPages:o,preloadCount:r,isVertical:a}=i,{width:l,height:h}=o[0],c=i.getParsedPageStyle(),d=i.getParsedCurrentPageStyle(),u=i.getParsedSelectedPageStyle(),p=i.getParsedHoveredPageStyle(),g=i.getParsedPlaceholderStyle(),f=i.getParsedPageNumberStyle(l,h),v=i.getParsedCheckboxStyle(l,h),{visibility:m,top:y,bottom:x,onPage:w,height:b}=f;let S=0;const C="visible"===m,P=i.getPageNumberStyle();if(C){const t=""!==P.top?y:x||0;w||(S=""!==P.top?b+t:0);}const{realColumn:T,realRow:A}=i.getRealRowAndColumnThumbnail(),{startRow:k,endRow:E}=this.getVisibleRow(t,A,T),{startColumn:D,endColumn:R}=this.getVisibleColumn(t,A,T);t.context.startRow=k,t.context.endRow=E,t.context.startColumn=D,t.context.endColumn=R;const I=fx(d.borderWidth),M=[];t.visibleChildren=[],t.pages.forEach(((e,i)=>{const o=a?Math.floor(i/s):i%n,l=a?i%s:Math.floor(i/n),h=o>=k&&o<=E&&l>=D&&l<=R,m=o>=k-r&&o<=E+r&&l>=D-r&&l<=R+r,y=h?Dx:Rx;e.isPreload!==m&&M.push({from:e.isPreload,to:m,pageUid:e.uid,index:i}),h&&t.visibleChildren.push(e);let x={borderWidth:0,background:"#ffffff00"};e.isDragging&&(x=g);let b=c;e.isHovered&&(b=p),e.isSelected&&(b=u);const T=fx(b.borderWidth);if(e.isPreload=m,e.updateStyle({visibility:y,...x}),e.borderBox.updateStyle({...b,visibility:y,borderWidth:T}),C){let t=f.y;w||(t=""!==P.top?-S:f.y+f.bottom),e.pageNumber.parsedPageNumberStyle={...f,y:t},e.pageNumber.updateText((i+1).toString());}e.pageNumber.updateStyle({visibility:f.visibility,zIndex:f.onPage?1:0});let A=v.visibility;v.visibleByHover&&(A=e.isHovered||e.isSelected?v.visibility:"hidden"),e.checkbox.parsedCheckboxStyle={...v},e.checkbox.updateStyle({visibility:A}),e.checkbox.checked=e.isSelected,e.curBox.updateStyle({...d,visibility:e.uid===t.currentUid?Dx:Rx,borderWidth:I});})),t.context.pagePreloadChanges=M;}continuousVisibility(t){const{preloadCount:e,isVertical:i}=t.context,{pages:n}=t,s=t.context.getParsedPageStyle(),o=t.context.getParsedCurrentPageStyle(),{realRow:r,realColumn:a}=t.context.getRealRowAndColumnContinuous(),{startRow:l,endRow:h}=this.getVisibleRow(t,r,a),{startColumn:c,endColumn:d}=this.getVisibleColumn(t,r,a);t.context.startRow=l,t.context.endRow=h,t.context.startColumn=c,t.context.endColumn=d;const u=fx(s.borderWidth),p=fx(o.borderWidth),g=[];t.visibleChildren=[],n.forEach(((n,f)=>{const v=i?Math.floor(f/a):f%r,m=i?f%a:Math.floor(f/r),y=v>=l&&v<=h&&m>=c&&m<=d,x=v>=l-e&&v<=h+e&&m>=c-e&&m<=d+e;n.isPreload!==x&&g.push({from:n.isPreload,to:x,pageUid:n.uid,index:f}),y&&t.visibleChildren.push(n),n.checkbox.updateStyle({visibility:Rx}),n.pageNumber.updateStyle({visibility:Rx}),n.curBox.updateStyle({...o,visibility:n.uid===t.currentUid?Dx:Rx,borderWidth:p}),n.borderBox.updateStyle({...s,borderWidth:u}),n.updateStyle({visibility:y?Dx:Rx}),n.isPreload=x;})),t.context.pagePreloadChanges=g;}singleVisibility(t){const{preloadCount:e}=t.context,{current:i,total:n,pages:s}=t,o=t.getCurrentPage();if(!o)return;const r=t.context.getParsedPageStyle(),a=Math.max(i-e,0),l=Math.min(i+e,n-1);o.checkbox.updateStyle({visibility:Rx}),o.pageNumber.updateStyle({visibility:Rx});const h=fx(r.borderWidth),c=[];t.visibleChildren=[],s.forEach(((e,i)=>{const n=i>=a&&i<=l,s=e.uid===o.uid;e.isPreload!==n&&c.push({from:e.isPreload,to:n,pageUid:e.uid,index:i}),e.borderBox.updateStyle({...r,borderWidth:h}),e.updateStyle({visibility:s?Dx:Rx}),e.isPreload=n,s&&t.visibleChildren.push(e),e.curBox.updateStyle({visibility:Rx});})),t.context.pagePreloadChanges=c;}getVisibleColumn(t,e,i){const{scrollLeft:n,placeholderPages:s,currentViewportWidth:o,isVertical:r}=t.context;let a=0,l=i-1;if(r&&this.context.isThumbnailViewer)return {startColumn:a,endColumn:l};let h=Number.MAX_VALUE,c=Number.MAX_VALUE,d=null,u=null;for(let t=0;t<i;t++){const i=s[r?t:t*e];if(!i)continue;const{width:p,x:g}=i;if(null===d){const e=g-n;e<=0&&n-(g+p)<-1?(d=t,a=t):e>0&&e<h&&(h=e,a=t);}if(null===u){const e=n+o,i=e-(g+p);g-e<-1&&i<=0?(u=t,l=t):i>0&&i<c&&(c=i,l=t);}if(null!==d&&null!==u)break}return {startColumn:a,endColumn:l}}getVisibleRow(t,e,i){const{scrollTop:n,placeholderPages:s,currentViewportHeight:o,isVertical:r}=t.context;let a=0,l=e-1;if(!r&&this.context.isThumbnailViewer)return {startRow:a,endRow:l};let h=Number.MAX_VALUE,c=Number.MAX_VALUE,d=null,u=null;for(let t=0;t<e;t++){const e=s[r?t*i:t];if(!e)continue;const{y:p,height:g}=e;if(null===d){const e=p-n;e<=0&&n-(p+g)<-1?(d=t,a=t):e>0&&e<h&&(h=e,a=t);}if(null===u){const e=n+o,i=e-(p+g);p-e<-1&&i<=0?(u=t,l=t):i>0&&i<c&&(c=i,l=t);}if(null!==d&&null!==u)break}return {startRow:a,endRow:l}}}const Mx={tag:"div",id:"ddv-thumbnail-container",className:"ddv-thumbnail-container"},Bx={tag:"div",id:"ddv-main-container",className:"ddv-main-container",children:[{tag:"div",id:"ddv-scroller-and-canvas",className:"ddv-scroller-and-canvas",children:[{tag:"div",id:"ddv-scroll-container",className:"ddv-scroll-container",children:[{tag:"div",id:"ddv-scroll-content",className:"ddv-scroll-content"}]},{tag:"div",id:"ddv-canvas-container",className:"ddv-canvas-container",children:[]}]}]},Ux={tag:"div",id:"ddv-video-container",className:"ddv-video-container"},Lx={tag:"div",id:"ddv-audio-container",className:"ddv-audio-container"},Ox={tag:"div",id:"ddv-main-and-thumbnail",className:"ddv-main-and-thumbnail"},Wx={tag:"div",id:"ddv-core",className:"ddv-core"};class Nx extends js{constructor(t,e){super(),i(this,"container",void 0),i(this,"defaultDom",void 0),i(this,"mainAndThbContainer",void 0),i(this,"thumbnailContainer",void 0),i(this,"mainContainer",void 0),i(this,"scrollerAndCanvasContainer",void 0),i(this,"scrollContainer",void 0),i(this,"scrollContent",void 0),i(this,"canvasContainer",void 0),i(this,"videoContainer",void 0),i(this,"audioContainer",void 0),i(this,"rootDom",void 0),i(this,"hooks",void 0),i(this,"isBindContainer",!1),i(this,"viewportWidth",void 0),i(this,"viewportHeight",void 0),i(this,"context",void 0),i(this,"dpr",xs()),i(this,"hasScrollbarX",!1),i(this,"hasScrollbarY",!1),i(this,"winResizeTimer",void 0),this.context=t,this.hooks=e;const n=vm(Wx,t.postfix);this.defaultDom=n;}dispose(){var t,e;null===(t=this.rootDom)||void 0===t||t.remove(),null===(e=this.thumbnailContainer)||void 0===e||e.remove(),this.defaultDom=null,this.rootDom=null,this.thumbnailContainer=null,this.context=null,this.dpr=null,super.dispose();}createMainAndThbContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.mainAndThbContainer){const e=vm(Ox,t);this.mainAndThbContainer=e,this.defaultDom.appendChild(e);}}createMainContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.mainContainer){const e=vm(Bx,t);this.mainContainer=e,this.mainAndThbContainer.appendChild(e);const i=e.querySelector(`#ddv-scroller-and-canvas${t}`),n=e.querySelector(`#ddv-canvas-container${t}`),s=e.querySelector(`#ddv-scroll-container${t}`),o=e.querySelector(`#ddv-scroll-content${t}`);this.scrollerAndCanvasContainer=i,this.canvasContainer=n,this.scrollContainer=s,this.scrollContent=o;const r=t=>{t.target===e&&this.isBindContainer&&this.context.isInitialized&&this.context.resize();},{resizeService:a}=this.context.core;a.observe(e),a.onResizeObserver.on(r,this),this.context.hooks.destroy.on((()=>{a.unobserve(e);}),this);}}createThumbnailContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.thumbnailContainer){const e=vm(Mx,t);this.thumbnailContainer=e,this.mainAndThbContainer.insertBefore(e,this.mainContainer);}}createVideoContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.videoContainer){const e=vm(Ux,t);this.mainContainer.appendChild(e);}}createAudioContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.audioContainer){const e=vm(Lx,t);this.mainContainer.appendChild(e);}}getViewportSize(){if(!this.mainContainer)return {width:0,height:0};const{offsetWidth:t,offsetHeight:e}=this.getElSize(this.mainContainer),i=this.getCanvasBorderSize();return {width:t-2*i,height:e-2*i}}resetViewport(){const{scrollContent:t,canvasContainer:e}=this;gx(e,0,0),gx(t,0,0);const{width:i,height:n}=this.getViewportSize();this.viewportWidth=i,this.viewportHeight=n,this.updateCanvasContainerSize();}resizeViewport(){const{canvasContainer:t,scrollContainer:e}=this;gx(t,0,0);const{offsetWidth:i,offsetHeight:n}=this.getElSize(e);this.viewportWidth=i,this.viewportHeight=n,this.updateCanvasContainerSize();}checkIsRound(t){const e=getComputedStyle(t);return {roundWidth:parseFloat(e.width)%1>=.5,roundHeight:parseFloat(e.height)%1>=.5}}getElSize(t){const{roundWidth:e,roundHeight:i}=this.checkIsRound(t);let{clientWidth:n,clientHeight:s,offsetWidth:o,offsetHeight:r}=t;return e&&(n-=1,o-=1),i&&(s-=1,r-=1),{clientWidth:n,clientHeight:s,offsetWidth:o,offsetHeight:r}}getMaxScrollValue(){const{scrollContainer:t}=this;return {scrollLeft:t.scrollWidth-t.clientWidth,scrollTop:t.scrollHeight-t.clientHeight}}isViewerResized(){return this.scrollContainer.offsetWidth!==this.viewportWidth||this.scrollContainer.offsetHeight!==this.viewportHeight}isDPRChanged(){const t=xs();return this.dpr!==t&&(this.dpr=t,!0)}isScrollbarAppeared(){return this.scrollContent.offsetWidth>this.scrollContainer.clientWidth||this.scrollContent.offsetHeight>this.scrollContainer.clientHeight}bindContainer(t){let e=t;return t&&Gn(t)&&(e=document.querySelector(`#${t}`)),e instanceof HTMLElement&&(e.appendChild(this.defaultDom),this.container=e,this.rootDom=this.defaultDom,this.isBindContainer=!0,this.context.resize(),!0)}unbindContainer(){if(!this.container||0===this.container.children.length)return !1;for(let t=0;t<this.container.children.length;t++)if(this.container.children[t]===this.rootDom){this.container.removeChild(this.rootDom);break}return this.isBindContainer=!1,!0}scrollTo(t,e){const{scrollContainer:i}=this;i.scrollTo?i.scrollTo(t,e):(i.scrollLeft=t,i.scrollTop=e);}scrollBy(t,e){const{scrollContainer:i}=this;i.scrollBy?i.scrollBy(t,e):(i.scrollLeft+=t,i.scrollTop+=e);}updateScrollerContentSize(t){const{currentLayoutWidth:e,currentLayoutHeight:i}=t.context,{scrollContent:n,canvasContainer:s,scrollContainer:o}=this;gx(s,10,10),gx(n,e,i);let r=o.scrollWidth-o.clientWidth,a=o.scrollHeight-o.clientHeight;const l=getComputedStyle(o),h=getComputedStyle(n),c=parseFloat(l.width),d=parseFloat(l.height);c>=parseFloat(h.width)&&(r=0),d>=parseFloat(h.height)&&(a=0),t.context.maxScrollLeft=r,t.context.maxScrollTop=a;const u=r>0,p=a>0;let g=!1;u!==this.hasScrollbarX&&(this.hasScrollbarX=u,g=!0),p!==this.hasScrollbarY&&(this.hasScrollbarY=p,g=!0),g&&this.context.clearCurrentTabOptimization(),this.updateCanvasContainerSize();}updateCanvasContainerSize(){const{scrollContainer:t,canvasContainer:e}=this,{width:i,height:n}=getComputedStyle(this.scrollContainer);let s,o=parseFloat(i),r=parseFloat(n);t.offsetWidth!==t.clientWidth&&(Xn(s)||(s=yx()),o-=s),t.offsetHeight!==t.clientHeight&&(Xn(s)||(s=yx()),r-=s),gx(e,o,r);}getCanvasBorderSize(){const{canvasContainer:t}=this;return (t.offsetWidth-t.clientWidth)/2}}class _x{constructor(){i(this,"canvasDom",void 0),i(this,"canvas",void 0),i(this,"renderer",void 0),i(this,"isInitialized",!1),i(this,"canvasWidth",0),i(this,"canvasHeight",0);}clear(){var t;const e=null===(t=this.canvas)||void 0===t?void 0:t.document.documentElement;if(!e)return;e.children.slice().forEach((t=>{e.removeChild(t);})),e.sortable.sorted=[];}appendDocToRoot(t){var e;const i=null===(e=this.canvas)||void 0===e?void 0:e.document.documentElement;if(i)if(t)if(0===i.children.length)i.appendChild(t);else {i.children.indexOf(t)<0&&i.replaceChild(t,i.children[0]);}else {const t=[...i.children];for(let e=t.length;e>=0;e--)i.removeChild(t[e]);}}render(t){var e;(null===(e=this.canvas)||void 0===e?void 0:e.document.documentElement)&&this.canvas.render();}initCanvas(t){let{container:e,width:i,height:n,limit1px:s}=t;const o=new _l({}),r=new xl({renderer:o,container:e,width:i,height:n});r.limit1px=s,this.canvasWidth=i,this.canvasHeight=n,this.renderer=o,this.canvas=r,this.canvasDom=r.contextService.getDomElement(),this.canvasDom.style.width="100%",this.canvasDom.style.height="100%",this.canvasDom.style.touchAction="none",this.isInitialized=!0;}registerShapeRenderer(t,e){this.canvas.contextService.registerShapeRenderer(t,e);}getCanvasPosition(){const t=this.canvasDom.getBoundingClientRect(),{scrollX:e,scrollY:i}={scrollX:void 0===window.scrollX?window.pageXOffset:window.scrollX,scrollY:void 0===window.scrollY?window.pageYOffset:window.scrollY};return {x:t.left+e,y:t.top+i}}resize(t,e){const i=xs();this.canvas.setDPR(i),this.canvasWidth=t,this.canvasHeight=e,this.canvas.resize(t,e);}}class Fx{render(t,e){const{opacity:i,visibility:n}=t.parsedCheckboxStyle;0!==i&&"hidden"!==n&&(e.save(),e.globalAlpha=i,this.renderBox(t,e,"out"),e.clip(),this.renderBox(t,e,"in"),this.fill(t,e),this.renderBox(t,e,"center"),this.stroke(t,e),this.renderCheckMark(t,e),e.restore());}renderBox(t,e,i){const{x:n,y:s,width:o,height:r,borderWidth:a,borderRadiusX:l,borderRadiusY:h}=t.parsedCheckboxStyle;let c=0;"center"===i?c=a/2:"in"===i&&(c=a);const d=[{x:n+l,y:s+h,start:Math.PI,end:3*Math.PI/2},{x:n+o-l,y:s+h,start:3*Math.PI/2,end:2*Math.PI},{x:n+o-l,y:s+r-h,start:0,end:Math.PI/2},{x:n+l,y:s+r-h,start:Math.PI/2,end:Math.PI}],u=Math.max(l-c,0),p=Math.max(h-c,0);if(e.beginPath(),e.ellipse&&u&&p)for(let t=0;t<4;t++){const{x:i,y:n,start:s,end:o}=d[t];e.ellipse(i,n,u,p,0,s,o);}else e.rect(n,s,o,r);e.closePath();}fill(t,e){const{background:i}=t.parsedCheckboxStyle;i&&""!==i&&(e.fillStyle=i,e.fill());}stroke(t,e){const{borderColor:i,borderWidth:n,borderStyle:s}=t.parsedCheckboxStyle;e.setLineDash(s),e.strokeStyle=i,e.lineWidth=n,n>0&&i&&""!==i&&e.stroke();}renderCheckMark(t,e){if(!t.checked)return;const{x:i,y:n,width:s,height:o,borderWidth:r,checkMarkLineWidth:a,checkMarkColor:l}=t.parsedCheckboxStyle,h=Math.max(Math.min(s-2*r,o-2*r),0);let c=i,d=n;0!==h&&(s<o?(c+=r,d=d+r+(o-s)/2):(c=c+r+(s-o)/2,d+=r),e.setLineDash([0,0]),e.lineWidth=a,e.strokeStyle=l,e.beginPath(),e.moveTo(c+.15*h,d+.5*h),e.lineTo(c+.4*h,d+.8*h),e.lineTo(c+.85*h,d+.2*h),e.stroke());}}class Hx{render(t,e){const{opacity:i,visibility:n}=t.parsedPageNumberStyle;0!==i&&"hidden"!==n&&(e.save(),e.globalAlpha=i,this.renderBox(t,e,"out"),e.clip(),this.renderBox(t,e,"in"),this.fill(t,e),this.renderBox(t,e,"center"),this.stroke(t,e),this.renderFont(t,e),e.restore());}renderBox(t,e,i){const{x:n,y:s,width:o,height:r,borderWidth:a,borderRadiusX:l,borderRadiusY:h}=t.parsedPageNumberStyle;let c=0;"center"===i?c=a/2:"in"===i&&(c=a);const d=[{x:n+l,y:s+h,start:Math.PI,end:3*Math.PI/2},{x:n+o-l,y:s+h,start:3*Math.PI/2,end:2*Math.PI},{x:n+o-l,y:s+r-h,start:0,end:Math.PI/2},{x:n+l,y:s+r-h,start:Math.PI/2,end:Math.PI}],u=Math.max(l-c,0),p=Math.max(h-c,0);if(e.beginPath(),e.ellipse&&u&&p)for(let t=0;t<4;t++){const{x:i,y:n,start:s,end:o}=d[t];e.ellipse(i,n,u,p,0,s,o);}else e.rect(n,s,o,r);e.closePath();}renderFont(t,e){const{x:i,y:n,width:s,height:o,fontSize:r,color:a,fontFamily:l}=t.parsedPageNumberStyle;e.fillStyle=a,e.textAlign="center",e.textBaseline="middle",l.includes(" ")?e.font=`${r}px '${l}'`:e.font=`${r}px ${l}`,e.fillText(t.text,i+s/2,n+o/2+r/8,s);}fill(t,e){const{background:i}=t.parsedPageNumberStyle;i&&""!==i&&(e.fillStyle=i,e.fill());}stroke(t,e){const{borderColor:i,borderWidth:n,borderStyle:s}=t.parsedPageNumberStyle;e.setLineDash(s),e.strokeStyle=i,e.lineWidth=n,n>0&&i&&""!==i&&e.stroke();}}class Vx{render(t,e){var i;if(null===(i=t.lines)||void 0===i||!i.length)return;const n=t.style;e.save(),e.fillStyle=t.style.background,e.globalCompositeOperation="multiply",e.beginPath(),t.lines.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath();const s=t.getScale().x,o=n.ctrlBorderRadius/s,r=[];if(t.startCharRect){const{startCharRect:e}=t;r.push({x:e.left+e.width/2,y:e.top-o});}if(t.endCharRect){const{endCharRect:e}=t;r.push({x:e.left+e.width/2,y:e.top+e.height+o});}e.lineWidth=n.ctrlBorderWidth/s,e.strokeStyle=n.ctrlBorderColor,e.fillStyle=n.ctrlBackground,r.forEach((t=>{e.beginPath(),e.ellipse(t.x,t.y,o,o,0,0,2*Math.PI),e.closePath(),n.ctrlBackground&&e.fill(),e.stroke();})),e.restore();}}class zx{render(t,e){var i;if(null===(i=t.lines)||void 0===i||!i.length)return;const{selectedTextUid:n}=t;e.save(),e.globalCompositeOperation="multiply",t.lines.forEach((i=>{i.textUid===n?e.fillStyle=t.style.currentBackground:e.fillStyle=t.style.background,e.beginPath(),i.boxes.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath();})),e.restore();}}class $x extends js{constructor(t,e){super(),i(this,"context",void 0),i(this,"docRenderer",void 0),i(this,"hooks",void 0),i(this,"reasons",[]),i(this,"tab",void 0),this.context=t,this.hooks=e,this.docRenderer=new _x;const n=()=>{null!=this&&this.context&&(this.reasons.length&&this.tab&&(this.internalRender(this.tab),this.tab=null,this.reasons=[]),requestAnimationFrame(n));};requestAnimationFrame(n);}dispose(){super.dispose(),this.context=null,this.docRenderer=null,this.hooks=null;}initRenderer(t,e,i){if(!this.docRenderer.isInitialized){Object.assign(t.style,this.context.viewerConfig.canvasStyle);const n=this.context.isDefaultViewer;this.docRenderer.initCanvas({container:t,width:e,height:i,limit1px:n}),this.docRenderer.registerShapeRenderer("checkbox",new Fx),this.docRenderer.registerShapeRenderer("pageNumber",new Hx),this.docRenderer.registerShapeRenderer("textSelection",new Vx),this.docRenderer.registerShapeRenderer("textSearch",new zx);}}getCanvasDom(){return this.docRenderer.canvasDom}clearCanvas(){const t=this.getCanvasDom();if(!t)return;t.getContext("2d").clearRect(0,0,t.width,t.height);}resize(t,e){this.docRenderer&&this.docRenderer.resize(t,e);}updateCanvasSize(){if(this.docRenderer){const t=this.getCanvasDom();if(!t)return;const{clientWidth:e,clientHeight:i}=t;this.docRenderer.resize(e,i);}}render(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t.isDestroyed||(this.tab=t,this.docRenderer.appendDocToRoot(t),"resize"!==e?this.reasons.push(e):(this.hooks.beforeRender.emit(t),this.docRenderer.render(t),this.hooks.afterRender.emit(t),t.pages.forEach(((t,e)=>{if(t.isVisible&&t.isLoaded){const i=Ff.create(e,t.uid);this.hooks.pageRendered.emit(i);}}))));}internalRender(t){t.isDestroyed||(this.hooks.beforeRender.emit(t),this.docRenderer.render(t),this.hooks.afterRender.emit(t),t.pages.forEach(((t,e)=>{if(t.isVisible&&t.isLoaded){const i=Ff.create(e,t.uid);this.hooks.pageRendered.emit(i);}})));}getCanvasPosition(){const t=this.docRenderer.canvasDom.getBoundingClientRect(),{scrollX:e,scrollY:i}=window;return {x:t.left+e,y:t.top+i}}}function jx(t){const e=t.getPages(),i=e.length;if(!i)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);let{viewportWidth:n,viewportHeight:s}=t;const{rows:o,columns:r,scrollbarWidth:a,tab:l,isVertical:h}=t,c=t.getMargin();r*o<i&&(h?n-=a:s-=a);let d=0,u=0;h?(d=(n-(r+1)*c)/r,u=(s-(o+1)*c)/o):(u=(s-(o+1)*c)/o,d=(n-(r+1)*c)/r);let p=!1;(d<0||u<0)&&(p=!0,d=Math.max(0,d),u=Math.max(0,u));const g=h?Math.max(o,Math.ceil(i/r)):o,f=h?r:Math.max(r,Math.ceil(i/o)),v=d*f+(f+1)*c,m=u*g+(g+1)*c,y=l.pages.map((t=>({uid:t.uid,x:0,y:0,width:d,height:u}))),x=t.getParsedPageStyle(),w=t.getParsedSelectedPageStyle(),b=t.getParsedHoveredPageStyle(),S=t.getParsedPageNumberStyle(d,u),{visibility:C,top:P,bottom:T,onPage:A,height:k}=S;let E=d,D=u;const R=d;let I=u,M=0;const B="visible"===C,U=t.getPageNumberStyle();if(B){const t=""!==U.top?P:T||0;A||(D=u-k-t,I=u-k-t,M=""!==U.top?k+t:0);}D<0&&(p=!0,D=Math.max(0,D)),(E-2*x.borderWidth<0||D-2*x.borderWidth<0)&&(p=!0);const L=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=p?0:v+2*L,t.currentLayoutHeight=p?0:m+2*L,t.currentViewportWidth=p?t.viewportWidth:n,t.currentViewportHeight=p?t.viewportHeight:s,t.isOutOfBounds=p,p||(E=mx(E),D=mx(D),e.forEach(((e,i)=>{let n=x.borderWidth;e.isHovered&&(n=b.borderWidth),e.isSelected&&(n=w.borderWidth),n=fx(n);const s=h?i%r:Math.floor(i/o),a=h?Math.floor(i/r):i%o,l=c+s*(c+d),p=c+a*(c+u);y[i].x=l,y[i].y=p;let g=E-2*n,f=D-2*n;g=Math.max(g,0),f=Math.max(f,0);const v=e.rWidth,m=e.rHeight;let S=v,C=m,P=1;(v>g||m>f)&&(v/m>g/f?(P=g/v,S=g,C=m*P):(P=f/m,C=f,S=v*P)),e.zoom=P;const T=vx(l),A=vx(p+M);let k=n+(g-S)/2,B=n+(f-C)/2;k=vx(k),B=vx(B);const U=mx(v),L=mx(m),O=v*(1-P)/2,W=m*(1-P)/2,N=e.cropWidth,_=e.cropHeight,F=k-O-(N-U)/2,H=B-W-(_-L)/2,V=k-O,z=B-W,$=U,j=L,X=k,G=B,Y=mx(S),q=mx(C);e.setPage(T,A,R,I),e.setBorderBox(0,0,E,D,n),e.setCropBox(F,H,N,_,P,e.rotation),e.setRealTimeBox(V,z,$,j,P);const{width:J,height:Z}=t.viewerContext.getPageRenderSize(e.uid);e.setMediaBox(-e.cropLeft,-e.cropTop,J,Z),e.setImage(0,0,J,Z),e.setCurBox(X,G,Y,q);})),t.placeholderPages=y);}function Xx(t){const{tab:e}=t,i=e.getCurrentPage();if(!i)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);const{viewportWidth:n,viewportHeight:s,scrollbarWidth:o,fitMode:r}=t,a=t.getMargin(),l=t.getParsedPageStyle(),{borderWidth:h=0}=l,c=2*h,d=i.rWidth,u=i.rHeight,p=2*a,g=c+p,f=c+p,v=n-g,m=s-f;let{zoom:y}=t;const x=Yx(r,{zoom:y,validLayoutWidth:d,validLayoutHeight:u,scrollbarWidth:o,fitViewportWidth:v,fitViewportHeight:m,isZoomChanged:t.isZoomChanged},Gx);t.isZoomChanged=!1;const{zoomedLayoutWidth:w,zoomedLayoutHeight:b,zoomedViewportWidth:S,zoomedViewportHeight:C,newFitMode:P}=x;if(y=x.zoom,P&&r!==P){t.fitMode=P,t.viewerContext.viewerConfig.fitMode=P;const e=gf.create(r,P);t.viewerContext.hooks.fitModeChanged.emit(e);}t.setZoom(y);const T=w+g,A=b+f,k=S+g,E=C+f,D=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=T+2*D,t.currentLayoutHeight=A+2*D,t.currentViewportWidth=k,t.currentViewportHeight=E,i.zoom=y,t.tab.setPosition({x:-0,y:-0});const R=e.pages.map((t=>{let{uid:e}=t;return {uid:e,x:a,y:a,width:w+c,height:b+c}}));t.placeholderPages=R;const I=mx(w+c),M=mx(b+c),B=vx(a),U=B,L=fx(h),O=L,W=mx(d),N=mx(u),_=d*(1-y)/2,F=u*(1-y)/2,H=i.cropWidth,V=i.cropHeight,z=L-_-(H-W)/2,$=O-F-(V-N)/2,j=L-_,X=O-F;i.setPage(B,U,I,M),i.setBorderBox(0,0,I,M),i.setCropBox(z,$,H,V,y,i.rotation),i.setRealTimeBox(j,X,d,u,y);const{width:G,height:Y}=t.viewerContext.getPageRenderSize(i.uid);i.setMediaBox(-i.cropLeft,-i.cropTop,G,Y),i.setImage(0,0,G,Y);}function Gx(t,e){let{zoom:i,validLayoutWidth:n,validLayoutHeight:s,scrollbarWidth:o,fitViewportWidth:r,fitViewportHeight:a}=e;return "none"===t||"actualSize"===t?("actualSize"===t&&(i=1),Math.floor(n*i)>r&&(a-=o),Math.floor(s*i)>a&&(r-=o)):"width"===t||"window"===t&&n/r>=s/a?(i=r/n,s*i>a&&(r-=o,i=r/n)):(i=a/s,n*i>r&&(a-=o,i=a/s)),{zoom:i,zoomedLayoutWidth:n*i,zoomedLayoutHeight:s*i,zoomedViewportWidth:r,zoomedViewportHeight:a}}function Yx(t,e,i){const{zoom:n,isZoomChanged:s}=e;let o={};if(s){let s;const r=xm(n);if(1===n)s="actualSize",o=i("actualSize",e);else {o=i("width",e);if(xm(o.zoom)===r)s="width","window"===t&&(s="window");else {o=i("height",e);r===xm(o.zoom)&&(s="height","window"===t&&(s="window"));}}s?o.newFitMode=s:(o=i("none",e),o.newFitMode="none");}else o=i(t,e);return o}function qx(t,e){let{zoom:i,fitWidth:n,fitHeight:s,validLayoutWidth:o,validLayoutHeight:r,scrollbarWidth:a,isVertical:l,fitViewportWidth:h,fitViewportHeight:c}=e;return "none"===t||"actualSize"===t?("actualSize"===t&&(i=1),Math.floor(o*i)>h&&(c-=a),Math.floor(r*i)>c&&(h-=a)):"width"===t||"window"===t&&n/h>=s/c?(i=h/n,l?r*i>c&&(h-=a,i=h/n):(o*i>h&&(c-=a),s*i>c&&(h-=a,i=h/n))):(i=c/s,l?(r*i>c&&(h-=a),n*i>h&&(c-=a,i=c/s)):o*i>h&&(c-=a,i=c/s)),{zoom:i,zoomedLayoutWidth:o*i,zoomedLayoutHeight:r*i,zoomedViewportWidth:h,zoomedViewportHeight:c}}const Jx=t=>{const e=t.getPages();if(!e.length)return;const{tab:i}=t,n=i.current,s=e[n-1],o=e[n+1];s&&Zx(t,s,-1),o&&Zx(t,o,1);};function Zx(t,e,i){const{viewportWidth:n,viewportHeight:s}=t,o=t.getParsedPageStyle(),{borderWidth:r=0}=o,a=t.getMargin(),{rWidth:l,rHeight:h}=e,c=n-2*a-2*r,d=s-2*a-2*r;let u=0,p=0,g=1;l/h>c/d?(u=c,g=c/l,p=h*g):(p=d,g=d/h,u=l*g);let f=(c-u)/2+a,v=(d-p)/2+a;f=Math.max(a,f),v=Math.max(a,v);const{x:m,y:y}=t.tab.getPosition();-1===i?(f=-n+f-m,v-=y):1===i&&(f=n+f-m,v-=y);const x=l*(1-g)/2,w=h*(1-g)/2,b=r,S=r,C=l,P=h,T=e.cropWidth,A=e.cropHeight,k=b-x-(T-C)/2,E=S-w-(A-P)/2,D="visible",R="hidden";e.updateStyle({visibility:D,x:f,y:v,width:u+2*r,height:p+2*r}),e.borderBox.updateStyle({x:0,y:0,width:u+2*r,height:p+2*r,...o,background:"#ffffff00",visibility:D}),e.cropBox.setLocalScale(1),e.cropBox.updateStyle({x:k,y:E,width:T,height:A}),e.cropBox.setLocalScale(g,g),e.cropBox.setLocalAngle(e.rotation);const{width:I,height:M}=t.viewerContext.getPageRenderSize(e.uid);e.mediaBox.updateStyle({x:-e.cropLeft,y:-e.cropTop,width:I,height:M}),e.zoom=g,e.checkbox.updateStyle({visibility:R}),e.pageNumber.updateStyle({visibility:R}),e.setImage(0,0,I,M);}function Qx(t){const{displayMode:e}=t;"single"===e?Xx(t):"continuous"===e?function(t){const e=t.getPages();if(!e.length)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);let{zoom:i}=t;const{viewportWidth:n,viewportHeight:s,tab:o,fitMode:r,scrollbarWidth:a,isVertical:l}=t,h=t.getParsedPageStyle(),{borderWidth:c}=h,d=2*c,u=t.getMargin(),{realRow:p,realColumn:g}=t.getRealRowAndColumnContinuous(),f=new Array(g).fill(0),v=new Array(p).fill(0);let m=0,y=0;e.forEach(((t,e)=>{const i=l?Math.floor(e/g):e%p,n=l?e%g:Math.floor(e/p),s=t.rWidth+d,o=t.rHeight+d;f[n]=Math.max(f[n],s),v[i]=Math.max(v[i],o),m=Math.max(f[n],m),y=Math.max(v[i],y);}));let x=f.reduce(((t,e)=>t+e),0),w=v.reduce(((t,e)=>t+e),0);const b=(g+1)*u,S=(p+1)*u,C=g*d+b,P=p*d+S;x+=b,w+=S;const T=x-C,A=w-P;let k=0,E=0,D=0,R=0;l?(k=n-C,E=s-2*u-d,D=f.reduce(((t,e)=>t+e-d),0),R=y-d):(k=n-2*u-d,E=s-P,D=m-d,R=v.reduce(((t,e)=>t+e-d),0));const I=Yx(r,{zoom:i,fitWidth:D,fitHeight:R,validLayoutWidth:T,validLayoutHeight:A,scrollbarWidth:a,isVertical:l,fitViewportWidth:k,fitViewportHeight:E,isZoomChanged:t.isZoomChanged},qx);t.isZoomChanged=!1;const{zoomedLayoutWidth:M,zoomedLayoutHeight:B,zoomedViewportWidth:U,zoomedViewportHeight:L,newFitMode:O}=I;if(i=I.zoom,O&&r!==O){t.fitMode=O,t.viewerContext.viewerConfig.fitMode=O;const e=gf.create(r,O);t.viewerContext.hooks.fitModeChanged.emit(e);}t.setZoom(i);const W=M+C,N=B+P;let _=0,F=0;l?(_=U+(g+1)*u+g*d,F=L+2*u+d):(_=U+2*u+d,F=L+(p+1)*u+p*d);const H=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=W+2*H,t.currentLayoutHeight=N+2*H,t.currentViewportWidth=_,t.currentViewportHeight=F,t.tab.setPosition({x:-0,y:-0});const V=o.pages.map((t=>({uid:t.uid,x:0,y:0,width:0,height:0,pageX:0,pageY:0})));e.forEach(((e,n)=>{const s=l?Math.floor(n/g):n%p,o=l?n%g:Math.floor(n/p),r=(f[o]-d)*i+d,a=(v[s]-d)*i+d,h=e.rWidth,m=e.rHeight;let y=0,x=0;if(0===o)y=u;else {const t=V[l?n-1:(o-1)*p+s];y=t.x+t.width+u;}if(0===s)x=u;else {const t=V[l?(s-1)*g+o:n-1];x=t.y+t.height+u;}const w=V[n];w.width=r,w.height=a,w.x=y,w.y=x,e.zoom=i;const b=h*i,S=m*i,C=x+(a-S)/2-c,P=vx(y+(r-b)/2-c),T=vx(C);w.pageX=P,w.pageY=T;let A=b+d,k=S+d;A=mx(A),k=mx(k);const E=vx(c),D=E,R=mx(h),I=mx(m),M=h*(1-i)/2,B=m*(1-i)/2,U=E,L=E,O=mx(b),W=mx(S),N=e.cropWidth,_=e.cropHeight,F=E-M-(N-R)/2,H=D-B-(_-I)/2,z=E-M,$=D-B;e.setPage(P,T,A,k),e.setBorderBox(0,0,A,k),e.setCropBox(F,H,N,_,i,e.rotation),e.setRealTimeBox(z,$,h,m,i);const{width:j,height:X}=t.viewerContext.getPageRenderSize(e.uid);e.setMediaBox(-e.cropLeft,-e.cropTop,j,X),e.setImage(e.mediaBoxRect.left,e.mediaBoxRect.top,j,X),e.setCurBox(U,L,O,W);})),t.placeholderPages=V;}(t):"slide"===e&&Jx(t);}class Kx{constructor(t,e){i(this,"context",void 0),i(this,"hooks",void 0),this.context=t,this.hooks=e;}layout(t){if(t.isDestroyed||!t.isActive)return;let e;if(this.context.isDefaultViewer)e=Qx;else if(this.context.isThumbnailViewer)e=jx;else if(this.context.isPerspectiveViewer){const{displayMode:i}=t.context;"single"===i?e=Xx:"slide"===i&&(e=Jx);}e&&(this.hooks.beforeLayout.emit(t),e(t.context),this.hooks.afterLayout.emit(t));}}const tw=["viewerMode","displayMode","toolMode","annotationMode","fitMode","visibility","zoom","zoomOrigin","minZoom","maxZoom","multiselectMode","canvasStyle","pageStyle","selectedPageStyle","hoveredPageStyle","placeholderStyle","pageNumberStyle","checkboxStyle","currentPageStyle","quadSelectionStyle","textSelectionStyle","cursorStyle","rows","columns","maxColumns","maxRows","margin"];class ew extends js{constructor(t){super(),i(this,"context",void 0),i(this,"handlers",{}),this.context=t;}dispose(){this.context=null,this.handlers={},super.dispose();}updateConfig(t){for(const[e,i]of Object.entries(t))tw.includes(e)&&this[e](i);}registerHandler(t,e){return !this[t]&&(this[t]=e,!0)}viewerMode(t){const{context:e}=this;e.viewerConfig.viewerMode=t,dg.CAPTURE;}toolMode(t){const{context:e}=this,i=e.viewerConfig.toolMode;t!==i&&(e.viewerConfig.toolMode=t,e.hooks.toolModeChanged.emit(ff.create(i,t)));}annotationMode(t){const{context:e}=this,i=e.viewerConfig.annotationMode;t!==i&&(e.viewerConfig.annotationMode=t),e.hooks.annotationModeChanged.emit(Af.create(i,t));}fitMode(t){const{context:e}=this,i=e.getActiveTab();if(!i){const i=e.viewerConfig.fitMode;if(i===t)return;return e.viewerConfig.fitMode=t,void e.hooks.fitModeChanged.emit(gf.create(i,t))}const n=i.context.fitMode;n!==t&&(i.context.fitMode=t,"none"!==t&&(e.showTab(i,!0),e.hooks.fitModeChanged.emit(gf.create(n,t))));}displayMode(t){const{context:e}=this,i=e.getActiveTab();let n;if(i){if(n=i.context.displayMode,t===n)return;i.context.displayMode=t,e.showTab(i,!0);}else {if(n=e.viewerConfig.displayMode,t===n)return;e.viewerConfig.displayMode=t;}if("slide"!==n&&"slide"!==t){const i=pf.create(n,t);e.viewer.hooks.displayModeChanged.emit(i);}}margin(t){const{context:e}=this;e.viewerConfig.margin!==t&&(e.viewerConfig.margin=t,e.showCurrentTab(!0));}rows(t){const{context:e}=this,i=e.getActiveTab();i?t!==i.context.rows&&(e.styleService.isCheckboxStyleChanged=!0,e.styleService.isPageNumberStyleChanged=!0,i.context.rows=t,this.context.showTab(i,!0)):e.viewerConfig.rows=t;}columns(t){const{context:e}=this,i=e.getActiveTab();i?t!==i.context.columns&&(e.styleService.isCheckboxStyleChanged=!0,e.styleService.isPageNumberStyleChanged=!0,i.context.columns=t,this.context.showTab(i,!0)):e.viewerConfig.columns=t;}maxColumns(t){t=Math.max(1,t);const{context:e}=this;e.viewerConfig.maxColumns=t;const i=e.getActiveTab();i&&i.context.columns>t&&this.columns(t);}maxRows(t){t=Math.max(1,t);const{context:e}=this;e.viewerConfig.maxRows=t;const i=e.getActiveTab();i&&i.context.rows>t&&this.rows(t);}zoom(t){const{context:e}=this;e.getActiveTab()&&e.zoomTo(t);}visibility(t){const{context:e}=this;if(t===e.viewerConfig.visibility)return;const{rootDom:i,defaultDom:n,thumbnailContainer:s}=e.viewService;if(!i)return;const{ui:o}=e.viewer,r=!s&&o.container.classList.contains("ddv-thumbnail-container"),a=e.viewerConfig.visibility;e.viewerConfig.visibility=t,"visible"===t?(i.style.display="flex",n.style.display="flex",r?(o.container.style.display="flex",e.core.viewerService.onResize.emit()):e.core.viewerService.onResize.emit()):(i.style.display="none",r&&(o.container.style.display="none",e.core.viewerService.onResize.emit()));const l=qg.create(t,a);e.hooks.visibleChanged.emit(l);}zoomOrigin(t){const{context:e}=this;e.viewerConfig.zoomOrigin=t;}minZoom(t){const{context:e}=this;e.viewerConfig.minZoom=t;}maxZoom(t){const{context:e}=this;e.viewerConfig.maxZoom=t;}multiselectMode(t){const{context:e}=this;e.viewerConfig.multiselectMode=t;}canvasStyle(t){const{context:e}=this;if(Wn(t))if(Object.assign(e.viewerConfig.canvasStyle,t),e.isCaptureViewer){var i;const n=null===(i=e.viewer)||void 0===i||null===(i=i.cameraContext)||void 0===i?void 0:i.cameraContainer;n&&Object.assign(n.style,t);}else {const{canvasContainer:i}=e.viewService,n=e.rendererService.getCanvasDom();i&&(Object.assign(i.style,t),t.cursor&&n&&Object.assign(n.style,{cursor:t.cursor}),e.styleService.isCanvasStyleChanged=!0,t.border&&e.resize());}}pageStyle(t){const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.pageStyle,t),e.styleService.isPageStyleChanged=!0,e.showCurrentTab(!0));}selectedPageStyle(t){const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.selectedPageStyle,t),e.styleService.isSelectedPageStyleChanged=!0,e.showCurrentTab(!0));}hoveredPageStyle(t){const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.hoveredPageStyle,t),e.styleService.isHoveredPageStyleChanged=!0,e.showCurrentTab(!0));}placeholderStyle(t){const{context:e}=this;Wn&&(Object.assign(e.viewerConfig.placeholderStyle,t),e.styleService.isPlaceholderStyleChanged=!0,e.showCurrentTab());}currentPageStyle(t){const{context:e}=this;Wn&&(Object.assign(e.viewerConfig.currentPageStyle,t),e.styleService.isCurrentPageStyleChanged=!0,e.showCurrentTab());}pageNumberStyle(t){const{context:e}=this;if(Wn(t)){const{pageNumberStyle:i}=e.viewerConfig;let n=!1;void 0!==t.onPage?(t.onPage!==i.onPage||!1===t.onPage)&&(n=!0):!1===i.onPage&&(n=!0),Object.assign(i,t),e.styleService.isPageNumberStyleChanged=!0,e.showCurrentTab(n);}}checkboxStyle(t){const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.checkboxStyle,t),e.styleService.isCheckboxStyleChanged=!0,e.showCurrentTab());}quadSelectionStyle(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.quadSelectionStyle,t),e.styleService.isQuadSelectionStyleChanged=!0,e.hooks.quadSelectionStyleChanged.emit(),e.showCurrentTab());}textSelectionStyle(t){const{context:e}=this;Wn(t)&&(Object.assign(e.viewerConfig.textSelectionStyle,t),e.tabService.getAllTabs().forEach((e=>{e.pages.forEach((e=>{e.setTextSelectionStyle(t);}));})),e.render("updateTextSelectionStyle"));}cursorStyle(t){const{context:e}=this;Wn(t)&&Object.assign(e.viewerConfig.cursorStyle,t);}scrollDirection(t){const{context:e}=this;e.viewerConfig.scrollDirection=t;const i=e.getActiveTab();i&&(i.context.direction=t,e.resize());}}class iw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"hoveredPageUid",null),this.context=t;}dispose(){super.dispose(),this.context=null;}handleExternalEvents(){const{context:t}=this,{hooks:e}=this.context;this.bindFileDropEvents(),this.bindNativeEvents(),this.convertInternalHooks(),e.currentIndexChanged.on((e=>{t.emit("currentIndexChanged",{oldIndex:e.oldIndex,newIndex:e.newIndex});}),this),e.currentPageChanged.on((()=>{const e=this.context.getActiveTab();if(!e)return;const{currentUid:i,oldCurrentUid:n}=e;t.emit("currentPageChanged",{oldPageUid:n||"",newPageUid:i||""});}),this),e.displayModeChanged.on((e=>{t.emit("displayModeChanged",{oldDisplayMode:e.oldDisplayMode,newDisplayMode:e.newDisplayMode});}),this),e.fitModeChanged.on((e=>{t.emit("fitModeChanged",{oldFitMode:e.oldFitMode,newFitMode:e.newFitMode});}),this),e.toolModeChanged.on((e=>{t.emit("toolModeChanged",{oldToolMode:e.oldToolMode,newToolMode:e.newToolMode});}),this),e.annotationModeChanged.on((e=>{t.emit("annotationModeChanged",{oldAnnotationMode:e.oldAnnotationMode,newAnnotationMode:e.newAnnotationMode});})),e.zoomChanged.on((e=>{e.oldZoomRatio!==e.newZoomRatio&&t.viewer.emit("zoomChanged",{oldZoomRatio:e.oldZoomRatio,newZoomRatio:e.newZoomRatio});}),this),e.textSelected.on((e=>{if(e.detail.length){const t=[],i=ko.displayResolution,n=ko.dataResolution;e.detail.forEach((e=>{const s=[];e.lines.forEach((t=>{s.push({x:Ks(Hs(t.selectedRect.left,i,n),2),y:Ks(Hs(t.selectedRect.top,i,n),2),width:Ks(Hs(t.selectedRect.width,i,n),2),height:Ks(Hs(t.selectedRect.height,i,n),2)});})),t.push({pageUid:e.pageUid,text:e.text,rects:s});})),this.context.viewer.emit("textSelected",t);}else t.viewer.emit("textUnselected",null);}),this),this.context.hooks.searchTextChanged.on((t=>{if(!this.context.hasCallback("textSearchTriggered"))return;if(!t.isLastPage)return;const e=[],{text:i}=t,n=ko.displayResolution,s=ko.dataResolution;t.searchResults.forEach((t=>{const{pageUid:o}=t;t.texts.forEach((t=>{const r=[];t.lines.forEach((t=>{r.push({x:Ks(Hs(t.box.left,n,s),2),y:Ks(Hs(t.box.top,n,s),2),width:Ks(Hs(t.box.width,n,s),2),height:Ks(Hs(t.box.height,n,s),2)});})),e.push({pageUid:o,text:i,rects:r,context:t.context});}));})),this.context.emit("textSearchTriggered",e);}),this),e.selectedPageChanged.on((t=>{this.context.viewer.emit("selectedPagesChanged",{oldIndices:t.oldIndices,newIndices:t.newIndices,oldPageUids:t.oldPageUids,newPageUids:t.newPageUids});}),this),e.annotationDefaultStyleChanged.on((t=>{this.context.viewer.emit("annotationDefaultStyleChanged",t);}),this),e.resize.on((t=>{this.context.viewer.emit("resized",{oldWidth:t.oldWidth,oldHeight:t.oldHeight,newWidth:t.newWidth,newHeight:t.newHeight});}),this),e.pageRendered.on((t=>{this.context.emit("pageRendered",{index:t.index,pageUid:t.pageUid});}),this),e.pagesDragged.on((e=>{t.viewer.emit("pagesDragged",{indices:e.indices,pageUids:e.pageUids});})),e.pagesDropped.on((e=>{t.viewer.emit("pagesDropped",{indicesBefore:e.indicesBefore,indicesAfter:e.indicesAfter,pageUids:e.pageUids});}),this),e.visibleChanged.on((e=>{t.viewer.emit("visibilityChanged",{isVisible:"visible"===e.newVisibility});}),this);}convertInternalHooks(){const{hooks:t}=this.context;t.pageChanged.on((e=>{const i=this.context.getActiveTab();let n;i&&0!==i.total?0===i.oldTotal&&i.total>0&&(n=e.total):n=0,_n(n)||t.pageExistenceChanged.emit(Bf.create(n));}),this),t.pageChangedAfterRender.on((e=>{const i=this.context.getActiveTab();if(!i)return;const{current:n,oldCurrent:s,currentUid:o,oldCurrentUid:r}=i;if(s!==n){const e=uf.create(s,n);t.currentIndexChanged.emit(e);}r!==o&&t.currentPageChanged.emit(e);}),this);}bindNativeEvents(){const{context:t}=this,e=this.context.rendererService.getCanvasDom();this.context.isCaptureViewer||(Ys(e,"click",this).on((e=>{const i=this.formatEvent(e);t.emit("click",i);})),Ys(e,"contextmenu",this).on((e=>{e.preventDefault();const i=this.formatEvent(e);t.emit("rightclick",i);})),Ys(e,"pointerdown",this).on((e=>{const i=this.formatEvent(e);t.emit("pointerdown",i);})),Ys(e,"pointermove",this).on((e=>{const i=this.formatEvent(e),{pageUid:n}=i;let s=-1;this.hoveredPageUid&&(s=this.context.getActiveTab().uidToIndex(this.hoveredPageUid)),n&&this.hoveredPageUid&&n!==this.hoveredPageUid?(t.emit("pageout",{...i,pageUid:this.hoveredPageUid,index:s}),t.emit("pageover",i)):n&&n!==this.hoveredPageUid?t.emit("pageover",i):!n&&this.hoveredPageUid&&t.emit("pageout",{...i,pageUid:this.hoveredPageUid,index:s}),this.hoveredPageUid=n,t.emit("pointermove",i);})),Ys(e,"pointerup",this).on((e=>{const i=this.formatEvent(e);t.emit("pointerup",i);})),Ys(e,"dblclick",this).on((e=>{const i=this.formatEvent(e);t.emit("dblclick",i);})),Ys(document.body,"dblclick",this).on((t=>{})));}bindFileDropEvents(){const{context:t}=this,e=this.context.rendererService.getCanvasDom();t.viewerConfig.enableLoadSourceByDrag&&!this.context.isCaptureViewer&&(Ys(e,"dragenter",this).on((t=>{t.preventDefault();})),Ys(e,"dragleave",this).on((t=>{t.preventDefault();})),Ys(e,"drop",this).on((async t=>{var e,i;t.preventDefault();const n=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;if(!n)return;let{viewer:s}=this.context;"thumbnail"===s.getViewerConfig().viewerMode&&this.context.mainViewerUid&&(s=this.context.core.viewerService.getViewer(this.context.mainViewerUid));const o=!0===(null===(i=s.popupConfig)||void 0===i||null===(i=i.passwordLoaderConfig)||void 0===i?void 0:i.enabled),r=n.length,a={renderAnnotations:Ep.annotationLicenseModuleIsExist()?rc.LOAD_ANNOTATIONS:rc.NO_ANNOTATIONS};if(o)for(let t=0;t<r;t++){const e=new Blob([n[t]],{type:n[t].type});await s.context.core.isPdfEncrypted(e)?await new Promise((i=>{s.emit("ui_showPasswordLoader",{blob:e,fileName:n[t].name,resolve:i});})):s.context.loadSource({fileData:e,convertMode:oc.CM_AUTO,renderOptions:a});}else {const t=[];for(let e=0;e<r;e++){const i=new Blob([n[e]],{type:n[e].type});"application/pdf"===n[e].type?t.push({fileData:i,convertMode:oc.CM_AUTO,renderOptions:a}):t.push({fileData:i});}this.context.loadSource(t);}})),Ys(e,"dragover",this).on((t=>{t.preventDefault();})));}formatEvent(t){var e,i;const[n]=this.context.toCanvas(t),s=this.context.getPointerOverPageInfo(n.pageX,n.pageY),o=ko.displayResolution,r=ko.dataResolution,{pointerX:a,pointerY:l}=s.imageInfo;return {index:s.index,pageUid:null!==(e=null===(i=s.pageInfo.page)||void 0===i?void 0:i.uid)&&void 0!==e?e:"",imageX:a<0?-1:zs(Hs(a,o,r),2),imageY:l<0?-1:zs(Hs(l,o,r),2),canvasX:Math.floor(n.pageX),canvasY:Math.floor(n.pageY),nativeEvent:t}}}class nw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"offsetX",0),i(this,"offsetY",0),i(this,"startX",0),i(this,"startY",0),i(this,"isDragging",!1),i(this,"startPage",void 0),i(this,"newIndexes",void 0),i(this,"cacheChildren",void 0),i(this,"cacheSelectedIndexes",void 0),i(this,"isMousedown",!1),i(this,"starDragIndices",[]),this.context=t;}dispose(){super.dispose(),this.context=null;}startHandler(t){const{context:e}=this,{viewerConfig:i,styleService:n}=e;if("pan"!==i.toolMode)return;const s=e.getActiveTab();if(null==s||!s.total)return;this.isMousedown=!0;const[o]=e.toCanvas(t),{page:r}=e.getPointerOverPageInfo(o.pageX,o.pageY).pageInfo;if(r&&r){this.startX=o.pageX,this.startY=o.pageY;const t=r.getPosition();this.offsetX=o.pageX-t.x,this.offsetY=o.pageY-t.y,this.startPage=r,this.cacheChildren=s.pages.slice();}}moveHandler(t){const{context:e}=this,i=e.getActiveTab();if(!i||!e.isThumbnailViewer)return;const[n]=e.toCanvas(t),s=e.getPointerOverPageInfo(n.pageX,n.pageY),{page:o}=s.pageInfo;if(this.isDragging){var r,a,l;if(o&&!o.isSelected){const t=i.selected.map((t=>i.uidToIndex(t))).sort(((t,e)=>t-e)),n=t[0],s=i.getPageIndex(o),r=i.pages.slice();t.slice().reverse().forEach((t=>{r.splice(t,1);}));let a=r.indexOf(o);s>n&&(a+=1),this.cacheSelectedIndexes.forEach(((t,e)=>{const n=i.getPageByUid(t.uid);r.splice(a+e,0,n);})),this.newIndexes=r.map((t=>i.getPageIndex(t))),i.reorderPages(this.newIndexes,!1),e.layoutService.layout(i),e.visibilityService.handleVisibility(i);}const t=e.styleService.getParsedPlaceholderStyle(),s=devicePixelRatio;let h=n.pageX-this.offsetX,c=n.pageY-this.offsetY;h=Math.round(h*s)/s,c=Math.round(c*s)/s,i.selected.forEach((e=>{const n=i.getPageByUid(e);n.isDragging=!0,n.updateStyle({...t}),n.borderBox.updateStyle({visibility:"hidden"});})),null===(r=this.startPage)||void 0===r||r.updateStyle({zIndex:1}),null===(a=this.startPage)||void 0===a||a.borderBox.updateStyle({visibility:"visible"}),null===(l=this.startPage)||void 0===l||l.borderBox.setPosition({x:h,y:c}),e.loadVisiblePages(i),e.rendererService.render(i,"dragPageMove");}else if(o&&o===this.startPage&&o.isSelected){if(((n.pageX-this.startX)**2+(n.pageY-this.startY)**2)**.5>=e.viewerConfig.dragThreshold&&this.startPage&&e.viewerConfig.enableDragPage){this.isDragging=!0,this.cacheSelectedIndexes=i.selected.map((t=>({uid:t,index:i.uidToIndex(t)}))).sort(((t,e)=>t.index-e.index));const t=i.uidsToIndices(i.selected);this.starDragIndices=[...t],e.viewer.hooks.pagesDragged.emit(Hf.create(t,[...i.selected]));}}}endHandler(t){var e;if(!this.isMousedown)return;const{context:i}=this,n=i.getActiveTab();if(n){if(this.isDragging){if(this.newIndexes){const t=n.pages.map((t=>this.cacheChildren.indexOf(t)));n.childNodes=this.cacheChildren,i.viewer.reorderPages(t),this.newIndexes=null;}n.selected.forEach((t=>{const e=n.getPageByUid(t);e.borderBox.setLocalPosition({x:0,y:0}),e.isDragging=!1,e.borderBox.updateStyle({visibility:"visible"});}));const t=n.uidsToIndices(n.selected);i.viewer.hooks.pagesDropped.emit(Vf.create(this.starDragIndices,t,[...n.selected]));}null===(e=this.startPage)||void 0===e||e.updateStyle({zIndex:0}),this.isDragging&&(i.scrollByCurrentChanged=!0,i.layoutService.layout(n),i.visibilityService.handleVisibility(n),i.rendererService.render(n,"dragPageEnd")),this.isMousedown=!1,this.startPage=null,this.isDragging=!1;}}}class sw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"lastX",void 0),i(this,"lastY",void 0),i(this,"startTime",void 0),i(this,"startScrollLeft",void 0),i(this,"startScrollTop",void 0),i(this,"isScrolling",void 0),i(this,"scrollTimer",void 0),i(this,"scrollDirectionX","left"),i(this,"scrollDirectionY","top"),i(this,"canvasElX",void 0),i(this,"canvasElY",void 0),this.context=t,this.isScrolling=!1;}startHandler(t){const{context:e}=this;if(e.isPanning||e.isZooming)return;const i=e.getActiveTab();if(null==i||!i.total)return;const n=e.toCanvas(t);if(n.length>1)return;this.canvasElX=t.screenX,this.canvasElY=t.screenY;const{pageX:s,pageY:o}=n[0];this.isStart=!0,this.startX=s,this.startY=o,this.lastX=s,this.lastY=o,this.startTime=(new Date).getTime();const{scrollLeft:r,scrollTop:a}=i.context;this.startScrollLeft=r,this.startScrollTop=a,this.isScrolling=!1,this.scrollTimer&&(hs.clearTimer(this.scrollTimer),this.scrollTimer=null);}moveHandler(t){if(!this.isStart)return;t instanceof PointerEvent&&t.cancelable&&t.preventDefault();const{context:e}=this;if(e.isZooming)return;const i=e.toCanvas(t);if(i.length>1)return;const n=e.getActiveTab(),{maxScrollLeft:s,maxScrollTop:o}=n.context;let{scrollLeft:r,scrollTop:a}=n.context;if(!s&&!o)return;const{viewerConfig:l}=e,{panThreshold:h,enablePanX:c,enablePanY:d}=l,{pageX:u,pageY:p}=i[0],g=u-this.startX,f=p-this.startY,v=u-this.lastX,m=p-this.lastY;if(e.isPanning){if(!r&&!a&&v>=0&&m>=0)return;if(r===s&&a===o&&v<=0&&m<=0)return;c&&(r=this.startScrollLeft-g),d&&(a=this.startScrollTop-f),r=Yn(r,0,s),a=Yn(a,0,o),e.viewService.scrollTo(r,a);}else e.isPanning=c&&Math.abs(g)>=h||d&&Math.abs(f)>=h;this.lastX=u,this.lastY=p;}endHandler(t){if(!this.isStart)return;this.isStart=!1,this.context.isPanning=!1;const{context:e}=this,i=e.toCanvas(t,!0);if(i.length>1)return;if(e.isZooming)return;if(bm(t))return;if(this.canvasElX===t.screenX&&this.canvasElY===t.screenY)return;const{scrollLeft:n,scrollTop:s}=this.context.viewService.getMaxScrollValue(),{scrollLeft:o,scrollTop:r}=this.context.viewService.scrollContainer;if(!this.isScrolling&&(n>0||s>0)){const t=(new Date).getTime(),e=i[0].pageX,a=i[0].pageY,l=e-this.startX,h=a-this.startY;let c=!1,d=!1;l>0?(c=0!==o,this.scrollDirectionX="right"):(c=o!==n,this.scrollDirectionX="left"),h>0?(d=0!==r,this.scrollDirectionY="bottom"):(d=r!==s,this.scrollDirectionY="top");const u=t-this.startTime;if((Math.abs(l)>10||Math.abs(h)>10)&&u>0&&u<300&&(c||d)){let t=Math.abs(l)/u,e=Math.abs(h)/u;(t>.4||e>.4)&&(t=Math.min(t,2.8),e=Math.min(e,2.8),this.scroll(t,e,-.05));}}}scroll(t,e,i){this.isScrolling=!0;const{scrollLeft:n,scrollTop:s}=this.context.viewService.scrollContainer;let o=0,r=0;this.scrollTimer=hs.createTimer((()=>{const{scrollLeft:a,scrollTop:l}=this.context.viewService.getMaxScrollValue();if(t<=0&&e<=0||!1===this.isScrolling)return hs.clearTimer(this.scrollTimer),this.scrollTimer=null,void(this.isScrolling=!1);t>=0&&("right"===this.scrollDirectionX?o-=40*t:o+=40*t,t+=i),e>=0&&("bottom"===this.scrollDirectionY?r-=40*e:r+=40*e,e+=i);const h=Yn(n+o,0,a),c=Yn(s+r,0,l);this.context.viewService.scrollTo(h,c);}),25);}}class ow extends js{constructor(t){super(),i(this,"context",void 0),i(this,"scrollTimer",void 0),this.context=t;}scrollHandler(t){const{context:e}=this;if(e.scrollByCurrentChanged)return void(e.scrollByCurrentChanged=!1);const i=e.getActiveTab();if(null==i||!i.total)return;const{scrollLeft:n,scrollTop:s}=t.target;i.context.setTabScrollValue(n,s),e.visibilityService.handleVisibility(i),this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout((()=>{if(!e.isDestroyed&&i.isActive){if(e.isDefaultViewer){if(i.context.updateReference(),i.context.isContinuousDisplay&&e.viewerConfig.autoChangeIndex){const t=i.context.getCurrentByScroll();null!==t&&(i.gotoPage(t),e.visibilityService.handleVisibility(i),e.emitPageChangedEvent(i),e.emitPageChangedAfterRenderEvent(i),e.core.viewerService.onCurrentChangedByScroll.emit(tf.create(i.uid,e.groupUid,e.uid,t)));}e.loadVisiblePages(i);}else e.isThumbnailViewer&&e.loadVisiblePages(i);this.scrollTimer=null;}}),42),e.rendererService.render(i,"scrollHandler"),e.hooks.scroll.emit();}wheelHandler(t){if(!As(t)&&!ks(t))return;const{context:e}=this,i=e.getActiveTab(),{maxScrollLeft:n,maxScrollTop:s,scrollLeft:o,scrollTop:r}=i.context;let{wheelDelta:a}=t;t.deltaY&&(a=-t.deltaY),1===t.deltaMode?a*=16:2===t.deltaMode&&(a=a<0?-100:100),t.shiftKey&&n?(a>0&&0!==o||a<0&&o!==n)&&(t.cancelable&&t.preventDefault(),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(-a,0)):s&&(a<0&&r!==s||a>0&&0!==r)&&(t.cancelable&&t.preventDefault(),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-a));}}class rw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"wheelTimer",void 0),i(this,"isStart",void 0),i(this,"isZooming",void 0),i(this,"startDistance",void 0),i(this,"touchZoomTimer",void 0),i(this,"startZoom",void 0),this.context=t,this.isZooming=!1,this.isStart=!1,this.startZoom=1;}zoomTo(t,e,i){var n;t=xm(t);const{context:s}=this;if(!s.isDefaultViewer)return;const o=s.getActiveTab();if(null==o||!o.total)return;const{viewerConfig:r}=s;t=Yn(t,r.minZoom,r.maxZoom),Xn(e)&&Xn(i)||({originX:e,originY:i}=o.context.getZoomOriginCord());const a=null===(n=o.context.placeholderPages)||void 0===n?void 0:n.length;let l;a&&(l=o.context.generateReference(e,i));const h=o.context.zoom;if(o.context.setZoom(t),r.zoom=t,o.context.isZoomChanged=!0,a){s.layoutService.layout(o),s.viewService.updateScrollerContentSize(o),s.rendererService.updateCanvasSize();const{scrollLeft:t,scrollTop:n}=o.context.parseReferenceZoom(l,e,i);o.context.setTabScrollValue(t,n),s.viewService.scrollTo(t,n),s.visibilityService.handleVisibility(o),s.loadVisiblePages(o),s.clearCurrentTabOptimization(),s.rendererService.render(o,"zoom");}o.context.oldZoom=h,s.emitZoomChangedEvent(o);}wheelHandler(t){const{viewerConfig:e}=this.context;if(e.enableZoom&&e.enableZoomWithCtrl&&Ts(t)){let{wheelDelta:i}=t;t.deltaY&&(i=-t.deltaY),t.cancelable&&t.preventDefault(),this.wheelTimer||(this.wheelTimer=setTimeout((()=>{clearTimeout(this.wheelTimer),this.wheelTimer=null;const n=e.wheelZoomFactor||1,s=i>0?n:1/n,{x:o,y:r}=this.context.rendererService.getCanvasPosition();this.zoomTo(e.zoom*s,t.pageX-o,t.pageY-r);}),40));}}touchstartHandler(t){const{context:e}=this,i=e.getActiveTab(),{displayMode:n}=i.context,s="continuous"===n||"single"===n;if(!e.viewerConfig.enableZoom||!s)return;const o=e.toCanvas(t);o.length<2||(e.isZooming=!0,this.startZoom=i.context.zoom,this.startDistance=aw(o),this.isStart=!0);}touchmoveHandler(t){if(!this.isStart)return;t.cancelable&&t.preventDefault();const{context:e}=this,i=e.toCanvas(t);if(i.length<2)return;const n=(i[0].pageX+i[1].pageX)/2,s=(i[0].pageY+i[1].pageY)/2;let o=aw(i)/this.startDistance;t.scale&&(o=t.scale);const r=e.getActiveTab();let{zoom:a}=r.context;const l=a;a=this.startZoom*o,a!==l&&(this.touchZoomTimer||(this.touchZoomTimer=setTimeout((()=>{this.zoomTo(a,n,s),clearTimeout(this.touchZoomTimer),this.touchZoomTimer=null;}),25))),e.isZooming=!0;}touchendHandler(t){this.isStart&&(this.isStart=!1,this.startZoom=1,this.context.isZooming=!1);}tapZoomHandler(t){const{toolMode:e,enableZoom:i,tapZoomFactor:n}=this.context.viewerConfig;if(!i)return;const s="zoomIn"===e,o="zoomOut"===e;if(!s&&!o)return;const r=this.context.toCanvas(t);if(r.length>1)return;const a=this.context.getActiveTab();let{zoom:l}=a.context;s?l*=n||1:o&&(l/=n||1),this.zoomTo(l,r[0].pageX,r[0].pageY);}}function aw(t){return ((t[0].pageX-t[1].pageX)**2+(t[0].pageY-t[1].pageY)**2)**.5}class lw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"isSliding",void 0),i(this,"slideDistance",void 0),i(this,"slideDirection",void 0),i(this,"slideRAF",void 0),i(this,"tabX",void 0),i(this,"tabY",void 0),this.context=t,this.isSliding=!1;}startHandler(t){if(!this.context.viewerConfig.enableSlide)return;if(this.isSliding)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;const{scrollLeft:i,scrollTop:n}=this.context.viewService.getMaxScrollValue();if(i||n)return;const s=this.context.toCanvas(t);if(s.length>1)return;const o=e.getPosition();this.tabX=o.x,this.tabY=o.y,this.startX=s[0].pageX,this.isStart=!0;}moveHandler(t){if(!this.isStart)return;const{context:e}=this,i=e.getActiveTab(),n=e.toCanvas(t)[0].pageX-this.startX;if(n>0?this.slideDirection="right":n<0&&(this.slideDirection="left"),this.slideDistance=Math.min(i.context.viewportWidth,Math.abs(n)),this.isSliding)"right"===this.slideDirection?i.setPosition({x:this.slideDistance+this.tabX,y:this.tabY,z:0}):"left"===this.slideDirection&&i.setPosition({x:-this.slideDistance+this.tabX,y:this.tabY,z:0}),e.render("SlideMove");else if("single"===i.context.displayMode&&"pan"===e.viewerConfig.toolMode&&e.viewerConfig.enableSlide){const{scrollLeft:t,scrollTop:i}=this.context.viewService.getMaxScrollValue();Math.abs(n)>e.viewerConfig.startSlideThreshold&&!t&&!i&&(this.isSliding=!0,this.context.isSliding=!0,e.configService.updateConfig({displayMode:"slide"}));}}endHandler(t){if(!this.isStart)return;const{context:e}=this;this.context.toCanvas(t,!0);const i=e.getActiveTab(),{displayMode:n}=i.context;"slide"===n&&this.slide(i),this.isStart=!1;}slide(t){let e,i=0,n=0,s=0,o=!1;const{viewerConfig:r}=this.context,a=t.context.viewportWidth*r.slideThresholdForPerspective;this.slideDistance>=Math.max(a,r.startSlideThreshold)?(n=t.context.viewportWidth,e=n-this.slideDistance,"left"===this.slideDirection?t.current!==t.total-1?(s=-this.slideDistance,i=-e/6):(n=0,e=this.slideDistance,o=!0,s=-this.slideDistance,i=e/6):0!==t.current?(s=this.slideDistance,i=e/6):(n=0,e=this.slideDistance,o=!0,s=this.slideDistance,i=-e/6)):(o=!0,n=0,e=this.slideDistance,"left"===this.slideDirection?(s=-this.slideDistance,i=e/6):(s=this.slideDistance,i=-e/6));const l=()=>{s+=i;const e=s>=0;if(Math.abs(s)>=n&&(s=n,e||(s*=-1)),t.setPosition({x:s+this.tabX,y:this.tabY,z:0}),Math.abs(s)===n)return o||("right"===this.slideDirection?this.context.viewer.gotoPage(t.current-1):this.context.viewer.gotoPage(t.current+1),this.context.configService.updateConfig({fitMode:"window"})),this.isSliding=!1,this.context.isSliding=!1,this.context.configService.updateConfig({displayMode:"single"}),void cancelAnimationFrame(this.slideRAF);this.slideRAF=requestAnimationFrame(l),this.context.render("slide");};this.slideRAF=requestAnimationFrame(l);}}class hw extends js{constructor(t){super(),i(this,"context",void 0),this.context=t;}handleOptimizationEvents(){this.context.hooks.afterRender.on((t=>{this.optimizeTab(t);}));}dispose(){super.dispose(),this.context=null;}optimizeTab(t){this.context.viewerConfig.enableOptimizePage&&(jn()||t.visibleChildren.forEach((t=>{!t.isOptimized&&t.isVisible&&t.isLoaded&&setTimeout((()=>{!t.isOptimized&&t.isVisible&&t.isLoaded&&this.optimizePage(t.uid);}),500);})));}cancelOptimization(t){this.context.core.optimizationService.cancel(t);}optimizePage(t){if(!this.context)return;const{context:e}=this,{viewerConfig:i}=e;if(!i.enableOptimizePage)return;const n=e.getActiveTab();if(null==n||!n.total)return;const s=n.getPageByUid(t);if(!s)return;if(s.isOptimized||!s.isVisible||!s.isLoaded||s.optimizationUid===s.optimizedUid||e.isSliding||e.isDestroyed)return;const o=e.core.pageService.getPage(t);if(null==o||!o.display.img)return;const{img:r}=s.image.style;if(!r)return;const{naturalWidth:a,naturalHeight:l}=r;let h=a,c=l;const{maxOptimizationSize:d}=i;if(h>d||c>d||s.rWidth>d||s.rHeight>d)return;let u=0,p=0,g=0,f=0,v=0;({rWidth:h,rHeight:c,cropLeft:u,cropTop:p,cropWidth:g,cropHeight:f,rotation:v}=o.getEditResultForPixel());const m=devicePixelRatio,y=Math.floor(s.realTimeBox.width*m+.5)||1,x=Math.floor(s.realTimeBox.height*m+.5)||1;if(y>h||x>c)return;const w=Hs(o.mediaBox.left,ko.displayResolution,o.resource.resolutionX),b=Hs(o.mediaBox.top,ko.displayResolution,o.resource.resolutionX),S=new Ma({style:{x:-u+w,y:-p+b,img:r,width:a,height:l}});let C="rgba(0,0,0,0)";if(i.enableFillColor)C=i.blankFillColor;else if(i.viewerMode===dg.THUMBNAIL){let t=i.pageStyle;s.isSelected?t=i.selectedPageStyle:s.isHovered&&(t=i.hoveredPageStyle),C=t.background;}const P=new Fa({style:{x:-(g-h)/2,y:-(f-c)/2,width:g,height:f,background:C}});P.appendChild(S),P.setLocalAngle(v);const{commonCanvas:T}=e.core;T.render(P,h,c),T.reset();const A=T.getCanvas();s.isOptimized=!0,e.core.optimizationService.optimize(A,h,c,y,x,s.optimizationUid).then((t=>{if(!e.isDestroyed&&t.taskUid===s.optimizationUid){s.isOptimized=!0,s.optimizedUid=s.optimizationUid;const i=A.getContext("2d",{willReadFrequently:!0}).createImageData(y,x);i.data.set(t.target),s.realTimeBox.imageData=i,s.image.updateStyle({visibility:"hidden"}),s.isVisible&&e.render("OptimizePage");}})).catch((t=>{s.isOptimized=!1;}));}}class cw extends js{constructor(t,e,n,s,o,r,a){super(),i(this,"context",void 0),i(this,"panModeInteraction",void 0),i(this,"cropModeInteraction",void 0),i(this,"annotationModeInteraction",void 0),i(this,"zoomInModeInteraction",void 0),i(this,"zoomOutModeInteraction",void 0),i(this,"textSelectionModeInteraction",void 0),this.context=t,this.panModeInteraction=e,this.cropModeInteraction=n,this.annotationModeInteraction=s,this.zoomInModeInteraction=o,this.zoomOutModeInteraction=r,this.textSelectionModeInteraction=a;}handleEvents(){if(this.context.isCaptureViewer)return;const t=this.context.rendererService.getCanvasDom();Ys(t,"pointerdown",this).on((t=>{if(this.context.isPointerWorking=!0,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointerdownHandler(t),this.cropModeInteraction.pointerdownHandler(t),this.annotationModeInteraction.pointerdownHandler(t),this.zoomInModeInteraction.startHandler(t),this.zoomOutModeInteraction.startHandler(t),this.textSelectionModeInteraction.startHandler(t));})),Ys(t,"pointermove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointermoveHandler(t,!1),this.cropModeInteraction.pointermoveHandler(t),this.panModeInteraction.cursorHandler(t),this.zoomInModeInteraction.moveHandler(t),this.zoomOutModeInteraction.moveHandler(t),this.textSelectionModeInteraction.moveHandler(t));}),{passive:!1}),Ys(t,"pointerup",this).on((t=>{if(this.context.isPointerWorking=!1,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&this.panModeInteraction.pointerupHandler(t);})),Ys(document,"pointerdown",this).on((t=>{this.context.isPointerWorking=!0;})),Ys(document,"pointermove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointermoveHandler(t,!0),this.annotationModeInteraction.pointermoveHandler(t),this.annotationModeInteraction.cursorHandler(t));}),{passive:!1}),Ys(document,"pointerup",this).on((t=>{if(this.context.isPointerWorking=!1,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointerupHandler(t),this.cropModeInteraction.pointerupHandler(t),this.annotationModeInteraction.pointerupHandler(t),this.zoomInModeInteraction.endHandler(t),this.zoomOutModeInteraction.endHandler(t),this.textSelectionModeInteraction.endHandler(t));})),Ys(t,"touchstart",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.touchstartHandler(t),this.cropModeInteraction.touchstartHandler(t));}),{passive:!1}),Ys(t,"touchmove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(t.cancelable&&t.preventDefault(),this.panModeInteraction.touchmoveHandler(t),this.cropModeInteraction.touchmoveHandler(t));}),{passive:!1}),Ys(t,"touchend",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.touchendHandler(t),this.cropModeInteraction.touchendHandler(t));})),Ys(t,"wheel",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.wheelHandler(t),this.cropModeInteraction.wheelHandler(t),this.annotationModeInteraction.wheelHandler(t),this.textSelectionModeInteraction.wheelHandler(t));}),{passive:!1}),Ys(this.context.viewService.scrollContainer,"scroll",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.scrollHandler(t),this.cropModeInteraction.scrollHandler(t),this.annotationModeInteraction.scrollHandler(t),this.textSelectionModeInteraction.scrollHandler(t));})),Ys(document,"keydown",this).on((t=>{if(!this.context.isFocusCanvas||!this.context.viewerConfig.enableKeyboardInteraction)return;const e=this.context.getActiveTab();null!=e&&e.total&&((t.ctrlKey||t.metaKey)&&"a"===t.key.toLowerCase()&&t.preventDefault(),this.panModeInteraction.keydownHandler(t),this.cropModeInteraction.keydownHandler(t),this.annotationModeInteraction.keydownHandler(t),this.zoomInModeInteraction.keydownHandler(t),this.zoomOutModeInteraction.keydownHandler(t),this.textSelectionModeInteraction.keydownHandler(t));})),Ys(document,"keyup",this).on((t=>{if(!this.context.isFocusCanvas||!this.context.viewerConfig.enableKeyboardInteraction)return;this.context.getActiveTab()&&(this.panModeInteraction.keyupHandler(t),this.annotationModeInteraction.keyupHandler(t));})),Ys(document,"pointerdown",this).on((t=>{var e;if(this.context.isDestroyed)return;if("hidden"===this.context.viewerConfig.visibility)return;if(t.target instanceof HTMLInputElement)return void(this.context.isFocusCanvas=!1);if(this.context.viewerConfig.hasThb&&this.context.viewService.thumbnailContainer.contains(t.target))return void(this.context.isFocusCanvas=!1);let i=!(null===(e=this.context.viewService.rootDom)||void 0===e||!e.contains(t.target));i||document.body.contains(t.target)||!this.context.isDefaultViewer||(i=!0),this.context.isFocusCanvas=i;}));}}class dw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"startPage",void 0),i(this,"mouseOverPage",void 0),this.context=t;}startHandler(t){const{context:e}=this,{viewerConfig:i,styleService:n}=e,s=this.context.getActiveTab();if(null==s||!s.total)return;this.isPointerdown=!0;const[o]=e.toCanvas(t),{page:r}=e.getPointerOverPageInfo(o.pageX,o.pageY).pageInfo;if(!r)return;if(this.startPage=r,!ks(t)&&!As(t))return;const a=s.getPageIndex(r),l=s.getCurrentPage(),h=t.shiftKey&&i.enableSelectWithShift;if(h&&s.selected.length){if(h&&l!==r&&s.shiftReference){const t=s.uidToIndex(s.shiftReference),i=Math.min(a,t),o=Math.max(a,t),l=[];for(let t=i;t<=o;t++)l.push(t);if(e.viewerConfig.enableOptimizePage){n.isSelectedBorderWidthEqualHovered()||e.clearOptimization([r.uid]),n.isSelectedBorderWidthEqualNormal()||l.forEach((t=>{const o=s.getPageByIndex(i+t);!o||s.selected.includes(o.uid)||o.uid===r.uid||n.isSelectedBorderWidthEqualNormal()||e.clearOptimization([o.uid]);}));const t=s.indicesToUids(l);n.isSelectedBorderWidthEqualNormal()||s.selected.forEach((i=>{if(!t.includes(i)){const t=s.getPageByUid(i);t&&e.clearOptimization([t.uid]);}}));}a<t&&l.reverse();const{shiftReference:h}=s;e.viewer.gotoPage(a),s.shiftReference=h,e.viewer.selectPagesByIndices(l);}}else i.multiselectMode||(r.uid!==s.currentUid?e.viewer.gotoPage(a):s.shiftReference=r.uid,r.isSelected||(e.viewerConfig.enableOptimizePage&&(n.isSelectedBorderWidthEqualNormal()||s.selected.forEach((t=>{const i=s.getPageByUid(t);i&&e.clearOptimization([i.uid]);})),n.isSelectedBorderWidthEqualHovered()||e.clearOptimization([r.uid])),e.viewer.selectPagesByIndices([a])));}moveHandler(t){const{context:e}=this,{styleService:i}=e,n=e.getActiveTab();if(null==n||!n.total)return;const[s]=e.toCanvas(t),o=e.getPointerOverPageInfo(s.pageX,s.pageY),{page:r}=o.pageInfo,{mouseOverPage:a}=this;e.viewerConfig.enableOptimizePage&&!i.isBorderWidthEqualHovered()&&(a&&!a.isSelected&&(r&&a===r||e.clearOptimization([a.uid])),r&&!r.isSelected&&(a&&a===r||e.clearOptimization([r.uid]))),this.mouseOverPage=r;let l=!1;if(bm(t)){const i=t.target===e.rendererService.getCanvasDom();n.pages.forEach((t=>{r&&r.uid===t.uid?(t.isHovered||(l=!0),t.isHovered=!!i):(t.isHovered&&(l=!0),t.isHovered=!1);}));}else n.pages.forEach((t=>{t.isHovered=!1;}));l&&(e.layoutService.layout(n),e.visibilityService.handleVisibility(n),e.rendererService.render(n,"selectPageMove"));}endHandler(t){if(!this.isPointerdown)return;const{context:e}=this,{styleService:i}=e,[n]=e.toCanvas(t,!0),s=e.getActiveTab();if(null==s||!s.total)return;const o=e.getPointerOverPageInfo(n.pageX,n.pageY).pageInfo.page;if(o&&o===this.startPage)if(Ps(t)&&e.viewerConfig.enableSelectWithCtrl||e.viewerConfig.multiselectMode){const t=s.selected.slice(),n=t.indexOf(o.uid);o.isSelected?t.splice(n,1):t.push(o.uid);const r=s.uidsToIndices(t);if(o.uid!==s.currentUid){const t=s.uidToIndex(o.uid);e.viewer.gotoPage(t);}!i.isSelectedBorderWidthEqualHovered()&&e.viewerConfig.enableOptimizePage&&e.clearOptimization([o.uid]),e.viewer.selectPagesByIndices(r);}else if(!Es(t)){const t=s.getPageIndex(o);o.uid!==s.currentUid&&e.viewer.gotoPage(t),e.viewerConfig.enableOptimizePage&&(i.isSelectedBorderWidthEqualNormal()||s.selected.forEach((t=>{const i=s.getPageByUid(t);i&&e.clearOptimization([i.uid]);})),i.isSelectedBorderWidthEqualHovered()||e.clearOptimization([o.uid])),e.viewer.selectPagesByIndices([t]);}this.isPointerdown=!1,this.startPage=null;}keydownHandler(t){}}class uw extends js{constructor(t){super(),i(this,"context",void 0),this.context=t;}selectAllHandler(t){this.context.viewerConfig.enableSelectAllWithKeyboard&&Ps(t)&&this.context.isThumbnailViewer&&(t.preventDefault(),this.context.viewer.selectAllPages());}undoHandler(t){this.context.viewerConfig.enableUndoWithKeyboard&&Ps(t)&&(t.preventDefault(),this.context.viewer.undo());}redoHandler(t){this.context.viewerConfig.enableRedoWithKeyboard&&Ps(t)&&(t.preventDefault(),this.context.viewer.redo());}zoomInHandler(t){this.context.viewerConfig.enableZoomInWithKeyboard&&Ps(t)&&(t.preventDefault(),this.context.viewer.zoomIn());}zoomOutHandler(t){this.context.viewerConfig.enableZoomOutWithKeyboard&&Ps(t)&&(t.preventDefault(),this.context.viewer.zoomOut());}arrowLeftHandler(t){const{context:e}=this;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollLeft:n,currentViewportWidth:s,scrollLeft:o}=i.context;t.preventDefault();const r=s/30;if(e.isDefaultViewer)ks(t)?0!==i.current&&e.viewer.gotoPage(i.current-1):As(t)&&(n?0===o?0!==i.current&&e.viewer.gotoPage(i.current-1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(-r,0)):0!==i.current&&e.viewer.gotoPage(i.current-1));else if(e.isThumbnailViewer){if(Es(t))return;0!==i.current&&e.viewer.gotoPage(i.current-1);}}arrowRightHandler(t){const{context:e}=this;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollLeft:n,currentViewportWidth:s,scrollLeft:o}=i.context;t.preventDefault();const r=s/30;if(e.isDefaultViewer)ks(t)?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):As(t)&&(n?o===n?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r,0)):i.current!==i.total-1&&e.viewer.gotoPage(i.current+1));else if(e.isThumbnailViewer){if(Es(t))return;i.current!==i.total-1&&e.viewer.gotoPage(i.current+1);}}arrowUpHandler(t){const{context:e}=this;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollTop:n,currentViewportHeight:s,scrollTop:o}=i.context;t.preventDefault();const r=s/30;if(e.isDefaultViewer)ks(t)&&(n?0===o?0!==i.current&&e.viewer.gotoPage(i.current-1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-r)):0!==i.current&&e.viewer.gotoPage(i.current-1));else if(e.isThumbnailViewer){if(Es(t))return;const{rows:n,columns:s}=i.context,{current:o}=i,r=Math.floor(o/s),a=o%s;0===r?0!==i.current&&e.viewer.gotoPage(i.current-1):e.viewer.gotoPage(s*(r-1)+a);}}arrowDownHandler(t){const{context:e}=this;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollTop:n,currentViewportHeight:s,scrollTop:o}=i.context;t.preventDefault();const r=s/30;if(e.isDefaultViewer)ks(t)&&(n?o===n?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,r)):i.current!==i.total-1&&e.viewer.gotoPage(i.current+1));else if(e.isThumbnailViewer){if(Es(t))return;const{rows:n,columns:s}=i.context,{current:o}=i,r=Math.floor(o/s),a=o%s;if(r===Math.floor((i.total-1)/s))0!==i.current&&e.viewer.gotoPage(i.current+1);else {const t=Math.min(i.total-1,s*(r+1)+a);e.viewer.gotoPage(t);}}}escapeHandler(t){Es(t)||t.preventDefault();}enterHandler(t){Es(t)||t.preventDefault();}pageUpHandler(t){if(Es(t))return;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:n,currentViewportHeight:s,scrollTop:o,scrollLeft:r}=i.context;t.preventDefault(),e.isDefaultViewer&&(n&&0!==o&&(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-s)),"single"===i.context.displayMode?n&&0!==o?(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-s)):0!==i.current&&(e.viewer.gotoPage(i.current-1),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r-i.context.scrollLeft,n)):"continuous"===i.context.displayMode&&n&&0!==o&&(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-s)));}pageDownHandler(t){if(Es(t))return;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:n,currentViewportHeight:s,scrollTop:o,scrollLeft:r}=i.context;t.preventDefault(),e.isDefaultViewer&&("single"===i.context.displayMode?n&&o!==n?(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,s)):i.current!==i.total-1&&(e.viewer.gotoPage(i.current+1),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r-i.context.scrollLeft,0)):"continuous"===i.context.displayMode&&n&&o!==n&&(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,s)));}homeHandler(t){if(Es(t))return;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:n,scrollTop:s}=i.context;t.preventDefault(),e.isDefaultViewer?n&&0!==s&&(e.scrollByCurrentChanged=!1,e.viewService.scrollTo(0,0)):e.isThumbnailViewer&&0!==i.current&&e.viewer.gotoPage(0);}endHandler(t){if(Es(t))return;if(!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:n,scrollTop:s}=i.context;t.preventDefault(),e.isDefaultViewer?n&&s!==n&&(e.scrollByCurrentChanged=!1,e.viewService.scrollTo(0,n)):e.isThumbnailViewer&&i.current!==i.total-1&&e.viewer.gotoPage(i.total-1);}}class pw{constructor(t){i(this,"context",void 0),i(this,"isEditAnnotation",!1),i(this,"isMove",!1),i(this,"isSlide",!1),i(this,"isActivateAnnotation",!1),i(this,"isTouchstart",!1),i(this,"isPointerdown",!1),i(this,"isFirstMove",!0),i(this,"isPointerOnAnnotation",!1),i(this,"isAnnotationActive",!1),i(this,"activeShape",void 0),i(this,"pointerNum",0),i(this,"startPoint",void 0),i(this,"dragTimer",void 0),i(this,"isDragPages",!1),i(this,"isMoveForThumbnail",!1),i(this,"isMoved",!1),i(this,"canScroll",!0),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"isTextSelectionMode",!1),i(this,"isStartTextSelection",!1),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionTimer",void 0),i(this,"textSelectionTimerMobile",void 0),i(this,"isEditTextStart",!1),i(this,"isEditTextEnd",!1),i(this,"isMovedForTextSelection",!1),i(this,"isZoomedForTextSelection",!1),i(this,"textSelectionThreshold",1),i(this,"activeAnnotationThreshold",1),i(this,"moveThreshold",2),i(this,"slideThreshold",10),i(this,"clearSelectionTimerThreshold",3),i(this,"hasSelectedText",!1),i(this,"textPages",[]),i(this,"canPan",!1),i(this,"magnifier",void 0),i(this,"canvas",void 0),i(this,"clickTimer",void 0),i(this,"clickCount",0),i(this,"lastClickPoint",void 0),i(this,"isOverTextCtrlPoint",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),i(this,"isMovedForMultiClick",!1),this.context=t,this.magnifier=new hg(this.context.viewerConfig.textMagnifierStyle),this.canvas=this.context.rendererService.getCanvasDom(),this.context.hooks.afterRender.on((()=>{if(this.needRenderMagnifier){const t=this.magnifierPoint;this.magnifier.render({from:this.canvas,fromX:t.x,fromY:t.y,canvas:this.canvas,canvasX:t.x,canvasY:t.y});}}),this.context);}get isPanMode(){return "pan"===this.context.viewerConfig.toolMode}pointerdownHandler(t){if(this.isPointerdown||!this.isPanMode)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;if("slide"===e.context.displayMode)return;const{isDefaultViewer:i,isThumbnailViewer:n,viewService:s,hasAnnotationModule:o,annotationEditService:r,selectPagesService:a,moveService:l,dragService:h,slideService:c,viewerConfig:{dragStartTimeThreshold:d,enableSlide:u,enableDragPage:p}}=this.context,{displayMode:g}=e.context;if(this.isPointerdown=!0,this.isFirstMove=!0,i){this.isMovedForMultiClick=!1;const{scrollLeft:i,scrollTop:n}=s.getMaxScrollValue(),[a]=this.context.toCanvas(t),{page:h}=this.context.getPointerOverPageInfo(a.pageX,a.pageY).pageInfo;if(o){if(this.startPoint={x:a.pageX,y:a.pageY},h){let{x:t,y:e}=h.cropBox.getPosition(),{width:i,height:n}=h.cropBox;const s=(h.rotation%360+360)%360/90;if(1===s?t-=n:2===s?(t-=i,e-=n):3===s&&(e-=i),1===s||3===s){const t=i;i=n,n=t;}r.setAnnotationContainer(h),r.setAnnotationInteractionArea({left:t,top:e,width:i,height:n});}const{isHit:e,shape:i,isHitSelected:n}=this.context.annotationEditService.isHitAnnotation(t);e&&h?(this.activeShape=i,this.isPointerOnAnnotation=!0,bm(t)?bm(t)&&(this.isAnnotationActive=!0,this.isEditAnnotation=!0,r.startHandler(t,!0)):n?(this.isAnnotationActive=!0,this.isEditAnnotation=!0,r.startHandler(t,!1)):(this.isActivateAnnotation=!0,r.deactivateAnnotation()),r.hasActiveAnnotation()&&(this.canScroll=!1)):r.deactivateAnnotation();}if(!this.isPointerOnAnnotation){const s=this.context.core.pageService.getPage(null==h?void 0:h.uid);if(this.context.viewerConfig.enableTextSelection&&null!=s&&s.isTextPage&&s.visibleLines){const i=xx(h.mediaBox,a.pageX,a.pageY,h.rotation),n={x:i.pointerX,y:i.pointerY},s=h.isPointOnTextStart(n),o=h.isPointOnTextEnd(n),r=!bm(t);if((s||o)&&this.clickCount<1)this.isEditTextStart=s,this.isEditTextEnd=o,this.context.hooks.beforeTextSelected.emit(),r&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:a.pageX,y:a.pageY}),this.context.render();else if(r)!this.isStartTextSelection&&this.pointerNum<2&&(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=setTimeout((()=>{if(this.pointerNum>1)return;clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null;const t=this.context.calcTextStartPosition({x:a.pageX,y:a.pageY},h,e);if(t){this.isTextSelectionMode=!0,this.isStartTextSelection=!0,this.context.textSelectionService.clearSelectedTexts(),this.startTextPosition=t,this.endTextPosition=t;const{textPages:i,startCharRect:n,endCharRect:s,startTextPosition:o,endTextPosition:r}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);e.setTextSelection(i,n,s,o,r),this.hasSelectedText=!0,this.textPages=Nn(i),this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:a.pageX,y:a.pageY}),this.context.render("textSelectionTimer"),this.context.hooks.beforeTextSelected.emit();}}),this.context.viewerConfig.enterTextModeTimeMobile));else if(bm(t)&&this.isTextSelectionMode){const t=this.context.calcTextStartPosition({x:a.pageX,y:a.pageY},h,e);if(t&&(this.isStartTextSelection=!0,this.startTextPosition=t,this.context.textSelectionService.clearSelectedTexts(),this.context.hooks.beforeTextSelected.emit()),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.clickTimer=setTimeout((()=>{this.clickCount=0,this.clickTimer=null;}),this.context.viewerConfig.multipleClickTimeout),this.clickCount>0)if(this.lastClickPoint.x===a.pageX&&this.lastClickPoint.y===a.pageY){const i=e.uidToIndex(h.uid);1===this.clickCount?t&&-1!==t.lineIndex&&this.selectClickedText(t.lineIndex,n,h.uid,i,!0):this.clickCount>1&&t&&-1!==t.lineIndex&&this.selectClickedText(t.lineIndex,n,h.uid,i,!1),this.clickCount+=1;}else this.clickCount=1,this.lastClickPoint={x:a.pageX,y:a.pageY};else this.clickCount=1,this.lastClickPoint={x:a.pageX,y:a.pageY};}}this.canPan&&(this.context.cursorService.applyCursorState(15),this.context.cursorService.lockCursor()),this.isStartTextSelection||(i||n?(this.isMove=!0,this.isSlide=!1,l.startHandler(t)):"single"===g&&u&&(this.isMove=!1,this.isSlide=!0,c.startHandler(t)));}}else if(n){a.startHandler(t);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&!Ps(t)?(this.startX=t.pageX,this.startY=t.pageY,bm(t)?bm(t)&&(p?(this.isDragPages=!0,h.startHandler(t)):(this.isMoveForThumbnail=!0,l.startHandler(t))):p?this.dragTimer=setTimeout((()=>{this.isMoveForThumbnail||(this.isDragPages=!0,h.startHandler(t));}),d):(this.isMoveForThumbnail=!0,l.startHandler(t))):(this.isMoveForThumbnail=!0,l.startHandler(t));}}selectClickedText(t,e,i,n,s){if(-1===t)return;const o=this.context.getActiveTab();this.context.clearSelectedTexts();const r=this.context.core.pageService.getPage(i);if(!r.isTextPage)return;let a;if(s){if(a=r.getSelectedTextWord(t,e),!a)return}else a=r.getSelectedTextSegment(t,e);if(!a)return;const{start:l,end:h}=a,c={lineIndex:l.lineIndex,charIndex:l.charIndex,pageUid:r.uid,pageIndex:n,mediaBoxPoint:{...e}},d={lineIndex:h.lineIndex,charIndex:h.charIndex,pageUid:r.uid,pageIndex:n,mediaBoxPoint:{...e}};this.startTextPosition=c,this.endTextPosition=d;const{textPages:u,startCharRect:p,endCharRect:g,startTextPosition:f,endTextPosition:v}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);o.setTextSelection(u,p,g,f,v),this.hasSelectedText=!0,this.textPages=Nn(u),this.context.render("multipleClickText");}pointermoveHandler(t,e){if(this.pointerNum>1)return;const i=this.context.getActiveTab();if(null==i||!i.total)return;if(!this.isPanMode)return;const{isDefaultViewer:n,isThumbnailViewer:s,viewService:o,moveService:r,slideService:a,annotationEditService:l,dragService:h,selectPagesService:c,textSelectionService:d}=this.context,{displayMode:u}=i.context;if(n&&!e){const[e]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;if(this.isMovedForMultiClick=!0,this.isPointerdown){const s=as(this.startPoint,{x:e.pageX,y:e.pageY});if(s>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0),this.isPointerOnAnnotation&&!this.isAnnotationActive&&this.isFirstMove){s>this.activeAnnotationThreshold&&(this.isActivateAnnotation=!1);const{scrollLeft:e,scrollTop:i}=o.getMaxScrollValue();e||i?(this.isMove=!0,this.isSlide=!1,r.startHandler(t)):"single"===u&&(this.isMove=!1,this.isSlide=!0,a.startHandler(t));}if(s>=this.clearSelectionTimerThreshold&&!this.isStartTextSelection&&this.textSelectionTimerMobile&&(clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null),this.isEditAnnotation)l.moveHandler(t,!n);else if(this.isEditTextStart)this.isStartTextSelection=!0,this.isEditTextStart=!1,this.startTextPosition={...i.endTextPosition};else if(this.isEditTextEnd)this.isStartTextSelection=!0,this.isEditTextEnd=!1,this.startTextPosition={...i.startTextPosition};else if(this.context.viewerConfig.enableTextSelection&&this.isStartTextSelection){const s=this.context.core.pageService.getPage(null==n?void 0:n.uid);if(null!=s&&s.isTextPage&&s.visibleLines){this.context.cursorService.lockCursor();const s=this.context.calcTextEndPosition({x:e.pageX,y:e.pageY},n,i,this.startTextPosition.mediaBoxPoint);if(s){this.endTextPosition=s;const{textPages:n,startCharRect:o,endCharRect:r,startTextPosition:a,endTextPosition:l}=d.calcSelectedText(this.startTextPosition,this.endTextPosition);i.setTextSelection(n,o,r,a,l),this.hasSelectedText=!0,this.textPages=Nn(n),this.context.render("panModeTextSelectionMove");!bm(t)&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY});}}}else this.isMove&&s>this.moveThreshold?(this.isActivateAnnotation=!1,r.moveHandler(t)):this.isSlide&&s>this.slideThreshold&&(this.isActivateAnnotation=!1,a.moveHandler(t));this.isFirstMove=!1;}else if(bm(t)){this.textSelectionTimer&&(clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null,this.isTextSelectionMode=!1);const i=this.context.core.pageService.getPage(null==n?void 0:n.uid);if(null!=i&&i.isTextPage&&null!=i&&i.visibleLines){if(this.context.viewerConfig.enableTextSelection&&!this.isStartTextSelection){let s=!1;if(i.annotations.length){s=this.context.annotationEditService.isHitAnnotation(t).isHit;}if(s)this.isTextSelectionMode=!1,this.canPan=!1;else {const t=xx(n.mediaBox,e.pageX,e.pageY,n.rotation),s={x:t.pointerX,y:t.pointerY},o=n.isPointOnTextStart(s),r=n.isPointOnTextEnd(s);if(o||r)this.isOverTextCtrlPoint=!0,this.context.cursorService.applyCursorState(16),this.canPan=!1;else {this.isOverTextCtrlPoint=!1;if(-1!==i.getHoveredTextLine(s)){n.isPointOnTextSelection(s)||this.isTextSelectionMode||(this.textSelectionTimer&&clearTimeout(this.textSelectionTimer),this.textSelectionTimer=setTimeout((()=>{this.isTextSelectionMode=!0,this.context.cursorService.applyCursorState(16),clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null,this.canPan=!1;}),this.context.viewerConfig.enterTextModeTime));}else this.isTextSelectionMode=!1,this.textSelectionTimer&&(clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null),this.context.cursorService.applyCursorState(14),this.canPan=!0;}}}}else this.isTextSelectionMode=!1,this.context.cursorService.applyCursorState(14),this.canPan=!0;}}else if(s&&e)if(c.moveHandler(t),"touch"===t.pointerType){const e=as({x:this.startX,y:this.startY},{x:t.pageX,y:t.pageY});this.isPointerdown&&this.dragTimer&&(this.isDragPages||r.startHandler(t),e>5&&(clearTimeout(this.dragTimer),this.dragTimer=null)),this.isDragPages?(this.isMoved=!0,h.moveHandler(t)):!this.isDragPages&&this.isPointerdown&&(e>5&&(this.isMoveForThumbnail=!0,r.moveHandler(t)),this.isMoved=!0);}else this.isPointerdown&&this.dragTimer&&(this.isDragPages||r.startHandler(t),clearTimeout(this.dragTimer),this.dragTimer=null),this.isDragPages?(this.isMoved=!0,h.moveHandler(t)):!this.isDragPages&&this.isPointerdown&&(this.isMoveForThumbnail=!0,r.moveHandler(t),this.isMoved=!0);}cursorHandler(t){if(!bm(t))return;if(!this.context.isDefaultViewer)return;if("pan"!==this.context.viewerConfig.toolMode)return;if(this.isTextSelectionMode||this.isOverTextCtrlPoint)return void this.context.cursorService.applyCursorState(16);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&this.context.annotationEditService.cursorHandler(t);}pointerupHandler(t){if(!this.isPointerdown)return;this.context.cursorService.unlockCursor();const{isDefaultViewer:e,isThumbnailViewer:i,annotationEditService:n,moveService:s,slideService:o,dragService:r,selectPagesService:a,textSelectionService:l}=this.context;if(e){if(this.isEditAnnotation?n.endHandler(t):this.isActivateAnnotation?(n.activateAnnotation(this.activeShape,Ps(t)),this.context.render("panModeActiveAnnotationEnd")):this.isMove?s.endHandler(t):this.isSlide&&o.endHandler(t),this.isStartTextSelection||this.isMovedForTextSelection||this.isZoomedForTextSelection||l.clearSelectedTexts(),this.isTextSelectionMode&&bm(t)&&this.lastClickPoint){const[e]=this.context.toCanvas(t);e.pageX===this.lastClickPoint.x&&e.pageY===this.lastClickPoint.y||(this.clickCount=0,this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null));}}else if(i){this.dragTimer&&(clearTimeout(this.dragTimer),this.dragTimer=null);const e=as({x:this.startX,y:this.startY},{x:t.pageX,y:t.pageY});(!this.isMoved||e<this.context.viewerConfig.dragThreshold)&&a.endHandler(t),this.isDragPages?r.endHandler(t):s.endHandler(t);}if(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimer&&clearTimeout(this.textSelectionTimer),this.magnifierPoint=null,this.needRenderMagnifier=!1,this.hasSelectedText){const t=af.create(this.context.textSelectionService.getSelectedTexts(),this.textPages);this.context.hooks.textSelected.emit(t),this.context.hooks.afterTextSelected.emit(),this.context.render("panModeTextSelectedEnd");}this.hasSelectedText=!1,this.isPointerdown=!1,this.isFirstMove=!0,this.isEditAnnotation=!1,this.isMove=!1,this.isSlide=!1,this.isActivateAnnotation=!1,this.isPointerOnAnnotation=!1,this.isAnnotationActive=!1,this.activeShape=null,this.isMoveForThumbnail=!1,this.isDragPages=!1,this.isMoved=!1,this.canScroll=!0,this.startPoint=null,this.isStartTextSelection=!1,0===this.clickCount&&this.isMovedForMultiClick&&(this.isTextSelectionMode=!1),this.isMovedForTextSelection=!1,this.isEditTextStart=!1,this.isEditTextEnd=!1,this.isZoomedForTextSelection=!1,this.isOverTextCtrlPoint=!1,this.canPan&&this.context.applyCursorState(14);}touchstartHandler(t){if(this.pointerNum=t.targetTouches.length,this.context.isDefaultViewer){const{enableZoom:e,enableZoomInPanMode:i,enableZoomWithTouch:n}=this.context.viewerConfig;if(!this.isPanMode||2!==t.targetTouches.length||this.isTouchstart||!e||!n||!i||this.isTextSelectionMode)return;this.isTouchstart=!0,this.context.zoomService.touchstartHandler(t);}}touchmoveHandler(t){this.pointerNum=t.targetTouches.length,2===t.targetTouches.length&&this.isTouchstart&&this.context.isDefaultViewer&&(this.context.zoomService.touchmoveHandler(t),this.isZoomedForTextSelection=!0);}touchendHandler(t){this.pointerNum=t.targetTouches.length,this.isTouchstart&&(this.isTouchstart=!1,this.context.isDefaultViewer&&this.context.zoomService.touchendHandler(t));}wheelHandler(t){if(this.pointerNum=0,!this.isPanMode)return;if(!this.canScroll)return void t.preventDefault();const{isDefaultViewer:e,isThumbnailViewer:i,viewerConfig:{enableZoom:n,enableZoomInPanMode:s,enableZoomWithCtrl:o},zoomService:r,scrollService:a}=this.context;if(e)if(Ts(t)){if(!n||!s||!o)return;r.wheelHandler(t);}else a.wheelHandler(t);else i&&a.wheelHandler(t);i&&t.preventDefault();}scrollHandler(t){this.isPanMode&&this.canScroll&&(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isPanMode)return;const{context:e,context:{keyboardService:i,annotationEditService:n,viewerConfig:{enableKeyboardInteraction:s,enableZoom:o,enableZoomInPanMode:r,enableCopyCutPasteWithKeyboard:a},isPointerWorking:l}}=this;if(!s||l)return;const h=Ps(t);if(e.isDefaultViewer){if(this.context.annotationEditService.hasActiveAnnotation()){if(h)switch(t.key){case"c":case"C":a&&n.copyAnnotations();break;case"x":case"X":a&&n.cutAnnotations();break;case"v":case"V":a&&n.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}else if(As(t)||ks(t)){const e=this.context.annotationEditService.containerPage;if(e){let{x:t,y:i}=e.cropBox.getPosition(),{width:s,height:o}=e.cropBox;const r=(e.rotation%360+360)%360/90;if(1===r?t-=o:2===r?(t-=s,i-=o):3===r&&(i-=s),1===r||3===r){const t=s;s=o,o=t;}n.setAnnotationContainer(e),n.setAnnotationInteractionArea({left:t,top:i,width:s,height:o});}n.keydownHandler(t);}return}if(h)switch(t.key){case"c":case"C":{const t=this.context.getActiveTab();t&&t.hasSelectedTexts()&&this.context.copySelectedTexts();break}case"v":case"V":a&&n.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}switch(t.key){case"Escape":i.escapeHandler(t);break;case"Enter":i.enterHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}else if(e.isThumbnailViewer)switch(t.key){case"a":case"A":i.selectAllHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}keyupHandler(t){if(!this.isPanMode)return;const{context:e,context:{annotationEditService:i,viewerConfig:{enableKeyboardInteraction:n}}}=this;n&&e.isDefaultViewer&&i.keyupHandler(t);}}class gw{constructor(t){i(this,"context",void 0),i(this,"isEditCropBox",!1),i(this,"isTouchstart",!1),i(this,"isPointerdown",!1),i(this,"pointerNum",0),this.context=t;}get isCropMode(){return "crop"===this.context.viewerConfig.toolMode}pointerdownHandler(t){if(this.isPointerdown||!this.isCropMode)return;const e=bm(t);this.isPointerdown=!0;const{context:i}=this;i.hasBoxRendererModule?(i.isDefaultViewer?(this.isEditCropBox=i.cropBoxEditService.isEditCropBox(t),this.isEditCropBox?i.cropBoxEditService.startHandler(t):(i.moveService.startHandler(t),e&&i.applyCursorState(15))):i.isPerspectiveViewer&&(i.perspectiveQuadEditService.startHandler(t),e&&i.perspectiveQuadEditService.isNotOverQuadCtrl(t)&&i.applyCursorState(15)),i.cursorService.lockCursor()):i.isDefaultViewer&&i.moveService.startHandler(t);}pointermoveHandler(t){if(this.pointerNum>1)return;const e=bm(t),{context:i}=this;i.isDefaultViewer?(i.cropBoxEditService.moveHandler(t),e&&i.cropBoxEditService.isNotOverCropBox(t)&&i.cursorService.applyCursorState(14),!this.isEditCropBox&&this.isPointerdown&&i.moveService.moveHandler(t)):i.isPerspectiveViewer&&(i.perspectiveQuadEditService.moveHandler(t),e&&i.perspectiveQuadEditService.isNotOverQuadCtrl(t)&&i.cursorService.applyCursorState(14));}pointerupHandler(t){if(!this.isPointerdown)return;const{context:e}=this;e.cursorService.unlockCursor(),e.isDefaultViewer?this.isEditCropBox?e.cropBoxEditService.endHandler(t):e.moveService.endHandler(t):e.isPerspectiveViewer&&e.perspectiveQuadEditService.endHandler(t),this.isPointerdown=!1,this.isEditCropBox=!1;}touchstartHandler(t){this.pointerNum=t.targetTouches.length;const{context:e,context:{viewerConfig:i}}=this;if(e.isDefaultViewer){if(!this.isCropMode||2!==t.targetTouches.length||this.isTouchstart||!i.enableZoom||!i.enableZoomWithTouch||!i.enableZoomInCropMode)return;this.isTouchstart=!0,e.zoomService.touchstartHandler(t);}}touchmoveHandler(t){this.pointerNum=t.targetTouches.length,2===t.targetTouches.length&&this.isTouchstart&&this.context.isDefaultViewer&&this.context.zoomService.touchmoveHandler(t);}touchendHandler(t){this.pointerNum=t.targetTouches.length,this.isTouchstart&&(this.isTouchstart=!1,this.context.isDefaultViewer&&this.context.zoomService.touchendHandler(t));}wheelHandler(t){if(this.pointerNum=0,!this.isCropMode)return;const{context:e,context:{viewerConfig:i}}=this;if(e.isDefaultViewer)if(Ps(t)){if(!i.enableZoom||!i.enableZoomInCropMode||!i.enableZoomWithCtrl)return;e.zoomService.wheelHandler(t);}else e.isPointerWorking||e.scrollService.wheelHandler(t);}scrollHandler(t){if(!this.isCropMode)return;const{context:e}=this;(e.isDefaultViewer||e.isThumbnailViewer)&&e.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isCropMode)return;const{keyboardService:e,isDefaultViewer:i,viewerConfig:{enableKeyboardInteraction:n,enableZoom:s,enableZoomInCropMode:o},isPointerWorking:r}=this.context;if(i&&n&&!r)switch(t.key){case"y":case"Y":e.redoHandler(t);break;case"z":case"Z":e.undoHandler(t);break;case"-":s&&o&&e.zoomOutHandler(t);break;case"=":s&&o&&e.zoomInHandler(t);break;case"Escape":e.escapeHandler(t);break;case"Enter":e.enterHandler(t);break;case"PageUp":e.pageUpHandler(t);break;case"PageDown":e.pageDownHandler(t);break;case"Home":e.homeHandler(t);break;case"End":e.endHandler(t);break;case"ArrowLeft":e.arrowLeftHandler(t);break;case"ArrowRight":e.arrowRightHandler(t);break;case"ArrowUp":e.arrowUpHandler(t);break;case"ArrowDown":e.arrowDownHandler(t);}}}class fw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"pointerId",null),i(this,"canScroll",!0),this.context=t;}get isAnnotationMode(){return "annotation"===this.context.viewerConfig.toolMode}get isTextAssistMode(){return ["highlight","underline","strikeout"].includes(this.context.viewerConfig.annotationMode)}pointerdownHandler(t){if(this.isPointerdown||!this.isAnnotationMode)return;if(this.pointerId)return;if(!this.context.hasBoxRendererModule||!this.context.isDefaultViewer)return;const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;if(!i)return;this.isPointerdown=!0,this.pointerId=t.pointerId;let{x:n,y:s}=i.cropBox.getPosition(),{width:o,height:r}=i.cropBox;const a=(i.rotation%360+360)%360/90;if(1===a?n-=r:2===a?(n-=o,s-=r):3===a&&(s-=o),1===a||3===a){const t=o;o=r,r=t;}this.context.annotationEditService.setAnnotationContainer(i),this.context.annotationEditService.setAnnotationInteractionArea({left:n,top:s,width:o,height:r}),this.context.annotationEditService.startHandler(t,!0),this.context.annotationEditService.hasActiveAnnotation()&&(this.canScroll=!1);}pointermoveHandler(t){if((this.pointerId===t.pointerId||"touch"!==t.pointerType)&&this.context.isDefaultViewer){const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;this.context.annotationEditService.moveHandler(t,!i);}}cursorHandler(t){if(!bm(t))return;if(!this.context.isDefaultViewer)return;if("annotation"!==this.context.viewerConfig.toolMode)return;if(this.isTextAssistMode&&!this.context.annotationEditService.isMouseOverText)return void this.context.cursorService.applyCursorState(1);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&this.context.annotationEditService.cursorHandler(t);}pointerupHandler(t){this.isPointerdown&&(this.context.isDefaultViewer&&this.context.annotationEditService.endHandler(t),this.isPointerdown=!1,this.canScroll=!0,this.pointerId=null);}wheelHandler(t){if(this.isAnnotationMode)if(this.canScroll){if(this.context.isDefaultViewer)if(Ps(t)){const{enableZoom:e,enableZoomInAnnotationMode:i,enableZoomWithCtrl:n}=this.context.viewerConfig;if(!e||!i||!n)return;this.context.zoomService.wheelHandler(t);}else this.context.scrollService.wheelHandler(t);}else t.preventDefault();}scrollHandler(t){this.isAnnotationMode&&this.canScroll&&(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isAnnotationMode)return;const{context:e,context:{keyboardService:i,annotationEditService:n,viewerConfig:{enableKeyboardInteraction:s,enableZoom:o,enableZoomInAnnotationMode:r,enableCopyCutPasteWithKeyboard:a},hasAnnotationModule:l,isPointerWorking:h}}=this;if(s&&!h&&e.isDefaultViewer)if(this.context.annotationEditService.hasActiveAnnotation()){if(Ps(t))switch(t.key){case"c":case"C":a&&n.copyAnnotations();break;case"x":case"X":a&&n.cutAnnotations();break;case"v":case"V":a&&n.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}else if(As(t)||ks(t)){const e=this.context.annotationEditService.containerPage;if(e){let{x:t,y:i}=e.cropBox.getPosition(),{width:s,height:o}=e.cropBox;const r=(e.rotation%360+360)%360/90;if(1===r?t-=o:2===r?(t-=s,i-=o):3===r&&(i-=s),1===r||3===r){const t=s;s=o,o=t;}n.setAnnotationContainer(e),n.setAnnotationInteractionArea({left:t,top:i,width:s,height:o});}n.keydownHandler(t);}}else {if(Ps(t))switch(t.key){case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"v":case"V":a&&n.pasteAnnotations();break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}switch(t.key){case"Escape":i.escapeHandler(t);break;case"Enter":i.enterHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}keyupHandler(t){if(!this.isAnnotationMode)return;const{context:e,context:{annotationEditService:i,viewerConfig:{enableKeyboardInteraction:n}}}=this;n&&e.isDefaultViewer&&i.keyupHandler(t);}}class vw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),this.context=t;}get isZoomInMode(){return "zoomIn"===this.context.viewerConfig.toolMode}startHandler(t){!this.isPointerdown&&this.context.isDefaultViewer&&(this.context.zoomService.tapZoomHandler(t),this.isPointerdown=!0);}moveHandler(t){bm(t)&&this.context.isDefaultViewer&&"zoomIn"===this.context.viewerConfig.toolMode&&this.context.cursorService.applyCursorState(26);}endHandler(t){this.isPointerdown&&(this.isPointerdown=!1);}keydownHandler(t){if(!this.isZoomInMode||!this.context.isDefaultViewer)return;const{context:{viewerConfig:e}}=this;if(!e.enableKeyboardInteraction||!e.enableZoom||!e.enableZoomInWithKeyboard||this.context.isPointerWorking)return;const{keyboardService:i}=this.context;switch(t.key){case"-":i.zoomInHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}class mw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),this.context=t;}get isZoomOutMode(){return "zoomOut"===this.context.viewerConfig.toolMode}startHandler(t){!this.isPointerdown&&this.context.isDefaultViewer&&(this.context.zoomService.tapZoomHandler(t),this.isPointerdown=!0);}moveHandler(t){bm(t)&&this.context.isDefaultViewer&&"zoomOut"===this.context.viewerConfig.toolMode&&this.context.cursorService.applyCursorState(27);}endHandler(t){this.isPointerdown&&(this.isPointerdown=!1);}keydownHandler(t){if(!this.isZoomOutMode||!this.context.isDefaultViewer)return;const{context:{viewerConfig:e}}=this;if(!e.enableKeyboardInteraction||!e.enableZoom||!e.enableZoomOutWithKeyboard||this.context.isPointerWorking)return;const{keyboardService:i}=this.context;switch(t.key){case"=":i.zoomOutHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}class yw extends js{constructor(t){super(),i(this,"context",void 0),this.context=t,t.hooks.toolModeChanged.on((()=>{this.clearSelectedTexts();}),this),this.context.hooks.annotationModeChanged.on((()=>{"annotation"===this.context.viewerConfig.toolMode&&this.clearSelectedTexts();}),this);}calcSelectedText(t,e){const i=this.context.getActiveTab(),n=[];let s,o,r=t,a=e;t.pageIndex=i.uidToIndex(t.pageUid),e.pageIndex=i.uidToIndex(e.pageUid),(t.pageIndex===e.pageIndex&&(t.lineIndex>e.lineIndex||t.lineIndex===e.lineIndex&&t.charIndex>e.charIndex)||t.pageIndex>e.pageIndex)&&(r=e,a=t);for(let t=r.pageIndex;t<=a.pageIndex;t++){var l;const e=i.getPageByIndex(t),h=this.context.core.pageService.getPage(e.uid);if(!h.isTextPage)continue;if(null===(l=h.visibleLines)||void 0===l||!l.length)continue;const c={pageUid:e.uid,lines:[],text:""};let d=0,u=h.visibleLines.length-1;t===r.pageIndex&&(d=r.lineIndex),t===a.pageIndex&&(u=a.lineIndex);let p="";for(let e=d;e<=u;e++){const i=h.visibleLines[e];let n=i.startIndex,l=i.endIndex;t===r.pageIndex&&e===r.lineIndex&&(n=r.charIndex,s=h.getEndCharRect(e,n)),t===a.pageIndex&&e===a.lineIndex&&(l=a.charIndex,o=h.getEndCharRect(e,l));const d=h.getSelectedTextLine(e,Math.min(n,l),Math.max(n,l));c.lines.push(d),p+=d.text;}c.lines=h.doMergeAdjacentLines(c.lines),t===r.pageIndex&&(s.top=c.lines[0].selectedRect.top,s.height=c.lines[0].selectedRect.height),t===a.pageIndex&&(o.top=c.lines[c.lines.length-1].selectedRect.top,o.height=c.lines[c.lines.length-1].selectedRect.height),c.text=p,n.push(c);}return {textPages:n,startCharRect:s,endCharRect:o,startTextPosition:r,endTextPosition:a}}getSelectedTexts(){let t="";const e=this.context.getActiveTab();if(!e)return "";if(e.selectedTextsCache)return e.selectedTextsCache;const i=e.startTextPosition,n=e.endTextPosition;let s=i,o=n;if(!i||!n)return "";(i.pageIndex===n.pageIndex&&i.lineIndex>n.lineIndex||i.pageIndex>n.pageIndex)&&(s=n,o=i);for(let i=s.pageIndex;i<=o.pageIndex;i++){var r;const n=e.getPageByIndex(i),a=this.context.core.pageService.getPage(n.uid);if(!a.isTextPage)continue;if(null===(r=a.visibleLines)||void 0===r||!r.length)continue;let l="",h=0,c=a.visibleLines.length-1;i===s.pageIndex&&(h=s.lineIndex),i===o.pageIndex&&(c=o.lineIndex);for(let t=h;t<=c;t++){let e=a.visibleLines[t].startIndex,n=a.visibleLines[t].endIndex;i===s.pageIndex&&t===s.lineIndex&&(e=s.charIndex),i===o.pageIndex&&t===o.lineIndex&&(n=o.charIndex);l+=a.getSelectedTextsStr(t,Math.min(e,n),Math.max(e,n),t!==c||i!==o.pageIndex);}t+=l;}return e.selectedTextsCache=t,t}clearSelectedTexts(){const t=this.context.getActiveTab();if(t){if(t.clearTextSelection()){const t=af.create("",[]);this.context.hooks.textSelected.emit(t),this.context.render("clearSelectedTexts");}}}getTextSelectionLines(){const t=this.context.getActiveTab();if(!t)return null;return t.getTextSelectionLines()}getTextSelectionControlPointsRect(){const t=this.context.getActiveTab();return t?t.getTextSelectionControlPointsRect():null}getTextSelection(){if(!this.context.getActiveTab())return [];const t=this.getTextSelectionLines();if(!t)return [];const e=[],i=ko.displayResolution,n=ko.dataResolution;return t.forEach((t=>{const s=[];t.lines.forEach((t=>{s.push({x:Hs(t.selectedRect.left,i,n),y:Hs(t.selectedRect.top,i,n),width:Hs(t.selectedRect.width,i,n),height:Hs(t.selectedRect.height,i,n)});})),e.push({pageUid:t.pageUid,text:t.text,rects:s});})),e}}class xw extends js{constructor(t){super(),i(this,"currentCursor","default"),i(this,"lastCursor","default"),i(this,"lastCursorState",void 0),i(this,"context",void 0),i(this,"isLocked",!1),this.context=t;}applyCursorState(t){if(!t||this.isLocked)return;const{cursorStyle:e}=this.context.viewerConfig;let i=null;switch(t){case 1:i=e.default;break;case 2:i=e.annotationSelect;break;case 3:i=e.annotationDraw;break;case 4:i=e.annotationMove;break;case 5:i=e.annotationNSResize;break;case 6:i=e.annotationEWResize;break;case 7:i=e.annotationNWResize;break;case 8:i=e.annotationNEResize;break;case 10:i=e.annotationSEResize;break;case 9:i=e.annotationSWResize;break;case 11:i=e.annotationRotate;break;case 12:i=e.annotationErase;break;case 13:i=e.annotationActivable;break;case 14:i=e.pan;break;case 15:i=e.panning;break;case 16:i=e.text;break;case 18:i=e.cropDraw;break;case 19:i=e.cropMove;break;case 20:i=e.cropNSResize;break;case 21:i=e.cropEWResize;break;case 22:i=e.cropNWResize;break;case 23:i=e.cropNEResize;break;case 25:i=e.cropSEResize;break;case 24:i=e.cropSWResize;break;case 26:i=e.zoomIn;break;case 27:i=e.zoomOut;}i&&(this.lastCursorState=t,this.setCursor(i));}setCursor(t){this.lastCursor=this.currentCursor,this.currentCursor=t,this.applyCursor();}resetCursor(){this.currentCursor=this.lastCursor,this.applyCursor();}applyCursor(){if(!this.context.viewerConfig.enableCursorService)return;const t=this.context.rendererService.getCanvasDom();(null==t?void 0:t.style.cursor)!==this.currentCursor&&(t.style.cursor=this.currentCursor);}lockCursor(){this.isLocked=!0;}unlockCursor(){this.isLocked=!1;}}class ww{constructor(t,e,n){i(this,"service",void 0),i(this,"text",void 0),i(this,"options",void 0),i(this,"cacheMap",new Map),i(this,"uid",Jn()),i(this,"isStopped",!1),i(this,"searchType",void 0),i(this,"pageUids",[]),i(this,"curSearch",void 0),i(this,"isComplete",!1),i(this,"isNotFound",!1),i(this,"tasks",new Map),i(this,"curTask",null),this.service=t,this.text=e,this.options=n,this.pageUids=this.service.context.getActiveTab().pages.map((t=>t.uid));}hasResult(){return this.cacheMap.size>0}async searchNextText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.breakTask(),this.isStopped)return null;if(this.isNotFound)return null;this.isNotFound=!1;let i=!1;if(this.curSearch){const t=this.cacheMap.get(this.curSearch.pageUid);this.curSearch.index===t.texts.length-1?(this.curSearch.pageIndex!==this.pageUids.length-1?this.curSearch.pageIndex+=1:this.curSearch.pageIndex=0,this.curSearch.pageUid=this.pageUids[this.curSearch.pageIndex],i=!0):this.curSearch.index+=1;}else this.curSearch={pageUid:this.pageUids[0],pageIndex:0,index:0};const n=this.pageUids.slice(this.curSearch.pageIndex).concat(this.pageUids.slice(0,this.curSearch.pageIndex));for(let t=0;t<n.length;t++){const e=n[t];if(this.cacheMap.has(e)){this.curSearch.pageUid=e,this.curSearch.pageIndex=this.pageUids.indexOf(e),i&&(this.curSearch.index=0);break}const s=await this.service.context.core.getSearchedTextsByPageUid(e,this.text,this.options);if(this.isStopped)return null;if(null!=s&&s.length){this.cacheMap.set(e,{pageUid:e,texts:s}),this.curSearch={pageUid:e,pageIndex:this.pageUids.indexOf(e),index:0};break}}return this.handleSearchResults(t,e)}async searchPrevText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.breakTask(),this.isStopped)return null;if(this.isNotFound)return null;this.isNotFound=!1;let e=!1,i=!1;this.curSearch?0===this.curSearch.index?(0!==this.curSearch.pageIndex?this.curSearch.pageIndex-=1:this.curSearch.pageIndex=this.pageUids.length-1,this.curSearch.pageUid=this.pageUids[this.curSearch.pageIndex],e=!0):this.curSearch.index-=1:(this.curSearch={pageUid:this.pageUids[0],pageIndex:0,index:0},i=!0);const n=this.curSearch.pageIndex+1,s=this.pageUids.slice(n).concat(this.pageUids.slice(0,n)).reverse();for(let t=0;t<s.length;t++){const n=s[t];if(this.cacheMap.has(n)){this.curSearch.pageUid=n,this.curSearch.pageIndex=this.pageUids.indexOf(n),i?this.curSearch.index=0:e&&(this.curSearch.index=this.cacheMap.get(n).texts.length-1);break}const o=await this.service.context.core.getSearchedTextsByPageUid(n,this.text,this.options);if(this.isStopped)return null;if(null!=o&&o.length){this.cacheMap.set(n,{pageUid:n,texts:o}),this.curSearch.pageUid=n,this.curSearch.pageIndex=this.pageUids.indexOf(n),i?this.curSearch.index=0:e&&(this.curSearch.index=o.length-1);break}}return this.handleSearchResults(t)}handleSearchResults(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=[];this.cacheMap.has(this.curSearch.pageUid)&&(i=[{pageUid:this.curSearch.pageUid,texts:[this.cacheMap.get(this.curSearch.pageUid).texts[this.curSearch.index]]}]),this.setSearchTextToPage(i),i.length&&this.select(t);const n=new lf(this.text,{...this.options},i,this.uid,this.searchType,[],!0,e);return this.service.context.hooks.searchTextChanged.emit(n),i.length&&this.emitSearchTextSelected(),i.length?i:(this.curSearch=null,this.isNotFound=!0,null)}createTask(){const t={taskUid:Jn(),isBreak:!1};return this.tasks.set(t.taskUid,t),t}async searchFullText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.breakTask(),this.service.context.hooks.searchTextCleared.emit(!0),this.isStopped)return null;const i=this.createTask();this.curTask=i,this.isComplete=!1;let n=!0,s=0,o=2;const r=[];for(let a=0;a<this.pageUids.length;a++){s+=1;const l=this.pageUids[a];if(this.cacheMap.has(l)){this.curSearch||(this.curSearch={pageUid:l,pageIndex:this.pageUids.indexOf(l),index:0});const t=this.cacheMap.get(l);r.push(t);}else {const t=await this.service.context.core.getSearchedTextsByPageUid(l,this.text,this.options);if(this.isStopped||i.isBreak)return null;if(null!=t&&t.length){this.curSearch||(this.curSearch={pageUid:l,pageIndex:this.pageUids.indexOf(l),index:0});const e={pageUid:l,texts:t};this.cacheMap.set(l,e),r.push(e);}}if(r.length&&(n||s%o==0||a===this.pageUids.length-1)){const l=!!n&&e;s=0,o<20&&(o+=1),this.curSearch||(this.curSearch={pageUid:r[0].pageUid,pageIndex:this.pageUids.indexOf(r[0].pageUid),index:0}),this.setSearchTextToPage(r),this.select(t);const h=new lf(this.text,{...this.options},r,this.uid,this.searchType,[],a===this.pageUids.length-1,l);if(this.service.context.hooks.searchTextChanged.emit(h),this.emitSearchTextSelected(),n=!1,i.isBreak||this.isStopped)return null}if(0===a&&!r.length){const t=new lf(this.text,{...this.options},r,this.uid,this.searchType,[],!1,!1);this.service.context.hooks.searchTextChanged.emit(t);}}if(this.isComplete=!0,!this.pageUids.length)return this.service.clearSearchText(),null;if(!r.length){this.setSearchTextToPage(r);const t=new lf(this.text,{...this.options},r,this.uid,this.searchType,[],!0,e);return this.service.context.hooks.searchTextChanged.emit(t),this.curSearch=null,null}return r}setSearchTextToPage(t){const e=this.service.context.getActiveTab();if(!e)return;const i=new Map;t.forEach((t=>{i.set(t.pageUid,t);})),e.pages.forEach((t=>{i.has(t.uid)?t.setSearchedText(i.get(t.uid)):t.clearSearchedText();}));}selectText(t,e){var i,n;const s=`${null===(i=this.curSearch)||void 0===i?void 0:i.pageUid}_${null===(n=this.curSearch)||void 0===n?void 0:n.index}`;if(e===s){const e=this.service.context.getActiveTab();if(!e)return;const i=e.uidToIndex(t);return void(e.current!==i&&this.service.context.viewer.gotoPage(i))}if(!this.cacheMap)return;const o=this.cacheMap.get(t);this.curSearch={pageUid:t,index:o.texts.findIndex((t=>t.textUid===e)),pageIndex:this.pageUids.indexOf(t)},this.select(),this.emitSearchTextSelected();}select(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.service.context.getActiveTab();if(!i)return;const n=this.cacheMap.get(this.curSearch.pageUid),s=n.texts[this.curSearch.index];if(i.pages.forEach((t=>{t.uid!==n.pageUid?t.selectSearchedText(null):t.selectSearchedText(s.textUid);})),t){const t=i.uidToIndex(this.curSearch.pageUid);this.service.context.viewer.gotoPage(t);}e&&this.service.context.render("selectSearchedText");}emitSearchTextSelected(){const t=this.cacheMap.get(this.curSearch.pageUid).texts[this.curSearch.index];this.service.context.hooks.searchTextSelected.emit(t.textUid);}next(){if("single"===this.searchType)return;if(this.isStopped)return;if(!this.curSearch)return;if(!this.isComplete)return;const t=this.cacheMap.get(this.curSearch.pageUid);this.curSearch.index===t.texts.length-1?this.pageUids.slice(this.curSearch.pageIndex+1).concat(this.pageUids.slice(0,this.curSearch.pageIndex+1)).some((t=>{const e=this.cacheMap.get(t);return !!(e&&e.texts.length>0)&&(this.curSearch={pageUid:t,pageIndex:this.pageUids.indexOf(t),index:0},!0)})):this.curSearch.index+=1,this.select(),this.emitSearchTextSelected();}previous(){"single"!==this.searchType&&(this.isStopped||this.curSearch&&this.isComplete&&(0===this.curSearch.index?this.pageUids.slice(this.curSearch.pageIndex).concat(this.pageUids.slice(0,this.curSearch.pageIndex)).reverse().some((t=>{const e=this.cacheMap.get(t);return !!(e&&e.texts.length>0)&&(this.curSearch={pageUid:t,pageIndex:this.pageUids.indexOf(t),index:e.texts.length-1},!0)})):this.curSearch.index-=1,this.select(),this.emitSearchTextSelected()));}reset(){this.cacheMap.clear(),this.curSearch=null,this.isStopped=!1,this.searchType=null,this.tasks.forEach((t=>{t.isBreak=!0;})),this.tasks.clear(),this.curTask=null;}updateSearchType(t){this.searchType=t;}stop(){this.isStopped=!0,this.curTask&&(this.curTask.isBreak=!0);}breakTask(){this.curTask&&(this.curTask.isBreak=!0,this.tasks.delete(this.curTask.taskUid));}refreshPageUids(){const t=this.service.context.getActiveTab();t&&(this.pageUids=t.pages.map((t=>t.uid)));}async addPages(t){this.refreshPageUids(),this.curSearch&&(this.curSearch.pageIndex=this.pageUids.indexOf(this.curSearch.pageUid)),this.isNotFound=!1,"full"===this.searchType?await this.searchFullText(!1):"single"===this.searchType&&(this.curSearch=null,await this.searchNextText(!1));}async deletePages(t){this.refreshPageUids(),this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async updatePage(t){this.deleteCacheByPageUids([t]),this.isNotFound=!1,this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async filterPages(t){this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async perspectivePage(t){this.deleteCacheByPageUids([t]),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async cropPages(t){this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async reorderPages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async swapPages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async movePages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async reSearch(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"single"===this.searchType?await this.searchNextText(t,!0):"full"===this.searchType&&await this.searchFullText(t,!0);}deleteCacheByPageUids(t){t.forEach((t=>{this.cacheMap.delete(t);}));}}class bw extends js{constructor(t){super(),i(this,"context",void 0),i(this,"searchers",new Map),i(this,"curSearcher",void 0),i(this,"lastOptions",{caseSensitive:!1,wholeWord:!1}),i(this,"curText",void 0),i(this,"lastSearchType",void 0),i(this,"isCleared",!1),i(this,"taskUid",void 0),i(this,"cancelQueue",[]),i(this,"searchTimer",null),i(this,"defaultOptions",{caseSensitive:!1,wholeWord:!1}),i(this,"lastSearchRes",void 0),this.context=t,this.listenEvents();}listenEvents(){const{documentService:t}=this.context.core,{hooks:e}=this.context;e.closeDocument.on((t=>{this.clearSearchText();}),this),t.onBeforeDeleteDocs.on((async t=>{const e=this.context.getActiveTab();e&&t.docUids.forEach((t=>{e.uid===t&&this.curSearcher&&this.clearSearchText();}));}),this),e.deletePages.on((async t=>{var e;const{docUid:i,pageUids:n}=t;if(!this.isMeetEventConditions(i))return;if(!this.context.getActiveTab().total)return this.clearSearchText(),void(this.lastSearchRes=null);await this.curSearcher.deletePages(n),this.lastSearchRes=null===(e=this.lastSearchRes)||void 0===e?void 0:e.filter((t=>!n.includes(t.pageUid)));}),this),e.addPagesToDoc.on((async t=>{const{docUid:e,pageUids:i}=t;this.isMeetEventConditions(e)&&await this.curSearcher.addPages(i);}),this),e.updatePage.on((async t=>{const{docUid:e,pageUid:i}=t;this.isMeetEventConditions(e)&&await this.curSearcher.updatePage(i);}),this),e.reorderPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.reorderPages();}),this),e.movePages.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.movePages();}),this),e.swapPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.swapPages();}),this),this.context.core.onFilterChanged.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.filterPages(t.pageUids);}),this),this.context.core.onAfterPerspective.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.perspectivePage(t.pageUid);}),this),this.context.core.editService.onAfterCropPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&(await this.curSearcher.cropPages(t.pageUids),this.context.render("afterCropPagesForTextSearch"));}),this);}isMeetEventConditions(t){const e=this.context.getActiveTab();return !(!(e&&(null==e?void 0:e.uid)===t&&this.curSearcher&&this.curText)||this.curSearcher.isStopped)}createTextSearcher(t,e,i){let n=this.searchers.get(t);return n||(this.context.getActiveTab(),n=new ww(this,e,i),this.searchers.set(n.uid,n)),n}async searchNextText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),Object.assign(this.lastOptions,i||{}),this.curText=e;const n=this.createTextSearcher(t,e,i);this.curSearcher=n;}else this.isSearchTypeChanged("single")&&this.curSearcher.reset();this.lastSearchType="single",this.curSearcher.updateSearchType("single");const n=await this.curSearcher.searchNextText();return !this.curSearcher.isStopped&&(this.context.render("searchNextText"),!!n)}async searchPrevText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),Object.assign(this.lastOptions,i||{}),this.curText=e;const n=this.createTextSearcher(t,e,i);this.curSearcher=n;}else this.isSearchTypeChanged("single")&&this.curSearcher.reset();this.lastSearchType="single",this.curSearcher.updateSearchType("single");const n=await this.curSearcher.searchPrevText();return !this.curSearcher.isStopped&&(this.context.render("searchPrevText"),!!n)}async searchFullText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isCleared=!1,this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),this.cancelQueue.forEach((t=>{t();})),this.cancelQueue=[],this.curText=e;const n=Jn();this.taskUid=n;if(!await new Promise((t=>{this.searchTimer=setTimeout((()=>{t(!0);}),this.context.viewerConfig.textSearchDelay),this.cancelQueue.push((()=>{t(!1);}));}))||this.taskUid!==n||this.isCleared||this.curText&&this.curText!==e)return null;Object.assign(this.lastOptions,i||{});const s=this.createTextSearcher(t,e,i);this.curSearcher=s;}else {if(!this.isSearchTypeChanged("full"))return !!this.lastSearchRes;if(!this.curSearcher)return !1;this.curSearcher.reset();}this.lastSearchType="full",this.curSearcher.updateSearchType("full");const n=this.curSearcher,s=await n.searchFullText(!1);return !n.isStopped&&(this.isCleared&&this.clearSearchTextFromPage(),this.context.render("searchFullText"),this.lastSearchRes=s,!!s)}isTextChanged(t){return this.curText!==t}isSearchTypeChanged(t){return this.lastSearchType!==t}isOptionsChanged(t){if(!t||0===Object.keys(t).length)return !1;const e={...this.lastOptions,...t};return this.lastOptions.caseSensitive!==e.caseSensitive||this.lastOptions.wholeWord!==e.wholeWord}stopSearch(t){const e=this.searchers.get(t);e&&(e.stop(),this.searchers.delete(t));}nextText(){const t=this.curSearcher;t&&!t.isStopped&&t.next();}previousText(){const t=this.curSearcher;t&&!t.isStopped&&t.previous();}selectText(t,e){const i=this.curSearcher;i&&!i.isStopped&&i.selectText(t,e);}clearSearchText(){this.searchers.forEach((t=>{t.stop();})),this.searchers.clear(),this.isCleared=!0,this.clearSearchTextFromPage(),this.context.render("clearSearchText"),this.curSearcher=null,this.curText=null,this.lastSearchType=null,this.context.hooks.searchTextCleared.emit();}clearSearchTextFromPage(){const t=this.context.getActiveTab();t&&t.pages.forEach((t=>{t.clearSearchedText();}));}dispose(){this.context=null,this.searchers.forEach((t=>{t.stop();})),super.dispose();}}class Sw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"isStartTextSelection",!1),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionTimerMobile",void 0),i(this,"isEditTextStart",!1),i(this,"isEditTextEnd",!1),i(this,"isMovedForTextSelection",!1),i(this,"isZoomedForTextSelection",!1),i(this,"textSelectionThreshold",1),i(this,"clearSelectionTimerThreshold",3),i(this,"startPoint",void 0),i(this,"hasSelectedText",!1),i(this,"textPages",[]),i(this,"clickTimer",void 0),i(this,"clickCount",0),i(this,"lastClickPoint",void 0),i(this,"magnifier",void 0),i(this,"canvas",void 0),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),this.context=t,this.magnifier=new hg(this.context.viewerConfig.textMagnifierStyle),this.canvas=this.context.rendererService.getCanvasDom(),this.context.hooks.afterRender.on((()=>{if(this.needRenderMagnifier){const t=this.magnifierPoint;this.magnifier.render({from:this.canvas,fromX:t.x,fromY:t.y,canvas:this.canvas,canvasX:t.x,canvasY:t.y});}}),this.context);}get isTextSelectionMode(){return "textSelection"===this.context.viewerConfig.toolMode}startHandler(t){if(this.isPointerdown||!this.isTextSelectionMode)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;if(!this.context.isDefaultViewer)return;const[i]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(i.pageX,i.pageY).pageInfo;if(!n)return;const s=this.context.core.pageService.getPage(n.uid);if(!s.isTextPage||!s.visibleLines)return;this.context.annotationEditService.hasActiveAnnotation()&&this.context.annotationEditService.deactivateAnnotation();const o=!bm(t),r=xx(n.mediaBox,i.pageX,i.pageY,n.rotation),a={x:r.pointerX,y:r.pointerY},l=n.isPointOnTextStart(a),h=n.isPointOnTextEnd(a);if((l||h)&&this.clickCount<1)this.isEditTextStart=l,this.isEditTextEnd=h,this.context.hooks.beforeTextSelected.emit(),o&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY});else if(o)this.isStartTextSelection||(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=setTimeout((()=>{clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null;const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},n,e);if(t){this.context.textSelectionService.clearSelectedTexts(),this.startTextPosition=t,this.endTextPosition=t,this.isStartTextSelection=!0;const{textPages:n,startCharRect:s,endCharRect:o,startTextPosition:r,endTextPosition:a}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);e.setTextSelection(n,s,o,r,a),this.hasSelectedText=!0,this.textPages=Nn(n),this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY}),this.context.render("textSelectionModeTimerStart"),this.context.hooks.beforeTextSelected.emit();}}),this.context.viewerConfig.enterTextModeTimeMobile));else if(bm(t)){const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},n,e);if(t&&(this.startTextPosition=t,this.context.textSelectionService.clearSelectedTexts(),this.isStartTextSelection=!0,this.context.hooks.beforeTextSelected.emit()),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.clickTimer=setTimeout((()=>{this.clickCount=0,this.clickTimer=null;}),this.context.viewerConfig.multipleClickTimeout),this.clickCount>0)if(this.lastClickPoint.x===i.pageX&&this.lastClickPoint.y===i.pageY){const i=e.uidToIndex(n.uid);1===this.clickCount?t&&-1!==t.lineIndex&&this.selectClickedText(t.lineIndex,a,n.uid,i,!0):this.clickCount>1&&t&&-1!==t.lineIndex&&this.selectClickedText(t.lineIndex,a,n.uid,i,!1),this.clickCount+=1;}else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};}this.startPoint={x:i.pageX,y:i.pageY},this.isPointerdown=!0;}selectClickedText(t,e,i,n,s){if(-1===t)return;const o=this.context.getActiveTab();this.context.clearSelectedTexts();const r=this.context.core.pageService.getPage(i);if(!r.isTextPage)return;let a;if(s){if(a=r.getSelectedTextWord(t,e),!a)return}else a=r.getSelectedTextSegment(t,e);if(!a)return;const{start:l,end:h}=a,c={lineIndex:l.lineIndex,charIndex:l.charIndex,pageUid:r.uid,pageIndex:n,mediaBoxPoint:{...e}},d={lineIndex:h.lineIndex,charIndex:h.charIndex,pageUid:r.uid,pageIndex:n,mediaBoxPoint:{...e}};this.startTextPosition=c,this.endTextPosition=d;const{textPages:u,startCharRect:p,endCharRect:g,startTextPosition:f,endTextPosition:v}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);o.setTextSelection(u,p,g,f,v),this.hasSelectedText=!0,this.textPages=Nn(u),this.context.render("textSelectionModeMultipleSelect");}moveHandler(t){if(!this.isTextSelectionMode||!this.context.viewerConfig.enableTextSelection)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;if(!this.context.isDefaultViewer)return;const[i]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(i.pageX,i.pageY).pageInfo;if(!n)return;const s=this.context.core.pageService.getPage(n.uid);if(this.isPointerdown){if(null==s||!s.visibleLines||null==s||!s.isTextPage)return;const o=as(this.startPoint,{x:i.pageX,y:i.pageY});if(o>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0),o>=this.clearSelectionTimerThreshold&&!this.isStartTextSelection&&this.textSelectionTimerMobile&&(clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null),this.isEditTextStart)this.isStartTextSelection=!0,this.isEditTextStart=!1,this.startTextPosition={...e.endTextPosition};else if(this.isEditTextEnd)this.isStartTextSelection=!0,this.isEditTextEnd=!1,this.startTextPosition={...e.startTextPosition};else if(this.context.viewerConfig.enableTextSelection&&this.isStartTextSelection){this.context.cursorService.lockCursor();const s=this.context.calcTextEndPosition({x:i.pageX,y:i.pageY},n,e,this.startTextPosition.mediaBoxPoint);if(s){this.endTextPosition=s;const{textPages:n,startCharRect:o,endCharRect:r,startTextPosition:a,endTextPosition:l}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);e.setTextSelection(n,o,r,a,l),this.hasSelectedText=!0,this.textPages=Nn(n);!bm(t)&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY}),this.context.render("textSelectionModeMove");}}}else {let t=1;if(!this.isStartTextSelection&&s.visibleLines&&null!=s&&s.isTextPage){const e=xx(n.mediaBox,i.pageX,i.pageY,n.rotation),o={x:e.pointerX,y:e.pointerY},r=n.isPointOnTextStart(o),a=n.isPointOnTextEnd(o);if(r||a)t=16;else {const e=s.getHoveredTextLine(o);n.isPointOnTextSelection(o)||-1===e||(t=16);}}this.context.cursorService.applyCursorState(t);}}endHandler(t){if(this.isPointerdown){if(this.context.cursorService.unlockCursor(),this.isStartTextSelection||this.isMovedForTextSelection||this.isZoomedForTextSelection||this.context.textSelectionService.clearSelectedTexts(),this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.hasSelectedText){const t=af.create(this.context.textSelectionService.getSelectedTexts(),this.textPages);this.context.hooks.textSelected.emit(t),this.context.hooks.afterTextSelected.emit();}if(bm(t)&&this.lastClickPoint){const[e]=this.context.toCanvas(t);e.pageX===this.lastClickPoint.x&&e.pageY===this.lastClickPoint.y||(this.clickCount=0,this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null));}this.hasSelectedText=!1,this.isStartTextSelection=!1,this.isPointerdown=!1,this.isMovedForTextSelection=!1,this.isEditTextStart=!1,this.isEditTextEnd=!1,this.isZoomedForTextSelection=!1,this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render("textSelectionModeEnd");}}wheelHandler(t){if(this.isTextSelectionMode&&this.context.isDefaultViewer)if(Ps(t)){const{enableZoom:e,enableZoomInAnnotationMode:i,enableZoomWithCtrl:n}=this.context.viewerConfig;if(!e||!i||!n)return;this.context.zoomService.wheelHandler(t);}else this.context.scrollService.wheelHandler(t);}scrollHandler(t){this.isTextSelectionMode&&this.context.isDefaultViewer&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isTextSelectionMode)return;const{context:e,context:{keyboardService:i,annotationEditService:n,isDefaultViewer:s,viewerConfig:{enableKeyboardInteraction:o,enableCopyCutPasteWithKeyboard:r},isPointerWorking:a}}=this;if(!o||a||!s)return;const l=this.context.getActiveTab();if(null==l||!l.total)return;if(Ps(t))switch(t.key){case"c":case"C":l.hasSelectedTexts&&r&&this.context.copySelectedTexts();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);}}}class Cw extends js{constructor(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),i(this,"core",void 0),i(this,"viewer",void 0),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"hooks",void 0),i(this,"mainViewerUid",null),i(this,"viewService",void 0),i(this,"rendererService",void 0),i(this,"tabService",void 0),i(this,"layoutService",void 0),i(this,"styleService",void 0),i(this,"configService",void 0),i(this,"visibilityService",void 0),i(this,"annotationEditService",void 0),i(this,"cropBoxEditService",void 0),i(this,"perspectiveQuadEditService",void 0),i(this,"eventsService",void 0),i(this,"dragService",void 0),i(this,"moveService",void 0),i(this,"scrollService",void 0),i(this,"zoomService",void 0),i(this,"slideService",void 0),i(this,"textSelectionService",void 0),i(this,"textSearchService",void 0),i(this,"optimizationService",void 0),i(this,"interactionService",void 0),i(this,"selectPagesService",void 0),i(this,"keyboardService",void 0),i(this,"cursorService",void 0),i(this,"viewerConfig",Nn(ox)),i(this,"postfix",void 0),i(this,"isDestroyed",!1),i(this,"viewportWidth",0),i(this,"viewportHeight",0),i(this,"scrollByCurrentChanged",!1),i(this,"isInitialized",!1),i(this,"addPagesTimer",null),i(this,"isPanning",void 0),i(this,"isZooming",void 0),i(this,"isSliding",void 0),i(this,"isFocusCanvas",!1),i(this,"isFocusViewer",!1),i(this,"isPointerWorking",!1),i(this,"hasBoxRendererModule",!1),i(this,"hasAnnotationModule",!1),this.core=t,this.viewer=e,this.postfix=e.postfix,this.hooks=e.hooks,this.uid=e.uid,this.groupUid=e.groupUid,Ws(n,this.viewerConfig),this.styleService=new Px(this),this.viewService=this.register(new Nx(this,this.hooks)),this.rendererService=this.register(new $x(this,this.hooks)),this.layoutService=new Kx(this,this.hooks),this.configService=this.register(new ew(this)),this.tabService=this.register(new Cx(this)),this.visibilityService=new Ix(this),this.optimizationService=this.register(new hw(this)),this.cursorService=this.register(new xw(this)),this.handleViewerModeChanged(),this.eventsService=this.register(new iw(this)),this.dragService=this.register(new nw(this)),this.moveService=this.register(new sw(this)),this.scrollService=this.register(new ow(this)),this.zoomService=this.register(new rw(this)),this.slideService=this.register(new lw(this)),this.textSelectionService=this.register(new yw(this)),this.textSearchService=this.register(new bw(this)),this.interactionService=this.register(new cw(this,new pw(this),new gw(this),new fw(this),new vw(this),new mw(this),new Sw(this))),this.selectPagesService=this.register(new dw(this)),this.keyboardService=this.register(new uw(this)),this.eventsService.handleExternalEvents(),this.optimizationService.handleOptimizationEvents(),this.interactionService.handleEvents(),this.isThumbnailViewer&&this.viewer.on("thumbnailBind",(t=>{this.mainViewerUid=t;}));}get isCropToolMode(){return "crop"===this.viewerConfig.toolMode}get isVisible(){var t;return "visible"===(null===(t=this.viewerConfig)||void 0===t?void 0:t.visibility)}syncViewer(t){const e=t.getActiveTab();if(!e)return;const i=this.tabService.createTab(e.doc);if(i.isDocType){const{width:t,height:e}=this.viewService.getViewportSize();i.updateViewportSize(t,e);}i.currentUid=e.currentUid,i.selectPages([...e.selected]),this.tabService.activateTab(i.uid),this.hooks.syncDocument.emit(i.doc),this.emitPageChangedEvent(i),this.showTab(i),this.emitPageChangedAfterRenderEvent(i);}toCanvas(t){const e=[];let i=null;i=t instanceof MouseEvent||t instanceof PointerEvent?[t]:arguments.length>1&&void 0!==arguments[1]&&arguments[1]?t.changedTouches:t.touches;const{x:n,y:s}=this.rendererService.getCanvasPosition();for(let t=0;t<i.length;t++){const o=i[t];e.push({pageX:o.pageX-n,pageY:o.pageY-s});}return e}getPointerOverPageInfo(t,e){const i=function(t,e,i){const n={pageInfo:{isOver:!1,pointerX:-1,pointerY:-1,page:null},imageInfo:{isOver:!1,pointerX:-1,pointerY:-1,page:null},index:-1};if(t)for(let s=0;s<t.pages.length;s++){const o=t.pages[s],r=wx(o,e,i,o.isVisible);if(r.isOver){n.index=s,Object.assign(n.pageInfo,r);const t=wx(o.image,e,i,!0);return t.isOver&&Object.assign(n.imageInfo,t),n}}return n}(this.getActiveTab(),t,e);return i}getPointerOverMediaBoxInfo(t,e,i,n){return xx(t,e,i,n)}resize(){if(this.tabService.resizeScrollbar(),this.isCaptureViewer)return;this.viewService.resizeViewport(),this.updateViewportSize(),this.rendererService.updateCanvasSize(),this.styleService.isCheckboxStyleChanged=!0,this.styleService.isPageNumberStyleChanged=!0;const t=this.getActiveTab();t&&(this.clearCurrentTabOptimization(),this.showTab(t,!0));}updateViewportSize(){const{width:t,height:e}=this.viewService.getViewportSize();this.viewportWidth=t,this.viewportHeight=e,this.tabService.updateViewportSize(t,e);}handleViewerModeChanged(){const{postfix:t,viewService:e,isDefaultViewer:i,isPerspectiveViewer:n,isThumbnailViewer:s}=this;if(i||n||s){e.createMainAndThbContainer(t),e.createMainContainer(t),s||e.createThumbnailContainer(t),i&&(e.createVideoContainer(t),e.createAudioContainer(t)),ym(e.mainAndThbContainer,"flex");const{width:n,height:o}=e.getViewportSize();this.rendererService.initRenderer(e.canvasContainer,n,o),this.rendererService.updateCanvasSize();}}loadSource(t,e){const i=this.getActiveTab();let n=null==i?void 0:i.uid;if(!i){const t=this.core.createDocument({name:Jf(),type:"document"});this.viewer.openDocument(t),n=t.uid;}const s=Du.buildInfo("loadSource",{docUid:n,current:0,total:On(t)?t.length:1});return Du.info(s),this.core.loadSource(t,n,{exception:e?"fail":"ignore"},s).catch((t=>{throw s.status="Failed",Du.info(s),t}))}openDocument(t){const{tabService:e}=this;let i=e.getTab(t.uid);if(!i){const n=e.getActiveTab();if(n&&(clearTimeout(this.addPagesTimer),this.addPagesTimer=null,this.hooks.closeDocument.emit(n.doc)),i=e.createTab(t),i.isDocType){const{width:t,height:e}=this.viewService.getViewportSize();i.updateViewportSize(t,e);}}i.isActive||(this.tabService.activateTab(i.uid),this.emitPageChangedEvent(i),this.showTab(i),this.hooks.openDocument.emit(t),this.emitPageChangedAfterRenderEvent(i));}closeTabs(t){const e=t.filter((t=>this.tabService.hasTab(t)));if(!e.length)return;const i=e.reduce(((t,e,i)=>{const n=this.tabService.getTab(e);return n&&t.push(n),t}),[]);i.forEach((t=>{t.isActive&&(clearTimeout(this.addPagesTimer),this.addPagesTimer=null,this.clearCurrentTabOptimization()),this.tabService.closeTab(t.uid),this.hooks.closeDocument.emit(t.doc);}));const n=this.tabService.getActiveTab();n?this.showTab(n):(this.rendererService.docRenderer.clear(),this.resetCanvas(),this.hooks.pageChanged.emit(Yg.create(-1,0)));}resetCanvas(){this.isCaptureViewer||(this.viewService.resetViewport(),this.rendererService.updateCanvasSize(),this.rendererService.clearCanvas());}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if("hidden"===this.viewerConfig.visibility)return;if(this.isDestroyed)return;const e=this.getActiveTab();e&&this.rendererService.render(e,t);}showCurrentTab(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const e=this.getActiveTab();null!=e&&e.total&&this.showTab(e,t);}showTab(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.isDestroyed||t.isDestroyed||(this.tabService.activateTab(t.uid),"hidden"!==this.viewerConfig.visibility&&(this.isDefaultViewer?this.showTabDefault(t,e):this.isThumbnailViewer?this.showTabThumbnail(t,e,i):this.isPerspectiveViewer&&this.showTabPerspective(t)));}showTabDefault(t){const e=t;if(!e.isDocType)return;e.style.visibility="visible";const i=e.context.zoom;this.layoutService.layout(e),this.viewerConfig.zoom=e.context.zoom;const n=e.context.zoom!==i;if(this.viewService.updateScrollerContentSize(e),this.rendererService.updateCanvasSize(),!e.total)return void this.rendererService.render(e,"showDefaultTab");const{scrollLeft:s,scrollTop:o}=e.context.parseReferenceDefault();e.context.setTabScrollValue(s,o),this.viewService.scrollTo(s,o),this.visibilityService.handleVisibility(e),this.loadVisiblePages(e),n&&this.clearCurrentTabOptimization(),this.rendererService.render(e,"showDefaultTab"),this.emitZoomChangedEvent(e);}showTabPerspective(t){const e=t;if(!e.isDocType)return;if(e.style.visibility="visible",this.layoutService.layout(e),this.viewService.updateScrollerContentSize(e),this.rendererService.updateCanvasSize(),!e.total)return void this.rendererService.render(e,"showPerspectiveTab");const{scrollLeft:i,scrollTop:n}=e.context.parseReferenceDefault();e.context.setTabScrollValue(i,n),this.viewService.scrollTo(i,n),this.visibilityService.handleVisibility(e),this.loadVisiblePages(e),this.rendererService.render(e,"showPerspectiveTab");}showTabThumbnail(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t.isDocType)return;if(t.style.visibility="visible",this.layoutService.layout(t),this.viewService.updateScrollerContentSize(t),this.rendererService.updateCanvasSize(),!t.total)return void this.rendererService.render(t,"showThumbnailTab");if(t.isActive&&this.isVisible&&this.viewerConfig.autoScroll&&!i){const{scrollLeft:e,scrollTop:i}=t.context.getScrollValuesByCurrentChanged();t.context.setTabScrollValue(e,i);}const{scrollLeft:n,scrollTop:s}=t.context;this.viewService.scrollTo(n,s),this.visibilityService.handleVisibility(t),this.loadVisiblePages(t),e&&this.clearCurrentTabOptimization(),this.rendererService.render(t,"showThumbnailTab");}loadPageImage(t){return this.isDefaultViewer||this.isThumbnailViewer?this.core.imageLoadService.loadDisplayImage(t):this.isPerspectiveViewer?this.core.imageLoadService.loadRawImage(t):null}loadVisiblePages(t){if(t.isDestroyed||null==t||!t.total)return;const e=[],i=[],n=t.getCurrentPage();let s=!1;t.pages.forEach((t=>{!t.isPreload||t.isLoaded||t.isLoading||(t.uid===(null==n?void 0:n.uid)?s=!0:t.isVisible?i.push(t):t.isPreload&&e.push(t));}));const o=[];s&&o.push(n),o.push(...e.reverse(),...i.reverse()),o.forEach((e=>{!e.isPreload||e.isLoaded||e.isLoading||(e.isLoading=!0,this.loadPageImage(e.uid).then((i=>{e.isLoading=!1,i&&this.renderPage(t,e,i);const n=this.core.pageService.getPage(e.uid);n&&n.isTextPage&&!n.parsedTexts&&this.core.textLoadService.loadText([n.uid]);})).catch((t=>{e.isLoading=!1;})));}));}renderPage(t,e,i){if(!this.isDestroyed&&this.isVisible&&t.isActive&&t.pages.includes(e)&&!t.isDestroyed&&e.isPreload&&(e.isLoaded=!0,e.setImgDom(i),e.isVisible)){if(this.isDefaultViewer&&t.context.isSingleDisplay){const e=t.getCurrentPage();if(e&&!e.isLoaded)return}this.rendererService.render(t,"renderPage");}}emitPageChangedEvent(t){this.hooks.pageChanged.emit(Yg.create(t.current,t.total));}emitPageChangedAfterRenderEvent(t){this.hooks.pageChangedAfterRender.emit(Yg.create(t.current,t.total));}emitZoomChangedEvent(t){const{oldZoom:e,zoom:i}=t.context;this.hooks.zoomChanged.emit(vf.create(xm(e),xm(i)));}afterPerspective(t,e){const i=this.getActiveTab();if(i&&i.uid===t){const t=i.getTextSelectionLines();null!=t&&t.find((t=>t.pageUid===e))&&this.clearSelectedTexts();}}beforeLoadSource(t){const{tabService:e}=this,i=e.getDocTab(t);i&&i.updateOldInfo();}afterLoadSource(t){const{tabService:e}=this,i=e.getDocTab(t);i&&(this.emitPageChangedEvent(i),this.emitPageChangedAfterRenderEvent(i),i.updateOldInfo());}addPages(t,e,i,n){const{tabService:s}=this,o=s.getDocTab(t);o&&(o.appendPages(e,i,n),this.emitPageChangedEvent(o),o.isActive&&!this.addPagesTimer&&(this.addPagesTimer=setTimeout((()=>{o.isActive&&(this.scrollByCurrentChanged=!0,this.showTab(o)),clearTimeout(this.addPagesTimer),this.addPagesTimer=null;}),200)));}deletePages(t,e){const{tabService:i}=this,n=i.getDocTab(t);n&&(this.clearOptimization(e),n.deletePages(e),this.textSelectionService.clearSelectedTexts(),this.hooks.deletePages.emit(Uf.create(e,n.uid)),this.emitEventsForTab(n));}deleteAllPages(t){const{tabService:e}=this,i=e.getDocTab(t);if(!i)return;const n=i.pages.map((t=>t.uid));this.clearOptimization(n),i.deleteAllPages(),this.textSelectionService.clearSelectedTexts(),this.hooks.deletePages.emit(Uf.create(n,i.uid)),this.emitEventsForTab(i);}setCurrentPage(t,e){const{tabService:i}=this,n=i.getDocTab(t);n&&n.current!==e&&(n.gotoPage(e),this.emitEventsForTab(n));}selectPages(t,e){const{tabService:i}=this,n=i.getDocTab(t);if(!n)return;const s=n.getSelected(),o=n.getSelectedIndices();let r=!1;if(o.length!==e.length)r=!0;else for(let t=0;t<e.length;t++)if(o[t]!==e[t]){r=!0;break}if(!r)return;const a=n.indicesToUids(e);if(n.selectPages(a),n.isActive){this.showTab(n,!1,!0);const t=zf.create(o,[...e],[...s],a);this.hooks.selectedPageChanged.emit(t);}}movePages(t,e,i){const n=this.tabService.getDocTab(t);n&&(n.movePages(e,i),this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(n,this.isDefaultViewer));}switchPage(t,e,i){const n=this.tabService.getDocTab(t);n&&(n.switchPage(e,i),this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(n,this.isDefaultViewer));}reorderPages(t,e){const i=this.tabService.getDocTab(t);i&&(i.reorderPages(e),this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(i,this.isDefaultViewer));}emitEventsForTab(t,e){t.isActive&&(this.emitPageChangedEvent(t),this.scrollByCurrentChanged=!0,this.showTab(t,e),this.emitPageChangedAfterRenderEvent(t));}updatePage(t,e,i){const n=this.tabService.getTab(t);if(n&&n.isActive){var s;const t=n.getPageByUid(e);t.isLoaded=!1,t.isLoading=!1,(t=>{const e=window.URL||window.webkitURL;/^blob:/.test(t)&&e.revokeObjectURL(t);})((null===(s=t.image.style)||void 0===s?void 0:s.img).src),this.clearOptimization([e]),this.clearSelectedTexts(),this.showTab(n);}}renameDoc(t,e){const{tabService:i}=this,n=i.getTab(t);n&&(n.rename(e),this.hooks.tabChanged.emit());}filter(t,e,i){if(this.isPerspectiveViewer||this.isCaptureViewer)return;const n=this.getActiveTab();n&&n.uid===t&&(e.forEach((t=>{const e=n.getPageByUid(t);e&&(e.isLoaded=!1);})),this.hooks.filterChanged.emit(Kg.create(t,e,i)),this.loadVisiblePages(n),this.clearOptimization(e),this.rendererService.render(n,"filter"));}activateTab(t){const e=this.tabService.getTab(t);return !!e&&(this.showTab(e),!0)}getActiveTab(){return this.tabService.getActiveTab()}getSelectedTexts(){const t=this.getActiveTab();if(null==t||!t.total)return "";return this.textSelectionService.getSelectedTexts()}async copySelectedTexts(){const t=this.getActiveTab();if(null==t||!t.total)return Promise.reject(new Error("no text selected"));const e=this.textSelectionService.getSelectedTexts();return await navigator.clipboard.writeText(e),Promise.resolve(void 0)}clearSelectedTexts(){this.textSelectionService.clearSelectedTexts();}dispose(){this.tabService.getAllTabs().forEach((t=>{const e=[];if(t.pages.forEach(((t,i)=>{[...t.mediaBox.childNodes].forEach((t=>{null==t||t.destroy();})),t.isPreload&&e.push({from:!0,to:!1,pageUid:t.uid,index:i});})),e.length){const i=Mf.create(t.uid,this.uid,this.viewerConfig.viewerMode,e);this.core.viewerService.onPagePreloadChanged.emit(i);}})),this.isDestroyed=!0,this.hooks.destroy.emit(),super.dispose();}get isDefaultViewer(){return this.viewerConfig.viewerMode===dg.DEFAULT}get isThumbnailViewer(){return this.viewerConfig.viewerMode===dg.THUMBNAIL}get isPerspectiveViewer(){return this.viewerConfig.viewerMode===dg.PERSPECTIVE}get isCaptureViewer(){return this.viewerConfig.viewerMode===dg.CAPTURE}zoomTo(t,e,i){this.zoomService.zoomTo(t,e,i);}getPageRenderSize(t){const e=this.core.pageService.getPage(t);return this.isPerspectiveViewer?e.raw.getPageSize():e.mediaBox}emit(t,e){this.viewer.emit(t,e);}hasCallback(t){return this.viewer.emitter.hasCallback(t)}clearCurrentTabOptimization(){if(!this.viewerConfig.enableOptimizePage)return;const t=this.getActiveTab();if(t){const e=t.pages.map((t=>t.uid));this.clearOptimization(e);}}clearOptimization(t){const e=[],i=this.getActiveTab();i&&t.forEach((t=>{const n=i.getPageByUid(t);n&&(e.push(n.optimizationUid),n.clearOptimization());})),e.forEach((t=>{this.optimizationService.cancelOptimization(t);}));}applyCursorState(t){this.cursorService.applyCursorState(t);}async searchNextText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchNextText(i.uid,t,e)}async searchPrevText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchPrevText(i.uid,t,e)}async searchFullText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchFullText(i.uid,t,e)}selectSearchText(t,e){this.textSearchService.selectText(t,e);}nextSearchText(){this.textSearchService.nextText();}prevSearchText(){this.textSearchService.previousText();}clearSearchText(){this.textSearchService.clearSearchText();}getVisiblePagesInfo(){const t=this.getActiveTab();if(!t)return [];if(this.isCaptureViewer)return [];if("hidden"===this.viewerConfig.visibility)return [];const{visibleChildren:e}=t,i=[];if(e.length>0){var n;const{canvas:s}=this.rendererService.docRenderer;let o=null===(n=this.viewer)||void 0===n||null===(n=n.ui)||void 0===n?void 0:n.container;if(this.isThumbnailViewer&&this.mainViewerUid){o=this.core.viewerService.getViewer(this.mainViewerUid).ui.container;}const{left:r,top:a}=o.getBoundingClientRect(),{left:l,top:h}=s.getBoundingClientRect();for(let n=0;n<e.length;n++){const s=e[n],o=t.getPageIndex(s),{x:c,y:d}=s.getPosition();i.push({pageUid:s.uid,pageIndex:o,width:s.bounds.width,height:s.bounds.height,isHovered:s.isHovered,isSelected:s.isSelected,canvasOffsetX:c,canvasOffsetY:d,containerOffsetX:l-r+c,containerOffsetY:h-a+d});}}return i}calcTextStartPosition(t,e,i){let n=t;if(!(arguments.length>3&&void 0!==arguments[3]&&arguments[3])){const i=this.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);n={x:i.pointerX,y:i.pointerY};}const s=this.core.pageService.getPage(e.uid),o=s.getHoveredTextLine(n);if(-1!==o){return {lineIndex:o,charIndex:s.getSelectedTextCharIndex(o,n),pageUid:e.uid,pageIndex:i.uidToIndex(e.uid),mediaBoxPoint:n}}return null}calcTextEndPosition(t,e,i,n){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=this.core.pageService.getPage(e.uid);if(!o.parsedTexts)return null;let r=t;if(!s){const i=this.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);r={x:i.pointerX,y:i.pointerY};}const a=o.getSelectedTextLineIndex(n,r);if(-1!==a){return {lineIndex:a,charIndex:o.getSelectedTextCharIndex(a,r),pageUid:e.uid,pageIndex:i.uidToIndex(e.uid),mediaBoxPoint:r}}return null}getTextSelection(){return this.textSelectionService.getTextSelection()}}class Pw extends js{constructor(t){super(),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"group",void 0),i(this,"postfix",void 0),i(this,"context",void 0),i(this,"emitter",void 0),i(this,"hooks",void 0),i(this,"core",void 0),i(this,"isDisposed",!1),this.emitter=new Kn,t.core&&(this.core=t.core),this.uid=Jn(),this.groupUid=t.groupUid,this.postfix=`-${this.uid}`,this.hooks=this.register(new pg),this.context=new Cw(this.core,this,t.viewerConfig),t.container&&!t.uiConfig&&this.context.viewService.bindContainer(t.container),this.listenGlobalEvents();}listenGlobalEvents(){const{documentService:t,viewerService:e}=this.core,{context:i}=this;this.core.onAfterPerspective.on((t=>{i.afterPerspective(t.docUid,t.pageUid);}),this),this.core.onBeforeLoadSource.on((t=>{let{docUid:e}=t;i.beforeLoadSource(e);}),this),this.core.onAfterLoadSource.on((t=>{i.afterLoadSource(t.docUid);}),this),this.core.pageService.onUpdatePage.on((t=>{i.updatePage(t.docUid,t.pageUid,t.data),i.hooks.updatePage.emit(t);}),this),t.onAddPagesToDoc.on((t=>{const{group:e}=this;let{scrollToLatest:n}=e.config;_n(n)&&({scrollToLatest:n}=i.viewerConfig),i.addPages(t.docUid,t.pageUids,n,t.index),i.hooks.addPagesToDoc.emit(t);}),this),t.onDeletePagesFromDoc.on((t=>{i.deletePages(t.docUid,t.pageUids);}),this),t.onDeleteAllPagesFromDoc.on((t=>{i.deleteAllPages(t.docUid);}),this),t.onMovePages.on((t=>{i.movePages(t.docUid,t.indices,t.insertBeforeIndex),this.hooks.movePages.emit(t);}),this),t.onSwitchPage.on((t=>{i.switchPage(t.docUid,t.one,t.another),this.hooks.swapPages.emit(t);}),this),t.onReorderPages.on((t=>{i.reorderPages(t.docUid,t.indices),this.hooks.reorderPages.emit(t);}),this),t.onBeforeDeleteDocs.on((t=>{i.closeTabs(t.docUids);}),this),t.onDocumentRenamed.on((t=>{i.renameDoc(t.docUid,t.newName);}),this),t.onDocumentDeleted.on((t=>{i.closeTabs([t.docUid]);}),this),t.onOpenDocument.on((t=>{i.groupUid===t.groupUid&&i.openDocument(t.doc);}),this),t.onCloseDocument.on((t=>{i.groupUid===t.groupUid&&i.closeTabs([t.doc.uid]);}),this),e.onGotoPage.on((t=>{i.groupUid===t.groupUid&&i.setCurrentPage(t.docUid,t.index);}),this),e.onSelectPages.on((t=>{i.groupUid===t.groupUid&&i.selectPages(t.docUid,t.indices);}),this),e.onResize.on((()=>{i.resize();}),this),e.onCurrentChangedByScroll.on((t=>{i.groupUid===t.groupUid&&i.uid!==t.viewerUid&&i.setCurrentPage(t.docUid,t.current);}),this),this.core.onFilterChanged.on((t=>{const e=i.getActiveTab();(null==e?void 0:e.uid)===t.docUid&&i.filter(t.docUid,t.pageUids,t.filterType);}),this),this.core.commandService.onOperationsChanged.on((t=>{const e=i.getActiveTab();e?e.uid===t.docUid&&i.hooks.operationsChanged.emit(t):this.hooks.operationsChanged.emit({docUid:t.docUid,undo:0,redo:0});}),this);}dispose(){this.isDisposed||(this.unbindContainer(),this.context.dispose(),this.context=null,this.isDisposed=!0,this.core.removeViewer(this),super.dispose());}undo(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.undo(t.uid)}redo(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.redo(t.uid)}getOperationState(){const t=this.context.getActiveTab();return t?this.core.commandService.getOperationState(t.uid):{undo:0,redo:0}}saveOperations(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.saveOperations(t.uid)}setRowAndColumn(t,e){return this.context.configService.updateConfig({rows:t,columns:e}),!0}getRowAndColumn(){const t=this.context.getActiveTab();if(t)return {rows:t.context.rows,columns:t.context.columns};const{viewerConfig:e}=this.context;return {rows:e.rows||1,columns:e.columns||1}}on(t,e){this.emitter.on(t,e);}emit(t,e){this.emitter.emit(t,e);}off(t,e){this.emitter.off(t,e);}getViewerConfig(){return this.context.viewerConfig}updateViewerConfig(t){this.context.configService.updateConfig(t);}bindContainer(t){return this.context.viewService.bindContainer(t)}unbindContainer(){this.context.viewService.unbindContainer();}show(){"visible"!==this.getViewerConfig().visibility&&(this.updateViewerConfig({visibility:"visible"}),this.context.showCurrentTab());}hide(){"hidden"!==this.getViewerConfig().visibility&&this.updateViewerConfig({visibility:"hidden"});}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.context.render(t);}resize(){this.context.resize();}indexToUid(t){const e=this.context.getActiveTab();return null==e?void 0:e.indexToUid(t)}uidToIndex(t){const e=this.context.getActiveTab();return e?e.uidToIndex(t):-1}getCurrentPageIndex(){const t=this.context.getActiveTab();return t?t.current:-1}getPageCounts(){const t=this.context.getActiveTab();return t?t.total:0}getCurrentPageUid(){var t;const e=this.context.getActiveTab();return null==e||null===(t=e.getCurrentPage())||void 0===t?void 0:t.uid}selectAllPages(){const t=this.getPageCounts();return this.selectPagesByIndices(Array.from(Array(t).keys()))}selectPagesByIndices(t){const e=this.context.getActiveTab();if(!e)return [];const i=e.indicesToUids(t);return this.core.viewerService.onSelectPages.emit(Of.create(e.uid,this.groupUid,this.uid,t)),[...i]}getSelectedPageIndices(){const t=this.context.getActiveTab();if(!t)return [];return t.getSelectedIndices()}gotoPage(t){const e=this.context.getActiveTab();return e?(t=Yn(t,0,e.total-1),e.current===t||this.core.viewerService.onGotoPage.emit(Qg.create(e.uid,this.groupUid,this.uid,t)),t):-1}movePages(t,e){const i=this.context.getActiveTab();return !!i&&this.core.movePages(i.uid,t,e)}swapPages(t,e){const i=this.context.getActiveTab();return !!i&&this.core.swapPages(i.uid,t,e)}reorderPages(t){const e=this.context.getActiveTab();return !!e&&this.core.reorderPages(e.uid,t)}deletePages(t){const e=this.context.getActiveTab();if(!e)return !1;if(!t.every((t=>t>=0&&t<e.total)))return !1;const i=e.indicesToUids(t);return this.core.deletePages(e.uid,i)}deleteAllPages(){const t=this.context.getActiveTab();return !!t&&this.core.deleteAllPages(t.uid)}openDocument(t){this.core.openDocument(t.uid,this.uid);}closeDocument(t){if(!t){const e=this.context.getActiveTab();if(!e)return;t=e.uid;}this.core.closeDocument(t,this.uid);}activateTab(t){var e;return (null===(e=this.context)||void 0===e?void 0:e.activateTab(t))||!1}getActiveTab(){var t;return (null===(t=this.context)||void 0===t?void 0:t.getActiveTab())||null}getAllTabs(){var t;return (null===(t=this.context)||void 0===t?void 0:t.tabService.getAllTabs())||[]}getRealPageSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_n(t)&&(t=e.current);const i=e.getPageByIndex(t);return {width:i.rWidth,height:i.rHeight}}getRealPtPageSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_n(t)&&(t=e.current);const i=e.getPageByIndex(t);let n=Hs(i.rWidth,ko.displayResolution,72),s=Hs(i.rHeight,ko.displayResolution,72);const o=Math.round(n),r=Math.round(s);return Math.abs(n-o)<1e-6&&(n=o),Math.abs(s-r)<1e-6&&(s=r),{width:n,height:s}}getRealPixelSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_n(t)&&(t=e.current);const i=e.getPageByIndex(t),n=this.core.pageService.getPage(i.uid),{rWidth:s,rHeight:o}=n.getEditResultForPerspective();return {width:Hs(s,ko.displayResolution,n.resource.resolutionX),height:Hs(o,ko.displayResolution,n.resource.resolutionY)}}zoomIn(){const t=this.getActiveTab();if(!t||!t.isDocType)return;const{maxZoom:e}=this.getViewerConfig(),{zoom:i}=t.context;let n=Tw(i,"in");(null===n||n>e)&&(n=e),this.updateViewerConfig({zoom:n});}zoomOut(){const t=this.getActiveTab();if(!t||!t.isDocType)return;const{minZoom:e}=this.getViewerConfig(),{zoom:i}=t.context;let n=Tw(i,"out");(null===n||n<e)&&(n=e),this.updateViewerConfig({zoom:n});}filter(t,e){const i=this.context.getActiveTab();if(!i)return !1;const n=i.indicesToUids(t);return n.forEach((t=>{const e=this.core.pageService.getPage(t);e&&(e.isTextPage=!1),this.context.textSelectionService.clearSelectedTexts();})),this.core.filterPages(i.uid,n,e),!0}async perspectivePage(t,e){const i=this.context.getActiveTab();if(!i)return null;let n=i.currentUid;_n(e)||(n=i.indexToUid(e));const s=this.context.core.pageService.getPage(n);t=Hs(t,s.resource.resolutionX,ko.displayResolution);const o=await this.core.perspectivePage(i.uid,n,t);return this.context.textSelectionService.clearSelectedTexts(),s.isTextPage=!1,o.data}perspectiveAllPage(){const t=this.context.getActiveTab();if(!t)return;this.context.textSelectionService.clearSelectedTexts();const e=[],i=[],n=[];t.pages.forEach(((t,s)=>{t.isVisible?e.push(s):t.isPreload?i.push(s):n.push(s);}));const s=[...e,...i,...n],{displayResolution:o}=ko;for(let e=0;e<s.length;e++){const i=this.indexToUid(s[e]),n=this.context.core.pageService.getPage(i);if(n.isFull){let{width:e,height:s}=n.raw.getImageDetail();const r=Math.abs((n.rotation%360+360)%360);if(90===r||270===r){const t=e;e=s,s=t;}const a=[[0,0],[e,0],[e,s],[0,s]];this.context.core.perspectivePage(t.uid,i,Hs(a,n.resolutionX,o),!0);}else if(n.activeQuad&&n.activeQuad!==n.quad){n.isTextPage=!1;const{width:e,height:s}=n.raw.getPageSize(),o=nv(n.activeQuad.flat(),n.rotation,e,s),r=rv(o);this.context.core.perspectivePage(t.uid,i,r,!0);}}}getPerspectivePreviewImage(t,e,i,n){const s=this.context.getActiveTab();if(!s)return null;const o=s.getPageByIndex(t);if(!o)return null;const r=o.uid,{quadSelectionStyle:a}=this.getViewerConfig(),{borderColor:l}=ws(a.border),h=function(t){const e=t=>{const e=t.toString(16);return 1===e.length?`0${e}`:e};if(t.startsWith("rgb")){const i=t.match(/(\d+)/g);if(3===i.length){const t=parseInt(i[0],10),n=parseInt(i[1],10),s=parseInt(i[2],10);return `#${e(t)}${e(n)}${e(s)}`}}if(t.startsWith("#")&&(7===t.length||4===t.length))return t;return "#FE8E14"}(l);return this.context.core.getPerspectivePreviewData(r,{width:e||200,height:i||200},{strokeColor:h.substring(1),lineWidth:n})}async copySelectedTexts(){return this.context.copySelectedTexts()}getSelectedTexts(){return this.context.getSelectedTexts()}searchNextText(t,e){return this.context.searchNextText(t,e)}searchPrevText(t,e){return this.context.searchPrevText(t,e)}searchFullText(t,e){return this.context.searchFullText(t,e)}selectSearchText(t,e){this.context.selectSearchText(t,e);}nextSearchText(){this.context.nextSearchText();}prevSearchText(){this.context.prevSearchText();}clearSearchText(){this.context.clearSearchText();}getVisiblePagesInfo(){return this.context.getVisiblePagesInfo()}}function Tw(t,e){const i=[.01,.0625,.125,.25,.333,.5,.667,.75,1,1.25,1.5,2,3,4,6,8,12,16,24,32,64];if("in"===e){for(let e=0;e<i.length;e++)if(i[e]>t)return i[e]}else for(let e=i.length-1;e>=0;e--)if(i[e]<t)return i[e];return null}class Aw extends js{constructor(t){super(),i(this,"isDestroyed",!1),i(this,"viewers",new Map),i(this,"groups",new Map),i(this,"onGotoPage",void 0),i(this,"onSelectPages",void 0),i(this,"onCurrentChangedByScroll",void 0),i(this,"onResize",void 0),i(this,"onPagePreloadChanged",void 0),i(this,"onViewerCreated",void 0),i(this,"core",void 0),this.core=t,this.initEventEmitter();}initEventEmitter(){this.onGotoPage=Gs(this),this.onSelectPages=Gs(this),this.onCurrentChangedByScroll=Gs(this),this.onResize=Gs(this),this.onPagePreloadChanged=Gs(this),this.onViewerCreated=Gs(this);}reset(){for(const t of this.viewers.values())t.dispose();this.viewers.clear(),this.groups.clear();}destroy(){if(!this.isDestroyed){for(const t of this.viewers.values())t.dispose();this.viewers=null,this.groups=null,this.isDestroyed=!0;}}createViewer(t,e){var i;const{groupUid:n}=e,s=this.groups.get(n)||new lg(n);var o;_n(null===(i=e.viewerConfig)||void 0===i?void 0:i.scrollToLatest)||s.isSetScrollToLatest||(s.updateConfig({scrollToLatest:null===(o=e.viewerConfig)||void 0===o?void 0:o.scrollToLatest}),s.isSetScrollToLatest=!0);e.groupConfig&&s.updateConfig(e.groupConfig);const r=new t(e);r.group=s,s.viewerUids.add(r.uid),this.groups.set(n,s),this.viewers.set(r.uid,r);const a=this.getViewersByGroupUid(n);if(a.length>0){r.context.syncViewer(a[0]);const t=a[0].getActiveTab();t&&this.core.commandService.emitOperationsChanged(t.uid);}return this.onViewerCreated.emit(rf.create(r)),r}removeViewer(t){let e;if(e=Gn(t)?this.getViewer(t):t,!e)return !1;const{uid:i,groupUid:n}=e,s=this.groups.get(n);return s&&(s.viewerUids.delete(i),s.viewerUids.size||this.groups.delete(n)),this.viewers.delete(e.uid),e.dispose(),!0}hasViewer(t){return this.viewers.has(t)}getViewer(t){return this.viewers.get(t)}getAllViewers(){return Array.from(this.viewers.values())}getViewersByViewerUid(t){const e=this.viewers.get(t);return this.getViewersByGroupUid(e.groupUid)}getViewersByGroupUid(t){return this.groups.has(t)?this.groups.get(t).getViewerUids().map((t=>this.viewers.get(t))):[]}hasGroup(t){return this.groups.has(t)}}const kw={apply(t){t.viewerService=new Aw(t);},install(t){t.setClass("Viewer",Pw);}},Ew=/^<\/([^>]*)>/,Dw=/^<([^\s>]+)[^>]*>/,Rw=/^<slot>.*<\/slot>/,Iw=/(:?[@\w-]+)\s*=\s*"(.*?)"/;function Mw(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const{template:i,data:n,components:s,injection:o}=t,r=Bw(i,n,s,o,e),a=r.length;return a&&(r[0].cpInstance=t,r[a-1].cpInstance=t),r}function Bw(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=t.trim();const r=[];function a(t){o=o.substring(t);}function l(t){let[s,o]=t;if(o){const t=function(t){const e={},i=Os(t,Iw);return i?(i.forEach((t=>{let[,i,n]=t;e[i]=n;})),e):e}(s),a=e[":for"];a&&(delete e[":for"],t[":for"]=a);const l={type:"start",name:o,data:e,attrs:t};if(r.push(l),(i[o]||n.components&&n.components[o])&&(l.cpOption={Component:i[o]||n.components[o],injection:n}),"input"===o||/\/>/.test(s)){const t={type:"end",name:o,data:e,attrs:{}};r.push(t);}}}function h(t){let[,e]=t;if(e){const t={type:"end",name:e,attrs:{}};r.push(t);}}function c(t){if(t.length){const i={type:"text",name:t,attrs:{},data:e};r.push(i);}}for(;o;){const t=o.indexOf("<");let e;if(0===t){const t=o.match(Ew);if(t){a(t[0].length),h(t);continue}const i=o.match(Rw);if(i){a(i[0].length),r.push(...s);continue}const n=o.match(Dw);if(n&&n[0]!==n.input){a(n[0].length),l(n);continue}e=o;}else e=t>0?o.substring(0,t):o;e&&(a(e.length),c(e));}return r}function Uw(t){const{cpInstance:e,children:i}=t;e&&!e.isInserted&&(e.isInserted=!0,e.hooks.inserted.emit()),i.forEach((t=>{Uw(t);}));}function Lw(t){const{cpInstance:e,children:i}=t;e&&e.hooks.destroyed.emit(t),i.forEach((t=>{Lw(t);}));}function Ow(t){if(t){const{el:e,children:i,cpInstance:n}=t;if(null!=n&&n.emitDestroyByRender&&function(t){const{cpInstance:e}=t;e&&(e.dispose(),e.hooks.beforeDestroyed.emit(t));}(t),e){const i=e.parentElement;i&&i.removeChild(e),e.vNode=null,t.el=null;}return null!=n&&n.emitDestroyByRender&&Lw(t),t.text=null,t.parent=null,i.length&&i.forEach((t=>{Ow(t);})),!0}return !1}class Ww{constructor(t){i(this,"el",void 0),i(this,"tagName",void 0),i(this,"sel",""),i(this,"data",void 0),i(this,"children",void 0),i(this,"text",void 0),i(this,"key",void 0),i(this,"cpInstance",void 0),i(this,"cpOptions",void 0),i(this,"parent",void 0),this.createVNode(t);}renderDom(){if(this.el)return this.el;let t;if("FRAGMENT"===this.tagName)t=document.createDocumentFragment();else if("TEXT"===this.tagName){const e=function(t){return 0===t.length?"":t.replace(function(){if(fs)return fs;let t="";return vs(gs,(e=>{t+=`${e}|`;})),t+="&#(\\d{1,5});",fs=new RegExp(t,"g"),fs}(),((t,e)=>ps[t]||String.fromCharCode(+e)))}(this.text);t=document.createTextNode(e);}else {t=document.createElement("IMAGE"===this.tagName?"IMG":this.tagName);for(const[e,i]of Object.entries(this.data))t.setAttribute(e,i);}return this.children.forEach((e=>{const i=e.renderDom();t.appendChild(i);})),t.vNode=this,this.el=t,function(t){const{cpInstance:e,el:i}=t;e&&(e.vNode=t,e.hooks.created.emit(i));}(this),t}patch(t){return function(t,e){const i=t.el,n=i.parentNode;null!==n&&(e.el=e.renderDom(),ys(e.el,i,n),Ow(t));let s=-1;const o=t.parent;return null==o||o.children.forEach(((e,i)=>{e===t&&(s=i);})),s>-1&&(o.children[s]=e,e.parent=o,t.el=null),e}(this,t)}destroy(){return Ow(this)}createVNode(t){const{tagName:e,data:i={},children:n=[],el:s=null,key:o,text:r="",cpOptions:a,cpInstance:l}=t;let h=e;i.id&&(h+=`#${i.id}`),i.class&&(h+=`.${i.class}`),this.sel=h,this.data=i,this.tagName=e,this.children=n,this.el=s,this.key=o,this.text=r,this.cpInstance=l,this.cpOptions=a;}}function Nw(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[],n=[];let s=[];return t.forEach((t=>{if("start"===t.type)i.push(t),n.push(s),s=[];else if("text"===t.type)s.push({type:"text",value:t.name,data:t.data});else if(t instanceof Ww)s.push(t);else {let e=i.pop();for(;e.name!==t.name;)e=i.pop();if(e){const{name:t,cpInstance:i,attrs:o,cpOption:r,data:a}=e,l={type:"token",tagName:t,cpInstance:i,cpOption:r,attrs:o,data:a,children:s};s.forEach((t=>{t.parent=l;})),s=n.pop(),s.push(l);}}})),e?s[0]:s}const _w=/'.+'|\\".+\\"|[\w$.]+/g,Fw=/{{([^\s@}]+)}}/;function Hw(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(On(t)){const e=[];return t.forEach((t=>{e.push(...zw(Hw(t)));})),e}if(t instanceof Ww)return t;if("token"===t.type){var i;const{tagName:n,attrs:s,cpInstance:o,children:r,data:a,cpOption:l}=t;if(s[":for"])return function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{attrs:i,data:n}=t,s=JSON.parse(JSON.stringify(i)),o={":for":i[":for"]};delete i[":for"],Vw(o,{...n,...e});const r=[];return o[":for"].forEach((e=>{const i=Hw(t,e);r.push(...zw(i));})),t.attrs=s,r}(t,e);const h={...a,...e},c={...s};let d;if(Vw(s,h),Object.prototype.hasOwnProperty.call(s,"if")&&!s.if)d=null;else if(delete s.if,l)d=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{children:i,attrs:n,cpOption:s}=t,o=$w(i,e),{Component:r,injection:a}=s,l=new r({data:n,injection:a}),h=Nw(Mw(l,o));if(!h)return null;return zw(Hw(h))[0]}(t,e);else {const{key:t}=s;void 0!==t&&delete s.key;const i=$w(r,e);d=new Ww({tagName:n.toUpperCase(),data:s,cpInstance:o,key:t,children:i});}return t.attrs=c,null===(i=d)||void 0===i||i.children.forEach((t=>{t.parent=d;})),d}return function(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{value:n}=t;const s=null===(e=t.parent)||void 0===e||null===(e=e.attrs)||void 0===e?void 0:e.html;if(n=function(t,e){const i=Os(t,Fw);i.length&&i.forEach((i=>{const n=i[1].split(".").reduce(((t,e)=>t[e]),e),s=i[0];t=t.replace(s,n);}));return t}(n,{...t.data,...i}),s){return Hw(Nw(Bw(n),!1))}return new Ww({tagName:"TEXT",text:n})}(t,e)}function Vw(t,e){for(const s of Object.keys(t)){const[,o,r]=s.match(/^(:|@)(.+)/)||[];if(!r)continue;let a=t[s];if(delete t[s],"for"===r){var i,n;let[s,o]=a.split(" in "),[r,l]=s.split(",");r=r.trim(),l=null===(i=l)||void 0===i?void 0:i.trim(),o=null===(n=o)||void 0===n?void 0:n.trim();const h=[],c=o.split(".").reduce(((t,e)=>t[e]),e);if(On(c))c.forEach(((t,e)=>{const i={};i[r]=t,l&&(i[l]=e),h.push(i);}));else if(Wn(c))for(const[t,e]of Object.entries(c)){const i={};i[r]=e,l&&(i[l]=t),h.push(i);}t[":for"]=h;}else {const i="this"===a?e:a.split(".").reduce(((t,e)=>null==t?void 0:t[e]),e);if(void 0!==i)"class"===r&&t[r]?t[r]=`${t[r]} ${i}`:t[r]=i;else {a=a.replace(_w,(t=>t.includes('"')||t.includes("'")||/^(true|false|\d+|undefined|null)$/.test(t)?t:t.split(".")));try{const i=jw(a,e);Us(i)&&(t[r]=void 0),"class"===r&&t[r]?t[r]=`${t[r]} ${i}`:t[r]=i;}catch(e){t[r]=void 0;}}"@"===o&&(t.events||(t.events={}),t.events[r]=t[r],delete t[`@${r}`]);}}}function zw(t){return t?(On(t)||(t=[t]),t):[]}function $w(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=[];return t.forEach((t=>{const n=Hw(t,e)||[];i.push(...zw(n));})),i}function jw(t,e){let i=null;try{const n=t.split(",");for(let t=0;t<n.length;t++){const i=n[t],s=/(\w+)(\[(\d+)\])?/,o=i.match(s);if(!o){e=null;break}{const t=o[1],i=o[3];if(!Object.prototype.hasOwnProperty.call(e,t)){e=null;break}e=e[t],void 0!==i&&Array.isArray(e)&&(e=e[i]);}}i=e;}catch(t){i=null;}return i}class Xw extends js{constructor(t){let{data:e={},template:n="",components:s={},injection:o={}}=t;super(),i(this,"el",void 0),i(this,"vNode",null),i(this,"template",""),i(this,"data",{}),i(this,"injection",{}),i(this,"components",{}),i(this,"emitter",void 0),i(this,"uiEmitter",void 0),i(this,"isInserted",!1),i(this,"emitDestroyByRender",!0),i(this,"hooks",{created:es.create(),inserted:es.create(),updated:es.create(),beforeDestroyed:es.create(),destroyed:es.create()}),i(this,"selfEvents",[]),i(this,"globalEvents",[]),i(this,"nativeEvents",[]),this.template=n,this.emitter=Kn.create(),this.setData(e),this.setComponents(s),this.setInjects(o),this.uiEmitter=this.injection.emitter,this.hooks.created.on((t=>{this.el=t;})),this.hooks.destroyed.on((()=>{this.dispose();})),this.initEvents();}setInjects(t){Object.assign(this.injection,t);}initEvents(){var t=this;const e=(e,i)=>{this.on(e,(function(){for(var e=arguments.length,n=new Array(e),s=0;s<e;s++)n[s]=arguments[s];Gn(i)?t.$emit(i,n):$n(i)&&i(...n);}));};for(const[t,n]of Object.entries((null===(i=this.data)||void 0===i?void 0:i.events)||{})){var i;e(t,n);}for(const[t,i]of Object.entries((null===(n=this.data)||void 0===n||null===(n=n.options)||void 0===n?void 0:n.events)||{})){var n;e(t,i);}}setData(t){Object.assign(this.data,t);}setComponents(t){Object.assign(this.components,t);}on(t,e){this.emitter.on(t,e),this.selfEvents.push([t,e]);}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];this.emitter.emit(t,...i);}unbindSelfEvents(){this.selfEvents.forEach((t=>{let[e,i]=t;this.emitter.off(e,i);})),this.selfEvents=[];}$on(t,e){var i;this.uiEmitter&&(null===(i=this.uiEmitter)||void 0===i||i.on(t,e),this.globalEvents.push([t,e]));}$emit(t){for(var e,i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];null===(e=this.uiEmitter)||void 0===e||e.emit(t,...n);}unbindGlobalEvents(){this.globalEvents.forEach((t=>{let[e,i]=t;this.uiEmitter.off(e,i);})),this.globalEvents=[];}nativeOn(t,e,i){if(On(t))t.forEach((t=>{this.nativeOn(t,e,i);}));else {const n=((t,e,i,n)=>t?(t.addEventListener(e,i,n),()=>{t.removeEventListener(e,i);}):null)(t,e,i);n&&this.nativeEvents.push(n);}}unbindNativeEvents(){this.nativeEvents.forEach((t=>{t();})),this.nativeEvents=[];}query(t){var e;return null===(e=this.el)||void 0===e?void 0:e.querySelector(t)}queryAll(t){var e;return null===(e=this.el)||void 0===e?void 0:e.querySelectorAll(t)}parseHTML(){return Hw(Nw(Mw(this,[])))}reRenderVNode(){const t=function(t){const e=Mw(t);return Hw(Nw(e))}(this);this.vNode.patch(t);}bindEventsEmitter(){var t=this;const{options:e}=this.data;if(null!=e&&e.events)for(const[i,n]of Object.entries(e.events))this.nativeOn(this.el,i,(function(){for(var e=arguments.length,n=new Array(e),s=0;s<e;s++)n[s]=arguments[s];t.emit(i,...n);}));}dispose(){this.unbindSelfEvents(),this.unbindGlobalEvents(),this.unbindNativeEvents(),super.dispose();}}const Gw=(t,e,i,n)=>{const{id:s,tooltip:o,dataId:r,style:a,className:l}=t||{},h=(t=>{let e="";if(t)for(const[i,n]of Object.entries(t))e+=`${Un(i)}:${n};`;return e})(a);return (_n(s)?"":` id="${s}"`)+` class="${e}${null!=i?i:""} ${l||""}"`+(_n(n)?"":` :class="${n}"`)+(h?` style="${h}"`:"")+(_n(o)?"":` title="${o}"`)+(_n(r)?"":` data-id="${r}"`)};function Yw(t){if(0===Object.keys(t).length||!t)return '<MainView :options="this"></MainView>';const e=-1!==["Root","DDVRoot","Layout","DDVLayout"].indexOf(null==t?void 0:t.type);return Gn(t.type)&&!e?`<${t.type} :options="this"></${t.type}>`:'<Root :options="this"></Root>'}function qw(){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const e=Nn(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return null!=e&&e.children&&(e.children=e.children.map((t=>Gn(t)?{type:t}:Wn(t)?qw(t):t))),t.length&&(e.children||On(e.children)||(e.children=[]),e.children.push(...t)),e}class Jw{constructor(t){i(this,"options",void 0),i(this,"postfix",void 0),i(this,"uiEvents",[]),i(this,"parsedUiConfig",void 0),i(this,"injection",void 0),i(this,"rootComponent",void 0),i(this,"emitter",null),i(this,"rootDom",null),i(this,"rootVNode",void 0),i(this,"container",void 0),i(this,"uiConfig",{}),i(this,"popupUiConfig",[]);const{container:e,injection:n,postfix:s,uiConfig:o,emitter:r,popupUiConfig:a}=t;this.options=t,this.injection=n,this.uiConfig=o,this.popupUiConfig=a,this.parsedUiConfig=qw(o,a),this.emitter=r||Kn.create(),this.postfix=s||`-${Jn()}`,Gn(e)?this.container=document.getElementById(e):e instanceof HTMLElement&&(this.container=e),this.init();}static registerComponent(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(const[e,i]of Object.entries(t))Jw.isAlreadyRegistered(e)||(this.components[`DDV${e}`]=i,this.components[e]=i);}static isAlreadyRegistered(t){return !!this.components[t]}static getComponents(){return this.components}init(){const t=new Xw({data:this.parsedUiConfig,template:Yw(this.parsedUiConfig),components:Jw.getComponents(),injection:{...this.injection,components:Jw.getComponents(),postfix:this.postfix,emitter:this.emitter}}),e=t.parseHTML();if(!e)return;const i=e.renderDom();this.rootComponent=t,this.rootVNode=e,this.rootDom=i,this.container&&(this.container.appendChild(i),Uw(this.rootVNode));}updateUiConfig(t){const e=qw(t,this.popupUiConfig),i=new Xw({data:e,template:Yw(this.parsedUiConfig),components:Jw.getComponents(),injection:{...this.injection,components:Jw.getComponents(),postfix:this.postfix,emitter:this.emitter}}).parseHTML(),n=this.rootVNode.patch(i);return this.rootDom=n.el,this.rootVNode=n,this.uiConfig=t,Uw(this.rootVNode),!0}bindContainer(t){let e;if(Qn(t)&&(e=t),Gn(t)){const i=document.getElementById(t);Qn(i)&&(e=i);}return !!e&&(this.container=e,e.appendChild(this.rootDom),Uw(this.rootVNode),!0)}unbindContainer(){if(this.container&&0!==this.container.children.length){for(let t=0;t<this.container.children.length;t++)if(this.container.children[t]===this.rootDom)return void this.container.removeChild(this.rootDom);this.container=null;}}queryByDataId(t){var e;return null===(e=this.rootDom)||void 0===e?void 0:e.querySelector(`[data-id=${t}]`)}queryAllByDataId(t){var e;return null===(e=this.rootDom)||void 0===e?void 0:e.querySelectorAll(`[data-id=${t}]`)}getElementsByType(t,e){var i;const n=[];return (null===(i=t.cpInstance)||void 0===i||null===(i=i.constructor)||void 0===i?void 0:i.cpName)===e&&t.el&&n.push(t.el),t.children.length>0&&t.children.forEach((t=>{n.push(...this.getElementsByType(t,e));})),n}on(t,e){const i=this.emitter.on(t,e);this.uiEvents.push(i);}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];this.emitter.emit(t,...i);}off(t,e){this.emitter.off(t,e);}offAllEvents(){this.uiEvents.forEach((t=>{let{name:e,fn:i,context:n,once:s}=t;this.emitter.off(e,i,n,s);}));}dispose(){this.unbindContainer(),this.offAllEvents(),this.emitter=null,this.rootDom=null,this.uiConfig={},this.parsedUiConfig={},Lw(this.rootVNode);}}i(Jw,"components",{});class Zw extends Xw{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";super(t),i(this,"defaultClass","ddv-button"),this.initTemplate(e),this.bindBaseHooks();}bindBaseHooks(){this.hooks.inserted.on((t=>{this.bindEventsEmitter();}));}initTemplate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const{options:e}=this.data,i=""===t?this.defaultClass:`${this.defaultClass} ${t}`,n=`<button ${Gw(e,i)} >`+(_n(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+"<slot></slot></button>";this.template=n;}}class Qw extends Xw{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"row";super(t),i(this,"defaultClass","ddv-layout"),i(this,"enableScroll",!1),i(this,"showScrollArrow",!0),i(this,"scrollLeftOrTopBtn",void 0),i(this,"scrollRightOrBottomBtn",void 0);const{options:n}=this.data;this.enableScroll=(null==n?void 0:n.enableScroll)||!1,this.showScrollArrow=(null==n?void 0:n.showScrollArrow)||!0,this.initTemplate((null==n?void 0:n.flexDirection)||e),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{Kw(this),this.bindCustomScroll();})),this.hooks.updated.on((()=>{Kw(this);}));}bindCustomScroll(){if(!this.enableScroll)return;this.showScrollArrow&&this.initCustomScrollButton();const t=new ResizeObserver((()=>{this.showScrollArrow&&this.updateCustomScrollButton();}));t.observe(this.el),this.hooks.destroyed.on((()=>{t.disconnect();}));}initCustomScrollButton(){const t=document.createElement("button"),e=document.createElement("button"),i=150;this.nativeOn(t,"click",(()=>{const{scrollLeft:e,scrollTop:n}=this.el;t.classList.contains("ddv-scroll-top")?this.el.scroll(0,n-i):this.el.scroll(e-i,0);})),this.nativeOn(e,"click",(()=>{const{scrollLeft:t,scrollTop:n}=this.el;e.classList.contains("ddv-scroll-bottom")?this.el.scroll(0,n+i):this.el.scroll(t+i,0);})),this.nativeOn(this.el,"scroll",(t=>{this.showScrollArrow&&this.updateCustomScrollButton(),this.$emit("ui_layoutScroll",this.el);})),this.el.appendChild(t),this.el.appendChild(e),this.scrollLeftOrTopBtn=t,this.scrollRightOrBottomBtn=e,this.updateCustomScrollButton();}updateCustomScrollButton(){const{vertical:t,horizontal:e}=tb(this.el),{scrollLeft:i,scrollTop:n}=this.el,{scrollRightOrBottomBtn:s,scrollLeftOrTopBtn:o}=this;if(!o||!s)return;if(!t&&!e)return o.style.display="none",void(s.style.display="none");o.className="ddv-scroll-button "+(e?"ddv-scroll-left":"ddv-scroll-top"),s.className="ddv-scroll-button "+(e?"ddv-scroll-right":"ddv-scroll-bottom");const r=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{vertical:i,horizontal:n}=tb(t);if(!i&&!n)return [!1,!1];const{scrollLeft:s,scrollTop:o,scrollHeight:r,scrollWidth:a,clientWidth:l,clientHeight:h}=t;if(n)return [s<=e,s+l+e>=a];return [o<=e,o+h+e>=r]}(this.el,3);e?(o.style.left=`${i}px`,s.style.right=-i+"px"):(o.style.top=`${n}px`,s.style.bottom=-n+"px"),o.style.display=r[0]?"none":"",s.style.display=r[1]?"none":"";}initTemplate(t){const{options:e}=this.data,i=(null==e?void 0:e.children)||[],n="row"===t?"":"-col";let s=`${this.defaultClass}${n}`;this.enableScroll&&(s+=" ddv-custom-scroll-hidden");let o=`<div ${Gw(e,s)}>`;i&&i.length&&i.forEach(((t,e)=>{if(Wn(t)){const{type:i}=t;i.trim(),i.length>0&&(o+=`<${i} :options="options.children[${e}]"></${i}>`);}})),o+="</div>",this.template=o;}}function Kw(t){const{options:e}=t.data,i=t.el.children;((null==e?void 0:e.children)||[]).forEach(((e,n)=>{if(Qn(e)){const s=e;0===n?(t.el.append(s),t.el.insertBefore(s,i[0])):((t,e)=>{const i=e.parentNode;i.lastChild===e?i.appendChild(t):ys(t,e.nextSibling,i);})(s,i[n-1]);}}));}function tb(t){let e=t.scrollHeight>t.clientHeight,i=t.scrollWidth>t.clientWidth;if(e&&i){t.scrollHeight-t.clientHeight>t.scrollWidth-t.clientWidth?i=!1:e=!1;}return {vertical:e,horizontal:i}}class eb extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-root"),this.initTemplate(),this.bindHooks();}initTemplate(){const{options:t}=this.data,{children:e}=t,i="column"===t.flexDirection?`ddv-column ${this.defaultClass}`:this.defaultClass;let n=`<div ${Gw(t,i,"")} >`;e&&e.length&&e.forEach(((t,e)=>{if(Wn(t)){const{type:i}=t;i.trim(),i.length>0&&(n+=`<${i} :options="options.children[${e}]"></${i}>`);}})),n+="</div>",this.template=n;}bindHooks(){this.hooks.inserted.on((()=>{Kw(this);}));}}class ib extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-split-row"),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{this.updateClassName();})),this.hooks.updated.on((()=>{this.isInserted&&this.updateClassName();}));}updateClassName(){const t=this.el.parentNode,e=window.getComputedStyle(t),{flexDirection:i}=e;"column"===i&&(this.el.classList.remove(this.defaultClass),this.el.classList.add("ddv-split-column"));}initTemplate(){const{options:t}=this.data,e=Gw(t,this.defaultClass);this.template=`<div ${e}></div>`;}}class nb extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-swipe-indicator"),i(this,"touchStartY",0),i(this,"touchEndY",0),i(this,"isSwiping",!1),i(this,"swipeLever",1),i(this,"handleTouchStart",(t=>{1===t.touches.length&&(t.preventDefault(),this.touchStartY=t.touches[0].clientY,this.touchEndY=t.touches[0].clientY,this.isSwiping=!0);})),i(this,"handleTouchMove",(t=>{this.isSwiping&&(t.preventDefault(),this.touchEndY=t.touches[0].clientY);})),i(this,"handleTouchEnd",(()=>{if(!this.isSwiping)return;const t=this.touchEndY-this.touchStartY;Math.abs(t)<30||(t>0?this.updateContainer(!1):this.updateContainer(!0)),this.isSwiping=!1;})),this.initTemplate(),this.hooks.inserted.on((()=>{this.bindNativeEvents();})),this.$on("ui_swipeReset",(t=>{t===this.el.parentNode&&(this.swipeLever=1);}));}bindNativeEvents(){const{el:t}=this;t&&(t.parentNode&&(t.parentNode.style.transition="top 0.25s ease-in-out, height 0.25s ease-in-out"),t.addEventListener("touchstart",this.handleTouchStart),t.addEventListener("touchmove",this.handleTouchMove),t.addEventListener("touchend",this.handleTouchEnd));}updateContainer(t){const e=this.el.parentNode;if(e)if(t){if(0===this.swipeLever)return this.swipeLever=1,e.style.height="",e.style.top="",void this.$emit("ui_swipeChanged",e);1===this.swipeLever&&(this.swipeLever=2,e.style.height="100%",e.style.top="0px",this.$emit("ui_swipeChanged",e));}else {if(2===this.swipeLever)return this.swipeLever=1,e.style.height="",void(e.style.top="");if(1===this.swipeLever)return this.swipeLever=0,e.style.height="25%",void(e.style.top="75%");0===this.swipeLever&&(e.style.height="0px",e.style.top="100%",setTimeout((()=>{this.$emit("ui_swipeHide",e);}),300));}}initTemplate(){const{options:t}=this.data,e=`<div ${Gw(t,this.defaultClass)}><div class="${this.defaultClass}-line"></div></div>`;this.template=e;}}const sb={CameraResolution:"ddvCameraResolution",Capture:"ddvCapture",Flashlight:"ddvFlashlight",CameraConvert:"ddvCameraConvert",AutoDetect:"ddvAutoDetect",AutoCapture:"ddvAutoCapture",Rotate:"ddvRotate",RotateLeft:"ddvRotateLeft",RotateRight:"ddvRotateRight",Load:"ddvLoad",Delete:"ddvDelete",DeleteCurrent:"ddvDeleteCurrent",DeleteAll:"ddvDeleteAll",Zoom:"ddvZoom",ZoomIn:"ddvZoomIn",ZoomOut:"ddvZoomOut",ZoomByPercentage:"ddvZoomByPercentage",Crop:"ddvCrop",CropAll:"ddvCropAll",CropCurrent:"ddvCropCurrent",CropMode:"ddvCropMode",PerspectiveAll:"ddvPerspectiveAll",FullQuad:"ddvFullQuad",Undo:"ddvUndo",Redo:"ddvRedo",Restore:"ddvRestore",Pan:"ddvPan",Filter:"ddvFilter",Print:"ddvPrint",ThumbnailSwitch:"ddvThumbnailSwitch",DisplayMode:"ddvDisplayMode",ContinuousPage:"ddvContinuousPage",SinglePage:"ddvSinglePage",FitMode:"ddvFitMode",FitWidth:"ddvFitWidth",FitHeight:"ddvFitHeight",FitWindow:"ddvFitWindow",ActualSize:"ddvActualSize",Back:"ddvBack",Close:"ddvClose",Done:"ddvDone",Download:"ddvDownload",ImagePreview:"ddvImagePreview",FirstPage:"ddvFirstPage",LastPage:"ddvLastPage",NextPage:"ddvNextPage",PrevPage:"ddvPrevPage",FitMode_FitWidth:"ddvFitModeFitWidth",FitMode_FitHeight:"ddvFitModeFitHeight",FitMode_FitWindow:"ddvFitModeFitWindow",FitMode_ActualSize:"ddvFitModeActualSize",DisplayMode_SinglePage:"ddvDisplayModeSinglePage",DisplayMode_ContinuousPage:"ddvDisplayModeContinuousPage",Crop_CropAll:"ddvCropCropAll",Crop_CropCurrent:"ddvCropCropCurrent",Crop_CropCancel:"ddvCropCropCancel",Crop_CropApply:"ddvCropCropApply",Filter_FilterAll:"ddvFilterFilterAll",Delete_DeleteCurrent:"ddvDeleteDeleteCurrent",Delete_DeleteAll:"ddvDeleteDeleteAll",RectAnnotation:"ddvRect",EllipseAnnotation:"ddvEllipse",InkAnnotation:"ddvInk",PolygonAnnotation:"ddvPolygon",PolylineAnnotation:"ddvPolyline",LineAnnotation:"ddvLine",StampImageAnnotation:"ddvStampImage",StampIconAnnotation:"ddvStampIcon",TextTypewriterAnnotation:"ddvTypewriter",TextBoxAnnotation:"ddvTextBox",HighlightAnnotation:"ddvHighlight",StrikeoutAnnotation:"ddvStrikeout",UnderlineAnnotation:"ddvUnderline",EraseAnnotation:"ddvAnnotationEraser",SelectAnnotation:"ddvAnnotationSelect",SendBackward:"ddvSendBackward",SendToBack:"ddvSendToBack",BringToFront:"ddvBringToFront",BringForward:"ddvBringForward",AnnotationSet:"ddvAnnotationSet",TextSearchPanelSwitch:"ddvTextSearchPanelSwitch",TextSelectionMode:"ddvTextSelectionMode"},ob=["Arial","Courier","Helvetica","Times New Roman"],rb=function(){let t=0,e=0;return function(i){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t&&clearTimeout(t),s){const s=!t;t=setTimeout((()=>{e!==t&&(t=0,e=0,i());}),n),s&&(e=t,i());}else t=setTimeout((()=>{i(),t=0;}),n);}}();function ab(t,e,i){const n=n=>{const s=(parseFloat(n.value)-e)/(i-e)*100;t.style.backgroundSize=`${s}% 100%`;};n(t),t.oninput=e=>{n(t);},t.onchange=e=>{n(t);};}function lb(t,e){const{bottom:i,height:n}=t.parentNode.getBoundingClientRect(),{height:s}=t.getBoundingClientRect(),{bottom:o}=e.getBoundingClientRect();let r=n;return o-i<s&&(r=-s),r}function hb(t){t.$on("ui_hidePopup",(e=>{e!==t&&$n(null==t?void 0:t.togglePopup)&&(null==t||t.togglePopup(!1));}));}function cb(t){t.$on("ui_cropClick",(e=>{const{viewer:i}=t.injection,n=i.getPageCounts()||0;(e||n)&&ub(t.el,e);}));}function db(t){t.$on("ui_toolModeRefactor",(()=>{const{viewer:e}=t.injection,i=e.getPageCounts()||0,{toolMode:n}=e.context.viewerConfig;i&&ub(t.el,"annotation"===n||"crop"===n);}));}function ub(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!t)return;const{classList:i}=t,n=i.contains("ddv-button-disabled");e?n||t.classList.add("ddv-button-disabled"):n&&!e&&t.classList.remove("ddv-button-disabled");}function pb(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"base";if(!t)return;const{classList:n}=t;let s="ddv-button-activated";"deep"===i?s="ddv-button-activated-deep":"light"===i&&(s="ddv-button-activated-light");const o=n.contains(s);e?o||t.classList.add(s):t.classList.remove(s);}function gb(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const{left:o,right:r,bottom:a}=function(t,e){const i=(e||t.parentElement).getBoundingClientRect(),n=t.getBoundingClientRect(),s=n.top-i.top,o=i.right-n.right;return {top:s,bottom:i.bottom-n.bottom,left:n.left-i.left,right:o}}(e,t),{x:l,y:h,width:c}=t.getBoundingClientRect(),{height:d,width:u}=i.getBoundingClientRect(),{x:p,y:g,width:f,height:v}=e.getBoundingClientRect(),m=mr(getComputedStyle(t).borderWidth);let y=Math.floor(p)-Math.floor(l)-m.value;y<5&&(y=0);const x=c-u,w=y-(Math.floor(u)-Math.floor(f))/2,b=w<5?"0px":`${w}px`;let S=Math.floor(g)-Math.floor(h)-m.value;i.style.left=s&&r>u/2&&o>u/2?b:c<u+5?"0px":r>u?`${y}px`:o>u?y-(Math.floor(u)-Math.floor(f))+"px":r>u/2&&o>u/2?b:x<5?"0px":`${x}px`,a>d?(n&&(S+=2),i.style.top=S+Math.floor(v)-1+"px"):(n&&(S-=4),i.style.top=S-Math.floor(d)+"px");}function fb(t,e,i){const n=LC.getTooltip(),s=LC.getDisplayTextConfig(),o=sb;null!=i&&i.id||!(t in o)||(i.id=o[t]+e.postfix),null!=i&&i.tooltip||!(t in n)||(i.tooltip=n[t]),null!=i&&i.displayText&&(i.label=null==i?void 0:i.displayText),null!=i&&i.label||!(t in s)||(i.label=s[t]);}function vb(t){return (null==t?void 0:t.constructor.cpName)||""}function mb(t){const{value:e}=t,{fontSize:i,fontFamily:n,paddingLeft:s,paddingRight:o}=getComputedStyle(t),r=document.createElement("div");r.style.position="absolute",r.style.left="-9999px",r.style.top="-9999px",r.style.visibility="hidden",r.style.fontSize=i,r.style.fontFamily=n||"Arial, Helvetica, sans-serif",document.body.appendChild(r),r.textContent=e;const a=r.clientWidth+parseInt(s,10)+parseInt(o,10);return r.remove(),a}function yb(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.uiState!==e&&t.el&&(ub(t.el,"disabled"===e),function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!t)return;const{classList:i}=t,n=i.contains("ddv-button-focused");e?n||t.classList.add("ddv-button-focused"):t.classList.remove("ddv-button-focused");}(t.el,"focused"===e),i&&pb(t.el,"focused"===e,n?"deep":"base"),t.uiState=e);}function xb(t,e){let i=document.getElementById(`ddvMask${t.postfix}`);if(!i&&!e)return;if(i&&!e)return void i.remove();i||(i=document.createElement("div"),i.id=`ddvMask${t.postfix}`,i.className="ddv-mask");t.context.viewService.rootDom.appendChild(i);}class wb extends Zw{constructor(t,e){super(t,e.class),i(this,"callback",void 0),i(this,"uiState","normal"),i(this,"isFocused",!1),i(this,"isMenuButton",!1),this.callback=e.callback,this.bindHooks(),this.isMenuButton=t.data.menu||!1,"false"!==t.data.default&&this.bindDefaultUi();}bindEvent(){this.nativeOn(this.el,"click",(()=>{this.callback();}));}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup");}));}setUiState(t){yb(this,t,!(arguments.length>1&&void 0!==arguments[1])||arguments[1],this.isMenuButton);}bindDefaultUi(){const{viewer:t}=this.injection,e=t=>{let e=this.isFocused?"focused":"normal";(_n(null==t?void 0:t.pageCount)?this.injection.viewer.getPageCounts():t.pageCount)||(e="disabled"),this.setUiState(e,!jn());};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindHooks(){this.hooks.created.on((()=>{this.bindEvent(),this.bindHidePopup();})),this.hooks.updated.on((()=>{this.uiState="normal";}));}initTemplate(t){const e=this.data;e.options||(e.options={});const{options:i,id:n}=this.data;n&&(i.id=n),fb(vb(this),this.injection.viewer,i),"false"===e.default&&(i.label=void 0),super.initTemplate(t);}}class bb extends Xw{constructor(t){super(t),i(this,"uiState","normal"),i(this,"defaultClass",void 0),i(this,"pullDownBox",void 0),i(this,"isFirstClick",!0),this.bindViewerResized(),this.bindPopupSwitchEvent(),this.bindDefaultUi(),this.bindViewerHooks(),this.bindBaseHooks();}bindBaseHooks(){this.hooks.inserted.on((t=>{this.bindEventsEmitter();}));}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{pullDownBox:t}=this;if(!t)return;const e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:gb(i,this.el,this.pullDownBox);}),this);}bindPullDownBoxEvents(){this.nativeOn(this.el,"click",(()=>{if(this.togglePopup(),this.isFirstClick){gb(this.injection.viewer.rootDom,this.el,this.pullDownBox),this.isFirstClick=!1;}}));}bindPopupSwitchEvent(){hb(this);}bindDefaultUi(){const t=t=>{const e=(_n(null==t?void 0:t.pageCount)?this.injection.viewer.getPageCounts():t.pageCount)?"normal":"disabled";this.isFirstClick=!0,this.setUiState(e);};this.injection.viewer.hooks.pageExistenceChanged.on(t,this),this.hooks.inserted.on(t),this.hooks.updated.on(t);}initPullDownBox(){this.hooks.created.on((()=>{this.pullDownBox=this.query(`.${this.defaultClass}-box`),this.pullDownBox.style.display="none",this.pullDownBox.remove(),this.bindPullDownBoxEvents();})),this.hooks.updated.on((()=>{this.uiState="normal",this.pullDownBox.style.display="none",this.isFirstClick=!0;}));}bindViewerHooks(){this.injection.viewer.hooks.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}setUiState(t){yb(this,t);}togglePopup(t){const{pullDownBox:e}=this,{viewer:i}=this.injection;let n="none"===e.style.display;n=_n(t)?!n:!t,n?e.remove():(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e)),pb(this.el,!n),e.style.display=n?"none":"";}}class Sb extends bb{constructor(t){super(t),i(this,"lastSelectedIndex",0),i(this,"defaultClass","ddv-pdl"),i(this,"pullDownBoxClass","ddv-pull-down"),i(this,"children",[]),i(this,"hasCheckIcon",!1);const{defaultClassName:e,children:n,showCheckIcon:s}=t.data.options;e&&(this.defaultClass=e),this.pullDownBoxClass=`${this.defaultClass}-box ddv-pull-down`,this.children=n,this.hasCheckIcon=s,this.initPullDownBox(),this.initTemplate(),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}getChildrenTemplate(){let t="";return this.children.forEach(((e,i)=>{const{id:n,label:s}=e;e.id=void 0,e.label=void 0,t+=`<${e.type} :options="options.children[${i}]" default="false"id="${n?n+this.injection.viewer.postfix:""}" ><span>${s}</span>`+(this.hasCheckIcon?'<i class="ddv-button-ok" style="visibility: hidden"></i>':"")+`</${e.type}>`;})),t}selectChildren(t){if(!this.hasCheckIcon)return;const{pullDownBox:e}=this;if(-1!==t&&!e.childNodes[t])return;if(-1!==this.lastSelectedIndex){const t=e.children[this.lastSelectedIndex],i=t.getElementsByTagName("i")[0];t.classList.remove("ddv-pull-down-selected"),i.style.visibility="hidden";}if(-1===t)return void(this.lastSelectedIndex=-1);const i=e.children[t],n=i.getElementsByTagName("i")[0];i.classList.add("ddv-pull-down-selected"),n.style.visibility="visible",this.lastSelectedIndex=t;}initTemplate(){const t=this.data;t.options||(t.options={});const{options:e}=this.data,{pullDownBox:i,showDropDownArrow:n}=e;fb(vb(this),this.injection.viewer,e);const s=`<button ${Gw(e,`ddv-button ${this.defaultClass}`)}>`+(_n(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${Gw(i,this.pullDownBoxClass)}>`+`${this.getChildrenTemplate()}</div>`+`<i style="display: ${n?"":"none"}" class="ddv-down-arrow"></i></button>`;this.template=s;}}class Cb extends bb{constructor(t){super(t),i(this,"defaultClass","ddv-pdm"),i(this,"pullDownBoxClass","ddv-pull-down"),i(this,"children",[]);const{defaultClassName:e,children:n,enableScroll:s}=t.data.options;e&&(this.defaultClass=e),this.pullDownBoxClass=`${this.defaultClass}-box ddv-pull-down`,s&&(this.pullDownBoxClass+=jn()?" ddv-custom-scroll-hidden":" ddv-custom-scroll"),this.children=n,this.initPullDownBox(),this.initTemplate();}getChildrenTemplate(){let t="";return this.children.forEach(((e,i)=>{t+=`<${e.type} :options="options.children[${i}]" menu="true"></${e.type}>`;})),t}initTemplate(){const t=this.data;t.options||(t.options={});const{options:e}=this.data,{pullDownBox:i,showDropDownArrow:n}=e;fb(vb(this),this.injection.viewer,e);const s=`<button ${Gw(e,`ddv-button ${this.defaultClass}`)}>`+(_n(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${Gw(i,this.pullDownBoxClass)}>`+`${this.getChildrenTemplate()}</div>`+`<i style="display: ${n?"":"none"}" class="ddv-down-arrow"></i></button>`;this.template=s;}}class Pb extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;jn()&&this.el.classList.contains("ddv-button-focused")?t.updateViewerConfig({toolMode:"pan"}):(t.updateViewerConfig({toolMode:"annotation",annotationMode:e.annotationMode}),"stamp"===e.annotationMode&&t.updateAnnotationConfig({defaultStyleConfig:{stamp:{imageData:null,stampConfig:null}}}));}}),i(this,"annotationMode",void 0),this.annotationMode=e.annotationMode;}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ep.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig();t.getPageCounts()?"annotation"!==e?this.setUiState("normal"):i===this.annotationMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class Tb extends Pb{constructor(t){super(t,{class:"ddv-ellipse",annotationMode:"ellipse"});}}i(Tb,"cpName","EllipseAnnotation");class Ab extends Pb{constructor(t){super(t,{class:"ddv-annot-eraser",annotationMode:"erase"});}}i(Ab,"cpName","EraseAnnotation");class kb extends Pb{constructor(t){super(t,{class:"ddv-ink",annotationMode:"ink"});}}i(kb,"cpName","InkAnnotation");class Eb extends Pb{constructor(t){super(t,{class:"ddv-line",annotationMode:"line"});}}i(Eb,"cpName","LineAnnotation");class Db extends Pb{constructor(t){super(t,{class:"ddv-polygon",annotationMode:"polygon"});}}i(Db,"cpName","PolygonAnnotation");class Rb extends Pb{constructor(t){super(t,{class:"ddv-polyline",annotationMode:"polyline"});}}i(Rb,"cpName","PolylineAnnotation");class Ib extends Pb{constructor(t){super(t,{class:"ddv-rect",annotationMode:"rectangle"});}}i(Ib,"cpName","RectAnnotation");class Mb extends Pb{constructor(t){super(t,{class:"ddv-annot-select",annotationMode:"select"});}}i(Mb,"cpName","SelectAnnotation");class Bb extends Pb{constructor(t){super(t,{class:"ddv-stamp-icon",annotationMode:"stamp"});}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ep.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig(),n=t.getPageCounts(),{defaultStyleConfig:s}=t.getAnnotationConfig(),{stamp:o}=s,r=null==o?void 0:o.imageData;n?"annotation"!==e||"stamp"!==i||r?this.setUiState("normal"):this.setUiState("focused"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),t.hooks.annotationDefaultStyleChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(Bb,"cpName","StampIconAnnotation");class Ub extends wb{constructor(t){super(t,{class:"ddv-stamp-image",callback:()=>{this.annotationImageLoader.value=null,delete this.annotationImageLoader.files,jn()&&this.el.classList.contains("ddv-button-focused")?this.injection.viewer.updateViewerConfig({toolMode:"pan"}):(this.injection.viewer.updateViewerConfig({toolMode:"pan"}),this.injection.viewer.selectAnnotations([]),this.annotationImageLoader.click());}}),i(this,"annotationImageLoader",void 0);}createAnnotationImageLoaderInput(){const t=document.createElement("input");return t.accept="image/png,image/jpeg,image/bmp",t.type="file",this.nativeOn(t,"change",(()=>{const{files:e}=t,i=new Blob([e[0]],{type:e[0].type});["image/png","image/jpeg","image/bmp"].includes(e[0].type)&&(this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{imageData:i}}}),t.value=null,t.files=null,this.injection.viewer.updateViewerConfig({toolMode:"annotation",annotationMode:"stamp"}));})),t}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindHooks(){super.bindHooks(),this.hooks.inserted.on((()=>{const t=this.createAnnotationImageLoaderInput();t.style.display="none",this.el.appendChild(t),this.annotationImageLoader=t,this.nativeOn(t,"click",(t=>{t.stopPropagation();}));}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ep.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig(),n=t.getPageCounts(),{defaultStyleConfig:s}=t.getAnnotationConfig(),{stamp:o}=s,r=null==o?void 0:o.imageData;n?"annotation"!==e?this.setUiState("normal"):"stamp"===i&&r?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),t.hooks.annotationDefaultStyleChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(Ub,"cpName","StampImageAnnotation");class Lb extends Pb{constructor(t){super(t,{class:"ddv-text-box",annotationMode:"textBox"});}}i(Lb,"cpName","TextBoxAnnotation");class Ob extends Pb{constructor(t){super(t,{class:"ddv-typewriter",annotationMode:"textTypewriter"});}}i(Ob,"cpName","TextTypewriterAnnotation");class Wb extends Pb{constructor(t){super(t,{class:"ddv-highlight-mode",annotationMode:"highlight"});}}i(Wb,"cpName","HighlightAnnotation");class Nb extends Pb{constructor(t){super(t,{class:"ddv-underline-mode",annotationMode:"underline"});}}i(Nb,"cpName","UnderlineAnnotation");class _b extends Pb{constructor(t){super(t,{class:"ddv-strikeout-mode",annotationMode:"strikeout"});}}i(_b,"cpName","StrikeoutAnnotation");class Fb extends Cb{constructor(t){const{AnnotationSet:e}=LC.getDisplayTextConfig(),i=t.data;i.options={children:[{type:"SelectAnnotation"},{type:"EraseAnnotation"},{type:"SeparatorLine"},{type:"HighlightAnnotation"},{type:"UnderlineAnnotation"},{type:"StrikeoutAnnotation"},{type:"TextTypewriterAnnotation"},{type:"TextBoxAnnotation"},{type:"SeparatorLine"},{type:"StampIconAnnotation"},{type:"StampImageAnnotation"},{type:"SeparatorLine"},{type:"InkAnnotation"},{type:"RectAnnotation"},{type:"EllipseAnnotation"},{type:"PolygonAnnotation"},{type:"PolylineAnnotation"},{type:"LineAnnotation"},{type:"SeparatorLine"},{type:"BringForward"},{type:"BringToFront"},{type:"SendBackward"},{type:"SendToBack"}],defaultClassName:"ddv-annotation-mode",label:e,enableScroll:!0,showDropDownArrow:!0,...i.options},super(t),this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts()||0;(t||i)&&Ep.annotationLicenseModuleIsExist()&&ub(this.el,t);}));}bindDefaultUi(){Ep.annotationLicenseModuleIsExist()?(super.bindDefaultUi(),this.hooks.inserted.on((t=>{const{toolMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getPageCounts();"annotation"===e&&i>0&&this.setUiState("focused");}))):this.hooks.inserted.on((t=>{this.setUiState("disabled");}));}togglePopup(t){if((!0!==t||""!==this.pullDownBox.style.display)&&(!1!==t||"none"!==this.pullDownBox.style.display)&&(super.togglePopup(t),""===this.pullDownBox.style.display&&Hb(this.pullDownBox).horizontal)){this.pullDownBox.style.justifyContent="start";let t=0;for(let e=0;e<this.pullDownBox.children.length;e++){const i=this.pullDownBox.children[e];i.classList.contains("ddv-button-focused")&&(t=i.offsetLeft+i.clientWidth/2-this.pullDownBox.clientWidth/2);}this.pullDownBox.scroll(t,0);}}bindPopupSwitchEvent(){this.$on("ui_hidePopup",(t=>{if(t===this||"viewer"===t||t===Fb.cpName)return;const{toolMode:e}=this.injection.viewer.getViewerConfig();"annotation"!==e&&this.togglePopup(!1);}));}bindViewerHooks(){if(!Ep.annotationLicenseModuleIsExist())return;const t=this.injection.viewer;t.hooks.resize.on((()=>{Hb(this.pullDownBox).horizontal?this.pullDownBox.style.justifyContent="start":this.pullDownBox.style.justifyContent="";}),this),t.hooks.pageExistenceChanged.on((()=>{const{toolMode:e}=t.getViewerConfig();let i="disabled";t.getPageCounts()>0?(i="normal","annotation"===e&&(this.isFirstClick?(this.togglePopup(!1),this.el.click()):this.togglePopup(!0),i="focused")):this.togglePopup(!1),this.setUiState(i);}),this),t.hooks.toolModeChanged.on((e=>{if("crop"===e.newToolMode)return this.togglePopup(!1),void this.setUiState("disabled");const i="annotation"===e.newToolMode;t.getPageCounts()>0&&(this.setUiState(i?"focused":"normal"),pb(this.el,"none"!==this.pullDownBox.style.display),this.$emit("ui_annotationModeClick",i),this.$emit("ui_toolModeRefactor",i),i&&(this.isFirstClick?(this.togglePopup(!1),this.el.click()):this.togglePopup(!0)));}),this);}setUiState(t){super.setUiState(t);}}function Hb(t){return {vertical:t.scrollHeight>t.clientHeight,horizontal:t.scrollWidth>t.clientWidth}}i(Fb,"cpName","AnnotationSet");class Vb extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection,e=t.getSelectedAnnotations();if(1!==e.length)return;const i=e[0].uid;switch(this.layerType){case"bringForward":t.bringForward(i);break;case"bringToFront":t.bringToFront(i);break;case"sendBackward":t.sendBackward(i);break;case"sendToBack":t.sendToBack(i);}}}),i(this,"layerType",void 0),this.layerType=e.layerType;}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindDefaultUi(){const t=this.injection.viewer,e=Ep.annotationLicenseModuleIsExist(),i=()=>{if(!e)return void this.setUiState("disabled");const{viewer:i}=this.injection,n=i.getSelectedAnnotations();t.getPageCounts()&&1===n.length?this.setUiState("normal"):this.setUiState("disabled");};t.hooks.annotationLayerStateChanged.on((i=>{let{state:n}=i;if(!e)return void this.setUiState("disabled");const s=t.getSelectedAnnotations();if(!s.length||s.length>1)return void this.setUiState("disabled");const o=t.getAnnotationObject(s[0].uid);if(o&&!o.context.isActive)return void this.setUiState("disabled");let r=!1;switch(this.layerType){case"bringForward":r=n.forward;break;case"bringToFront":r=n.front;break;case"sendBackward":r=n.backward;break;case"sendToBack":r=n.back;}this.setUiState(r?"normal":"disabled");}),this),t.hooks.pageExistenceChanged.on(i,this),this.hooks.inserted.on(i),this.hooks.updated.on(i);}}class zb extends Vb{constructor(t){super(t,{class:"ddv-bring-forward",layerType:"bringForward"});}}i(zb,"cpName","BringForward");class $b extends Vb{constructor(t){super(t,{class:"ddv-bring-to-front",layerType:"bringToFront"});}}i($b,"cpName","BringToFront");class jb extends Vb{constructor(t){super(t,{class:"ddv-send-backward",layerType:"sendBackward"});}}i(jb,"cpName","SendBackward");class Xb extends Vb{constructor(t){super(t,{class:"ddv-send-to-back",layerType:"sendToBack"});}}i(Xb,"cpName","SendToBack");class Gb extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-annotation-toolbar"),i(this,"lastAnnotation",void 0),i(this,"toolbarOffset",20),i(this,"toolbarType",void 0),i(this,"updateToolBarPosition",(()=>{if("text"===this.toolbarType)return void this.togglePopup(!1);if(!this.lastAnnotation)return;const{viewer:t}=this.injection,e=t.getActiveTab();if(e&&"single"===e.context.displayMode&&this.lastAnnotation.pageUid!==e.getCurrentPage().uid)return;this.setToolbarType("annotation");const{show:i,x:n,y:s}=qb(t.context.viewService.mainContainer,this.lastAnnotation,this.el,this.toolbarOffset);this.togglePopup(i,n,s);})),this.bindHooks(),this.initTemplate(),this.bindViewerHooks(),this.$on("ui_toolbarToggle",(()=>{this.togglePopup();}));}bindHooks(){const t=t=>{this.el.style.display="none",this.setToolbarType("annotation");};this.hooks.inserted.on(t),this.hooks.updated.on(t),this.hooks.destroyed.on((()=>{this.el.remove();}));}bindViewerHooks(){const{viewer:t}=this.injection;t.hooks.visibleChanged.on((()=>{this.togglePopup(!1);}),this),t.hooks.pageExistenceChanged.on((t=>{0===t.pageCount&&(this.togglePopup(!1),this.lastAnnotation=null);}),this),t.hooks.pageChanged.on((()=>{const e=t.getActiveTab();if(!e||"single"!==e.context.displayMode)return;const i=t.getSelectedAnnotations();if(1!==i.length)return;const n=i[0].pageUid===e.getCurrentPage().uid;this.togglePopup(n);}),this),t.hooks.resize.on(this.updateToolBarPosition,this),t.hooks.scroll.on(this.updateToolBarPosition,this),t.hooks.fitModeChanged.on(this.updateToolBarPosition,this),t.hooks.displayModeChanged.on(this.updateToolBarPosition,this),t.hooks.zoomChanged.on(this.updateToolBarPosition,this),this.bindViewerAnnotationHooks(),this.bindViewerTextSelectedHooks();}bindViewerAnnotationHooks(){const{viewer:t}=this.injection;if(t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return this.togglePopup(!1),void(this.lastAnnotation=null);const i=e.newAnnotationUids[0],n=t.getAnnotationObject(i);if(!n)return;this.setToolbarType("annotation");const{show:s,x:o,y:r}=qb(t.context.viewService.mainContainer,n,this.el,this.toolbarOffset);this.togglePopup(s,o,r),this.lastAnnotation=n;}),this),t.hooks.beforeAnnotationEdit.on((()=>{this.togglePopup(!1);}),this),t.hooks.afterAnnotationEdit.on((e=>{if(e instanceof wh)return;this.setToolbarType("annotation");const{show:i,x:n,y:s}=qb(t.context.viewService.mainContainer,e,this.el,this.toolbarOffset);this.lastAnnotation=e,this.togglePopup(i,n,s);}),this),t.hooks.annotationsUpdated.on(this.updateToolBarPosition,this),t.hooks.annotationTextContentUpdated.on(this.updateToolBarPosition,this),null!=t&&t.annotationViewerContext){const{annotationViewerContext:e}=t,{hooks:i}=e.annotationController;i.enableAnnotationTextEditMode.on(this.updateToolBarPosition,this),i.disableAnnotationTextEditMode.on(this.updateToolBarPosition,this);}}bindViewerTextSelectedHooks(){const{viewer:t}=this.injection;t.hooks.textSelected.on((e=>{const i=t.context.textSelectionService.getTextSelectionControlPointsRect();if(i.length){const n=t.getActiveTab();let s=[i[1],i[0]];if(1===e.detail.length){180===n.getPageByUid(e.detail[0].pageUid).getRotation()&&(s=[i[0],i[1]]);}this.setToolbarType("text");let{show:o,x:r,y:a}=Yb(t.context.viewService.mainContainer,s,this.el,this.toolbarOffset);if(!o){const e=Yb(t.context.viewService.mainContainer,s,this.el,this.toolbarOffset);o=e.show,r=e.x,a=e.y;}this.togglePopup(o,r,a);}else "text"===this.toolbarType&&this.togglePopup(!1);}),this),t.hooks.beforeTextSelected.on((()=>{this.togglePopup(!1);}),this);}togglePopup(t,e,i){const{viewer:n}=this.injection;if(!t)return void(this.el.style.display="none");n.context.viewService.mainContainer.appendChild(this.el),this.el.style.display="",this.el.style.left=`${e||0}px`,this.el.style.top=`${i||0}px`;}setToolbarType(t){var e,i,n,s,o,r;const{options:a}=this.data;this.toolbarType=t;const l={highlight:this.el.querySelector(".ddv-highlight-mode"),strikeout:this.el.querySelector(".ddv-strikeout-mode"),underline:this.el.querySelector(".ddv-underline-mode"),copyText:this.el.querySelector(".ddv-copy-text"),palette:this.el.querySelector(".ddv-palette"),delete:this.el.querySelector(".ddv-delete-annot")},h={highlight:"none"===(null===(e=a.highlightButton)||void 0===e||null===(e=e.style)||void 0===e?void 0:e.display),strikeout:"none"===(null===(i=a.strikeoutButton)||void 0===i||null===(i=i.style)||void 0===i?void 0:i.display),underline:"none"===(null===(n=a.underlineButton)||void 0===n||null===(n=n.style)||void 0===n?void 0:n.display),copyText:"none"===(null===(s=a.copyButton)||void 0===s||null===(s=s.style)||void 0===s?void 0:s.display),palette:"none"===(null===(o=a.paletteButton)||void 0===o||null===(o=o.style)||void 0===o?void 0:o.display),delete:"none"===(null===(r=a.deleteButton)||void 0===r||null===(r=r.style)||void 0===r?void 0:r.display)};["copyText","highlight","strikeout","underline"].forEach((e=>{!h[e]&&l[e]&&(l[e].style.display="text"===t?"":"none");})),["palette","delete"].forEach((e=>{!h[e]&&l[e]&&(l[e].style.display="annotation"===t?"":"none");})),this.toolbarOffset="text"===t?10:20;}initTemplate(){const{options:t}=this.data;fb(vb(this),this.injection.viewer,t);let e=`<div ${Gw(t,this.defaultClass,"")}>`;null!=t&&t.isPaletteEnabled&&(e+='<AnnotationPaletteButton :options="options.paletteButton"></AnnotationPaletteButton>'),e+='<TextCopyButton :options="options.copyButton"></TextCopyButton>',e+='<HighlightCreateButton :options="options.highlightButton"></HighlightCreateButton>',e+='<UnderlineCreateButton :options="options.underlineButton"></UnderlineCreateButton>',e+='<StrikeoutCreateButton :options="options.strikeoutButton"></StrikeoutCreateButton>',e+='<AnnotationDeleteButton :options="options.deleteButton"></AnnotationDeleteButton></div>',this.template=e;}}function Yb(t,e,i,n){i.style.display="flex";const{width:s,height:o}=t.getBoundingClientRect(),r=getComputedStyle(i),a=mr(r.width).value,l=mr(r.height).value;i.style.display="none";const h=function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return {left:t.left+t.width/2-a/2,top:e?t.top-n-l:t.top+t.height+n}},{left:c,top:d}=h(e[0]);if(c>=0&&d>=0&&c+a<=s&&d+l<=o)return {show:!0,x:c,y:d};const{left:u,top:p}=h(e[1],!0),g=u>=0&&p>=0&&u+a<=s&&p+l<=o;return {show:!0,x:g?u:Math.max(0,Math.min(s-a,c)),y:g?p:Math.max(0,Math.min(o-l,d))}}function qb(t,e,i,n){i.style.display="flex";const{width:s,height:o}=t.getBoundingClientRect(),r=e.context.getRealTimeBoundingBox(),a=getComputedStyle(i),l=mr(a.width).value,h=mr(a.height).value;if(i.style.display="none",r.right<0||r.left>s||r.top>o||r.bottom<0)return {show:!1,x:0,y:0};const c=r.left+r.width/2-l/2;let d=r.bottom+n;return d+h>o&&(d=r.top-h-n),d<0&&(d=0),{show:!0,x:c,y:d}}i(Gb,"cpName","AnnotationToolBar");class Jb extends wb{constructor(t){super(t,{class:"ddv-palette",callback:()=>{this.$emit("ui_changePalette_visible","AnnotationPalette");}}),cb(this);}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet"),this.focusTexture();}));}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.focusTexture();}}}i(Jb,"cpName","AnnotationPaletteButton");class Zb extends wb{constructor(t){super(t,{class:"ddv-delete-annot",callback:()=>{const{viewer:t}=this.injection,e=t.getSelectedAnnotations(),i=[];e.forEach((t=>{i.push(t.uid);})),t.deleteAnnotations(i);}}),cb(this);}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{viewer:e}=this.injection,i=e.getSelectedAnnotations();t.getPageCounts()&&i.length?this.setUiState("normal"):this.setUiState("disabled");};t.hooks.selectedAnnotationsChanged.on(e,this),t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(Zb,"cpName","AnnotationDeleteButton");class Qb extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-color-panel"),i(this,"colorList",void 0),i(this,"enableChangeColor",void 0),i(this,"paletteType",void 0),i(this,"colorInput",void 0),i(this,"selectedColorButton",void 0),i(this,"lastUpdatedAnnotation",void 0),i(this,"lastInputColor",void 0),i(this,"lastTextContents",void 0),i(this,"lastPaletteType",void 0),i(this,"dblClickButtons",[]),this.colorList=t.data.colorList,this.enableChangeColor=t.data.enableChangeColor,this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stamp"===t?"none":"",this.paletteType=t,this.showNoFill("fill"===t),this.updateButtonSelected();}));}bindHooks(){this.hooks.inserted.on((()=>{const t=document.createElement("input");t.type="color",this.colorInput=t,this.el.appendChild(this.colorInput),this.bindEvents(),this.bindColorInputEvents();}));}bindEvents(){const t=this.el.querySelector(".ddv-palette-color-grid");this.nativeOn(t,"click",(t=>{const e=t.target;if(!(e instanceof HTMLButtonElement))return;this.dblClickButtons.push(e),this.dblClickButtons.length>2&&this.dblClickButtons.shift();if(e.classList.contains("ddv-color-selected"))return;const i=e.value,{viewer:n}=this.injection;if(""===i)this.colorInput.focus(),this.colorInput.click(),this.selectedColorButton=e;else {const t=n.getSelectedAnnotations();1===t.length&&this.updateColorByData(t[0],i),this.updateDefaultColor(i);}})),this.nativeOn(t,"dblclick",(t=>{if(!this.enableChangeColor)return;const e=t.target;if(!(e instanceof HTMLButtonElement))return;if(2===this.dblClickButtons.length&&this.dblClickButtons[0]!==this.dblClickButtons[1])return;const i=e.value;"transparent"!==i&&""!==i&&(this.colorInput.value=i,jn()&&this.colorInput.focus(),this.colorInput.click(),this.selectedColorButton=e);}));}bindColorInputEvents(){this.nativeOn(this.colorInput,"input",(t=>{rb((()=>{const{viewer:t}=this.injection,e=this.colorInput.value;this.selectedColorButton.classList.contains("ddv-add-color")&&this.addColor();this.selectedColorButton.children[0].style.background=e,this.selectedColorButton.value=e;1===t.getSelectedAnnotations().length&&this.updateColorByShape(e),this.updateDefaultColor(e),this.selectedColor(e);}),60);})),this.nativeOn(this.colorInput,"change",(t=>{this.lastUpdatedAnnotation&&(this.updateColorByData(this.lastUpdatedAnnotation,this.lastInputColor,this.lastPaletteType),this.lastUpdatedAnnotation=null,this.lastInputColor=null,this.lastPaletteType=null);}));}bindViewerHooks(){const t=this.injection.viewer;t.hooks.selectedAnnotationsChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationsUpdated.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationModeChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationTextCharsSelected.on((t=>{const e=t.freeTextContentStyle,{color:i}=e;"text"===this.paletteType?this.selectedColor(i):this.updateButtonSelected();}),this);}updateColorByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid),n=i instanceof $h,s=i instanceof xh;if("fill"===this.paletteType||"textAssist"===this.paletteType&&n)i.style.background=t;else if(["stroke","textAssist"].includes(this.paletteType))i.style.borderColor=t;else if("text"===this.paletteType&&s){if(i.hasSelectedChars){const e=th(i,{color:t});i.style.textContents=e,i.textEditEventHandler.updateTextSelection();}else {if(i.isEditMode)return void this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[e[0].type]:{textContent:{color:t}}}});{const e=Kl(i,{color:t});e.length&&(i.style.textContents=e);}}this.lastTextContents=i.style.textContents;}this.lastUpdatedAnnotation=e[0],this.lastInputColor=t,this.lastPaletteType=this.paletteType,this.injection.viewer.context.render("ColorPanel");}updateColorByData(t,e,i){const{viewer:n}=this.injection,{uid:s}=t,o={},r=this.injection.viewer.getAnnotationObject(s),a=i||this.paletteType;if("text"===a&&r instanceof xh){if(r.hasSelectedChars){const t=th(r,{color:e});o.textContents=t;}else {if(r.isEditMode)return void this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[t.type]:{textContent:{color:e}}}});{const t=Kl(r,{color:e});t.length&&(o.textContents=t);}}return this.lastTextContents&&(o.textContents=this.lastTextContents,this.lastTextContents=null),n.updateAnnotation(s,{style:o},["appearanceChanged"]),void(r.hasSelectedChars&&r.textEditEventHandler.updateTextSelection())}"fill"===a?o.background="transparent"===e?"":e:"stroke"===a?o.borderColor=e:"textAssist"===a&&(r instanceof $h?o.background=e:o.borderColor=e),n.updateAnnotation(s,{style:o},["appearanceChanged"]);}updateDefaultColor(t,e){const{annotationMode:i}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations();let s=i;n.length&&n[0]&&(s=n[0].type);const o={};switch(e||this.paletteType){case"fill":o.background=t;break;case"textAssist":"highlight"===i?o.background=t:o.borderColor=t;break;case"stroke":o.borderColor=t;break;case"text":o.textContent={},o.textContent.color=t;}this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[s]:o}});}selectedColor(t){const e=this.el.querySelector(".ddv-palette-color-grid").getElementsByTagName("button");for(let i=0;i<e.length;i++){const n=e[i];if(!n.value)continue;const s=kr(n.value),o=kr(t);s.formatted===o.formatted?n.classList.add("ddv-color-selected"):n.classList.contains("ddv-color-selected")&&n.classList.remove("ddv-color-selected");}}updateButtonSelected(){const{viewer:t}=this.injection,e=t.getSelectedAnnotations();if(1===e.length){let n=null;const s="highlight"===e[0].type;if("fill"===this.paletteType||"textAssist"===this.paletteType&&s)n=e[0].style.background||"transparent";else if(["stroke","textAssist"].includes(this.paletteType))n=e[0].style.borderColor||"transparent";else if("text"===this.paletteType){const s=t.getAnnotationObject(e[0].uid);var i;if(s instanceof xh)n=(null===(i=e[0].style)||void 0===i||null===(i=i.textContents[0])||void 0===i?void 0:i.color)||"transparent";s instanceof xh&&(s.isEditMode||!s.style.textContents.length)&&(n=s.freeTextContentStyle.color);}return void(n&&this.selectedColor(n))}const{toolMode:n,annotationMode:s}=t.getViewerConfig();if("annotation"===n&&"select"!==s&&"erase"!==s){const{defaultStyleConfig:e}=t.getAnnotationConfig(),{background:i,borderColor:n,textContent:l}=oh,h="highlight"===s;let c=null;var o;if("fill"===this.paletteType||"textAssist"===this.paletteType&&h)c=(null===(o=e[s])||void 0===o?void 0:o.background)||i||"transparent";else if("stroke"===this.paletteType||"textAssist"===this.paletteType){var r;c=(null===(r=e[s])||void 0===r?void 0:r.borderColor)||n||"transparent";}else if("text"===this.paletteType){var a;c=(null===(a=e[s])||void 0===a||null===(a=a.textContent)||void 0===a?void 0:a.color)||(null==l?void 0:l.color)||"transparent";}c&&this.selectedColor(c);}}getColorTemplate(){const t=document.createElement("div");let e="<div>",i=0;for(let n=0;n<this.colorList.length;n++){const s=this.colorList[n];if(t.style.background=s,""!==t.style.background){if(i>26)break;i+=1,e+=`<button value="${s}"><div style="background:${s}"></div></button>`,0!==i&&i%7==0&&(e+="</div><div>"),t.style.background="";}}const n=i>26?0:27-i;for(let t=0;t<n;t++)e+=0===t?'<button value="" class="ddv-add-color"><div></div></button>':'<button value="" class="ddv-color-placeholder"><div></div></button>',(i+t+1)%7==0&&(e+="</div><div>");return e+='<button value="transparent" class="ddv-color-transparent"><div></div></button>',e+="</div>",t.remove(),e}showNoFill(t){this.el.querySelectorAll(".ddv-color-transparent").forEach((e=>{e.style.visibility=t?"":"hidden",e.style.pointerEvents=t?"":"none";}));}addColor(){const t=this.el.querySelector(".ddv-palette-color-grid"),e=t.querySelector(".ddv-add-color"),i=t.querySelector(".ddv-color-placeholder");e&&e.classList.remove("ddv-add-color"),i&&(i.classList.remove("ddv-color-placeholder"),i.classList.add("ddv-add-color"));}initTemplate(){const t=`<div class="${this.defaultClass}"><div class="ddv-palette-color-grid">${this.getColorTemplate()}</div></div>`;this.template=t;}}const Kb=ko.displayResolution/ko.dataResolution;class tS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-font-panel"),i(this,"fontFamilyEl",void 0),i(this,"fontSizeEl",void 0),i(this,"fontList",[...ob]),i(this,"inputIsBlur",!0),i(this,"currentFontSizeValue",void 0),i(this,"isArrowKeyPressed",!1),i(this,"maxFontSize",72),this.maxFontSize=t.data.maxFontSize,this.maxFontSize<72&&(this.maxFontSize=72),this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_shrinkSelectionBox",(t=>{"fontFamily"!==t&&this.toggleSelect("fontFamily",!1),"fontSize"!==t&&this.toggleSelect("fontSize",!1);})),this.$on("ui_changePalette_type",(t=>{this.el.style.display="text"===t?"":"none";})),this.$on("ui_addFont",(t=>{this.addFont(t);}));}updateTextStyle(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{toolMode:i,annotationMode:n}=this.injection.viewer.getViewerConfig(),s=this.injection.viewer.getSelectedAnnotations();if(1!==s.length||"textTypewriter"!==s[0].type&&"textBox"!==s[0].type)"annotation"!==i||"textBox"!==n&&"textTypewriter"!==n||this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:{textContent:t}}});else {const{uid:e,type:i}=s[0],n=this.injection.viewer.getAnnotationObject(e);if(n.isEditMode)n.hasSelectedChars&&(this.injection.viewer.updateAnnotation(e,{style:{textContents:th(n,t)}},["appearanceChanged"]),n.textEditEventHandler.updateTextSelection());else {const i=Kl(n,t);i.length&&this.injection.viewer.updateAnnotation(e,{style:{textContents:i}},["appearanceChanged"]);}this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[i]:{textContent:t}}});}e&&this.focusTexture();}bindHooks(){this.hooks.created.on((()=>{this.fontFamilyEl=this.el.querySelector(".ddv-palette-font-family"),this.fontSizeEl=this.el.querySelector(".ddv-palette-font-size");})),this.hooks.inserted.on((()=>{this.bindToggleEvent(),this.bindSelectEvent(),this.bindFontSizeInputEvent(),this.bindTextAlignEvents(),this.bineFontStyleEvents();}));}bindToggleEvent(){const t=this.fontSizeEl.querySelector(".ddv-down-arrow");Ys(this.fontFamilyEl,"click",this).on((t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","fontFamily"),this.toggleSelect("fontFamily");}),this),Ys(t,"click",this).on((t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","fontSize"),this.toggleSelect("fontSize");}),this);}bindSelectEvent(){const t=this.fontFamilyEl.querySelector(".ddv-palette-font-family-select"),e=this.fontSizeEl.querySelector(".ddv-palette-font-size-select"),i=this.fontSizeEl.getElementsByTagName("input")[0],n=this.fontFamilyEl.getElementsByTagName("span")[0];this.nativeOn(t,"click",(t=>{t.stopPropagation(),this.toggleSelect("fontFamily",!1);const e=t.target.value;e&&n.innerText!==e&&this.updateTextStyle({fontFamily:e});})),this.nativeOn(e,"click",(t=>{t.stopPropagation(),this.toggleSelect("fontSize",!1);const e=t.target.value,n=`${e}pt`===i.value;e&&!n&&this.updateTextStyle({fontSize:mr(e).value*Kb});}));}bindFontSizeInputEvent(){const t=this.fontSizeEl.getElementsByTagName("input")[0];this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){let e=Math.round(mr(t.value).value);e>this.maxFontSize&&(e=this.maxFontSize,t.value=`${this.maxFontSize}`),e<1&&(e=1,t.value="1"),this.updateTextStyle({fontSize:e*Kb},!1),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(()=>{const e=t.value,i=mr(e).value;t.value=i,t.type="number",this.inputIsBlur=!1,this.currentFontSizeValue=i,this.$emit("ui_shrinkSelectionBox");})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,"text"!==t.type&&(this.currentFontSizeValue=t.value,t.type="text",t.value+="pt",e.relatedTarget instanceof HTMLInputElement||this.focusTexture());}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="pt",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);let i=Math.round(mr(t.value).value);i>this.maxFontSize&&(i=this.maxFontSize),i<1&&(i=1),this.updateTextStyle({fontSize:i*Kb});};this.nativeOn(t,"change",e);}bindTextAlignEvents(){const t=this.el.querySelector(".ddv-align-left"),e=this.el.querySelector(".ddv-align-center"),i=this.el.querySelector(".ddv-align-right"),n=this.el.querySelector(".ddv-justify-center"),s=t=>{const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations();if(1!==n.length||"textTypewriter"!==n[0].type&&"textBox"!==n[0].type)"annotation"!==e||"textBox"!==i&&"textTypewriter"!==i||this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[i]:{textAlign:t}}});else {if(t===n[0].style.textAlign)return;this.injection.viewer.updateAnnotation(n[0].uid,{style:{textAlign:t}},["appearanceChanged"]);}};this.nativeOn(t,"click",(()=>{s("left");})),this.nativeOn(e,"click",(()=>{s("center");})),this.nativeOn(i,"click",(()=>{s("right");})),this.nativeOn(n,"click",(()=>{s("justify");}));}bineFontStyleEvents(){const t=this.el.querySelector(".ddv-bold"),e=this.el.querySelector(".ddv-italic"),i=this.el.querySelector(".ddv-underline"),n=this.el.querySelector(".ddv-line-through");this.nativeOn(t,"click",(e=>{this.updateTextStyle({fontWeight:t.classList.contains("ddv-button-activated-light")?"normal":"bold"});})),this.nativeOn(e,"click",(t=>{this.updateTextStyle({fontStyle:e.classList.contains("ddv-button-activated-light")?"normal":"italic"});})),this.nativeOn(i,"click",(t=>{this.updateTextStyle({underline:!i.classList.contains("ddv-button-activated-light")});})),this.nativeOn(n,"click",(t=>{this.updateTextStyle({lineThrough:!n.classList.contains("ddv-button-activated-light")});}));}bindViewerHooks(){const{viewer:t}=this.injection;t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];if("textTypewriter"!==i.type&&"textBox"!==i.type)return;this.showTextAlignList("textBox"===i.type),this.selectTextAlign(i.style.textAlign||"left");const{defaultStyleConfig:n}=this.injection.viewer.getAnnotationConfig(),{textContent:s}=n[i.type],o=i.style.textContents.length?i.style.textContents[0]:s,{fontFamily:r,fontSize:a,fontWeight:l,fontStyle:h,underline:c,lineThrough:d}=o;this.selectFontStyle(r,Math.round(mr(a).value/Kb),"bold"===l,"italic"===h,c,d);}),this),t.hooks.annotationDefaultStyleChanged.on((t=>{const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations();let s,o,r=!1;if("annotation"!==e||"textBox"!==i&&"textTypewriter"!==i||(r=!0,s=i),1===n.length){const t=this.injection.viewer.getAnnotationObject(n[0].uid);t instanceof xh&&(s=n[0].type,o=n[0].style.textAlign,t.isEditMode&&!t.hasSelectedChars?r=!0:t.isEditMode||t.style.textContents.length?(this.selectTextAlign(o),r=!1):r=!0);}if(!r)return;const{textAlign:a}=t[s],{fontFamily:l,fontSize:h,fontWeight:c,fontStyle:d,underline:u,lineThrough:p}=t[s].textContent||{},{textContent:g}=oh;this.selectTextAlign(o||a||oh.textAlign),this.selectFontStyle(l||g.fontFamily,Math.round(mr(h||g.fontSize).value/Kb),"bold"===(c||g.fontWeight),"italic"===(d||g.fontStyle),u||g.underline,p||g.lineThrough);}),this),t.hooks.annotationTextCharsSelected.on((t=>{const e=t.freeTextContentStyle,{fontFamily:i,fontSize:n,fontStyle:s,fontWeight:o,underline:r,lineThrough:a}=e;this.selectFontStyle(i,Math.round(mr(n).value/Kb),"bold"===o,"italic"===s,r,a);}),this),t.hooks.annotationsUpdated.on((t=>{const{actions:e,uids:i}=t,n=this.injection.viewer.getSelectedAnnotations();if(!e.includes("appearanceChanged")||1!==n.length||!i.includes(n[0].uid))return;if("textTypewriter"!==n[0].type&&"textBox"!==n[0].type)return;this.selectTextAlign(n[0].style.textAlign||"left");if(!this.injection.viewer.getAnnotationObject(n[0].uid).isEditMode&&n[0].style.textContents.length){const{fontFamily:t,fontSize:e,fontWeight:i,fontStyle:s,underline:o,lineThrough:r}=n[0].style.textContents[0];this.selectFontStyle(t,Math.round(mr(e).value/Kb),"bold"===i,"italic"===s,o,r);}}),this);const e=t=>{if(["textBox","textTypewriter"].includes(t)){this.showTextAlignList("textBox"===t);const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),{textContent:i,textAlign:n}=e[t],{fontFamily:s,fontSize:o,fontWeight:r,fontStyle:a,underline:l,lineThrough:h}=i;this.selectTextAlign(n),this.selectFontStyle(s,Math.round(mr(o).value/Kb),"bold"===r,"italic"===a,l,h);}};t.hooks.annotationModeChanged.on((i=>{t.getSelectedAnnotations().length||e(i.newAnnotationMode);}),this),t.hooks.toolModeChanged.on((i=>{if("annotation"!==i.newToolMode)return;const{annotationMode:n}=t.getViewerConfig();e(n);}),this);}toggleSelect(t,e){const i="fontFamily"===t?"ddv-palette-font-family-select":"ddv-palette-font-size-select",n="fontFamily"===t?this.fontFamilyEl:this.fontSizeEl,s=n.querySelector(`.${i}`),o=n.querySelector(".ddv-down-arrow"),r="none"!==s.style.display,a=_n(e)?!r:e,l=this.injection.viewer.context.viewService.mainContainer;r!==a&&(a?(s.style.display="block",s.style.top=`${lb(s,l)}px`,o.style.transform="rotate(180deg)","fontSize"===t&&this.scrollFontSizeSelect()):(s.style.display="none",o.style.transform=""));}getFontFamilySelectTemplate(){let t="";for(let e=0;e<ob.length;e++){const i=ob[e];t+=`<button style="font-family:${i}" value="${i}">${i}</button>`;}return `<div class="ddv-palette-font-family"><span>Helvetica</span><i class="ddv-down-arrow"></i><div class="ddv-palette-font-family-select" style="display: none;">${t}</div></div>`}getFontSizeTemplate(){let t="";for(let e=1;e<=12;e++)t+=`<button value="${e}">${e}pt</button>`;for(let e=14;e<=36;e+=2)t+=`<button value="${e}">${e}pt</button>`;for(let e=40;e<=72;e+=4)t+=`<button value="${e}">${e}pt</button>`;if(this.maxFontSize>72){let e=72;for(;e+8<this.maxFontSize;)e+=8,t+=`<button value="${e}">${e}pt</button>`;t+=`<button value="${this.maxFontSize}">${this.maxFontSize}pt</button>`;}return `<div class="ddv-palette-font-size"><input type="string"/><i class="ddv-down-arrow"></i><div class="ddv-palette-font-size-select" style="display: none;">${t}</div></div>`}selectTextAlign(t){const e=this.el.querySelector(".ddv-align-left"),i=this.el.querySelector(".ddv-align-center"),n=this.el.querySelector(".ddv-align-right"),s=this.el.querySelector(".ddv-justify-center");pb(e,"left"===t,"light"),pb(i,"center"===t,"light"),pb(n,"right"===t,"light"),pb(s,"justify"===t,"light");}selectFontStyle(t,e,i,n,s,o){const r=this.fontFamilyEl.getElementsByTagName("span")[0],a=this.fontSizeEl.getElementsByTagName("input")[0],l=this.el.querySelector(".ddv-bold"),h=this.el.querySelector(".ddv-italic"),c=this.el.querySelector(".ddv-underline"),d=this.el.querySelector(".ddv-line-through");r.innerText=t,this.isArrowKeyPressed||("number"===a.type&&(a.type="text"),this.currentFontSizeValue=e,a.value=`${e}pt`),pb(l,i,"light"),pb(h,n,"light"),pb(c,s,"light"),pb(d,o,"light");}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.focusTexture();}}addFont(t){if(this.fontList.includes(t))return;this.fontList.push(t);const e=this.fontFamilyEl.querySelector(".ddv-palette-font-family-select"),i=document.createElement("button");i.style.fontFamily=t,i.value=t,i.innerText=t,e.appendChild(i);}showTextAlignList(t){const e=this.el.querySelector(".ddv-text-align-list");e&&(e.style.display=t?"":"none");}scrollFontSizeSelect(){if(!this.fontSizeEl)return;const t=this.fontSizeEl.querySelector(".ddv-palette-font-size-select"),{currentFontSizeValue:e}=this;let i=0;for(let n=0;n<t.children.length;n++){const s=t.children[n];if(!(e>=s.value))break;i=s.offsetTop;}t.scrollTo(0,i);}initTemplate(){const t=`<div class="${this.defaultClass}"><div style="display:flex; justify-content: space-between; position:relative; z-index:2">${this.getFontFamilySelectTemplate()}${this.getFontSizeTemplate()}</div><div><div class="ddv-button ddv-bold"></div><div class="ddv-button ddv-italic"></div><div class="ddv-button ddv-underline"></div><div class="ddv-button ddv-line-through"></div></div><div class="ddv-text-align-list"><div class="ddv-button ddv-align-left"></div><div class="ddv-button ddv-align-center"></div><div class="ddv-button ddv-align-right"></div><div class="ddv-button ddv-justify-center"></div></div></div>`;this.template=t;}}const eS=["None","ClosedArrow","OpenArrow","ROpenArrow","RClosedArrow","Butt","Circle","Diamond","Square","Slash"],iS=[[0,0],[3,3],[5,5],[7,7],[7,6,3,6],[5,4,21,4],[11,5,5,5]],nS={None:"ddv-solid",OpenArrow:"ddv-line-open",ROpenArrow:"ddv-line-r-open",ClosedArrow:"ddv-line-closed",RClosedArrow:"ddv-line-r-closed",Butt:"ddv-line-butt",Square:"ddv-line-square",Diamond:"ddv-line-diamond",Circle:"ddv-line-circle",Slash:"ddv-line-slash"},sS={33:"ddv-dashed-33",55:"ddv-dashed-55",77:"ddv-dashed-77",7636:"ddv-dashed-7636",54214:"ddv-dashed-54214",11555:"ddv-dashed-11555"};class oS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-line-panel"),i(this,"commonClass","ddv-palette-line-panel-common"),i(this,"LineStyleClass","ddv-palette-border-style"),i(this,"lineStyleClassSmall","ddv-palette-border-style-small"),i(this,"startLineEndingClass","ddv-palette-line-start"),i(this,"endLineEndingClass","ddv-palette-line-end"),i(this,"selectionClass","ddv-palette-line-panel-selection"),i(this,"startLineEndingSelect",void 0),i(this,"borderStyleSelect",void 0),i(this,"endLineEndingSelect",void 0),i(this,"isStrokePalette",void 0),this.bindHooks(),this.initTemplate(),this.$on("ui_shrinkSelectionBox",(t=>{"lineEndingStart"!==t&&this.toggleSelect(0,!1),"borderStyle"!==t&&this.toggleSelect(1,!1),"lineEndingEnd"!==t&&this.toggleSelect(2,!1);})),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stroke"===t?"":"none",this.isStrokePalette="stroke"===t;const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations();("annotation"===e&&"ink"===i||1===n.length&&"ink"===n[0].type)&&(this.el.style.display="none");}));}bindHooks(){this.hooks.inserted.on((()=>{const t=this.el.querySelectorAll(`.${this.commonClass}`);this.startLineEndingSelect=t[0],this.borderStyleSelect=t[1],this.endLineEndingSelect=t[2],this.bindViewerHooks(),this.bindToggleEvent(),this.bindSelectEvent();}));}bindSelectEvent(){const t=this.startLineEndingSelect.querySelector(`.${this.selectionClass}`),e=this.borderStyleSelect.querySelector(`.${this.selectionClass}`),i=this.endLineEndingSelect.querySelector(`.${this.selectionClass}`),n=(t,e)=>{const i=e.target,n="BUTTON"===i.tagName?i:i.parentNode;return Array.from(t.childNodes).indexOf(n)||0};this.nativeOn(t,"click",(e=>{const i=n(t,e),s=eS[i]||"None";this.updateLineEndingByData(!0,s),this.updateDefaultLineEnding(!0,s);})),this.nativeOn(e,"click",(t=>{const i=n(e,t),s=iS[i]||[0,0];this.updateLineDashByData(s),this.updateDefaultLineDash(s);})),this.nativeOn(i,"click",(t=>{const e=n(i,t),s=eS[e]||"None";this.updateLineEndingByData(!1,s),this.updateDefaultLineEnding(!1,s);}));}bindToggleEvent(){this.nativeOn(this.startLineEndingSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","lineEndingStart"),this.toggleSelect(0);})),this.nativeOn(this.borderStyleSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","borderStyle"),this.toggleSelect(1);})),this.nativeOn(this.endLineEndingSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","lineEndingEnd"),this.toggleSelect(2);}));}bindViewerHooks(){const t=this.injection.viewer,e=(t,e,i,n)=>{if(this.startLineEndingSelect.style.display=t?"":"none",this.endLineEndingSelect.style.display=t?"":"none",this.borderStyleSelect.classList.remove(t?this.LineStyleClass:this.lineStyleClassSmall),this.borderStyleSelect.classList.add(t?this.lineStyleClassSmall:this.LineStyleClass),t){const[t,e]=i;this.updateLineEndingSelect(!0,nS[t]||"ddv-solid"),this.updateLineEndingSelect(!1,nS[e]||"ddv-solid");}this.el.style.display=n||!this.isStrokePalette?"none":"",this.updateBorderStyleSelect(e||[0,0]);};t.hooks.selectedAnnotationsChanged.on((i=>{var n,s;if(1!==i.newAnnotationUids.length)return;const o=t.getSelectedAnnotations()[0];if(!o)return;const r="line"===o.type||"polyline"===o.type;e(r,null===(n=o.style)||void 0===n?void 0:n.lineDash,null===(s=o.style)||void 0===s?void 0:s.lineEnding,"ink"===o.type||"stamp"===o.type);}),this),t.hooks.annotationModeChanged.on((t=>{const i=t.newAnnotationMode,n="polyline"===i||"line"===i,s="ink"===i;if("select"!==i&&"erase"!==i&&"stamp"!==i){var o,r;const{defaultStyleConfig:t}=this.injection.viewer.getAnnotationConfig(),a=(null===(o=t[i])||void 0===o?void 0:o.lineEnding)||(null==oh?void 0:oh.lineEnding),l=(null===(r=t[i])||void 0===r?void 0:r.lineDash)||(null==oh?void 0:oh.lineDash);e(n,l,a,s);}}),this),t.hooks.annotationDefaultStyleChanged.on((i=>{var n;const{toolMode:s,annotationMode:o}=this.injection.viewer.getViewerConfig();if("annotation"!==s)return;if("select"===o||"erase"===o||"stamp"===o)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:r}=this.injection.viewer.getAnnotationConfig(),a="line"===o||"polyline"===o,l="ink"===o,h=(null===(n=r[o])||void 0===n?void 0:n.lineEnding)||oh.lineEnding,c=r[o].lineDash||oh.lineDash;e(a,c,h,l);}),this),t.hooks.annotationsUpdated.on((i=>{const{actions:n,uids:s}=i,o=t.getSelectedAnnotations();if(!n.includes("appearanceChanged")||1!==o.length||!s.includes(o[0].uid))return;if("ink"===o[0].type||"stamp"===o[0].type)return;const r="line"===o[0].type||"polyline"===o[0].type,a=o[0].style.lineEnding||["None","None"],l=o[0].style.lineDash||[0,0];e(r,l,a,!1);}),this);}toggleSelect(t,e){let i=this.borderStyleSelect;0===t?i=this.startLineEndingSelect:2===t&&(i=this.endLineEndingSelect);const n=i.querySelector(`.${this.selectionClass}`),s=i.querySelector(".ddv-down-arrow"),o="none"!==n.style.display,r=_n(e)?!o:e,a=this.injection.viewer.context.viewService.mainContainer;o!==r&&(r?(n.style.display="block",n.style.top=`${lb(n,a)}px`,s.style.transform="rotate(180deg)"):(n.style.display="none",s.style.transform=""));}updateLineEndingSelect(t,e){(t?this.startLineEndingSelect:this.endLineEndingSelect).querySelector("div").className=`ddv-button ${e}`;}updateBorderStyleSelect(t){const e=this.borderStyleSelect,i=t.join("")||"0",n=e.querySelector("div");let s="ddv-solid";((function(t){if(0===t.length)return !0;if(1===t.length)return 0===t[0];t.length%2!=0&&(t=t.concat(t));for(let e=1;e<t.length;e+=2)if(0!==t[e])return !1;return !0}))(t)||(s=sS[i]||"ddv-dashed-33"),n.className=`ddv-button ${s}`;}updateLineDashByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;(e[0].style.lineDash||[0,0]).toString()!==t.toString()&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{lineDash:t}},["appearanceChanged"]);}updateLineEndingByData(t,e){const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const n=i[0].style.lineEnding||["None","None"];t&&e===n[0]||!t&&e===n[1]||this.injection.viewer.updateAnnotation(i[0].uid,{style:{lineEnding:t?[e,n[1]]:[n[0],e]}},["appearanceChanged"]);}updateDefaultLineEnding(t,e){var i;const{annotationMode:n}=this.injection.viewer.getViewerConfig(),s=this.injection.viewer.getSelectedAnnotations(),{defaultStyleConfig:o}=this.injection.viewer.getAnnotationConfig();let r=(null===(i=o[n])||void 0===i?void 0:i.lineEnding)||oh.lineEnding,a=n;s.length&&s[0]&&(r=s[0].style.lineEnding,a=s[0].type);const l=[...r];t?l[0]=e:l[1]=e,this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[a]:{lineEnding:l}}});}updateDefaultLineDash(t){const{annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let n=e;i.length&&i[0]&&(n=i[0].type),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:{lineDash:t}}});}getBaseLineDashTemplate(){const t=["ddv-solid","ddv-dashed-33","ddv-dashed-55","ddv-dashed-77","ddv-dashed-7636","ddv-dashed-54214","ddv-dashed-11555"];let e="";for(let i=0;i<t.length;i++){e+=`<button><i class="ddv-button ${t[i]}"></i></button>`;}return `<div class="${this.commonClass} ${this.lineStyleClassSmall}"><div class="ddv-button ddv-solid"></div><i class="ddv-down-arrow"></i><div style="display:none;" class="${this.selectionClass}" >${e}</div></div>`}getLineEndingTemplate(t){const e=["ddv-solid","ddv-line-closed","ddv-line-open","ddv-line-r-open","ddv-line-r-closed","ddv-line-butt","ddv-line-circle","ddv-line-diamond","ddv-line-square","ddv-line-slash"];let i="";for(let t=0;t<e.length;t++){i+=`<button><i class="ddv-button ${e[t]}"></i></button>`;}const n=t?this.startLineEndingClass:this.endLineEndingClass;return `<div class="${this.commonClass} ${n}"><div class="ddv-button ddv-solid"></div><i class="ddv-down-arrow"></i><div style="display:none;" class="${this.selectionClass}" >${i}</div></div>`}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div style="margin-top:10px">${this.getLineEndingTemplate(!0)}${this.getBaseLineDashTemplate()}${this.getLineEndingTemplate(!1)}</div></div>`;this.template=e;}}class rS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-opacity-panel"),i(this,"isPointerDown",!1),i(this,"lastPointerValue",void 0),i(this,"range",void 0),i(this,"input",void 0),i(this,"inputIsBlur",!0),i(this,"isArrowKeyPressed",!1),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{this.range=this.el.querySelector(".ddv-palette-opacity-range"),this.input=this.el.querySelector(".ddv-palette-opacity-input"),ab(this.range,0,100),this.bindViewerHooks(),this.bindRangeEvent(),this.bineInputEvent();}));}bineInputEvent(){const{input:t}=this;this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){const e=yr(t.value).value;e>100&&(t.value=100),e<0&&(t.value=0);let i=parseInt(t.value,10);Xn(i)||(i=100,this.updateInput(100)),this.updateDefaultOpacity(i),this.updateOpacityByData(i),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(e=>{const i=t.value,n=yr(i).value;t.value=n,t.type="number",this.inputIsBlur=!1;})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,e.relatedTarget instanceof HTMLInputElement||this.focusTexture(),"text"!==t.type&&(t.type="text",t.value+="%");}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="%",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);const i=yr(t.value).value;i>100&&(t.value=100),i<0&&(t.value=0);let n=parseInt(t.value,10);Xn(n)||(n=100,this.updateInput(100)),this.updateDefaultOpacity(n),this.updateOpacityByData(n);};this.nativeOn(t,"change",e);}bindRangeEvent(){const{range:t}=this,e=()=>{const e=parseInt(t.value,10);this.updateOpacityByShape(e),this.input.value=`${e}%`;const{toolMode:i,annotationMode:n}=this.injection.viewer.getViewerConfig();"annotation"===i&&"select"!==n&&"erase"!==n&&this.updateInput(e);};this.nativeOn(t,"click",(()=>{const e=parseInt(t.value,10);this.injection.viewer.context.isFocusCanvas=!1,e!==this.lastPointerValue&&(this.updateOpacityByData(e),this.updateDefaultOpacity(e));})),this.nativeOn(t,"pointerdown",(t=>{t.stopPropagation(),this.isPointerDown=!0,this.injection.viewer.context.isFocusCanvas=!1,this.$emit("ui_shrinkSelectionBox");const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const n=this.injection.viewer.getAnnotationObject(i[0].uid);n instanceof xh&&n.isEditMode&&(n.textEditEventHandler.disableEditMode(),this.injection.viewer.render("OpacityPanel")),e();})),this.nativeOn(t,"pointermove",(()=>{this.isPointerDown&&e();})),this.nativeOn(t,"pointerup",(()=>{if(this.isPointerDown){const e=parseInt(t.value,10);this.lastPointerValue=e,this.updateOpacityByData(e),this.updateDefaultOpacity(e);}this.isPointerDown=!1;})),this.nativeOn(t,"keydown",(t=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&e();})),this.nativeOn(t,"keyup",(e=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){const e=parseInt(t.value,10);this.updateOpacityByData(e),this.updateDefaultOpacity(e);}}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{annotationMode:t}=this.injection.viewer.getViewerConfig();if("select"===t||"erase"===t)return;const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),i=Xn(e[t].opacity)?e[t].opacity:oh.opacity;this.updateInput(Math.round(100*i));};t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];i&&this.updateInput(Math.round(100*i.style.opacity));}),this),t.hooks.annotationsUpdated.on((e=>{const{actions:i,uids:n}=e,s=t.getSelectedAnnotations();i.includes("appearanceChanged")&&1===s.length&&n.includes(s[0].uid)&&this.updateInput(Math.round(100*s[0].style.opacity));}),this),t.hooks.annotationModeChanged.on((t=>{e();}),this),t.hooks.toolModeChanged.on((t=>{"annotation"===t.newToolMode&&e();}),this),t.hooks.annotationDefaultStyleChanged.on((e=>{const{toolMode:i,annotationMode:n}=this.injection.viewer.getViewerConfig();if("annotation"!==i)return;if("select"===n||"erase"===n)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:s}=this.injection.viewer.getAnnotationConfig(),o=Xn(s[n].opacity)?s[n].opacity:oh.opacity;this.updateInput(100*o);}),this);}updateInput(t){let e=t;t>100&&(e=100),t<0&&(e=0),e=Math.round(e),this.range.value=`${e}`,this.range.dispatchEvent(new Event("change")),this.input.value="number"===this.input.type?e:`${e}%`;}updateOpacityByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid);if(!i)return;const n=100*i.style.opacity;(t=Math.round(t))!==n&&(i.style.opacity=t/100,this.injection.viewer.context.render("OpacityPanel"));}updateOpacityByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=100*e[0].style.opacity;(t=Math.round(t))!==i&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{opacity:t/100}},["appearanceChanged"]);}updateDefaultOpacity(t){const{annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let n=e;i.length&&i[0]&&(n=i[0].type),t=Math.round(t),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:{opacity:t/100}}});}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div class="ddv-palette-opacity-range-container"><input class="ddv-palette-opacity-range" type="range" min="0" max="100" value="100"/><input class="ddv-palette-opacity-input" type="string" value="100%"/></div></div>`;this.template=e;}}const aS=[ih.DRAFT,ih.FINAL,ih.VOID,ih.REJECTED,ih.ACCEPTED,ih.APPROVED,ih.NOT_APPROVED,ih.COMPLETED,ih.CONFIDENTIAL,ih.INITIAL_HERE,ih.SIGN_HERE,ih.WITNESS];class lS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-stamp-panel"),i(this,"select",void 0),i(this,"selectBox",void 0),i(this,"iconName",ih.DRAFT),i(this,"enableCustomStamp",!1),i(this,"customStampSelect",void 0),i(this,"customStampSelectBox",void 0),i(this,"customStampList",[]),this.enableCustomStamp=t.data.enableCustomStamp,this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_shrinkSelectionBox",(t=>{"stampIcon"!==t&&this.toggleSelect(!1,!1),this.enableCustomStamp&&"customStamp"!==t&&this.toggleSelect(!0,!1);}));}bindHooks(){this.hooks.inserted.on((()=>{this.select=this.el.querySelector(".ddv-palette-stamp-icon"),this.selectBox=this.el.querySelector(".ddv-palette-stamp-icon-select"),this.enableCustomStamp&&(this.customStampSelect=this.el.querySelector(".ddv-palette-custom-stamp"),this.customStampSelectBox=this.el.querySelector(".ddv-palette-custom-stamp-select")),this.bindToggleEvent(),this.bindSelectEvent(),this.bindCreateCustomStampEvent();}));}bindToggleEvent(){this.nativeOn(this.select,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","stampIcon"),this.toggleSelect(!1);})),this.enableCustomStamp&&this.nativeOn(this.customStampSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","customStamp"),this.toggleSelect(!0);}));}bindSelectEvent(){this.nativeOn(this.selectBox,"click",(t=>{const e=t.target.value;this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampIcon:e,stampConfig:null}}});})),this.nativeOn(this.selectBox,"pointermove",(t=>{t.stopPropagation();}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{var e;const{toolMode:i,annotationMode:n}=t.getViewerConfig(),s=t.getAnnotationConfig();"annotation"!==i||"stamp"!==n||null!==(e=s.defaultStyleConfig)&&void 0!==e&&null!==(e=e.stamp)&&void 0!==e&&e.imageData?this.el.style.display="none":this.el.style.display="";};this.hooks.inserted.on((()=>{e();const{defaultStyleConfig:i}=t.getAnnotationConfig(),{stamp:n}=i,s=(null==n?void 0:n.stampIcon)||(null==oh?void 0:oh.stampIcon);this.updateStampSpan(s);})),t.hooks.annotationDefaultStyleChanged.on((t=>{e();const{stamp:i}=t,n=(null==i?void 0:i.stampIcon)||(null==oh?void 0:oh.stampIcon);(null==i?void 0:i.stampConfig)?this.updateStampSpan("SBCustom Stamp"):n!==this.iconName&&this.updateStampSpan(n);}),this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this);}toggleSelect(t,e){const i=t?this.customStampSelect:this.select,n=t?this.customStampSelectBox:this.selectBox,s=i.querySelector(".ddv-down-arrow"),o="none"!==n.style.display,r=_n(e)?!o:e,a=this.injection.viewer.context.viewService.mainContainer;o!==r&&(r?(n.style.display="block",n.style.top=`${lb(n,a)}px`,s.style.transform="rotate(180deg)"):(n.style.display="none",s.style.transform=""));}updateStampSpan(t){this.el.getElementsByTagName("span")[1].innerText=t.slice(2),this.iconName=t;}getStampIconSelectTemplate(){let t="";for(let e=0;e<aS.length;e++){const i=aS[e];t+=`<button value="${i}">${i.slice(2)}</button>`;}return `<div class="ddv-palette-stamp-icon"><span>${ih.DRAFT.slice(2)}</span><i class="ddv-down-arrow"></i><div class="ddv-palette-stamp-icon-select" style="display: none;">${t}</div></div>${this.getCustomStampTemplate()}`}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span>${this.getStampIconSelectTemplate()}</div>`;this.template=e;}bindCreateCustomStampEvent(){if(!this.enableCustomStamp)return;const t=this.customStampSelectBox.querySelector(".ddv-palette-custom-stamp-button");this.nativeOn(t,"click",(()=>{xb(this.injection.viewer,!0),this.$emit("ui_changePalette_visible","AnnotationCustomStampPanel",!0);})),this.$on("ui_customStampCreated",(t=>{const{stampConfig:e,stampImage:i}=t,n=URL.createObjectURL(i),s={stampConfig:Nn(e),imgUrl:n};this.customStampList.push(s),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampConfig:s.stampConfig}}}),this.addCustomStamp(s);})),this.nativeOn(this.customStampSelectBox,"click",(t=>{const e=t.target;if(e instanceof HTMLImageElement){const t=ms(e.parentElement),{stampConfig:i}=this.customStampList[t-1];this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampConfig:i}}});}if("i"===e.tagName.toLocaleLowerCase()){t.stopPropagation();const i=ms(e.parentElement),{imgUrl:n}=this.customStampList[i-1];URL.revokeObjectURL(n),e.parentElement.remove(),this.customStampList.splice(i-1,1);}}));}getCustomStampTemplate(){if(!this.enableCustomStamp)return "";return '<div class="ddv-palette-custom-stamp"><span>Custom Stamp</span><i class="ddv-down-arrow"></i><div class="ddv-palette-custom-stamp-select" style="display: none;"><div><button class="ddv-palette-custom-stamp-button">Create New Stamp</button></div></div></div>'}addCustomStamp(t){const e=document.createElement("div");e.className="ddv-palette-custom-stamp-item";const i=document.createElement("img");i.src=t.imgUrl,i.draggable=!1,e.appendChild(i);const n=document.createElement("i");n.className="ddv-button ddv-delete-annot",e.appendChild(n),this.customStampSelectBox.appendChild(e);}}const hS=ko.displayResolution/ko.dataResolution;class cS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-stroke-panel"),i(this,"isPointerDown",!1),i(this,"lastPointerValue",void 0),i(this,"range",void 0),i(this,"input",void 0),i(this,"inputIsBlur",!0),i(this,"isArrowKeyPressed",!1),i(this,"maxBorderWidth",20),this.maxBorderWidth=t.data.maxBorderWidth,this.maxBorderWidth<20&&(this.maxBorderWidth=20),this.initTemplate(),this.bindHooks(),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stroke"===t?"":"none";}));}bindHooks(){this.hooks.inserted.on((()=>{this.range=this.el.querySelector(".ddv-palette-stroke-range"),this.input=this.el.querySelector(".ddv-palette-stroke-input"),ab(this.range,0,this.maxBorderWidth),this.bindViewerHooks(),this.bindRangeEvent(),this.bineInputEvent();}));}bineInputEvent(){const{input:t}=this;this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){const e=mr(t.value).value;e>this.maxBorderWidth&&(t.value=this.maxBorderWidth),e<0&&(t.value=0);let i=parseInt(t.value,10);Xn(i)||(i=1,this.updateInput(1*hS)),this.updateDefaultBorderWidth(i),this.updateBorderWidthByData(i),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(e=>{const i=t.value,n=parseFloat(i);t.value=n,t.type="number",this.inputIsBlur=!1;})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,e.relatedTarget instanceof HTMLInputElement||this.focusTexture(),"text"!==t.type&&(t.type="text",t.value+="pt");}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="pt",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);const i=mr(t.value).value;i>this.maxBorderWidth&&(t.value=this.maxBorderWidth),i<0&&(t.value=0);let n=parseInt(t.value,10);Xn(n)||(n=1,this.updateInput(1*hS)),this.updateDefaultBorderWidth(n),this.updateBorderWidthByData(n);};this.nativeOn(t,"change",e);}bindRangeEvent(){const{range:t}=this,e=()=>{const e=mr(t.value).value;this.updateBorderWidthByShape(e),this.input.value=`${e}pt`;const{toolMode:i,annotationMode:n}=this.injection.viewer.getViewerConfig();"annotation"===i&&"select"!==n&&"erase"!==n&&this.updateInput(e*hS);};this.nativeOn(t,"click",(()=>{const e=mr(t.value).value;this.injection.viewer.context.isFocusCanvas=!1,e!==this.lastPointerValue&&(this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e));})),this.nativeOn(t,"pointerdown",(t=>{t.stopPropagation(),this.isPointerDown=!0,this.injection.viewer.context.isFocusCanvas=!1,this.$emit("ui_shrinkSelectionBox");const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const n=this.injection.viewer.getAnnotationObject(i[0].uid);n instanceof xh&&n.isEditMode&&(n.textEditEventHandler.disableEditMode(),this.injection.viewer.render("StrokePanel")),e();})),this.nativeOn(t,"pointermove",(()=>{this.isPointerDown&&e();})),this.nativeOn(t,"pointerup",(()=>{if(this.isPointerDown){const e=mr(t.value).value;this.lastPointerValue=e,this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e);}this.isPointerDown=!1;})),this.nativeOn(t,"keydown",(t=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&e();})),this.nativeOn(t,"keyup",(e=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){const e=mr(t.value).value;this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e);}}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{annotationMode:t}=this.injection.viewer.getViewerConfig();if("select"===t||"erase"===t)return;const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),i=Xn(e[t].borderWidth)?e[t].borderWidth:oh.borderWidth;this.updateInput(i);};t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];i&&this.updateInput(mr(i.style.borderWidth).value,!0);}),this),t.hooks.annotationsUpdated.on((e=>{const{actions:i,uids:n}=e,s=t.getSelectedAnnotations();i.includes("appearanceChanged")&&1===s.length&&n.includes(s[0].uid)&&this.updateInput(mr(s[0].style.borderWidth).value);}),this),t.hooks.annotationModeChanged.on((t=>{e();}),this),t.hooks.toolModeChanged.on((t=>{"annotation"===t.newToolMode&&e();}),this),t.hooks.annotationDefaultStyleChanged.on((e=>{const{toolMode:i,annotationMode:n}=this.injection.viewer.getViewerConfig();if("annotation"!==i)return;if("select"===n||"erase"===n||"stamp"===n)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:s}=this.injection.viewer.getAnnotationConfig(),o=Xn(s[n].borderWidth)?s[n].borderWidth:oh.borderWidth;this.updateInput(o);}),this);}updateInput(t,e){let i=t/hS;this.isPointerDown||e?i=Math.round(i):(i=i.toFixed(1),i.endsWith(".0")&&(i=parseInt(i,10))),this.range.value=i,this.range.dispatchEvent(new Event("change")),this.input.value="number"===this.input.type?parseFloat(i):`${i}pt`;}updateBorderWidthByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid);if(!i)return;const n=t*hS,{borderWidth:s}=i.style;s!==n&&(i.style.borderWidth=n,this.injection.viewer.context.render("StrokePanel"));}updateBorderWidthByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=t*hS,{borderWidth:n}=e[0].style;n!==i&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{borderWidth:i}},["appearanceChanged"]);}updateDefaultBorderWidth(t){const{annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let n=e;i.length&&i[0]&&(n=i[0].type),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:{borderWidth:t*hS}}});}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div><input class="ddv-palette-stroke-range" type="range" min="0" max="${this.maxBorderWidth}" value="0"/><input class="ddv-palette-stroke-input" type="string" value="0pt"/></div></div>`;this.template=e;}}class dS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-palette-box"),i(this,"header",void 0),i(this,"fillSpan",void 0),i(this,"textSpan",void 0),i(this,"strokeSpan",void 0),i(this,"thumbnail",void 0),Jw.registerComponent({ColorPanel:Qb,FontPanel:tS,LinePanel:oS,StampPanel:lS,OpacityPanel:rS,StrokePanel:cS}),this.bindHooks(),this.initTemplate(),this.bindViewerHooks(),this.$on("ui_changePalette_visible",((t,e)=>{t===dS.cpName&&this.togglePopup(e);})),this.injection.viewer.on("thumbnailBind",(t=>{if(this.thumbnail)return;const e=this.injection.viewer.context.core.getViewer(t);e&&(this.thumbnail=e,this.bindThumbnailHooks());}));}bindHooks(){const t=t=>{this.header=this.el.querySelector(`.${this.defaultClass}-header`);const e=this.header.getElementsByTagName("span");this.textSpan=e[0],this.strokeSpan=e[1],this.fillSpan=e[2],this.bindEvents();this.injection.viewer.context.viewService.mainContainer.appendChild(this.el);const{enableDrag:i}=this.data.options;this.el.dataset.enableDrag=`${i}`,function(t){let e,i,n=!1;function s(s){if(!n)return;const o=s.clientX-e,r=s.clientY-i;t.style.left=`${t.offsetLeft+o}px`,t.style.top=`${t.offsetTop+r}px`,e=s.clientX,i=s.clientY;}function o(){n=!1,document.removeEventListener("pointermove",s),document.removeEventListener("pointerup",o);}t.addEventListener("pointerdown",(function(r){const a=r.target;a.classList.contains("ddv-button")||"false"===t.dataset.enableDrag||a instanceof HTMLInputElement||a instanceof HTMLButtonElement||(n=!0,e=r.clientX,i=r.clientY,document.addEventListener("pointermove",s),document.addEventListener("pointerup",o));}));}(this.el);};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindEvents(){this.nativeOn(this.el,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox",t);})),this.nativeOn(this.el,"pointerup",(t=>{t.target instanceof HTMLInputElement&&!(t.target instanceof HTMLInputElement&&"range"===t.target.type)||this.focusTexture();})),this.nativeOn(this.textSpan,"click",(()=>{this.setPaletteType("text");})),this.nativeOn(this.fillSpan,"click",(()=>{this.setPaletteType("fill");})),this.nativeOn(this.strokeSpan,"click",(()=>{this.setPaletteType("stroke");}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{toolMode:e,annotationMode:i}=t.getViewerConfig(),n=t.getSelectedAnnotations();return !t.getPageCounts()||("annotation"!==e&&!n.length||"annotation"===e&&("select"===i||"erase"===i))},i=t=>{"stamp"===t?this.setPaletteType("stamp"):"textAssist"===t?this.setPaletteType("textAssist"):"text"===t?(this.textSpan.style.display="",this.setPaletteType("text")):(this.textSpan.style.display="none",this.setPaletteType("stroke"));};this.hooks.inserted.on((()=>{e()&&this.togglePopup(!1);})),t.hooks.resize.on((()=>{if("none"===this.el.style.display)return;const{isOutOf:t}=uS(this.el,!1);if(t){var e;const t=this.el.getBoundingClientRect(),i=null===(e=this.el.parentElement)||void 0===e?void 0:e.getBoundingClientRect();this.el.style.right=i.width-t.width+"px";}}),this),t.hooks.beforeAnnotationEdit.on((()=>{this.togglePopup(!1);}),this),t.hooks.beforeAnnotationDraw.on((()=>{this.togglePopup(!1);}),this),t.hooks.beforeTextSelected.on((()=>{this.togglePopup(!1);})),t.hooks.pageChanged.on((e=>{e.total||this.togglePopup(!1);const i=t.getActiveTab();if(!i||"single"!==i.context.displayMode)return;1===t.getSelectedAnnotations().length&&this.togglePopup(!1);}),this),t.hooks.toolModeChanged.on((n=>{if(e())return void this.togglePopup(!1);const{annotationMode:s}=t.getViewerConfig(),o=["erase","select"].includes(s);if("annotation"===n.newToolMode&&!o&&!jn()){const t=["textBox","textTypewriter"].includes(s),e=["highlight","underline","strikeout"].includes(s);i("stamp"===s?"stamp":t?"text":e?"textAssist":"common"),this.togglePopup(!0);}}),this),t.hooks.selectedAnnotationsChanged.on((n=>{e()&&this.togglePopup(!1);const s=t.getSelectedAnnotations();if(1!==s.length)return;const o=s[0],r=["textBox","textTypewriter"].includes(o.type),a="textTypewriter"===o.type,l="ink"===o.type,h=["highlight","underline","strikeout"].includes(o.type),c="stamp"===o.type?"stamp":r?"text":h?"textAssist":"common";i(c),("text"===c&&a||l)&&(this.header.style.display="none");}),this),t.hooks.annotationModeChanged.on((e=>{if(t.getSelectedAnnotations().length)return;const n=e.newAnnotationMode;if(["erase","select"].includes(n))return void this.togglePopup(!1);const s=["textBox","textTypewriter"].includes(n),o=["highlight","underline","strikeout"].includes(n),r="textTypewriter"===n,a="ink"===n,l="stamp"===n?"stamp":s?"text":o?"textAssist":"common";i(l),("text"===l&&r||a)&&(this.header.style.display="none");const{toolMode:h}=this.injection.viewer.getViewerConfig(),c=this.injection.viewer.getPageCounts();if(jn()&&"stamp"!==l)this.togglePopup(!1);else {const{options:t}=this.data;this.togglePopup(c>0&&"annotation"===h&&t.autoDisplay);}}),this);}bindThumbnailHooks(){this.thumbnail.hooks.visibleChanged.on((()=>{this.updatePosition();}),this),this.$on("ui_searchVisibilityChanged",(()=>{this.updatePosition();}));}updatePosition(){if("none"===this.el.style.display)return;const{isOutOf:t,outOfLeft:e,outOfRight:i}=uS(this.el,!1);if(t){var n;const t=this.el.getBoundingClientRect(),s=null===(n=this.el.parentElement)||void 0===n?void 0:n.getBoundingClientRect();e&&(this.el.style.left="0px"),i&&(this.el.style.left=s.width-t.width+"px");}}setPaletteType(t){const{header:e,textSpan:i,strokeSpan:n,fillSpan:s}=this;if(this.$emit("ui_changePalette_type",t),"stamp"===t||"textAssist"===t)return void(e.style.display="none");const{backgroundColor:o}=getComputedStyle(this.el);e.style.display="";const r=(e,i,n)=>{e.style.background=t===i?n:"",e.style.borderBottom=t===i?"none":"";};r(i,"text",o),r(n,"stroke",o),r(s,"fill",o);}togglePopup(t,e,i){const n="none"!==this.el.style.display,s=_n(t)?!n:t;if(n===s)return;const{options:o}=this.data;s?(this.el.style.display="",null!=o&&o.positionRocked&&(this.el.style.left="",this.el.style.top="")):(this.el.style.display="none",this.$emit("ui_shrinkSelectionBox")),_n(e)||(this.el.style.right=`${e||0}px`),_n(i)||(this.el.style.top=`${i||0}px`),this.injection.viewer.emit("annotationPaletteToggle",s),uS(this.el).isOutOf&&(this.el.style.left="",this.el.style.top="");}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof xh&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{options:t}=this.data;fb(vb(this),this.injection.viewer,t),null!=t&&t.labels||(t.labels={}),t.labels={text:"Text",stroke:"Stroke",fill:"Fill",opacity:"Opacity",style:"Style",standardBusiness:"Standard Business",...t.labels},t.style={...t.style,display:"none"};const e=`<div ${Gw(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>${t.labels.text}</span><span>${t.labels.stroke}</span><span>${t.labels.fill}</span></div><FontPanel :maxFontSize="options.maxFontSize"></FontPanel><ColorPanel :enableChangeColor="options.enableChangeColor" :colorList="options.colorList"></ColorPanel><StampPanel :enableCustomStamp="options.enableCustomStamp" label="${t.labels.standardBusiness}"></StampPanel><OpacityPanel label="${t.labels.opacity}"></OpacityPanel><StrokePanel :maxBorderWidth="options.maxBorderWidth" label="${t.labels.stroke}"></StrokePanel><LinePanel label="${t.labels.style}"></LinePanel></div>`;this.template=e;}}function uS(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;if("none"===t.style.display||!t.parentElement)return {isOutOf:!1};const n=t.getBoundingClientRect(),s=t.parentElement.getBoundingClientRect();if(!e){const t=n.left<s.left,e=n.left+n.width>s.right;return {isOutOf:t||e,outOfLeft:t,outOfRight:e}}const o=n.right-i<s.left,r=n.left+i>s.right,a=n.bottom-i<s.top,l=n.top+i>s.bottom;return {isOutOf:o||r||a||l,outOfLeft:o,outOfRight:r,outOfTop:a,outOfBottom:l}}i(dS,"cpName","AnnotationPalette");class pS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-custom-stamp-panel"),i(this,"stampBoard",void 0),i(this,"fontList",[...ob]),i(this,"colorType",void 0),this.stampBoard=new ix(260,100),this.bindHooks(),this.initTemplate(),this.$on("ui_addFont",(t=>{this.addFont(t);})),this.$on("ui_changePalette_visible",((t,e)=>{t===pS.cpName&&this.togglePopup(e);}));}getFontFamilySelectTemplate(){let t="";for(let e=0;e<ob.length;e++){const i=ob[e];t+=`<button style="font-family:${i}" value="${i}">${i}</button>`;}return `<div class="ddv-stamp-font-family"><p>${this.stampBoard.signatureStyle.fontFamily}</p><i class="ddv-down-arrow"></i><div class="ddv-stamp-font-family-select" style="display: none;">${t}</div></div>`}bindHooks(){this.hooks.inserted.on((t=>{this.injection.viewer.context.viewService.rootDom.appendChild(this.el);const e=this.stampBoard.getCanvas();this.el.querySelector(`.${this.defaultClass}-canvas-container`).appendChild(e),this.bindEvents(),this.updateFontStyleButton(),this.selectColorType("background"),this.updateColorSelected();}));}bindEvents(){const t=this.el.querySelector(".ddv-bold"),e=this.el.querySelector(".ddv-italic"),i=this.el.querySelector(".ddv-underline-mode"),n=this.el.querySelector(".ddv-strikeout-mode");this.nativeOn(t,"click",(()=>{const{fontWeight:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({fontWeight:"bold"===t?"normal":"bold"}),this.updateFontStyleButton();})),this.nativeOn(e,"click",(()=>{const{fontStyle:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({fontStyle:"italic"===t?"normal":"italic"}),this.updateFontStyleButton();})),this.nativeOn(i,"click",(()=>{const{underline:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({underline:!t}),this.updateFontStyleButton();})),this.nativeOn(n,"click",(()=>{const{strikeout:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({strikeout:!t}),this.updateFontStyleButton();}));const s=this.el.querySelectorAll(`.${this.defaultClass}-color-type span`),[o,r,a]=Array.from(s);this.nativeOn(o,"click",(()=>{this.selectColorType("background");})),this.nativeOn(r,"click",(()=>{this.selectColorType("border");})),this.nativeOn(a,"click",(()=>{this.selectColorType("text");}));const l=this.el.querySelector(`.${this.defaultClass}-color-container`);this.nativeOn(l,"click",(t=>{const e=t.target;if(!(e.dataset.color||e instanceof HTMLButtonElement))return;const i=(e instanceof HTMLButtonElement?e.parentNode:e).dataset.color;"background"===this.colorType?this.stampBoard.updateSignatureStyle({background:i}):"border"===this.colorType?this.stampBoard.updateSignatureStyle({borderColor:i}):this.stampBoard.updateSignatureStyle({color:i}),this.updateColorSelected();}));const h=this.el.querySelector(`.${this.defaultClass}-ok`);this.nativeOn(h,"click",(async t=>{const e=this.stampBoard.getStampConfig(),i=await this.stampBoard.getSignatureImage(),{options:n}=this.data,{autoDisplay:s}=n;this.$emit("ui_customStampCreated",{stampConfig:e,stampImage:i}),s&&this.togglePopup(!1);}));const c=this.el.querySelector(".ddv-button-close");this.nativeOn(c,"click",(t=>{this.togglePopup(!1);})),this.bindInputEvent(),this.bindToggleEvent(),this.bindSelectEvent();}bindInputEvent(){const t=this.el.querySelector(`.${this.defaultClass}-stamp-text input`);this.nativeOn(t,"input",(()=>{const e=t.value;this.stampBoard.updateSignatureStyle({stampText:e});}));const e=this.el.querySelectorAll(`.${this.defaultClass}-time-stamp input`),[i,n,s,o]=Array.from(e);this.nativeOn(i,"input",(()=>{const t=i.value;this.stampBoard.updateSignatureStyle({userName:t});})),this.nativeOn(n,"change",(()=>{this.stampBoard.updateSignatureStyle({hasUserName:n.checked});})),this.nativeOn(s,"change",(()=>{this.stampBoard.updateSignatureStyle({hasDate:s.checked});})),this.nativeOn(o,"change",(()=>{this.stampBoard.updateSignatureStyle({hasTime:o.checked});}));}bindSelectEvent(){const t=this.el.querySelector(".ddv-stamp-font-family"),e=t.querySelector(".ddv-stamp-font-family-select"),i=t.querySelector("p");this.nativeOn(e,"click",(t=>{t.stopPropagation(),this.toggleSelect(!1);const e=t.target.value;e&&(this.stampBoard.updateSignatureStyle({fontFamily:e}),i.innerText=e);}));}bindToggleEvent(){const t=this.el.querySelector(".ddv-stamp-font-family");this.nativeOn(t,"click",(t=>{t.stopPropagation(),this.toggleSelect();}));}toggleSelect(t){const e=this.el.querySelector(".ddv-stamp-font-family"),i=e.querySelector(".ddv-stamp-font-family-select"),n=e.querySelector(".ddv-down-arrow"),s="none"!==i.style.display,o=_n(t)?!s:t,r=this.injection.viewer.context.viewService.rootDom;s!==o&&(o?(i.style.display="block",i.style.top=`${lb(i,r)}px`,n.style.transform="rotate(180deg)"):(i.style.display="none",n.style.transform=""));}addFont(t){const e=this.el.querySelector(".ddv-stamp-font-family");if(this.fontList.includes(t))return;this.fontList.push(t);const i=e.querySelector(".ddv-stamp-font-family-select"),n=document.createElement("button");n.style.fontFamily=t,n.value=t,n.innerText=t,i.appendChild(n);}updateFontStyleButton(){const{fontStyle:t,fontWeight:e,underline:i,strikeout:n}=this.stampBoard.signatureStyle,s=this.el.querySelector(".ddv-bold"),o=this.el.querySelector(".ddv-italic"),r=this.el.querySelector(".ddv-underline-mode"),a=this.el.querySelector(".ddv-strikeout-mode");pb(s,"bold"===e,"light"),pb(o,"italic"===t,"light"),pb(r,i,"light"),pb(a,n,"light");}getColorSelector(t){const{options:e}=this.data,{colorList:i}=e,n=document.createElement("div");let s=`<div class="${t}">`,o=0,r=!1;for(let e=0;e<i.length;e++){const a=i[e];if(n.style.background=a,""!==n.style.background){if(o>20)break;o+=1,s+=`<div data-color="${a}"><button style="background:${a}"></button></div>`,0!==o&&o%10==0&&(r=!1,s+="</div>",e!==i.length-1&&(r=!0,s+=`<div class="${t}">`)),n.style.background="";}}return r&&(s+="</div>"),n.remove(),s}selectColorType(t){if(t===this.colorType)return;const e=this.el.querySelectorAll(`.${this.defaultClass}-color-type span`),[i,n,s]=Array.from(e);this.colorType=t;[{element:i,type:"background"},{element:n,type:"border"},{element:s,type:"text"}].forEach((e=>{let{element:i,type:n}=e;n===t?(i.style.color="#3183c8",i.style.borderBottom="2px solid #3183c8"):(i.style.color="",i.style.borderBottom="");})),this.updateColorSelected();}updateColorSelected(){const{colorType:t}=this,{background:e,borderColor:i,color:n}=this.stampBoard.signatureStyle,s="background"===t?e:"border"===t?i:n,o=this.el.querySelectorAll(".ddv-custom-stamp-panel-color-container div");Array.from(o).forEach((t=>{t.style.border=t.dataset.color===s?"1px solid #aaa":"";}));}togglePopup(t){const e="none"!==this.el.style.display,i=_n(t)?!e:t;e!==i&&(this.el.style.display=i?"":"none",i||xb(this.injection.viewer,!1));}initTemplate(){const{options:t}=this.data;fb(vb(this),this.injection.viewer,t),t.style={...t.style,display:"none"};const{hasUserName:e,hasDate:i,hasTime:n}=this.stampBoard.signatureStyle,s=`<div ${Gw(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>${(null==t?void 0:t.title)||"Create New Stamp"}</span><div class="ddv-button ddv-button-close"></div></div><div class="${this.defaultClass}-content"><div class="${this.defaultClass}-canvas-container"></div><div class="${this.defaultClass}-stamp-text"><span>${t.labels.stampText}</span><input type="text" value="${this.stampBoard.signatureStyle.stampText}"/></div><div class="${this.defaultClass}-font-style"><span>${t.labels.fontStyle}</span><div style="margin-top: 10px; display: flex; justify-content: space-between">${this.getFontFamilySelectTemplate()}<div class="ddv-button ddv-bold"></div><div class="ddv-button ddv-italic"></div><div class="ddv-button ddv-underline-mode"></div><div class="ddv-button ddv-strikeout-mode"></div></div></div><div class="${this.defaultClass}-time-stamp"><span>${t.labels.timeStampText}</span><div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;"><input type="text" value="${this.stampBoard.signatureStyle.userName}"/><label><input checked="${e?"checked":""}" type="checkbox"/>${t.labels.userName}</label><label><input checked="${i?"checked":""}" type="checkbox" />${t.labels.date}</label><label><input checked="${n?"checked":""}" type="checkbox" />${t.labels.time}</label></div></div><div class="${this.defaultClass}-color-picker"><div class="${this.defaultClass}-color-type"><span>${t.labels.backgroundColor}</span><span>${t.labels.borderColor}</span><span>${t.labels.textColor}</span></div><div class="${this.defaultClass}-color-container">${this.getColorSelector(`${this.defaultClass}-color-list`)}</div></div><div class="${this.defaultClass}-footer"><div class="${this.defaultClass}-ok">${t.labels.create}</div></div></div></div>`;this.template=s;}}i(pS,"cpName","AnnotationCustomStampPanel");class gS extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;t.context.annotationEditService.applyTextSelectionToAnnotation(this.textAssistType),t.context.textSelectionService.clearSelectedTexts();}}),i(this,"textAssistType",void 0),this.textAssistType=e.textAssistType;}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}}class fS extends gS{constructor(t){super(t,{class:"ddv-highlight-mode",textAssistType:Gh.HIGHLIGHT});}}class vS extends gS{constructor(t){super(t,{class:"ddv-strikeout-mode",textAssistType:Gh.STRIKEOUT});}}class mS extends gS{constructor(t){super(t,{class:"ddv-underline-mode",textAssistType:Gh.UNDERLINE});}}class yS extends wb{constructor(t){super(t,{class:"ddv-copy-text",callback:()=>{this.injection.viewer.copySelectedTexts(),this.$emit("ui_toolbarToggle");}});}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}}class xS extends wb{constructor(t){super(t,{class:"ddv-auto-capture",callback:()=>{const{viewer:t}=this.injection,{viewerMode:e}=t.getViewerConfig(),{enableAutoCapture:i}=t.getCameraConfig();e===dg.CAPTURE&&t.updateCameraConfig({enableAutoCapture:!i});}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()?t.getCameraConfig().enableAutoCapture?this.setUiState("focused",!jn()):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.autoCaptureChanged.on((t=>{const e=t.enableAutoCapture?"focused":"normal";this.setUiState(e,!jn());}),this),t.cameraPlayed.on((()=>{const{enableAutoCapture:t}=this.injection.viewer.getCameraConfig();this.setUiState(t?"focused":"normal",!jn());}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(xS,"cpName","AutoCapture");class wS extends wb{constructor(t){super(t,{class:"ddv-auto-detect",callback:()=>{const{viewer:t}=this.injection,{viewerMode:e}=t.getViewerConfig(),{enableAutoDetect:i}=t.getCameraConfig();e===dg.CAPTURE&&t.updateCameraConfig({enableAutoDetect:!i});}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()&&t.context.core.detectorService.enableDetect?t.getCameraConfig().enableAutoDetect?this.setUiState("focused",!jn()):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.autoDetectChanged.on((t=>{const e=t.enableAutoDetect?"focused":"normal";this.setUiState(e,!jn());}),this),t.cameraPlayed.on((()=>{const{core:t}=this.injection.viewer.context;if(!t.detectorService.enableDetect)return;const{enableAutoDetect:e}=this.injection.viewer.getCameraConfig();this.setUiState(e?"focused":"normal",!jn());}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(wS,"cpName","AutoDetect");class bS extends wb{constructor(t){super(t,{class:"ddv-capture-image",callback:()=>{if(this.isCapturing)return;const t=this.injection.viewer;this.isCapturing=!0,this.setUiState("disabled"),t.capture().finally((()=>{this.isCapturing=!1,this.setUiState("normal");}));}}),i(this,"isCapturing",!1),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{this.setUiState(this.injection.viewer.isVideoPlaying()?"normal":"disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.cameraPlayed.on((()=>{this.setUiState("normal");}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(bS,"cpName","Capture");class SS extends wb{constructor(t){super(t,{class:"ddv-camera-flashlight",callback:()=>{const{viewer:t}=this.injection;t.cameraContext.turnOnTheTorch?t.turnOffTorch():t.turnOnTorch();}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const{viewer:t}=this.injection;t.isVideoPlaying()&&t.cameraContext.torchSupported?t.cameraContext.turnOnTheTorch?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){this.injection.viewer.hooks.torchChanged.on((t=>{switch(t.torchState){case"supported":case"off":this.setUiState("normal");break;case"on":this.setUiState("focused",!jn());break;default:this.setUiState("disabled");}}),this);}}i(SS,"cpName","Flashlight");class CS extends wb{constructor(t){super(t,{class:"ddv-camera-convert",callback:()=>{const{viewer:t}=this.injection;t.cameraContext.convertCamera();}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()?this.setUiState(t.cameraContext.canFrontCamera?"normal":"disabled"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.cameraPlayed.on((()=>{const t=this.injection.viewer.cameraContext.canFrontCamera;this.setUiState(t?"normal":"disabled");}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(CS,"cpName","CameraConvert");const PS=[{label:" 720P",value:{width:1280,height:720}},{label:" 1080P",value:{width:1920,height:1080}},{label:" 1440P",value:{width:2560,height:1440}},{label:" 2160P",value:{width:3840,height:2160}}];class TS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-resolution"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"checkedClassName",`${this.cssPrefix}checkbox-checked`),i(this,"resolutionOptions",[]),i(this,"isFirstClick",!0),i(this,"fakeResolution",!1),i(this,"lastCheckIndex",0),i(this,"box",void 0),this.bindHooks(),this.initTemplate(),hb(this);}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}box`),this.box.style.display="none",this.box.remove(),this.updateResolution(),this.bindEvents(),this.bindViewerHooks(),this.bindEventsEmitter(),ub(this.el,!0);})),this.hooks.updated.on((()=>{this.box.style.display="none",this.isFirstClick=!0,this.injection.viewer.isVideoPlaying()||ub(this.el,!0);}));}bindEvents(){const t=this.box.getElementsByTagName("ul")[0];this.nativeOn(this.el,"click",(()=>{const t=this.injection.viewer.rootDom;this.togglePopup(),this.isFirstClick&&(gb(t,this.el,this.box),this.isFirstClick=!1);})),this.ulEvent(t);}ulEvent(t){t&&this.nativeOn(t,"click",(t=>{const e=this.injection.viewer,i=t.target,n=i.parentNode;if("LI"===i.tagName||"LI"===n.tagName){const t="LI"===i.tagName?i.value:n.value;if(t===this.lastCheckIndex)return;const{width:s,height:o}=this.resolutionOptions[t].value;this.fakeResolution=!0,e.setResolution(s,o).catch((t=>{Du.error(t);})),this.updateChecked(s,o);}this.togglePopup(!1);}));}bindViewerHooks(){const{viewer:t}=this.injection,{hooks:e}=t;e.cameraPlayed.on((t=>{if(ub(this.el,!1),this.fakeResolution)return;const{width:e,height:i}=t.resolution;this.updateChecked(e,i),this.fakeResolution=!1;}),this),e.cameraClosed.on((()=>{ub(this.el,!0);}),this),e.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}updateChecked(t,e){const i=function(t,e){let i=-1;const n=e.width*e.height;for(let e=0;e<t.length;e++){const{value:s}=t[e],o=s.width*s.height;if(0===e&&n<=o)return 0;if(e===t.length&&n>=o)return t.length-1;n>o&&(i=e+1);}return i}(this.resolutionOptions,{width:t,height:e}),{box:n,checkedClassName:s}=this,o=n.getElementsByClassName(`${this.cssPrefix}checkbox`)[i],r=n.getElementsByClassName(s)[0];o!==r&&(this.lastCheckIndex=i,null==o||o.classList.add(s),null==r||r.classList.remove(s));}initTemplate(){const{options:t}=this.data,{popupBox:e}=t;fb(vb(this),this.injection.viewer,t);const i=`<div ${Gw(t,`${this.defaultClass} ddv-button`)}>`+(_n(null==t?void 0:t.label)?"":`<span>${t.label}</span>`)+'<i class="ddv-down-arrow"></i>'+`<div ${Gw(e,this.cssPrefix,"box")}><ul></ul></div></div>`;this.template=i;}getOptionTemplate(){const{options:t}=this.data;let e=PS;if(On(null==t?void 0:t.valueList))e=t.valueList;else {const{CameraResolution_720P:t,CameraResolution_1080P:i,CameraResolution_1440P:n,CameraResolution_2160P:s}=LC.getDisplayTextConfig(),o=[t,i,n,s];e.forEach(((t,e)=>{o[e]&&(t.label=o[e]);}));}let i="";return e.forEach(((t,e)=>{const{width:n,height:s}=t.value;Xn(n)&&Xn(s)&&(i+=[`<li value="${e}">`,`<i class="${this.cssPrefix}checkbox"></i>`,`<span>${(null==t?void 0:t.label)||""}</span>`,"</li>"].join(""));})),this.resolutionOptions=e,i}updateResolution(){const t=this.getOptionTemplate();this.box.getElementsByTagName("ul")[0].innerHTML=t;}togglePopup(t){const{box:e}=this,{viewer:i}=this.injection;let n="none"!==e.style.display;n=_n(t)?!n:t,n?(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e)):e.remove(),pb(this.el,n),e.style.display=n?"":"none";}}i(TS,"cpName","CameraResolution");class AS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-image-preview"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"uiState",void 0),i(this,"image",void 0),i(this,"counter",void 0),i(this,"imagePageUid",void 0),i(this,"hasTask",!1),i(this,"isUpdateTask",!1),i(this,"lastPageUid",void 0),i(this,"pageTaskUids",[]),i(this,"currentTimer",void 0),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.created.on((t=>{this.setState("disabled"),this.bindViewerHooks(),this.bindEventsEmitter();})),this.hooks.inserted.on((t=>{this.image=this.el.getElementsByTagName("img")[0],this.counter=this.query(`.${this.cssPrefix}counter`);})),this.hooks.destroyed.on((()=>{var t;clearTimeout(this.currentTimer),null!=this&&this.image&&null!=this&&null!==(t=this.image)&&void 0!==t&&t.src&&URL.revokeObjectURL(this.image.src);}));}bindViewerHooks(){const t=this.injection.viewer,e=jn()?10:4;t.hooks.updatePage.on((async i=>{if(i.pageUid!==this.lastPageUid)return;if(this.hasTask)return this.pageTaskUids.push(i.pageUid),void(this.isUpdateTask=!0);this.hasTask=!0;const n=t.getPageCounts(),s=await t.getPerspectivePreviewImage(n-1,400,400,e);s&&(this.image.src&&URL.revokeObjectURL(this.image.src),this.image.src=Zn(s.data).data),this.hasTask=!1,this.pageTaskUids.length>0&&this.createTask();}),this),t.hooks.pageChanged.on((async e=>{var i;if(0===e.total)return null!=this&&this.image&&null!=this&&null!==(i=this.image)&&void 0!==i&&i.src&&URL.revokeObjectURL(this.image.src),this.image.src="",this.setState("disabled"),this.imagePageUid=void 0,this.lastPageUid=void 0,void(this.pageTaskUids.length=0);if(null==this||!this.counter)return;this.counter.innerText=`${e.total}`;const n=t.getActiveTab();if(!n)return;const s=n.pages[e.total-1].uid;this.pageTaskUids.push(s),this.hasTask||s!==this.lastPageUid&&this.createTask();}),this);}async createTask(){this.hasTask||(this.hasTask=!0,await this.updateImage(),this.currentTimer=setTimeout((()=>{this.hasTask=!1,0!==this.pageTaskUids.length&&this.createTask();}),300));}async updateImage(){var t;const e=this.injection.viewer;if(!e||!e.context)return;const i=e.getActiveTab(),n=jn()?10:4;if(!i)return;const s=i.pages.length;if(!s)return;const o=this.pageTaskUids[this.pageTaskUids.length-1],r=i.pages[s-1].uid;if(this.pageTaskUids.length=0,this.lastPageUid=i.pages[s-1].uid,this.lastPageUid===o&&this.imagePageUid===o&&!this.isUpdateTask)return;let a;this.isUpdateTask&&(this.isUpdateTask=!1);try{a=await e.getPerspectivePreviewImage(s-1,400,400,n);}catch(t){}const l=e.getActiveTab(),h=(null==l||null===(t=l.pages)||void 0===t?void 0:t.length)||0;this.image.src&&URL.revokeObjectURL(this.image.src),a&&!e.isDestroy&&l&&h&&(this.image.src=Zn(a.data).data,this.imagePageUid=r,this.setState(h>0?"normal":"disabled"));}setState(t){this.uiState!==t&&this.el&&("normal"===t?(this.el.style.visibility="",this.el.style.pointerEvents=""):(this.el.style.visibility="hidden",this.el.style.pointerEvents="none"),this.uiState=t);}initTemplate(){const{options:t}=this.data,{imageCounter:e}=t,i=this.injection.viewer.getPageCounts();fb(vb(this),this.injection.viewer,t);const n=`<div ${Gw(t,this.defaultClass)}> <img src=""></img><div ${Gw(e,this.cssPrefix,"counter")}>${i}</div></div>`;this.template=n;}}i(AS,"cpName","ImagePreview");class kS extends wb{constructor(t){super(t,{class:"ddv-load-image",callback:()=>{this.fileLoader.value=null,delete this.fileLoader.files,this.fileLoader.click();}}),i(this,"fileLoader",void 0),this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection;0!==(e.getPageCounts()||0)&&this.setUiState(t?"disabled":"normal");}));}createFileInput(){var t;const e=document.createElement("input");e.accept="image/png,image/jpeg,image/bmp,image/tiff,application/pdf",e.type="file",e.multiple=!0;const i={renderAnnotations:Ep.annotationLicenseModuleIsExist()?rc.LOAD_ANNOTATIONS:rc.NO_ANNOTATIONS};return !0===(null===(t=this.injection.viewer)||void 0===t||null===(t=t.popupConfig)||void 0===t||null===(t=t.passwordLoaderConfig)||void 0===t?void 0:t.enabled)?this.nativeOn(e,"change",(async()=>{const{files:t}=e,n=t.length;for(let e=0;e<n;e++){const n=new Blob([t[e]],{type:t[e].type});await this.injection.viewer.context.core.isPdfEncrypted(n)?await new Promise((i=>{this.$emit("ui_showPasswordLoader",{blob:n,fileName:t[e].name,resolve:i});})):this.injection.viewer.context.loadSource({fileData:n,convertMode:oc.CM_AUTO,renderOptions:i});}e.value=null,e.files=null;})):this.nativeOn(e,"change",(()=>{const{files:t}=e,n=t.length,s=[];for(let e=0;e<n;e++){const n=new Blob([t[e]],{type:t[e].type});"application/pdf"===t[e].type?s.push({fileData:n,convertMode:oc.CM_AUTO,renderOptions:i}):s.push({fileData:n});}this.injection.viewer.context.loadSource(s),e.value=null,e.files=null;})),e}bindHooks(){super.bindHooks(),this.hooks.inserted.on((()=>{const t=this.createFileInput();t.style.display="none",this.el.appendChild(t),this.fileLoader=t,this.nativeOn(t,"click",(t=>{t.stopPropagation();}));}));}bindDefaultUi(){this.injection.viewer.hooks.pageExistenceChanged.on((t=>{null!=t&&t.pageCount||this.setUiState("normal");}),this);}}i(kS,"cpName","Load");class ES extends wb{constructor(t){super(t,{class:"ddv-delete-all",callback:()=>{this.injection.viewer.deleteAllPages();}}),db(this);}}i(ES,"cpName","DeleteAll");class DS extends wb{constructor(t){super(t,{class:"ddv-delete-current",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.deletePages([e]);}}),db(this);}}function RS(t){try{t.dispatchEvent(new MouseEvent("click"));}catch(e){const i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(i);}}function IS(t,e,i){if("download"in HTMLAnchorElement.prototype){const i=document.createElementNS("http://www.w3.org/1999/xhtml","a");e=e||t.name||"download",i.download=e,i.rel="noopener","string"==typeof t?(i.href=t,i.origin!==window.location.origin?function(t){const e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send();}catch(t){}return e.status>=200&&e.status<=299}(i.href)?function(t,e,i){const n=new XMLHttpRequest;n.open("GET",t),n.responseType="blob",n.onload=()=>{IS(n.response,e);},n.onerror=()=>{},n.send();}(t,e):(i.target="_blank",RS(i)):RS(i)):(i.href=URL.createObjectURL(t),setTimeout((()=>{URL.revokeObjectURL(i.href),i.href="",i.remove();}),3e3),setTimeout((()=>{RS(i);}),0));}}i(DS,"cpName","DeleteCurrent");class MS extends wb{constructor(t){super(t,{class:"ddv-button-download",callback:()=>{const t=this.injection.viewer,e=t.getActiveTab(),i=Du.buildInfo("save",{docUid:e.doc.uid,pageUids:e.doc.pages,current:0,total:e.doc.pages.length});Du.info(i),t.context.core.fileSaveService.saveToPdf(e.doc.pages,{mimeType:"application/octet-stream",saveAnnotation:Ep.annotationLicenseModuleIsExist()?"annotation":"none"},i).then((t=>{IS(t,`${e.docName}.pdf`);})).catch((t=>{Du.error(t);}));}}),cb(this);}}i(MS,"cpName","Download");class BS extends Sb{constructor(t){const{Delete_DeleteCurrent:e,Delete_DeleteAll:i}=LC.getDisplayTextConfig(),{Delete_DeleteCurrent:n,Delete_DeleteAll:s}=sb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"DeleteCurrent",label:e,id:n},{type:"DeleteAll",label:i,id:s}],defaultClassName:"ddv-delete-btn"},super(t),db(this);}}i(BS,"cpName","Delete");class US extends wb{constructor(t){super(t,{class:"ddv-print-page",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex(),i=t.getActiveTab(),{displayMode:n}=i.context;"single"===n?t.context.core.printPages(i.uid,[e]):t.context.core.printPages(i.uid);}}),cb(this);}}i(US,"cpName","Print");class LS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-password-loader"),i(this,"errorTimes",0),i(this,"fileData",null),i(this,"fileName",null),i(this,"loaderResolve",null),this.initTemplate(),this.bindHooks(),this.$on("ui_showPasswordLoader",(t=>{this.show(t.blob,t.fileName,t.resolve);}));}bindHooks(){this.hooks.inserted.on((t=>{this.bindEvents();}));}bindEvents(){const t=this.el.querySelector(".ddv-button-close"),e=this.el.querySelector(`.${this.defaultClass}-button`),i=this.el.querySelector(`.${this.defaultClass}-input`);i.addEventListener("input",(()=>{this.setErrorTimesVisible(!1);})),i.addEventListener("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.reloadFile());})),t.addEventListener("click",(()=>{this.loaderResolve&&(this.loaderResolve(),this.hide());})),e.addEventListener("click",(()=>{this.reloadFile();}));}show(t,e,i){const n=this.el.querySelector(`.${this.defaultClass}-input`);this.el.style.display="block",this.fileData=t,this.fileName=e,this.loaderResolve=i,this.updateFileInfo(),xb(this.injection.viewer,!0),n.focus();}hide(){this.el.querySelector(`.${this.defaultClass}-input`).value="",this.el.style.display="none",this.fileData=null,this.fileName=null,this.loaderResolve=null,this.errorTimes=0,this.setErrorTimesVisible(!1),this.setErrorVisible(!1),xb(this.injection.viewer,!1);}reloadFile(){if(!this.fileData)return;if(this.errorTimes>3)return void this.hide();const t=this.el.querySelector(`.${this.defaultClass}-input`);this.injection.viewer.context.loadSource({fileData:this.fileData,convertMode:oc.CM_AUTO,password:t.value},!0).then((()=>{this.loaderResolve(),this.hide();})).catch((()=>{3===this.errorTimes&&this.setErrorVisible(!0),this.setErrorTimesVisible(!0,3-this.errorTimes),this.errorTimes+=1;}));}updateFileInfo(){const t=this.el.querySelector(`.${this.defaultClass}-name`);t&&(t.innerText=` ${this.fileName} `);}setErrorTimesVisible(t,e){const i=this.el.querySelector(`.${this.defaultClass}-times`);i.style.display=t?"block":"none",t&&(i.innerText=`The password is incorrect. Remaining input times: ${e}`);}setErrorVisible(t){const e=this.el.querySelector(`.${this.defaultClass}-error`),i=this.el.querySelector(`.${this.defaultClass}-container`),n=this.el.querySelector(`.${this.defaultClass}-button`);e.style.display=t?"block":"none",i.style.display=t?"none":"block",n.innerText=t?"Ok":"Submit";}initTemplate(){const{options:t}=this.data;fb(vb(this),this.injection.viewer,t);const e=`<div ${Gw(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>Password required</span><div class="ddv-button ddv-button-close"></div></div><div class="${this.defaultClass}-container"><span class="${this.defaultClass}-info">The<span class="${this.defaultClass}-name">file</span>has been encrypted. Please enter your password.</span><form style="width: 100%"><input autocomplete="off" type="password" class="${this.defaultClass}-input" /></form><span style="display:none" class="${this.defaultClass}-times">The password is incorrect. Remaining input times:3</span></div><div style="display:none" class="${this.defaultClass}-error"><span>Unable to load the document, too many attempts.</span></div><div class="${this.defaultClass}-button">OK</div></div>`;this.template=e;}}i(LS,"cpName","PasswordLoader");class OS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-search-result"),i(this,"searchedResult",[]),i(this,"bufferSize",3),i(this,"lastSearchUid",""),i(this,"lastSearchType",""),i(this,"lastSelectedTextUid",""),i(this,"isDirty",!1),i(this,"isFocusResultItem",!1),i(this,"startIndex",0),i(this,"endIndex",0),i(this,"titleIndex",[]),i(this,"renderDataArr",[]),i(this,"pageIndices",[]),i(this,"totalHeight",0),i(this,"domHightList",[]),i(this,"tempDiv",null),i(this,"getResultItemDom",(t=>{const e=this.renderDataArr[t],{length:i}=e.text,{startIndex:n,context:s}=e,o=s.substring(0,n),r=WS(s.substring(n,n+i)),a=WS(s.substring(n+i)),l=document.createElement("div");return l.dataset.textUid=e.textUid,l.className=`${this.defaultClass}-item`,l.innerHTML=`${o}<span>${r}</span>${a}`,l.addEventListener("click",(t=>{this.injection.viewer.selectSearchText(e.pageUid,e.textUid);})),l})),this.initTemplate(),this.bindHooks(),this.$on("ui_clearTextSearch",(()=>{this.resetSelf(),this.updateSearchResultCount();})),this.$on("ui_searchVisibilityChanged",(t=>{this.isDirty&&t&&(this.calculatePhantomHeight(),this.updateSearchResultCount(),this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid));})),this.$on("ui_swipeChanged",(t=>{t===this.el.parentNode&&setTimeout((()=>{this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid);}),250);})),this.tempDiv=document.createElement("div"),this.tempDiv.className=`${this.defaultClass}-item`;}bindHooks(){this.hooks.inserted.on((()=>{this.bindViewerHooks(),this.bindEvents();})),this.hooks.destroyed.on((()=>{this.tempDiv=null;}));}bindEvents(){const t=this.el.querySelector(`.${this.defaultClass}-prev`),e=this.el.querySelector(`.${this.defaultClass}-next`),i=this.el.querySelector(`.${this.defaultClass}-container-body`);this.nativeOn(t,"click",(()=>{this.injection.viewer.prevSearchText(),this.autoScrollToItem();})),this.nativeOn(e,"click",(()=>{this.injection.viewer.nextSearchText(),this.autoScrollToItem();})),this.nativeOn(i,"scroll",(()=>{this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid);})),jn()||(i.tabIndex=0,this.nativeOn(i,"focus",(()=>{this.injection.viewer.context.isFocusCanvas=!1;})),this.nativeOn(i,"blur",(()=>{this.isFocusResultItem=!1;})),this.nativeOn(i,"click",(t=>{this.renderDataArr.length&&(i.focus(),t.target.classList.contains(`${this.defaultClass}-item`)?this.isFocusResultItem=!0:this.isFocusResultItem=!1);})),this.nativeOn(i,"keydown",(t=>{this.isFocusResultItem&&(t.preventDefault(),t.stopPropagation(),"ArrowDown"===t.key&&this.injection.viewer.nextSearchText(),"ArrowUp"===t.key&&this.injection.viewer.prevSearchText(),this.autoScrollToItem());})));}bindViewerHooks(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-container-body`),i=this.el.querySelector(`.${this.defaultClass}-content`);t.hooks.searchTextChanged.on((n=>{const s=t.getActiveTab(),o=e.offsetHeight,r=i.offsetHeight;this.pageIndices=[],this.searchedResult=n.searchResults,this.searchedResult.forEach((t=>{const e=s.uidToIndex(t.pageUid);this.pageIndices.push(e);}));const a=this.lastSearchUid!==n.searchUid||this.lastSearchType!==n.searchType||"single"===n.searchType||n.isEditPages;a&&(e.scrollTo({top:0}),this.domHightList=[],this.renderDataArr=[],this.titleIndex=[],this.lastSearchType=n.searchType,this.lastSearchUid=n.searchUid,this.totalHeight=0),this.calculatePhantomHeight(),this.updateSearchResultCount(),(a||r<o)&&(this.updateVisibleItems(),this.renderItem());}),this),t.hooks.searchTextSelected.on((t=>{this.lastSelectedTextUid=t,this.selectResultItem(t);}),this);}resetSelf(){this.searchedResult=[],this.renderDataArr=[],this.titleIndex=[],this.domHightList=[],this.totalHeight=0,this.calculatePhantomHeight();const t=this.el.querySelector(`.${this.defaultClass}-content`);t.style.transform="",t.innerHTML="";}autoScrollToItem(){const t=this.el.querySelector(`.${this.defaultClass}-container-body`);if(!t||!this.lastSelectedTextUid)return;let e=-1;for(let t=0;t<this.renderDataArr.length;t++){const i=this.renderDataArr[t];if(i&&i.textUid===this.lastSelectedTextUid){e=t;break}}if(-1===e)return;if(1===e)return void t.scrollTo({top:0,behavior:"smooth"});let i=0;for(let t=0;t<e;t++)i+=this.domHightList[t];const n=i+this.domHightList[e],s=t.scrollTop,o=s+t.clientHeight;i<s?t.scrollTo({top:i,behavior:"smooth"}):n>o&&t.scrollTo({top:n-t.clientHeight,behavior:"smooth"});}calculatePhantomHeight(){const t=this.el.querySelector(`.${this.defaultClass}-phantom`);for(let t=this.titleIndex.length;t<this.searchedResult.length;t++){const e=this.renderDataArr.length;this.titleIndex.push(e),this.renderDataArr.push(t),this.renderDataArr.push(...this.searchedResult[t].texts);for(let t=e;t<this.renderDataArr.length;t++)this.domHightList[t]=this.titleIndex.includes(t)?27:63,this.totalHeight+=this.domHightList[t];}t.style.height=`${this.totalHeight}px`;}updateVisibleItems(){const t=this.el.querySelector(`.${this.defaultClass}-container-body`);if(!t)return;const{scrollTop:e,clientHeight:i}=t;if(0===i)return this.startIndex=0,this.endIndex=0,void(this.isDirty=!0);let n=0;const s=this.domHightList.map((t=>(n+=t)-t));this.isDirty=!1;let o=0;const r=this.findIndex(e,s),a=this.findIndex(e+i,s);this.startIndex=Math.max(0,r-this.bufferSize),this.endIndex=Math.min(this.renderDataArr.length,a+this.bufferSize);for(let t=0;t<this.startIndex;t++)o+=this.domHightList[t];this.el.querySelector(`.${this.defaultClass}-content`).style.transform=`translateY(${o}px)`;}renderItem(){const t=this.el.querySelector(`.${this.defaultClass}-content`),e=this.el.querySelector(`.${this.defaultClass}-phantom`);if(!t)return;t.innerHTML="";let i=0;for(let e=this.startIndex;e<this.endIndex;e++)if(this.titleIndex.includes(e)){const i=document.createElement("span");i.className=`${this.defaultClass}-split`,i.textContent=`Page ${this.pageIndices[this.titleIndex.indexOf(e)]+1}`,t.appendChild(i);}else {const n=this.getResultItemDom(e);t.appendChild(n);const s=this.domHightList[e],o=n.offsetHeight+5;this.domHightList[e]=o,i+=o-s;}i&&(this.totalHeight+=i,e.style.height=`${this.totalHeight}px`);}updateSearchResultCount(){const t=this.el.querySelector(`.${this.defaultClass}-count`);if(!t)return;const e=this.renderDataArr.length-this.titleIndex.length;t.textContent=1===e?`${e} result found`:`${e} results found`;}selectResultItem(t){const e=this.el.querySelector(`.${this.defaultClass}-content`);if(!e)return;const i=e.querySelectorAll(`.${this.defaultClass}-item`),n=`${this.defaultClass}-item-selected`;i.forEach((e=>{e.dataset.textUid===t?e.classList.add(n):e.classList.remove(n);}));}findIndex(t,e){let i=0,n=e.length-1;for(;i<=n;){const s=Math.floor((i+n)/2);e[s]<=t?i=s+1:n=s-1;}return i}async initTemplate(){const t=`<div class="${this.defaultClass}-container"><div class="${this.defaultClass}-container-header"><span class="${this.defaultClass}-count">0 results found</span><div style="display:flex; align-items: center;"><button class="${this.defaultClass}-prev"></button><button class="${this.defaultClass}-next"></button></div></div><div class="${this.defaultClass}-container-body"><div class="${this.defaultClass}-phantom"></div><div class="${this.defaultClass}-content"></div></div></div>`;this.template=t;}}function WS(t){return t.replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]||t)))}i(OS,"cpName","TextSearchResult");class NS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-search"),i(this,"clearBySelf",!1),this.initTemplate(),Jw.registerComponent({TextSearchResult:OS}),this.bindHooks(),this.bindUiEvents();}bindUiEvents(){this.$on("ui_searchToggle",(()=>{this.toggle();})),this.$on("ui_swipeHide",(t=>{t===this.el&&(this.toggle(),this.el.style.height="",this.el.style.top="");}));}toggle(){const t="none"!==getComputedStyle(this.el).display;if(this.el.style.display=t?"none":"flex",this.$emit("ui_searchVisibilityChanged",!t),t)jn()&&(this.el.style.height="",this.el.style.top="",this.$emit("ui_swipeReset",this.el));else {const t=this.el.querySelector(`.${this.defaultClass}-input`);this.injection.viewer.context.isFocusCanvas=!1,t.focus();}}bindHooks(){this.hooks.inserted.on((t=>{var e,i;this.bindEvents(),this.bindViewerHooks();const{options:n}=this.data,{postfix:s}=this.injection.viewer,o=null!==(e=n.defaultCaseSensitive)&&void 0!==e&&e,r=null!==(i=n.defaultWholeWord)&&void 0!==i&&i;o&&(this.el.querySelector(`#ddvCaseSensitive${s}`).checked=o),r&&(this.el.querySelector(`#ddvWholeWord${s}`).checked=r);if(this.injection.viewer.getPageCounts()>0){this.el.querySelector(`.${this.defaultClass}-header`).classList.remove("ddv-button-disabled");}}));}bindViewerHooks(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-header`),i=this.el.querySelector(`.${this.defaultClass}-input`),n=this.el.querySelector(`#ddvCaseSensitive${t.postfix}`),s=this.el.querySelector(`#ddvWholeWord${t.postfix}`);t.hooks.pageExistenceChanged.on((t=>{if(t.pageCount){e.classList.remove("ddv-button-disabled");const t="none"!==getComputedStyle(this.el).display;t&&this.$emit("ui_searchVisibilityChanged",t);}else e.classList.add("ddv-button-disabled"),this.$emit("ui_clearTextSearch"),i.value="";}),this),t.hooks.searchTextCleared.on((t=>{this.clearBySelf||!0!==t&&(this.$emit("ui_clearTextSearch"),i.value="");}),this),t.hooks.searchTextChanged.on((t=>{var e,o;i.value=t.text,n.checked=null===(e=t.searchConfig)||void 0===e?void 0:e.caseSensitive,s.checked=null===(o=t.searchConfig)||void 0===o?void 0:o.wholeWord;}),this);}bindEvents(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-input`),i=this.el.querySelector(`#ddvCaseSensitive${t.postfix}`),n=this.el.querySelector(`#ddvWholeWord${t.postfix}`),s=()=>{const s=e.value;s.length?t.searchFullText(s,{caseSensitive:i.checked,wholeWord:n.checked}):(this.clearBySelf=!0,this.injection.viewer.clearSearchText(),this.$emit("ui_clearTextSearch"),this.clearBySelf=!1);},o=()=>{e.value.length&&(this.clearBySelf=!0,this.injection.viewer.clearSearchText(),this.$emit("ui_clearTextSearch"),this.clearBySelf=!1,s());},r=t=>{var e;!0===(null==this||null===(e=this.injection)||void 0===e||null===(e=e.viewer)||void 0===e||null===(e=e.context)||void 0===e?void 0:e.isFocusCanvas)&&t.ctrlKey&&"f"===t.key&&(t.preventDefault(),this.$emit("ui_searchToggle"));};e.addEventListener("input",s),i.addEventListener("change",o),n.addEventListener("change",o),document.addEventListener("keydown",r),this.hooks.destroyed.on((()=>{document.removeEventListener("keydown",r);}));}initTemplate(){var t,e,i;const{options:n}=this.data,{postfix:s}=this.injection.viewer;fb(vb(this),this.injection.viewer,n),delete n.label,delete n.tooltip;const o=null===(t=n.showCaseSensitive)||void 0===t||t,r=null===(e=n.showWholeWord)||void 0===e||e,a=null===(i=n.enableSwipeForMobile)||void 0===i||i,l=`<div ${Gw(n,this.defaultClass,"")}>`+(jn()&&a?"<SwipeIndicator></SwipeIndicator>":"")+`<div class="${this.defaultClass}-header ddv-button-disabled">`+`<div class="${this.defaultClass}-input-container"><i class="ddv-icon-search"></i>`+`<input type="search" class="${this.defaultClass}-input" /></div>`+`<label ${o?"":'style="display:none"'} for="ddvCaseSensitive${s}" >`+`<input id="ddvCaseSensitive${s}" type="checkbox"/>Case sensitive</label>`+`<label ${r?"":'style="display:"none""'} for="ddvWholeWord${s}" >`+`<input id="ddvWholeWord${s}" type="checkbox"/>Whole word</label></div>`+`<div class="${this.defaultClass}-split-line"></div><TextSearchResult></TextSearchResult></div>`;this.template=l;}}i(NS,"cpName","TextSearchPanel");class _S extends wb{constructor(t){super(t,{class:"ddv-search-switch",callback:()=>{this.$emit("ui_searchToggle");}}),this.bindUiEvents();}bindUiEvents(){const t=jn();this.$on("ui_searchVisibilityChanged",(e=>{this.setUiState(e?"focused":"normal",!t);})),jn()&&this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts()||0;(t||i)&&(this.el.classList.contains("ddv-button-focused")&&this.$emit("ui_searchToggle"),ub(this.el,t));})),cb(this);}}i(_S,"cpName","TextSearchPanelSwitch");class FS extends wb{constructor(t){super(t,{class:"ddv-crop-current",callback:()=>{this.cropEvent();}});}bindDefaultUi(){HS(this);}cropEvent(){const t=this.injection.viewer,e=t.getRectBox(),i=t.getCurrentPageIndex();e&&t.cropPages(e,[i]);}}function HS(t){const e=t.injection.viewer,i=i=>{const n=_n(null==i?void 0:i.pageCount)?e.getPageCounts():i.pageCount,s=e.getRectBox();n&&s?t.setUiState("normal"):t.setUiState("disabled");};t.hooks.inserted.on(i),t.hooks.updated.on(i),e.hooks.pageExistenceChanged.on(i,t),e.hooks.cropRectDrawn.on((e=>{t.setUiState("normal");}),t),e.hooks.cropRectDeleted.on((e=>{t.setUiState("disabled");}),t);}i(FS,"cpName","CropCurrent");class VS extends wb{constructor(t){super(t,{class:"ddv-crop-all",callback:()=>{this.cropEvent();}});}bindDefaultUi(){HS(this);}cropEvent(){const{viewer:t}=this.injection,e=t.getRectBox(),i=t.getCropIndices();e&&t.cropPages(e,i);}}i(VS,"cpName","CropAll");class zS extends wb{constructor(t){super(t,{class:"ddv-perspective",callback:()=>{this.perspectiveEvent();}});}perspectiveEvent(){const{viewer:t}=this.injection;t.perspectiveAllPage();}}i(zS,"cpName","PerspectiveAll");class $S extends wb{constructor(t){super(t,{class:"ddv-full-quad",callback:()=>{this.toggleFull();}}),this.bindViewerHooks();}toggleFull(){const{viewer:t}=this.injection;t.toggleFullPerspective();}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.perspectiveQuadChanged.on((t=>{this.isFocused=t.isFull||!1,this.setUiState(t.isFull?"focused":"normal",!jn());}),this);}}i($S,"cpName","FullQuad");class jS extends wb{constructor(t){super(t,{class:"ddv-redo-page",callback:()=>{this.injection.viewer.redo();}}),this.$on("ui_cropClick",(()=>{const t=this.injection.viewer.getOperationState().redo>0?"normal":"disabled";this.setUiState(t);}));}bindDefaultUi(){XS("redo",this);}}function XS(t,e){const{viewer:i}=e.injection,n=()=>{const n=i.getOperationState(),s=("redo"===t?n.redo:n.undo)>0?"normal":"disabled";e.setUiState(s);};e.hooks.inserted.on(n),e.hooks.updated.on(n);i.hooks.operationsChanged.on((i=>{let n="disabled";n="redo"===t?i.redo>0?"normal":"disabled":i.undo>0?"normal":"disabled",e.setUiState(n);}),e),i.hooks.pageExistenceChanged.on((t=>{0===t.pageCount&&e.setUiState("disabled");}),e);}i(jS,"cpName","Redo");class GS extends wb{constructor(t){super(t,{class:"ddv-restore-page",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.reset(e);}}),db(this);}}i(GS,"cpName","Restore");class YS extends wb{constructor(t){super(t,{class:"ddv-rotate-left",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.rotatePages(-90,[e]);}}),db(this);}}i(YS,"cpName","RotateLeft");class qS extends wb{constructor(t){super(t,{class:"ddv-rotate-right",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.rotatePages(90,[e]);}}),db(this);}}i(qS,"cpName","RotateRight");class JS extends wb{constructor(t){super(t,{class:"ddv-undo-page",callback:()=>{this.injection.viewer.undo();}}),this.$on("ui_cropClick",(()=>{const t=this.injection.viewer.getOperationState().undo>0?"normal":"disabled";this.setUiState(t);}));}bindDefaultUi(){XS("undo",this);}}i(JS,"cpName","Undo");class ZS extends bb{constructor(t){super(t),this.defaultClass="ddv-crop",this.initPullDownBox(),this.initTemplate(),this.initHooks(),this.$on("ui_layoutScroll",(t=>{if(t===this.el.parentElement){gb(this.injection.viewer.rootDom,this.el,this.pullDownBox);}}));}initHooks(){const t=this.injection.viewer;t.hooks.toolModeChanged.on((t=>{const e="crop"===t.newToolMode;this.injection.viewer.getPageCounts()>0&&(this.setUiState(e?"focused":"normal"),this.togglePopup(e),this.isFirstClick&&e&&this.el.click()),this.$emit("ui_cropClick",e),this.$emit("ui_toolModeRefactor");}),this),t.hooks.cropRectDrawn.on((()=>{ub(this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1],!1);}),this),t.hooks.pageChanged.on((()=>{ub(this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1],!this.injection.viewer.getRenderedRectBoxCount());}),this);}bindPullDownBoxEvents(){const{viewer:t}=this.injection,e=this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`),i=this.pullDownBox.getElementsByTagName("input")[1],n=this.pullDownBox.getElementsByTagName("input")[0],s=e.children[0],o=e.children[1],r=()=>{this.togglePopup(!1),t.updateViewerConfig({toolMode:"pan",canvasStyle:{cursor:"default"}});};this.nativeOn(o,"click",(()=>{const e=t.getRectBox(),i=t.getCropIndices();e&&(t.cropPages(e,i),r());})),this.nativeOn(s,"click",r),this.nativeOn(this.el,"click",(()=>{const e=t.rootDom,i=this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1];t.updateViewerConfig({toolMode:"crop"}),this.togglePopup(!0),this.setUiState("focused"),this.$emit("ui_cropClick",!0),this.$emit("ui_toolModeRefactor");ub(i,!t.getRectBox()),this.isFirstClick&&(gb(e,this.el,this.pullDownBox),this.isFirstClick=!1);})),this.nativeOn(i,"change",(()=>{t.cropMode="all";})),this.nativeOn(n,"change",(()=>{t.cropMode="current";}));}bindPopupSwitchEvent(){}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{toolMode:e}=t.getViewerConfig();let i="disabled";t.getPageCounts()>0?("crop"===e&&this.el.click(),i=""===this.pullDownBox.style.display?"focused":"normal"):this.togglePopup(!1),this.setUiState(i);};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){}initTemplate(){const{defaultClass:t}=this,{options:e}=this.data,{popupBox:i}=e,{postfix:n,cropMode:s}=this.injection.viewer,{Crop_CropCurrent:o,Crop_CropAll:r,Crop_CropApply:a,Crop_CropCancel:l}=LC.getDisplayTextConfig(),{Crop_CropCurrent:h,Crop_CropAll:c,Crop_CropApply:d,Crop_CropCancel:u}=sb,p="current"===s?'checked="checked"':"",g="all"===s?'checked="checked"':"";fb(vb(this),this.injection.viewer,e);const f=`<button ${Gw(e,`ddv-button ${t}`)}>`+(_n(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${Gw(i,`${t}-box`)}><div>`+`<input ${p} type="radio" id="${h+n}" name="cropType" value="cropCurrent" />`+`<label for="${h+n}">${o}</label>`+`<input ${g} type="radio" id="${c+n}" name="cropType" value="cropAll" />`+`<label for="${c+n}">${r}</label></div>`+`<div class= "${t}-buttonGroup">`+`<div id="${u+n}"><span>${l}</span></div>`+`<div id="${d+n}"><span>${a}</span></div></div></div></button>`;this.template=f;}}i(ZS,"cpName","Crop");class QS extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-filter-item"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"checkedClass",`${this.cssPrefix}checked`),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.created.on((t=>{this.bindEvents();})),this.hooks.inserted.on((()=>{this.bindFilterEvents();})),this.hooks.destroyed.on((()=>{const t=this.el.getElementsByTagName("img")[0];t.src&&URL.revokeObjectURL(t.src);}));}bindEvents(){const{el:t}=this;this.nativeOn(t,"click",(()=>{if(""===this.el.getElementsByTagName("img")[0].getAttribute("src"))return;const{itemValue:t}=this.data;this.$emit("ui_filterClick",t.type);}));}bindFilterEvents(){this.$on("ui_filterReset",(t=>{this.resetSelect(t.currentFilter);const{filterList:e}=t,{itemValue:i}=this.data,n=this.el.getElementsByTagName("img")[0];n.src&&URL.revokeObjectURL(n.src),e.forEach((t=>{if(t.type===i.type){let e="";t.imageData&&(e=Zn(t.imageData).data),n.src=e;}}));})),this.$on("ui_filterLoading",(t=>{const e=this.el.getElementsByTagName("img")[0],i=this.el.getElementsByTagName("div")[0];e.style.display=t?"none":"",i.style.display=t?"":"none",this.el.style.pointerEvents=t?"none":"";})),this.injection.viewer.hooks.filterChanged.on((t=>{this.resetSelect(t.filterType);}),this);}resetSelect(t){const{itemValue:e}=this.data;t===e.type?this.el.classList.add(this.checkedClass):this.el.classList.remove(this.checkedClass);}initTemplate(){const{options:t,itemValue:e}=this.data,i=`<div ${Gw(t,this.defaultClass)}><img src=""></img><div class="ddv-filter-loading" style="display:none"></div><span>${e.label}</span></div>`;this.template=i;}}const KS=[{type:"none",label:"Original"}];class tC extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-filter"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"isFirstClick",!0),i(this,"box",void 0),i(this,"applyAll",!1),i(this,"filterList",void 0),i(this,"filterUpdateStatus",!1),i(this,"enableFilter",!1),i(this,"uiState","normal"),this.bindHooks(),this.initTemplate(),this.bindDefaultUi(),hb(this);const{filterService:e}=this.injection.viewer.context.core;e.enableFilter&&(this.enableFilter=!0,db(this),this.bindViewerHooks(),this.bindFilterEvents(),this.bindViewerResized()),Jw.registerComponent({FilterItem:QS}),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}list`),this.box.style.display="none",this.box.remove(),this.filterUpdateStatus=!0,this.bindNativeEvents();})),this.hooks.updated.on((()=>{this.uiState="normal";}));}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{box:t}=this,e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:gb(i,this.el,this.box);}),this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.pageChanged.on((async e=>{if(0===e.total)return this.filterUpdateStatus=!0,void this.togglePopup(!1);const i=t.context.getActiveTab();if(!i||!this.box)return;const{currentUid:n,oldCurrentUid:s}=i;s!==n&&(this.filterUpdateStatus=!0,this.togglePopup(!1));}),this),t.hooks.updatePage.on((e=>{var i;const n=t.context.getActiveTab();n&&this.box&&(null===(i=n.getCurrentPage())||void 0===i?void 0:i.uid)===e.pageUid&&(this.filterUpdateStatus=!0,this.togglePopup(!1));}),this),t.hooks.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}bindNativeEvents(){const{el:t,box:e}=this,i=e.querySelector(`.${this.cssPrefix}list-header`),n=i.getElementsByTagName("span")[0],s=i.getElementsByTagName("div")[0];this.nativeOn(t,"click",(async t=>{if(this.togglePopup(),this.isFirstClick){gb(this.injection.viewer.rootDom,this.el,this.box),this.isFirstClick=!1;}})),this.nativeOn(e,"click",(t=>{t.stopPropagation();})),this.nativeOn([n,s],"click",(()=>{if(this.clickApplyToAll(),this.applyAll){const{viewer:t}=this.injection,e=t.getPageCounts(),i=t.getCurrentPageUid(),n=t.context.core.pageService.getPage(i);t.filter(Array.from(Array(e).keys()),n.filter);}}));}bindFilterEvents(){this.$on("ui_filterClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts();if(i<1)return;let n=Array.from(Array(i).keys());if(!this.applyAll){const i=e.getCurrentPageUid();if(e.context.core.pageService.getPage(i).filter===t)return;n=[e.getCurrentPageIndex()];}e.filter(n,t);}));}clickApplyToAll(t){const e=this.injection.viewer,i=sb.Filter_FilterAll+e.postfix,n=document.getElementById(i);if(_n(t))return this.applyAll?n.classList.remove(`${this.cssPrefix}checked`):n.classList.add(`${this.cssPrefix}checked`),void(this.applyAll=!this.applyAll);t?n.classList.add(`${this.cssPrefix}checked`):n.classList.remove(`${this.cssPrefix}checked`),this.applyAll=t;}async updateFilterPreview(){const t=this.injection.viewer,e=t.getCurrentPageUid(),i=await t.context.core.imageDataService.getOriginal(e);if(!i)return;this.$emit("ui_filterLoading",!0);const n=[],s=t.context.core.pageService.getPage(e);let o;try{o=await t.context.core.processService.resize(i.data,3,i.width,i.height,200);}catch(t){}for(let e=0;e<this.filterList.length;e++){const s=this.filterList[e];if("none"===s.type)n.push({type:"none",imageData:i.data});else {let e;try{var r;o&&null!==(r=o)&&void 0!==r&&r.data&&(e=await t.context.core.filterService.applyFilter({data:o.data,type:co.JPEG,width:o.width,height:o.height},s.type));}catch(t){e=null;}n.push({type:s.type,imageData:e});}}this.$emit("ui_filterLoading",!1),this.$emit("ui_filterReset",{currentFilter:s.filter||"none",filterList:n}),this.filterUpdateStatus=!1;}initTemplate(){var t;const e=this.data,{options:i}=e,{popupBox:n,filterHeader:s,filterContent:o,valueList:r}=i,{filterService:a}=this.injection.viewer.context.core,l=sb.Filter_FilterAll+this.injection.viewer.postfix;fb(vb(this),this.injection.viewer,i);const h=(null===(t=LC.getDisplayTextConfig())||void 0===t?void 0:t.Filter_FilterAll)||"Apply to All";e.valueList=r||KS,a.enableFilter&&(e.valueList=a.getSupportedFilters()),this.filterList=e.valueList;const c=`<button ${Gw(i,`ddv-button ${this.defaultClass}`)}>`+(_n(null==i?void 0:i.label)?"":`<span>${i.label}</span>`)+'<i class="ddv-down-arrow"></i>'+`<div ${Gw(n,this.cssPrefix,"list")}>`+`<div id="${l}"`+`${Gw(s,this.cssPrefix,"list-header")}><div></div>`+`<span>${h}</span></div>`+`<div ${Gw(o,this.cssPrefix,"list-content")}><FilterItem :for="item in valueList":options="options.filterItem" :itemValue="item"></FilterItem></div></div></button>`;this.template=c;}async togglePopup(t){const{box:e}=this,{viewer:i}=this.injection;let n="none"===e.style.display;n=_n(t)?!n:!t,n?e.remove():(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e),this.filterUpdateStatus&&this.updateFilterPreview()),pb(this.el,!n),e.style.display=n?"none":"";}bindDefaultUi(){const t=this.injection.viewer,e=()=>{let e="normal";0!==t.getPageCounts()&&this.enableFilter||(e="disabled"),yb(this,e);};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(tC,"cpName","Filter");class eC extends wb{constructor(t){super(t,{class:"ddv-button-blank",callback:()=>{}});}bindDefaultUi(){}}class iC extends wb{constructor(t){super(t,{class:"ddv-button-close",callback:()=>{}});}bindDefaultUi(){}}i(iC,"cpName","Close");class nC extends wb{constructor(t){super(t,{class:"ddv-button-back",callback:()=>{}});}bindDefaultUi(){}}i(nC,"cpName","Back");class sC extends wb{constructor(t){super(t,{class:"ddv-button-done",callback:()=>{}});}bindDefaultUi(){}}i(sC,"cpName","Done");const oC=[{displayName:"continuous",className:"ddv-continuous-mode"},{displayName:"single",className:"ddv-single-mode"}];class rC extends Sb{constructor(t){const{DisplayMode_ContinuousPage:e,DisplayMode_SinglePage:i}=LC.getDisplayTextConfig(),{DisplayMode_ContinuousPage:n,DisplayMode_SinglePage:s}=sb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"ContinuousPage",label:e,id:n},{type:"SinglePage",label:i,id:s}],defaultClassName:"ddv-display-mode"},super(t),db(this);}updateUiState(t){const{el:e}=this;oC.forEach(((i,n)=>{t===i.displayName?(e.classList.add(i.className),this.selectChildren(n)):e.classList.remove(i.className);}));}bindDefaultUi(){super.bindDefaultUi();const t=this.injection.viewer,e=()=>{const{displayMode:e}=t.getViewerConfig();this.updateUiState(e);};t.hooks.displayModeChanged.on((t=>{this.updateUiState(t.newDisplayMode);}),this),t.hooks.openDocument.on((()=>{const e=t.context.getActiveTab();e&&this.updateUiState(e.context.displayMode);}),this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(rC,"cpName","DisplayMode");class aC extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{this.injection.viewer.updateViewerConfig({displayMode:e.displayMode});}}),i(this,"displayMode",void 0),this.displayMode=e.displayMode,db(this);}bindDefaultUi(){const t=this.injection.viewer,e=e=>{var i;const n=t.getActiveTab(),s=(null==e?void 0:e.pageCount)||t.getPageCounts(),o=(null==n||null===(i=n.context)||void 0===i?void 0:i.displayMode)||t.getViewerConfig().displayMode;s?o===this.displayMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.displayModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class lC extends aC{constructor(t){super(t,{class:"ddv-continuous-mode",displayMode:"continuous"});}}i(lC,"cpName","ContinuousPage");class hC extends aC{constructor(t){super(t,{class:"ddv-multiple-mode",displayMode:"multiple"});}}i(hC,"cpName","MultiPage");class cC extends aC{constructor(t){super(t,{class:"ddv-single-mode",displayMode:"single"});}}i(cC,"cpName","SinglePage");const dC=[{displayName:"window",className:"ddv-fit-window"},{displayName:"width",className:"ddv-fit-width"},{displayName:"height",className:"ddv-fit-height"},{displayName:"actualSize",className:"ddv-fit-actual"}];class uC extends Sb{constructor(t){const{FitMode_FitWindow:e,FitMode_FitWidth:i,FitMode_FitHeight:n,FitMode_ActualSize:s}=LC.getDisplayTextConfig(),{FitMode_FitWindow:o,FitMode_FitWidth:r,FitMode_FitHeight:a,FitMode_ActualSize:l}=sb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"FitWindow",label:e,id:o},{type:"FitWidth",label:i,id:r},{type:"FitHeight",label:n,id:a},{type:"ActualSize",label:s,id:l}],defaultClassName:"ddv-fit-type"},super(t),db(this);}updateUiState(t){const{el:e}=this;if("none"===t)return this.selectChildren(-1),dC.forEach((t=>{e.classList.remove(t.className);})),void e.classList.add(dC[0].className);dC.forEach(((i,n)=>{t===i.displayName?(e.classList.add(i.className),this.selectChildren(n)):e.classList.remove(i.className);}));}bindDefaultUi(){super.bindDefaultUi();const t=this.injection.viewer,e=()=>{const{fitMode:e}=t.getViewerConfig();this.updateUiState(e);};t.hooks.fitModeChanged.on((t=>{this.updateUiState(t.newFitMode);}),this),t.hooks.openDocument.on((()=>{const e=t.context.getActiveTab();e&&this.updateUiState(e.context.fitMode);}),this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(uC,"cpName","FitMode");class pC extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;t.updateViewerConfig({fitMode:e.fitMode});}}),i(this,"fitMode",void 0),this.fitMode=e.fitMode,db(this);}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const e=t.getPageCounts(),i=t.getActiveTab();let{fitMode:n}=t.getViewerConfig();i&&(n=i.context.fitMode);const s=e>0&&n===this.fitMode;e>0?s?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.fitModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class gC extends pC{constructor(t){super(t,{class:"ddv-fit-height",fitMode:"height"});}}i(gC,"cpName","FitHeight");class fC extends pC{constructor(t){super(t,{class:"ddv-fit-width",fitMode:"width"});}}i(fC,"cpName","FitWidth");class vC extends pC{constructor(t){super(t,{class:"ddv-fit-window",fitMode:"window"});}}i(vC,"cpName","FitWindow");class mC extends pC{constructor(t){super(t,{class:"ddv-fit-actual",fitMode:"actualSize"});}}i(mC,"cpName","ActualSize");class yC extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-main-canvas"),this.initTemplate(),this.bindHooks();}bindHooks(){const{inserted:t}=this.hooks;t.on((()=>{var t;null===(t=this.injection.viewer)||void 0===t||t.context.viewService.bindContainer(this.el);}));}initTemplate(){const{options:t}=this.data;t.id=t.id||`ddvMainView${this.injection.viewer.postfix}`;const e=`<div ${Gw(t,this.defaultClass,"")} ><slot></slot></div>`;this.template=e;}}i(yC,"cpName","MainView");class xC extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-pagination"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"uiState","normal"),i(this,"input",void 0),i(this,"totalSpan",void 0),this.initTemplate(),this.bindHooks(),this.bindDefaultUi();}bindHooks(){this.hooks.created.on((t=>{this.bindEvents(),this.input=this.query(`.${this.cssPrefix}goto`),this.totalSpan=this.query(`.${this.cssPrefix}total`);}));}bindEvents(){const t=this.injection.viewer,e=this.query(`.${this.cssPrefix}goto`);this.nativeOn(e,"input",(t=>{const i=mb(e),n=Math.min(i,this.totalSpan.clientWidth);e.style.width=`${n}px`;})),this.nativeOn(e,"blur",(()=>{const i=t.getPageCounts(),n=t.getCurrentPageIndex();let s=parseInt(e.value,10);Xn(s)?s<1?s=1:s>i&&(s=i):s=n+1,e.value=`${s}`,e.style.width=`${mb(e)}px`,t.gotoPage(s-1);})),this.nativeOn(e,"keydown",(t=>{t.stopPropagation(),"Enter"===t.key&&e.blur();}));}setState(t){this.uiState!==t&&this.el&&("normal"===t?this.el.classList.remove(`${this.cssPrefix}disabled`):this.el.classList.add(`${this.cssPrefix}disabled`),this.uiState=t);}bindDefaultUi(){const t=this.injection.viewer,e=e=>{const i=_n(null==e?void 0:e.total)?t.getPageCounts():null==e?void 0:e.total,n=_n(null==e?void 0:e.current)?t.getCurrentPageIndex():null==e?void 0:e.current;this.setState(i>0?"normal":"disabled"),this.input.value=`${n+1}`,this.totalSpan.innerText=`${i}`,this.input.style.width=`${mb(this.input)}px`;};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on((()=>{this.uiState="normal",e(null);}));}initTemplate(){const{options:t}=this.data,{gotoPage:e,total:i,separator:n}=t,{cssPrefix:s,injection:o,defaultClass:r}=this,{viewer:a}=o,l=a.getCurrentPageIndex()+1,h=a.getPageCounts(),c=`<div ${Gw(t,r,"")}><FirstPage :options="options.firstPage"></FirstPage><PrevPage :options="options.prevPage"></PrevPage><input ${Gw(e,s,"goto")} value="${l}" type="number" ><div ${Gw(n,s,"separator")}></div><span ${Gw(i,s,"total")} >${h}</span><NextPage :options="options.nextPage"></NextPage><LastPage :options="options.lastPage"></LastPage></div>`;this.template=c;}}i(xC,"cpName","Pagination");class wC extends wb{constructor(t,e){super(t,{class:e.class,callback:e.callback}),i(this,"type",void 0),this.type=e.type;}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const e=t.getPageCounts(),i=t.getCurrentPageIndex();let n=!1;switch(this.type){case"previous":case"first":n=e>0&&0!==i;break;case"last":case"next":n=i<e-1;}0===e&&(n=!1),this.setUiState(n?"normal":"disabled");};this.hooks.inserted.on(e),this.hooks.updated.on(e),t.hooks.pageChanged.on(e,this);}}class bC extends wC{constructor(t){super(t,{class:"ddv-first-page",type:"first",callback:()=>{this.injection.viewer.gotoPage(0);}});}}i(bC,"cpName","FirstPage");class SC extends wC{constructor(t){super(t,{class:"ddv-last-page",type:"last",callback:()=>{const t=this.injection.viewer,e=t.getPageCounts();t.gotoPage(e-1);}});}}i(SC,"cpName","LastPage");class CC extends wC{constructor(t){super(t,{class:"ddv-next-page",type:"next",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.gotoPage(e+1);}});}}i(CC,"cpName","NextPage");class PC extends wC{constructor(t){super(t,{class:"ddv-prev-page",type:"previous",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.gotoPage(e-1);}});}}i(PC,"cpName","PrevPage");class TC extends wb{constructor(t){super(t,{class:"ddv-thumbnail-switch",callback:()=>{const{thumbnail:t}=this;if(!t)return;const{visibility:e}=t.getViewerConfig();t.updateViewerConfig({visibility:"visible"===e?"hidden":"visible"});}}),i(this,"thumbnail",void 0),this.injection.viewer.on("thumbnailBind",(t=>{if(this.thumbnail)return;const e=this.injection.viewer.context.core.getViewer(t);e&&(this.thumbnail=e,this.bindThumbnailHooks(e));const{visibility:i}=e.getViewerConfig();this.setUiState("visible"===i?"focused":"normal",!jn());})),this.injection.viewer.hooks.destroy.on((()=>{this.thumbnail=null;}),this);}bindThumbnailHooks(t){t.hooks.visibleChanged.on((t=>{this.setUiState("visible"===t.newVisibility?"focused":"normal",!jn());}),this);}bindDefaultUi(){const t=()=>{if(!this.thumbnail)return;const{visibility:t}=this.thumbnail.getViewerConfig();this.setUiState("visible"===t?"focused":"normal",!jn());};this.injection.viewer.hooks.pageExistenceChanged.on(t,this),this.hooks.updated.on(t);}}i(TC,"cpName","ThumbnailSwitch");class AC extends wb{constructor(t,e){super(t,{class:e.class,callback:()=>{this.injection.viewer.updateViewerConfig({toolMode:e.toolMode});}}),i(this,"toolMode",void 0),this.toolMode=e.toolMode,this.bindViewerHooks();}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{toolMode:e}=t.getViewerConfig();t.getPageCounts()>0?e===this.toolMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.toolModeChanged.on((e=>{const i=e.newToolMode===this.toolMode;t.getPageCounts()>0?i?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");}),this);}}class kC extends AC{constructor(t){super(t,{class:"ddv-pan-mode",toolMode:"pan"});}}i(kC,"cpName","Pan");i(class extends AC{constructor(t){super(t,{class:"ddv-zoom-mode",toolMode:"zoomIn"});}},"cpName","ZoomMode");class EC extends AC{constructor(t){super(t,{class:"ddv-crop-mode",toolMode:"crop"});}}i(EC,"cpName","CropMode");class DC extends AC{constructor(t){super(t,{class:"ddv-text-selection-mode",toolMode:"textSelection"});}}i(DC,"cpName","TextSelectionMode");class RC extends wb{constructor(t){super(t,{class:"ddv-zoom-in",callback:()=>{this.injection.viewer.zoomIn();}}),this.bindViewerHooks(),db(this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.zoomChanged.on((e=>{const{maxZoom:i}=t.getViewerConfig();t.getPageCounts()<1||e.newZoomRatio>=i?this.setUiState("disabled"):this.setUiState("normal");}),this);}}i(RC,"cpName","ZoomIn");class IC extends wb{constructor(t){super(t,{class:"ddv-zoom-out",callback:()=>{this.injection.viewer.zoomOut();}}),this.bindViewerHooks(),db(this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.zoomChanged.on((e=>{const{minZoom:i}=t.getViewerConfig();t.getPageCounts()<1||e.newZoomRatio<=i?this.setUiState("disabled"):this.setUiState("normal");}),this);}}i(IC,"cpName","ZoomOut");class MC extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-zoom-controller"),Jw.registerComponent({ZoomIn:RC,ZoomOut:IC}),this.initTemplate();}initTemplate(){const{options:t}=this.data;fb(vb(this),this.injection.viewer,t);const e=`<div ${Gw(t,this.defaultClass)}><ZoomOut :options:"options.ZoomOut"></ZoomOut><ZoomByPercentage :options:"options.ZoomByPercentage"></ZoomByPercentage><ZoomIn :options:"options.ZoomIn"></ZoomIn></div>`;this.template=e;}}i(MC,"cpName","Zoom");const BC=[10,25,50,75,100,125,150,200,400,800,1600,2400,3200,6400];class UC extends Xw{constructor(t){super(t),i(this,"defaultClass","ddv-zoom-percentage"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"isFirstClick",!0),i(this,"box",void 0),i(this,"uiState","normal"),this.initTemplate(),this.bindHooks(),this.bindDefaultUi(),this.bindViewerHooks(),this.bindViewerResized(),db(this),hb(this),this.hooks.destroyed.on((()=>{this.dispose();})),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}box`),this.box.style.display="none",this.box.remove(),this.bindEvents();})),this.hooks.inserted.on((()=>{const t=this.injection.viewer,{zoom:e}=t.getViewerConfig();this.updateZoom(e),this.updateZoomOption();})),this.hooks.updated.on((()=>{this.uiState="normal",this.box.style.display="none",this.isFirstClick=!0;}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{yb(this,0===t.getPageCounts()?"disabled":"normal"),this.updateZoom(t.getViewerConfig().zoom);};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){const{viewer:t}=this.injection,{hooks:e}=t;e.zoomChanged.on((t=>{this.updateZoom(t.newZoomRatio);}),this),e.visibleChanged.on((e=>{if("hidden"===e.newVisibility)return void this.togglePopup(!1);const{zoom:i}=t.getViewerConfig();this.updateZoom(i);}),this);}bindEvents(){const{el:t,box:e}=this,i=t.querySelector(`.${this.cssPrefix}selector`),n=t.getElementsByTagName("input")[0],s=e.getElementsByTagName("ul")[0];this.nativeOn(i,"click",(()=>{const t=this.injection.viewer.rootDom;this.togglePopup(),this.isFirstClick&&(gb(t,this.el,this.box,!0,!0),this.isFirstClick=!1);})),this.inputEvent(n),this.ulEvent(s);}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{box:t}=this,e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:gb(i,this.el,this.box,!0,!0);}),this);}inputEvent(t){const e=this.injection.viewer,{maxZoom:i,minZoom:n}=e.getViewerConfig();t.value=`${i}`;const s=mb(t);function o(){const s=t.value/100,o=Yn(s,n,i);e.updateViewerConfig({zoom:o});}this.nativeOn(t,"input",(()=>{this.adaptInputWidth(s);})),this.nativeOn(t,"blur",o),this.nativeOn(t,"keydown",(t=>{t.stopPropagation();"Enter"===t.key&&o();}));}ulEvent(t){this.nativeOn(t,"click",(t=>{t.stopPropagation();const{viewer:e}=this.injection,{maxZoom:i,minZoom:n}=e.getViewerConfig(),s=t.target;if("LI"===s.tagName){const t=Yn(s.value,100*n,100*i);e.updateViewerConfig({zoom:t/100});}this.togglePopup(!1);}));}getZoomOptionTemplate(){var t;const e=(null===(t=this.data.options)||void 0===t?void 0:t.valueList)||null,i=this.injection.viewer,{maxZoom:n,minZoom:s}=i.getViewerConfig(),o=On(e)?e:BC,r=s<1e-4?.01:parseFloat((100*s).toFixed(2)),a=Math.floor(100*n);o.push(r,a);const l=Array.from(new Set(o)).sort(((t,e)=>t-e));let h="";return l.forEach((t=>{Xn(t)&&t<=100*n&&t>=100*s&&(h+=`<li value="${t}">${t}%</li>`);})),h}updateZoomOption(){const t=this.getZoomOptionTemplate();this.box.getElementsByTagName("ul")[0].innerHTML=t;}updateZoom(t){const e=this.el.getElementsByTagName("input")[0],i=100*t;if(Number.isInteger(i))e.value=`${i}`;else {let t=i;t=t>=1e3?+t.toFixed(0).toString():t>=100?+t.toFixed(1).toString():t>=10?+t.toFixed(2).toString():+t.toFixed(3).toString(),e.value=`${t}`;}this.adaptInputWidth();}initTemplate(){const{options:t={}}=this.data,{input:e,selector:i,popupBox:n}=t,{cssPrefix:s}=this,{viewer:o}=this.injection;fb(vb(this),o,t);const r=`<div ${Gw(t,this.defaultClass)}><div style="display: flex"><div ${Gw(e,s,"input")}><input type="number"><span>%</span></div><button ${Gw(i,s,"selector")}></button></div><div ${Gw({id:`ddvZoomByPercentageSelectBox${o.postfix}`,...n},s,"box")}><ul></ul></div></div>`;this.template=r;}adaptInputWidth(t){const e=this.el.getElementsByTagName("input")[0];let i=mb(e);t&&i>t&&(i=t),e.style.width=`${i}px`;}togglePopup(t){const{viewer:e}=this.injection,{box:i}=this;let n="none"!==i.style.display;n=_n(t)?!n:t,n?(this.$emit("ui_hidePopup",this),e.rootDom.appendChild(i)):i.remove(),i.style.display=n?"":"none";}}i(UC,"cpName","ZoomByPercentage");class LC{static getTooltip(){return this.tooltip}static setTooltip(t){this.tooltip={...this.tooltip,...t};}static getDisplayTextConfig(){return this.displayTextConfig}static setDisplayTextConfig(t){this.displayTextConfig={...this.displayTextConfig,...t};}static registerAll(){Jw.registerComponent({Capture:bS,Flashlight:SS,CameraConvert:CS,CameraResolution:TS,AutoDetect:wS,AutoCapture:xS,ImagePreview:AS,RotateLeft:YS,RotateRight:qS,Delete:BS,DeleteAll:ES,DeleteCurrent:DS,Zoom:MC,ZoomIn:RC,ZoomOut:IC,ZoomByPercentage:UC,PerspectiveAll:zS,FullQuad:$S,Restore:GS,Undo:JS,Redo:jS,FitMode:uC,FitWidth:fC,FitHeight:gC,FitWindow:vC,ActualSize:mC,DisplayMode:rC,SinglePage:cC,MultiPage:hC,ContinuousPage:lC,Pan:kC,Print:US,Filter:tC,ThumbnailSwitch:TC,Back:nC,Done:sC,Pagination:xC,FirstPage:bC,LastPage:SC,NextPage:CC,PrevPage:PC,Root:eb,Layout:Qw,Button:Zw,SwipeIndicator:nb,MainView:yC,Load:kS,Download:MS,Close:iC,Blank:eC,SeparatorLine:ib,PasswordLoader:LS,TextSearchPanel:NS,TextSearchPanelSwitch:_S,CropCurrent:FS,CropAll:VS,CropMode:EC,Crop:ZS,AnnotationSet:Fb,EllipseAnnotation:Tb,EraseAnnotation:Ab,InkAnnotation:kb,LineAnnotation:Eb,PolygonAnnotation:Db,PolylineAnnotation:Rb,RectAnnotation:Ib,SelectAnnotation:Mb,StampIconAnnotation:Bb,StampImageAnnotation:Ub,TextBoxAnnotation:Lb,TextTypewriterAnnotation:Ob,HighlightAnnotation:Wb,UnderlineAnnotation:Nb,StrikeoutAnnotation:_b,BasePullDownButton:bb,PullDownListButton:Sb,PullDownMenuButton:Cb,BringForward:zb,BringToFront:$b,SendBackward:jb,SendToBack:Xb,TextSelectionMode:DC,AnnotationToolBar:Gb,AnnotationDeleteButton:Zb,AnnotationPaletteButton:Jb,AnnotationPalette:dS,AnnotationCustomStampPanel:pS,HighlightCreateButton:fS,StrikeoutCreateButton:vS,UnderlineCreateButton:mS,TextCopyButton:yS});}}i(LC,"tooltip",{}),i(LC,"displayTextConfig",{FitMode_FitWidth:"Fit Width",FitMode_FitHeight:"Fit Height",FitMode_FitWindow:"Fit Window",FitMode_ActualSize:"Actual Size",DisplayMode_SinglePage:"Single Page",DisplayMode_ContinuousPage:"Continuous Page",Crop_CropAll:"Crop All",Crop_CropCurrent:"Crop Current",Crop_CropCancel:"Cancel",Crop_CropApply:"Apply",Filter_FilterAll:"Apply to All",Delete_DeleteCurrent:"Delete current",Delete_DeleteAll:"Delete all",CameraResolution_720P:"720P",CameraResolution_1080P:"1080P",CameraResolution_1440P:"1440P",CameraResolution_2160P:"2160P"});const OC={install(t){const e=function(t){var e,o,r,a;return e=new WeakMap,o=new WeakMap,r=new WeakMap,a=new WeakSet,class extends t{constructor(t){super(t),v(this,a),i(this,"ui",void 0),i(this,"rootDom",void 0),i(this,"popupConfig",null),f(this,e,{writable:!0,value:!1}),f(this,o,{writable:!0,value:0}),f(this,r,{writable:!0,value:0}),LC.registerAll();const{popupConfig:n}=t,s=t.viewerConfig.enablePopup?this.getPopupUiConfig({annotationToolBarConfig:(null==n?void 0:n.annotationToolBarConfig)||{},annotationPaletteConfig:(null==n?void 0:n.annotationPaletteConfig)||{},annotationCustomStampPanelConfig:(null==n?void 0:n.annotationCustomStampPanelConfig)||{},passwordLoaderConfig:(null==n?void 0:n.passwordLoaderConfig)||{}}):[];this.popupConfig=null==t?void 0:t.popupConfig,this.ui=new Jw({container:t.container,emitter:this.emitter,postfix:this.uid,uiConfig:t.uiConfig,popupUiConfig:s,injection:{viewer:this}}),t.container&&(t.uiConfig?(this.bindContainer(t.container),this.rootDom=this.ui.rootDom):this.rootDom=this.context.viewService.rootDom),this.listenNativeEventsForUi();}listenNativeEventsForUi(){this.on("click",(()=>{this.emit("ui_hidePopup","viewer");}));}getPopupUiConfig(t){const e={enabled:!0,isPaletteEnabled:!0,...t.annotationToolBarConfig,type:"AnnotationToolBar"},i={enabled:!0,colorList:["#F01314","#FD7C10","#FFEE5F","#07C37F","#0E68F5","#9D3BFE","#000000","#FF9494","#87440C","#B7A514","#046743","#50C9FF","#EBA3ED","#FFFFFF","#CECECE"],enableChangeColor:!0,enableDrag:!0,autoDisplay:!0,enableCustomStamp:!1,...t.annotationPaletteConfig,type:"AnnotationPalette"},n={labels:{stampText:"Stamp Text",fontStyle:"Font Style",textColor:"TextColor",backgroundColor:"Background",borderColor:"BorderColor",timeStampText:"Timestamp Text",userName:"Username",date:"Date",time:"Time",create:"Create"},colorList:["#fdcccc","#f7fc7b","#c7d2e4","#d6e4cd","#910f05","#d5b142","#182564","#416a1c","#ffffff","#000000"],enabled:!1,autoDisplay:!0,...t.annotationCustomStampPanelConfig,type:"AnnotationCustomStampPanel"},s={enabled:!0,...t.passwordLoaderConfig,type:"PasswordLoader"},o=[],r="default"===this.getViewerConfig().viewerMode;return e.enabled&&r&&o.push(e),i.enabled&&r?o.push(i):e.isPaletteEnabled=!1,n.enabled&&r&&o.push(n),s.enabled&&o.push(s),o}addFontToUi(t){this.emit("ui_addFont",t);}toggleUiPopup(t,e){this.ui.emit("ui_changePalette_visible",t,e);}getUiConfig(){return Nn(this.ui.uiConfig)}updateUiConfig(t){const{resizeService:i}=this.context.core;i&&(i.unobserve(this.ui.rootDom),s(this,e,!1));const n=this.ui.updateUiConfig(t);return this.rootDom=this.ui.rootDom,this.context.viewService.rootDom=this.rootDom,p(this,a,l).call(this,this.ui.rootDom),n}getElementsByType(t){return Gn(t)?this.ui.getElementsByType(this.ui.rootVNode,t):""}bindContainer(t){let e=t;return Gn(t)&&(e=document.querySelector(`#${t}`)),e instanceof HTMLElement&&(p(this,a,l).call(this,this.ui.rootDom),this.ui.bindContainer(e),this.context.viewService.container=e,this.context.viewService.rootDom=this.ui.rootDom,this.rootDom=this.ui.rootDom,"hidden"===this.context.viewerConfig.visibility&&(this.context.viewService.rootDom.style.display="none"),this.context.viewService.isBindContainer=!0,!0)}unbindContainer(){this.rootDom&&this.ui.container&&(this.ui.unbindContainer(),this.context.viewService.container=null,this.context.viewService.isBindContainer=!1);}dispose(){var t;super.dispose(),null===(t=this.ui)||void 0===t||t.dispose();}};function l(t){if(n(this,e))return;const{resizeService:i}=this.context.core;i.observe(t),this.register(i.onResizeObserver.on((e=>{if(e.target===t){var i;let a=0,l=0;if((null===(i=e.borderBoxSize)||void 0===i?void 0:i.length)>0){const t=e.borderBoxSize[0];a=t.inlineSize,l=t.blockSize;}else a=t.offsetWidth,l=t.offsetHeight;const h=mf.create(n(this,o),n(this,r),a,l);s(this,o,a),s(this,r,l),this.hooks.resize.emit(h);}}))),this.hooks.destroy.on((()=>{i.unobserve(t);}),this),s(this,e,!0);}}(t.getClass("Viewer"));t.setClass("Viewer",e);}};function WC(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function NC(t,e,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===n?s.call(t,i):s?s.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;const _C="undefined"==typeof self;let FC,HC,VC,zC,$C;function jC(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function XC(t,e,i,n,s){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===n?s.call(t,i):s?s.value=i:e.set(t,i),i}"undefined"!=typeof navigator&&(FC=navigator,HC=FC.userAgent,VC=FC.platform,zC=FC.mediaDevices),function(){if(!_C){const t={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:FC.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},e={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:VC,search:"Win"},Mac:{str:VC},Linux:{str:VC}};let i="unknownBrowser",n=0,s="unknownOS";for(let e in t){const s=t[e]||{};let o=s.str||HC,r=s.search||e,a=s.verStr||HC,l=s.verSearch||e;if(l instanceof Array||(l=[l]),-1!=o.indexOf(r)){i=e;for(let t of l){let e=a.indexOf(t);if(-1!=e){n=parseFloat(a.substring(e+t.length+1));break}}break}}for(let t in e){const i=e[t]||{};let n=i.str||HC,o=i.search||t;if(-1!=n.indexOf(o)){s=t;break}}"Linux"==s&&-1!=HC.indexOf("Windows NT")&&(s="HarmonyOS"),$C={browser:i,version:n,OS:s};}_C&&($C={browser:"ssr",version:0,OS:"ssr"});}(),zC&&zC.getUserMedia,"Chrome"===$C.browser&&$C.version>66||"Safari"===$C.browser&&$C.version>13||"OPR"===$C.browser&&$C.version>43||"Edge"===$C.browser&&$C.version,"function"==typeof SuppressedError&&SuppressedError;class GC{static multiply(t,e){const i=[];for(let n=0;n<3;n++){const s=e.slice(3*n,3*n+3);for(let e=0;e<3;e++){const n=[t[e],t[e+3],t[e+6]].reduce(((t,e,i)=>t+e*s[i]),0);i.push(n);}}return i}static identity(){return [1,0,0,0,1,0,0,0,1]}static translate(t,e,i){return GC.multiply(t,[1,0,0,0,1,0,e,i,1])}static rotate(t,e){var i=Math.cos(e),n=Math.sin(e);return GC.multiply(t,[i,-n,0,n,i,0,0,0,1])}static scale(t,e,i){return GC.multiply(t,[e,0,0,0,i,0,0,0,1])}}var YC,qC,JC,ZC,QC,KC,tP,eP,iP;!function(t){t.GREY="grey",t.GREY32="grey32",t.RGBA="rgba",t.RBGA="rbga",t.GRBA="grba",t.GBRA="gbra",t.BRGA="brga",t.BGRA="bgra";}(YC||(YC={}));class nP{static get version(){return "1.1.0"}static checkWebGLSupport(){return null===document.createElement("canvas").getContext("webgl")?(XC(nP,qC,!1,"f",JC),!1):(XC(nP,qC,!0,"f",JC),!0)}get disposed(){return jC(this,iP,"f")}constructor(){ZC.set(this,YC.RGBA),QC.set(this,null),KC.set(this,null),tP.set(this,null),this.useWebGLByDefault=!0,this._reusedCvs=null,this._reusedWebGLCvs=null,eP.set(this,null),iP.set(this,!1);}drawImage(t,e,i,n,s,o){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!i||!n)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==jC(nP,qC,"f",JC)&&nP.checkWebGLSupport(),(null==o?void 0:o.bUseWebGL)&&!jC(nP,qC,"f",JC))throw new Error("Your browser or machine may not support WebGL.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let r;nP._onLog&&(r=Date.now(),nP._onLog("drawImage(), START: "+r));let a=0,l=0,h=i,c=n,d=0,u=0,p=i,g=n;s&&(s.sx&&(a=Math.round(s.sx)),s.sy&&(l=Math.round(s.sy)),s.sWidth&&(h=Math.round(s.sWidth)),s.sHeight&&(c=Math.round(s.sHeight)),s.dx&&(d=Math.round(s.dx)),s.dy&&(u=Math.round(s.dy)),s.dWidth&&(p=Math.round(s.dWidth)),s.dHeight&&(g=Math.round(s.dHeight)));let f,v=YC.RGBA;if((null==o?void 0:o.pixelFormat)&&(v=o.pixelFormat),(null==o?void 0:o.bufferContainer)&&(f=o.bufferContainer,f.length<4*p*g))throw new Error("Unexpected size of the 'bufferContainer'.");const m=t;if(!jC(nP,qC,"f",JC)||!(this.useWebGLByDefault&&null==(null==o?void 0:o.bUseWebGL)||(null==o?void 0:o.bUseWebGL))){nP._onLog&&nP._onLog("drawImage() in context2d."),m.ctx2d||(m.ctx2d=m.getContext("2d",{willReadFrequently:!0}));const t=m.ctx2d;if(!t)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return (m.width<d+p||m.height<u+g)&&(m.width=d+p,m.height=u+g),t.drawImage(e,a,l,h,c,d,u,p,g),nP._onLog&&nP._onLog("drawImage() in context2d end. Costs: "+(Date.now()-r)),{context:t,pixelFormat:YC.RGBA,bUseWebGL:!1}}nP._onLog&&nP._onLog("drawImage() in WebGL.");try{(m.width<d+p||m.height<u+g)&&(m.width=d+p,m.height=u+g,m.ctxWebGL&&m.ctxWebGL.viewport(0,0,d+p,u+g));const t=m.ctxWebGL||m.getContext("webgl",{antialias:!1})||m.getContext("experimental-webgl",{antialias:!1});if(!t){nP._onLog&&nP._onLog("Browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");const t=new Error("Unable to get 'WebGLRenderingContext'. Your browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");throw t.name="WebGLError",t}if(!m.ctxWebGL||v!==jC(this,ZC,"f")){m.ctxWebGL=t;const e=t=>{const e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW);const i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW),{positions:e,texCoords:i}},i=t=>{const e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e},n=(t,e)=>{const i=t.createProgram();if(e.forEach((e=>t.attachShader(i,e))),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=new Error(`An error occured linking the program: ${t.getProgramInfoLog(i)}.`);throw e.name="WebGLError",e}return t.useProgram(i),i},s=(t,e,i)=>{const n=t.createShader(e);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const e=new Error(`An error occured compiling the shader: ${t.getShaderInfoLog(n)}.`);throw e.name="WebGLError",e}return n},o="\n                  attribute vec2 a_position;\n                  attribute vec2 a_texCoord;\n  \n                  uniform mat3 u_matrix;\n                  uniform mat3 u_textureMatrix;\n  \n                  varying vec2 v_texCoord;\n                  void main(void) {\n                  gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                  v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                  }\n              ";let r="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(v)&&(r=v.slice(0,3));const a=`\n                  precision mediump float;\n                  varying vec2 v_texCoord;\n                  uniform sampler2D u_image;\n                  uniform float uColorFactor;\n  \n                  void main() {\n                      vec4 sample = texture2D(u_image, v_texCoord);\n                      float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                      gl_FragColor = vec4(sample.${r} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                  }\n              `,l=n(t,[s(t,t.VERTEX_SHADER,o),s(t,t.FRAGMENT_SHADER,a)]);XC(this,KC,{program:l,attribLocations:{vertexPosition:t.getAttribLocation(l,"a_position"),texPosition:t.getAttribLocation(l,"a_texCoord")},uniformLocations:{uSampler:t.getUniformLocation(l,"u_image"),uColorFactor:t.getUniformLocation(l,"uColorFactor"),uMatrix:t.getUniformLocation(l,"u_matrix"),uTextureMatrix:t.getUniformLocation(l,"u_textureMatrix")}},"f"),XC(this,tP,e(t),"f"),XC(this,QC,i(t),"f"),XC(this,ZC,v,"f");}const s=(t,e,i)=>{t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0);},o=(t,e,i)=>{const n=t.RGBA,s=t.RGBA,o=t.UNSIGNED_BYTE;t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,n,s,o,i);},y=(t,e,o,r)=>{t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),s(t,o.positions,e.attribLocations.vertexPosition),s(t,o.texCoords,e.attribLocations.texPosition),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r),t.uniform1i(e.uniformLocations.uSampler,0),t.uniform1f(e.uniformLocations.uColorFactor,[YC.GREY,YC.GREY32].includes(v)?1:0);let f,m,y=GC.translate(GC.identity(),-1,-1);y=GC.scale(y,2,2),y=GC.scale(y,1/t.canvas.width,1/t.canvas.height),f=GC.translate(y,d,u),f=GC.scale(f,p,g),t.uniformMatrix3fv(e.uniformLocations.uMatrix,!1,f),m=GC.translate(GC.identity(),a/i,l/n),m=GC.scale(m,h/i,c/n),t.uniformMatrix3fv(e.uniformLocations.uTextureMatrix,!1,m),t.drawArrays(t.TRIANGLES,0,6);};o(t,jC(this,QC,"f"),e),y(t,jC(this,KC,"f"),jC(this,tP,"f"),jC(this,QC,"f"));const x=f||new Uint8Array(4*p*g);if(t.readPixels(d,u,p,g,t.RGBA,t.UNSIGNED_BYTE,x),255!==x[3]){nP._onLog&&nP._onLog("Incorrect WebGL drawing .");const t=new Error("WebGL error: incorrect drawing.");throw t.name="WebGLError",t}return nP._onLog&&nP._onLog("drawImage() in WebGL end. Costs: "+(Date.now()-r)),{context:t,pixelFormat:v===YC.GREY?YC.GREY32:v,bUseWebGL:!0}}catch(r){if(this.forceLoseContext(),null==(null==o?void 0:o.bUseWebGL))return nP._onLog&&nP._onLog("'drawImage()' in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.drawImage(t,e,i,n,s,Object.assign({},o,{bUseWebGL:!1}));throw r.name="WebGLError",r}}readCvsData(t,e,i){if(!(t instanceof CanvasRenderingContext2D||t instanceof WebGLRenderingContext))throw new Error("Invalid 'context'.");let n,s=0,o=0,r=t.canvas.width,a=t.canvas.height;if(e&&(e.x&&(s=e.x),e.y&&(o=e.y),e.width&&(r=e.width),e.height&&(a=e.height)),(null==i?void 0:i.length)<4*r*a)throw new Error("Unexpected size of the 'bufferContainer'.");if(t instanceof WebGLRenderingContext){const e=t;i?(e.readPixels(s,o,r,a,e.RGBA,e.UNSIGNED_BYTE,i),n=new Uint8Array(i.buffer,0,4*r*a)):(n=new Uint8Array(4*r*a),e.readPixels(s,o,r,a,e.RGBA,e.UNSIGNED_BYTE,n));}else if(t instanceof CanvasRenderingContext2D){let e;e=t.getImageData(s,o,r,a),n=new Uint8Array(e.data.buffer),null==i||i.set(n);}return n}transformPixelFormat(t,e,i,n){let s,o;if(nP._onLog&&(s=Date.now(),nP._onLog("transformPixelFormat(), START: "+s)),e===i)return nP._onLog&&nP._onLog("transformPixelFormat() end. Costs: "+(Date.now()-s)),n?new Uint8Array(t):t;const r=[YC.RGBA,YC.RBGA,YC.GRBA,YC.GBRA,YC.BRGA,YC.BGRA];if(r.includes(e))if(i===YC.GREY){o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e/4]=i;}}else if(i===YC.GREY32){o=n?new Uint8Array(t):t;for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e]=i,o[e+1]=i,o[e+2]=i;}}else {if(!r.includes(i))throw new Error("Unable to transform.");if(n){o=new Uint8Array(t);const n=e.indexOf("r"),s=e.indexOf("g"),r=e.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let e=0;e<t.length;e+=4)o[e+a]=t[e+n],o[e+l]=t[e+s],o[e+h]=t[e+r];}else {o=t;const n=e.indexOf("r"),s=e.indexOf("g"),r=e.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let e=0;e<t.length;e+=4){let i=[t[e],t[e+1],t[e+2]];o[e+a]=i[n],o[e+l]=i[s],o[e+h]=i[r];}}}else if(e===YC.GREY){if(i!==YC.GREY32)throw new Error("Unable to transform.");o=new Uint8Array(4*t.length);for(let e=0;e<t.length;e++)o[4*e]=t[e],o[4*e+1]=t[e],o[4*e+2]=t[e],o[4*e+3]=255;}else {if(e!==YC.GREY32)throw new Error("Unable to transform.");if(i!==YC.GREY)throw new Error("Unable to transform.");o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4)o[e/4]=t[e];}return nP._onLog&&nP._onLog("transformPixelFormat() end. Costs: "+(Date.now()-s)),o}getImageData(t,e,i,n,s){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!e||!i)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==jC(nP,qC,"f",JC)&&nP.checkWebGLSupport(),(null==s?void 0:s.bUseWebGL)&&!jC(nP,qC,"f",JC))throw new Error("Your browser or machine may not support WebGL.");if(n.sx>e||n.sy>i||n.sx+n.sWidth>e||n.sy+n.sHeight>i)throw new Error("Invalid position.");if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let o;nP._onLog&&(o=Date.now(),nP._onLog("getImageData(), START: "+o));const r=Math.round(n.sx),a=Math.round(n.sy),l=Math.round(n.sWidth),h=Math.round(n.sHeight),c=Math.round(n.dWidth),d=Math.round(n.dHeight);let u=YC.RGBA;(null==s?void 0:s.pixelFormat)&&(u=s.pixelFormat);let p,g,f,v=null;if((null==s?void 0:s.bufferContainer)&&(v=s.bufferContainer),jC(nP,qC,"f",JC)&&(this.useWebGLByDefault&&null==(null==s?void 0:s.bUseWebGL)||(null==s?void 0:s.bUseWebGL))){nP._onLog&&nP._onLog("getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),p=this._reusedWebGLCvs;try{if(v)if(u===YC.GREY){if(f=new Uint8Array(4*c*d),g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:f}),f=this.transformPixelFormat(f,g.pixelFormat,u),v){if(v.length<f.length)throw new Error("Unexpected size of the 'bufferContainer'.");v.set(f);}}else g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:v}),f=new Uint8Array(v.buffer,0,4*c*d),f=this.transformPixelFormat(f,g.pixelFormat,u);else u===YC.GREY?((!jC(this,eP,"f")||jC(this,eP,"f").length<4*c*d)&&XC(this,eP,new Uint8Array(4*c*d),"f"),f=new Uint8Array(jC(this,eP,"f").buffer,0,4*c*d)):f=new Uint8Array(4*c*d),g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:f}),f=this.transformPixelFormat(f,g.pixelFormat,u);}catch(n){if("WebGLError"===n.name&&(this.forceLoseContext(),null==(null==s?void 0:s.bUseWebGL)))return nP._onLog&&nP._onLog("getImageData() in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.getImageData(t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},Object.assign({},s,{bUseWebGL:!1}));throw n}}else if(nP._onLog&&nP._onLog("getImageData() in context2d."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),p=this._reusedCvs,g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:YC.RGBA,bUseWebGL:!1}),f=this.readCvsData(g.context,{width:c,height:d},null),f=this.transformPixelFormat(f,g.pixelFormat,u),v){if(v.length<f.length)throw new Error("Unexpected size of the 'bufferContainer'.");v.set(f);}return nP._onLog&&nP._onLog("getImageData() end. Costs: "+(Date.now()-o)),{data:f,pixelFormat:u,width:c,height:d,bUseWebGL:g.bUseWebGL}}convertDataToCvs(t,e,i,n){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new TypeError("Invalid 'data'.");if("number"!=typeof e||e<=0)throw new Error("Invalid 'width'.");if("number"!=typeof i||i<=0)throw new Error("Invalid 'height'.");const s=document.createElement("canvas");let o;if(s.width=e,s.height=i,n===YC.GREY){o=new Uint8ClampedArray(4*e*i);for(let e=0;e<o.length;e+=4)o[e]=t[e/4],o[e+1]=t[e/4],o[e+2]=t[e/4],o[e+3]=255;}else o=new Uint8ClampedArray(t.buffer);const r=new ImageData(o,e,i);return s.getContext("2d").putImageData(r,0,0),s}forceLoseContext(){if(!this._reusedWebGLCvs)return;const t=this._reusedWebGLCvs.ctxWebGL;t&&!t.isContextLost()&&t.getExtension("WEBGL_lose_context")&&t.getExtension("WEBGL_lose_context").loseContext(),XC(this,QC,null,"f"),XC(this,KC,null,"f"),XC(this,tP,null,"f"),this._reusedWebGLCvs=null;}dispose(){this.forceLoseContext(),XC(this,iP,!0,"f");}}qC=nP,ZC=new WeakMap,QC=new WeakMap,KC=new WeakMap,tP=new WeakMap,eP=new WeakMap,iP=new WeakMap,JC={value:void 0};var sP,oP,rP,aP,lP,hP,cP,dP,uP,pP,gP,fP,vP,mP,yP,xP,wP,bP,SP,CP,PP,TP,AP,kP,EP,DP,RP,IP,MP,BP,UP,LP,OP,WP,NP,_P,FP,HP,VP,zP,$P,jP,XP;class GP{constructor(){sP.set(this,new Map),oP.set(this,!1);}get disposed(){return WC(this,oP,"f")}on(t,e){t=t.toLowerCase();const i=WC(this,sP,"f").get(t);if(i){if(i.includes(e))return;i.push(e);}else WC(this,sP,"f").set(t,[e]);}off(t,e){t=t.toLowerCase();const i=WC(this,sP,"f").get(t);if(!i)return;const n=i.indexOf(e);-1!==n&&i.splice(n,1);}offAll(t){t=t.toLowerCase();const e=WC(this,sP,"f").get(t);e&&(e.length=0);}fire(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{async:!1,copy:!0};e||(e=[]),t=t.toLowerCase();const n=WC(this,sP,"f").get(t);if(n&&n.length){i=Object.assign({async:!1,copy:!0},i);for(let t of n){if(!t)continue;let s=[];if(i.copy)for(let t of e){try{t=JSON.parse(JSON.stringify(t));}catch(t){}s.push(t);}else s=e;let o=!1;if(i.async)setTimeout((()=>{this.disposed||n.includes(t)&&t.apply(i.target,s);}),0);else try{o=t.apply(i.target,s);}catch(t){}if(!0===o)break}}}dispose(){NC(this,oP,!0,"f");}}sP=new WeakMap,oP=new WeakMap;const YP=(t,e,i,n)=>{if(!i)return t;let s=e+Math.round((t-e)/i)*i;return n&&(s=Math.min(s,n)),s};class qP{static get version(){return "2.0.12"}static isStorageAvailable(t){let e;try{e=window[t];const i="__storage_test__";return e.setItem(i,i),e.removeItem(i),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&e&&0!==e.length}}static findBestRearCameraInIOS(t,e){if(!t||!t.length)return null;let i=!1;if((null==e?void 0:e.getMainCamera)&&(i=!0),i){const e=["후면 카메라","背面カメラ","後置鏡頭","后置相机","กล้องด้านหลัง","बैक कैमरा","الكاميرا الخلفية","מצלמה אחורית","камера на задней панели","задня камера","задна камера","артқы камера","πίσω κάμερα","zadní fotoaparát","zadná kamera","tylny aparat","takakamera","stražnja kamera","rückkamera","kamera på baksidan","kamera belakang","kamera bak","hátsó kamera","fotocamera (posteriore)","câmera traseira","câmara traseira","cámara trasera","càmera posterior","caméra arrière","cameră spate","camera mặt sau","camera aan achterzijde","bagsidekamera","back camera","arka kamera"],i=t.find((t=>e.includes(t.label.toLowerCase())));return null==i?void 0:i.deviceId}{const e=["후면","背面","後置","后置","านหลัง","बैक","خلفية","אחורית","задняя","задней","задна","πίσω","zadní","zadná","tylny","trasera","traseira","taka","stražnja","spate","sau","rück","posteriore","posterior","hátsó","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"],i=["트리플","三镜头","三鏡頭","トリプル","สาม","ट्रिपल","ثلاثية","משולשת","үштік","тройная","тройна","потроєна","τριπλή","üçlü","trójobiektywowy","trostruka","trojný","trojitá","trippelt","trippel","triplă","triple","tripla","tiga","kolmois","ba camera"],n=["듀얼 와이드","雙廣角","双广角","デュアル広角","คู่ด้านหลังมุมกว้าง","ड्युअल वाइड","مزدوجة عريضة","כפולה רחבה","қос кең бұрышты","здвоєна ширококутна","двойная широкоугольная","двойна широкоъгълна","διπλή ευρεία","çift geniş","laajakulmainen kaksois","kép rộng mặt sau","kettős, széles látószögű","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka široka","duální širokoúhlý","duálna širokouhlá","dupla grande-angular","dublă","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],s=t.filter((t=>{const i=t.label.toLowerCase();return e.some((t=>i.includes(t)))}));if(!s.length)return null;const o=s.find((t=>{const e=t.label.toLowerCase();return i.some((t=>e.includes(t)))}));if(o)return o.deviceId;const r=s.find((t=>{const e=t.label.toLowerCase();return n.some((t=>e.includes(t)))}));return r?r.deviceId:s[0].deviceId}}static findBestRearCamera(t,e){if(!t||!t.length)return null;if(["iPhone","iPad","Mac"].includes($C.OS))return qP.findBestRearCameraInIOS(t,{getMainCamera:null==e?void 0:e.getMainCameraInIOS});const i=["후","背面","背置","後面","後置","后面","后置","านหลัง","หลัง","बैक","خلفية","אחורית","задняя","задня","задней","задна","πίσω","zadní","zadná","tylny","trás","trasera","traseira","taka","stražnja","spate","sau","rück","rear","posteriore","posterior","hátsó","darrere","belakang","baksidan","bakre","bak","bagside","back","aртқы","arrière","arka","achterzijde"];for(let e of t){const t=e.label.toLowerCase();if(t&&i.some((e=>t.includes(e)))&&/\b0(\b)?/.test(t))return e.deviceId}return ["Android","HarmonyOS"].includes($C.OS)?t[t.length-1].deviceId:null}static findBestCamera(t,e,i){return t&&t.length?"environment"===e?this.findBestRearCamera(t,i):"user"===e?null:e?void 0:null:null}static async playVideo(t,e,i){if(!t)throw new Error("Invalid 'videoEl'.");if(!e)throw new Error("Invalid 'source'.");return new Promise((async(n,s)=>{let o;const r=()=>{t.removeEventListener("loadstart",c),t.removeEventListener("abort",d),t.removeEventListener("play",u),t.removeEventListener("error",p),t.removeEventListener("loadedmetadata",v);};let a=!1;const l=()=>{a=!0,o&&clearTimeout(o),r(),n(t);},h=t=>{o&&clearTimeout(o),r(),s(t);},c=()=>{t.addEventListener("abort",d,{once:!0});},d=()=>{const t=new Error("Video playing was interrupted.");t.name="AbortError",h(t);},u=()=>{l();},p=()=>{h(new Error(`Video error ${t.error.code}: ${t.error.message}.`));};let g;const f=new Promise((t=>{g=t;})),v=()=>{g();};if(t.addEventListener("loadstart",c,{once:!0}),t.addEventListener("play",u,{once:!0}),t.addEventListener("error",p,{once:!0}),t.addEventListener("loadedmetadata",v,{once:!0}),"string"==typeof e||e instanceof String?t.src=e:t.srcObject=e,t.autoplay&&await new Promise((t=>{setTimeout(t,1e3);})),!a){i&&(o=setTimeout((()=>{r(),s(new Error("Failed to play video. Timeout."));}),i));try{t.src&&await t.load(),await t.play(),l();}catch(t){}if(!a){await f;try{await t.play(),l();}catch(t){h(t);}}}}))}static async testCameraAccess(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))return {ok:!1,errorName:"InsecureContext",errorMessage:"Insecure context."};let n;try{n=t?await navigator.mediaDevices.getUserMedia(t):await navigator.mediaDevices.getUserMedia({video:!0});}catch(t){return {ok:!1,errorName:t.name,errorMessage:t.message}}finally{null==n||n.getTracks().forEach((t=>{t.stop();}));}return {ok:!0}}get state(){if(!WC(this,xP,"f"))return "closed";if("pending"===WC(this,xP,"f"))return "opening";if("fulfilled"===WC(this,xP,"f"))return "opened";throw new Error("Unknown state.")}set ifSaveLastUsedCamera(t){t&&qP.isStorageAvailable("localStorage")?NC(this,fP,!0,"f"):NC(this,fP,!1,"f");}get ifSaveLastUsedCamera(){return WC(this,fP,"f")}get isVideoPlaying(){return !(!WC(this,lP,"f")||WC(this,lP,"f").paused)&&"opened"===this.state}set tapFocusEventBoundEl(t){var e,i,n;if(!(t instanceof HTMLElement)&&null!=t)throw new TypeError("Invalid 'element'.");null===(e=WC(this,TP,"f"))||void 0===e||e.removeEventListener("click",WC(this,PP,"f")),null===(i=WC(this,TP,"f"))||void 0===i||i.removeEventListener("touchend",WC(this,PP,"f")),null===(n=WC(this,TP,"f"))||void 0===n||n.removeEventListener("touchmove",WC(this,CP,"f")),NC(this,TP,t,"f"),t&&(window.TouchEvent&&["Android","HarmonyOS","iPhone","iPad"].includes($C.OS)?(t.addEventListener("touchend",WC(this,PP,"f")),t.addEventListener("touchmove",WC(this,CP,"f"))):t.addEventListener("click",WC(this,PP,"f")));}get tapFocusEventBoundEl(){return WC(this,TP,"f")}get disposed(){return WC(this,UP,"f")}constructor(t){var e,i;aP.add(this),lP.set(this,null),hP.set(this,void 0),cP.set(this,(()=>{"opened"===this.state&&WC(this,DP,"f").fire("resumed",null,{target:this,async:!1});})),dP.set(this,(()=>{WC(this,DP,"f").fire("paused",null,{target:this,async:!1});})),uP.set(this,void 0),pP.set(this,void 0),this.cameraOpenTimeout=15e3,this._arrCameras=[],gP.set(this,void 0),fP.set(this,!1),this.ifSkipCameraInspection=!1,this.selectIOSRearMainCameraAsDefault=!1,vP.set(this,void 0),mP.set(this,!0),yP.set(this,void 0),xP.set(this,void 0),wP.set(this,!1),this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,focusArea:null,tempBufferContainer:null,defaultTempBufferContainerLenRatio:1/4},bP.set(this,!1),this._focusSupported=!0,this.calculateCoordInVideo=(t,e)=>{let i,n;const s=window.getComputedStyle(WC(this,lP,"f")).objectFit,o=this.getResolution(),r=WC(this,lP,"f").getBoundingClientRect(),a=r.left,l=r.top,{width:h,height:c}=WC(this,lP,"f").getBoundingClientRect();if(h<=0||c<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const d=h/c,u=o.width/o.height;let p=1;if("contain"===s)u>d?(p=h/o.width,i=(t-a)/p,n=(e-l-(c-h/u)/2)/p):(p=c/o.height,n=(e-l)/p,i=(t-a-(h-c*u)/2)/p);else {if("cover"!==s)throw new Error("Unsupported object-fit.");u>d?(p=c/o.height,n=(e-l)/p,i=(t-a+(c*u-h)/2)/p):(p=h/o.width,i=(t-a)/p,n=(e-l+(h/u-c)/2)/p);}return {x:i,y:n}},SP.set(this,!1),CP.set(this,(()=>{NC(this,SP,!0,"f");})),PP.set(this,(async t=>{var e;if(WC(this,SP,"f"))return void NC(this,SP,!1,"f");if(!WC(this,bP,"f"))return;if(!this.isVideoPlaying)return;if(!WC(this,hP,"f"))return;if(!this._focusSupported)return;if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(e=this.getCameraCapabilities())||void 0===e?void 0:e.focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let i,n;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),t instanceof MouseEvent)i=t.clientX,n=t.clientY;else {if(!(t instanceof TouchEvent))throw new Error("Unknown event type.");if(!t.changedTouches.length)return;i=t.changedTouches[0].clientX,n=t.changedTouches[0].clientY;}const s=this.getResolution(),o=2*Math.round(Math.min(s.width,s.height)/this._focusParameters.defaultFocusAreaSizeRatio/2);let r;try{r=this.calculateCoordInVideo(i,n);}catch(t){}if(r.x<0||r.x>s.width||r.y<0||r.y>s.height)return;const a={x:r.x+"px",y:r.y+"px"},l=o+"px",h=l;let c;qP._onLog&&(c=Date.now());try{await WC(this,aP,"m",$P).call(this,a,l,h,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance);}catch(t){if(qP._onLog)throw qP._onLog(t),t}qP._onLog&&qP._onLog(`Tap focus costs: ${Date.now()-c} ms`),this._focusParameters.taskBackToContinous=setTimeout((()=>{var t;qP._onLog&&qP._onLog("Back to continuous focus."),null===(t=WC(this,hP,"f"))||void 0===t||t.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}));}),this._focusParameters.focusBackToContinousTime),WC(this,DP,"f").fire("tapfocus",null,{target:this,async:!1});})),TP.set(this,null),AP.set(this,1),kP.set(this,{x:0,y:0}),this.updateVideoElWhenSoftwareScaled=()=>{if(!WC(this,lP,"f"))return;const t=WC(this,AP,"f");if(t<1)throw new RangeError("Invalid scale value.");if(1===t)WC(this,lP,"f").style.transform="";else {const e=window.getComputedStyle(WC(this,lP,"f")).objectFit,i=WC(this,lP,"f").videoWidth,n=WC(this,lP,"f").videoHeight,{width:s,height:o}=WC(this,lP,"f").getBoundingClientRect();if(s<=0||o<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const r=s/o,a=i/n;let l=1;"contain"===e?l=r<a?s/(i/t):o/(n/t):"cover"===e&&(l=a>r?o/(i/t):s/(n/t));const h=l*(1-1/t)*(i/2-WC(this,kP,"f").x),c=l*(1-1/t)*(n/2-WC(this,kP,"f").y);WC(this,lP,"f").style.transform=`translate(${h}px, ${c}px) scale(${t})`;}},EP.set(this,(function(){if(!(this.data instanceof Uint8Array||this.data instanceof Uint8ClampedArray))throw new TypeError("Invalid data.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const t=document.createElement("canvas");let e;if(t.width=this.width,t.height=this.height,this.pixelFormat===YC.GREY){e=new Uint8ClampedArray(this.width*this.height*4);for(let t=0;t<e.length;t+=4)e[t]=this.data[t/4],e[t+1]=this.data[t/4],e[t+2]=this.data[t/4],e[t+3]=255;}else e=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(e,this.width,this.height);return t.getContext("2d").putImageData(i,0,0),t})),DP.set(this,void 0),RP.set(this,["before:open","opened","before:close","closed","before:camera:change","camera:changed","before:resolution:change","resolution:changed","played","paused","resumed","tapfocus"]),this.detectedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],IP.set(this,new Map),MP.set(this,!1),BP.set(this,(async()=>{var t,e;if("visible"===document.visibilityState){if(qP._onLog&&qP._onLog("document visible. video paused: "+(null===(t=WC(this,lP,"f"))||void 0===t?void 0:t.paused)),"opening"==this.state||"opened"==this.state){let t=!1;if(!this.isVideoPlaying){qP._onLog&&qP._onLog("document visible. Not auto resume. 1st resume start.");try{await this.resume(),t=!0;}catch(t){qP._onLog&&qP._onLog("document visible. 1st resume video failed, try open instead.");}t||await WC(this,aP,"m",_P).call(this);}if(await new Promise((t=>setTimeout(t,300))),!this.isVideoPlaying){qP._onLog&&qP._onLog("document visible. 1st open failed. 2rd resume start."),t=!1;try{await this.resume(),t=!0;}catch(t){qP._onLog&&qP._onLog("document visible. 2rd resume video failed, try open instead.");}t||await WC(this,aP,"m",_P).call(this);}}}else "hidden"===document.visibilityState&&(qP._onLog&&qP._onLog("document hidden. video paused: "+(null===(e=WC(this,lP,"f"))||void 0===e?void 0:e.paused)),"opening"==this.state||"opened"==this.state&&this.isVideoPlaying&&this.pause());})),UP.set(this,!1),(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia)||setTimeout((()=>{qP.onWarning&&qP.onWarning("The browser is too old or the page is loaded from an insecure origin.");}),0),this.defaultConstraints={video:{facingMode:{ideal:"environment"}}},this.resetMediaStreamConstraints(),t instanceof HTMLVideoElement&&this.setVideoEl(t),NC(this,DP,new GP,"f"),this.imageDataGetter=new nP,document.addEventListener("visibilitychange",WC(this,BP,"f"));}setVideoEl(t){if(!(t&&t instanceof HTMLVideoElement))throw new Error("Invalid 'videoEl'.");t.addEventListener("play",WC(this,cP,"f")),t.addEventListener("pause",WC(this,dP,"f")),NC(this,lP,t,"f");}getVideoEl(){return WC(this,lP,"f")}releaseVideoEl(){var t,e;null===(t=WC(this,lP,"f"))||void 0===t||t.removeEventListener("play",WC(this,cP,"f")),null===(e=WC(this,lP,"f"))||void 0===e||e.removeEventListener("pause",WC(this,dP,"f")),NC(this,lP,null,"f");}isVideoLoaded(){return !!WC(this,lP,"f")&&4==WC(this,lP,"f").readyState}async open(){if(WC(this,yP,"f")&&!WC(this,mP,"f")){if("pending"===WC(this,xP,"f"))return WC(this,yP,"f");if("fulfilled"===WC(this,xP,"f"))return}WC(this,DP,"f").fire("before:open",null,{target:this}),await WC(this,aP,"m",_P).call(this),WC(this,DP,"f").fire("played",null,{target:this,async:!1}),WC(this,DP,"f").fire("opened",null,{target:this,async:!1});}async close(){if("closed"===this.state)return;WC(this,DP,"f").fire("before:close",null,{target:this});const t=WC(this,yP,"f");if(WC(this,aP,"m",HP).call(this),t&&"pending"===WC(this,xP,"f")){try{await t;}catch(t){}if(!1===WC(this,mP,"f")){const t=new Error("'close()' was interrupted.");throw t.name="AbortError",t}}NC(this,yP,null,"f"),NC(this,xP,null,"f"),WC(this,DP,"f").fire("closed",null,{target:this,async:!1});}pause(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");WC(this,lP,"f").pause();}async resume(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");await WC(this,lP,"f").play();}async setCamera(t){if("string"!=typeof t)throw new TypeError("Invalid 'deviceId'.");if("object"!=typeof WC(this,uP,"f").video&&(WC(this,uP,"f").video={}),delete WC(this,uP,"f").video.facingMode,WC(this,uP,"f").video.deviceId={exact:t},!("closed"===this.state||this.videoSrc||"opening"===this.state&&WC(this,mP,"f"))){WC(this,DP,"f").fire("before:camera:change",[],{target:this,async:!1}),await WC(this,aP,"m",FP).call(this);try{this.resetSoftwareScale();}catch(t){}return WC(this,pP,"f")}}async switchToFrontCamera(t){if("object"!=typeof WC(this,uP,"f").video&&(WC(this,uP,"f").video={}),(null==t?void 0:t.resolution)&&(WC(this,uP,"f").video.width={ideal:t.resolution.width},WC(this,uP,"f").video.height={ideal:t.resolution.height}),delete WC(this,uP,"f").video.deviceId,WC(this,uP,"f").video.facingMode={exact:"user"},NC(this,gP,null,"f"),!("closed"===this.state||this.videoSrc||"opening"===this.state&&WC(this,mP,"f"))){WC(this,DP,"f").fire("before:camera:change",[],{target:this,async:!1}),WC(this,aP,"m",FP).call(this);try{this.resetSoftwareScale();}catch(t){}return WC(this,pP,"f")}}getCamera(){var t;if(WC(this,pP,"f"))return WC(this,pP,"f");{let e=(null===(t=WC(this,uP,"f").video)||void 0===t?void 0:t.deviceId)||"";if(e){e=e.exact||e.ideal||e;for(let t of this._arrCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t))}return {deviceId:"",label:"",_checked:!1}}}async _getCameras(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let n;if(t){let t=await navigator.mediaDevices.getUserMedia({video:!0});n=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind)),t.getTracks().forEach((t=>{t.stop();}));}else n=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind));const s=[],o=[];if(this._arrCameras)for(let t of this._arrCameras)t._checked&&o.push(t);for(let t=0;t<n.length;t++){let e,i=n[t];for(let t of o)if(i.deviceId==t.deviceId){e=t;break}e||(e={deviceId:i.deviceId,label:i.label?i.label:"camera "+t,_checked:!1}),e.deviceId&&s.push(e);}return this._arrCameras=s,qP._onLog&&qP._onLog(JSON.stringify(this._arrCameras)),s}async getCameras(){var t,e;if(!(null===(e=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===e?void 0:e.enumerateDevices))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");const i=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind));return i&&i.length&&!i[0].deviceId?this._getCameras(!0):this._getCameras(!1)}async getAllCameras(){return this.getCameras()}async setResolution(t,e,i){if("number"!=typeof t||t<=0)throw new TypeError("Invalid 'width'.");if("number"!=typeof e||e<=0)throw new TypeError("Invalid 'height'.");if("object"!=typeof WC(this,uP,"f").video&&(WC(this,uP,"f").video={}),i?(WC(this,uP,"f").video.width={exact:t},WC(this,uP,"f").video.height={exact:e}):(WC(this,uP,"f").video.width={ideal:t},WC(this,uP,"f").video.height={ideal:e}),"closed"===this.state||this.videoSrc||"opening"===this.state&&WC(this,mP,"f"))return null;WC(this,DP,"f").fire("before:resolution:change",[],{target:this,async:!1}),await WC(this,aP,"m",FP).call(this);try{this.resetSoftwareScale();}catch(t){}const n=this.getResolution();return {width:n.width,height:n.height}}getResolution(){if("opened"===this.state&&this.videoSrc&&WC(this,lP,"f"))return {width:WC(this,lP,"f").videoWidth,height:WC(this,lP,"f").videoHeight};if(WC(this,hP,"f")){const t=WC(this,hP,"f").getSettings();return {width:t.width,height:t.height}}if(this.isVideoLoaded())return {width:WC(this,lP,"f").videoWidth,height:WC(this,lP,"f").videoHeight};{const t={width:0,height:0};let e=WC(this,uP,"f").video.width||0,i=WC(this,uP,"f").video.height||0;return e&&(t.width=e.exact||e.ideal||e),i&&(t.height=i.exact||i.ideal||i),t}}async getResolutions(t){var e,i,n,s,o,r,a,l,h,c,d;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let u="";const p=(t,e)=>{const i=WC(this,IP,"f").get(t);if(!i||!i.length)return !1;for(let t of i)if(t.width===e.width&&t.height===e.height)return !0;return !1};if(this._mediaStream){u=null===(d=WC(this,pP,"f"))||void 0===d?void 0:d.deviceId;let e=WC(this,IP,"f").get(u);if(e&&!t)return JSON.parse(JSON.stringify(e));e=[],WC(this,IP,"f").set(u,e),NC(this,wP,!0,"f");try{for(let t of this.detectedResolutions){await WC(this,hP,"f").applyConstraints({width:{ideal:t.width},height:{ideal:t.height}}),WC(this,aP,"m",OP).call(this);const i=WC(this,hP,"f").getSettings(),n={width:i.width,height:i.height};p(u,n)||e.push({width:n.width,height:n.height});}}catch(t){throw WC(this,aP,"m",HP).call(this),NC(this,wP,!1,"f"),t}try{await WC(this,aP,"m",_P).call(this);}catch(t){if("AbortError"===t.name)return e;throw t}finally{NC(this,wP,!1,"f");}return e}{const e=async(t,e,i)=>{const n={video:{deviceId:{exact:t},width:{ideal:e},height:{ideal:i}}};let s=null;try{s=await navigator.mediaDevices.getUserMedia(n);}catch(t){return null}if(!s)return null;const o=s.getVideoTracks();let r=null;try{const t=o[0].getSettings();r={width:t.width,height:t.height};}catch(t){const e=document.createElement("video");e.srcObject=s,r={width:e.videoWidth,height:e.videoHeight},e.srcObject=null;}return o.forEach((t=>{t.stop();})),r};let i=(null===(o=null===(s=null===(n=WC(this,uP,"f"))||void 0===n?void 0:n.video)||void 0===s?void 0:s.deviceId)||void 0===o?void 0:o.exact)||(null===(l=null===(a=null===(r=WC(this,uP,"f"))||void 0===r?void 0:r.video)||void 0===a?void 0:a.deviceId)||void 0===l?void 0:l.ideal)||(null===(c=null===(h=WC(this,uP,"f"))||void 0===h?void 0:h.video)||void 0===c?void 0:c.deviceId);if(!i)return [];let d=WC(this,IP,"f").get(i);if(d&&!t)return JSON.parse(JSON.stringify(d));d=[],WC(this,IP,"f").set(i,d);for(let t of this.detectedResolutions){const n=await e(i,t.width,t.height);n&&!p(i,n)&&d.push({width:n.width,height:n.height});}return d}}async setMediaStreamConstraints(t,e){if(!(t=>{return null!==t&&"[object Object]"===(e=t,Object.prototype.toString.call(e));var e;})(t))throw new TypeError("Invalid 'mediaStreamConstraints'.");NC(this,uP,JSON.parse(JSON.stringify(t)),"f"),NC(this,gP,null,"f"),e&&WC(this,aP,"m",FP).call(this);}getMediaStreamConstraints(){return JSON.parse(JSON.stringify(WC(this,uP,"f")))}resetMediaStreamConstraints(){NC(this,uP,this.defaultConstraints?JSON.parse(JSON.stringify(this.defaultConstraints)):null,"f");}getCameraCapabilities(){if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return WC(this,hP,"f").getCapabilities?WC(this,hP,"f").getCapabilities():{}}getCameraSettings(){if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return WC(this,hP,"f").getSettings()}async turnOnTorch(){if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const t=this.getCameraCapabilities();if(!(null==t?void 0:t.torch))throw Error("Not supported.");await WC(this,hP,"f").applyConstraints({advanced:[{torch:!0}]});}async turnOffTorch(){if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const t=this.getCameraCapabilities();if(!(null==t?void 0:t.torch))throw Error("Not supported.");await WC(this,hP,"f").applyConstraints({advanced:[{torch:!1}]});}async setColorTemperature(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const n=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.colorTemperature;if(!n)throw Error("Not supported.");return e&&(t<n.min?t=n.min:t>n.max&&(t=n.max),t=YP(t,n.min,n.step,n.max)),await WC(this,hP,"f").applyConstraints({advanced:[{colorTemperature:t,whiteBalanceMode:"manual"}]}),t}getColorTemperature(){return this.getCameraSettings().colorTemperature||0}async setExposureCompensation(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const n=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.exposureCompensation;if(!n)throw Error("Not supported.");return e&&(t<n.min?t=n.min:t>n.max&&(t=n.max),t=YP(t,n.min,n.step,n.max)),await WC(this,hP,"f").applyConstraints({advanced:[{exposureCompensation:t}]}),t}getExposureCompensation(){return this.getCameraSettings().exposureCompensation||0}async setFrameRate(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");let n=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.frameRate;if(!n)throw Error("Not supported.");e&&(t<n.min?t=n.min:t>n.max&&(t=n.max));const s=this.getResolution();return await WC(this,hP,"f").applyConstraints({width:{ideal:Math.max(s.width,s.height)},frameRate:t}),t}getFrameRate(){return this.getCameraSettings().frameRate}async setFocus(t,e){if("object"!=typeof t||Array.isArray(t)||null==t)throw new TypeError("Invalid 'settings'.");if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const i=this.getCameraCapabilities(),n=null==i?void 0:i.focusMode,s=null==i?void 0:i.focusDistance;if(!n)throw Error("Not supported.");if("string"!=typeof t.mode)throw TypeError("Invalid 'mode'.");const o=t.mode.toLowerCase();if(!n.includes(o))throw Error("Unsupported focus mode.");if("manual"===o){if(!s)throw Error("Manual focus unsupported.");if(t.hasOwnProperty("distance")){let i=t.distance;e&&(i<s.min?i=s.min:i>s.max&&(i=s.max),i=YP(i,s.min,s.step,s.max)),this._focusParameters.focusArea=null,await WC(this,hP,"f").applyConstraints({advanced:[{focusMode:o,focusDistance:i}]});}else {if(!t.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const e=t.area.centerPoint;let i=t.area.width,n=t.area.height;if(!i||!n){const t=this.getResolution();i||(i=2*Math.round(Math.min(t.width,t.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),n||(n=2*Math.round(Math.min(t.width,t.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px");}this._focusParameters.focusArea={centerPoint:{x:e.x,y:e.y},width:i,height:n},await WC(this,aP,"m",$P).call(this,e,i,n);}}}else this._focusParameters.focusArea=null,await WC(this,hP,"f").applyConstraints({advanced:[{focusMode:o}]});}getFocus(){const t=this.getCameraSettings(),e=t.focusMode;return e?"manual"===e?this._focusParameters.focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters.focusArea))}:{mode:"manual",distance:t.focusDistance}:{mode:e}:null}async enableTapToFocus(){NC(this,bP,!0,"f");}disableTapToFocus(){NC(this,bP,!1,"f");}isTapToFocusEnabled(){return WC(this,bP,"f")}async setZoom(t){if("object"!=typeof t||Array.isArray(t)||null==t)throw new TypeError("Invalid 'settings'.");if("number"!=typeof t.factor)throw new TypeError("Illegal type of 'factor'.");if(t.factor<1)throw new RangeError("Invalid 'factor'.");if("opened"!==this.state)throw new Error("Video is not playing.");t.centerPoint?WC(this,aP,"m",jP).call(this,t.centerPoint):this.resetScaleCenter();try{if(WC(this,aP,"m",XP).call(this,WC(this,kP,"f"))){const e=await this.setHardwareScale(t.factor,!0);let i=this.getHardwareScale();1==i&&1!=e&&(i=e),t.factor>i?this.setSoftwareScale(t.factor/i):this.setSoftwareScale(1);}else await this.setHardwareScale(1),this.setSoftwareScale(t.factor);}catch(e){const i=e.message||e;if("Not supported."!==i&&"Camera is not open."!==i)throw e;this.setSoftwareScale(t.factor);}}getZoom(){if("opened"!==this.state)throw new Error("Video is not playing.");let t=1;try{t=this.getHardwareScale();}catch(t){if("Camera is not open."!==(t.message||t))throw t}return {factor:t*WC(this,AP,"f")}}async resetZoom(){await this.setZoom({factor:1});}async setHardwareScale(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(t<1)throw new RangeError("Invalid 'value'.");if(!WC(this,hP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const n=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.zoom;if(!n)throw Error("Not supported.");return e&&(t<n.min?t=n.min:t>n.max&&(t=n.max),t=YP(t,n.min,n.step,n.max)),await WC(this,hP,"f").applyConstraints({advanced:[{zoom:t}]}),t}getHardwareScale(){return this.getCameraSettings().zoom||1}setSoftwareScale(t,e){if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(t<1)throw new RangeError("Invalid 'value'.");if("opened"!==this.state)throw new Error("Video is not playing.");e&&WC(this,aP,"m",jP).call(this,e),NC(this,AP,t,"f"),this.updateVideoElWhenSoftwareScaled();}getSoftwareScale(){return WC(this,AP,"f")}resetScaleCenter(){if("opened"!==this.state)throw new Error("Video is not playing.");const t=this.getResolution();NC(this,kP,{x:t.width/2,y:t.height/2},"f");}resetSoftwareScale(){this.setSoftwareScale(1),this.resetScaleCenter();}getFrameData(t){if(this.disposed)throw Error("The 'Camera' instance has been disposed.");if(!this.isVideoLoaded())return null;if(WC(this,wP,"f"))return null;const e=Date.now();qP._onLog&&qP._onLog("getFrameData() START: "+e);const i=WC(this,lP,"f").videoWidth,n=WC(this,lP,"f").videoHeight;let s={sx:0,sy:0,sWidth:i,sHeight:n,dWidth:i,dHeight:n};(null==t?void 0:t.position)&&(s=JSON.parse(JSON.stringify(t.position)));let o=YC.RGBA;(null==t?void 0:t.pixelFormat)&&(o=t.pixelFormat);let r=WC(this,AP,"f");(null==t?void 0:t.scale)&&(r=t.scale);let a=WC(this,kP,"f");if(null==t?void 0:t.scaleCenter){if("string"!=typeof t.scaleCenter.x||"string"!=typeof t.scaleCenter.y)throw new Error("Invalid scale center.");let e=0,s=0;if(t.scaleCenter.x.endsWith("px"))e=parseFloat(t.scaleCenter.x);else {if(!t.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");e=parseFloat(t.scaleCenter.x)/100*i;}if(t.scaleCenter.y.endsWith("px"))s=parseFloat(t.scaleCenter.y);else {if(!t.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");s=parseFloat(t.scaleCenter.y)/100*n;}if(isNaN(e)||isNaN(s))throw new Error("Invalid scale center.");a.x=Math.round(e),a.y=Math.round(s);}let l=null;if((null==t?void 0:t.bufferContainer)&&(l=t.bufferContainer),0==i||0==n)return null;1!==r&&(s.sWidth=Math.round(s.sWidth/r),s.sHeight=Math.round(s.sHeight/r),s.sx=Math.round((1-1/r)*a.x+s.sx/r),s.sy=Math.round((1-1/r)*a.y+s.sy/r));const h=this.imageDataGetter.getImageData(WC(this,lP,"f"),i,n,s,{pixelFormat:o,bufferContainer:l});if(!h)return null;const c=Date.now();return qP._onLog&&qP._onLog("getFrameData() END: "+c),{data:h.data,width:h.width,height:h.height,pixelFormat:h.pixelFormat,timeSpent:c-e,timeStamp:c,toCanvas:WC(this,EP,"f")}}on(t,e){if(!WC(this,RP,"f").includes(t.toLowerCase()))throw new Error(`Event '${t}' does not exist.`);WC(this,DP,"f").on(t,e);}off(t,e){WC(this,DP,"f").off(t,e);}async dispose(){this.tapFocusEventBoundEl=null,await this.close(),this.releaseVideoEl(),WC(this,DP,"f").dispose(),this.imageDataGetter.dispose(),document.removeEventListener("visibilitychange",WC(this,BP,"f")),NC(this,UP,!0,"f");}}function JP(t,e){Xn(e)&&(t.config.maxFrameNumber=e);}function ZP(t,e){Xn(e)&&(t.config.autoCaptureDelay=e);}function QP(t,e){if(!zn(e))return;const{context:i}=t.viewer;i.core.detectorService.enableDetect&&(t.config.enableAutoDetect=e,t.isVideoPlaying&&(t.viewer.hooks.autoDetectChanged.emit(bf.create(e)),e?t.loop.startLoop():t.config.enableAutoCapture?t.loop.cancelAnimation():t.loop.closeLoop()));}function KP(t,e){zn(e)&&(t.config.enableAutoCapture=e,t.isVideoPlaying&&(t.viewer.hooks.autoCaptureChanged.emit(Sf.create(e)),e?t.loop.startLoop():t.config.enableAutoDetect||t.loop.closeLoop()));}function tT(t,e){Xn(e)&&(t.config.acceptedPolygonConfidence=e);}function eT(t,e){return !!t.videoEl&&(t.config.fullscreen=e,t.videoEl.style.objectFit=e?"cover":"contain",t.loop.updateVideoLayout(),!0)}lP=new WeakMap,hP=new WeakMap,cP=new WeakMap,dP=new WeakMap,uP=new WeakMap,pP=new WeakMap,gP=new WeakMap,fP=new WeakMap,vP=new WeakMap,mP=new WeakMap,yP=new WeakMap,xP=new WeakMap,wP=new WeakMap,bP=new WeakMap,SP=new WeakMap,CP=new WeakMap,PP=new WeakMap,TP=new WeakMap,AP=new WeakMap,kP=new WeakMap,EP=new WeakMap,DP=new WeakMap,RP=new WeakMap,IP=new WeakMap,MP=new WeakMap,BP=new WeakMap,UP=new WeakMap,aP=new WeakSet,LP=async function(){const t=this.getMediaStreamConstraints();if("boolean"==typeof t.video&&(t.video={}),t.video.deviceId);else if(WC(this,gP,"f"))delete t.video.facingMode,t.video.deviceId={exact:WC(this,gP,"f")};else if(this.ifSaveLastUsedCamera&&qP.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete t.video.facingMode,t.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),i=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&i&&(t.video.width=e,t.video.height=i);}else if(this.ifSkipCameraInspection);else {const e=async t=>{let e=null;return "environment"===t&&["Android","HarmonyOS","iPhone","iPad"].includes($C.OS)?(await this._getCameras(!1),WC(this,aP,"m",OP).call(this),e=qP.findBestCamera(this._arrCameras,"environment",{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})):t||["Android","HarmonyOS","iPhone","iPad"].includes($C.OS)||(await this._getCameras(!1),WC(this,aP,"m",OP).call(this),e=qP.findBestCamera(this._arrCameras,null,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})),e};let i=t.video.facingMode;i instanceof Array&&i.length&&(i=i[0]),"object"==typeof i&&(i=i.exact||i.ideal);const n=await e(i);n&&(delete t.video.facingMode,t.video.deviceId={exact:n});}return t},OP=function(){if(WC(this,mP,"f")){const t=new Error("The operation was interrupted.");throw t.name="AbortError",t}},WP=async function(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let n;try{qP._onLog&&qP._onLog("======try getUserMedia========");let e=[0,500,1e3,2e3],i=null;const s=async t=>{for(let s of e){s&&(await new Promise((t=>setTimeout(t,s))),WC(this,aP,"m",OP).call(this));try{qP._onLog&&qP._onLog("ask "+JSON.stringify(t)),n=await navigator.mediaDevices.getUserMedia(t),WC(this,aP,"m",OP).call(this);break}catch(t){if("NotFoundError"===t.name||"NotAllowedError"===t.name||"AbortError"===t.name||"OverconstrainedError"===t.name)throw t;i=t,qP._onLog&&qP._onLog(t.message||t);}}};if(await s(t),n||"object"!=typeof t.video||(t.video.deviceId&&(delete t.video.deviceId,await s(t)),!n&&t.video.facingMode&&(delete t.video.facingMode,await s(t)),n||!t.video.width&&!t.video.height||(delete t.video.width,delete t.video.height,await s(t))),!n)throw i;return n}catch(t){throw null==n||n.getTracks().forEach((t=>{t.stop();})),"NotFoundError"===t.name&&(DOMException?t=new DOMException("No camera available, please use a device with an accessible camera.",t.name):(t=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),t}},NP=function(){this._mediaStream&&(this._mediaStream.getTracks().forEach((t=>{t.stop();})),this._mediaStream=null),NC(this,hP,null,"f");},_P=async function(){NC(this,mP,!1,"f");const t=NC(this,vP,Symbol(),"f");if(WC(this,yP,"f")&&"pending"===WC(this,xP,"f")){try{await WC(this,yP,"f");}catch(t){}WC(this,aP,"m",OP).call(this);}if(t!==WC(this,vP,"f"))return;const e=NC(this,yP,(async()=>{NC(this,xP,"pending","f");try{if(this.videoSrc){if(!WC(this,lP,"f"))throw new Error("'videoEl' should be set.");await qP.playVideo(WC(this,lP,"f"),this.videoSrc,this.cameraOpenTimeout),WC(this,aP,"m",OP).call(this);}else {let t=await WC(this,aP,"m",LP).call(this);WC(this,aP,"m",NP).call(this);let e=await WC(this,aP,"m",WP).call(this,t);await this._getCameras(!1),WC(this,aP,"m",OP).call(this);const i=()=>{const t=e.getVideoTracks();let i,n;if(t.length&&(i=t[0]),i){const t=i.getSettings();if(t)for(let e of this._arrCameras)if(t.deviceId===e.deviceId){e._checked=!0,e.label=i.label,n=e;break}}return n},n=WC(this,uP,"f");if("object"==typeof n.video){let s=n.video.facingMode;if(s instanceof Array&&s.length&&(s=s[0]),"object"==typeof s&&(s=s.exact||s.ideal),!(WC(this,gP,"f")||this.ifSaveLastUsedCamera&&qP.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")||this.ifSkipCameraInspection||n.video.deviceId)){const n=i(),o=qP.findBestCamera(this._arrCameras,s,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault});o&&o!=(null==n?void 0:n.deviceId)&&(e.getTracks().forEach((t=>{t.stop();})),t.video.deviceId={exact:o},e=await WC(this,aP,"m",WP).call(this,t),WC(this,aP,"m",OP).call(this));}}const s=i();(null==s?void 0:s.deviceId)&&(NC(this,gP,s&&s.deviceId,"f"),this.ifSaveLastUsedCamera&&qP.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",WC(this,gP,"f")),"object"==typeof t.video&&t.video.width&&t.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(t.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(t.video.height))))),WC(this,lP,"f")&&(await qP.playVideo(WC(this,lP,"f"),e,this.cameraOpenTimeout),WC(this,aP,"m",OP).call(this)),this._mediaStream=e;const o=e.getVideoTracks();(null==o?void 0:o.length)&&NC(this,hP,o[0],"f"),NC(this,pP,s,"f");}}catch(t){throw WC(this,aP,"m",HP).call(this),NC(this,xP,null,"f"),t}NC(this,xP,"fulfilled","f");})(),"f");return e},FP=async function(){var t;if("closed"===this.state||this.videoSrc)return;const e=null===(t=WC(this,pP,"f"))||void 0===t?void 0:t.deviceId,i=this.getResolution();await WC(this,aP,"m",_P).call(this);const n=this.getResolution();e&&e!==WC(this,pP,"f").deviceId&&WC(this,DP,"f").fire("camera:changed",[WC(this,pP,"f").deviceId,e],{target:this,async:!1}),i.width==n.width&&i.height==n.height||WC(this,DP,"f").fire("resolution:changed",[{width:n.width,height:n.height},{width:i.width,height:i.height}],{target:this,async:!1}),WC(this,DP,"f").fire("played",null,{target:this,async:!1});},HP=function(){WC(this,aP,"m",NP).call(this),NC(this,pP,null,"f"),WC(this,lP,"f")&&(WC(this,lP,"f").srcObject=null,this.videoSrc&&(WC(this,lP,"f").pause(),WC(this,lP,"f").currentTime=0)),NC(this,mP,!0,"f");try{this.resetSoftwareScale();}catch(t){}},VP=async function t(e,i){const n=t=>{if(!WC(this,hP,"f")||!this.isVideoPlaying||t.focusTaskId!=this._focusParameters.curFocusTaskId){WC(this,hP,"f")&&this.isVideoPlaying||(this._focusParameters.isDoingFocus=0);const e=new Error(`Focus task ${t.focusTaskId} canceled.`);throw e.name="DeprecatedTaskError",e}1===this._focusParameters.isDoingFocus&&Date.now()-t.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1);};let s;i=YP(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await WC(this,hP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}),n(e),s=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/i),Math.abs(1/this._focusParameters.fds.max-1/i))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/i)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=i,await new Promise((t=>{setTimeout(t,s);})),n(e);let o=e.focusL-e.focusW/2,r=e.focusT-e.focusH/2,a=e.focusW,l=e.focusH;const h=this.getResolution();if(o>=h.width||r>=h.height)throw new Error("Invalid area.");o+a>h.width&&(a=h.width-o),r+l>h.height&&(l=h.height-r),o=Math.round(o),r=Math.round(r),a=Math.round(a),l=Math.round(l);const c=4*h.width*h.height*this._focusParameters.defaultTempBufferContainerLenRatio,d=4*a*l;let u=this._focusParameters.tempBufferContainer;if(u){const t=u.length;c>t&&c>=d?u=new Uint8Array(c):d>t&&d>=c&&(u=new Uint8Array(d));}else u=this._focusParameters.tempBufferContainer=new Uint8Array(Math.max(c,d));if(!this.imageDataGetter.getImageData(WC(this,lP,"f"),h.width,h.height,{sx:o,sy:r,sWidth:a,sHeight:l,dWidth:a,dHeight:l},{pixelFormat:YC.RGBA,bufferContainer:u}))return WC(this,aP,"m",t).call(this,e,i);const p=u;let g=0;for(let t=0,e=d-8;t<e;++t){let e=p[t]-p[t+8];++t;let i=p[t]-p[t+8];++t;let n=p[t]-p[t+8];++t,g+=e*e+i*i+n*n;}return -g},zP=async function t(e,i,n,s,o,r,a){let l;if(i=YP(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=YP(s,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r?r=YP(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(r=YP(Math.sqrt((i||this._focusParameters.fds.step)*(s||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a=await WC(this,aP,"m",VP).call(this,e,r)),a<=n&&a<=o?l=3:n<o&&n<a?l=1:o<n&&o<a&&(l=2),(s-i)/2<=this._focusParameters.fds.step)return 3===l||(1===l?await WC(this,hP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}):2===l&&await WC(this,hP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:s}]})),!0;if(1===l)return await WC(this,aP,"m",t).call(this,e,i,n,r,a);if(2===l)return await WC(this,aP,"m",t).call(this,e,r,a,s,o);if(3!==l)return n=await WC(this,aP,"m",VP).call(this,e,i),o=await WC(this,aP,"m",VP).call(this,e,s),await WC(this,aP,"m",t).call(this,e,i,n,s,o);let h=YP(Math.sqrt((i||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),c=YP(Math.sqrt((s||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/h)<=Math.abs(1/this._focusParameters.oldDistance-1/c)){let l=await WC(this,aP,"m",VP).call(this,e,h);if(l<a)return await WC(this,aP,"m",t).call(this,e,i,n,r,a,h,l);if(l==a)return await WC(this,aP,"m",t).call(this,e,h,l,r,a);let d=await WC(this,aP,"m",VP).call(this,e,c);if(l>a&&a<d)return await WC(this,aP,"m",t).call(this,e,h,l,c,d,r,a);if(a==d)return await WC(this,aP,"m",t).call(this,e,r,a,c,d);if(a>d)return await WC(this,aP,"m",t).call(this,e,r,a,s,o,c,d)}else {let l=await WC(this,aP,"m",VP).call(this,e,c);if(a>l)return await WC(this,aP,"m",t).call(this,e,r,a,s,o,c,l);if(a==l)return await WC(this,aP,"m",t).call(this,e,r,a,c,l);let d=await WC(this,aP,"m",VP).call(this,e,h);if(d>a&&a<l)return await WC(this,aP,"m",t).call(this,e,h,d,c,l,r,a);if(d==a)return await WC(this,aP,"m",t).call(this,e,h,d,r,a);if(d<a)return await WC(this,aP,"m",t).call(this,e,i,n,r,a,h,d)}return !1},$P=async function(t,e,i,n,s){var o;if(1==this._focusParameters.isDoingFocus)return !1;if(!t||"string"!=typeof t.x||"string"!=typeof t.y)throw new Error("Invalid 'centerPoint'.");if(!e||"string"!=typeof e)throw new Error("Invalid 'width'.");if(!i||"string"!=typeof i)throw new Error("Invalid 'height'.");const r=this.getResolution();let a=0,l=0;if(t.x.endsWith("px"))a=parseFloat(t.x);else {if(!t.x.endsWith("%"))throw new Error("Invalid 'centerPoint'.");a=parseFloat(t.x)/100*r.width;}if(t.y.endsWith("px"))l=parseFloat(t.y);else {if(!t.y.endsWith("%"))throw new Error("Invalid 'centerPoint'.");l=parseFloat(t.y)/100*r.height;}if(isNaN(a)||isNaN(l)||a<0||a>r.width||l<0||l>r.height)throw new Error("Invalid 'centerPoint'.");let h=0;if(e.endsWith("px"))h=parseFloat(e);else {if(!e.endsWith("%"))throw new Error("Invalid 'width'.");h=parseFloat(e)/100*r.width;}if(isNaN(h)||h<0)throw new Error("Invalid 'width'.");let c=0;if(i.endsWith("px"))c=parseFloat(i);else {if(!i.endsWith("%"))throw new Error("Invalid 'height'.");c=parseFloat(i)/100*r.height;}if(isNaN(c)||c<0)throw new Error("Invalid 'height'.");if(1!==WC(this,AP,"f")){const t=WC(this,AP,"f"),e=WC(this,kP,"f");h/=t,c/=t,a=(1-1/t)*e.x+a/t,l=(1-1/t)*e.y+l/t;}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(o=this.getCameraCapabilities())||void 0===o?void 0:o.focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const d={focusL:a,focusT:l,focusW:h,focusH:c,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},u=async(t,e,i)=>{try{(null==e||e<this._focusParameters.fds.min)&&(e=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let n=YP(Math.sqrt(i*(e||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),s=YP(Math.sqrt((e||this._focusParameters.fds.step)*n),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=YP(Math.sqrt(n*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=await WC(this,aP,"m",VP).call(this,t,o),a=await WC(this,aP,"m",VP).call(this,t,s),l=await WC(this,aP,"m",VP).call(this,t,n);if(a>l&&l<r){const e=await WC(this,aP,"m",zP).call(this,t,s,a,o,r,n,l);return this._focusParameters.isDoingFocus=0,e}if(a<l&&a<r){let i=await WC(this,aP,"m",VP).call(this,t,e);const o=await WC(this,aP,"m",zP).call(this,t,e,i,n,l,s,a);return this._focusParameters.isDoingFocus=0,o}if(l>r&&a>r){let e=await WC(this,aP,"m",VP).call(this,t,i);const s=await WC(this,aP,"m",zP).call(this,t,n,l,i,e,o,r);return this._focusParameters.isDoingFocus=0,s}if(a==l&&l<r){const e=await WC(this,aP,"m",zP).call(this,t,s,a,n,l);return this._focusParameters.isDoingFocus=0,e}if(l==r&&a>l){const e=await WC(this,aP,"m",zP).call(this,t,n,l,o,r);return this._focusParameters.isDoingFocus=0,e}return u(t,e,i)}catch(t){if("DeprecatedTaskError"!==t.name)throw t}};return u(d,n,s)},jP=function(t){if("opened"!==this.state)throw new Error("Video is not playing.");if(!t||"string"!=typeof t.x||"string"!=typeof t.y)throw new Error("Invalid 'center'.");const e=this.getResolution();let i=0,n=0;if(t.x.endsWith("px"))i=parseFloat(t.x);else {if(!t.x.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(t.x)/100*e.width;}if(t.y.endsWith("px"))n=parseFloat(t.y);else {if(!t.y.endsWith("%"))throw new Error("Invalid scale center.");n=parseFloat(t.y)/100*e.height;}if(isNaN(i)||isNaN(n))throw new Error("Invalid scale center.");NC(this,kP,{x:i,y:n},"f");},XP=function(t){if("opened"!==this.state)throw new Error("Video is not playing.");const e=this.getResolution();return t&&t.x==e.width/2&&t.y==e.height/2},qP.browserInfo=$C,qP.onWarning=null===(rP=null===window||void 0===window?void 0:window.console)||void 0===rP?void 0:rP.warn;class iT{constructor(t){i(this,"isLooping",!1),i(this,"lastDetectTime",(new Date).getTime()),i(this,"loopTimer",void 0),i(this,"autoCaptureStartTime",0),i(this,"lastRenderedQuad",void 0),i(this,"animation",void 0),i(this,"cameraContext",void 0),i(this,"videoLayout",void 0),this.cameraContext=t;}getLoopState(){const{enableAutoCapture:t,enableAutoDetect:e}=this.cameraContext.config;return t||e}clearLoopTimer(){clearTimeout(this.loopTimer),this.loopTimer=null,this.isLooping=!1,this.autoCaptureStartTime=0,this.lastDetectTime=(new Date).getTime();}loopTimeout(){if(!this.cameraContext.isVideoPlaying&&!this.getLoopState())return;const t=this.getDetectRemainTime();this.loopTimer=setTimeout((async()=>{if(!this.getLoopState()||this.isLooping)return;this.isLooping=!0;const t=await this.loopTaskDetail();this.isLooping=!1,t&&this.getLoopState()&&setTimeout((()=>{this.getLoopState()&&this.loopTimeout();}),10);}),t);}async loopTaskDetail(){if(!(this.cameraContext&&this.cameraContext.isVideoPlaying&&this.cameraContext.videoEl&&this.cameraContext.canvasEl))return !1;if(!this.getLoopState())return !1;const{viewer:t}=this.cameraContext;if(this.lastDetectTime=(new Date).getTime(),!t.context.viewService.isBindContainer)return !0;if("hidden"===t.getViewerConfig().visibility)return !1;const{config:e}=this.cameraContext,{enableDetect:i}=t.context.core.detectorService,n=this.cameraContext.getFrameData();if(!n)return !1;const s={type:1,data:n.data.buffer,height:n.height,width:n.width};let o={success:!1};var r;i&&(o=await this.getDetectResult(s),0===n.data.length&&(n.data=new Uint8Array(s.data)),e.enableAutoDetect&&this.cameraContext.isVideoPlaying&&o.success&&null!==(r=o)&&void 0!==r&&r.location?(this.lastRenderedQuad?this.createDetectAnimation(this.lastRenderedQuad,o.location):this.drawQuadrilateral(o.location),this.lastRenderedQuad=o.location):(this.clearCanvas(),this.lastRenderedQuad=null));let a=!1;var l;if(e.enableAutoCapture){if((null===(l=o)||void 0===l?void 0:l.status)===Gd.AUTO_CAPTURE&&(a=!0),!i)if(this.autoCaptureStartTime<=0)this.autoCaptureStartTime=(new Date).getTime();else {(new Date).getTime()-this.autoCaptureStartTime>e.autoCaptureDelay&&(this.autoCaptureStartTime=0,a=!0);}}else this.autoCaptureStartTime=0;if(a){var h,c,d;if(null===(h=this.cameraContext.viewer)||void 0===h||!h.context)return !1;const t=await this.cameraContext.viewer.context.core.processService.resize(n.data.buffer,1,n.width,n.height,-1);if(this.cameraContext.isCapturedPages=!0,null===(c=this.cameraContext.viewer)||void 0===c||!c.context)return !1;await this.cameraContext.viewer.context.loadSource({extraPageData:[{index:0,perspectiveQuad:null===(d=o)||void 0===d?void 0:d.location}],fileData:t.data}),this.startCaptureAnimation(),await nT(),this.closeCaptureAnimation();}return !0}getDetectRemainTime(){const t=(new Date).getTime(),{maxFrameNumber:e}=this.cameraContext.config,i=t-this.lastDetectTime;return Math.max(0,1e3/e-i)}startLoop(){this.loopTimer||(this.getLoopState()?this.loopTimeout():(this.clearLoopTimer(),this.clearCanvas()));}closeLoop(){if(!this.loopTimer)return;const{context:t}=this.cameraContext.viewer,{detectorService:e}=t.core;e.resetDetector(),this.clearLoopTimer(),this.clearCanvas(),cancelAnimationFrame(this.animation);}updateVideoLayout(){const{videoEl:t,config:e}=this.cameraContext,{fullscreen:i}=e,{videoWidth:n,videoHeight:s}=t,{width:o,height:r}=t.getBoundingClientRect(),a={zoom:1,left:0,top:0};if(i){const t=Math.max(o/n,r/s);a.zoom=t;}else {const t=Math.min(o/n,r/s),e=(o-n*t)/2,i=(r-s*t)/2;a.zoom=t,a.left=e,a.top=i;}this.videoLayout=a;}async getDetectResult(t){const{cameraContext:e}=this,{context:i}=e.viewer,{detectorService:n}=i.core;if(!n.enableDetect)return Promise.resolve({success:!1});let s=t;if(!t){const t=e.getFrameData();s={type:1,data:t.data.buffer,height:t.height,width:t.width};}const{acceptedPolygonConfidence:o,enableAutoCapture:r,autoCaptureDelay:a}=e.config,l={acceptedPolygonConfidence:o,enableAutoCapture:r,autoCaptureDelay:a},h=await n.detect(s,l);return h||Promise.resolve({success:!1})}drawQuadrilateral(t){if(!this.loopTimer)return;const{canvasEl:e,viewer:i}=this.cameraContext;if(!e)return;const{zoom:n,left:s,top:o}=this.videoLayout,r=e.getContext("2d");r.save(),r.clearRect(0,0,e.width,e.height),r.translate(s,o),r.scale(n,n),r.beginPath(),r.moveTo(t[0][0],t[0][1]);for(let e=1;e<t.length;e++)r.lineTo(t[e][0],t[e][1]);r.closePath();const{quadSelectionStyle:a}=i.getViewerConfig(),{border:l,background:h}=a,{borderWidth:c,borderColor:d,borderStyle:u}=ws(l);let p=mr(c).value/n;0===p&&(p=1);const g="solid"===u?[0,0]:[5*p,2*p];r.strokeStyle=d,r.fillStyle=h,r.lineCap="round",r.lineWidth=p,r.setLineDash(g),r.fill(),r.stroke(),r.restore();}clearCanvas(){const{canvasEl:t}=this.cameraContext;if(!t)return;t.getContext("2d").clearRect(0,0,t.width,t.height);}cancelAnimation(){this.clearCanvas(),cancelAnimationFrame(this.animation);}createDetectAnimation(t,e){let i=0;const n=()=>{this.clearCanvas();const s=t.map(((t,n)=>{const s=e[n];return [t[0]+(s[0]-t[0])*i,t[1]+(s[1]-t[1])*i]}));this.drawQuadrilateral(s),i<1&&(i+=.2,this.animation=requestAnimationFrame(n));};n();}startCaptureAnimation(){var t,e;this.cameraContext&&null!==(t=this.cameraContext)&&void 0!==t&&t.videoEl&&null!==(e=this.cameraContext)&&void 0!==e&&e.canvasEl&&(this.cameraContext.videoEl.style.filter="brightness(0%)",this.cameraContext.canvasEl.style.visibility="hidden");}closeCaptureAnimation(){var t,e;this.cameraContext&&null!==(t=this.cameraContext)&&void 0!==t&&t.videoEl&&null!==(e=this.cameraContext)&&void 0!==e&&e.canvasEl&&(this.cameraContext.videoEl.style.filter="brightness(100%)",this.cameraContext.canvasEl.style.visibility="");}}function nT(){return new Promise((t=>{setTimeout((()=>{t("");}),50);}))}const sT={tag:"div",id:"ddv-camera-container",className:"ddv-camera-container",children:[{tag:"video",id:"ddv-camera-video",class:"ddv-camera-camera"},{tag:"canvas",id:"ddv-camera-canvas",class:"ddv-camera-canvas"}]},oT={enableAutoCapture:!1,enableAutoDetect:!1,enableTorch:!1,maxFrameNumber:10,acceptedPolygonConfidence:65,fullscreen:!1,autoCaptureDelay:1e3};class rT{constructor(t){var e;if(i(this,"camera",void 0),i(this,"configHandler",{}),i(this,"isHttps",!0),i(this,"lastDeviceId",void 0),i(this,"isFirstPlayed",!0),i(this,"isTurningTorch",!1),i(this,"initializing",!1),i(this,"cameraContainer",void 0),i(this,"viewer",void 0),i(this,"loop",void 0),i(this,"videoEl",void 0),i(this,"canvasEl",void 0),i(this,"config",Nn(oT)),i(this,"bUser",!1),i(this,"canFrontCamera",!1),i(this,"isCapturedPages",!1),i(this,"lastEnvironmentCameraId",void 0),i(this,"cameraList",[]),i(this,"turnOnTheTorch",!1),i(this,"torchSupported",!1),this.viewer=t,this.camera=new qP,this.loop=new iT(this),this.initConfigHandler(),null!==(e=navigator)&&void 0!==e&&null!==(e=e.mediaDevices)&&void 0!==e&&e.getUserMedia||(this.isHttps=!1),this.isCaptureViewer&&this.isHttps){this.initializing=!0;const t=this.getCameras().then((t=>{this.cameraList=t;})),e=this.getFrontCamera().then((t=>{this.canFrontCamera=t,this.viewer.hooks.cameraInit.emit(Pf.create(t));})).catch((t=>{}));Promise.all([t,e]).finally((()=>{this.initializing=!1;}));}this.camera.setResolution(1280,720),this.bindCameraEvents(),this.initHooks(),this.handleViewerModeChanged(),this.bindNativeEvents(),this.handleExternalEvents();}initHooks(){this.bindViewerHooks(),this.bindGlobalHooks();}handleViewerModeChanged(){const{defaultDom:t,mainAndThbContainer:e}=this.viewer.context.viewService;if(this.isCaptureViewer){if(!this.cameraContainer){const e=vm(sT,this.viewer.postfix);this.cameraContainer=e,Object.assign(e.style,this.viewer.context.viewerConfig.canvasStyle),t.appendChild(e);const i=e.getElementsByTagName("video")[0],n=e.getElementsByTagName("canvas")[0];i.setAttribute("playsinline","true"),i.setAttribute("muted","true"),i.setAttribute("disablePictureInPicture","true"),i.setAttribute("autoplay","autoplay"),i.setAttribute("poster","data:image/gif;base64,R0lGODlhAQABAIEAAAAAAAAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAgEAAEEBAA7"),i.style.transition="opacity 300ms, filter 100ms ease",this.bindCameraVideo(i),this.bindCameraCanvas(n),this.updateCameraConfig(oT);}ym(this.cameraContainer,"flex"),mm(e);}else mm(this.cameraContainer),ym(e,"flex");}initConfigHandler(){const t={maxFrameNumber:JP,enableAutoCapture:KP,enableAutoDetect:QP,acceptedPolygonConfidence:tT,fullscreen:eT,autoCaptureDelay:ZP};this.configHandler=t;}bindViewerHooks(){this.viewer.hooks.visibleChanged.on((t=>{this.loop.closeLoop(),"visible"===t.newVisibility&&this.loop.startLoop();}),this);}bindGlobalHooks(){this.viewer.context.core.documentService.onAddPagesToDoc.on((t=>{if(!this.isCapturedPages)return;const e=xf.create(t.pageUids[0]);this.viewer.hooks.cameraCaptured.emit(e),this.isCapturedPages=!1;}),this.viewer);}bindCameraEvents(){const{camera:t}=this;t.on("paused",(()=>{this.loop.closeLoop();})),t.on("resumed",(()=>{this.loop.closeLoop(),this.loop.startLoop();})),t.on("before:open",(()=>{this.videoEl&&(this.videoEl.style.opacity="0");})),t.on("before:resolution:change",(()=>{this.videoEl&&(this.videoEl.style.opacity="0"),this.loop.closeLoop();})),t.on("before:camera:change",(()=>{this.videoEl&&(this.videoEl.style.opacity="0"),this.loop.closeLoop(),this.lastDeviceId=this.camera.getCamera().deviceId;})),t.on("camera:changed",(()=>{const t=wf.create(this.lastDeviceId,this.camera.getCamera().deviceId);this.viewer.hooks.cameraChanged.emit(t);})),t.on("played",(()=>{if(!this.videoEl||!this.isVideoPlaying)return;this.videoEl.style.opacity="1";const{enableTorch:t}=this.config,e=this.camera.getResolution();let i="unsupported";try{const t=this.camera.getCameraCapabilities();i=null!=t&&t.torch?"supported":"unsupported";}catch(t){}this.torchSupported="supported"===i,this.emitTorchChanged(i),"supported"===i&&t&&this.turnOnTorch().catch((()=>{this.config.enableTorch=!0;})),this.viewer.hooks.cameraPlayed.emit(Cf.create(e)),this.loop.updateVideoLayout(),this.loop.closeLoop(),this.loop.startLoop();})),t.on("closed",(()=>{this.isVideoPlaying||(this.loop.closeLoop(),this.viewer.hooks.cameraClosed.emit(),this.emitTorchChanged("unsupported"));}));}emitTorchChanged(t){this.viewer.hooks.torchChanged.emit(Tf.create(t));}getPointerEvent(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=0,s=0,o=0,r=0;if(e){const{left:t,top:i}=e.getBoundingClientRect();o=t,r=i;}return t instanceof PointerEvent||t instanceof MouseEvent?(n=t.offsetX,s=t.offsetY):i?(n=t.changedTouches[0].clientX-o,s=t.changedTouches[0].clientY-r):(n=t.touches[0].clientX-o,s=t.touches[0].clientY-r),{index:-1,pageUid:"",imageX:-1,imageY:-1,canvasX:Math.floor(n),canvasY:Math.floor(s),nativeEvent:t}}handleExternalEvents(){this.viewer.hooks.cameraPlayed.on((t=>{const e={deviceId:this.camera.getCamera().deviceId,resolution:[t.resolution.width,t.resolution.height]};this.viewer.emit("played",e);}),this),this.viewer.hooks.cameraClosed.on((()=>{this.viewer.emit("stopped",{deviceId:this.lastDeviceId});}),this),this.viewer.hooks.cameraCaptured.on((t=>{this.viewer.emit("captured",{pageUid:t.pageUid});}),this),this.viewer.hooks.cameraChanged.on((t=>{this.viewer.emit("cameraChanged",{oldDeviceId:t.oldDeviceId,newDeviceId:t.newDeviceId});}),this);}bindNativeEvents(){const t=this.canvasEl;if(!t)return;const e=t=>{this.viewer.emit("click",this.getPointerEvent(t));},i=t=>{this.viewer.emit("dblclick",this.getPointerEvent(t));},n=t=>{t.preventDefault(),this.viewer.emit("rightclick",this.getPointerEvent(t));},s=()=>{setTimeout((()=>{this.resize();}),500);},o=()=>{this.isVideoPlaying&&(this.loop.closeLoop(),"visible"===document.visibilityState&&this.loop.startLoop());};t.addEventListener("click",e),t.addEventListener("dblclick",i),t.addEventListener("contextmenu",n),document.addEventListener("visibilitychange",o),window.addEventListener("orientationchange",s),this.viewer.hooks.destroy.on((()=>{t.removeEventListener("click",e),t.removeEventListener("dblclick",i),t.removeEventListener("contextmenu",n),document.removeEventListener("visibilitychange",o),window.removeEventListener("orientationchange",s);}));}get isCaptureViewer(){return this.viewer.context.viewerConfig.viewerMode===dg.CAPTURE}get isVideoPlaying(){return !!this.camera&&this.camera.isVideoPlaying}async getFrontCamera(){if(!this.isHttps)return Du.reject(Du.CAMERA_NEED_HTTPS);const t=await qP.testCameraAccess({video:{facingMode:{exact:"user"}}});return Promise.resolve(t.ok)}convertCamera(){if(!this.canFrontCamera)return Promise.reject();if("opening"===this.camera.state)return Promise.resolve();if(!this.bUser){const t=this.getCamera().deviceId;return this.camera.switchToFrontCamera().then((()=>(this.bUser=!0,this.lastEnvironmentCameraId=t,this.torchSupported&&this.emitTorchChanged("unsupported"),Promise.resolve())))}return this.setCamera(this.lastEnvironmentCameraId).then((()=>(this.bUser=!1,this.torchSupported&&this.emitTorchChanged("supported"),Promise.resolve())))}getFrameData(){if(!this.config.fullscreen)return this.camera.getFrameData();const{width:t,height:e}=this.videoEl.getBoundingClientRect(),i=this.videoEl.videoWidth,n=this.videoEl.videoHeight,s=Math.max(t/i,e/n),o=t/(i*s),r=e/(n*s),a=Math.floor((1-o)/2*i),l=Math.floor((1-r)/2*n),h=Math.floor(i*o),c=Math.floor(n*r);return this.camera.getFrameData({position:{sx:a,sy:l,sWidth:h,sHeight:c,dWidth:h,dHeight:c}})}updateCameraConfig(t){for(const[e,i]of Object.entries(t)){const t=this.configHandler[e];t&&!_n(i)&&t(this,i);}}bindCameraVideo(t){t instanceof HTMLVideoElement&&(this.camera.setVideoEl(t),this.videoEl=t);}bindCameraCanvas(t){t instanceof HTMLCanvasElement&&(this.canvasEl=t);}async capture(){this.loop.startCaptureAnimation(),await nT(),this.loop.closeCaptureAnimation(),Du.verbose(`[${Date.now()}][cv] start capture`);const t=this.getFrameData();if(Du.verbose(`[${Date.now()}][cv] get frame done`),!t)return null;const e={type:1,data:t.data.buffer,width:t.width,height:t.height},i=await this.loop.getDetectResult(e);Du.verbose(`[${Date.now()}][cv] get detect result done`),0===t.data.length&&(t.data=new Uint8Array(e.data));const n=await this.viewer.context.core.processService.resize(t.data.buffer,1,t.width,t.height,-1);return Du.verbose(`[${Date.now()}][cv] create image done`),this.isCapturedPages=!0,await this.viewer.context.loadSource({fileData:n.data,extraPageData:[{index:0,perspectiveQuad:i.success?i.location:void 0}]}),Du.verbose(`[${Date.now()}][cv] capture done`),n.data}async play(t){if(!this.isHttps)return Promise.reject(Du.CAMERA_NEED_HTTPS);if(!t&&this.isVideoPlaying)return Promise.resolve();const{fill:e,resolution:i}=t||{},n=this.camera.getResolution();if(zn(e)&&this.updateCameraConfig({fullscreen:e}),this.isVideoPlaying&&aT(i)&&i[0]===n.width&&i[1]===n.height)return Promise.resolve();if(n.width,n.height,aT(i)){if(this.isVideoPlaying)return this.camera.setResolution(i[0],i[1]).then((t=>(this.resize(),Promise.resolve()))).catch();this.camera.setResolution(i[0],i[1]);}return !this.isFirstPlayed||this.isVideoPlaying||i||"opening"===this.camera.state||this.camera.setResolution(1280,720),this.initializing&&await new Promise((t=>{const e=setInterval((()=>{this.initializing||(clearInterval(e),t(""));}),100);})),this.isFirstPlayed&&(this.isFirstPlayed=!1),this.camera.open().then((async()=>(this.resize(),Promise.resolve()))).catch((t=>{let e=Du.CAMERA_OCCUPIED;return "Permission denied"===t.message&&(e=Du.CAMERA_DENIED),8===t.code&&(e=Du.CAMERA_NO_CAMERA),Promise.reject(e)}))}stop(){var t;this.loop.closeLoop(),this.lastDeviceId=this.getCamera().deviceId,null===(t=this.camera)||void 0===t||t.close();}async setCamera(t){let e="";Wn(t)?e=t.deviceId||"":Gn(t)&&(e=t);let i=!1;const n=this.cameraList.length?this.cameraList:await this.getCameras();for(let t=0;t<n.length;t++)n[t].deviceId===e&&(i=!0);if(!i)return Promise.reject(Du.CAMERA_NOT_EXIST);await this.camera.setCamera(e).catch((t=>{let e=Du.CAMERA_OCCUPIED;"Permission denied"===t.message&&(e=Du.CAMERA_DENIED),8===t.code&&(e=Du.CAMERA_NO_CAMERA),Promise.reject(e);}));const s=this.camera.getResolution(),o={deviceId:e,width:s.width,height:s.height};return Promise.resolve(o)}getCamera(){const t=this.camera.getCamera();return {deviceId:t.deviceId,label:t.label}}async getCameras(){const t=(await this.camera.getAllCameras()).map((t=>({deviceId:t.deviceId,label:t.label})));return Promise.resolve(t)}async setResolution(t,e){const i=this.camera.getCamera();if(!i||""===i.deviceId)return Promise.reject(Du.CAMERA_NOT_EXIST);let n;if(Xn(t))n=t;else if(On(t)){const[i,s]=t;n=i,e=s;}let s=this.camera.getResolution();return Xn(n)&&Xn(e)&&(this.loop.closeLoop(),s=await this.camera.setResolution(n,e).catch((t=>{}))),Promise.resolve({deviceId:i.deviceId,...s})}getResolution(){const t=this.camera.getCamera();if(!t||""===t.deviceId)return [0,0];const e=this.camera.getResolution();return [e.width,e.height]}async getResolutions(){const t=(await this.camera.getResolutions()).map((t=>[t.width,t.height]));return Promise.resolve(t)}turnOnTorch(){const t=this.camera.getCamera();return t&&""!==t.deviceId?this.isTurningTorch?Promise.resolve():(this.isTurningTorch=!0,this.camera.turnOnTorch().then((()=>(this.isTurningTorch=!1,this.turnOnTheTorch=!0,this.config.enableTorch=!0,this.emitTorchChanged("on"),Promise.resolve()))).catch((t=>(this.isTurningTorch=!1,this.turnOnTheTorch=!1,this.config.enableTorch=!1,this.emitTorchChanged("off"),Du.reject(Du.CAMERA_NOT_SUPPORT_TORCH))))):Promise.reject(Du.CAMERA_NO_VIDEO)}turnOffTorch(){const t=this.camera.getCamera();return t&&""!==t.deviceId?this.camera.turnOffTorch().then((()=>(this.turnOnTheTorch=!1,this.config.enableTorch=!1,this.emitTorchChanged("off"),Promise.resolve()))).catch((t=>Du.reject(Du.CAMERA_NOT_SUPPORT_TORCH))):Promise.reject(Du.CAMERA_NO_VIDEO)}resize(){const{canvasEl:t}=this,{width:e,height:i}=t.getBoundingClientRect();t.width=Math.floor(e),t.height=Math.floor(i),this.loop.updateVideoLayout();}dispose(){var t,e;this.stop(),null===(t=this.loop)||void 0===t||t.closeLoop(),null===(e=this.camera)||void 0===e||e.dispose(),this.camera=null,this.loop=null,this.videoEl=null,this.canvasEl=null;}}function aT(t){return !!(On(t)&&Xn(t[0])&&Xn(t[1]))}const lT={install(t){const e=t.getClass("Viewer"),n=(s=e,class extends s{constructor(t){if(super(t),i(this,"cameraContext",void 0),this.context.viewerConfig.viewerMode===dg.CAPTURE){this.cameraContext=new rT(this);const e=oT;Wn(t.viewerConfig)&&["enableTorch","enableAutoCapture","enableAutoDetect","acceptedPolygonConfidence","maxFrameNumber","autoCaptureDelay"].forEach((i=>{i in t.viewerConfig&&(e[i]=t.viewerConfig[i]);})),this.cameraContext.config={...e,defaultCameraConfig:oT},this.on("resized",(()=>{this.cameraContext.resize();}));}}isVideoPlaying(){return this.cameraContext.isVideoPlaying}convertCamera(){return this.cameraContext.convertCamera()}getCameraConfig(){return Nn(this.cameraContext.config)}updateCameraConfig(t){Wn(t)&&this.cameraContext.updateCameraConfig(t);}capture(){return this.cameraContext.capture()}play(t){return this.cameraContext.play(t)}stop(){this.isVideoPlaying()?this.cameraContext.stop():Du.warning(Du.CAMERA_NO_VIDEO);}getCurrentCamera(){return this.cameraContext.getCamera()}getAllCameras(){return this.cameraContext.getCameras()}selectCamera(t){return this.cameraContext.setCamera(t)}getCurrentResolution(){return this.cameraContext.getResolution()}getResolutions(){return this.cameraContext.getResolutions()}setResolution(t,e){return this.cameraContext.setResolution(t,e)}turnOnTorch(){return this.cameraContext.turnOnTorch()}turnOffTorch(){return this.cameraContext.turnOffTorch()}dispose(){var t;this.cameraContext&&(null===(t=this.cameraContext)||void 0===t||t.dispose()),this.cameraContext=null,super.dispose();}});var s;t.setClass("Viewer",n);}};class hT{constructor(t){i(this,"uid",void 0),i(this,"areaUid",void 0),i(this,"isRect",!0),i(this,"vertexes",[]),i(this,"midpoints",[]),i(this,"points",[]),i(this,"keepAspectRatio",!1),i(this,"isConvex",!0),i(this,"renderer",void 0),i(this,"area",void 0),i(this,"slopeRatio",[]),i(this,"selectedPart",-1),i(this,"startX",null),i(this,"startY",null),i(this,"lastX",null),i(this,"lastY",null),i(this,"lastAspectRatio",1),i(this,"b1",void 0),i(this,"b2",void 0),i(this,"k1",void 0),i(this,"k2",void 0),this.uid=Jn(),Object.assign(this,t),this.initBox(t.vertexes);}initBox(t){this.vertexes=t,this.midpoints=cT(this.vertexes),this.points=this.vertexes.slice().concat(this.midpoints.slice()),this.slopeRatio=Qs(this.vertexes);}getRect(){if(!this.isRect)return null;const{minX:t,maxX:e,minY:i,maxY:n}=this.getBounds();return {left:t,top:i,width:e-t||1,height:n-i||1}}getQuad(){if(this.isRect)return null;const{points:t}=this,e=[];for(let i=0;i<4;i++)e.push([t[2*i],t[2*i+1]]);return e}getActivePartNum(t,e,i){const n=this.getSelectedCtrlPointNum(t,e,i);if(n>-1)return n;return this.isPointOnBox(t,e)?8:-1}getSelectedCtrlPointNum(t,e,i){const{points:n}=this,{width:s,height:o,zoom:r}=this.area,{ctrlWidth:a,ctrlHeight:l,ctrlRadiusMultipleMobile:h}=this.renderer.config.boxStyle;let c=l/2/r,d=a/2/r;i&&(d*=h,c*=h);const u=Yn(d,0,3*d),p=Yn(c,0,3*c);for(let i=0;i<8;i++){const r=n[2*i],a=n[2*i+1];if(t<=r+u&&t>=r-u&&e<=a+p&&e>=a-p&&t>=0-u&&t<=s+u&&e>=0-p&&e<=o+p&&(i<4&&this.renderer.config.enableEditCropBoxVertices||this.renderer.config.enableEditCropBoxMidpoints))return i}return -1}checkOrientation(t){if(t<0||t>7)return null;const{minX:e,maxX:i,minY:n,maxY:s}=this.getBounds(),{points:o}=this,r=o[2*t],a=o[2*t+1];let l="",h="";return r===i?l="e":r===e&&(l="w"),a===s?h="s":a===n&&(h="n"),t<4?h+l:h||l}onStartHandler(t,e,i,n){var s;if(null!==(s=i)&&void 0!==s||(i=this.getActivePartNum(t,e,n)),!(i<0)&&(this.startX=t,this.startY=e,this.lastX=t,this.lastY=e,this.selectedPart=i,!this.isRect&&i>3&&i<8)){const{points:t,slopeRatio:e}=this,n=i-4;this.k1=e[(n+1)%4],this.b1=t[(2*n+3)%8]-this.k1*t[(2*n+2)%8],this.k2=e[(n+3)%4],this.b2=t[(2*n+1)%8]-this.k2*t[(2*n+0)%8];}}onMoveHandler(t,e,i){const{selectedPart:n}=this;if(n<0)return;const s=t-this.lastX,o=e-this.lastY;if(0===s&&0===o)return;const{points:r}=this;let a=r.slice();var l;n<8?(null!==(l=i)&&void 0!==l||(i=n),this.isRect?a=this.moveRectPoint(a,i,t,e):(a=this.moveQuadPoint(a,i,t,e),this.slopeRatio=Qs(r).slice(0,4),this.isConvex=to(a))):8===n&&(a=this.moveBox(a,s,o));const h=cT(a);this.points=a.slice(0,8).concat(h),this.midpoints=h,this.lastX=t,this.lastY=e;}onEndHandler(){const{startX:t,startY:e,vertexes:i,midpoints:n,lastX:s,lastY:o,selectedPart:r}=this;if(r<0)return;this.startX=0,this.startY=0,this.selectedPart=-1;let a=this.points.slice();const l=to(a);(t===s&&e===o||!l)&&(a=i.slice().concat(n)),this.isConvex=!0,this.vertexes=a.slice(0,8),this.midpoints=cT(a),this.points=a.slice(0,8).concat(this.midpoints),this.slopeRatio=Qs(a).slice(0,4);}getBounds(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.points;return {minX:Math.min(t[0],t[2],t[4],t[6]),maxX:Math.max(t[0],t[2],t[4],t[6]),minY:Math.min(t[1],t[3],t[5],t[7]),maxY:Math.max(t[1],t[3],t[5],t[7])}}moveRectPoint(t,e,i,n){let s=0,o=0;const{enableEditCropBoxMidpoints:r,enableEditCropBoxVertices:a}=this.renderer.config;if(this.keepAspectRatio){const{minX:l,maxX:h,minY:c,maxY:d}=this.getBounds(),u=this.checkOrientation(e);let p=(h-l)/(d-c);0===p||p===1/0||p===-1/0||Number.isNaN(p)?p=this.lastAspectRatio:this.lastAspectRatio=p,s=0,o=0;let g="w",f=!1;if(e<4){if(a){if(f=!0,s=i-t[2*e],o=n-t[2*e+1],0===s||0===o)return t;g="w";}}else {const a=e-4;if(r){f=!0;const r={e:[(a+1)%4,"w"],s:[a,"h"],w:[a,"w"],n:[(a+1)%4,"h"]};if(["e","s","w","n"].includes(u)&&([e,g]=r[u]),s=i-t[2*a],o=n-t[2*a+1],0===s||0===o)return t}}if(f){const i=["ne","sw","n","w"];"h"===g?(s=o*p,i.includes(u)&&(s=-s)):(o=s/p,i.includes(u)&&(o=-o));const n=t[2*e]+s,r=t[2*e+1]+o,{width:a,height:l}=this.area;n<0?(s=0-t[2*e],o=0):n>a?(s=a-t[2*e],o=0):r<0?(o=0-t[2*e+1],s=0):r>l&&(o=l-t[2*e+1],s=0),t[2*e]+=s,t[2*e+1]+=o;const h=(e+1)%4,c=(e+3)%4;e%2?(t[2*h]+=s,t[2*c+1]+=o):(t[2*h+1]+=o,t[2*c]+=s);}}else if(e<4){if(a){if(s=i-t[2*e],o=n-t[2*e+1],0===s&&0===o)return t;t[2*e]=i,t[2*e+1]=n;const r=(e+1)%4,a=(e+3)%4;e%2?(t[2*r]=i,t[2*a+1]=n):(t[2*r+1]=n,t[2*a]=i);}}else {const s=e-4;if(r){const e=this.slopeRatio[s%4];0===e?(t[(2*s+3)%8]=n,t[(2*s+1)%8]=n):e!==1/0&&e!==-1/0||(t[(2*s+2)%8]=i,t[(2*s+0)%8]=i);}}return t}moveQuadPoint(t,e,i,n){const s=t.slice();if(e<4){const s=i-t[2*e],o=n-t[2*e+1];if(0===s&&0===o)return t;t[2*e]=i,t[2*e+1]=n;}else {const o=e-4,r=this.slopeRatio[o%4],a=n-r*i,l=-a/r,h=a,c=t[(2*o+9)%8]-r*t[(2*o+8)%8],d=-c/r,{k1:u,b1:p,k2:g,b2:f}=this;0===r?(t[(2*o+3)%8]=n,u!==1/0&&u!==-1/0&&(t[(2*o+2)%8]=(n-p)/u),t[(2*o+1)%8]=n,g!==1/0&&g!==-1/0&&(t[(2*o+0)%8]=(n-f)/g)):r===1/0||r===-1/0?(t[(2*o+2)%8]=i,t[(2*o+3)%8]=u*i+p,t[(2*o+0)%8]=i,t[(2*o+1)%8]=g*i+f):(0===u?t[(2*o+2)%8]+=l-d:u===1/0||u===-1/0?t[(2*o+3)%8]+=h-c:(t[(2*o+2)%8]=(p-a)/(r-u),t[(2*o+3)%8]=(r*p-u*a)/(r-u)),0===g?t[(2*o+0)%8]+=l-d:g===1/0||g===-1/0?t[(2*o+1)%8]+=h-c:(t[(2*o+0)%8]=(f-a)/(r-g),t[(2*o+1)%8]=(r*f-g*a)/(r-g)));for(let e=0;e<4;e++){const i=t[2*e],n=t[2*e+1];if(i<0||i>this.area.width||n<0||n>this.area.height)return s}}return t}moveBox(t,e,i){const{minX:n,maxX:s,minY:o,maxY:r}=this.getBounds(t);e=Yn(e,-n,this.area.width-s),i=Yn(i,-o,this.area.height-r);for(let n=0;n<4;n++)t[2*n]+=e,t[2*n+1]+=i;return t}isPointOnBox(t,e){if(this.isRect){const{minX:i,maxX:n,minY:s,maxY:o}=this.getBounds();return t>=i&&t<=n&&e>=s&&e<=o}const i=[...this.vertexes],n=[...this.midpoints],s=[];for(let t=0;t<4;t++)s.push([i[2*t],i[2*t+1]]),s.push([n[2*t],n[2*t+1]]);return function(t,e){let i,n,s,o,r=0;const a=e.length;for([s]=e,i=1;i<=a;i++)o=e[i%a],t[0]>Math.min(s[0],o[0])&&t[0]<=Math.max(s[0],o[0])&&t[1]<=Math.max(s[1],o[1])&&s[0]!==o[0]&&(n=(t[0]-s[0])*(o[1]-s[1])/(o[0]-s[0])+s[1],(s[1]===o[1]||t[1]<=n)&&(r+=1)),s=o;if(r%2==0)return !1;return !0}([t,e],s)}}function cT(t){const e=t.slice(0,8).concat(t[0],t[1]),i=[];for(let t=0;t<4;t++){const n=(e[2*t]+e[2*(t+1)])/2,s=(e[2*t+1]+e[2*(t+1)+1])/2;i.push(n,s);}return i}class dT{constructor(t,e,n){i(this,"areaUid",void 0),i(this,"left",void 0),i(this,"top",void 0),i(this,"width",void 0),i(this,"height",void 0),i(this,"boxes",void 0),i(this,"isVisible",!0),i(this,"zoom",1),i(this,"oldRect",void 0),i(this,"oldQuad",void 0),i(this,"isModified",!1),i(this,"isDrawNewBox",!1),i(this,"activeBoxUid",void 0),i(this,"activePartNum",-1),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"isMouseDown",!1),i(this,"isDrawing",!1),i(this,"renderer",void 0),this.renderer=t,this.areaUid=e,this.boxes=[],this.updateAreaRect(n);}hasActiveBox(){return !!this.activeBoxUid}getFullVertexes(){return [0,0,this.width,0,this.width,this.height,0,this.height]}isContainRect(t){return t.left>=0&&t.left<=this.width&&t.left+t.width<=this.width&&t.top>=0&&t.top<=this.height&&t.top+t.height<=this.height}isContainBox(t){const e=t.getRect();return this.isContainRect(e)}isFullBox(t){const{vertexes:e}=t;return 0===e[0]&&0===e[1]&&e[2].toFixed(2)===this.width.toFixed(2)&&0===e[3]&&e[4].toFixed(2)===this.width.toFixed(2)&&e[5].toFixed(2)===this.height.toFixed(2)&&0===e[6]&&e[7].toFixed(2)===this.height.toFixed(2)}addRectBox(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t=this.handleBoundary(t),this.addBox(t,!0,e,i)}updateRectBox(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=t.getRect(),s=t.getQuad();if(e=this.handleBoundary(e),t.initBox(e),i){const e={box:t};t.isRect?(e.oldRect=n,e.newRect=t.getRect()):(e.oldQuad=s,e.newQuad=t.getQuad()),this.renderer.hooks.boxModified.emit(e);}}handleBoundary(t){t=[...t];for(let e=0;e<4;e++){const i=[t[2*e],t[2*e+1]];i[0]=Yn(i[0],0,this.width),i[1]=Yn(i[1],0,this.height),[t[2*e],t[2*e+1]]=i;}return t}addQuadBox(t){return this.addBox(t,!1)}addBox(t){let e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=new hT({isRect:!(arguments.length>1&&void 0!==arguments[1])||arguments[1],area:this,renderer:this.renderer,vertexes:[...t],keepAspectRatio:this.renderer.config.keepAspectRatio});return this.boxes.push(n),e&&this.renderer.hooks.boxCreated.emit({box:n,fromEvent:i}),n}getBoxRects(){return this.boxes.map(((t,e)=>({index:e,...t.getRect()})))}getBoxByUid(t){return this.boxes.find((e=>e.uid===t))}deleteBoxByUid(t){const e=this.boxes.findIndex((e=>e.uid===t));e>-1&&this.boxes.splice(e,1);}clearBoxes(){this.boxes.length=0;}updateAreaRect(t){this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height;}setKeepAspectRatio(t){this.isDrawing||this.boxes.forEach((e=>{e.keepAspectRatio=t;}));}isTouchedPoint(t,e,i){return t=Yn(t,0,this.width),e=Yn(e,0,this.height),this.boxes.some((n=>{const s=n.getActivePartNum(t,e,i);return s>-1&&s<8}))}isTouchedBox(t,e,i){return t=Yn(t,0,this.width),e=Yn(e,0,this.height),this.boxes.some((n=>n.getActivePartNum(t,e,i)>-1))}onStartHandler(t,e,i){this.isMouseDown=!0,t=Yn(t,0,this.width),e=Yn(e,0,this.height),this.startX=t,this.startY=e;const n=this.boxes.find((n=>{const s=n.getActivePartNum(t,e,i);return s>-1&&(this.activePartNum=s),s>-1}));n&&(this.oldRect=n.getRect(),this.oldQuad=n.getQuad(),this.activeBoxUid=n.uid,n.keepAspectRatio=this.renderer.config.keepAspectRatio,n.onStartHandler(t,e,void 0,i));}onMoveHandler(t,e,i,n){if(!this.isMouseDown)return;let s;if(t=Yn(t,0,this.width),e=Yn(e,0,this.height),this.activeBoxUid){if(s=this.getBoxByUid(this.activeBoxUid),!s)return;const{keepAspectRatioWithShift:n,keepAspectRatio:o,enableMoveQuad:r}=this.renderer.config;if(s.isRect)s.keepAspectRatio=!(!i||!n)||o;else if(!r&&8===this.activePartNum)return;return s.onMoveHandler(t,e),void(this.isModified=!0)}const{enableCreateBoxByPointer:o,enableMultiple:r}=this.renderer.config;if((r||!this.boxes.length)&&o){const{startX:i,startY:o}=this;let r=e-o;const a=t-i;let l=-1;const h=2/this.zoom;if(a<-h&&r<-h?l=0:a>h&&r<-h?l=1:a>h&&r>h?l=2:a<-h&&r>h&&(l=3),l>-1){const{aspectRatio:h}=this.renderer.config;h>0&&(r=a/h,l%2&&(r=-a/h));const c=[],d=l%2?[i,o,i,o+r,t,o+r,t,o]:[t,o+r,i,o+r,i,o,t,o];for(let t=0;t<4;t++)c.push(d[2*(l+t)%8]),c.push(d[(2*(l+t)+1)%8]);s=this.addRectBox(c,!1),this.isDrawNewBox=!0,s.keepAspectRatio=h>0,this.isDrawing=!0,this.activeBoxUid=s.uid,s.onStartHandler(this.startX,this.startY,l,n),s.onMoveHandler(t,e,l);}}}onEndHandler(){if(!this.isMouseDown||!this.activeBoxUid)return;this.isMouseDown=!1;const t=this.getBoxByUid(this.activeBoxUid);if(t){if(t.keepAspectRatio=this.renderer.config.keepAspectRatio,t.onEndHandler(),this.isDrawNewBox)this.isDrawNewBox=!1,this.renderer.hooks.boxCreated.emit({box:t,fromEvent:!1});else if(this.isModified){const e={box:t};t.isRect?(e.oldRect=this.oldRect,e.newRect=t.getRect()):(e.oldQuad=this.oldQuad,e.newQuad=t.getQuad()),this.renderer.hooks.boxModified.emit(e);}this.oldRect=null,this.oldQuad=null,this.isModified=!1,this.isDrawing=!1,this.activeBoxUid=null,this.activePartNum=-1;}}isPointHover(t){let[e,i]=t;return e>=0&&e<=this.width&&i>=0&&i<=this.height}getCursorInfo(t,e,i){for(let n=this.boxes.length-1;n>=0;n--){const s=this.boxes[n],o=s.getActivePartNum(t,e,i);if(o>-1){let t="move";return o<8&&(t=s.checkOrientation(o)),{part:o,position:t,isRect:s.isRect}}}return null}}const uT={aspectRatio:0,keepAspectRatio:!1,keepAspectRatioWithShift:!0,enableMultiple:!1,enableCreateBoxByPointer:!0,enableCursor:!0,enableMask:!0,enableMagnifier:!0,moveThreshold:2,enableMoveQuad:!1,magnifier:{fixed:!1,fixedTop:0,fixedLeft:0,size:50,magnification:2},boxStyle:{borderColor:"orange",borderWidth:2,borderStyle:[5,2],background:"rgba(255,255,255,0)",ctrlBorderWidth:2,ctrlBorderRadius:4,ctrlBorderColor:"orange",ctrlWidth:16,ctrlHeight:16,ctrlBackground:"rgba(255,0,0,0)",invalidCtrlBorderColor:"red",invalidBorderColor:"red",ctrlRadiusMultipleMobile:2},enableEditCropBoxVertices:!0,enableEditCropBoxMidpoints:!0,enableHideEditingCropBoxVertex:!0,enableHideEditingCropBoxMidpoint:!0};class pT{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"areas",void 0),i(this,"scrollTop",0),i(this,"scrollLeft",0),i(this,"zoom",1),i(this,"config",void 0),i(this,"canvasDom",void 0),i(this,"isMousedown",!1),i(this,"isEditing",!1),i(this,"editingCursor",18),i(this,"hoveredArea",void 0),i(this,"hooks",{boxCreated:is(),boxModified:is(),boxDeleted:is()}),this.areas=new Map,this.zoom=1,this.config=Nn(uT),Ws(t,this.config),this.setCanvasDom(t.canvas);}setCanvasDom(t){t&&(this.canvasDom=t);}updateConfig(t){Ws(t,this.config);}addArea(t,e){if(this.areas.has(t)){const i=this.areas.get(t);return i.updateAreaRect(e),i}const i=new dT(this,t,e);return this.areas.set(t,i),i}deleteArea(t){if(this.areas.has(t)){this.areas.get(t).boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);})),this.areas.delete(t);}}clearArea(){this.areas.forEach((t=>{t.boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);}));})),this.areas.clear();}clearAreaBoxes(t){if(this.areas.has(t)){const e=this.areas.get(t);e.boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);})),e.clearBoxes();}}addRectBox(t,e){return this.areas.get(e).addRectBox(t)}addQuadBox(t,e){return this.areas.get(e).addQuadBox(t)}updateOptions(t){Object.assign(this,t),Xn(t.zoom)&&this.areas.forEach((e=>{e.zoom=t.zoom;}));}getAreaByUid(t){return this.areas.get(t)}deleteAreaByUid(t){this.areas.delete(t);}getHoveredArea(t){const e=this.nativeToCanvas(t);for(const t of this.areas.values()){const i=this.canvasToArea(e,t);if(t.isPointHover(i)&&t.isVisible)return t}return null}getHoveredAreaForCursor(t){const e=bs(t),i=this.nativeToCanvas(t);for(const t of this.areas.values()){const n=this.canvasToArea(i,t),[s,o]=n,r=t.isVisible&&t.boxes.find((t=>t.getActivePartNum(s,o,e)>-1));if(t.isPointHover(n)||r)return t}return null}isControlPointTouched(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return !1;const i=this.nativeToCanvas(t),[n,s]=this.canvasToArea(i,e),o=bs(t);return e.isTouchedPoint(n,s,o)}isBoxTouched(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return !1;const i=this.nativeToCanvas(t),[n,s]=this.canvasToArea(i,e),o=bs(t);return e.isTouchedBox(n,s,o)}onStartHandler(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return;this.hoveredArea=e,this.isMousedown=!0;const i=this.nativeToCanvas(t),[n,s]=this.canvasToArea(i,e),o=bs(t);e.onStartHandler(n,s,o);}onMoveHandler(t){if(!this.canvasDom)return null;let e=null;const i=this.getHoveredArea(t),n=bs(t),s=this.nativeToCanvas(t);if(this.isMousedown){const[e,i]=this.canvasToArea(s,this.hoveredArea);this.hoveredArea.onMoveHandler(e,i,As(t),n);}if(this.config.enableCursor&&i&&"mouse"===t.pointerType)if(this.hasBox()){const[t,o]=this.canvasToArea(s,i),r=i.getCursorInfo(t,o,n);if(null===r)this.config.enableMultiple&&(e=18);else if(r.isRect){switch(r.position){case"n":case"s":e=20;break;case"w":case"e":e=21;break;case"nw":e=22;break;case"ne":e=23;break;case"sw":e=24;break;case"se":e=25;break;case"move":e=19;}}else r.part>-1&&r.part<8&&(e=18);}else e=18;return e}hasBox(){for(const t of this.areas.values())if(t.isVisible&&t.boxes.length)return !0;return !1}onEndHandler(t){this.isMousedown&&(this.isMousedown=!1,this.isEditing=!1,this.hoveredArea.onEndHandler(),this.hoveredArea=null);}render(){if(!this.canvasDom||!this.areas.size)return;const t=this.canvasDom.getContext("2d");t.setTransform(1,0,0,1,0,0),this.areas.forEach((e=>{e.isVisible&&e.boxes.length&&this.renderArea(t,e);}));}renderArea(t,e){const{borderStyle:i,borderColor:n,borderWidth:s,ctrlBorderColor:o,ctrlBackground:r,ctrlBorderWidth:a,ctrlBorderStyle:l,background:h,maskColor:c,invalidBorderColor:d,invalidCtrlBorderColor:u,ctrlBorderRadius:p,ctrlWidth:g,ctrlHeight:f}=this.config.boxStyle,v=devicePixelRatio,m=g*v,y=f*v,x=Math.min(p*v,m/2,y/2),w=[i[0]*v,i[1]*v],b=s*v,S=a*v,C=[l[0]*v,l[1]*v];t.save(),t.beginPath(),t.rect(e.left*v,e.top*v,e.width*e.zoom*v,e.height*e.zoom*v),t.closePath(),t.clip(),this.config.enableMask&&c&&(t.save(),t.beginPath(),t.rect(e.left*v,e.top*v,e.width*e.zoom*v,e.height*e.zoom*v),e.boxes.forEach((i=>{let n=this.areaPointsToCanvas(i.points.slice(0,8),e),s=this.areaPointsToCanvas(i.midpoints.slice(0,8),e);1!==v&&(n=n.map((t=>t*v)),s=s.map((t=>t*v))),t.moveTo(n[0],n[1]);for(let e=1;e<4;e++)t.lineTo(n[2*e],n[2*e+1]);})),t.closePath(),t.clip("evenodd"),t.fillStyle=c,t.fill(),t.restore()),e.boxes.forEach((i=>{let s=this.areaPointsToCanvas(i.points.slice(0,8),e),a=this.areaPointsToCanvas(i.midpoints.slice(0,8),e);1!==v&&(s=s.map((t=>t*v)),a=a.map((t=>t*v))),t.save(),t.setLineDash(w),t.strokeStyle=i.isConvex?n:d,t.fillStyle=""===h?"transparent":h,t.lineWidth=b,t.beginPath(),t.moveTo(s[0],s[1]);for(let e=1;e<4;e++)t.lineTo(s[2*e],s[2*e+1]);t.closePath(),t.fill(),t.stroke(),t.setLineDash(C),t.strokeStyle=i.isConvex?o:u,t.fillStyle=""===r?"transparent":r,t.lineWidth=S,this.config.enableEditCropBoxVertices&&this.drawCtrlPoints(t,s,m,y,x,this.config.enableHideEditingCropBoxVertex?i.selectedPart:-1),this.config.enableEditCropBoxMidpoints&&this.drawCtrlPoints(t,a,m,y,x,this.config.enableHideEditingCropBoxMidpoint?i.selectedPart-4:-1),t.restore();})),t.restore();}drawCtrlPoints(t,e,i,n,s,o){const r=i/2,a=n/2;for(let l=0;l<4;l++){if(l===o)continue;t.beginPath();const h=e[2*l],c=e[2*l+1];if(0===s)t.rect(h-r,c-a,i,n);else {const{PI:e}=Math;t.arc(h-r+s,c-a+s,s,e,3*e/2),t.arc(h+r-s,c-a+s,s,3*e/2,2*e),t.arc(h+r-s,c+a-s,s,0,e/2),t.arc(h-r+s,c+a-s,s,e/2,e);}t.closePath(),t.fill(),t.stroke();}}areaPointsToCanvas(t,e){const i=[];for(let n=0;n<4;n++){const[s,o]=this.areaToCanvas([t[2*n],t[2*n+1]],e);i.push(s,o);}return i}canvasToArea(t,e){let[i,n]=t;const{scrollLeft:s,scrollTop:o,zoom:r}=this;return i=(i-e.left+s)/r,n=(n-e.top+o)/r,[i,n]}areaToCanvas(t,e){let[i,n]=t;const{scrollLeft:s,scrollTop:o,zoom:r}=this;return i=i*r+e.left-s,n=n*r+e.top-o,[i,n]}nativeToCanvas(t){const e=function(t){return ["touchstart","touchend","touchmove"].includes(t.type)}(t)?t.targetTouches[0]:t,i=this.canvasDom.getBoundingClientRect(),{scrollX:n,scrollY:s}=window;return [e.pageX-n-i.left,e.pageY-s-i.top]}}class gT{constructor(t){i(this,"canvas",void 0),i(this,"style",{type:"rect",size:100,borderColor:"#323232",borderWidth:3,magnification:3,crosshairWidth:1,crosshairColor:"#323232"}),Object.assign(this.style,t||{}),this.canvas=document.createElement("canvas");}render(t){const{type:e,size:i,borderColor:n,borderWidth:s,magnification:o,crosshairColor:r,crosshairWidth:a}=this.style,l=i/2*devicePixelRatio,h=i*devicePixelRatio,c=2*Math.PI,d=t.canvas.getContext("2d",{willReadFrequently:!0});d.save(),d.setTransform(1,0,0,1,0,0),t.targetX*devicePixelRatio<h&&t.targetY*devicePixelRatio<h?d.translate(t.canvas.width-l,l):d.translate(l,l),d.beginPath(),"circle"===e?d.arc(0,0,l,0,c):d.rect(-l,-l,h,h),d.clip(),d.scale(o,o),d.clearRect(-l,-l,2*l,2*l);const u=d.getImageData(t.targetX*devicePixelRatio-l,t.targetY*devicePixelRatio-l,h,h);this.canvas.width=h,this.canvas.height=h;this.canvas.getContext("2d").putImageData(u,0,0),d.drawImage(this.canvas,-l,-l,h,h),d.closePath(),d.strokeStyle=n,d.lineWidth=s,d.stroke(),d.beginPath();const p=.5*l/o;d.moveTo(0,-p),d.lineTo(0,p),d.moveTo(-p,0),d.lineTo(p,0),d.closePath(),d.strokeStyle=r,d.lineWidth=a/o,d.stroke(),d.restore();}}class fT{constructor(t,e){i(this,"context",void 0),i(this,"core",void 0),i(this,"boxRenderer",void 0),i(this,"viewer",void 0),i(this,"isMousedown",!1),i(this,"magnifier",void 0),i(this,"canvas",void 0),i(this,"isRenderMagnifier",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),this.viewer=t,this.context=t.context,this.core=t.context.core,this.boxRenderer=e,this.magnifier=new gT(this.context.viewerConfig.croppingMagnifierStyle),this.canvas=this.context.rendererService.getCanvasDom();}afterRenderForMagnifier(){if(this.needRenderMagnifier){const t=this.magnifierPoint;this.magnifier.render({target:this.canvas,targetX:t.x,targetY:t.y,canvas:this.canvas,canvasX:t.x,canvasY:t.y});}}isEditCropBox(t){const e=this.boxRenderer.getHoveredArea(t);return !(!e||!e.isVisible||e.boxes.length&&!this.boxRenderer.isBoxTouched(t))}isNotOverCropBox(t){return this.boxRenderer.hasBox()&&!this.boxRenderer.isBoxTouched(t)}mousedown(t){const{context:e}=this,i=this.context.getActiveTab();if(null==i||!i.total)return;if("crop"!==this.context.viewerConfig.toolMode)return;const[n]=this.context.toCanvas(t),{page:s}=this.context.getPointerOverPageInfo(n.pageX,n.pageY).pageInfo;if(i&&s&&s.uid!==i.currentUid){const t=i.getPageIndex(s);i.gotoPage(t),this.context.emitPageChangedEvent(i),this.context.core.viewerService.onCurrentChangedByScroll.emit(tf.create(i.uid,e.groupUid,e.uid,t)),this.context.emitPageChangedAfterRenderEvent(i);}this.isMousedown=!0,this.boxRenderer.onStartHandler(t);const o=!this.boxRenderer.hasBox()||this.boxRenderer.isControlPointTouched(t);this.isRenderMagnifier=o,o&&e.viewerConfig.enableMagnifier&&!bm(t)&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:n.pageX,y:n.pageY});}mousemove(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;if("crop"!==this.context.viewerConfig.toolMode)return;window.TouchEvent&&t instanceof TouchEvent&&t.cancelable&&t.preventDefault();const i=this.boxRenderer.onMoveHandler(t);if(bm(t)&&this.context.applyCursorState(i),this.isMousedown&&this.context.render("cropMoveHandler"),this.isRenderMagnifier&&this.context.viewerConfig.enableMagnifier&&!bm(t)){this.needRenderMagnifier=!0;const[e]=this.context.toCanvas(t);this.magnifierPoint={x:e.pageX,y:e.pageY};}}mouseup(t){this.isMousedown&&(this.boxRenderer.onEndHandler(t),this.isRenderMagnifier=!1,this.isMousedown=!1,this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render("cropEndHandler"));}afterPerspective(t){let{pageUid:e,docUid:i,width:n,height:s}=t;const{context:o}=this,r=o.tabService.getTab(i);if(!r)return;const a=r.getPageByUid(e);if(a&&(a.rWidth=n,a.rHeight=s,o.clearOptimization([a.uid])),r.isActive){if("crop"===o.viewerConfig.toolMode){this.boxRenderer.areas.forEach((t=>{t.clearBoxes();}));const t=this.boxRenderer.getAreaByUid(e),i=r.getPageByUid(e).getRect();null==t||t.updateAreaRect(i);}a&&(a.isLoaded=!1),o.scrollByCurrentChanged=!0;let t=!0;this.context.isDefaultViewer?"none"===r.context.fitMode&&(t=!1):this.context.isThumbnailViewer&&(t=!1),this.context.showTab(r,t);}}afterRotatePages(t){const{context:e}=this;if("crop"!==e.viewerConfig.toolMode)return;const i=this.context.getActiveTab();null!=i&&i.total&&i.uid===t.docUid&&(this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),t.pageUids.forEach((t=>{const e=this.boxRenderer.getAreaByUid(t),n=i.getPageByUid(t).getRect();null==e||e.updateAreaRect(n);})),this.context.render("afterRotatePages"));}afterRender(t){const{context:e}=this;"crop"===e.viewerConfig.toolMode&&(t.pages.forEach((e=>{const i=this.boxRenderer.getAreaByUid(e.uid);if(i){if(e.isVisible){const t=e.getRect();i.updateAreaRect(t);}"current"===this.viewer.cropMode?i.isVisible=e.uid===t.currentUid:i.isVisible=e.isVisible;}})),this.boxRenderer.updateOptions({zoom:t.context.zoom}),this.boxRenderer.render());}toolModeChanged(t){if("crop"!==t.oldToolMode&&"crop"===t.newToolMode){const t=this.context.getActiveTab();if(!t)return;t.pages.forEach((e=>{const i=e.getRect(),n=this.boxRenderer.addArea(e.uid,i);"current"===this.viewer.cropMode?n.isVisible=e.uid===t.currentUid:n.isVisible=e.isVisible;})),this.boxRenderer.updateOptions({zoom:t.context.zoom});}else "crop"!==t.newToolMode&&"crop"===t.oldToolMode&&(this.boxRenderer.clearArea(),this.context.render("toolModeChanged"));}pageChanged(t){if("crop"!==this.context.viewerConfig.toolMode)return;return this.context.getActiveTab()?0===t.total?(this.clearRedundantBoxes(),this.boxRenderer.clearArea(),void this.context.render("pageChanged")):void("current"===this.viewer.cropMode&&this.resetPageCropArea()):void 0}deletePages(t){t.pageUids.forEach((t=>{this.boxRenderer.deleteArea(t);}));}updatePage(t){const{context:e}=this;if("crop"!==e.viewerConfig.toolMode)return;const i=e.getActiveTab();if(i&&i.uid===t.docUid)if("current"===this.viewer.cropMode&&t.pageUid===i.currentUid)this.resetPageCropArea();else if("all"===this.viewer.cropMode){const n=this.boxRenderer.getAreaByUid(t.pageUid),s=i.getPageByUid(t.pageUid).getRect();n.updateAreaRect(s),this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),e.render("updatePage");}}addPages(t){const e=this.context.getActiveTab();null!=e&&e.total&&e.uid===t.docUid&&(t.pageUids.forEach((t=>{const i=e.getPageByUid(t),n=i.getRect();this.boxRenderer.addArea(i.uid,n),this.boxRenderer.updateOptions({zoom:e.context.zoom});})),this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})));}resetPageCropArea(){const t=this.context.getActiveTab();this.clearRedundantBoxes();const e=t.getCurrentPage(),i=e.getRect();this.boxRenderer.addArea(e.uid,i),this.boxRenderer.updateOptions({zoom:t.context.zoom}),this.context.render("resetPageCropArea");}clearRedundantBoxes(){const t=this.context.getActiveTab();t&&"current"===this.viewer.cropMode&&this.boxRenderer.areas.forEach((e=>{e.areaUid!==t.currentUid&&this.boxRenderer.clearAreaBoxes(e.areaUid);}));}}class vT{constructor(t,e){i(this,"context",void 0),i(this,"core",void 0),i(this,"boxRenderer",void 0),i(this,"viewer",void 0),i(this,"isMousedown",!1),i(this,"canSlide",!1),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"isSliding",void 0),i(this,"slideDistance",void 0),i(this,"slideDirection",void 0),i(this,"slideRAF",void 0),i(this,"tabX",void 0),i(this,"tabY",void 0),i(this,"magnifier",void 0),i(this,"canvas",void 0),i(this,"isRenderMagnifier",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),this.viewer=t,this.context=t.context,this.core=t.context.core,this.boxRenderer=e,this.magnifier=new gT(this.context.viewerConfig.croppingMagnifierStyle),this.canvas=this.context.rendererService.getCanvasDom();}afterRenderForMagnifier(){if(this.needRenderMagnifier){const t=this.magnifierPoint;this.magnifier.render({target:this.canvas,targetX:t.x,targetY:t.y,canvas:this.canvas,canvasX:t.x,canvasY:t.y});}}isNotOverQuadCtrl(t){return this.boxRenderer.hasBox()&&!this.boxRenderer.isControlPointTouched(t)}mousedown(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;this.isMousedown=!0;if(!this.boxRenderer.isControlPointTouched(t)&&this.context.viewerConfig.enableSlide)this.canSlide=!0,this.slideStart(t);else {this.boxRenderer.onStartHandler(t);const e=this.boxRenderer.isControlPointTouched(t);if(this.isRenderMagnifier=e,e&&this.context.viewerConfig.enableMagnifier&&!bm(t)){const[e]=this.context.toCanvas(t);this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY};}}}mousemove(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;if(bs(t)&&t.cancelable&&t.preventDefault(),this.canSlide)this.slideMove(t);else {const e=this.boxRenderer.onMoveHandler(t);if(bm(t)&&this.context.applyCursorState(e),this.isMousedown&&this.context.render("perspectiveMove"),this.isRenderMagnifier&&this.context.viewerConfig.enableMagnifier&&!bm(t)){const[e]=this.context.toCanvas(t);this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY};}}}mouseup(t){this.isMousedown&&(this.canSlide?this.slideEnd(t):this.boxRenderer.onEndHandler(t),this.isRenderMagnifier=!1,this.canSlide=!1,this.isMousedown=!1,this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render("perspectiveEnd"));}reRender(){const{context:t}=this,e=t.getActiveTab();null!=e&&e.total&&"visible"===t.viewerConfig.visibility&&(this.updatePageQuad(e),t.render("resize or visibilityChanged"));}updatePage(t){const{context:e}=this,i=e.getActiveTab();null!=i&&i.total&&"visible"===e.viewerConfig.visibility&&i.currentUid===t.pageUid&&(this.updatePageQuad(i),e.render("updatePagePerspective"));}afterRender(t){if(null==t||!t.total)return;const{boxRenderer:e}=this;t.pages.forEach((t=>{const i=e.getAreaByUid(t.uid);if(i&&t.isVisible){const e=t.getRect();i.updateAreaRect(e);}})),e.updateOptions({zoom:t.context.zoom}),e.render();}pageChanged(t){if(-1===t.current&&0===t.total)return void this.boxRenderer.clearArea();const e=this.context.getActiveTab();e&&this.updatePageQuad(e);}updatePageQuad(t){const{context:e}=this,i=t.getCurrentPage();if(!i)return !1;let n=null;const s=this.boxRenderer.getAreaByUid(i.uid);s&&s.boxes[0]&&(n=s.boxes[0].getQuad());const o=e.core.pageService.getPage(t.currentUid);this.boxRenderer.clearArea();const r=i.getRect(),a=this.boxRenderer.addArea(i.uid,r);this.boxRenderer.updateOptions({zoom:t.context.zoom});const l=o.getQuadVertices(),h=a.addQuadBox(l);let c=h.getQuad();return n&&(n=o.quadToPixelPPI(n)),c&&(c=o.quadToPixelPPI(c)),uv(n),uv(c),e.hooks.perspectiveQuadChanged.emit(ef.create(c,n,o.isFull)),h}afterRotatePages(t){const e=this.context.getActiveTab();null!=e&&e.total&&t.pageUids.includes(e.currentUid)&&(this.updatePageQuad(e),this.context.render("afterRotatePagesPerspective"));}afterPerspective(t){let{pageUid:e,docUid:i}=t;const{context:n}=this,s=this.context.getActiveTab();if(null==s||!s.total)return;if(s.uid!==i||s.currentUid!==e)return;const o=s.getCurrentPage();o&&(o.isLoaded=!1),this.updatePageQuad(s),n.scrollByCurrentChanged=!0,n.showTab(s,!0);}slideStart(t){if(!this.context.viewerConfig.enableSlide)return;if(this.isSliding)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;const{scrollLeft:i,scrollTop:n}=this.context.viewService.getMaxScrollValue();if(i||n)return;const s=this.context.toCanvas(t);if(s.length>1)return;const o=e.getPosition();this.tabX=o.x,this.tabY=o.y,this.startX=s[0].pageX,this.isStart=!0;}slideMove(t){if(!this.isStart)return;const{context:e}=this,{viewerConfig:i}=e,n=e.getActiveTab(),s=e.toCanvas(t)[0].pageX-this.startX;if(s>0?this.slideDirection="right":s<0&&(this.slideDirection="left"),this.slideDistance=Math.min(n.context.viewportWidth,Math.abs(s)),this.isSliding)"right"===this.slideDirection?n.setPosition({x:this.slideDistance+this.tabX,y:this.tabY,z:0}):"left"===this.slideDirection&&n.setPosition({x:-this.slideDistance+this.tabX,y:this.tabY,z:0}),e.render("slideMovePerspective");else if(n&&"single"===n.context.displayMode&&"crop"===i.toolMode&&i.enableSlide){const{scrollLeft:t,scrollTop:n}=this.context.viewService.getMaxScrollValue();Math.abs(s)>i.startSlideThresholdForPerspective&&!t&&!n&&(this.isSliding=!0,e.configService.updateConfig({displayMode:"slide"}));}}slideEnd(t){if(!this.isStart)return;const{context:e}=this,i=e.getActiveTab(),{displayMode:n}=i.context;"slide"===n&&this.slide(i),this.isStart=!1;}slide(t){let e,i=0,n=0,s=0,o=!1;const{viewerConfig:r}=this.context,a=t.context.viewportWidth*r.slideThresholdForPerspective;this.slideDistance>=Math.max(a,r.startSlideThresholdForPerspective)?(n=t.context.viewportWidth,e=n-this.slideDistance,"left"===this.slideDirection?t.current!==t.total-1?(s=-this.slideDistance,i=-e/6):(n=0,e=this.slideDistance,o=!0,s=-this.slideDistance,i=e/6):0!==t.current?(s=this.slideDistance,i=e/6):(n=0,e=this.slideDistance,o=!0,s=this.slideDistance,i=-e/6)):(o=!0,n=0,e=this.slideDistance,"left"===this.slideDirection?(s=-this.slideDistance,i=e/6):(s=this.slideDistance,i=-e/6));const l=()=>{s+=i;const e=s>=0;if(Math.abs(s)>=n&&(s=n,e||(s*=-1)),t.setPosition({x:s+this.tabX,y:this.tabY,z:0}),Math.abs(s)===n)return o||("right"===this.slideDirection?this.context.viewer.gotoPage(t.current-1):this.context.viewer.gotoPage(t.current+1),this.context.configService.updateConfig({fitMode:"window"})),this.isSliding=!1,this.context.configService.updateConfig({displayMode:"single"}),void cancelAnimationFrame(this.slideRAF);this.slideRAF=requestAnimationFrame(l),this.context.render("Slide");};this.slideRAF=requestAnimationFrame(l);}}class mT{constructor(t){i(this,"service",void 0),this.service=t;}startHandler(t){this.service.mousedown(t);}moveHandler(t){this.service.mousemove(t);}endHandler(t){this.service.mouseup(t);}isEditCropBox(t){return this.service.isEditCropBox(t)}isNotOverCropBox(t){return this.service.isNotOverCropBox(t)}}class yT{constructor(t){i(this,"service",void 0),this.service=t;}startHandler(t){this.service.mousedown(t);}moveHandler(t){this.service.mousemove(t);}endHandler(t){this.service.mouseup(t);}isNotOverQuadCtrl(t){return this.service.isNotOverQuadCtrl(t)}}function xT(t,e){return {left:zs(t.left,e),top:zs(t.top,e),width:zs(t.width,e),height:zs(t.height,e)}}const wT={install(t){const e=t.getClass("Viewer"),n=(s=e,class extends s{constructor(t){super(t),i(this,"boxRenderer",void 0),i(this,"iCropMode","current"),i(this,"cropRectService",void 0),i(this,"perspectiveQuadService",void 0);const{isDefaultViewer:e,isPerspectiveViewer:n}=this.context;(e||n)&&(this.initBoxRenderer(),this.bindExternalEvents()),this.cropRectService=new fT(this,this.boxRenderer),this.perspectiveQuadService=new vT(this,this.boxRenderer),this.listenDefaultViewerEventsForBox(),this.listenDefaultGlobalEventsForBox(),this.listenPerspectiveViewerEventsForBox(),this.listenPerspectiveGlobalEventsForBox(),this.context.hasBoxRendererModule=!0,this.context.cropBoxEditService=new mT(this.cropRectService),this.context.perspectiveQuadEditService=new yT(this.perspectiveQuadService);}initBoxRenderer(){if(!this.context.isDefaultViewer&&!this.context.isPerspectiveViewer)return;const{enableEditCropBoxMidpoints:t,enableEditCropBoxVertices:e,enableHideEditingCropBoxMidpoint:i,enableHideEditingCropBoxVertex:n}=this.context.viewerConfig;this.boxRenderer=new pT({enableEditCropBoxMidpoints:t,enableEditCropBoxVertices:e,enableHideEditingCropBoxMidpoint:i,enableHideEditingCropBoxVertex:n}),this.boxRenderer.setCanvasDom(this.context.rendererService.getCanvasDom()),this.updateQuadStyle(),this.context.hooks.quadSelectionStyleChanged.on((()=>{this.updateQuadStyle();}),this),this.hooks.resize.on((()=>{this.context.render("resize");}),this);const{hooks:s}=this.boxRenderer;s.boxCreated.on((t=>{let{box:e,fromEvent:i}=t;const n=this.context.getActiveTab();if(null!=n&&n.total&&(this.context.isDefaultViewer&&e.isRect&&!i&&"all"===this.cropMode&&this.boxRenderer.areas.forEach((t=>{t.boxes.length?t.boxes.forEach((i=>{t.isContainBox(e)?t.updateRectBox(i,[...e.vertexes]):t.clearBoxes();})):t.isContainBox(e)&&t.addRectBox([...e.vertexes],!0,!0);})),e.isRect)){let t=e.getRect();t=Hs(t,ko.displayResolution,72),t=xT(t,2);const i=cf.create(t);this.hooks.cropRectDrawn.emit(i);}})),s.boxDeleted.on((t=>{const e=this.context.getActiveTab();if(null!=e&&e.total&&t.isRect){let e=t.getRect();e=Hs(e,ko.displayResolution,72),e=xT(e,2);const i=hf.create(e);this.hooks.cropRectDeleted.emit(i);}})),s.boxModified.on((t=>{const e=this.context.getActiveTab();if(null==e||!e.total)return;const{box:i}=t;if(this.context.isDefaultViewer&&i.isRect){let{oldRect:e,newRect:n}=t,s=0;if("all"===this.cropMode&&this.boxRenderer.areas.forEach((t=>{t.boxes.length?t.boxes.forEach((e=>{t.isContainBox(i)?(s+=1,t.updateRectBox(e,[...i.vertexes])):t.clearBoxes();})):t.isContainBox(i)&&t.addRectBox([...i.vertexes]);})),e&&(e=Hs(e,ko.displayResolution,72),e=xT(e,2)),n&&(n=Hs(n,ko.displayResolution,72),n=xT(n,2)),!e||!n||e.left!==n.left||e.top!==n.top||e.width!==n.width||e.height!==n.height){s=Math.max(1,s);for(let t=0;t<s;t++){const t=df.create(e,n);this.hooks.cropRectModified.emit(t);}}}if(this.context.isPerspectiveViewer&&!i.isRect){const e=this.context.core.pageService.getPage(i.area.areaUid),n=this.boxRenderer.getAreaByUid(i.area.areaUid);if(!n)return;const s=n.isFullBox(i);e.isFull=s,e.setActiveQuad(i.getQuad());let{oldQuad:o,newQuad:r}=t;o&&(o=e.quadToPixelPPI(o)),r&&(r=e.quadToPixelPPI(r)),uv(o),uv(r),this.hooks.perspectiveQuadChanged.emit(ef.create(r,o,e.isFull));}}));}updateQuadStyle(){const t=this.context.styleService.getParsedQuadSelectionStyle();this.boxRenderer.updateConfig({boxStyle:t});}bindExternalEvents(){this.hooks.cropRectDrawn.on((t=>{this.emit("cropRectDrawn",{rect:t.rect});}),this),this.hooks.cropRectDeleted.on((t=>{this.emit("cropRectDeleted",{rect:t.rect});}),this),this.hooks.cropRectModified.on((t=>{this.emit("cropRectModified",{oldRect:t.oldRect,newRect:t.newRect});}),this),this.hooks.perspectiveQuadChanged.on((t=>{const{newQuad:e,oldQuad:i}=t;let n=!1;i&&e&&(n=Vs(i,e)),n||this.emit("quadModified",{oldQuad:i,newQuad:e});}),this);}get cropMode(){return this.iCropMode}set cropMode(t){if(this.iCropMode===t)return;const e=this.iCropMode;this.iCropMode=t;const i=this.context.getActiveTab();if(null!=i&&i.total){if("current"===e&&"all"===t){const t=this.boxRenderer.getAreaByUid(i.currentUid).boxes[0];t&&this.boxRenderer.areas.forEach((e=>{e.isContainBox(t)?e.boxes.length?e.updateRectBox(e.boxes[0],[...t.vertexes]):e.addRectBox([...t.vertexes]):e.clearBoxes();}));}this.cropRectService.clearRedundantBoxes(),this.context.render("setCropMode");}}toggleFullPerspective(){const{context:t}=this;if(!t.isPerspectiveViewer)return;const e=t.getActiveTab();null!=e&&e.total&&t.core.pageService.getPage(e.currentUid).toggleFull()&&(this.perspectiveQuadService.updatePageQuad(e),t.render("toggleFullPerspective"));}listenDefaultGlobalEventsForBox(){this.context.isPerspectiveViewer||(this.context.core.editService.onAfterRotatePages.on((t=>{this.cropRectService.afterRotatePages(t);}),this),this.context.core.onAfterPerspective.on((t=>{this.cropRectService.afterPerspective(t);}),this));}listenPerspectiveGlobalEventsForBox(){this.context.isPerspectiveViewer&&(this.context.core.editService.onAfterRotatePages.on((t=>{this.perspectiveQuadService.afterRotatePages(t);}),this),this.context.core.onAfterPerspective.on((t=>{this.perspectiveQuadService.afterPerspective(t);}),this));}listenPerspectiveViewerEventsForBox(){if(!this.context.isPerspectiveViewer)return;const{perspectiveQuadService:t}=this;this.hooks.resize.on((()=>{t.reRender();}),this),this.hooks.visibleChanged.on((()=>{t.reRender();}),this),this.hooks.updatePage.on((e=>{t.updatePage(e);}),this),this.hooks.afterRender.on((e=>{t.afterRender(e),t.afterRenderForMagnifier();}),this),this.hooks.pageChanged.on((e=>{t.pageChanged(e);}),this);}listenDefaultViewerEventsForBox(){if(!this.context.isDefaultViewer)return;const{cropRectService:t}=this;this.hooks.updatePage.on((e=>{t.updatePage(e);}),this),this.hooks.addPagesToDoc.on((e=>{t.addPages(e);}),this),this.hooks.afterRender.on((e=>{t.afterRender(e),t.afterRenderForMagnifier();}),this),this.hooks.toolModeChanged.on((e=>{t.toolModeChanged(e);}),this),this.hooks.pageChanged.on((e=>{t.pageChanged(e);}),this),this.hooks.deletePages.on((e=>{t.deletePages(e);}),this),this.hooks.beforeCropPages.on((()=>{this.clearRectBox();}),this),this.hooks.closeDocument.on((t=>{t.pages.forEach((t=>{this.boxRenderer.deleteArea(t);}));}),this);}setRectBox(t,e){const i=this.context.getActiveTab();return !(!i||!i.total||(_n(e)&&(e=[i.current]),i.indicesToUids(e).forEach((e=>{let i=t;i=Hs(t,ko.dataResolution,ko.displayResolution);const n=(t=>{const{left:e,top:i,width:n,height:s}=t;return [e,i,e+n,i,e+n,i+s,e,i+s]})(i),s=this.boxRenderer.areas.get(e);s.boxes.length?s.updateRectBox(s.boxes[0],n,!0):s.addRectBox(n);})),this.context.render("setRectBox"),0))}getRectBox(){const t=this.context.getActiveTab();if(t&&t.total){let e=null;if(t.pages.find((t=>{const i=this.boxRenderer.getAreaByUid(t.uid);return !(null==i||!i.boxes.length||(e=i,0))})),e){const t=e.boxes[0];if(null!=t&&t.isRect){let e=t.getRect();return e=Hs(e,ko.displayResolution,ko.dataResolution),e=xT(e,2),e.width=e.width||1,e.height=e.height||1,e}}}return null}getRenderedRectBoxCount(){const t=this.context.getActiveTab();let e=0;return t&&t.total&&this.boxRenderer.areas.forEach((t=>{e+=t.boxes.length;})),e}getCropIndices(){const t=this.context.getActiveTab();let e=[];if(t&&t.total)if("all"===this.iCropMode){const i=[];this.boxRenderer.areas.forEach((t=>{t.boxes.length&&i.push(t.areaUid);})),e=t.uidsToIndices(i);}else e=[t.current];return e}clearRectBox(){return this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),!0}setQuadBox(t){const e=this.context.getActiveTab();if(!e||!e.total)return !1;const i=this.context.core.pageService.getPage(e.currentUid);let n=t;n=t.map((t=>Hs(t,i.resource.resolutionX,ko.displayResolution)));const s=this.boxRenderer.getAreaByUid(e.currentUid),{width:o,height:r}=s,a=av(n,o,r);return i.isFull=a,i.setActiveQuad(n),this.perspectiveQuadService.updatePageQuad(e),this.context.render("setQuadBox"),!0}getQuadBox(){const t=this.context.getActiveTab();if(t&&t.total){const e=this.boxRenderer.getAreaByUid(t.currentUid).boxes[0];if(!e.isRect){let i=e.getQuad();const n=this.context.core.pageService.getPage(t.currentUid);return i=i.map((t=>Hs(t,ko.displayResolution,n.resource.resolutionX))),uv(i),i}}return null}resetQuadBox(t){const e=this.context.getActiveTab();if(null==e||!e.total)return !1;let i=[];return i=_n(t)?[e.currentUid]:e.indicesToUids(t),i.forEach((t=>{const i=this.context.core.pageService.getPage(t),{quad:n}=i;n?(i.isFull&&(i.isFull=!1),i.setActiveQuad(n),this.perspectiveQuadService.updatePageQuad(e)):i.isFull||(i.isFull=!0,this.perspectiveQuadService.updatePageQuad(e));})),this.context.render("resetQuadBox"),!0}clearQuadBox(){return this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),!0}isConvexQuad(t){return to(t.flat())}});var s;t.setClass("Viewer",n);}};class bT extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="rotate",this.isValid=!0,this.core.commandService.onBeforeRefreshCommands.on((t=>{const{pageUids:e}=this.action;e.slice().forEach((i=>{if(t.pageUids.includes(i)){const t=e.indexOf(i);e.splice(t,1);}})),this.isValid=e.length>0;}),this);}execute(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).addAction(e);}));const i=Lf.create(e.docUid,e.angle,e.pageUids);return t.editService.onRotatePages.emit(i),t.editService.onAfterRotatePages.emit(i),!0}undo(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).deleteAction(e.actionUid);}));const i=Lf.create(e.docUid,e.angle,e.pageUids);t.editService.onRotatePages.emit(i),t.editService.onAfterRotatePages.emit(i);}}class ST extends Sm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="crop",this.isValid=!0,this.core.commandService.onBeforeRefreshCommands.on((t=>{const{pageUids:e}=this.action;e.slice().forEach((i=>{if(t.pageUids.includes(i)){const t=e.indexOf(i);e.splice(t,1);}})),this.isValid=e.length>0;}),this);}execute(){const{core:t,action:e}=this;e.pageUids.forEach((e=>{t.pageService.getPage(e).addAction(this.action);}));const i=Rf.create(e.docUid,e.rect,e.pageUids);return t.editService.onCropPages.emit(i),t.editService.onAfterCropPages.emit(i),!0}undo(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).deleteAction(e.actionUid);}));const i=Rf.create(e.docUid,e.rect,e.pageUids);t.editService.onCropPages.emit(i),t.editService.onAfterCropPages.emit(i);}}class CT extends js{constructor(t){super(),i(this,"core",void 0),i(this,"onRotatePages",void 0),i(this,"onAfterRotatePages",void 0),i(this,"onCropPages",void 0),i(this,"onAfterCropPages",void 0),this.core=t,this.initEventEmitter();}initEventEmitter(){this.onRotatePages=Gs(this),this.onAfterRotatePages=Gs(this),this.onCropPages=Gs(this),this.onAfterCropPages=Gs(this);}rotatePages(t,e,i,n){const s={actionUid:Jn(),type:"rotate",docUid:t,pageUids:[...e],angle:i,rotationType:n},{core:o}=this,r=new bT(s,o);return o.commandService.execute(r,t),!0}cropPages(t,e,i){const n={actionUid:Jn(),type:"crop",docUid:t,pageUids:[...e],rect:{...i}},{core:s}=this,o=new ST(n,s);return s.commandService.execute(o,t),!0}}const PT={apply(t){t.editService=new CT(t);},install(t){const e=t.getClass("Viewer"),i=(n=e,class extends n{constructor(t){super(t),this.listenGlobalEventsForEdit(),this.listenViewerEventsForEdit();}listenGlobalEventsForEdit(){const{context:t}=this,e=e=>{let{docUid:i,pageUids:n}=e;const s=t.tabService.getTab(i);if(null!=s&&s.isActive){t.scrollByCurrentChanged=!0,t.clearOptimization(n);let e=!0;t.isDefaultViewer?"none"===s.context.fitMode&&(e=!1):t.isThumbnailViewer&&(e=!1),t.showTab(s,e);}};t.core.editService.onRotatePages.on(e,this),t.core.editService.onCropPages.on(e,this);}listenViewerEventsForEdit(){this.hooks.beforeLayout.on((t=>{const{core:{pageService:e},isDefaultViewer:i,isThumbnailViewer:n,isPerspectiveViewer:s}=this.context;(i||n||s)&&t.pages.forEach((t=>{let s=null;const o=e.getPage(t.uid);s=i||n?o.getEditResult():o.getEditResultForPerspective(),s&&(t.rWidth=s.rWidth,t.rHeight=s.rHeight,t.cropLeft=s.cropLeft,t.cropTop=s.cropTop,t.cropWidth=s.cropWidth,t.cropHeight=s.cropHeight,t.rotation=s.rotation,t.mediaBoxRect=s.mediaBox,t.cropBoxRect=s.cropBox);}));}),this);}rotatePages(t,e){var i;if(t%360==0)return !0;const n=this.context.getActiveTab();if(!n)return !1;null!==(i=e)&&void 0!==i||(e=[n.current]);const s=n.indicesToUids(e);return this.context.core.editService.rotatePages(n.uid,s,t,"contain")}cropPages(t,e){var i;const n=this.context.getActiveTab();if(!n)return !1;null!==(i=e)&&void 0!==i||(e=[n.current]);const s=n.indicesToUids(e);t=Hs(t,ko.dataResolution,ko.displayResolution),this.hooks.beforeCropPages.emit();const o=this.context.core.editService.cropPages(n.uid,s,t);return this.context.clearSelectedTexts(),this.hooks.afterCropPages.emit(s),o}});var n;t.setClass("Viewer",i);}};class TT{async perspective(t,e,i,n){var s;const o=new xo,r=await o.initImage({source:t.data,isRGBA:t.type===co.RGBA,width:t.width,height:t.height,isBGRA:t.type===co.BGRA});r.srcBuffer&&(t.data=r.srcBuffer),null!=i&&i.angle&&await o.rotate({angle:i.angle}),await o.perspective(e);const a=await o.getImage({jpegQuality:null==n?void 0:n.jpegQuality,ifDeleteObject:!0,isRGBA:t.type===co.RGBA,bitDepth:null==n?void 0:n.bitDepth,xDpi:null==n?void 0:n.xdpi,yDpi:null==n?void 0:n.ydpi,returnBlob:!1,returnType:To[null!==(s=null==n?void 0:n.outputType)&&void 0!==s?s:t.type]});await o.freeReservedData();const l={data:new Blob([a.imageData],{type:a.blobType}),width:a.imageWidth,height:a.imageHeight,resolutionX:a.imageXResolution,resolutionY:a.imageYResolution};return o.terminate(),l}}var AT=new WeakMap,kT=new WeakMap,ET=new WeakSet,DT=new WeakSet,RT=new WeakSet;function IT(t,e,i,n){return (new TT).perspective(t,e,i,n)}function MT(t){return n(this,AT).push(t),n(this,kT)||(s(this,kT,!0),p(this,RT,BT).call(this)),t.promise}async function BT(){do{if(n(this,AT).isEmpty())break;const t=n(this,AT).pop();try{let e;if("perspective"===(null==t?void 0:t.api))e=await p(this,ET,IT).apply(this,t.params);null==t||t.resolve(e);}catch(e){t.retry<1?(t.retry+=1,n(this,AT).push(t)):null==t||t.reject(e);}}while(!n(this,AT).isEmpty());s(this,kT,!1);}gm.registerPlugin(kw),gm.registerPlugin(lT),gm.registerPlugin(wT),gm.registerPlugin(PT),gm.registerPlugin(sx),gm.registerPlugin(OC);const UT=new gm(new class{constructor(){this.registerParser("image/jpeg",Dc),this.registerParser("image/bmp",Dc),this.registerParser("image/png",Dc),this.registerParser("image/tiff",Rc),this.registerParser("image/jp2",Dc),this.registerParser("application/pdf",Cd),this.registerParser("image/rgba",Td),this.registerParser("application/ddv-blank-image",Xd);}dispose(){this.reset();}reset(){kd.getAllParsers().forEach((t=>t.destroy())),kd.clear(),Rd.clear();}freeParserByFileUid(t){Bd.execute(t);}registerParser(t,e){Nd.execute({mime:t,parser:e});}unregisterParser(t){_d.execute(t);}registerCustomParser(t,e){Fd.execute({mime:t,parser:e});}unregisterCustomParser(t){Hd.execute(t);}getDefaultParserOptions(t){return Vd.execute(t)}setDefaultParserOptions(t,e){return zd.execute({mime:t,options:e})}getCustomParserClasses(t){return $d.execute(t)}async parse(t,e,i,n,s){return Od.execute({fileData:t,mime:e,fileUid:i,indices:n,parseOptions:s})}async parseAnnotation(t,e,i,n,s,o){return Wd.execute({fileData:t,mime:e,fileUid:i,indices:s,parseOptions:o,parsedPages:n})}async getPage(t,e,i,n){return Ld.execute({fileData:t,mime:e,fileUid:i,fileIndex:n})}cancelGetPage(t,e){Md.execute({fileUid:t,fileIndex:e});}async getParseInfo(t,e,i,n){return jd.execute({fileData:t,mime:e,fileUid:i,options:n})}async getPageTexts(t,e,i,n){return Ud.execute({fileData:t,mime:e,fileUid:i,indices:n})}},new class{constructor(){this.registerSaver("application/pdf",$o),this.registerSaver("image/png",jo),this.registerSaver("image/jpeg",jo),this.registerSaver("image/tiff",Xo);}registerSaver(t,e){Mo.execute({mime:t,saverConstructor:e});}unregisterSaver(t){Bo.execute(t);}getSaver(t){return Io.execute(t)}},new class{constructor(){v(this,RT),v(this,DT),v(this,ET),f(this,AT,{writable:!0,value:new Po}),f(this,kT,{writable:!0,value:!1});}dispose(){throw new Error("Method not implemented.")}perspective(t,e,i,n){return this.createTask("perspective",[t,e,i,n])}createTask(t,e){const i={api:t,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)i.params.push(t);return i.promise=new Promise(((t,e)=>{i.resolve=t,i.reject=e;})),p(this,DT,MT).call(this,i)}cancelTask(t,e){const i={api:t,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)i.params.push(t);n(this,AT).remove(i);}},new class{constructor(){v(this,xu),v(this,yu),v(this,mu),i(this,"filter",void 0),f(this,fu,{writable:!0,value:new Po}),f(this,vu,{writable:!0,value:!1});}get enableFilter(){return !!this.filter}async applyFilter(t,e,i,n){return this.createTask("filter",[t,e,i,n])}cancelFilter(t,e){}setImageFilter(t){t?this.filter=t:this.filter&&(this.filter.destroy(),this.filter=null);}getDefaultFilterType(){var t;return (null===(t=this.filter)||void 0===t?void 0:t.defaultFilterType)||Yd.NONE}getSupportedFilters(){var t;return (null===(t=this.filter)||void 0===t?void 0:t.querySupported())||[]}createTask(t,e){const i={api:t,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)i.params.push(t);return i.promise=new Promise(((t,e)=>{i.resolve=t,i.reject=e;})),p(this,yu,bu).call(this,i)}cancelTask(t,e){const i={api:t,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)i.params.push(t);n(this,fu).remove(i);}},new class{constructor(){i(this,"detector",void 0);}get enableDetect(){return this.detector&&this.detector instanceof ou}detect(t,e){var i;return null===(i=this.detector)||void 0===i?void 0:i.detect(t,e)}setDetector(t){t?this.detector=t:this.detector&&(this.detector.destroy(),this.detector=null);}resetDetector(){this.detector&&this.detector.reset();}reset(){var t;null===(t=this.detector)||void 0===t||t.destroy(),this.detector=null;}}),LT="Layout",OT="Button",WT="Capture",NT="Flashlight",_T="CameraConvert",FT="CameraResolution",HT="AutoDetect",VT="AutoCapture",zT="ImagePreview",$T="Rotate",jT="RotateLeft",XT="RotateRight",GT="Delete",YT="DeleteCurrent",qT="DeleteAll",JT="Zoom",ZT="ZoomIn",QT="ZoomOut",KT="ZoomByPercentage",tA="Crop",eA="CropMode",iA="CropCurrent",nA="CropAll",sA="FullQuad",oA="PerspectiveAll",rA="Undo",aA="Redo",lA="FitMode",hA="FitWindow",cA="FitHeight",dA="FitWidth",uA="ActualSize",pA="DisplayMode",gA="SinglePage",fA="ContinuousPage",vA="Pan",mA="Load",yA="Download",xA="Print",wA="Filter",bA="Restore",SA="ThumbnailSwitch",CA="Pagination",PA="TextSelectionMode",TA="Done",AA="Back",kA="Blank",EA="Close",DA="MainView",RA="SeparatorLine",IA="AnnotationSet",MA="EllipseAnnotation",BA="EraseAnnotation",UA="InkAnnotation",LA="LineAnnotation",OA="PolygonAnnotation",WA="PolylineAnnotation",NA="RectAnnotation",_A="SelectAnnotation",FA="StampIconAnnotation",HA="StampImageAnnotation",VA="TextBoxAnnotation",zA="TextTypewriterAnnotation",$A="HighlightAnnotation",jA="UnderlineAnnotation",XA="StrikeoutAnnotation",GA="BringForward",YA="BringToFront",qA="SendBackward",JA="SendToBack",ZA="TextSearchPanel",QA="TextSearchPanelSwitch";function KA(t,e,i,n){return !!_n(t)&&Iu.output(e,i,n,void 0,Du.PARAM_MISS,!0)}function tk(t,e,i,n){return !!Wn(t)||Iu.output(e,i,n,void 0,Du.PARAM_INVALID)}class ek{static getTooltip(){return LC.getTooltip()}static setTooltip(t){const e="Elements.setTooltip",i="tooltip";return !(KA(t,1,e,i)||!tk(t,1,e,i))&&(LC.setTooltip(t),!0)}static getDisplayTextConfig(){return LC.getDisplayTextConfig()}static setDisplayTextConfig(t){const e="Elements.displayTextConfig",i="displayTextConfig";return !(KA(t,1,e,i)||!tk(t,1,e,i))&&(LC.setDisplayTextConfig(t),!0)}static get Layout(){return LT}static get Button(){return OT}static get Capture(){return WT}static get Flashlight(){return NT}static get CameraConvert(){return _T}static get CameraResolution(){return FT}static get AutoDetect(){return HT}static get AutoCapture(){return VT}static get ImagePreview(){return zT}static get Rotate(){return $T}static get RotateLeft(){return jT}static get RotateRight(){return XT}static get Delete(){return GT}static get DeleteCurrent(){return YT}static get DeleteAll(){return qT}static get Zoom(){return JT}static get ZoomIn(){return ZT}static get ZoomOut(){return QT}static get ZoomByPercentage(){return KT}static get Crop(){return tA}static get CropCurrent(){return iA}static get CropAll(){return nA}static get FullQuad(){return sA}static get PerspectiveAll(){return oA}static get Undo(){return rA}static get Redo(){return aA}static get Pan(){return vA}static get CropMode(){return eA}static get Load(){return mA}static get Download(){return yA}static get Print(){return xA}static get Filter(){return wA}static get Restore(){return bA}static get ThumbnailSwitch(){return SA}static get Pagination(){return CA}static get FitMode(){return lA}static get FitWindow(){return hA}static get FitHeight(){return cA}static get FitWidth(){return dA}static get ActualSize(){return uA}static get DisplayMode(){return pA}static get SinglePage(){return gA}static get ContinuousPage(){return fA}static get MainView(){return DA}static get SeparatorLine(){return RA}static get Done(){return TA}static get Back(){return AA}static get Blank(){return kA}static get Close(){return EA}static get AnnotationSet(){return IA}static get EllipseAnnotation(){return MA}static get EraseAnnotation(){return BA}static get InkAnnotation(){return UA}static get LineAnnotation(){return LA}static get PolygonAnnotation(){return OA}static get PolylineAnnotation(){return WA}static get RectAnnotation(){return NA}static get SelectAnnotation(){return _A}static get StampIconAnnotation(){return FA}static get StampImageAnnotation(){return HA}static get TextBoxAnnotation(){return VA}static get TextTypewriterAnnotation(){return zA}static get BringForward(){return GA}static get BringToFront(){return YA}static get SendBackward(){return qA}static get SendToBack(){return JA}static get HighlightAnnotation(){return $A}static get UnderlineAnnotation(){return jA}static get StrikeoutAnnotation(){return XA}static get TextSelectionMode(){return PA}static get TextSearchPanel(){return ZA}static get TextSearchPanelSwitch(){return QA}}const ik={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-capture-viewer-header-mobile",children:[{type:"CameraResolution",className:"ddv-capture-viewer-resolution"},ek.Flashlight]},ek.MainView,{type:"Layout",className:"ddv-capture-viewer-footer-mobile",children:[ek.AutoDetect,ek.AutoCapture,{type:"Capture",className:"ddv-capture-viewer-captureButton"},ek.ImagePreview,ek.CameraConvert]}]},nk={type:"Layout",flexDirection:"column",className:"ddv-edit-viewer-mobile",children:[{type:"Layout",className:"ddv-edit-viewer-header-mobile",children:[ek.Blank,ek.AnnotationSet,ek.Pagination,ek.Download,ek.TextSearchPanelSwitch]},ek.MainView,{type:"Layout",className:"ddv-edit-viewer-footer-mobile",children:[ek.DisplayMode,ek.RotateLeft,ek.Crop,ek.Undo,ek.Delete,ek.Load]},{type:ek.TextSearchPanel,className:"ddv-edit-viewer-search-mobile"}]},sk={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-perspective-viewer-header-mobile",children:[ek.Blank,ek.Pagination,ek.PerspectiveAll]},ek.MainView,{type:"Layout",className:"ddv-perspective-viewer-footer-mobile",children:[ek.FullQuad,ek.RotateLeft,ek.RotateRight,ek.DeleteCurrent,ek.DeleteAll]}]},ok={type:"Layout",flexDirection:"column",className:"ddv-capture-viewer-desktop",children:[{type:"Layout",className:"ddv-capture-viewer-header-desktop",children:[{type:ek.CameraResolution,className:"ddv-capture-viewer-resolution-desktop"},ek.AutoDetect,{type:ek.Capture,className:"ddv-capture-viewer-capture-desktop"},ek.AutoCapture]},ek.MainView,{type:ek.ImagePreview,className:"ddv-capture-viewer-image-preview-desktop"}]},rk={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-perspective-viewer-header-desktop",children:[ek.FullQuad,ek.RotateLeft,ek.RotateRight,ek.DeleteCurrent,ek.DeleteAll,{type:ek.Pagination,className:"ddv-perspective-viewer-pagination-desktop"},{type:ek.PerspectiveAll,className:"ddv-perspective-viewer-perspective-desktop"}]},ek.MainView]},ak={type:ek.Layout,flexDirection:"column",className:"ddv-edit-viewer-desktop",children:[{type:ek.Layout,className:"ddv-edit-viewer-header-desktop",children:[{type:ek.Layout,enableScroll:!0,children:[ek.ThumbnailSwitch,ek.Zoom,ek.FitMode,ek.DisplayMode,ek.RotateLeft,ek.RotateRight,ek.Crop,ek.Undo,ek.Redo,ek.DeleteCurrent,ek.DeleteAll,ek.Pan,ek.TextSelectionMode,ek.SeparatorLine,ek.AnnotationSet]},{type:ek.Layout,children:[{type:ek.Pagination,className:"ddv-edit-viewer-pagination-desktop"},ek.Load,ek.Download,ek.Print,ek.TextSearchPanelSwitch]}]},{type:ek.Layout,flexDirection:"row",children:[ek.MainView,ek.TextSearchPanel]}]},lk={type:ek.Layout,children:[ek.MainView]};Nn(nk).children[0].children=[ek.Blank,ek.Blank,ek.Pagination,ek.AnnotationSet,ek.Download];const hk=Nn(ak);var ck,dk;hk.children[0].children[0].enableScroll=!0,hk.children[0].children[0].children.push(ek.SeparatorLine,ek.AnnotationSet),function(t){t.REJECTED="rejected",t.ACCEPTED="accepted",t.INITIAL_HERE="initialHere",t.SIGN_HERE="signHere",t.WITNESS="witness",t.APPROVED="approved",t.NOT_APPROVED="notApproved",t.DRAFT="draft",t.FINAL="final",t.COMPLETED="completed",t.CONFIDENTIAL="confidential",t.VOID="void";}(ck||(ck={})),function(t){t.NONE="none",t.OPEN="open",t.OPEN_REVERSE="openReverse",t.CLOSED="closed",t.CLOSED_REVERSE="closedReverse",t.BUTT="butt",t.SLASH="slash",t.SQUARE="square",t.DIAMOND="diamond",t.CIRCLE="circle";}(dk||(dk={}));const uk={background:"#e2e1de"},pk={border:"1px solid #707070",background:"#fff"},gk={border:"2px solid #fe8e14",background:"rgba(255,255,255,0)",maskColor:"rgba(128,128,128,0.6)",ctrlBorderRadius:"50%",ctrlBackground:"#fe8e14",ctrlBorder:"2px solid #fe8e14",ctrlWidth:"15px",ctrlHeight:"15px",invalidCtrlBorderColor:"red",invalidBorderColor:"red"},fk={opacity:1,borderWidth:1,borderColor:"rgb(0,0,0)",background:"",lineDash:[0,0]},vk={content:"",color:"rgb(0,0,0)",fontSize:16,fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",lineThrough:!1,underline:!1},mk={content:"",color:"rgb(0,0,0)",fontSize:1536/72,fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",lineThrough:!1,underline:!1};jn()&&(fk.borderWidth=3,vk.fontSize=72);const yk={...fk,lineEnding:{start:dk.NONE,end:dk.NONE}},xk={paletteConfig:{maxFontSize:256,maxBorderWidth:40,colorList:["#F01314","#FD7C10","#FFEE5F","#07C37F","#0E68F5","#9D3BFE","#000000","#FF9494","#87440C","#B7A514","#046743","#50C9FF","#EBA3ED","#ffffff","#CECECE"],labels:{text:"Text",stroke:"Stroke",fill:"Fill",opacity:"Opacity",style:"Style",standardBusiness:"StandardBusiness"}},toolbarConfig:{},annotationSelectionStyle:{border:"1px solid #59626A",background:"",ctrlBorderRadius:"6px",ctrlWidth:"12px",ctrlHeight:"12px",ctrlBorder:"1px solid #59626A",ctrlBackground:"white"},inkCreateDelay:1e3,showOnTopWhenSelected:!1,enableContinuousDrawing:!1,defaultStyleConfig:{rectangle:{...fk},ellipse:{...fk},polygon:{...fk},polyline:{...yk},line:{...yk},ink:{opacity:1,borderWidth:jn()?3:1,borderColor:"rgb(0,0,0)"},textBox:{...fk,textAlign:"left",textContent:{...vk}},textTypewriter:{opacity:1,textContent:{...vk}},stamp:{opacity:1,stamp:ck.DRAFT},highlight:{background:"#FD7C10",opacity:1},underline:{borderColor:"#0E68F5",opacity:1},strikeout:{borderColor:"#F01314",opacity:1}}},wk={canvasStyle:{...uk},quadSelectionStyle:{...gk},enableAutoCapture:!1,enableAutoDetect:!1,enableTorch:!1,maxFrameNumber:10,acceptedPolygonConfidence:80};function bk(t,e){return !!t.getActiveTab()||Iu.output(e,void 0,void 0,void 0,Du.DOC_NOT_OPEN)}function Sk(t,e,i,n){return !i.getActiveTab().doc.pages.length&&Iu.output(n,t,e,void 0,Du.DOC_NO_IMAGE,!0)}function Ck(t,e,i,n){return !!function(t){return !(!Xn(t)||Xn(t)&&!Number.isInteger(t))}(t)||Iu.output(n,e,i,void 0,Du.PARAM_INVALID)}function Pk(t,e,i,n,s){const o=qD.isUiConfigValid(t,n);if(o.length>0)return Iu.output(s,i,n,o);const r=WD(t,e);return !r||Iu.output(s,e.charAt(0).toUpperCase()+e.slice(1),r,void 0,Du.ELEMENT_UNSUPPORTED)}function Tk(t,e,i,n,s,o){return (t<e||t>i)&&Iu.output(n,s,o,void 0,Du.PARAM_OUT_OF_RANGE,!0)}function Ak(t,e,i,n){return !!t.includes(e)||Iu.output(i,n,void 0,void 0,Du.PAGE_NOT_EXIST)}function kk(t,e,i,n){return !!$n(t)||Iu.output(n,e,i,void 0,Du.PARAM_INVALID)}function Ek(t,e,i,n,s){const o=Iu.formatError(Iu.isStringAndNotEmpty(t,s));return !o||Iu.output(e,i,n,void 0,o)}function Dk(t,e,i,n,s,o,r){const a=qD.isNumberArrayValid(t,s,o,r);return !a.length||Iu.output(e,i,n,a,Du.PARAM_INVALID)}class Rk{getIsBoundContainer(t){return t.context.viewService.isBindContainer}bindContainer(t,e,i){KA(e,0,i,"container");const n=qD.isContainerParamValid(e);n&&Iu.error(i,"container",void 0,n),t.bindContainer(e);}unbindContainer(t){t.unbindContainer();}getIsVisible(t){return "visible"===t.getViewerConfig().visibility}show(t){t.show();}hide(t){t.hide();}getCurrentDocument(t){var e;const i=null===(e=t.getActiveTab())||void 0===e?void 0:e.uid;return i?lR.getDocument(i):null}openDocument(t,e,i){const n="docUid or doc";KA(t,0,i,n),function(t){if(Gn(t))return 0!==t.trim().length;return !1}(t)||Wn(t)||Iu.error(i,n,void 0,Du.PARAM_INVALID);const s=Wn(t)?t.uid:t;!function(t,e,i,n,s){!!t.getDocument(e)||Iu.output(i,n,s,void 0,Du.DOC_NOT_EXIST);}(UT.documentService,s,0,i,n),UT.getViewer(e)||Iu.error(i,"viewerUid",void 0,Du.PARAM_INVALID),UT.openDocument(s,e);}closeDocument(t,e){return !!bk(t,1)&&(t.closeDocument(),!0)}getStyle(t,e,i,n,s){const o="styleName";if(KA(i,1,s,o)||!Ek(i,1,s,o))return null;if(!n.includes(i))return Iu.warning(s,o,void 0,Du.PARAM_NOT_SUPPORT),null;if("annotationSelectionStyle"===i){return t.getAnnotationConfig().controlsStyle}const r=t.getViewerConfig();if(i in r){const t=function(t,e){const i=["border","background"],n=["left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY","opacity","visibility"],s={pageStyle:i,selectedPageStyle:i,hoveredPageStyle:i,canvasStyle:[...i,"cursor"],checkboxStyle:[...n,"checkMarkColor","checkMarkLineWidth"],pageNumberStyle:[...n,"color","fontSize","fontFamily","onPage"],quadSelectionStyle:["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground","invalidCtrlBorderColor","invalidBorderColor"]};if(t in s){const i=s[t];return Object.fromEntries(Object.entries(e).filter((t=>{let[e,n]=t;return i.includes(e)})))}return Nn(e)}(i,r[i]);return "capture"===e&&"quadSelectionStyle"===i?{border:t.border,background:t.background}:t}return null}updateStyle(t,e,i,n,s){return !(KA(e,1,s,"styleName")||KA(i,1,s,"style")||!Ek(e,1,s,"styleName")||!tk(i,1,s,"style")||!function(t,e,i,n,s,o){if(!Ek(t,o,n,s))return !1;if(!i.includes(t))return Iu.output(o,n,s,void 0,Du.PARAM_NOT_SUPPORT);const r=zD(t,e);return !r.length||Iu.output(o,n,"style",r)}(e,i,n,s,"styleName",1))&&("annotationSelectionStyle"===e?(t.updateAnnotationConfig({controlsStyle:i}),!0):(t.updateViewerConfig({[e]:i}),!0))}getUiConfig(t){return t.getUiConfig()}updateUiConfig(t,e,i,n){const s="uiConfig";return !(KA(e,1,n,s)||!Pk(e,i,n,s,1))&&t.updateUiConfig(e)}indexToUid(t,e,i){const n="index";if(KA(e,1,i,n)||!Ck(e,i,n,1)||!bk(t,1)||Sk(void 0,void 0,t,1))return "";return Tk(e,0,t.getPageCounts()-1,1,i,n)?"":t.indexToUid(e)}uidToIndex(t,e,i){if(KA(e,1,i,"uid")||!Ek(e,1,i,"uid",!1)||!bk(t,1)||Sk(void 0,void 0,t,1))return -1;return Ak(this.getCurrentDocument(t).pages,e,1,i)?t.uidToIndex(e):-1}getCurrentPageUid(t){return bk(t,1)?Sk(void 0,void 0,t,1)?"":t.getCurrentPageUid():""}getCurrentPageIndex(t){return bk(t,1)?Sk(void 0,void 0,t,1)?-1:t.getCurrentPageIndex():-1}getPageCount(t){return bk(t,1)?t.getPageCounts():-1}gotoPage(t,e,i){const n="index";if(KA(e,1,i,n)||!Ck(e,i,n,1)||!bk(t,1)||Sk(void 0,void 0,t,1))return -1;return Tk(e,0,t.getPageCounts()-1,1,i,n)?-1:t.gotoPage(e)}rotate(t,e,i,n){if(KA(e,1,n,"angle")||!Ck(e,n,"angle",1)||!function(t,e,i,n){return t%90==0||Iu.output(n,e,i,void 0,Du.PARAM_NOT_SUPPORT)}(e,n,"angle",1)||!bk(t,1)||Sk(void 0,void 0,t,1))return !1;if(!_n(i)){if(!Dk(i,1,n,"indices",0,this.getPageCount(t)-1))return !1}return t.rotatePages(e,i)}saveOperation(t){return !!bk(t,1)&&t.saveOperations()}on(t,e,i,n){!KA(i,1,e,"eventName")&&!KA(n,1,e,"listener")&&Ek(i,1,e,"eventName",!1)&&kk(n,e,"listener",1)&&t.on(i,n);}off(t,e,i,n){!KA(i,1,e,"eventName")&&Ek(i,1,e,"eventName",!1)&&(_n(n)||kk(n,e,"listener",1))&&t.off(i,n);}destroy(t){t&&t.dispose();}}function Ik(t,e,i,n){return !!zn(t)||Iu.output(n,e,i,void 0,Du.PARAM_INVALID)}function Mk(t,e,i,n,s,o){const r=Iu.formatError(Iu.isNumberAndIsInRange(t,s,o));return !r||Iu.output(e,i,n,void 0,r)}function Bk(t,e,i,n,s){if(!Wn(t))return Iu.output(i,n,s,void 0,Du.PARAM_INVALID);const o=[],r=["pageStyle","hoveredPageStyle","selectedPageStyle","currentPageStyle","placeholderStyle","canvasStyle","pageNumberStyle","checkboxStyle","quadSelectionStyle"];return Object.keys(t).forEach((i=>{const n=t[i];if("container"===i)o.push(...qD.isContainerKeyValid(n,s));else if("uiConfig"===i){const t=qD.isUiConfigValid(n,"option.uiConfig");if(t.length>0)o.push(...t);else {const t=WD(n,e);if(t){const i=Du.buildError(Du.ELEMENT_UNSUPPORTED,e.charAt(0).toUpperCase()+e.slice(1),t);o.push(`option.uiConfig: ${i.message}`);}}}else "viewerConfig"!==i&&"thumbnailConfig"!==i||Object.keys(n).forEach((t=>{const e=n[t];if(r.includes(t)){const n=zD(t,e);o.push(...n.map((t=>`${i}.${t}`)));}}));})),!(o.length>0)||Iu.output(i,n,s,o)}const Uk=["canvasStyle","quadSelectionStyle"],Lk="CaptureViewer";var Ok=new WeakMap,Wk=new WeakMap,Nk=new WeakSet;class _k{constructor(t){var e;v(this,Nk),f(this,Ok,{writable:!0,value:void 0}),f(this,Wk,{writable:!0,value:new Rk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0);const o=`new ${Lk}`;Ep.makeSureCoreLicenseExist(),Ep.makeSureCameraLicenseExist(),_n(t)||Bk(t,"captureViewer",0,o,"option");const r=Ws((null==t?void 0:t.viewerConfig)||{},Nn({...wk,viewerMode:dg.CAPTURE})),a=jn()?ik:ok;s(this,Ok,UT.createViewer({uiConfig:Nn(a),...t,viewerConfig:r})),null!=t&&null!==(e=t.viewerConfig)&&void 0!==e&&e.enableAutoDetect&&!n(this,Ok).context.core.detectorService.enableDetect&&Du.warning(Du.DOC_DETECT_MISS),this.uid=n(this,Ok).uid,this.groupUid=n(this,Ok).groupUid,this.postfix=n(this,Ok).postfix,p(this,Nk,Fk).call(this);}get isVisible(){return n(this,Wk).getIsVisible(n(this,Ok))}get isBoundContainer(){return n(this,Wk).getIsBoundContainer(n(this,Ok))}get currentDocument(){return n(this,Wk).getCurrentDocument(n(this,Ok))}get acceptedPolygonConfidence(){return n(this,Ok).getCameraConfig().acceptedPolygonConfidence}set acceptedPolygonConfidence(t){const e="acceptedPolygonConfidence";Mk(t,1,`${Lk}.${e}`,e,0,100)&&n(this,Ok).updateCameraConfig({acceptedPolygonConfidence:t});}get maxFrameNumber(){return n(this,Ok).getCameraConfig().maxFrameNumber}set maxFrameNumber(t){const e="maxFrameNumber";Mk(t,1,`${Lk}.${e}`,e,1e-6,60)&&n(this,Ok).updateCameraConfig({maxFrameNumber:t});}get enableAutoDetect(){return n(this,Ok).getCameraConfig().enableAutoDetect}set enableAutoDetect(t){const e="enableAutoDetect",i=`${Lk}.${e}`;Ik(t,i,e,1)&&(t&&!n(this,Ok).context.core.detectorService.enableDetect&&Iu.warning(i,void 0,void 0,Du.DOC_DETECT_MISS),n(this,Ok).updateCameraConfig({enableAutoDetect:t}));}get enableAutoCapture(){return n(this,Ok).getCameraConfig().enableAutoCapture}set enableAutoCapture(t){const e="enableAutoCapture";Ik(t,`${Lk}.${e}`,e,1)&&n(this,Ok).updateCameraConfig({enableAutoCapture:t});}bindContainer(t){n(this,Wk).bindContainer(n(this,Ok),t,`${Lk}.bindContainer`);}unbindContainer(){n(this,Wk).unbindContainer(n(this,Ok));}show(){n(this,Wk).show(n(this,Ok));}hide(){n(this,Wk).hide(n(this,Ok));}getUiConfig(){return n(this,Wk).getUiConfig(n(this,Ok))}updateUiConfig(t){return n(this,Wk).updateUiConfig(n(this,Ok),t,"captureViewer",`${Lk}.updateUiConfig`)}openDocument(t){n(this,Wk).openDocument(t,this.uid,`${Lk}.openDocument`);}closeDocument(){return n(this,Wk).closeDocument(n(this,Ok),`${Lk}.closeDocument`)}getStyle(t){return n(this,Wk).getStyle(n(this,Ok),"capture",t,Uk,`${Lk}.getStyle`)}updateStyle(t,e){return n(this,Wk).updateStyle(n(this,Ok),t,e,Uk,`${Lk}.updateStyle`)}capture(){return n(this,Ok).isVideoPlaying()?n(this,Ok).context.viewService.isBindContainer?n(this,Ok).capture():Du.reject(Du.CONTAINER_NO_BOUND):Du.reject(Du.CAMERA_NO_VIDEO)}play(t){const e=`${Lk}.play`;if(!_n(t)){const i=function(t,e,i,n){const s=qD.isVideoConfig(t,n);return !s.length||Iu.output(e,i,n,s)}(t,2,e,"config");if(!0!==i)return i}return n(this,Ok).play(t).catch((t=>Du.reject(t,e)))}stop(){n(this,Ok).stop();}getCurrentCamera(){return n(this,Ok).getCurrentCamera()}getAllCameras(){return n(this,Ok).getAllCameras()}selectCamera(t){const e=`${Lk}.selectCamera`,i="cameraObjectOrDeviceID",s=KA(t,2,e,i);if(s)return s;if(Gn(t)){const n=Ek(t,2,e,i,!1);if(!0!==n)return n}else {const n=function(t,e,i,n){const s=qD.isVideoDeviceInfo(t,n);return !s.length||Iu.output(e,i,n,s)}(t,2,e,i);if(!0!==n)return n}return n(this,Ok).selectCamera(t).catch((t=>Du.reject(t,e,i)))}getCurrentResolution(){return n(this,Ok).getCurrentResolution()}turnOnTorch(){return n(this,Ok).turnOnTorch().catch((t=>Du.reject(t)))}turnOffTorch(){return n(this,Ok).turnOffTorch().catch((t=>Du.reject(t)))}on(t,e){n(this,Wk).on(n(this,Ok),`${Lk}.on`,t,e);}off(t,e){n(this,Wk).off(n(this,Ok),`${Lk}.off`,t,e);}destroy(){n(this,Wk).destroy(n(this,Ok));}}function Fk(){n(this,Ok).hooks.destroy.on((()=>{s(this,Ok,null),Object.setPrototypeOf(this,null);}));}const Hk={canvasStyle:{...uk},currentPageStyle:{border:"4px solid #fe8e14"},pageStyle:{border:"6px solid rgba(0,0,0,0)",background:"rgba(255,255,255,0)"},selectedPageStyle:{border:"6px solid #AAAAAA",background:"#AAAAAA"},hoveredPageStyle:{border:"6px solid #AAAAAA",background:"#AAAAAA"},placeholderStyle:{border:"6px solid rgba(136,136,136,0.2)",background:"rgba(136,136,136,0.2)"},pageNumberStyle:{onPage:!1,visibility:"visible",width:"32px",height:"24px",background:"rgba(255,255,255,0)",border:"0px solid #000",borderRadius:"0px",opacity:1,color:"#323234",fontSize:"14px",fontFamily:"Open Sans",left:"50%",top:"",right:"",bottom:"3px",translateX:"-50%",translateY:"0px"},checkboxStyle:{visibility:"visible",width:"16px",height:"16px",background:"#fff",border:"2px solid #999999",borderRadius:"0px",opacity:1,left:"2px",top:"2px",checkMarkColor:"#FE8E14",checkMarkLineWidth:"2px",translateX:"0px",translateY:"0px"},rows:2,columns:2,multiselectMode:!1,scrollToLatest:!1,enableDragPage:!0,scrollDirection:"vertical"},Vk={...Hk,visibility:"hidden",size:"180px",position:"left",rows:4,columns:1,canvasStyle:{background:"#DDDDDD"}},zk={canvasStyle:{...uk},pageStyle:{...pk},quadSelectionStyle:{...gk},currentPageStyle:{border:"",background:""},minZoom:.01,maxZoom:64,scrollDirection:"vertical",enableSlide:!0,scrollToLatest:!1,enableMagnifier:!0},$k=["canvasStyle","pageStyle","selectedPageStyle","hoveredPageStyle","placeholderStyle","pageNumberStyle","checkboxStyle","currentPageStyle","cursorStyle"];var jk=new WeakSet;class Xk{constructor(t){var e,n;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"BaseBrowseViewer";v(this,jk),i(this,"v",void 0),i(this,"vCommon",new Rk),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),i(this,"errorPrefix",void 0),this.errorPrefix=s;const o=`new ${this.errorPrefix}`;Ep.makeSureCoreLicenseExist(),_n(t)||Bk(t,"browseViewer",0,o,"option");const r=YD(null==t?void 0:t.keyboardInteractionConfig),a=Ws((null==t?void 0:t.viewerConfig)||{},Nn({...Hk,viewerMode:dg.THUMBNAIL,displayMode:"multiple",toolMode:"pan",enableOptimizePage:!0})),l={passwordLoaderConfig:{enabled:null!==(e=null==t||null===(n=t.viewerConfig)||void 0===n?void 0:n.enablePasswordLoader)&&void 0!==e?e:"BrowseViewer"===s}};this.v=UT.createViewer({uiConfig:Nn(lk),...t,viewerConfig:{enablePopup:!0,...a,...r},popupConfig:l}),this.uid=this.v.uid,this.groupUid=this.v.groupUid,this.postfix=this.v.postfix,p(this,jk,Gk).call(this);}get isVisible(){return this.vCommon.getIsVisible(this.v)}get isBoundContainer(){return this.vCommon.getIsBoundContainer(this.v)}set multiselectMode(t){const e="multiselectMode";Ik(t,`${this.errorPrefix}.${e}`,e,1)&&this.v.updateViewerConfig({multiselectMode:t});}get multiselectMode(){return this.v.getViewerConfig().multiselectMode}show(){this.vCommon.show(this.v);}hide(){this.vCommon.hide(this.v);}getUiConfig(){return this.vCommon.getUiConfig(this.v)}updateUiConfig(t){return this.vCommon.updateUiConfig(this.v,t,"browseViewer",`${this.errorPrefix}.updateUiConfig`)}getStyle(t){return this.vCommon.getStyle(this.v,"browse",t,$k,`${this.errorPrefix}.getStyle`)}updateStyle(t,e){const i=`${this.errorPrefix}.updateStyle`;return this.vCommon.updateStyle(this.v,t,e,$k,i)}getSelectedPageIndices(){return bk(this.v,1)?this.v.getSelectedPageIndices():[]}selectAllPages(){if(!bk(this.v,1))return [];if(0===this.v.getPageCounts()){const t=`${this.errorPrefix}.selectAllPages`;return Iu.output(1,t,void 0,void 0,Du.DOC_NO_IMAGE),[]}return this.v.selectAllPages()}selectPages(t){const e=`${this.errorPrefix}.selectPages`,i="indices";if(KA(t,1,e,i)||!bk(this.v,1))return [];return Dk(t,1,e,i,0,this.v.getPageCounts()-1)?this.v.selectPagesByIndices(t):[]}setRowAndColumn(t,e){const i=`${this.errorPrefix}.setRowAndColumn`,n="row",s="column",{maxColumns:o,maxRows:r}=this.v.getViewerConfig();return !(KA(t,1,i,n)||KA(e,1,i,s)||!Ck(t,i,n,1)||!Ck(e,i,s,1)||Tk(t,1,r,1,i,n)||Tk(e,1,o,1,i,s))&&this.v.setRowAndColumn(t,e)}on(t,e){this.vCommon.on(this.v,`${this.errorPrefix}.on`,t,e);}off(t,e){this.vCommon.off(this.v,`${this.errorPrefix}.off`,t,e);}getVisiblePagesInfo(){return this.v.getVisiblePagesInfo()}}function Gk(){this.v.hooks.destroy.on((()=>{this.v=null,Object.setPrototypeOf(this,null);}));}function Yk(t,e,i,n,s){const o=qD.isAnnotationOptionsValid(t,n,s);return !o.length||Iu.output(e,i,n,o)}const qk={borderColor:"rgb(0,0,0)",background:"",borderWidth:1,opacity:1,lineDash:[0,0],flags:{print:!0,noView:!1,readOnly:!1},rotation:0};var Jk=new WeakMap;class Zk{constructor(t){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),f(this,Jk,{writable:!0,value:void 0}),s(this,Jk,t),this.uid=Jn(),this.creationDate=Zf(),this.modificationDate=this.creationDate;}get source(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return null}get pageUid(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(KA(t,1,e,"options"))return;if(!Ik(t,e,"options",1))return;UT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?UT.annotationService.flattenAnnotations([this.uid]):UT.annotationService.unFlattenAnnotation(this.uid));}getOptions(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);if(t){const e=t.getConfig(),i=tE(e,this.type);s(this,Jk,{...i}),this.modificationDate=e.comment.modificationDate;}return nE(this.type,n(this,Jk))}updateOptions(t){const e="Annotation.updateOptions";if(KA(t,1,e,"options"))return !1;if(!tk(t,1,e,"options"))return !1;if(!Yk(t,1,e,"options",this.type))return !1;const i=this.getOptions(),s=Qk(this.type,t,i);if(["rectangle","stamp","ellipse","textBox","ink"].includes(this.type)||(s.has("rotated")&&s.delete("rotated"),Xn(null==t?void 0:t.angle)&&(t.angle=void 0)),!s.size)return !0;this.getOptions(),Ws(t,n(this,Jk));const o=Kk({...n(this,Jk)},this.type);if(["highlight","underline","strikeout"].includes(this.type)){const{lines:t}=o.style;if(null!=t&&t.length){const e=16,i=t[0],n=t[t.length-1],s={left:i.left,top:i.top,width:e,height:e},r={left:n.left+n.width-e,top:n.top,width:e,height:n.height};o.startCharRect=s,o.endCharRect=r;const a=wm(t);o.style.borderWidth=a;}}return UT.annotationService.updateAnnotations([{annotationUid:this.uid,options:o}],void 0,[...s]),!0}}function Qk(t,e,i){const n="moved",s="resized",o="startPoint",r="endPoint",a=new Map([[["x","y"],"moved"],[["width","height","rects"],"resized"],[["rotation"],"rotated"],[["flags"],"flagsChanged"],[["borderWidth","borderColor","background","opacity","textAlign","lineCap","lineJoin","miterLimit","lineDash","lineEnding","textContents"],"appearanceChanged"],[["textContents","stamp"],"contentChanged"]]),l=Nn(e);l.flags={...i.flags,...(null==l?void 0:l.flags)||{}},["line","polyline"].includes(t)&&e.lineEnding&&(l.lineEnding={...i.lineEnding,...(null==l?void 0:l.lineEnding)||{}});const h=new Set,c=Object.keys(l);return c.forEach((e=>{if(!VD(i[e],l[e]))if("points"!==e||"ink"!==t&&"polygon"!==t&&"polyline"!==t)if(e!==o&&e!==r||"line"!==t)for(const[t,i]of a)t.includes(e)&&!h.has(i)&&h.add(i);else c.includes(o)&&c.includes(r)&&XD([i[o],i[r]],[l[o],l[r]])?h.add(n):h.add(s);else XD(i[e],l[e])?h.add(n):h.add(s);})),h}function Kk(t,e){const i=Nn(t),n={style:i,flags:[],transform:{angle:0}},{lineEnding:s,points:o,textContents:r,stamp:a,borderWidth:l,x:h,y:c,width:d,height:u,startPoint:p,endPoint:g,lineDash:f,rects:v}=i||{},m=ko.dataResolution,y=ko.displayResolution,x=["ink","line","polygon","polyline","highlight","underline","strikeout"].includes(e);if(v&&(n.style.lines=aE(v,m,y,"date")),o&&("ink"===e?n.style.segments=rE(o,m,y):n.style.points=oE(o,m,y)),s&&(n.style.lineEnding=eE(s,"date")),a&&(n.style.imageData=null,a instanceof Blob||Gn(a)&&RD(a)?n.style.imageData=a:Gn(a)?n.style.iconName=iE(a,"date"):GD(a)&&(n.style.stampConfig=a)),_n(l)||(n.style.borderWidth=Hs(l,m,y)),_n(h)||(x?delete n.style.x:n.style.x=Hs(h,m,y)),_n(c)||(x?delete n.style.y:n.style.y=Hs(c,m,y)),_n(d)||(n.style.width=Hs(d,m,y)),_n(u)||(n.style.height=Hs(u,m,y)),_n(f)||(n.style.lineDash=Hs(f,m,y)),_n(p)||(n.style.startPoint=Hs(p,m,y)),_n(g)||(n.style.endPoint=Hs(g,m,y)),r){const t=[];r.forEach((e=>{null!=e&&e.fontSize&&(e.fontSize=Hs(e.fontSize,m,y)),Gn(e.fontFamily)&&""===(null==e?void 0:e.fontFamily.trim())&&(e.fontFamily="Helvetica"),t.push({...mk,...e});})),n.style.textContents=t;}return Xn(t.rotation)&&(n.transform.angle=t.rotation),t.flags&&(t.flags.print&&n.flags.push("print"),t.flags.noView&&n.flags.push("noView"),t.flags.readOnly&&n.flags.push("readOnly"),t.flags.noResize&&n.flags.push("noResize"),t.flags.noRotate&&n.flags.push("noRotate"),t.flags.noMove&&n.flags.push("noMove")),n}function tE(t,e){var i,n,s,o,r,a,l,h,c,d;const{lineEnding:u,iconName:p,imageData:g,segments:f,textContents:v,borderWidth:m,x:y,y:x,width:w,height:b,startPoint:S,endPoint:C,lineDash:P,points:T,stampConfig:A,lines:k}=(null==t?void 0:t.style)||{},E=ko.displayResolution,D=ko.dataResolution;if(k&&(t.style.rects=aE(k,E,D,"user")),T&&(t.style.points=oE(T,E,D)),f&&"ink"===e&&(t.style.points=rE(f,E,D),delete t.style.segments),u&&(t.style.lineEnding=eE(u,"user")),(g||p||A)&&(t.style.stamp=g||iE(p,"user")||Nn(A),delete t.style.iconName,delete t.style.imageData,delete t.style.stampConfig),_n(m)||(t.style.borderWidth=Hs(m,E,D)),_n(y)||(t.style.x=Hs(y,E,D)),_n(x)||(t.style.y=Hs(x,E,D)),_n(w)||(t.style.width=Hs(w,E,D)),_n(b)||(t.style.height=Hs(b,E,D)),_n(S)||(t.style.startPoint=Hs(S,E,D)),_n(C)||(t.style.endPoint=Hs(C,E,D)),_n(P)||(t.style.lineDash=Hs(P,E,D)),v){const e=[];v.forEach((t=>{null!=t&&t.fontSize&&(t.fontSize=Hs(t.fontSize,E,D)),Gn(t.fontFamily)&&""===(null==t?void 0:t.fontFamily.trim())&&(t.fontFamily="Helvetica"),e.push({...mk,...t});})),t.style.textContents=e;}return null===(i=t.style)||void 0===i||delete i.lineJoin,null===(n=t.style)||void 0===n||delete n.lineCap,null===(s=t.style)||void 0===s||delete s.miterLimit,{...t.style,rotation:(null===(o=t.transform)||void 0===o?void 0:o.angle)||0,flags:{print:!(null===(r=t.flags)||void 0===r||!r.includes("print")),noView:!(null===(a=t.flags)||void 0===a||!a.includes("noView")),readOnly:!(null===(l=t.flags)||void 0===l||!l.includes("readOnly")),noResize:!(null===(h=t.flags)||void 0===h||!h.includes("noResize")),noRotate:!(null===(c=t.flags)||void 0===c||!c.includes("noRotate")),noMove:!(null===(d=t.flags)||void 0===d||!d.includes("noMove"))}}}function eE(t,e){const i={None:dk.NONE,OpenArrow:dk.OPEN,ROpenArrow:dk.OPEN_REVERSE,ClosedArrow:dk.CLOSED,RClosedArrow:dk.CLOSED_REVERSE,Butt:dk.BUTT,Slash:dk.SLASH,Square:dk.SQUARE,Diamond:dk.DIAMOND,Circle:dk.CIRCLE};if("user"===e){const[e,n]=t;return {start:i[e],end:i[n]}}return [HD(i,t.start)[0]||"None",HD(i,t.end)[0]||"None"]}function iE(t,e){const i={[ck.REJECTED]:ih.REJECTED,[ck.ACCEPTED]:ih.ACCEPTED,[ck.INITIAL_HERE]:ih.INITIAL_HERE,[ck.SIGN_HERE]:ih.SIGN_HERE,[ck.WITNESS]:ih.WITNESS,[ck.APPROVED]:ih.APPROVED,[ck.NOT_APPROVED]:ih.NOT_APPROVED,[ck.DRAFT]:ih.DRAFT,[ck.FINAL]:ih.FINAL,[ck.COMPLETED]:ih.COMPLETED,[ck.CONFIDENTIAL]:ih.CONFIDENTIAL,[ck.VOID]:ih.VOID};return "user"===e?HD(i,t)[0]||t:i[t]||ih.DRAFT}function nE(t,e){const i=["opacity","flags"],n=["x","y","width","height"],s=["borderColor","borderWidth","lineDash"],o=[...i,...s,...n,"background","rotation"],r=["points","background",...s,...i],a=["rects","opacity"],l={rectangle:o,ellipse:o,polygon:r,polyline:["lineEnding",...r],stamp:["stamp",...n,...i,"rotation"],ink:["points","borderWidth","borderColor","rotation",...i],line:["startPoint","endPoint","lineEnding","background",...s,...i],textBox:["textContents","textAlign","background","rotation",...i,...s,...n],textTypewriter:["x","y","textContents",...i],highlight:[...a,...i,"background"],underline:[...a,...i,"borderColor"],strikeout:[...a,...i,"borderColor"]}[t];if(!l)return e;const h={};for(const i in e)if(l.includes(i)){let n=e[i];"rects"===i?h[i]=n.map((t=>({x:Ks(t.x,2),y:Ks(t.y,2),width:Ks(t.width,2),height:Ks(t.height,2)}))):"points"!==i||"ink"!==t&&"polygon"!==t&&"polyline"!==t?"startPoint"!==i&&"endPoint"!==i||"line"!==t?"borderColor"===i||"background"===i?h[i]=sE(n,2):"opacity"===i?(n>1&&(n=1),n<0&&(n=0),h[i]=Ks(n,2)):"textContents"===i?h[i]=n.map((t=>(void 0!==t.color&&(t.color=sE(t.color,2)),void 0!==t.fontSize&&(t.fontSize=Ks(t.fontSize,2)),t))):"lineDash"===i?h[i]=n.map((t=>Ks(t,2))):Xn(e[i])?h[i]=Ks(n,2):h[i]=n:h[i]={x:Ks(n.x,2),y:Ks(n.y,2)}:On(n[0])?h[i]=n.map((t=>t.map((t=>({x:Ks(t.x,2),y:Ks(t.y,2)}))))):h[i]=n.map((t=>({x:Ks(t.x,2),y:Ks(t.y,2)})));}return h}function sE(t,e){if(t&&t.startsWith("rgb")){const i=/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+)\s*)?\)/,n=t.match(i);if(n){const t=parseInt(n[1],10),i=parseInt(n[2],10),s=parseInt(n[3],10);let o=void 0!==n[4]?parseFloat(n[4]):void 0;if(void 0!==o){o<0&&(o=0),o>1&&(o=1);const n=function(t,e){const i=t.toString();if(/^\d+\.\d{3,}$/.test(i))return parseFloat(t.toFixed(e));return t}(o,e);return `rgba(${t},${i},${s},${n})`}return `rgb(${t},${i},${s})`}}return t}function oE(t,e,i){return t.map((t=>({x:Hs(t.x,e,i),y:Hs(t.y,e,i)})))}function rE(t,e,i){return t.map((t=>t.map((t=>({x:Hs(t.x,e,i),y:Hs(t.y,e,i)})))))}function aE(t,e,i,n){return "date"===n?t.map((t=>({left:Hs(t.x,e,i),top:Hs(t.y,e,i),width:Hs(t.width,e,i),height:Hs(t.height,e,i)}))):t.map((t=>({x:Hs(t.left,e,i),y:Hs(t.top,e,i),width:Hs(t.width,e,i),height:Hs(t.height,e,i)})))}const lE={...qk,x:10,y:10,width:100,height:100};class hE extends Zk{constructor(t){super(t=Ws(t||{},Nn(lE)));}get type(){return "rectangle"}}const cE={...qk,x:10,y:10,width:100,height:80};class dE extends Zk{constructor(t){super(t=Ws(t||{},Nn(cE)));}get type(){return "ellipse"}}const uE={...qk,points:[[{x:10,y:10},{x:110,y:80}],[{x:110,y:10},{x:10,y:80}]]};class pE extends Zk{constructor(t){super(t=Ws(t||{},Nn(uE)));}get type(){return "ink"}}const gE={...qk,startPoint:{x:10,y:10},endPoint:{x:110,y:80},lineEnding:{start:dk.NONE,end:dk.NONE},flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class fE extends Zk{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super(t=Ws(i||{},Nn(gE)));}get type(){return "line"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super.updateOptions(i)}}const vE={...qk,points:[{x:60,y:10},{x:10,y:55},{x:30,y:110},{x:90,y:110},{x:110,y:55}],flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class mE extends Zk{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super(t=Ws(i||{},Nn(vE)));}get type(){return "polygon"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super.updateOptions(i)}}const yE={...qk,points:[{x:10,y:40},{x:50,y:80},{x:110,y:10}],lineEnding:{start:dk.NONE,end:dk.NONE},flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class xE extends Zk{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super(t=Ws(i||{},Nn(yE)));}get type(){return "polyline"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Nn(t),i.flags.noRotate=!0),super.updateOptions(i)}}async function wE(t,e,i,n,s){const o=[`${s}.${n} is invalid`];let r=!1;if(Vn(t)){const e=await Fs(t);["image/bmp","image/jpeg","image/png"].includes(e)||(r=!0);}else r=!0;return !r||Iu.output(e,i,s,o)}const bE={x:10,y:10,stamp:ck.DRAFT,width:void 0,height:void 0,opacity:1,flags:{print:!0,noView:!1,readOnly:!1},rotation:0},SE={[ck.REJECTED]:[23.58,23.54],[ck.ACCEPTED]:[28.39,24.6],[ck.INITIAL_HERE]:[126.26,33.78],[ck.SIGN_HERE]:[126.26,33.78],[ck.WITNESS]:[126.26,33.78],[ck.APPROVED]:[211.33,59.33],[ck.NOT_APPROVED]:[284.83,59.33],[ck.DRAFT]:[144.19,59.66],[ck.FINAL]:[123.73,59.66],[ck.COMPLETED]:[227.83,59.33],[ck.CONFIDENTIAL]:[272.83,59.33],[ck.VOID]:[114.71,59.66]};var CE=new WeakMap;class PE{constructor(t){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),f(this,CE,{writable:!0,value:void 0}),t=Ws(t||{},Nn(bE)),!Gn(t.stamp)||!SE[t.stamp]||Xn(t.width)&&Xn(t.height)||(t.width=t.width||SE[t.stamp][0],t.height=t.height||SE[t.stamp][1]),s(this,CE,t),this.uid=Jn(),this.creationDate=Zf(),this.modificationDate=this.creationDate;}get source(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "stamp"}get pageUid(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(KA(t,1,e,"options"))return;if(!Ik(t,e,"options",1))return;UT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?UT.annotationService.flattenAnnotations([this.uid]):UT.annotationService.unFlattenAnnotation(this.uid));}getOptions(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);if(t){const e=t.getConfig(),i=tE(e,this.type);s(this,CE,{...i}),this.modificationDate=e.comment.modificationDate;}return nE(this.type,n(this,CE))}async updateOptions(t){const e="Annotation.updateOptions";if(KA(t,0,e,"options"))return;if(!tk(t,0,e,"options"))return;if(!Yk(t,0,e,"options",this.type))return;if(Vn(t.stamp)&&!await wE(t.stamp,0,e,"stamp","options"))return;const i=this.getOptions(),s=Qk(this.type,t,i);if(!s.size)return;this.getOptions(),Ws(t,n(this,CE));let o=n(this,CE);null!=t&&t.stamp||(o={...n(this,CE),stamp:null});const r=Kk(o,this.type);UT.annotationService.updateAnnotations([{annotationUid:this.uid,options:r}],void 0,[...s]);}}const TE={...qk,x:10,y:10,width:150,height:80,textAlign:"left",textContents:[{content:"Insert text here"}]};class AE extends Zk{constructor(t){super(t=Ws(t||{},Nn(TE)));}get type(){return "textBox"}}const kE={x:10,y:10,textContents:[{content:"Insert text here"}],opacity:1,author:"",subject:"",flags:{print:!0,noView:!1,readOnly:!1,noResize:!0,noRotate:!0}};class EE extends Zk{constructor(t){var e,i;const n=Nn(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noResize)&&(n.flags.noResize=!0),super(t=Ws(n||{},Nn(kE)));}get type(){return "textTypewriter"}updateOptions(t){var e,i;const n=Nn(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noResize)&&(n.flags.noResize=!0),super.updateOptions(n)}}function DE(t,e,i,n,s,o){const r=Iu.formatError({isValid:On(t)});if(r)return Iu.output(e,i,n,void 0,r);const a=[];return t.forEach(((t,e)=>{const i=Iu.formatDetails(Ru("Array",s,`[${e}]`,!0),Iu.isStringAndNotEmpty(t,o));a.push(...i);})),!a.length||Iu.output(e,i,n,a)}function RE(t,e,i,n,s){const o=[];return e.forEach(((e,i)=>{t.has(e)||o.push(`annotationUids[${i}]: The specified annotation(s) do not exist.`);})),!o.length||Iu.output(i,n,s,o,Du.ANNOTATION_NOT_EXIST)}function IE(t,e,i,n,s){return !!t.has(e)||Iu.output(i,n,s,void 0,Du.ANNOTATION_NOT_EXIST)}class ME{constructor(){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),this.uid=Jn(),this.creationDate=Zf(),this.modificationDate=Zf();}get source(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "unknown"}get pageUid(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(KA(t,1,e,"options"))return;if(!Ik(t,e,"options",1))return;UT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?UT.annotationService.flattenAnnotations([this.uid]):UT.annotationService.unFlattenAnnotation(this.uid));}}var BE=new WeakMap;class UE{constructor(t){f(this,BE,{writable:!0,value:void 0}),i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),this.uid=Jn(),this.creationDate=Zf(),this.modificationDate=Zf(),s(this,BE,t);}get source(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "incomplete"}get pageUid(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get raw(){return n(this,BE)}get flattened(){const t=UT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(KA(t,1,e,"options"))return;if(!Ik(t,e,"options",1))return;UT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?UT.annotationService.flattenAnnotations([this.uid]):UT.annotationService.unFlattenAnnotation(this.uid));}}const LE={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],background:"#FD7C10",opacity:1};class OE extends Zk{constructor(t){var e,i;const n=Nn(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super(t=Ws(n||{},Nn(LE)));}get type(){return "highlight"}updateOptions(t){var e,i;const n=Nn(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super.updateOptions(n)}}const WE={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],borderColor:"#0E68F5",opacity:1};class NE extends Zk{constructor(t){var e,i;const n=Nn(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super(t=Ws(n||{},Nn(WE)));}get type(){return "underline"}updateOptions(t){var e,i;const n=Nn(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super.updateOptions(n)}}const _E={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],borderColor:"#F01314",opacity:1};class FE extends Zk{constructor(t){var e,i;const n=Nn(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super(t=Ws(n||{},Nn(_E)));}get type(){return "strikeout"}updateOptions(t){var e,i;const n=Nn(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(n.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(n.flags.noMove=!0),super.updateOptions(n)}}const HE=["annotationsAdded","annotationsDeleted","annotationsModified","annotationLayerChanged"],VE="AnnotationManager",zE=new Map;var $E=new WeakMap,jE=new WeakMap,XE=new WeakMap,GE=new WeakSet,YE=new WeakSet;function qE(t,e){switch(t){case"rectangle":return new hE(e);case"ellipse":return new dE(e);case"polygon":return new mE(e);case"polyline":return new xE(e);case"line":return new fE(e);case"stamp":return new PE(e);case"ink":return new pE(e);case"textBox":return new AE(e);case"textTypewriter":return new EE(e);case"unknown":return new ME;case"highlight":return new OE(e);case"underline":return new NE(e);case"strikeout":return new FE(e);case"incomplete":return new UE((null==e?void 0:e.annotationRaw)||{});default:return null}}function JE(t,e){n(this,XE).emit(t,e);}const ZE=new class{constructor(){v(this,YE),v(this,GE),f(this,$E,{writable:!0,value:void 0}),f(this,jE,{writable:!0,value:void 0}),f(this,XE,{writable:!0,value:void 0}),s(this,$E,UT),s(this,jE,zE),s(this,XE,new Kn);const t=n(this,$E).annotationService.annotationApp.hooks;t.annotationCreated.on((t=>{const e=t.annotations.reduce(((t,e)=>{if(!n(this,jE).has(e.uid)){const t=e.getConfig(),i=tE(t),s=p(this,GE,qE).call(this,t.type,i);s&&(s.uid=t.uid,s.creationDate=t.comment.creationDate,s.modificationDate=t.comment.modificationDate,n(this,jE).set(t.uid,s));}return t.push(e.uid),t}),[]);p(this,YE,JE).call(this,"annotationsAdded",{annotationUids:e});})),t.annotationDeleted.on((t=>{t.annotations.forEach((t=>{if(n(this,jE).has(t.uid)){this.getAnnotationsByUids([t.uid])[0].modificationDate="",n(this,jE).delete(t.uid);}}));const e=t.annotations.map((t=>t.uid));t.emitEvent&&p(this,YE,JE).call(this,"annotationsDeleted",{annotationUids:e});})),t.annotationUpdated.on((t=>{const e={modifiedAnnotations:t.updateDetails.map((t=>{const e=this.getAnnotationsByUids([t.annotationUid])[0],i=e.type,n=UT.annotationService.annotationApp.getAnnotationByUid(e.uid);return e.modificationDate=n.comment.modificationDate,{uid:t.annotationUid,oldOptions:nE(i,tE(Nn(t.from),i)),newOptions:nE(i,tE(Nn(t.to),i))}})),actions:[...t.updateActions]};e.actions.includes("flattenedChanged")||p(this,YE,JE).call(this,"annotationsModified",e);}));const e=(t,e)=>{n(this,$E).annotationService.enableEmitLayerChanged&&p(this,YE,JE).call(this,"annotationLayerChanged",{oldAnnotationUidList:[...t.from],newAnnotationUidList:[...t.to]});};t.bringFroward.on((t=>{e(t);})),t.bringToFront.on((t=>{e(t);})),t.sendBackward.on((t=>{e(t);})),t.sendToBack.on((t=>{e(t);}));}createAnnotation(t,e,i){const s="AnnotationManager.createAnnotation",o="pageUid",r="type",a="annotationOptions";let l=null;try{Ep.makeSureCoreLicenseExist(),Ep.makeSureAnnotationLicenseExist(),KA(t,0,s,o),KA(e,0,s,r),Ek(t,0,s,o,!1),function(t,e,i,n){Gn(t)?!!["rectangle","ellipse","polygon","polyline","line","stamp","ink","textBox","textTypewriter","highlight","underline","strikeout"].includes(t)||Iu.output(e,i,n,void 0,Du.PARAM_NOT_SUPPORT):Iu.output(e,i,n,void 0,Du.PARAM_INVALID);}(e,0,s,r),l=n(this,$E).pageService.getPage(t),l||Iu.error(s,o,void 0,Du.PAGE_NOT_EXIST),_n(i)||(tk(i,0,s,a),Yk(i,0,s,a,e));}catch(t){if("stamp"===e)return Promise.reject(t);throw t}const h=Nn(i||{}),c=()=>{var i,s,o;const r=p(this,GE,qE).call(this,e,h);n(this,jE).set(r.uid,r);const a=n(this,$E).pageService.getPage(t).doc.uid,c=Kk(r.getOptions(),e);if("textTypewriter"===e){const t=l.mediaBox.width,e=l.mediaBox.width-c.style.x;c.style.width=e<0?t:e;}if("underline"===e||"strikeout"===e){var d;const t=wm(null==c||null===(d=c.style)||void 0===d?void 0:d.lines)||1;c.style.borderWidth=t;}const u={uid:r.uid,docUid:a,pageUid:t,type:e,style:c.style,transform:c.transform,flags:c.flags,source:"api",comment:{annotationUid:r.uid,author:(null===(i=c.comment)||void 0===i?void 0:i.author)||"",subject:(null===(s=c.comment)||void 0===s?void 0:s.subject)||"",contents:(null===(o=c.comment)||void 0===o?void 0:o.contents)||"",creationDate:r.creationDate,modificationDate:r.creationDate,markedStates:[],reviewStates:[],replies:[]}};return n(this,$E).annotationService.createAnnotation(a,u),r};if("stamp"===e&&Vn(null==h?void 0:h.stamp)){const t=h;return new Promise((async(e,i)=>{try{await wE(t.stamp,0,s,"stamp",a);}catch(t){return void i(t)}if(!Xn(t.width)||!Xn(t.height)){const e=new wo,n=await e.readImageInfo({fileSource:t.stamp}).catch((t=>{i(t);}));let s=n.imageWidth,o=n.imageHeight;if(s>400||o>400){const t=Math.max(s/400,o/400);s/=t,o/=t;}t.width=s,t.height=o;}e(c());}))}return c()}deleteAnnotations(t){const e=`${VE}.deleteAnnotations`,i="annotationUids";return !(KA(t,1,e,i)||!DE(t,1,e,i,void 0,!1)||!RE(n(this,jE),t,1,e,i))&&(n(this,$E).annotationService.deleteAnnotations(t),!0)}getAnnotationsByUids(t){const e=`${VE}.getAnnotationsByUids`,i="annotationUids";return !KA(t,1,e,i)&&DE(t,1,e,i,void 0,!1)&&RE(n(this,jE),t,1,e,i)?t.map((t=>n(this,jE).get(t))):[]}getAnnotationsByPage(t){const e=`${VE}.getAnnotationsByPage`,i="pageUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1))return [];if(!n(this,$E).pageService.getPage(t))return Iu.warning(e,i,void 0,Du.PAGE_NOT_EXIST),[];const s=n(this,$E).annotationService.getAnnotationUidsByLayer(t),o=[];return s.forEach((t=>{const e=n(this,jE).get(t);e&&o.push(e);})),o}getAnnotationsByDoc(t){const e=`${VE}.getAnnotationsByDoc`,i="docUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1))return [];const s=n(this,$E).documentService.getDocument(t);if(!s)return Iu.warning(e,i,void 0,Du.DOC_NOT_EXIST),[];return s.pages.reduce(((t,e)=>(n(this,$E).annotationService.getAnnotationUidsByLayer(e).forEach((e=>{const i=n(this,jE).get(e);i&&t.push(i);})),t)),[])}bringAnnotationForward(t){const e=`${VE}.bringAnnotationForward`,i="annotationUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1)||!IE(n(this,jE),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return n(this,$E).annotationService.bringForward(t)}sendAnnotationBackward(t){const e=`${VE}.sendAnnotationBackward`,i="annotationUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1)||!IE(n(this,jE),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return n(this,$E).annotationService.sendBackward(t)}bringAnnotationToFront(t){const e=`${VE}.bringAnnotationToFront`,i="annotationUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1)||!IE(n(this,jE),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return n(this,$E).annotationService.bringToFront(t)}sendAnnotationToBack(t){const e=`${VE}.sendAnnotationToBack`,i="annotationUid";if(KA(t,1,e,i)||!Ek(t,1,e,i,!1)||!IE(n(this,jE),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return n(this,$E).annotationService.sendToBack(t)}on(t,e){const i="AnnotationManager.on",s="eventName",o="listener";!KA(t,1,i,s)&&!KA(e,1,i,o)&&Ek(t,1,i,s,!1)&&kk(e,i,o,1)&&(HE.includes(t)?n(this,XE).on(t,e):Du.warning(Du.PARAM_NOT_SUPPORT,i,s));}off(t,e){const i="AnnotationManager.off",s="eventName";!KA(t,1,i,s)&&Ek(t,1,i,s,!1)&&(_n(e)||kk(e,i,"listener",1))&&(HE.includes(t)?n(this,XE).off(t,e):Du.warning(Du.PARAM_NOT_SUPPORT,i,s));}};function QE(t,e,i,n,s,o){const r=[];let a=!1;if(s)s.forEach(((t,e)=>{const{width:s,height:o}=i.getRealPtPageSize(t);FD(n,s,o)||r.push(`indices[${t}]: ${Du.RECT_EXCEED_PAGE_BOUND.message}`);})),r.length>0&&(a=!0);else {const{width:t,height:e}=i.getRealPtPageSize();FD(n,t,e)||(a=!0);}return !!a&&Iu.output(o,t,e,r.length?r:void 0,Du.RECT_EXCEED_PAGE_BOUND,!0)}function KE(t,e,i,n){const s=qD.isRectValid(t);return !!s.length&&Iu.output(n,e,i,s,void 0,!0)}const tD=["canvasStyle","pageStyle","quadSelectionStyle","currentPageStyle","annotationSelectionStyle","cursorStyle"],eD="EditViewer";var iD=new WeakMap,nD=new WeakMap,sD=new WeakMap,oD=new WeakSet,rD=new WeakSet,aD=new WeakSet;class lD{constructor(t){var e,o,r,a,l,h;v(this,aD),v(this,rD),v(this,oD),f(this,iD,{writable:!0,value:void 0}),f(this,nD,{writable:!0,value:!0}),f(this,sD,{writable:!0,value:new Rk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),i(this,"thumbnail",void 0);Ep.makeSureCoreLicenseExist(),_n(t)||Bk(t,"editViewer",0,"new EditViewer","option");const c=YD(null==t?void 0:t.keyboardInteractionConfig);!1===(null==t||null===(e=t.viewerConfig)||void 0===e?void 0:e.enableMagnifier)&&(t.viewerConfig.enableTextMagnifier=!1);const d=Ws((null==t?void 0:t.viewerConfig)||{},Nn({...zk,viewerMode:dg.DEFAULT,displayMode:"continuous",enablePopup:!0,enableOptimizePage:!0}));if(d.minZoom>d.maxZoom){Du.warning(Du.MIN_ZOOM_INVALID);const t=d.maxZoom;d.maxZoom=d.minZoom,d.minZoom=t;}const{maxZoom:u,minZoom:g}=d;d.maxZoom=u>64||u<.01?64:u,d.minZoom=g>64||g<.01?.01:g,jn()&&(xk.toolbarConfig.style={scale:"0.9"}),s(this,iD,UT.createViewer({uiConfig:Nn(jn()?nk:ak),...t,viewerConfig:{...d,...c},popupConfig:{annotationToolBarConfig:{...null==xk?void 0:xk.toolbarConfig,...null==t||null===(o=t.annotationConfig)||void 0===o?void 0:o.toolbarConfig},annotationPaletteConfig:{...xk.paletteConfig,...null==t||null===(r=t.annotationConfig)||void 0===r?void 0:r.paletteConfig},annotationCustomStampPanelConfig:{...null==t||null===(a=t.annotationConfig)||void 0===a?void 0:a.customStampPanelConfig},passwordLoaderConfig:{enabled:null===(l=null==t||null===(h=t.viewerConfig)||void 0===h?void 0:h.enablePasswordLoader)||void 0===l||l}}})),this.uid=n(this,iD).uid,this.groupUid=n(this,iD).groupUid,this.postfix=n(this,iD).postfix;const m=Ws(Nn(null==t?void 0:t.annotationConfig)||{},Nn(xk));n(this,iD).updateAnnotationConfig(ND(m)),OD(n(this,iD).getUiConfig()).includes(ek.Filter)&&!n(this,iD).context.core.filterService.enableFilter&&Du.warning(Du.IMG_FILTER_MISS),t&&!1===t.createThumbnail||p(this,rD,cD).call(this,null==t?void 0:t.thumbnailConfig,c),t&&!_n(null==t?void 0:t.adaptiveIconSize)&&s(this,nD,t.adaptiveIconSize),n(this,iD).rootDom&&(n(this,iD).rootDom.style.fontSize="20px",DD(this,n(this,iD).rootDom,n(this,nD))),yR.forEach((t=>{n(this,iD).addFontToUi(t);})),p(this,aD,dD).call(this),p(this,oD,hD).call(this);}get isVisible(){return n(this,sD).getIsVisible(n(this,iD))}get isBoundContainer(){return n(this,sD).getIsBoundContainer(n(this,iD))}get currentDocument(){return n(this,sD).getCurrentDocument(n(this,iD))}get zoom(){return parseFloat(n(this,iD).getViewerConfig().zoom.toFixed(4))}set zoom(t){const{maxZoom:e,minZoom:i}=n(this,iD).getViewerConfig();(function(t,e,i,n,s,o){const r=Iu.formatError(Iu.isNumberAndIsInRange(t));return r?Iu.output(e,i,n,void 0,r):(t<s&&Iu.output(e,i,n,void 0,Du.ZOOM_TOO_SMALL),t>o&&Iu.output(e,i,n,void 0,Du.ZOOM_TOO_LARGE),!0)})(t,1,`${eD}.zoom`,"zoom",i,e)&&n(this,iD).updateViewerConfig({zoom:t});}get zoomOrigin(){return n(this,iD).getViewerConfig().zoomOrigin}set zoomOrigin(t){(function(t,e,i,n){const s=qD.isZoomOriginValid(t);return !s.length||Iu.output(n,e,i,s)})(t,`${eD}.zoomOrigin`,"zoomOrigin",1)&&n(this,iD).updateViewerConfig({zoomOrigin:{x:t.x,y:t.y}});}get displayMode(){const{displayMode:t}=n(this,iD).getViewerConfig(),e=n(this,iD).getActiveTab();return e?e.context.displayMode:t}set displayMode(t){const e="displayMode",i=`${eD}.${e}`;Ek(t,1,i,e)&&(["single","continuous"].includes(t)?n(this,iD).updateViewerConfig({displayMode:t}):Du.warning(Du.PARAM_NOT_SUPPORT,i,e));}get toolMode(){const{toolMode:t}=n(this,iD).getViewerConfig();return t}set toolMode(t){const e="toolMode",i=`${eD}.${e}`;Ek(t,1,i,e)&&function(t,e,i,n){return !!["crop","pan","annotation","textSelection"].includes(t)||Iu.output(e,i,n,void 0,Du.PARAM_NOT_SUPPORT)}(t,1,i,e)&&n(this,iD).updateViewerConfig({toolMode:t});}get annotationMode(){const{annotationMode:t}=n(this,iD).getViewerConfig();return t}set annotationMode(t){const e="annotationMode",i=`${eD}.${e}`;Ek(t,1,i,e)&&function(t,e,i,n){return !!["rectangle","ellipse","line","polygon","polyline","ink","textBox","textTypewriter","stamp","erase","select","highlight","underline","strikeout"].includes(t)||Iu.output(e,i,n,void 0,Du.PARAM_NOT_SUPPORT)}(t,1,i,e)&&n(this,iD).updateViewerConfig({annotationMode:t});}get fitMode(){const{fitMode:t}=n(this,iD).getViewerConfig(),e=n(this,iD).getActiveTab();return e?e.context.fitMode:t}set fitMode(t){const e=`${eD}.fitMode`,i="fitMode";Ek(t,1,e,i)&&function(t,e,i,n){return !!["width","height","window","actualSize"].includes(t)||Iu.output(e,i,n,void 0,Du.PARAM_NOT_SUPPORT)}(t,1,e,i)&&n(this,iD).updateViewerConfig({fitMode:t});}bindContainer(t){n(this,sD).bindContainer(n(this,iD),t,`${eD}.bindContainer`);}unbindContainer(){n(this,sD).unbindContainer(n(this,iD));}show(){n(this,sD).show(n(this,iD)),DD(this,n(this,iD).rootDom,n(this,nD));}hide(){n(this,sD).hide(n(this,iD));}getUiConfig(){return n(this,sD).getUiConfig(n(this,iD))}updateUiConfig(t){n(this,iD).selectAnnotations([]);return !!n(this,sD).updateUiConfig(n(this,iD),t,"editViewer",`${eD}.updateUiConfig`)&&(n(this,iD).emit("thumbnailBind",this.thumbnail.uid),DD(this,n(this,iD).rootDom,n(this,nD)),!0)}openDocument(t){n(this,sD).openDocument(t,this.uid,`${eD}.openDocument`);}closeDocument(){return n(this,sD).closeDocument(n(this,iD),`${eD}.closeDocument`)}getStyle(t){return n(this,sD).getStyle(n(this,iD),"edit",t,tD,`${eD}.getStyle`)}updateStyle(t,e){const i=`${eD}.updateStyle`;return n(this,sD).updateStyle(n(this,iD),t,e,tD,i)}setParallelScrollCount(t){const e=`${eD}.setParallelScrollCount`,i="count",{maxColumns:s,maxRows:o}=n(this,iD).getViewerConfig();return !(KA(t,1,e,i)||!Ck(t,e,i,1)||Tk(t,1,o,1,e,i)||Tk(t,1,s,1,e,i))&&("continuous"!==this.displayMode?(Du.warning(Du.ROW_COLUMN_CAN_NOT_CHANGE,e),!1):n(this,iD).setRowAndColumn(t,t))}setCropRect(t){const e=`${eD}.setCropRect`,i="rect";return !(KA(t,1,e,i)||KE(t,e,i,1)||!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1)||QE(e,i,n(this,iD),t,void 0,1))&&("crop"!==this.toolMode?(Du.warning(Du.TOOL_MODE_NOT_AVAILABLE,e),!1):n(this,iD).setRectBox(t))}getCropRect(){return bk(n(this,iD),1)?n(this,iD).getRectBox():null}crop(t,e){const i=`${eD}.crop`,s=n(this,iD).getPageCounts(),o="rect";if(KA(t,1,i,o)||KE(t,i,o,1)||!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1))return !1;if(e&&!Dk(e,1,i,"indices",0,s-1))return !1;if(QE(i,o,n(this,iD),t,e,1))return !1;const r=n(this,iD).getCurrentPageIndex();return n(this,iD).cropPages(t,e||[r])}rotate(t,e){const i=`${eD}.rotate`;return n(this,sD).rotate(n(this,iD),t,e,i)}undo(){if(!bk(n(this,iD),1))return !1;const t=n(this,iD).undo();return t||Du.warning(Du.UNDO_NOOP),t}redo(){if(!bk(n(this,iD),1))return !1;const t=n(this,iD).redo();return t||Du.warning(Du.REDO_NOOP),t}saveOperations(){return n(this,sD).saveOperation(n(this,iD))}indexToUid(t){const e=`${eD}.indexToUid`;return n(this,sD).indexToUid(n(this,iD),t,e)}uidToIndex(t){const e=`${eD}.uidToIndex`;return n(this,sD).uidToIndex(n(this,iD),t,e)}getCurrentPageUid(){return n(this,sD).getCurrentPageUid(n(this,iD))}getCurrentPageIndex(){return n(this,sD).getCurrentPageIndex(n(this,iD))}getPageCount(){return n(this,sD).getPageCount(n(this,iD))}goToPage(t){const e=`${eD}.goToPage`;return n(this,sD).gotoPage(n(this,iD),t,e)}selectAnnotations(t){const e=`${eD}.selectAnnotations`,i="annotationUids";if(!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1)||KA(t,1,e,i)||!DE(t,1,e,i,void 0,!1))return !1;if(["textSelection","crop"].includes(this.toolMode))return Du.warning(Du.TOOL_MODE_NOT_AVAILABLE,e),!1;t=[...new Set(t)];const s=[],o=[],r=[],a=[],l=this.getCurrentPageUid(),h=t.reduce(((t,e,n)=>{const h=UT.annotationService.getAnnotationByUid(e);return h?h.pageUid!==l?s.push(`${i}[${n}]: The specified annotation is not on the current page.`):"incomplete"===h.type||"unknown"===h.type?o.push(`${i}[${n}]: ${Du.UNSELECTED_UNKNOWN.message}`):h.flags.includes("readOnly")||h.flags.includes("noView")?r.push(`${i}[${n}]: ${Du.UNSELECTED_READONLY.message}`):h.flattened?a.push(`${i}[${n}]: ${Du.UNSELECTED_FLATTENED.message}`):t.push(e):s.push(`${i}[${n}]: The specified annotation does not exist.`),t}),[]),c=[{result:s,exceptionType:Du.ANNOTATION_SELECT},{result:o,exceptionType:Du.UNSELECTED_UNKNOWN},{result:r,exceptionType:Du.UNSELECTED_READONLY},{result:a,exceptionType:Du.UNSELECTED_FLATTENED}];for(const{result:t,exceptionType:n}of c)if(t.length){const s=n;return s.details=t,Du.warning(s,e,i),!1}const d=n(this,iD).getSelectedAnnotations().map((t=>t.uid));return d.length===h.length&&function(t,e){if(t.length!==e.length)return !1;const i=t.slice().sort(),n=e.slice().sort();for(let t=0;t<i.length;t++)if(i[t]!==n[t])return !1;return !0}(d,h)||n(this,iD).selectAnnotations(h),!0}getSelectedAnnotations(){if(!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1))return [];return n(this,iD).getSelectedAnnotations().length?ZE.getAnnotationsByUids(n(this,iD).getSelectedAnnotations().map((t=>t.uid))):[]}async copySelectedTexts(){await n(this,iD).copySelectedTexts();}on(t,e){n(this,sD).on(n(this,iD),`${eD}.on`,t,e);}off(t,e){n(this,sD).off(n(this,iD),`${eD}.off`,t,e);}destroy(){n(this,sD).destroy(n(this,iD));}setAnnotationDrawingStyle(t){var e,i;const s=`${eD}.setAnnotationDrawingStyle`,o="config";if(KA(t,1,s,o)||!tk(t,1,s,o))return !1;const r=qD.isAnnotationDrawingStyleValid(t,o);if(r.length){const t=Du.PARAM_INVALID;return t.details=r,Du.warning(t,s,o),!1}(null==t||null===(e=t.textBox)||void 0===e||null===(e=e.textContent)||void 0===e?void 0:e.fontSize)<=0&&(t.textBox.textContent.fontSize=1),(null==t||null===(i=t.textTypewriter)||void 0===i||null===(i=i.textContent)||void 0===i?void 0:i.fontSize)<=0&&(t.textTypewriter.textContent.fontSize=1);const a=n(this,iD).getAnnotationConfig().defaultStyleConfig;if(null!=t&&t.line){const e=eE(a.line.lineEnding,"user");t.line.lineEnding={...e,...t.line.lineEnding};}if(null!=t&&t.polyline){const e=eE(a.polyline.lineEnding,"user");t.polyline.lineEnding={...e,...t.polyline.lineEnding};}const l=ND({defaultStyleConfig:t});return n(this,iD).updateAnnotationConfig(l),!0}getTextSelection(){const t=n(this,iD).context.getTextSelection();return t.forEach((t=>{t.rects=t.rects.map((t=>({x:Ks(t.x,2),y:Ks(t.y,2),width:Ks(t.width,2),height:Ks(t.height,2)})));})),t}async searchNextText(t,e){const i=`${eD}.searchNextText`;if(KA(t,1,i,"text")||!Ek(t,1,i,"text")||!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1))return !1;if(e){const t=qD.isSearchTextOptionsValid(e,"options");if(t.length){const e=Du.PARAM_INVALID;return e.details=t,Du.warning(e,i,"options"),!1}}return n(this,iD).searchNextText(t,e).then((t=>(t||Du.warning(Du.NO_RESULTS_FOUND),t)))}async searchPrevText(t,e){const i=`${eD}.searchPrevText`;if(KA(t,1,i,"text")||!Ek(t,1,i,"text")||!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1))return !1;if(e){const t=qD.isSearchTextOptionsValid(e,"options");if(t.length){const e=Du.PARAM_INVALID;return e.details=t,Du.warning(e,i,"options"),!1}}return n(this,iD).searchPrevText(t,e).then((t=>(t||Du.warning(Du.NO_RESULTS_FOUND),t)))}async searchFullText(t,e){const i=`${eD}.searchFullText`;if(KA(t,1,i,"text")||!Ek(t,1,i,"text")||!bk(n(this,iD),1)||Sk(void 0,void 0,n(this,iD),1))return !1;if(e){const t=qD.isSearchTextOptionsValid(e,"options");if(t.length){const e=Du.PARAM_INVALID;return e.details=t,Du.warning(e,i,"options"),!1}}return n(this,iD).searchFullText(t,e).then((t=>(t||Du.warning(Du.NO_RESULTS_FOUND),t)))}getVisiblePagesInfo(){return n(this,iD).getVisiblePagesInfo()}}function hD(){n(this,iD).hooks.destroy.on((()=>{var t;null===(t=this.thumbnail)||void 0===t||t.vCommon.destroy(this.thumbnail.v),this.thumbnail=null,s(this,iD,null),Object.setPrototypeOf(this,null);}));}function cD(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=t||{},s=Nn(Vk);jn()&&(s.size="100%",s.rows=3,s.columns=2,s.canvasStyle.background="#4B4B4B",s.pageNumberStyle.color="white",s.enableOptimizePage=!0),Ws(i,s);const{mainAndThbContainer:o,mainContainer:r,thumbnailContainer:a}=n(this,iD).context.viewService,{size:l,position:h,visibility:c}=s,d=Nn(lk);let u="row",p=l,g="100%",f="left"===h?"-1":"1";"top"!==h&&"bottom"!==h||(u="column",p="100%",g=l,f="top"===h?"-1":"1");const v=`ddv-edit-viewer-thumb-${h}`;d.className=v,Object.assign(a.style,{width:p,height:g,order:f,display:"visible"===c?"block":"none"}),o.style.flexDirection=u,o.insertBefore(a,r),n(this,iD).context.resize(),n(this,iD).context.viewerConfig.hasThb=!0;const m=new Xk({container:a,viewerConfig:{...s,...e},groupUid:this.groupUid,uiConfig:d},`${eD}.thumbnail`);this.thumbnail=m,n(this,iD).emit("thumbnailBind",m.uid),m.v.emit("thumbnailBind",n(this,iD).uid),m.on("click",(()=>{n(this,iD).emit("ui_hidePopup",null);}));}function dD(){this.on("resized",(t=>{t.newWidth<1280&&t.newWidth>800&&DD(this,n(this,iD).rootDom,n(this,nD));}));}const uD={canvasStyle:{...uk},pageStyle:{...pk},quadSelectionStyle:{...gk},enableSlide:!0,enableMagnifier:!0};function pD(t,e,i,n){const s=qD.isQuadValid(t);return s.length?Iu.output(e,i,n,s):!!to(t.flat())||Iu.output(e,i,n,void 0,Du.PARAM_INVALID)}function gD(t,e,i,n){return !!function(t,e,i){for(let n=0;n<t.length;n++)if(t[n][0]>e||t[n][1]>i)return !0;return !1}(t,i,n)&&(Iu.output(e,void 0,void 0,void 0,Du.QUAD_EXCEED_PAGE_BOUND),!0)}const fD=["canvasStyle","pageStyle","quadSelectionStyle","cursorStyle"],vD="PerspectiveViewer";var mD=new WeakMap,yD=new WeakMap,xD=new WeakSet;class wD{constructor(t){var e,o;v(this,xD),f(this,mD,{writable:!0,value:void 0}),f(this,yD,{writable:!0,value:new Rk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),Ep.makeSureCoreLicenseExist(),_n(t)||Bk(t,"perspectiveViewer",0,`new ${vD}`,"option");const r=Ws((null==t?void 0:t.viewerConfig)||{},Nn({...uD,viewerMode:dg.PERSPECTIVE,toolMode:"crop"})),a=jn()?sk:rk;s(this,mD,UT.createViewer({uiConfig:Nn(a),...t,viewerConfig:{enablePopup:!0,...r},popupConfig:{passwordLoaderConfig:{enabled:null===(e=null==t||null===(o=t.viewerConfig)||void 0===o?void 0:o.enablePasswordLoader)||void 0===e||e}}})),this.uid=n(this,mD).uid,this.groupUid=n(this,mD).groupUid,this.postfix=n(this,mD).postfix,p(this,xD,bD).call(this);}get isVisible(){return n(this,yD).getIsVisible(n(this,mD))}get isBoundContainer(){return n(this,yD).getIsBoundContainer(n(this,mD))}get currentDocument(){return n(this,yD).getCurrentDocument(n(this,mD))}bindContainer(t){n(this,yD).bindContainer(n(this,mD),t,`${vD}.bindContainer`);}unbindContainer(){n(this,yD).unbindContainer(n(this,mD));}show(){n(this,yD).show(n(this,mD));}hide(){n(this,yD).hide(n(this,mD));}getUiConfig(){return n(this,yD).getUiConfig(n(this,mD))}updateUiConfig(t){return n(this,yD).updateUiConfig(n(this,mD),t,"perspectiveViewer",`${vD}.updateUiConfig`)}openDocument(t){n(this,yD).openDocument(t,this.uid,`${vD}.openDocument`);}closeDocument(){return n(this,yD).closeDocument(n(this,mD),`${vD}.closeDocument`)}getStyle(t){return n(this,yD).getStyle(n(this,mD),"perspective",t,fD,`${vD}.getStyle`)}updateStyle(t,e){const i=`${vD}.updateStyle`;return n(this,yD).updateStyle(n(this,mD),t,e,fD,i)}setQuadSelection(t){const e=`${vD}.setQuadSelection`,i="quad";if(KA(t,1,e,i)||!pD(t,1,e,i)||!bk(n(this,mD),1)||Sk(e,void 0,n(this,mD),1))return !1;const{width:s,height:o}=n(this,mD).getRealPixelSize();return !gD(t,1,s,o)&&n(this,mD).setQuadBox(t)}getQuadSelection(){const t=`${vD}.getQuadSelection`;return !bk(n(this,mD),1)||Sk(t,void 0,n(this,mD),1)?null:n(this,mD).getQuadBox()}resetQuadSelection(t){const e=`${vD}.resetQuadSelection`;if(!bk(n(this,mD),1)||Sk(e,void 0,n(this,mD),1))return !1;if(!_n(t)){if(!Dk(t,1,e,"indices",0,n(this,mD).getPageCounts()-1))return !1}return n(this,mD).resetQuadBox(t)}applyPerspective(t){const e=`${vD}.applyPerspective`,i="quad";KA(t,0,e,i),pD(t,0,e,i),bk(n(this,mD),0),Sk(e,void 0,n(this,mD),0);let{width:s,height:o}=n(this,mD).getRealPixelSize();return s=Math.round(s),o=Math.round(o),gD(t,0,s,o),n(this,mD).perspectivePage(t)}rotate(t,e){const i=`${vD}.rotate`;return n(this,yD).rotate(n(this,mD),t,e,i)}saveOperations(){return n(this,yD).saveOperation(n(this,mD))}goToPage(t){const e=`${vD}.goToPage`;return n(this,yD).gotoPage(n(this,mD),t,e)}indexToUid(t){const e=`${vD}.indexToUid`;return n(this,yD).indexToUid(n(this,mD),t,e)}uidToIndex(t){const e=`${vD}.uidToIndex`;return n(this,yD).uidToIndex(n(this,mD),t,e)}getCurrentPageUid(){return n(this,yD).getCurrentPageUid(n(this,mD))}getCurrentPageIndex(){return n(this,yD).getCurrentPageIndex(n(this,mD))}getPageCount(){return n(this,yD).getPageCount(n(this,mD))}on(t,e){n(this,yD).on(n(this,mD),`${vD}.on`,t,e);}off(t,e){n(this,yD).off(n(this,mD),`${vD}.off`,t,e);}destroy(){n(this,yD).destroy(n(this,mD));}getVisiblePagesInfo(){return n(this,mD).getVisiblePagesInfo()}}function bD(){n(this,mD).hooks.destroy.on((()=>{s(this,mD,null),Object.setPrototypeOf(this,null);}));}class SD extends Xk{constructor(t){super(t,"BrowseViewer");}get currentDocument(){return this.vCommon.getCurrentDocument(this.v)}bindContainer(t){this.vCommon.bindContainer(this.v,t,`${this.errorPrefix}.bindContainer`);}unbindContainer(){this.vCommon.unbindContainer(this.v);}openDocument(t){this.vCommon.openDocument(t,this.uid,`${this.errorPrefix}.openDocument`);}closeDocument(){return this.vCommon.closeDocument(this.v,`${this.errorPrefix}.closeDocument`)}rotate(t,e){const i=`${this.errorPrefix}.rotate`;return this.vCommon.rotate(this.v,t,e,i)}indexToUid(t){const e=`${this.errorPrefix}.indexToUid`;return this.vCommon.indexToUid(this.v,t,e)}uidToIndex(t){const e=`${this.errorPrefix}.uidToIndex`;return this.vCommon.uidToIndex(this.v,t,e)}getCurrentPageUid(){return this.vCommon.getCurrentPageUid(this.v)}getCurrentPageIndex(){return this.vCommon.getCurrentPageIndex(this.v)}getPageCount(){return this.vCommon.getPageCount(this.v)}goToPage(t){const e=`${this.errorPrefix}.goToPage`;return this.vCommon.gotoPage(this.v,t,e)}saveOperations(){return this.vCommon.saveOperation(this.v)}destroy(){this.vCommon.destroy(this.v);}}var CD=new WeakMap,PD=new WeakMap,TD=new WeakMap,AD=new WeakSet;class kD{constructor(t){v(this,AD),f(this,CD,{writable:!0,value:void 0}),f(this,PD,{writable:!0,value:void 0}),f(this,TD,{writable:!0,value:!1}),i(this,"uid",void 0),i(this,"isDestroyed",!1),i(this,"postfix",void 0);this.uid=Jn(),this.postfix=`-${this.uid}`,s(this,PD,new Kn),_n(t)||Bk(t,"customViewer",0,"new CustomViewer","option");let e=null==t?void 0:t.uiConfig;(!e||Wn(e)&&0===Object.keys(e).length)&&(e={type:"Layout"}),p(this,AD,ED).call(this),s(this,CD,new Jw({container:null==t?void 0:t.container,emitter:n(this,PD),postfix:this.uid,uiConfig:e,injection:{viewer:{postfix:this.postfix}}})),null!=t&&t.container&&e&&n(this,CD).bindContainer(t.container);}get isBoundContainer(){return n(this,TD)}get isVisible(){return "none"!==n(this,CD).rootDom.style.display}bindContainer(t){const e="CustomViewer.bindContainer";KA(t,0,e,"container");const i=qD.isContainerParamValid(t);i&&Iu.error(e,"container",void 0,i);n(this,CD).bindContainer(t)&&s(this,TD,!0);}unbindContainer(){n(this,CD).unbindContainer(),s(this,TD,!1);}hide(){n(this,CD).rootDom.style.display="none";}show(){n(this,CD).rootDom.style.display="flex";}getUiConfig(){return n(this,CD).uiConfig}updateUiConfig(t){const e="CustomViewer.updateUiConfig",i="uiConfig";return !(KA(t,1,e,i)||!Pk(t,"customViewer",e,i,1))&&n(this,CD).updateUiConfig(t)}on(t,e){const i="CustomViewer.on";!KA(t,1,i,"eventName")&&!KA(e,1,i,"listener")&&Ek(t,1,i,"eventName",!1)&&kk(e,i,"listener",1)&&n(this,PD).on(t,e);}off(t,e){const i="CustomViewer.off";!KA(t,1,i,"eventName")&&Ek(t,1,i,"eventName",!1)&&(_n(e)||kk(e,i,"listener",1))&&n(this,PD).off(t,e);}destroy(){this.isDestroyed||(n(this,CD).dispose(),n(this,PD).destroy(),s(this,CD,null),s(this,PD,null)),this.isDestroyed=!0,Object.setPrototypeOf(this,null);}}function ED(){Jw.registerComponent({Root:eb,Layout:Qw,Button:Zw,Blank:eC,SeparatorLine:ib,Close:iC,Done:sC,Back:nC});}function DD(t,e,i){if(!i||jn()||!t.isVisible)return;const n=e,s=n.clientWidth;if(t instanceof lD){let t=20;s<1280&&(t=Math.max(13.5,s/1280*20)),n.style.fontSize=`${t}px`;}}function RD(t){if(t instanceof Blob)return !0;if(Gn(t)){const e=t=>{try{new URL(t);return !0}catch(t){return !1}};return !(!(t=>/^data:image\/([a-zA-Z]*);base64,/.test(t))(t)&&!e(t))}return !1}function ID(t){return !![ck.REJECTED,ck.ACCEPTED,ck.INITIAL_HERE,ck.SIGN_HERE,ck.WITNESS,ck.APPROVED,ck.NOT_APPROVED,ck.DRAFT,ck.FINAL,ck.COMPLETED,ck.CONFIDENTIAL,ck.VOID].includes(t)}function MD(t){return !!ID(t)||(!!Vn(t)||!!GD(t))}function BD(t){return !!Wn(t)&&!(null!=t&&t.content&&!Gn(t.content)||null!=t&&t.color&&!Gn(t.color)||null!=t&&t.fontFamily&&!Gn(t.fontFamily)||null!=t&&t.fontSize&&!Xn(t.fontSize)||null!=t&&t.lineThrough&&!zn(t.lineThrough)||null!=t&&t.underline&&!zn(t.underline)||null!=t&&t.fontWeight&&!["normal","bold"].includes(t.fontWeight)||null!=t&&t.fontStyle&&!["normal","italic"].includes(t.fontStyle))}function UD(t){return !!Wn(t)&&(!!(Xn(null==t?void 0:t.x)&&Xn(null==t?void 0:t.y)&&Xn(null==t?void 0:t.width)&&Xn(null==t?void 0:t.height))&&!(t.width<=0||t.height<=0))}function LD(t,e){const i=["Load","Download","Print"],n=["Layout","Button","Blank","SeparatorLine","Close","Done","Back"],s=[...n,"MainView"],o=["Pagination","RotateLeft","RotateRight","Delete","DeleteCurrent","DeleteAll"],r=[...s,...o,...i,"PerspectiveAll","FullQuad"],a=[...s,...o,...i],l=[...s,"Capture","Flashlight","CameraConvert","CameraResolution","AutoDetect","AutoCapture","ImagePreview"],h=[...s,...o,...i,"Zoom","ZoomIn","ZoomOut","ZoomByPercentage","ThumbnailSwitch","FitMode","DisplayMode","Crop","Filter","Undo","Redo","Pan","FitWidth","FitHeight","FitWindow","ActualSize","SinglePage","ContinuousPage","AnnotationSet","EllipseAnnotation","EraseAnnotation","InkAnnotation","LineAnnotation","PolygonAnnotation","PolylineAnnotation","RectAnnotation","SelectAnnotation","StampIconAnnotation","StampImageAnnotation","TextBoxAnnotation","TextTypewriterAnnotation","BringForward","BringToFront","SendBackward","SendToBack","TextSearchPanel","TextSearchPanelSwitch","TextSelectionMode","HighlightAnnotation","UnderlineAnnotation","StrikeoutAnnotation"];let c;switch(e){case"captureViewer":c=l;break;case"editViewer":c=h;break;case"perspectiveViewer":c=r;break;case"customViewer":c=n;break;case"browseViewer":c=a;}const d=[];return null!=t&&t.type&&!c.includes(null==t?void 0:t.type)&&d.push(t.type),null!=t&&t.children&&t.children.forEach((t=>{Gn(t)&&!c.includes(t)&&d.push(t),Wn(t)&&d.push(...LD(t,e));})),d}function OD(t){const e=[];return null!=t&&t.type&&e.push(t.type),null!=t&&t.children&&t.children.forEach((t=>{Gn(t)&&e.push(t),Wn(t)&&e.push(...OD(t));})),[...new Set(e)]}function WD(t,e){const i=LD(t,e);if(i.length>0){let t="";return i.forEach(((e,n)=>{n===i.length-1?t+=`${e}`:t+=`${e} `;})),t}return !1}function ND(t){const{defaultStyleConfig:e}=t;Object.keys(e).forEach((t=>{const i=e[t];"object"==typeof i&&null!==i&&((t=>{if("lineEnding"in t&&"object"==typeof t.lineEnding&&null!==t.lineEnding){const e=eE(t.lineEnding,"date");delete t.lineEnding,t.lineEnding=e;}})(i),(t=>{"borderWidth"in t&&(t.borderWidth=Hs(Xn(null==t?void 0:t.borderWidth)?t.borderWidth:1,ko.dataResolution,ko.displayResolution));})(i),(t=>{if("textContent"in t)if(Wn(t.textContent)){var e,i,n,s,o,r,a;Xn(null==t||null===(e=t.textContent)||void 0===e?void 0:e.fontSize)&&(t.textContent.fontSize=Hs(null==t||null===(a=t.textContent)||void 0===a?void 0:a.fontSize,ko.dataResolution,ko.displayResolution)),null!=t&&null!==(i=t.textContent)&&void 0!==i&&i.fontStyle&&!["normal","italic"].includes(null==t||null===(n=t.textContent)||void 0===n?void 0:n.fontStyle)&&(t.textContent.fontStyle="normal"),null!=t&&null!==(s=t.textContent)&&void 0!==s&&s.fontWeight&&!["normal","bold"].includes(null==t||null===(o=t.textContent)||void 0===o?void 0:o.fontWeight)&&(t.textContent.fontWeight="normal"),""===(null==t||null===(r=t.textContent)||void 0===r?void 0:r.fontFamily)&&(t.textContent.fontFamily="Helvetica");}else t.textContent={};})(i),(t=>{"lineDash"in t&&t.lineDash.length&&(t.lineDash=Hs(t.lineDash,ko.dataResolution,ko.displayResolution));})(i),(t=>{"textAlign"in t&&!["left","right","center","justify"].includes(null==t?void 0:t.textAlign)&&(t.textAlign="left");})(i),(t=>{"opacity"in t&&(!Xn(null==t?void 0:t.opacity)||(null==t?void 0:t.opacity)<0||(null==t?void 0:t.opacity)>1)&&(t.opacity=1);})(i),"stamp"===t&&(t=>{t.stamp instanceof Blob&&(t.imageData=t.stamp),Gn(t.stamp)&&(RD(t.stamp)?t.imageData=t.stamp:t.stampIcon=ID(t.stamp)?iE(t.stamp,"date"):iE(ck.DRAFT,"date")),GD(t.stamp)&&(t.stampConfig=t.stamp),delete t.stamp;})(i));}));return {...t,controlsStyle:t.annotationSelectionStyle}}function _D(t){if(""===t)return !0;const e=document.createElement("div");e.style.border=t;const i=t=>""===t||"initial"===t,{borderWidth:n,borderColor:s,borderStyle:o}=e.style;return !(i(n)||i(s)||i(o))}function FD(t,e,i){const{left:n,top:s,width:o,height:r}=t;return !(n>e||n+o>e||s>i||s+r>i)}function HD(t,e){return Object.keys(t).filter((i=>t[i]===e))}function VD(t,e){if(t===e)return !0;if(Wn(t)&&Wn(e)&&Object.keys(t).length===Object.keys(e).length)for(const i in t){if(!Object.prototype.hasOwnProperty.call(e,i))return !1;if(!VD(t[i],e[i]))return !1}else {if(!On(t)||!On(e)||t.length!==e.length)return !1;for(let i=0;i<t.length;i++)if(!VD(t[i],e[i]))return !1}return !0}function zD(t,e){let i;switch(t){case"canvasStyle":i=function(t,e){const i=[];i.push(...jD(t,{border:(null==e?void 0:e.border)||"",background:(null==e?void 0:e.background)||""})),_n(null==e?void 0:e.cursor)||Gn(e.cursor)||i.push(`${t}.cursor is invalid`);return i}(t,e);break;case"pageNumberStyle":i=function(t,e){const i=[],n=["color","fontSize","fontFamily","left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY"];return Object.keys(e).forEach((s=>{-1!==n.indexOf(s)&&(Gn(e[s])||i.push(`${t}.${s} is invalid.`)),"border"===s&&Gn(e[s])&&!_D(e[s])&&i.push(`${t}.border is invalid.`),("onPage"===s&&!zn(e[s])||"opacity"===s&&!Xn(e[s])||"visibility"===s&&-1===["visible","hidden"].indexOf(e[s]))&&i.push(`${t}.${s} is invalid.`);})),i}(t,e);break;case"checkBoxStyle":i=function(t,e){const i=[],n=["checkMarkColor","checkMarkLineWidth","left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY"];return Object.keys(e).forEach((s=>{-1!==n.indexOf(s)&&(Gn(e[s])||i.push(`${t}.${s} is invalid.`)),"border"===s&&Gn(e[s])&&!_D(e[s])&&i.push(`${t}.border is invalid.`),("opacity"===s&&!Xn(e[s])||"visibility"===s&&-1===["visible","hidden"].indexOf(e[s]))&&i.push(`${t}.${s} is invalid.`);})),i}(t,e);break;case"quadSelectionStyle":i=function(t,e){const i=[],n=["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground","invalidCtrlBorderColor","invalidBorderColor"];return Object.keys(e).forEach((s=>{-1!==n.indexOf(s)&&(Gn(e[s])||i.push(`${t}.${s} is invalid`)),"border"!==s&&"ctrlBorder"!==s||!Gn(e[s])||_D(e[s])||i.push(`${t}.${s} is invalid`);})),i}(t,e);break;case"annotationSelectionStyle":i=function(t,e){const i=[],n=["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground"];return Object.keys(e).forEach((s=>{-1!==n.indexOf(s)&&(Gn(e[s])||i.push(`${t}.${s} is invalid.`)),"border"!==s&&"ctrlBorder"!==s||!Gn(e[s])||_D(e[s])||i.push(`${t}.${s} is invalid.`);})),i}(t,e);break;default:i=jD(t,e);}return i}function $D(t){return !!Xn(t)&&t>=0}function jD(t,e){const i=[];return Object.keys(e).forEach((n=>{-1!==["background","border"].indexOf(n)&&(Gn(e[n])||i.push(`${t}.${n} is invalid.`),"border"===n&&e[n]&&Gn(e[n])&&!_D(e[n])&&i.push(`${t}.border is invalid.`));})),i}function XD(t,e){const i=t.flat(2),n=e.flat(2);if(i.length!==n.length)return !1;const s=n[0].x-i[0].x,o=n[1].y-i[1].y;for(let t=1;t<i.length;t++){if(n[t].x-i[t].x!==s)return !1;if(n[t].y-i[t].y!==o)return !1}return !0}function GD(t){return Array.isArray(t)&&t.every((t=>"object"==typeof t&&null!==t))}function YD(t){const e={};return !1===(null==t?void 0:t.enableZoom)&&(e.enableZoomInWithKeyboard=!1,e.enableZoomOutWithKeyboard=!1),!1===(null==t?void 0:t.enableUndoRedo)&&(e.enableUndoWithKeyboard=!1,e.enableRedoWithKeyboard=!1),!1===(null==t?void 0:t.enableAnnotationClipboard)&&(e.enableCopyCutPasteWithKeyboard=!1),!1===(null==t?void 0:t.enableMoveAnnotation)&&(e.enableMoveAnnotationWithKeyboard=!1),!1===(null==t?void 0:t.enableDeleteAnnotation)&&(e.enableDeleteWithKeyboard=!1),!1===(null==t?void 0:t.enablePageNavigation)&&(e.enableSelectPageWithKeyboard=!1),!1===(null==t?void 0:t.enableMultiplePagesSelection)&&(e.enableSelectWithShift=!1,e.enableSelectWithCtrl=!1,e.enableSelectAllWithKeyboard=!1),!1===(null==t?void 0:t.enableMultipleAnnotationsSelection)&&(e.enableMultipleSelectAnnotationWithKeyboard=!1),e}class qD{static isLicenseValid(t){if(Gn(t)){const e=t.trim();return 0===e.length||e.startsWith("DLS")||(e.startsWith("f")||e.startsWith("t"))&&e.length>50}return !1}static isQuadValid(t,e){const i=[],n=Ru("Quad",e);if(_n(t))return i.push(`${n} is missing.`),i;const s=Iu.isArrayAndMeetMinLength(t,4),o=Iu.formatDetails(n,s);return o.length?(i.push(...o),i):(t.forEach(((t,n)=>{const s=Ru("Quad",e,`[${n}]`,!0),o=Iu.isArrayAndMeetMinLength(t,2),r=Iu.formatDetails(Ru("Array",s),o);r.length?i.push(...r):t.forEach(((t,e)=>{const n=Iu.isNumberAndIsInRange(t),o=Iu.formatDetails(Ru("Array",s,`[${e}]`,!0),n);o.length&&i.push(...o);}));})),i)}static isRectValid(t,e){const i=[],n=Ru("Rect",e);if(_n(t))return i.push(`${n} is missing.`),i;const s=Iu.formatDetails(n,Wn(t));return s.length?(i.push(...s),i):(["left","top","width","height"].forEach((n=>{const s=Iu.formatDetails(Ru("Rect",e,n),Iu.isNumberAndIsInRange(t[n]));s.length&&i.push(...s);})),i)}static isUpdatedSourceValid(t,e,i){const n=[],s="UpdatedSource",o=Iu.formatDetails(Ru(s,e),Wn(t));if(o.length)return n.push(...o),n;const r=qD.isSourceValid(t,"source",i);if(r.length&&n.push(...r),!_n(t.fileIndex)){const i=Iu.formatDetails(Ru(s,e,"fileIndex"),Iu.isNumberAndIsInRange(t.fileIndex,0));n.push(...i);}return n}static isSourceValid(t,e,i){const n=[],s="Source",o=Iu.formatDetails(Ru(s,e),Wn(t));if(o.length)return n.push(...o),n;const r=Iu.formatDetails(Ru(s,e,"fileData"),Vn(t.fileData));return r.length?(n.push(...r),n):n}static isSourcesValid(t,e,i){const n=[],s="Source[]",o=Iu.formatDetails(Ru(s,e),Iu.isArrayAndMeetMinLength(t));return o.length?(n.push(...o),n):(t.forEach(((t,o)=>{n.push(...this.isSourceValid(t,Ru(s,e,`[${o}]`,!0),i));})),n)}static isLoadSourceOptionsValid(t,e){const i=[],n="LoadSourceOptions",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.insertBeforeIndex)){const s=Iu.formatDetails(Ru(n,e,"insertBeforeIndex"),Iu.isNumberAndIsInRange(t.insertBeforeIndex));i.push(...s);}if(!_n(t.exception)){const s=Iu.formatDetails(Ru(n,e,"exception"),Iu.isStringAndNotEmpty(t.exception,!1));i.push(...s);}return i}static isHandlerTypeValid(t){return {isValid:Gn(t)&&["documentBoundariesDetect","imageFilter"].includes(t)}}static isContainerKeyValid(t,e){const i="container";let n;if(Qn(t)&&(n=t),Gn(t)){const e=document.getElementById(t);Qn(e)&&(n=e);}const s=[];return n||s.push(`${Ru(i,e,i)}: ${Du.CONTAINER_NOT_EXIST.message}`),s}static isContainerParamValid(t){return Gn(t)||Qn(t)?this.isContainerKeyValid(t).length>0?Du.CONTAINER_NOT_EXIST:null:Du.PARAM_INVALID}static isUiConfigValid(t,e){const i="UiConfig",n=[],s=Iu.formatDetails(Ru(i,e),Wn(t));if(s.length)return n.push(...s),n;const o=Iu.formatDetails(Ru(i,e,"type"),Iu.isStringAndNotEmpty(t.type,!1));if(n.push(...o),["id","name","flexDirection","tooltip","className","label"].forEach((s=>{if(!_n(t[s])){const o=Iu.formatDetails(Ru(i,e,s),Iu.isStringAndNotEmpty(t[s]));n.push(...o);}})),["style","events"].forEach((s=>{if(!_n(t[s])){const o=Iu.formatDetails(Ru(i,e,s),Wn(t[s]));n.push(...o);}})),!_n(t.children)){const s=Iu.formatDetails(Ru(i,e,"children"),Iu.isArrayAndMeetMinLength(t.children));if(s.length)return n.push(...s),n;t.children.forEach(((t,s)=>{if(Gn(t)||Wn(t)||n.push(`${i}.children[${s}] is invalid.`),Wn(t)){const o=this.isUiConfigValid(t,Ru(i,e,`children[${s}]`));n.push(...o);}}));}return n}static isDocOptionsValid(t,e){const i=[],n=e||"CreateDocumentOptions",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.name)){const s=Iu.formatDetails(Ru(n,e,"name"),Iu.isStringAndNotEmpty(t.name,!1));i.push(...s);}if(!_n(t.author)){const s=Iu.formatDetails(Ru(n,e,"author"),Iu.isStringAndNotEmpty(t.author,!1));i.push(...s);}if(!_n(t.creationDate)){const s=Iu.formatDetails(Ru(n,e,"creationDate"),Iu.isPdfDate(t.creationDate));i.push(...s);}if(!_n(t.deleteOriginal)){const s=Iu.formatDetails(Ru(n,e,"deleteOriginal"),zn(t.deleteOriginal));i.push(...s);}return i}static isTransferOptionsValid(t,e,i,n){const s=[],o="TransferOptions",r=Iu.formatDetails(Ru(o,n),Wn(t));if(r.length)return s.push(...r),s;if(!_n(t.sourceIndices)){const r=this.isNumberArrayValid(t.sourceIndices,e,i,Ru(o,n,"sourceIndices"));s.push(...r);}if(!_n(t.insertBeforeIndex)){const e=Iu.formatDetails(Ru(o,n,"insertBeforeIndex"),Iu.isNumberAndIsInRange(t.insertBeforeIndex,0));s.push(...e);}return s}static isNumberArrayValid(t,e,i,n){return this.isTypeArrayValid("number",t,e,i,n)}static isStringArrayValid(t,e){return this.isTypeArrayValid("string",t,void 0,void 0,e)}static isBlobArrayValid(t,e){return this.isTypeArrayValid("blob",t,void 0,void 0,e)}static isTypeArrayValid(t,e,i,n,s){const o=[],r=Iu.formatDetails(Ru("Array",s),Iu.isArrayAndMeetMinLength(e));return r.length?(o.push(...r),o):(e.forEach(((e,r)=>{let a=null;"blob"===t?a=Vn(e):"number"===t?a=Iu.isNumberAndIsInRange(e,i,n):"string"===t&&(a=Iu.isStringAndNotEmpty(e));const l=Iu.formatDetails(Ru("Array",s,`[${r}]`,!0),a);o.push(...l);})),o)}static isRotationValid(t,e){const i=[],n=Ru("",e,"rotation"),s=Iu.formatDetails(n,Iu.isNumberAndIsInRange(t));return s.length?(i.push(...s),i):(i.length||t%90==0||i.push(`'${n}' is not supported.`),i)}static isFilterTypeValid(t,e,i){const n=[],s=Ru("",i,"filter"),o=Iu.formatDetails(s,Iu.isStringAndNotEmpty(t,!1));return o.length?(n.push(...o),n):(!n.length&&"none"!==t&&On(e)&&e.length>0&&!e.includes(t)&&n.push(`'${s}' is not supported.`),n)}static isSaveJpegSettingsValid(t,e){const i=[],n="SaveJpegSettings",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.quality)){const s=Iu.formatDetails(Ru(n,e,"quality"),Iu.isNumberAndIsInRange(t.quality,0,100));i.push(...s);}if(!_n(t.saveAnnotation)){const s=Iu.formatDetails(Ru(n,e,"saveAnnotation"),zn(t.saveAnnotation));i.push(...s);}return i}static isSavePngSettingsValid(t,e){const i=[],n="SavePngSettings",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.saveAnnotation)){const s=Iu.formatDetails(Ru(n,e,"saveAnnotation"),zn(t.saveAnnotation));i.push(...s);}return i}static isSavePdfSettingsValid(t,e){const i=[],n="SavePdfSettings",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(["author","creator","keyWords","producer","subject","title"].forEach((s=>{const o=t[s];if(!_n(o)){const t=Iu.formatDetails(Ru(n,e,s),Iu.isStringAndNotEmpty(o,!1));i.push(...t);}})),!_n(t.compression)){const s=Iu.formatDetails(Ru(n,e,"compression"),_o.has(t.compression));i.push(...s);}if(!_n(t.creationDate)){const s=Iu.formatDetails(Ru(n,e,"creationDate"),Iu.isPdfDate(t.creationDate));i.push(...s);}if(!_n(t.modifiedDate)){const s=Iu.formatDetails(Ru(n,e,"modifiedDate"),Iu.isPdfDate(t.modifiedDate));i.push(...s);}if(!_n(t.pageType)){const s=Iu.formatDetails(Ru(n,e,"pageType"),No.has(t.pageType));i.push(...s);}if(!_n(t.version)){const s=Iu.formatDetails(Ru(n,e,"version"),this.isPdfVersionValid(t.version));i.push(...s);}if(!_n(t.mimeType)){const s=Iu.formatDetails(Ru(n,e,"mimeType"),Iu.isStringAndNotEmpty(t.mimeType));i.push(...s);}if(!_n(t.quality)){const s=Iu.formatDetails(Ru(n,e,"quality"),Iu.isNumberAndIsInRange(t.quality,0,100));i.push(...s);}if(!_n(t.password)){const s=Iu.formatDetails(Ru(n,e,"password"),Iu.isStringAndNotEmpty(t.password));i.push(...s),!s.length&&t.password.length>32&&i.push("The specified password exceeds 32 characters.");}if(!_n(t.saveAnnotation)){const s=Iu.formatDetails(Ru(n,e,"saveAnnotation"),["none","image","annotation","flatten"].includes(t.saveAnnotation));i.push(...s);}if(!_n(t.imageScaleFactor)){const s=Iu.formatDetails(Ru(n,e,"imageScaleFactor"),Iu.isNumberAndIsInRange(t.imageScaleFactor,Number.MIN_VALUE,1));i.push(...s);}return i}static isPdfVersionValid(t){return !!Gn(t)&&["1.1","1.2","1.3","1.4","1.5","1.6","1.7"].includes(t.trim())}static isSaveTiffSettingsValid(t,e){const i=[],n="SaveTiffSettings",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.compression)){const s=Iu.formatDetails(Ru(n,e,"compression"),Fo.has(t.compression));i.push(...s);}if(!_n(t.customTag)){const s=Iu.formatDetails(Ru(n,e,"customTag"),Iu.isArrayAndMeetMinLength(t.customTag));i.push(...s),s.length||t.customTag.forEach(((t,s)=>{const o=this.isTiffCustomTagValid(t,Ru(n,e,`customTag[${s}]`));i.push(...o);}));}if(!_n(t.quality)){const s=Iu.formatDetails(Ru(n,e,"quality"),Iu.isNumberAndIsInRange(t.quality,0,100));i.push(...s);}return i}static isTiffCustomTagValid(t,e){const i=[],n="CustomTag",s=Iu.formatDetails(Ru(n,e),Wn(t));if(s.length)return i.push(...s),i;if(!_n(t.content)){const s=Iu.formatDetails(Ru(n,e,"content"),Iu.isStringAndNotEmpty(t.content,!1));i.push(...s);}if(!_n(t.contentIsBase64)){const s=Iu.formatDetails(Ru(n,e,"contentIsBase64"),zn(t.contentIsBase64));i.push(...s);}if(!_n(t.id)){const s=Iu.formatDetails(Ru(n,e,"id"),Iu.isNumberAndIsInRange(t.id));i.push(...s);}return i}static isVideoDeviceInfo(t,e){const i=[],n=Iu.formatDetails(e,Wn(t));i.push(...n);const s=Iu.formatDetails(Ru(e,void 0,"deviceId"),Iu.isStringAndNotEmpty(t.deviceId,!1));i.push(...s);const o=Iu.formatDetails(Ru(e,void 0,"label"),Iu.isStringAndNotEmpty(t.label,!1));return i.push(...o),i}static isVideoConfig(t,e){const i=[],n=Iu.formatDetails(e,Wn(t));if(n.length)return i.push(...n),i;if(!_n(t.fill)){const n=Iu.formatDetails(Ru(e,void 0,"fill"),zn(t.fill));i.push(...n);}if(!_n(t.resolution)){const n=qD.isNumberArrayValid(t.resolution,0,void 0,Ru(e,void 0,"resolution"));i.push(...n);}return i}static isZoomOriginValid(t){const e=[],i=Iu.formatDetails("zoomOrigin",Wn(t));return i.length?(e.push(...i),e):(["x","y"].forEach((i=>{const n=t[i];_n(n)?e.push(`ZoomOrigin.${i} is missing.`):["start","center","end"].includes(n)||e.push(`ZoomOrigin.${i} is valid.`);})),e)}static isAnnotationOptionsValid(t,e,i){const n=[],s=["x","y","rotation"],o=["width","height","borderWidth","opacity","miterLimit","fontSize"],r=["borderColor","background","icon","lineCap","lineJoin","textAlign","content","color","fontFamily","fontWeight","fontStyle"],a=["points"],l=["textContents"],h=["startPoint","endPoint"],c=["flags"],d=["stamp"],u=["lineDash"],p=["rects"],g=t=>!!Wn(t)&&(!!Xn(null==t?void 0:t.x)&&!!Xn(null==t?void 0:t.y)),f=function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!On(t))return !1;if(e&&t.length<2)return !1;for(let e=0;e<t.length;e++)if(!g(t[e]))return !1;return !0};return Object.keys(t).forEach((v=>{const m=t[v];let y=!0;(s.includes(v)&&!Xn(m)||o.includes(v)&&!$D(m)||r.includes(v)&&!Gn(m)||l.includes(v)&&!((t,e)=>{if(!On(t))return !1;if("textTypewriter"===e&&0===t.length)return !1;for(let e=0;e<t.length;e++){const i=t[e];if(!Wn(i))return !1;if(!BD(i))return !1}return !0})(m,i)||h.includes(v)&&!g(m)||c.includes(v)&&!Wn(m)||d.includes(v)&&!MD(m)||u.includes(v)&&!(t=>{if(!On(t))return !1;for(let e=0;e<t.length;e++)if(!$D(t[e]))return !1;return !0})(m)||p.includes(v)&&!(t=>{if(!On(t))return !1;if(0===t.length)return !1;for(let e=0;e<t.length;e++){const i=t[e];if(!Wn(i))return !1;if(!UD(i))return !1}return !0})(m))&&(y=!1),a.includes(v)&&("ink"===i?(t=>{if(!On(t))return !1;if(!t.length)return !1;for(let e=0;e<t.length;e++)if(!f(t[e],!1))return !1;return !0})(t[v])||(y=!1):f(t[v])||(y=!1)),y||n.push(`${e}.${v} is invalid`);})),n}static isAnnotationDrawingStyleValid(t,e){const i=["opacity","borderWidth"],n=["borderColor","background","textAlign"],s=["lineEnding","textContent"],o=[];return Object.keys(t).forEach((r=>{if(["rectangle","ellipse","polygon","polyline","line","ink","textBox","textTypewriter","stamp","highlight","underline","strikeout"].includes(r)){const a=t[r];Object.keys(a).forEach((t=>{const l=a[t];let h=!0;(i.includes(t)&&!Xn(l)||n.includes(t)&&!Gn(l)||s.includes(t)&&!Wn(l))&&(h=!1),"stamp"!==t||MD(l)||(h=!1),"textContent"===t&&h&&(null!=l&&l.content&&!Gn(l.content)||null!=l&&l.color&&!Gn(l.color)||null!=l&&l.fontFamily&&!Gn(l.fontFamily)||null!=l&&l.fontSize&&!Xn(l.fontSize)||null!=l&&l.lineThrough&&!zn(l.lineThrough)||null!=l&&l.underline&&!zn(l.underline)||null!=l&&l.fontWeight&&!["normal","bold"].includes(l.fontWeight)||null!=l&&l.fontStyle&&!["normal","italic"].includes(l.fontStyle))&&(h=!1),h||o.push(`${e}[${r}].${t} is invalid`);}));}})),o}static isSearchTextOptionsValid(t,e){const i=[],n=Iu.formatDetails(e,Wn(t));return n.length?(i.push(...n),i):(["caseSensitive","wholeWord"].forEach((n=>{if(!_n(t[n])){const s=Iu.formatDetails(Ru(e,void 0,n),zn(t[n]));i.push(...s);}})),i)}}var JD=new WeakMap,ZD=new WeakMap,QD=new WeakMap;class KD{constructor(t,e){f(this,QD,{get:tR,set:void 0}),f(this,JD,{writable:!0,value:void 0}),f(this,ZD,{writable:!0,value:void 0}),s(this,JD,t),s(this,ZD,e);}get name(){return n(this,ZD).name}get uid(){return n(this,ZD).uid}get pages(){return n(this,ZD).pages.slice()}get creationDate(){return n(this,ZD).creationDate}get author(){return n(this,ZD).author}async loadSource(t,e){const i="IDocument.loadSource",s="sources";Ep.makeSureLoadLicenseExist(),KA(t,0,i,s);!function(t,e,i,n,s){let o=[];if(On(t)){for(let i=0;i<t.length;i++)if(!Vn(t[i]))if(Wn(t[i])){const n=qD.isSourceValid(t[i],Ru("Source",void 0,`[${i}]`,!0),e);n.length&&o.push(...n);}else {const t=Iu.formatDetails(Ru("Source",s,`[${i}]`,!0),!1);o.push(...t);}}else Vn(t)||(o=qD.isSourceValid(t,void 0,e));!o.length||Iu.output(i,n,s,o);}(t,n(this,JD).filterService.getSupportedFilters().map((t=>t.type)),0,i,s),Wn(e)?function(t,e,i,n){const s=qD.isLoadSourceOptionsValid(t,void 0);!s.length||Iu.output(e,i,n,s);}(e,0,i,"loadSourceOptions"):_n(e)||Mk(e,0,i,"index",0),On(t)||(t=[t]),t=t.map((t=>Vn(t)?{fileData:t}:(t.extraPageData=[],t)));const o=Du.buildInfo("loadSource",{docUid:this.uid,current:0,total:t.length});return Du.info(o),n(this,JD).loadSource(t,this.uid,e,o).catch((t=>(o.status="Failed",Du.info(o),Du.reject(t,i))))}getPageData(t){const e="IDocument.getPageData",i="pageUid";KA(t,0,e,i),Ek(t,0,e,i,!1),this.pages.includes(t)||Iu.error(e,i,void 0,Du.PAGE_NOT_EXIST);return n(this,JD).getPageData(t)}async updatePage(t,e){const i="IDocument.updatePage",s="pageUid";Ep.makeSureLoadLicenseExist(),KA(t,0,i,s),KA(e,0,i,"data"),Ek(t,0,i,s,!1),Ak(this.pages,t,0,i);return function(t,e,i,n,s){const o=qD.isUpdatedSourceValid(t,Ru("UpdatedSource",void 0),e);!o.length||Iu.output(i,n,s,o);}(e,n(this,JD).filterService.getSupportedFilters().map((t=>t.type)),0,i,"source"),e.rotation=void 0,e.perspectiveQuad=void 0,e.filer=void 0,n(this,JD).updatePage(t,e).catch((t=>-80101===t.code?Du.reject(t,i,"fileData"):Du.reject(t,i,"source")))}deletePages(t){const e="IDocument.deletePages",i="indices";if(KA(t,1,e,i)||!Dk(t,1,e,i,0,n(this,QD)-1))return !1;const s=t.map((t=>n(this,ZD).pages[t]));return n(this,JD).deletePages(this.uid,s)}deleteAllPages(){return n(this,ZD).pages.slice(),n(this,JD).deleteAllPages(this.uid)}movePages(t,e){const i="IDocument.movePages",s="indices";KA(t,0,i,s),Dk(t,0,i,s,0,n(this,QD)-1),_n(e)||Mk(e,0,i,"insertBeforeIndex",0),e=e>n(this,QD)-1?void 0:e,n(this,JD).movePages(this.uid,t,e);}switchPage(t,e){const i="IDocument.switchPage",s="oneIndex",o="anotherIndex";KA(t,0,i,s),KA(e,0,i,o),Mk(t,0,i,s,0,n(this,QD)-1),Mk(e,0,i,o,0,n(this,QD)-1),n(this,JD).documentService.swapPages(this.uid,t,e);}rename(t){const e="IDocument.rename",i="name";return !KA(t,1,e,i)&&(!!Ek(t,1,e,i)&&n(this,JD).documentService.renameDocument(this.uid,t))}setPageCustomData(t,e){const i="IDocument.setPageCustomData",s="pageUid";return KA(t,0,i,s),KA(e,0,i,"data"),Ek(t,0,i,s,!1),Ak(this.pages,t,0,i),n(this,JD).setCustomData(t,e)}getPageCustomData(t){const e="IDocument.getPageCustomData",i="pageUid";return KA(t,0,e,i),Ek(t,0,e,i,!1),Ak(this.pages,t,0,e),n(this,JD).getCustomData(t)}async saveToJpeg(t,e){const i="IDocument.saveToJpeg",s="index";KA(t,0,i,s),Mk(t,0,i,s,0,n(this,QD)-1),_n(e)||function(t,e,i){const n=qD.isSaveJpegSettingsValid(t);!n.length||Iu.output(e,i,"saveJpegSettings",n);}(e,0,i);const o=this.pages[t],r=Du.buildInfo("save",{docUid:this.uid,pageUids:[o],current:0,total:1});return Du.info(r),n(this,JD).fileSaveService.saveToJpeg(o,e,r).catch((t=>{r.status="Failed",Du.info(r),Du.reject(t,i);}))}saveToPng(t,e){const i="IDocument.saveToPng",s="index";KA(t,0,i,s),Mk(t,0,i,s,0,n(this,QD)-1),_n(e)||function(t,e,i){const n=qD.isSavePngSettingsValid(t);n.length&&Iu.output(e,i,"savePngSettings",n);}(e,0,i);const o=this.pages[t],r=Du.buildInfo("save",{docUid:this.uid,pageUids:[o],current:0,total:1});return Du.info(r),n(this,JD).fileSaveService.saveToPng(o,e,r).catch((t=>(r.status="Failed",Du.info(r),Du.reject(t,i))))}saveToPdf(t,e){const i="IDocument.saveToPdf";0===this.pages.length&&Du.throw(Du.DOC_NO_IMAGE),On(t)?Dk(t,0,i,"indices",0,n(this,QD)-1):(e=t,t=Array.from(Array(this.pages.length).keys())),_n(e)||function(t,e,i){const n=qD.isSavePdfSettingsValid(t);!n.length||Iu.output(e,i,"savePdfSettings",n);}(e,0,i);const s=[];t.forEach((t=>{s.push(this.pages[t]);}));try{!e||"annotation"!==e.saveAnnotation&&"flatten"!==e.saveAnnotation||Ep.makeSureAnnotationLicenseExist();}catch(t){return Promise.reject(t)}const o=Du.buildInfo("save",{docUid:this.uid,pageUids:s,current:0,total:s.length});return Du.info(o),n(this,JD).fileSaveService.saveToPdf(s,e,o).catch((t=>(o.status="Failed",Du.info(o),Du.reject(t,i))))}saveToTiff(t,e){const i="IDocument.saveToTiff";0===this.pages.length&&Du.throw(Du.DOC_NO_IMAGE),On(t)?Dk(t,0,i,"indices",0,n(this,QD)-1):(e=t,t=Array.from(Array(this.pages.length).keys())),_n(e)||function(t,e,i){const n=qD.isSaveTiffSettingsValid(t);!n.length||Iu.output(e,i,"saveTiffSettings",n);}(e,0,i);const s=[];t.forEach((t=>{s.push(this.pages[t]);}));const o=Du.buildInfo("save",{docUid:this.uid,pageUids:s,current:0,total:s.length});return Du.info(o),n(this,JD).fileSaveService.saveToTiff(s,e,o).catch((t=>(o.status="Failed",Du.info(o),Du.reject(t,i))))}print(t,e){const i="IDocument.print";let s,o=e;var r;(On(t)?(Dk(t,0,i,"indices",0,n(this,QD)-1),s=t):o=t,_n(o))||(_n(null===(r=o)||void 0===r?void 0:r.printAnnotation)||zn(o.printAnnotation)||Iu.error(i,"setting.printAnnotation",void 0,Du.PARAM_INVALID));0===this.pages.length&&Du.throw(Du.DOC_NO_IMAGE),n(this,JD).printPages(this.uid,s,o);}insertBlankPage(t,e,i){const s="IDocument.insertBlankPage",o="pageWidth",r="pageHeight";Ep.makeSureLoadLicenseExist(),KA(t,0,s,o),KA(e,0,s,r),Mk(t,0,s,o,.72,7200),Mk(e,0,s,r,.72,7200),_n(i)||Mk(i,0,s,"insertBeforeIndex",0);return n(this,JD).insertBlankPage(this.uid,Math.floor(Hs(t,ko.dataResolution,72))||1,Math.floor(Hs(e,ko.dataResolution,72))||1,72,72,i)}isPageModified(t){const e="IDocument.isPageModified",i="index";KA(t,0,e,i),Mk(t,0,e,i,0,n(this,QD)-1);const s=this.pages[t];return n(this,JD).isPageModified(s)}createTextSearcher(t,e){const i="IDocument.createTextSearcher";if(KA(t,0,i,"text"),Ek(t,0,i,"text"),!_n(e)){const t=qD.isSearchTextOptionsValid(e,"options");if(t.length){const e=Du.PARAM_INVALID;e.details=t,Du.error(e,i,"options");}}""===t&&Du.error(Du.PARAM_INVALID,i,"text");return n(this,JD).createTextSearcher(this.uid,t,e)}}function tR(){return n(this,ZD).pages.length}function eR(t,e,i,n,s){if(!_n(t)){const o="transferOptions",r=qD.isTransferOptionsValid(t,e,i,o);if(r.length)return Iu.output(n,s,o,r)}return !0}function iR(t,e,i,n){if(!_n(t)){const s=qD.isDocOptionsValid(t);if(s.length)return Iu.output(e,i,n,s)}return !0}function nR(t,e,i,n,s){const o=e.reduce(((e,i,n)=>(t.has(i)||e.push(`${s}[${n}]:The specified document(s) do not exist.`),e)),[]);return !o.length||Iu.output(i,n,s,o,Du.DOC_NOT_EXIST,!0)}const sR=["documentCreated","documentDeleted","pagesAdded","pagesDeleted"];var oR=new WeakMap,rR=new WeakMap,aR=new WeakMap;const lR=new class extends js{constructor(){super(),f(this,oR,{writable:!0,value:void 0}),f(this,rR,{writable:!0,value:void 0}),f(this,aR,{writable:!0,value:void 0}),s(this,aR,new Kn),s(this,oR,UT),s(this,rR,new Map),UT.onUnload.on((()=>{n(this,rR).clear(),n(this,aR).removeAllEventListeners();}),this);const{documentService:t}=UT;t.onDocumentCreated.on((t=>{const e=n(this,oR).getDocument(t.docUid),i=new KD(n(this,oR),e);n(this,rR).set(i.uid,i),n(this,aR).emit("documentCreated",t);}),this),t.onDocumentDeleted.on((t=>{n(this,rR).has(t.docUid)&&n(this,rR).delete(t.docUid),n(this,aR).emit("documentDeleted",t);}),this),t.onPagesAddedOut.on((t=>{t.indices.length&&t.pageUids.length&&n(this,aR).emit("pagesAdded",t);}),this),t.onDeletePagesFromDoc.on((t=>{n(this,aR).emit("pagesDeleted",t);}),this),t.onDeleteAllPagesFromDoc.on((t=>{n(this,aR).emit("pagesDeleted",t);}),this);}createDocument(t){iR(t,0,"DocumentManager.createDocument","createDocumentOptions");const e=n(this,oR).createDocument(t);return n(this,rR).get(e.uid)}getDocument(t){const e="DocumentManager.getDocument",i="docUid";if(KA(t,1,e,i)||!Ek(t,1,e,i))return null;const s=n(this,rR).get(t);return s||(Iu.warning(e,i,void 0,Du.DOC_NOT_EXIST),null)}getAllDocuments(){return Array.from(n(this,rR).values())}deleteDocuments(t){const e="DocumentManager.deleteDocuments",i="docUids";return !(KA(t,1,e,i)||!DE(t,1,e,i,void 0,!1)||!nR(n(this,rR),t,1,e,i))&&n(this,oR).deleteDocuments([...new Set(t)])}deleteAllDocuments(){const t=n(this,oR).documentService.getAllDocuments();return n(this,oR).deleteDocuments(t.map((t=>t.uid)))}copyPagesToDocument(t,e,i){const s="DocumentManager.copyPagesToDocument",o="sourceDocUid",r="targetDocUid";KA(t,0,s,o),KA(e,0,s,r),Ek(t,0,s,o),Ek(e,0,s,r);const a=n(this,rR).get(t),l=n(this,rR).get(e);return a&&l||Du.throw(Du.DOC_NOT_EXIST,s),eR(i,0,a.pages.length-1,0,s),n(this,oR).transferDocument(t,e,{...i,copy:!0})}movePagesToDocument(t,e,i){const s="DocumentManager.movePagesToDocument",o="sourceDocUid",r="targetDocUid";KA(t,0,s,o),KA(e,0,s,r),Ek(t,0,s,o),Ek(e,0,s,r);const a=n(this,rR).get(t),l=n(this,rR).get(e);return a&&l||Du.throw(Du.DOC_NOT_EXIST,s),eR(i,0,a.pages.length-1,0,s),n(this,oR).transferDocument(t,e,i)}mergeDocuments(t,e){const i="DocumentManager.mergeDocuments",s="docUids";KA(t,0,i,s),DE(t,0,i,s,void 0,!1),function(t){return new Set(t).size!==t.length}(t)&&Iu.error(void 0,void 0,void 0,Du.DOC_UID_DUPLICATE),nR(n(this,rR),t,0,i,s),iR(e,0,i,"mergeDocumentOptions");const o=n(this,oR).mergeDocuments(t,e);return n(this,rR).get(o.uid)}on(t,e){const i="DocumentManager.on";!KA(t,1,i,"eventName")&&!KA(e,1,i,"listener")&&Ek(t,1,i,"eventName",!1)&&kk(e,i,"listener",1)&&(sR.includes(t)?n(this,aR).on(t,e):Du.warning(Du.PARAM_NOT_SUPPORT,i,"eventName"));}off(t,e){const i="DocumentManager.off";!KA(t,1,i,"eventName")&&Ek(t,1,i,"eventName",!1)&&(_n(e)||kk(e,i,"listener",1))&&(sR.includes(t)?n(this,aR).off(t,e):Du.warning(Du.PARAM_NOT_SUPPORT,i,"eventName"));}},hR=document.currentScript;function cR(){return `${(()=>{if(!ln&&hR){let{src:t}=hR;const e=t.indexOf("?");if(-1!==e)t=t.substring(0,e);else {const e=t.indexOf("#");-1!==e&&(t=t.substring(0,e));}return t.substring(0,t.lastIndexOf("/")+1)}return "./"})()}engine`}let dR="";function uR(){let t,i;var n;if(""===dR&&(CoreModule&&CoreModule.engineResourcePaths?(t=CoreModule.engineResourcePaths.ddv,i=CoreModule.engineResourcePaths.rootDirectory):null!==(n=window)&&void 0!==n&&null!==(n=n.Dynamsoft)&&void 0!==n&&null!==(n=n.Core)&&void 0!==n&&null!==(n=n.CoreModule)&&void 0!==n&&null!==(n=n.engineResourcePaths)&&void 0!==n&&n.ddv&&(t=window.Dynamsoft.Core.CoreModule.engineResourcePaths.ddv,window.Dynamsoft.Core.CoreModule.engineResourcePaths.rootDirectory&&(i=window.Dynamsoft.Core.CoreModule.engineResourcePaths.rootDirectory)),t))if(Gn(t)&&(dR=t),Gn(dR)){if(dR.startsWith("https://")||dR.startsWith("http://"));else if(dR.startsWith("@engineRootDirectory/")){let t=i;i&&Gn(i)&&i.length>0?"/"==t.charAt(t.length-1)&&(t=t.substring(0,t.length-1)):t="",dR=dR.replace("@engineRootDirectory",t);}else if("@engineRootDirectory"===dR&&(dR=""),i&&Gn(i)&&i.length>0){let t="";"/"==i.charAt(i.length-1)||(t="/"),dR=[i,t,dR].join("");}}else dR="";return dR}var pR=new WeakMap,gR=new WeakMap,fR=new WeakMap;const vR=new class{constructor(){f(this,pR,{writable:!0,value:""}),f(this,gR,{writable:!0,value:""}),f(this,fR,{writable:!0,value:""});}get versionInfo(){return {viewer:Op,engine:no.version}}set engineResourcePath(t){Gn(t)?s(this,fR,t):Du.throw(Du.PARAM_INVALID,"Core.engineResourcePath","engineResourcePath");}get engineResourcePath(){const t=uR();return ""!==t?(s(this,fR,t),t):(""===n(this,fR)&&s(this,fR,cR()),n(this,fR))}set license(t){!function(t,e,i,n){const s=Iu.formatError({isValid:qD.isLicenseValid(t)});!s||Iu.output(e,i,n,void 0,s);}(t,0,"Core.license","license"),s(this,gR,t);}get license(){return n(this,gR)}set deviceFriendlyName(t){Gn(t)?s(this,pR,t):Du.throw(Du.PARAM_INVALID,"Core.deviceFriendlyName","deviceFriendlyName");}get deviceFriendlyName(){return n(this,pR)}loadWasm(){return async function(t){let e=t.trim();e.endsWith("/")||(e=`${e}/`);const i=Du.buildInfo("loadWasm",{});if(Du.info(i),no.resourceDir=e,!await no.isResourceDirValid())return i.status="Failed",Du.info(i),Du.reject(Du.RESOURCE_NOT_FOUND,"DDV.Core.loadWasm");const n=no.preloadModule("proc"),s=no.preloadModule("pdf");await Promise.all([n,s]),i.status="Completed",Du.info(i);}(this.engineResourcePath)}init(){return rg({license:n(this,gR),engineResourcePath:this.engineResourcePath,deviceFriendlyName:n(this,pR)})}};var mR;!function(t){t.NONE="none",t.BLACK_AND_WHITE="blackAndWhite",t.GRAY="gray",t.REMOVE_SHADOW="removeShadow",t.SAVE_INK="saveInk",t.ENHANCE="enhance",t.INVERT="invert";}(mR||(mR={}));const yR=[],xR={documentManager:lR,Core:vR,Elements:ek,DocumentDetect:ou,ImageFilter:class{constructor(){v(this,Au),v(this,Tu);}get defaultFilterType(){return Yd.NONE}async applyFilter(t,e,i,n){const s=new xo,o=p(this,Tu,ku).call(this,e,i),r=p(this,Au,Eu).call(this,{outputType:t.type,...n||{}});let a;try{const i=await s.initImage({source:t.data,isRGBA:t.type===co.RGBA,width:t.width,height:t.height,isBGRA:t.type===co.BGRA});let n;i.srcBuffer&&(t.data=i.srcBuffer),e===Yd.NONE?(n=await s.getImage({jpegQuality:r.jpegQuality,ifDeleteObject:!0,isRGBA:t.type===co.RGBA,bitDepth:r.bitDepth,xDpi:r.xdpi,yDpi:r.ydpi,returnBlob:!1,returnType:To[r.outputType]}),s.freeReservedData()):n=await s.filter(Cu.get(e),o,r),a=new Blob([n.imageData],{type:n.blobType});}finally{s.terminate();}return a}querySupported(){return [{type:Yd.NONE,label:"Original"},{type:Yd.BLACK_AND_WHITE,label:"B&W"},{type:Yd.GRAY,label:"Grayscale"},{type:Yd.SAVE_INK,label:"Save Toner"}]}destroy(){}},BrowseViewer:SD,CaptureViewer:_k,CustomViewer:kD,EditViewer:lD,PerspectiveViewer:wD,get lastError(){return Du.getLastError()},clearLastError(){Du.lastError=void 0;},Experiments:{get(t,e){switch(t){case"WasmEnv":return no;case"ImageProcess":return new Uu;case"FileParser.Options":return UT.getFileParserDefaultOptions(e);case"InnerViewer":return UT.getViewer(e);case"PageSourceInfo":return UT.getPageSourceInfo(e);case"AnnotationInkSignatureBoard":return $y;case"AnnotationCustomStampBoard":return ix;default:return}},set(t,e){switch(t){case"FileParser.Options":return UT.setFileParserDefaultOptions(e.type,e.options);case"ClearExternalHandler":return UT.clearExternalHandler(e.type);default:return}}},async addFonts(t){const e="DDV.addFonts";if(KA(t,0,e,"fonts"))return [];const i=function(t,e,i,n,s){const o=Iu.formatError({isValid:On(t)});if(o)return Iu.output(e,i,n,void 0,o);const r=[];return t.forEach(((t,e)=>{const i=Iu.formatDetails(Ru("Array",s,`[${e}]`,!0),Vn(t));r.push(...i);})),!!r.length&&Iu.output(e,i,n,r)}(t,0,e,"fonts","font");if(i)return [];const n=[];try{for(let e=0;e<t.length;e++){const i=t[e],s=new Co,o=await s.getFontInfo(i).catch((t=>{throw s.terminate(),t}));s.terminate();for(let t=0;t<o.fontInfo.length;t++){const e=o.fontInfo[t];if(n.includes(e.family)||n.push(e.family),!yR.includes(e.family)){const t=new FontFace(e.family,o.srcBuffer,{style:"normal",weight:"normal",display:"swap"}),i=await t.load();document.fonts.add(i),yR.push(e.family);const n=`${e.family}${e.isBold?"Blob":""}${e.isItalic?"Italic":""}`;So.addPdfFont(n,o.srcBuffer),UT.getViewers().forEach((t=>{t.addFontToUi(e.family),t.context.render();}));}}}}catch(t){return Du.reject(Du.PARAM_INVALID,e,"fonts")}return Promise.resolve(n)},getDefaultUiConfig(t){const e="DDV.getDefaultUiConfig",i="viewerType";if(KA(t,1,i,e)||!Ek(t,1,e,i)||!function(t,e,i,n){return !!["editViewer","perspectiveViewer","captureViewer","browseViewer"].includes(t)||Iu.output(n,e,i,void 0,Du.PARAM_NOT_SUPPORT)}(t,e,i,1))return null;let n=null;if(jn()){n={editViewer:nk,perspectiveViewer:sk,captureViewer:ik,browseViewer:lk}[t];}else {n={editViewer:ak,perspectiveViewer:rk,captureViewer:ok,browseViewer:lk}[t];}return Nn(n)},setProcessingHandler(t,e){const i="DDV.setProcessingHandler",n="type",s="handler";switch(KA(t,0,i,n),KA(e,0,i,s),function(t,e,i,n){const s=Iu.formatError(qD.isHandlerTypeValid(t));s&&Iu.output(e,i,n,void 0,s);}(t,0,i,n),t){case"documentBoundariesDetect":("function"!=typeof(o=e).detect||"function"!=typeof o.destroy)&&Iu.error(i,s);break;case"imageFilter":(function(t){return "function"==typeof t.querySupported&&"defaultFilterType"in t&&"function"==typeof t.applyFilter&&"function"==typeof t.destroy})(e)||Iu.error(i,s);}var o;try{switch(t){case"documentBoundariesDetect":UT.setDetectHandler(t,e);break;case"imageFilter":UT.setImageFilterHandler(e);}}catch(t){Du.throw(t,i);}},setFileParser(t,e){UT.setFileParser(t,e);},unload(){this.Core.deviceFriendlyName="",this.Core.engineResourcePath=uR(),this.Core.license="",UT.unload(),UT.onUnload.emit(),zE.clear(),this.off("error"),this.off("warning"),this.off("verbose"),this.off("info");},on(t,e){const i="DDV.on";if(KA(t,1,i,"eventName")||KA(e,1,i,"listener")||!Ek(t,1,i,"eventName",!1)||!kk(e,i,"listener",1))return;const n={error:"error",warning:"warning",verbose:"verbose",info:"info"}[t];n?Du.on(n,e):Du.throw(Du.PARAM_NOT_SUPPORT,i,"eventName");},off(t,e){const i="DDV.off";if(KA(t,1,i,"eventName")||!Ek(t,1,i,"eventName",!1))return;if(!_n(e)&&!kk(e,i,"listener",1))return;const n={error:"error",warning:"warning",verbose:"verbose",info:"info"}[t];n?Du.off(n,e):Du.throw(Du.PARAM_NOT_SUPPORT,i,"eventName");},EnumImageDataType:co,EnumConvertMode:oc,EnumDocumentDetectionStatus:Gd,EnumImageFilterType:mR,EnumPDFCompressionType:Lo,EnumPDFPageType:Oo,EnumTIFFCompressionType:Uo,EnumStampIcon:ck,EnumLineEnding:dk,EnumAnnotationRenderMode:rc,annotationManager:ZE};window.Dynamsoft||(window.Dynamsoft={}),window.Dynamsoft.DDV=xR;

export { SD as BrowseViewer, _k as CaptureViewer, kD as CustomViewer, xR as DDV, lD as EditViewer, rc as EnumAnnotationRenderMode, oc as EnumConvertMode, Gd as EnumDocumentDetectionStatus, co as EnumImageDataType, mR as EnumImageFilterType, Lo as EnumPDFCompressionType, Oo as EnumPDFPageType, Uo as EnumTIFFCompressionType, wD as PerspectiveViewer };
