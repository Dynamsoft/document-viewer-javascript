/*! 
* 20251230183233
* Dynamsoft JavaScript Library
* Product: Dynamsoft Document Viewer
* Web Site: https://www.dynamsoft.com
*
* Copyright 2025, Dynamsoft Corporation
* Author: Dynamsoft Support Team
* Version: 3.2.0
*/

import { mapPackageRegister, CoreModule } from 'dynamsoft-core';

function i(t,e,i){return (e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return ("string"===e?String:Number)(t)}(t,"string");return "symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function s(t,e){return h(t,o(t,e,"get"))}function n(t,e,i){return c(t,o(t,e,"set"),i),i}function o(t,e,i){if(!e.has(t))throw new TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function r(t,e,i){return d(t,e),u(i,"get"),h(t,i)}function a(t,e,i,s){return d(t,e),u(i,"set"),c(t,i,s),s}function l(t,e,i){return d(t,e),i}function h(t,e){return e.get?e.get.call(t):e.value}function c(t,e,i){if(e.set)e.set.call(t,i);else {if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=i;}}function d(t,e){if(t!==e)throw new TypeError("Private static access of wrong provenance")}function u(t,e){if(void 0===t)throw new TypeError("attempted to "+e+" private static field before its declaration")}function p(t,e,i){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return i}function g(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function f(t,e,i){g(t,e),e.set(t,i);}function v(t,e){g(t,e),e.add(t);}function m(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{l(s.next(t));}catch(t){o(t);}}function a(t){try{l(s.throw(t));}catch(t){o(t);}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e);}))).then(r,a);}l((s=s.apply(t,e||[])).next());}))}function y(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)}function x(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i}var w,b,S,C,P,T,A,k,D,R,E,M,I,B,U,L,O,N,_,W,F,H,V,z,$,j,X,G,Y,q,J,Z,Q,K,tt,et,it,st,nt,ot,rt,at,lt,ht,ct,dt,ut,pt,gt,ft,vt,mt,yt,xt,wt,bt,St,Ct,Pt,Tt,At,kt,Dt,Rt,Et,Mt,It,Bt,Ut,Lt,Ot,Nt,_t,Wt,Ft,Ht,Vt,zt,$t,jt,Xt,Gt,Yt,qt,Jt,Zt,Qt,Kt,te,ee,ie,se,ne,oe,re,ae,le,he,ce,de,ue,pe,ge,fe,ve,me,ye,xe,we,be,Se,Ce,Pe,Te,Ae,ke,De,Re,Ee,Me,Ie,Be,Ue,Le,Oe,Ne,_e,We,Fe,He,Ve,ze,$e,je,Xe,Ge,Ye,qe,Je,Ze,Qe,Ke,ti,ei,ii,si,ni,oi,ri,ai,li,hi,ci,di,ui,pi,gi,fi,vi,mi,yi,xi,wi;"function"==typeof SuppressedError&&SuppressedError,function(t){t.logInfo="logInfo",t.logDebug="logDebug",t.logAll="logAll",t.imgIO="imgIO",t.imgProc="imgProc",t.binaryBlobType="application/octet-stream",t.wasmExtension=".wasm";}(w||(w={})),function(t){t.imgCore="imgCore",t.imgProc="imgProc",t.pdfCore="pdfCore";}(b||(b={})),function(t){t.core="ddv-core",t.reader="ddv-reader",t.detector="ddv-detector",t.loader="ddv-loader",t.proc="ddv-proc";}(S||(S={})),function(t){t.pending="pending",t.ready="ready",t.failed="failed",t.destroyed="destroyed",t.init="init";}(C||(C={})),function(t){t.PARAMETER_TYPE_ERROR="Parameter Type not Supported = ",t.TIMEOUT="Timeout no Response = ",t.FILE_STREAM_ERROR="File Stream Error = ",t.WASM_EXCEPTION_ERROR="An WASM exception occurred.";}(P||(P={})),function(t){t[t.LONG_KEY=0]="LONG_KEY",t[t.DLS_KEY=1]="DLS_KEY";}(T||(T={})),function(t){t[t.wasmSucceed=0]="wasmSucceed",t[t.wasmBase=-4e3]="wasmBase",t[t.wasmException=-4001]="wasmException",t[t.wasmNoModule=-4002]="wasmNoModule",t[t.wasmJsBase=-4100]="wasmJsBase",t[t.wasmJsObjectNotInit=-4101]="wasmJsObjectNotInit",t[t.wasmJsObjectTerminated=-4102]="wasmJsObjectTerminated",t[t.wasmJsObjectInitFailed=-4103]="wasmJsObjectInitFailed",t[t.wasmJsNotLoaded=-4104]="wasmJsNotLoaded",t[t.wasmJsInvalidJson=-4105]="wasmJsInvalidJson",t[t.wasmJsWorkerRunException=-4106]="wasmJsWorkerRunException",t[t.wasmJsWorkerRunFailed=-4107]="wasmJsWorkerRunFailed",t[t.wasmJsReadFileFailed=-4108]="wasmJsReadFileFailed",t[t.wasmJsCoreTaskException=-4109]="wasmJsCoreTaskException",t[t.wasmJsProcTaskException=-4110]="wasmJsProcTaskException",t[t.wasmJsSavePdfFailed=-4111]="wasmJsSavePdfFailed",t[t.wasmJsSaveTiffFailed=-4112]="wasmJsSaveTiffFailed";}(A||(A={})),function(t){t[t.IT_DIB=-1]="IT_DIB",t[t.IT_RGBA=-2]="IT_RGBA",t[t.IT_BGRA=-3]="IT_BGRA",t[t.IT_BMP=0]="IT_BMP",t[t.IT_JPG=1]="IT_JPG",t[t.IT_PNG=3]="IT_PNG",t[t.IT_ALL=5]="IT_ALL";}(k||(k={})),function(t){t[t.RT_AUTO=-1]="RT_AUTO",t[t.RT_BINARY=1]="RT_BINARY",t[t.RT_BASE64=2]="RT_BASE64";}(D||(D={})),function(t){t[t.SF_DEF=0]="SF_DEF",t[t.SF_ENABLE=1]="SF_ENABLE",t[t.SF_DISABLE=2]="SF_DISABLE";}(R||(R={})),function(t){t.imgIOVer="3.2.0",t.imgProcVer="3.2.0";}(st||(st={}));class bi{static setLogFunc(t,e,i){x(this,E,t,"f",M),x(this,E,e,"f",I),x(this,E,i,"f",B);}static get level(){return y(this,E,"f",M)}static get func(){return y(this,E,"f",I)}static get context(){return y(this,E,"f",B)}static logAll(t){this.log(w.logAll,t);}static logD(t){this.log(w.logDebug,t);}static log(t,e){y(this,E,"f",I)&&y(this,E,"f",M)===t&&y(this,E,"f",I).call(this,e,y(this,E,"f",B));}}E=bi,M={value:""},I={value:void 0},B={value:null};class Si{static unload(){x(this,U,"","f",L),x(this,U,"","f",N),x(this,U,null,"f",_),x(this,U,{name:w.imgIO,instanceName:b.imgCore,workerName:S.core,autoLoad:!1,ver:st.imgIOVer,prefixName:Si.ImageIOPrefixName,useSimd:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli},"f",tt),x(this,U,{name:w.imgProc,instanceName:b.imgProc,workerName:S.proc,autoLoad:!1,ver:st.imgProcVer,prefixName:Si.ImageProcPrefixName,useSimd:Si.UseSimd,useBrotli:Si.UseBrotli},"f",et),bi.setLogFunc("",void 0,null);}static get UseSimd(){return y(this,U,"f",F)}static set UseSimd(t){x(this,U,t,"f",F);}static get UseBrotli(){return y(this,U,"f",H)}static set UseBrotli(t){x(this,U,t,"f",H);}static get License(){return y(this,U,"f",L)}static set License(t){x(this,U,t,"f",L);}static get LicMode(){return y(this,U,"f",O)}static set LicMode(t){x(this,U,t,"f",O);}static get UUID(){return y(this,U,"f",N)}static set UUID(t){x(this,U,t,"f",N);}static get NavInfo(){return y(this,U,"f",_)}static set NavInfo(t){x(this,U,t,"f",_);}static get Mobile(){return y(this,U,"f",W)}static set Mobile(t){x(this,U,t,"f",W);}static get DefHeapSize(){return y(this,U,"f",V)}static set DefHeapSize(t){x(this,U,t,"f",V);}static get MaxHeapSize(){return y(this,U,"f",z)}static get HeapConfig(){return y(this,U,"m",j).call(this),Object.assign({},y(this,U,"f",$))}static getWorkerHeap(t){return void 0!==y(this,U,"f",$)[t]?y(this,U,"f",$)[t]:{maxHeapSize:y(this,U,"f",z),initHeapSize:y(this,U,"f",V)}}static UpdateHeapConfig(t,e,i){y(this,U,"m",j).call(this),e&&void 0!==y(this,U,"f",$)[t]&&(y(this,U,"f",$)[t].maxHeapSize=e),i&&void 0!==y(this,U,"f",$)[t]&&(y(this,U,"f",$)[t].initHeapSize=i);}static get FileReadModeSize(){return y(this,U,"f",X)}static set FileReadModeSize(t){x(this,U,t,"f",X);}static get FontUseFileReadMode(){return {load:y(this,U,"f",G),save:y(this,U,"f",Y)}}static set FontUseFileReadMode(t){"boolean"==typeof t.load&&x(this,U,t.load,"f",G),"boolean"==typeof t.save&&x(this,U,t.save,"f",Y);}static get ImageIOWorkerJS(){return "ddv-imageio.worker.js?v="+st.imgIOVer}static get ImageProcWorkerJS(){return "ddv-imageproc.worker.js?v="+st.imgProcVer}static get ImageProcSimdWorkerJS(){return "ddv-imageproc-simd.worker.js?v="+st.imgProcVer}static get ImageIOPrefixName(){return "ddv-imageio"}static get ImageProcPrefixName(){return "ddv-imageproc"}static get ImageIOResource(){return y(this,U,"f",Z)}static set ImageIOResource(t){x(this,U,y(this,U,"m",q).call(this,t),"f",Z),y(this,U,"m",K).call(this,y(this,U,"f",Z),y(this,U,"f",tt)),y(this,U,"m",K).call(this,y(this,U,"f",Z),y(this,U,"f",et));}static get ImageProcResource(){return y(this,U,"f",Q)}static set ImageProcResource(t){t.useFastCompEdition=!1,x(this,U,y(this,U,"m",q).call(this,t),"f",Q),y(this,U,"m",K).call(this,y(this,U,"f",Q),y(this,U,"f",et));}static get ImageIOModule(){return y(this,U,"f",tt)}static get ImageReadereModule(){const t=Object.assign({},y(this,U,"f",tt));return t.workerName=S.reader,t}static get PdfReaderModule(){const t=Object.assign({},y(this,U,"f",tt));return t.workerName=S.reader,t.singleInstance=!0,t.instanceName=b.pdfCore,t}static get PdfWriterModule(){const t=Object.assign({},y(this,U,"f",tt));return t.singleInstance=!0,t.instanceName=b.pdfCore,t}static get ImageProcModule(){return y(this,U,"f",et)}static get DetectorModule(){return x(this,U,Object.assign({},y(this,U,"f",et)),"f",it),y(this,U,"f",it).workerName=S.detector,y(this,U,"f",it)}static setLogFunc(t,e,i){bi.setLogFunc(t,e,i);}static hasLogFunc(){return void 0!==bi.func}}U=Si,j=function(){0===Object.keys(y(this,U,"f",$)).length&&(y(this,U,"f",$)[S.core]={},y(this,U,"f",$)[S.core].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.core].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.reader]={},y(this,U,"f",$)[S.reader].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.reader].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.detector]={},y(this,U,"f",$)[S.detector].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.detector].initHeapSize=y(this,U,"f",V),y(this,U,"f",$)[S.proc]={},y(this,U,"f",$)[S.proc].maxHeapSize=y(this,U,"f",z),y(this,U,"f",$)[S.proc].initHeapSize=y(this,U,"f",V));},q=function(t){var e,i,s,n;let o={crossScript:!1,resourceDir:t.resourceDir,workerScript:t.workerScript,useFastCompEdition:null!==(e=t.useFastCompEdition)&&void 0!==e&&e,useSimd:null!==(i=t.useSimd)&&void 0!==i?i:y(this,U,"f",F),fetchOptions:null!==(s=t.fetchOptions)&&void 0!==s?s:y(this,U,"f",J),useBrotli:null!==(n=t.useBrotli)&&void 0!==n?n:y(this,U,"f",H)};return o.workerScript=t.resourceDir+t.workerScript,o.workerScript.startsWith("http://")||o.workerScript.startsWith("https://")||o.workerScript.includes("://")?(o.resourceDir=t.resourceDir,o.workerScript.startsWith(location.origin)||(o.crossScript=!0)):t.resourceDir.startsWith("/")?null!=location.origin&&(o.resourceDir=location.origin+t.resourceDir):null!=location.href&&(o.resourceDir=location.href.substring(0,location.href.replace(/[?#].*/,"").lastIndexOf("/")+1)+t.resourceDir),o.resourceDir.endsWith("/")||(o.resourceDir+="/"),t.useFastCompEdition&&(o.resourceDir+="fastcomp/",o.workerScript=o.resourceDir+t.workerScript),o},K=function(t,e){e.resourceDir=t.resourceDir,e.crossScript=t.crossScript,e.name===w.imgProc?e.useSimd=t.useSimd:e.useSimd=!1,e.script=t.workerScript,e.fetchOptions=t.fetchOptions,e.useBrotli=t.useBrotli;},L={value:""},O={value:T.LONG_KEY},N={value:""},_={value:null},W={value:!1},F={value:!1},H={value:!1},V={value:32},z={value:200},$={value:Object.create(null)},X={value:20},G={value:!0},Y={value:!1},J={value:{mode:"cors",credentials:"same-origin",retries:3,retryDelay:500}},Z={value:{resourceDir:"",workerScript:Si.ImageIOWorkerJS,useFastCompEdition:!1,useSimd:!1,crossScript:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},Q={value:{resourceDir:"",workerScript:Si.ImageIOWorkerJS,useFastCompEdition:!1,useSimd:!1,crossScript:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},tt={value:{name:w.imgIO,instanceName:b.imgCore,workerName:S.core,autoLoad:!1,ver:st.imgIOVer,prefixName:Si.ImageIOPrefixName,useSimd:!1,fetchOptions:y(Si,U,"f",J),useBrotli:Si.UseBrotli}},et={value:{name:w.imgProc,instanceName:b.imgProc,workerName:S.proc,autoLoad:!1,ver:st.imgProcVer,prefixName:Si.ImageProcPrefixName,useSimd:Si.UseSimd,useBrotli:Si.UseBrotli}},it={value:void 0};class Ci{static read(t){return new Promise((function(e,i){let s=Object.prototype.toString.call(t);if("[object String]"===s){if(0===t.indexOf("blob:")||t.indexOf(".jpg")>0||t.indexOf(".jpeg")>0||t.indexOf(".png")>0||t.indexOf(".bmp")>0||t.indexOf(".dib")>0||t.indexOf(".pdf")>0||t.indexOf(".tiff")>0||t.indexOf(".tif")>0)return fetch(t,{mode:"cors"}).then((function(t){return t.arrayBuffer()})).then((function(t){return e(t)})).catch((function(t){return Promise.reject(t)}));i("Error url: Can not read the file URL");}else if("[object Blob]"===s||"[object FileList]"===s||"[object File]"===s){let n=t;"[object FileList]"!==s&&"[object File]"!==s||(n=t[0]?t[0]:t),y(Ci,nt,"m",ot).call(Ci,n,e,i);}else "[object ArrayBuffer]"===s||"[object Uint8ClampedArray]"===s?e(t):i("Not support source type: "+s);}))}}nt=Ci,ot=function(t,e,i){let s,n,o=0;try{s=new ArrayBuffer(t.size),n=new Uint8Array(s);}catch(t){i(t);}!function r(){const a=new FileReader;a.onload=function(a){var l;if(null===(l=null==a?void 0:a.target)||void 0===l?void 0:l.result){const i=a.target.result;n.set(new Uint8Array(i),o),o+=i.byteLength,o<t.size?r():e(s);}else i(a);},a.onerror=function(t){i(t);},a.onabort=function(t){i(t);};const l=Math.min(o+1048576,t.size),h=t.slice(o,l);a.readAsArrayBuffer(h);}();};class Pi{static fetchRetry(t,e,i,s){let n=e.retries,o=e.retryDelay;return new Promise((function(r,a){const l=function(h){return fetch(t,e).then((function(t){r(t);})).catch((function(t){h<n?function(t,e,n){i&&i(e,s),setTimeout((function(){l(++t);}),o);}(h,t):a(t);}))};return l(0)}))}}class Ti{constructor(t,e,i,s,n,o){rt.add(this),at.set(this,void 0),lt.set(this,void 0),ht.set(this,void 0),ct.set(this,void 0),dt.set(this,void 0),ut.set(this,void 0),pt.set(this,void 0),gt.set(this,void 0),ft.set(this,void 0),vt.set(this,void 0),mt.set(this,void 0),yt.set(this,void 0),xt.set(this,void 0),wt.set(this,0),bt.set(this,{}),St.set(this,null),x(this,at,t,"f"),x(this,ft,s,"f"),x(this,xt,i,"f"),x(this,ht,[],"f"),x(this,ct,!1,"f"),x(this,dt,!1,"f"),x(this,wt,e,"f"),x(this,St,Object.create(null),"f"),y(this,bt,"f").modulesInfo=[],x(this,mt,Object.create(null),"f"),x(this,gt,null,"f"),x(this,vt,0,"f"),x(this,yt,0,"f"),x(this,lt,y(this,rt,"m",Pt).call(this,y(this,at,"f")),"f"),y(this,lt,"f").on("message",y(this,rt,"m",At),this),y(this,lt,"f").on("error",y(this,rt,"m",Tt),this),y(this,lt,"f").on("exit",(function(e,i,s){let n="Worker #terminated Unexpectedly\n";n+=" exitCode: `"+e+"`\n",n+=" signalCode: `"+i+"`\n",n+=" #script: `"+t+"`\n",y(s,rt,"m",Tt).call(s,new Error(n),s);}),this);}get WorkerScript(){return y(this,ft,"f")}get id(){return y(this,wt,"f")}get Module(){return y(this,bt,"f")}get Instances(){return y(this,St,"f")}get WorkerName(){return y(this,xt,"f")}execTask(t,e,i){i||((i={}).promise=new Promise((function(t,e){i.resolve=t,i.reject=e;})));let s=x(this,yt,+y(this,yt,"f")+1,"f");y(this,mt,"f")[s]={id:s,insId:e.insId,resolver:i,cost:e.cost},delete e.cost;let n={id:s,func:t,params:e};return bi.logD("["+e.insId+"] "+t+" send"),y(this,dt,"f")?i.reject(new Error("Worker is #terminated")):y(this,ct,"f")?i.reject(new Error("Worker is #terminating")):y(this,lt,"f").wasmReady||y(this,lt,"f").ready&&"loadWasm"===t?y(this,lt,"f").send(n):y(this,ht,"f").push(n),i.promise}get memSize(){return y(this,vt,"f")}get busy(){return this.howManyTasks>0}get howManyTasks(){return Object.keys(y(this,mt,"f")).length}get alive(){return !y(this,ct,"f")&&!y(this,dt,"f")}terminate(t,e){if(bi.logD("["+this.id+"] worker terminate "+t),t&&y(this,rt,"m",Dt).call(this,"Worker has been #terminated"),"function"==typeof e&&x(this,gt,e,"f"),this.busy)x(this,ct,!0,"f");else {if(y(this,lt,"f")){if("function"!=typeof y(this,lt,"f").terminate)throw new Error("Failed to terminate worker");bi.logD("["+this.id+"] will be terminated"),y(this,lt,"f").terminate(),x(this,lt,null,"f");}x(this,ct,!1,"f"),x(this,dt,!0,"f"),y(this,gt,"f")&&y(this,gt,"f").call(this,this);}}hasInstance(t){if(t){const e=y(this,St,"f")[t];if(e)return 0!=Object.keys(e).length}else {const t=Object.keys(y(this,St,"f"));for(const e of t)if(0!=Object.keys(y(this,St,"f")[e]).length)return !0}return !1}exceedMaxMemory(){const t=1024*Si.getWorkerHeap(this.WorkerName).maxHeapSize*1024;return !!(y(this,vt,"f")&&y(this,vt,"f")>t&&0!=t)&&(bi.logD("[w-"+this.id+"] current memSize="+y(this,vt,"f")+", max="+t),!0)}shouldBeFreed(){return !(!this.exceedMaxMemory()||this.hasInstance(void 0)||(bi.logD("[w-"+this.id+"] try to terminate the worker"),this.terminate(),0))}}at=new WeakMap,lt=new WeakMap,ht=new WeakMap,ct=new WeakMap,dt=new WeakMap,ut=new WeakMap,pt=new WeakMap,gt=new WeakMap,ft=new WeakMap,vt=new WeakMap,mt=new WeakMap,yt=new WeakMap,xt=new WeakMap,wt=new WeakMap,bt=new WeakMap,St=new WeakMap,rt=new WeakSet,Ct=function(t){let e=new Error(""),i=Object.keys(t);for(let s=0;s<i.length;s++)e[i[s]]=t[i[s]];return e},Pt=function(t){if("function"!=typeof Worker&&"object"!=typeof Worker)throw new Error("Web Workers not supported");let e=new Worker(t,{name:this.WorkerName});return e.on=function(t,e,i){this.addEventListener(t,(function(s){"exit"===t?e(s.data,"",i):e(s.data,i);}));},e.send=function(t){if(null!=t&&null!=t.params&&null!=t.params.input){let e=Object.prototype.toString.call(t.params.input);if("[object Array]"===Object.prototype.toString.call(t.params.input)){if(e=Object.prototype.toString.call(t.params.input[0]),"[object ArrayBuffer]"===e||"[object Uint8ClampedArray]"===e||"[object Uint8Array]"===e)return void this.postMessage(t,[null!=t.params.input[0].buffer?t.params.input[0].buffer:t.params.input[0]])}else if("[object ArrayBuffer]"===e||"[object Uint8ClampedArray]"===e||"[object Uint8Array]"===e)return void this.postMessage(t,[null!=t.params.input.buffer?t.params.input.buffer:t.params.input])}this.postMessage(t);},e},Tt=function(t,e){x(e,dt,!0,"f"),bi.logD("[js]["+e.id+"] worker error "+JSON.stringify(t)),y(e,ct,"f")&&y(e,gt,"f")&&y(e,gt,"f").call(e,e),x(e,ct,!1,"f"),y(e,rt,"m",Dt).call(e);},At=function(t,e){let i=t.id,s=y(e,mt,"f")[i];if(t&&t.cost&&s&&s.cost){const e=s.cost;e.exec=t.cost;const i=Date.now();e.total=i-e.ctime,e.msgQueue=t.ctime-e.time;const n=i-t.time;delete e.time,delete e.ctime,t.cost=e,t.cost.receive=n,delete t.ctime,delete t.time;}if(bi.logD(t.log?t.log:t),"string"==typeof t&&"ready"===t)y(e,lt,"f").ready=!0,setTimeout((()=>{y(e,rt,"m",kt).call(e);}),0);else if(!t.log){if("object"==typeof t){let i=t.result;"object"==typeof i?(null!=i.errorCode&&(i.code=i.errorCode,delete i.errorCode),null!=i.errorMessage&&(i.message=i.errorMessage,delete i.errorMessage)):"string"==typeof i&&(i=i.replace('"errorCode"','"code"'),i=i.replace("'errorCode'","'code'"),i=i.replace('"errorMessage"','"message"'),i=i.replace("'errorMessage'","'message'"),t.result=i),null!=t.memSize&&x(e,vt,t.memSize,"f");}if(void 0!==s){const n=s.insId;delete y(e,mt,"f")[i],bi.logD("["+n+"] "+t.func+" received"),!0===y(e,ct,"f")&&e.terminate(),"loadWasm"===t.func&&null!=t.result&&(y(e,lt,"f").wasmReady=!0,setTimeout((()=>{y(e,rt,"m",kt).call(e);}),0)),t.error?s.resolver.reject(y(e,rt,"m",Ct).call(e,t.error)):t.result&&s.resolver.resolve(t.result);}}},kt=function(){this.alive&&(y(this,ht,"f").forEach(y(this,lt,"f").send.bind(y(this,lt,"f"))),x(this,ht,[],"f"));},Dt=function(t){for(let e in y(this,mt,"f"))void 0!==y(this,mt,"f")[e]&&y(this,mt,"f")[e].resolver.reject(new Error(t));x(this,mt,Object.create(null),"f");};class Ai{constructor(){Rt.add(this),It.set(this,[]),Bt.set(this,4),Ut.set(this,60),Lt.set(this,!1),Ot.set(this,0),_t.set(this,!1);}static get Instance(){return y(this,Et,"f",Mt)||x(this,Et,new Ai,"f",Mt),y(this,Et,"f",Mt)}get Terminated(){return y(this,Lt,"f")}getModuleLoadedError(t){for(let e of y(Ai,Et,"f",Nt))if(e.name==t)return e.error}getModuleStatus(t){for(let e of y(Ai,Et,"f",Nt))if(e.name==t)return e.status;return ""}addModules(t,e){let i=!1;if(y(Ai,Et,"f",Nt).forEach((function(e,s,n){e.name==t.name&&(e.ver==t.ver?i=!0:n.splice(s,1));})),!i){let i=t;i.status=e||"",i.wasmModule=null,y(Ai,Et,"f",Nt).push(i);}}loadModule(t,e){return m(this,void 0,void 0,(function*(){let i,s;null==e&&(e=0!=y(this,Rt,"m",Xt).call(this,t).length),this.addModules(t);for(let n of y(Ai,Et,"f",Nt))if(n.name===t.name){if(n.status===C.pending)return !1;if(n.wasmModule){if(e)return !0;i=n.wasmModule,s=n.wasmBinary;break}break}let n=null;if(i)n=t,n.wasmModule=i,n.wasmBinary=s,n.status=C.pending;else if(n=t,""===n.status)n.status=C.pending,n.wasmModule=null;else {if(n.status===C.pending)return !1;e||(n.error={code:0,message:""},n.status=C.pending);}return y(this,Rt,"m",Wt).call(this,n)}))}get busy(){y(this,Rt,"m",Jt).call(this);let t=y(this,It,"f");for(let e of t)if(e.busy)return !0;return !1}getWorker(t,e){return m(this,void 0,void 0,(function*(){if(y(this,Rt,"m",Gt).call(this,t.name))return y(this,Rt,"m",qt).call(this),{worker:null,workers:0};let i=y(this,Rt,"m",Xt).call(this,t,!0);return 0!=i.length?{worker:y(this,Rt,"m",Zt).call(this,i,e,t),workers:i.length}:(yield this.loadModule(t,!1),{worker:null,workers:0})}))}removeInstanceInWorker(t,e,i,s){if(y(this,Rt,"m",Qt).call(this,e,t.instanceName,i),s&&e&&e.shouldBeFreed()){let t=y(this,It,"f").indexOf(e);-1!==t&&y(this,It,"f").splice(t,1);}}terminate(t){x(Ai,Et,null,"f",Mt),bi.logD("worker pool terminate "+t),x(this,Lt,!0,"f");let e=[];return y(this,It,"f").splice(0).forEach((function(i){let s={};s.promise=new Promise((function(t,e){s.resolve=t,s.reject=e;})),e.push(s.promise),i.terminate(t,(function(t){s.resolve(t);}));})),Promise.all(e)}static unload(){x(Ai,Et,new Array,"f",Nt);}terminateWorker(t){y(this,It,"f").splice(0,y(this,It,"f").length,...y(this,It,"f").filter((e=>e.WorkerName!==t||(e.terminate(!0),!1))));}getMemoryUsed(){let t=y(this,It,"f"),e=[],i=0;for(let s of t)s&&null!=s.memSize&&(e[i]={},e[i].size=s.memSize,e[i].limit=1024*Si.getWorkerHeap(s.WorkerName).maxHeapSize*1024,e[i].name=s.WorkerName,e[i].id=s.id,i+=1);return e}}Et=Ai,It=new WeakMap,Bt=new WeakMap,Ut=new WeakMap,Lt=new WeakMap,Ot=new WeakMap,_t=new WeakMap,Rt=new WeakSet,Wt=function(t){return m(this,void 0,void 0,(function*(){let e=this,i=yield y(this,Rt,"m",$t).call(this,t);if(i){let s={id:0,func:"loadWasm",params:{insId:0,priority:0,module:{modulesInfo:[]},fetchOptions:t.fetchOptions}};s.params.resourceDir=t.resourceDir,s.params.initMemory=Si.getWorkerHeap(t.workerName).initHeapSize,s.params.module&&s.params.module.modulesInfo.push(t),yield y(this,Rt,"m",Ht).call(this,i,s),x(e,Bt,y(e,Rt,"m",zt).call(e),"f"),t.status===C.pending&&(t.status="");}else t.status="",t.wasmModule=null;}))},Ft=function(t,e,i,s){for(let n of y(Ai,Et,"f",Nt))if(n.name===t){n.status=e,n.wasmModule=i.wasmModule,n.wasmBinary=i.wasmBinary,n.error=s;break}},Ht=function(t,e,i){return m(this,void 0,void 0,(function*(){let s=this;try{const i=yield t.execTask(e.func,e.params);let n=!1;return void 0===i.code||i.modules?n=y(s,Rt,"m",Vt).call(s,i,t):bi.logD(i),n}catch(s){return bi.logD(s),!1}finally{i&&i();}}))},Vt=function(t,e){if(bi.logD("handleWasmLoad:"),bi.logD(t),y(this,Lt,"f"))return e.terminate(),!1;if(("object"!=typeof t||null==t.modules)&&"object"==typeof t)return !1;let i=!1;for(const s of t.modules)t.code?(y(this,Rt,"m",Ft).call(this,s.name,C.failed,null,{code:t.code,message:t.message}),e.Module.modulesInfo[s.name]=!1):(y(this,Rt,"m",Ft).call(this,s.name,C.ready,s.wasmResource,void 0),e.Module.modulesInfo[s.name]=!0,i=!0);return i},zt=function(){let t=2;return "hardwareConcurrency"in self.navigator&&(t=self.navigator.hardwareConcurrency),Math.max(Math.min(y(this,Bt,"f"),Math.max(y(this,Bt,"f"),t/2)),1)},$t=function(t){return m(this,void 0,void 0,(function*(){y(this,Rt,"m",Jt).call(this);let e=y(this,It,"f");for(let i of e)if(i.WorkerName===t.workerName)return i.busy?null:i;return y(this,Rt,"m",jt).call(this,t)}))},jt=function(t){var e;return m(this,void 0,void 0,(function*(){let i=this,s=y(i,It,"f");if(s.length<y(i,Bt,"f")&&!y(i,_t,"f")){x(i,_t,!0,"f");let n=t.script;t.crossScript&&(n=yield Pi.fetchRetry(t.script,t.fetchOptions,bi.func,i).then((t=>t.blob())).then((t=>URL.createObjectURL(t))).catch((t=>(bi.logD("get new worker fetch failed: "),bi.logD(t),x(i,_t,!1,"f"),null))));let o=new Ti(n,x(e=i,Ot,+y(e,Ot,"f")+1,"f"),t.workerName,t.script,bi.func,bi.context);return s.push(o),x(i,_t,!1,"f"),bi.logAll(s),bi.logD("[wl-"+y(i,It,"f").length+"] got new worker w-"+o.id+"("+o.WorkerName+") succeed!"),o}return null}))},Xt=function(t,e){y(this,Rt,"m",Jt).call(this);let i=y(this,It,"f");bi.logAll(i);let s=[];for(let n of i)if(n.Module.modulesInfo[t.name]){if(e&&n.WorkerName!==t.workerName)continue;s.push(n);}return bi.logAll("[wl-"+i.length+"] got workers for module "+t.name),bi.logAll(s),s},Gt=function(t){for(let e of y(Ai,Et,"f",Nt))if(e.name===t&&e.status===C.pending)return !0;return !1},Yt=function(){return m(this,void 0,void 0,(function*(){this.terminate(!0);for(let t of y(Ai,Et,"f",Nt))yield y(this,Rt,"m",Wt).call(this,t);}))},qt=function(){y(this,Rt,"m",Jt).call(this),0==y(this,It,"f").length&&0!=y(Ai,Et,"f",Nt).length&&(bi.logD("no worker ready, reinit"),y(this,Rt,"m",Yt).call(this));},Jt=function(){y(this,It,"f").splice(0,y(this,It,"f").length,...y(this,It,"f").filter((function(t){return t.alive})));},Zt=function(t,e,i){bi.logAll("[wl-"+y(this,It,"f").length+"] getWorkerByIntanceId"),bi.logAll(t);let s,n=9007199254740991;for(let o of t){if(i.singleInstance&&o.hasInstance(i.instanceName)&&!o.Instances[i.instanceName][e])continue;const t=o.Instances[i.instanceName];if(!t||void 0!==t[e]){s=o;break}{let t=o.howManyTasks;t<n&&(s=o,n=t);}}if(s){if(s.shouldBeFreed())return null;const n=s.Instances[i.instanceName];if(n)n[e]="";else {const t=Object.create(null);t[e]="",s.Instances[i.instanceName]=t;}return bi.logAll(t),bi.logD("[wl-"+t.length+"]["+e+"] got worker w-"+s.id),s}return bi.logAll("#getWorkerByIntanceId: no suitable worker"),null},Qt=function(t,e,i){let s=y(this,It,"f");bi.logAll("removeInstanceInWorkerInner"),bi.logAll(s);for(let n of s)if(n===t){const o=n.Instances[e];if(o){if(null!=o[i]){delete o[i],bi.logAll(s),bi.logD("[w-"+n.id+"] removeInstanceInWorkerInner "+i+" in "+t.id+" succeed!");break}bi.logD("[w-"+n.id+"] not found instance "+i);}}},Mt={value:null},Nt={value:new Array};class ki{static buildWasmFileName(t,e,i,s,n){return t+(s?"-simd":"")+i+"?v="+e}static base64DecToArr(t,e){let i=t.replace(/[^A-Za-z0-9\+\/]/g,""),s=i.length,n=e?Math.ceil((3*s+1>>>2)/e)*e:3*s+1>>>2,o=new Uint8Array(n);for(let t,e,r=0,a=0,l=0;l<s;l++)if(e=3&l,r|=y(this,Kt,"m",te).call(this,i.charCodeAt(l))<<18-6*e,3===e||s-l==1){for(t=0;t<3&&a<n;t++,a++)o[a]=r>>>(16>>>t&24)&255;r=0;}return o}static isWasmSupport(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return !1}static random(){return (Date.now()%10086).toString(36).slice(2)+Math.random().toString(36).slice(2)}static newBlobInChunks(t,e,i){var s;let n;const o=i||t.byteLength,r=8388608,a=[];for(let e=0;e<o;e+=r)a.push(new Blob([new Uint8Array(null!==(s=t.buffer)&&void 0!==s?s:t,e,Math.min(o-e,r))]));return n=null!=e?new Blob(a,{type:e}):new Blob(a),n}}Kt=ki,te=function(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:43===t?62:47===t?63:0};class Di{constructor(t,e){var i,s,n,o;ee.add(this),ne.set(this,void 0),this._outputType=k.IT_JPG,this._inputType=k.IT_ALL,this._jpegQuality=80,oe.set(this,null!==(i=Si.License)&&void 0!==i?i:""),re.set(this,[]),ae.set(this,null),le.set(this,0),he.set(this,x(o=Di,ie,+y(o,ie,"f",se)+1,"f",se)),ce.set(this,null),de.set(this,JSON.parse(JSON.stringify(Si.NavInfo))),ue.set(this,Si.Mobile),pe.set(this,location.origin),ge.set(this,""),fe.set(this,C.init),ve.set(this,!1),me.set(this,null!==(s=Si.LicMode)&&void 0!==s?s:T.LONG_KEY),ye.set(this,null!==(n=Si.UUID)&&void 0!==n?n:""),xe.set(this,0),we.set(this,!1),be.set(this,!1),this._handleBooleanResult=function(t,e){return !0},x(this,ne,t,"f"),x(this,oe,null!=e?e:Si.License,"f");}_prepareModule(t){}get workerId(){return y(this,ae,"f")&&y(this,ae,"f").alive?y(this,ae,"f").id:0}get id(){return y(this,he,"f")}hasTask(){return y(this,re,"f").length>0}_canTerminateWork(){return !1}_makeSureWorkerMemoryNotExceed(){return !(y(this,ae,"f")&&y(this,ae,"f").alive&&this._canTerminateWork()&&y(this,ae,"f").exceedMaxMemory()&&(bi.logD(`[${this.id}] try to termiate worker [${y(this,ae,"f").id}]`),y(this,ae,"f").terminate(!0),x(this,ae,null,"f"),x(this,fe,C.init,"f"),1))}_makeSureWorkerChanged(){return !!(y(this,ae,"f")&&y(this,ae,"f").alive&&this._canTerminateWork())&&(bi.logD(`[${this.id}] try to termiate worker [${y(this,ae,"f").id}]`),y(this,ae,"f").terminate(!0),x(this,ae,null,"f"),x(this,fe,C.init,"f"),!0)}_workerChanged(t){}_handleBasicResult(t,e){return delete t.code,delete t.message,t}_handleImageData(t,e){var i,s,n;if("object"==typeof t.imageData)if(null!=t.imageCount&&t.imageCount>1)for(let s=0;s<t.imageCount;s++)t.imageData[s]=y(i=e.context,ee,"m",Pe).call(i,t.imageData[s],t.blobType,e.params.returnBlob,t.imageDataSize);else t.imageData=y(s=e.context,ee,"m",Pe).call(s,t.imageData,t.blobType,e.params.returnBlob,t.imageDataSize);return "object"==typeof t.pdfData&&(t.pdfData=y(n=e.context,ee,"m",Pe).call(n,t.pdfData,t.blobType,e.params.returnBlob,t.pdfDataSize)),t}_handleResult(t,e){var i,s;let n=y(s=e.context,ee,"m",Te).call(s,t);if(void 0===n.code||!n.code&&"Successful."===n.message)n=e.handleResult(n,e),setTimeout((()=>{var t;y(t=e.context,ee,"m",Ce).call(t);}),0),(0, e.resolve)(n);else {let t={code:n.code,message:n.code===A.wasmException?P.WASM_EXCEPTION_ERROR+"("+(null===(i=e.params)||void 0===i?void 0:i.moduleName)+":"+e.func+":"+n.message+")":n.message};e.context.terminated?e.resolve(t):e.reject(t);}}_execTask(t){let e=this,i=y(e,ae,"f");if(bi.logAll(t),i)try{if(t.params.cost){const e=t.params.cost.time;t.params.cost.time=Date.now(),t.params.cost.taskQueue=t.params.cost.time-e;}i.execTask(t.func,t.params).then((function(i){e._handleResult(y(e,ee,"m",Te).call(e,i),t);})).catch((function(i){bi.logD(i),setTimeout((()=>{y(e,ee,"m",Ce).call(e);}),0);let s=i;"object"==typeof i&&null!=i.message&&(s=i.message);let n={code:A.wasmJsWorkerRunFailed,message:s};y(e,ve,"f")?t.resolve(n):t.reject(n);}));}catch(i){setTimeout((()=>{y(e,ee,"m",Ce).call(e);}),0),bi.logD(i);let s={code:A.wasmJsWorkerRunException,message:i.message,stack:i.stack};y(e,ve,"f")?t.resolve(s):t.reject(s);}}_cancelAllTasks(t,e){for(let i of y(this,re,"f"))if(void 0!==i){let s={code:t,message:e};y(this,ve,"f")?i.resolve(s):i.reject(s);}x(this,re,[],"f");}_createTask(t,e,i){let s={moduleName:y(this,ne,"f").instanceName,insId:y(this,he,"f")},n={id:x(this,le,+y(this,le,"f")+1,"f"),func:t,params:s};return n.promise=new Promise((function(t,e){n.resolve=t,n.reject=e;})),n.func=t,n.context=this,n.handleResult=void 0!==i&&i?i:this._handleBasicResult,n.params.input=void 0!==e&&e?e:"",n.params.returnType=D.RT_AUTO,n.params.returnBlob=!0,n.params.logLevel=bi.level,n.params.cost={},n.params.cost.ctime=Date.now(),n.params.cost.time=n.params.cost.ctime,n}_addTask(t,e){if(t.params.cost){const e=t.params.cost.time;t.params.cost.time=Date.now(),t.params.cost.create=t.params.cost.time-e;}return y(this,fe,"f")===C.destroyed?t.reject({code:A.wasmJsObjectNotInit,message:y(this,ve,"f")?"object has been disposed":"object not init"}):y(this,fe,"f")===C.failed?t.reject({code:A.wasmJsObjectInitFailed,message:y(this,ge,"f")}):(e?y(this,re,"f").unshift(t):y(this,re,"f").push(t),y(this,ee,"m",Ce).call(this)),t.promise}terminate(t){let e=this;y(e,we,"f")?x(e,ve,!0,"f"):(x(this,be,!0,"f"),y(e,ee,"m",ke).call(e).then((function(t){bi.logD("["+e.id+"] "+y(e,ne,"f").name+" destroy return: "),bi.logD(t);})).catch((function(t){bi.logD(y(e,ne,"f").name+" destroy failed"),bi.logD(t);})).finally((()=>{Ai.Instance&&Ai.Instance.removeInstanceInWorker(y(e,ne,"f"),y(e,ae,"f"),y(e,he,"f"),null==t||t),x(e,ae,null,"f"),x(e,ve,!0,"f"),x(e,be,!1,"f");}))),x(e,fe,"","f");}_readFile(t){return Ci.read(t).catch((function(t){let e=t;return "object"!=typeof e&&(e={},e.code=A.wasmJsReadFileFailed,e.message=t),Promise.reject(e)}))}updateLicense(t,e,i){return m(this,void 0,void 0,(function*(){x(this,oe,t,"f"),x(this,me,null!=e?e:T.LONG_KEY,"f"),x(this,ye,null!=i?i:"","f");let s=this,n=s._createTask("UpdateLicense");return n.params.input=[y(s,oe,"f"),y(s,me,"f"),y(s,ye,"f")],s._addTask(n),n.promise}))}}ie=Di,ne=new WeakMap,oe=new WeakMap,re=new WeakMap,ae=new WeakMap,le=new WeakMap,he=new WeakMap,ce=new WeakMap,de=new WeakMap,ue=new WeakMap,pe=new WeakMap,ge=new WeakMap,fe=new WeakMap,ve=new WeakMap,me=new WeakMap,ye=new WeakMap,xe=new WeakMap,we=new WeakMap,be=new WeakMap,ee=new WeakSet,Se=function t(e){let i=null!=e?e:this;return y(i,ce,"f")&&clearTimeout(y(i,ce,"f")),y(i,ve,"f")?(bi.logD(`[${i.id}] has been termiated.(getWorker)`),i._cancelAllTasks(A.wasmJsObjectTerminated,`Instance [${i.id}] has been termiated.`),y(i,ae,"f")):y(i,ae,"f")&&y(i,ae,"f").alive?y(i,ae,"f"):void(Ai.Instance?Ai.Instance.getWorker(y(i,ne,"f"),y(i,he,"f")).then((e=>{var s;if(x(i,ae,e.worker,"f"),y(i,ae,"f")&&y(i,ae,"f").alive)y(i,xe,"f")!=y(i,ae,"f").id&&(0!==y(i,xe,"f")&&i._workerChanged(y(i,ae,"f").id),x(i,xe,y(i,ae,"f").id,"f")),y(i,re,"f").length>0&&setTimeout((()=>{y(i,ee,"m",Ce).call(i);}),0);else {let e=null===(s=Ai.Instance)||void 0===s?void 0:s.getModuleLoadedError(y(i,ne,"f").name);if(null==e?void 0:e.code)return i._cancelAllTasks(A.wasmJsNotLoaded,e.message),y(i,ae,"f");y(i,re,"f").length>0&&x(i,ce,setTimeout(y(i,ee,"m",t),50,i),"f");}return y(i,ae,"f")})).catch((t=>y(i,ae,"f"))):i._cancelAllTasks(A.wasmJsNotLoaded,"wasm env not loaded or unloaded"))},Ce=function(){if(bi.logAll(y(this,re,"f")),y(this,fe,"f")!=C.init)if(y(this,ae,"f")&&y(this,ae,"f").alive){if(y(this,re,"f").length>0&&(y(this,fe,"f")===C.ready||"init"===y(this,re,"f")[0].func)){const t=y(this,re,"f").shift();this._execTask(t);}}else {if(y(this,ae,"f")&&!y(this,ae,"f").alive&&y(this,re,"f").length>0&&"init"!=y(this,re,"f")[0].func)return x(this,ae,null,"f"),void y(this,ee,"m",Ae).call(this);y(this,re,"f").length>0&&y(this,ne,"f").script&&y(this,ee,"m",Se).call(this,this);}else y(this,ee,"m",Ae).call(this);},Pe=function(t,e,i,s){return i?ki.newBlobInChunks(t,e,s):void 0===s||s===t.byteLength?t:t.slice(0,s)},Te=function(t){try{return "string"==typeof t?JSON.parse(t):t}catch(e){return t}},Ae=function(){let t=this;t._prepareModule(y(this,ne,"f"));let e=this._createTask("init");e.params.key=y(this,oe,"f"),e.params.uuid=y(this,ye,"f"),e.params.licMode=y(this,me,"f"),e.params.val={nv:y(this,de,"f"),mb:y(this,ue,"f"),dm:y(this,pe,"f")},e.handleResult=function(t,e){return x(e.context,fe,C.ready,"f"),t},x(this,fe,C.pending,"f"),this._addTask(e,!0),e.promise.then((function(e){bi.logD("["+t.id+"] "+y(t,ne,"f").name+" init return: "),bi.logD(e),x(t,we,!1,"f");})).catch((function(e){x(t,fe,C.failed,"f"),x(t,ge,e.message,"f"),bi.logD(y(t,ne,"f").name+" init failed"),bi.logD(e),t._cancelAllTasks(A.wasmJsObjectInitFailed,e.message);}));},ke=function(){if(y(this,fe,"f")==C.pending||y(this,fe,"f")==C.ready){let t=this._createTask("destroy",null,this._handleBooleanResult);return this._addTask(t),t.promise}return Promise.resolve(!0)},se={value:0};class Ri extends Di{constructor(t,e){super(t,e);}_prepareModule(t){Ai.Instance.addModules(t);}}class Ei extends Ri{constructor(t){super(Si.ImageIOModule,t),De.add(this),Re.set(this,0);}getImageFormat(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetImageFormat");const s=yield e._readFile(t);return i.params.input=s,e._addTask(i),i.promise}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("ReadImageInfo");const s=yield e._readFile(t);return i.params.input=s,e._addTask(i),i.promise}))}getMD5(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetMD5");const s=yield e._readFile(t);return i.params.input=s,i.handleResult=function(t,e){return t.MD5},e._addTask(i),i.promise}))}getLicenseInfo(){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("GetLicenseInfo"))}))}getAesResult(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:"",this._addTask(this._createTask("GetAesResult",[t]))}))}saveImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){return (n=null!=n&&n)?y(this,De,"m",Ee).call(this,t,void 0,void 0,void 0,1,void 0,void 0,e,i,s):y(this,De,"m",Ee).call(this,t,void 0,void 0,void 0,void 0,void 0,void 0,e,i,s)}))}readImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._outputType,i=null!=i?i:this._jpegQuality,s=null!=s?s:D.RT_AUTO,n=null!=n&&n;let o=this,r=o._createTask("ReadImage");const a=yield o._readFile(t);r.params.input=[a,e,i,n],r.params.returnType=s,r.params.returnBlob=s===D.RT_AUTO,r.handleResult=o._handleImageData,o._addTask(r);const l=yield r.promise;if(l.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete l.srcBuffer;}return l}))}openTiff(t,e){return m(this,void 0,void 0,(function*(){let i=this,s=i._createTask("LoadTiff");e=null!=e&&e;const n=yield i._readFile(t);s.params.input=[n,e],i._addTask(s);const o=yield s.promise;if(o.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete o.srcBuffer;}return o}))}readTiff(t,e,i,s){t=null!=t?t:0,e=null!=e?e:this._outputType,i=null!=i?i:D.RT_AUTO,s=null!=s&&s;let n=this._createTask("ReadTiffPage");return n.params.input=[t,e,s],n.params.returnType=i,n.params.returnBlob=i===D.RT_AUTO,n.handleResult=this._handleImageData,this._addTask(n)}readTiffInfos(t){let e=this._createTask("GetTiffPageInfos");return e.params.input=[t],this._addTask(e)}closeTiff(){return this._addTask(this._createTask("EndReadTiff",null,this._handleBooleanResult))}createTiff(){return this._addTask(this._createTask("NewTiff",null,this._handleBooleanResult))}appendImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._inputType,i=null!=i?i:y(this,Re,"f"),s=null!=s?s:this._jpegQuality,n=null!=n&&n;let o=this,r=o._createTask("AppendImageToTiff");const a=yield o._readFile(t);return r.params.input=[a,e,i,s,n],r.handleResult=o._handleBooleanResult,o._addTask(r),r.promise}))}addTag(t,e,i){return i=null!=i&&i,this._addTask(this._createTask("AddTagToNextPage",[t,e,i],this._handleBooleanResult))}getTiff(t){t=null!=t?t:D.RT_AUTO;let e=this._createTask("GetTiffStream");return e.handleResult=this._handleImageData,e.params.returnType=t,e.params.returnBlob=t===D.RT_AUTO,this._addTask(e)}getMemoryUsed(){return this._addTask(this._createTask("getMemoryUsed",null,(function(t,e){return t.memoryUsed})))}getWasmVersion(){return this._addTask(this._createTask("GetWasmVersion",null,(function(t,e){return t.version})))}getMultiPartFile(t,e){return this._addTask(this._createTask("ds_get_file",[t,e],(function(t,e){return t})))}}Re=new WeakMap,De=new WeakSet,Ee=function(t,e,i,s,n,o,r,a,l,h){return m(this,void 0,void 0,(function*(){let c=this;e=null!=e?e:this._inputType,i=null!=i?i:0,s=null!=s?s:0,n=null!=n?n:24,o=null!=o?o:96,r=null!=r?r:96,a=null!=a?a:this._outputType,l=null!=l?l:this._jpegQuality,h=null!=h?h:D.RT_AUTO;let d=c._createTask("SaveImage");const u=yield c._readFile(t);return d.params.input=[u,e,i,s,n,o,r,a,l],d.params.returnType=h,d.params.returnBlob=h===D.RT_AUTO,d.handleResult=c._handleImageData,c._addTask(d),d.promise}))};class Mi extends Ri{constructor(t){super(Si.ImageReadereModule,t),Me.add(this),Ie.set(this,0),Be.set(this,!1),Ue.set(this,null),Le.set(this,void 0),Oe.set(this,0),Ne.set(this,void 0),_e.set(this,void 0);}workerChanged(t){x(this,Be,!1,"f"),t&&(bi.logD("["+this.id+"] worker changed to "+t),x(this,Oe,t,"f"));}setExternalWorkerChanged(t,e){x(this,Ne,t,"f"),x(this,_e,e,"f");}_workerChanged(t){this.workerChanged(t),y(this,Ne,"f")&&y(this,Ne,"f").call(this,y(this,_e,"f"),this,t);}_canTerminateWork(){return !0}makeSureWorkerMemoryNotExceed(){this._makeSureWorkerMemoryNotExceed()||(x(this,Be,!1,"f"),y(this,Ne,"f")&&y(this,Ne,"f").call(this,y(this,_e,"f"),this));}getImageFormat(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("GetImageFormat");const s=yield e._readFile(t.fileSource);return i.params.input=s,e._addTask(i),i.promise}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("ReadImageInfo");const s=yield e._readFile(t.fileSource);return i.params.input=s,e._addTask(i),i.promise}))}readImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){e=null!=e?e:this._outputType,i=null!=i?i:this._jpegQuality,s=null!=s?s:D.RT_AUTO,n=null!=n&&n;let o=this,r=o._createTask("ReadImage");const a=yield o._readFile(t.fileSource);r.params.input=[a,e,i,n],r.params.returnType=null!=s?s:D.RT_AUTO,r.params.returnBlob=s===D.RT_AUTO,r.handleResult=o._handleImageData,o._addTask(r);const l=yield r.promise;if(l.srcBuffer){let e=Object.prototype.toString.call(t.fileSource);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete l.srcBuffer;}return l}))}openTiff(t,e){return m(this,void 0,void 0,(function*(){e=null!=e&&e;let i,s=this,n=s._createTask("LoadTiff");t!=y(this,Ue,"f")&&(t instanceof Blob?x(s,Ue,t,"f"):(i=yield s._readFile(t),x(s,Ue,ki.newBlobInChunks(i),"f"))),y(s,Ue,"f").size>1024*Si.FileReadModeSize*1024?n.params.input=[y(s,Ue,"f"),e]:(i||(i=yield s._readFile(y(s,Ue,"f"))),n.params.input=[i,e]),s._addTask(n);const o=yield n.promise;if(x(s,Be,!0,"f"),o.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete o.srcBuffer;}return x(s,Le,{pageCount:o.pageCount},"f"),o}))}readTiffPage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){yield y(this,Me,"m",We).call(this,t.fileSource),e=null!=e?e:0,i=null!=i?i:this._outputType,s=null!=s?s:D.RT_AUTO,n=null!=n&&n;let o=this._createTask("ReadTiffPage");return o.params.input=[e,i,n],o.params.returnType=null!=s?s:D.RT_AUTO,o.params.returnBlob=s===D.RT_AUTO,o.handleResult=this._handleImageData,this._addTask(o)}))}getTiffInfo(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,Me,"m",We).call(this,t.fileSource),y(this,Le,"f")}))}getTiffPageInfos(t,e){return m(this,void 0,void 0,(function*(){yield y(this,Me,"m",We).call(this,t.fileSource);let i=this._createTask("GetTiffPageInfos");return i.params.input=[e],this._addTask(i)}))}}Ie=new WeakMap,Be=new WeakMap,Ue=new WeakMap,Le=new WeakMap,Oe=new WeakMap,Ne=new WeakMap,_e=new WeakMap,Me=new WeakSet,We=function(t){return m(this,void 0,void 0,(function*(){if(this.makeSureWorkerMemoryNotExceed(),y(this,Be,"f")){if(y(this,Ue,"f")===t)return void bi.logD("["+this.id+"] already opened in "+this.workerId);yield y(this,Me,"m",Fe).call(this);}bi.logD("["+this.id+"] reopen in worker "+this.workerId),yield this.openTiff(t,!1);}))},Fe=function(){if(x(this,Ue,null,"f"),y(this,Be,"f"))return x(this,Be,!1,"f"),this._addTask(this._createTask("EndReadTiff",null,this._handleBooleanResult))};class Ii{static decode(t){const e={encodeChars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",decodeChars:[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1]};function i(t){let e,i,s,n,o,r,a,l=[],h=t.length;for(e=0;e<h;e++)n=t.charCodeAt(e),n>>7&255?6==(n>>5&255)?(o=t.charCodeAt(++e),i=(31&n)<<6,s=63&o,a=i|s,l.push(String.fromCharCode(a))):14==(n>>4&255)&&(o=t.charCodeAt(++e),r=t.charCodeAt(++e),i=n<<4|o>>2&15,s=(3&o)<<6|63&r,a=(255&i)<<8|s,l.push(String.fromCharCode(a))):l.push(t.charAt(e));return l.join("")}return function(t){let s,n,o,r,a=[],l=0,h=t.length;for(;l<h;){do{s=e.decodeChars[255&t.charCodeAt(l++)];}while(l<h&&-1==s);if(-1==s)break;do{n=e.decodeChars[255&t.charCodeAt(l++)];}while(l<h&&-1==n);if(-1==n)break;a.push(String.fromCharCode(s<<2|(48&n)>>4));do{if(o=255&t.charCodeAt(l++),61==o)return i(a.join(""));o=e.decodeChars[o];}while(l<h&&-1==o);if(-1==o)break;a.push(String.fromCharCode((15&n)<<4|(60&o)>>2));do{if(r=255&t.charCodeAt(l++),61==r)return i(a.join(""));r=e.decodeChars[r];}while(l<h&&-1==r);if(-1==r)break;a.push(String.fromCharCode((3&o)<<6|r));}return i(a.join(""))}(t)}}!function(t){t[t.render=1]="render",t[t.extractImageOnly=2]="extractImageOnly",t[t.auto=3]="auto",t[t.renderWithAnnot=4]="renderWithAnnot";}(ri||(ri={}));class Bi extends Di{constructor(t){super(Si.PdfReaderModule,t),He.add(this),$e.set(this,void 0),je.set(this,void 0),Ge.set(this,0),Ye.set(this,200),qe.set(this,3),Je.set(this,!1),Ze.set(this,void 0),Qe.set(this,null),Ke.set(this,""),this._outputType=k.IT_ALL;}static get fonts(){return y(this,Ve,"f",ze)}static addPdfFont(t,e){return m(this,void 0,void 0,(function*(){return y(this,Ve,"m",Xe).call(this,t,e)}))}static getPdfFonts(){return this.fonts?Object.keys(this.fonts):[]}static removeFont(){x(this,Ve,Object.create(null),"f",ze);}workerChanged(t){x(this,Je,!1,"f"),t&&(bi.logD("["+this.id+"] worker changed to "+t),x(this,Ge,t,"f"));}setExternalWorkerChanged(t,e){x(this,$e,t,"f"),x(this,je,e,"f");}_workerChanged(t){this.workerChanged(t),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this,t);}_canTerminateWork(){return !0}makeSureWorkerMemoryNotExceed(){this._makeSureWorkerMemoryNotExceed()||(x(this,Je,!1,"f"),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this));}makeSureWorkerChanged(){this._makeSureWorkerChanged()&&(x(this,Je,!1,"f"),y(this,$e,"f")&&y(this,$e,"f").call(this,y(this,je,"f"),this));}getPdfInfo(t){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),y(this,Ze,"f")}))}readPage(t,e,i,s,n,o,r,a){return m(this,void 0,void 0,(function*(){return this.readPageEx(t,e,{convertMode:s,renderOptions:{resolution:i}},n,o,r,a)}))}readPageEx(t,e,i,s,n,o,r){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0,s=null!=s?s:this._outputType,o=null!=o?o:D.RT_AUTO,n=null!=n&&n,r=null!=r&&r;let a=i?JSON.stringify(i):"{}",l=this._createTask("ReadPdfPageEx");return l.params.input=[e,a,s,n,r],l.params.returnType=o,l.params.returnBlob=o===D.RT_AUTO,l.handleResult=this._handleImageData,this._addTask(l)}))}renderPage(t,e,i,s,n){var o,r,a,l;return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0;const h=null!==(o=null==n?void 0:n.outputType)&&void 0!==o?o:k.IT_RGBA,c=null!==(r=null==n?void 0:n.rect)&&void 0!==r?r:null,d=null!==(a=null==n?void 0:n.returnType)&&void 0!==a?a:D.RT_AUTO,u=null!==(l=null==n?void 0:n.is1BitTo8Bit)&&void 0!==l&&l;let p=(null==n?void 0:n.renderOptions)?JSON.stringify(n.renderOptions):"{}",g=this._createTask("RenderPdfPage");return g.params.input=[e,p,c,i,s,h,u],g.params.returnType=d,g.params.returnBlob=d===D.RT_AUTO,g.handleResult=this._handleImageData,this._addTask(g)}))}readPageImageInfos(t,e,i,s){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),s=null!=s?s:this._outputType;let n=i?JSON.stringify(i):"{}",o=this._createTask("ReadPageImageInfos");return o.params.input=[e,n,s],this._addTask(o)}))}readPageAnnot(t,e){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t),e=null!=e?e:0;let i=this._createTask("GetPageAnnot",[e]);return this._addTask(i)}))}findText(t,e,i,s){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ti).call(this,t);let n=0;return s&&(s.matchCase&&(n|=1),s.matchWholeWord&&(n|=2),s.consecutive&&(n|=4)),this._addTask(this._createTask("SearchText",[e,i,n]))}))}getCharInfos(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPageCharInfos",[e]))}))}getPageInfos(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPdfPageInfos",[e]))}))}getPdfPageType(t,e){return m(this,void 0,void 0,(function*(){return yield y(this,He,"m",ti).call(this,t),this._addTask(this._createTask("GetPageContentType",[e]))}))}UnloadPage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("UnloadPdfPage",[t]))}))}SetLoadedPageCapacity(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("SetLoadedPageCapacity",[t]))}))}}Ve=Bi,$e=new WeakMap,je=new WeakMap,Ge=new WeakMap,Ye=new WeakMap,qe=new WeakMap,Je=new WeakMap,Ze=new WeakMap,Qe=new WeakMap,Ke=new WeakMap,He=new WeakSet,Xe=function(t,e){return m(this,void 0,void 0,(function*(){if("string"==typeof t&&0!==t.length||Promise.reject("The 'name' should be a valid string"),void 0===y(this,Ve,"f",ze)[t])if(e instanceof Blob)y(this,Ve,"f",ze)[t]=e;else {const i=yield Ci.read(e);y(this,Ve,"f",ze)[t]=ki.newBlobInChunks(i);}}))},ti=function(t){var e,i;return m(this,void 0,void 0,(function*(){if(this.makeSureWorkerMemoryNotExceed(),y(this,Je,"f")){if(y(this,Qe,"f")===t.fileSource)return void bi.logD("["+this.id+"] already opened in "+this.workerId);yield y(this,He,"m",oi).call(this);}bi.logD("["+this.id+"] reopen in worker "+this.workerId),yield y(this,He,"m",ni).call(this,null!==(e=t.fileSource)&&void 0!==e?e:y(this,Qe,"f"),null!==(i=t.password)&&void 0!==i?i:y(this,Ke,"f"));}))},ei=function(){return m(this,void 0,void 0,(function*(){if(0===y(this,Ge,"f")||y(this,Ge,"f")!==this.workerId){if(bi.logD("["+this.id+"] load font in worker "+this.workerId),Si.FontUseFileReadMode.load)return yield y(this,He,"m",ii).call(this);const t=Bi.fonts,e=Object.keys(t);for(let i of e){const e=t[i],s=yield Ci.read(e);s&&(yield y(this,He,"m",si).call(this,i,s));}}}))},ii=function(){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("SetSystemFonts",[Bi.fonts]))}))},si=function(t,e){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("AddSystemFont",[t,e]))}))},ni=function(t,e){return m(this,void 0,void 0,(function*(){yield y(this,He,"m",ei).call(this),e=null!=e?e:"";let i,s=this,n=s._createTask("LoadPdf");return t!==y(s,Qe,"f")||e!==y(s,Ke,"f")?(t instanceof Blob?x(s,Qe,t,"f"):(i=yield s._readFile(t),x(s,Qe,ki.newBlobInChunks(i),"f")),x(s,Ke,e,"f")):e=y(s,Ke,"f"),y(s,Qe,"f").size>1024*Si.FileReadModeSize*1024?n.params.input=[y(s,Qe,"f"),e]:(i||(i=yield s._readFile(y(s,Qe,"f"))),n.params.input=[i,e]),n.handleResult=function(e,i){if(e.srcBuffer){let i=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=i&&"[object Uint8ClampedArray]"!=i&&delete e.srcBuffer;}let n=Ii.decode(e.infoBase64);try{let t;try{n.replace(new RegExp("\\\\","gi"),"\\\\"),t=JSON.parse(n);}catch(e){t=n;}let i={PdfCount:e.pageCount,PdfInfo:t,isTextBased:e.isTextBased};return e.srcBuffer&&(i.srcBuffer=e.srcBuffer,delete e.srcBuffer),x(s,Je,!0,"f"),x(s,Ze,i,"f"),i}catch(e){i.reject({code:A.wasmJsInvalidJson,message:e.message,stack:e.stack});}},s._addTask(n)}))},oi=function(){return m(this,void 0,void 0,(function*(){if(x(this,Qe,null,"f"),x(this,Ke,"","f"),y(this,Je,"f"))return x(this,Je,!1,"f"),this._addTask(this._createTask("UnloadDocument",null,this._handleBooleanResult))}))},ze={value:Object.create(null)};const Ui=["readPdfPage","readTiffPage","readImage","renderPdfPage"];class Li{constructor(t){this.items=[],t&&(this.items=t);}push(t){this.items.push(t);}pop(){return this.items.pop()}peek(){return this.items[this.items.length-1]}isEmpty(){return 0===this.items.length}size(){return this.items.length}add(t){let e;-1!==Ui.indexOf(t.api)&&this.push(t);for(let i of this.items)i.api===t.api&&i.params[0]===t.params[0]&&i.params[1]===t.params[1]&&(e=i);e?(e.resolves=[...e.resolves,...t.resolves],e.rejects=[...e.rejects,...t.rejects]):this.push(t);}remove(t){-1!==Ui.indexOf(t.api)&&this.items.forEach(((e,i)=>{if(e.api===t.api){let s=!1;t.id?s=e.id===t.id:e.params[0]===t.params[0]&&e.params[1]===t.params[1]&&(s=!0),s&&this.items.splice(i,1).forEach((t=>{null==t||t.resolves.forEach((t=>{t(null);}));}));}}));}}class Oi{static unload(){if(x(this,ai,[],"f",li),x(this,ai,new Li,"f",hi),x(this,ai,!1,"f",ui),x(this,ai,0,"f",fi),x(this,ai,!1,"f",vi),Bi.removeFont(),y(this,ai,"f",ci)){bi.logD("pdfReader destroy");const t=y(this,ai,"f",ci);x(this,ai,null,"f",ci),t.terminate();}if(y(this,ai,"f",di)){bi.logD("imageReader destroy");const t=y(this,ai,"f",di);x(this,ai,null,"f",di),t.terminate();}}static updateLicense(t,e,i){return m(this,void 0,void 0,(function*(){let s=[];return y(this,ai,"f",ci)&&s.push(y(this,ai,"f",ci).updateLicense(t,e,i)),y(this,ai,"f",di)&&s.push(y(this,ai,"f",di).updateLicense(t,e,i)),Promise.all(s)}))}static add(t){return m(this,void 0,void 0,(function*(){y(this,ai,"f",li).push(t),y(this,ai,"f",ci)||(x(this,ai,new Bi,"f",ci),y(this,ai,"f",ci).setExternalWorkerChanged(y(Oi,ai,"m",mi),this),this.initPdfReaderFunctionMap()),y(this,ai,"f",di)||(x(this,ai,new Mi,"f",di),y(this,ai,"f",di).setExternalWorkerChanged(y(Oi,ai,"m",mi),this),this.initImageReaderFunctionMap());}))}static addFont(t,e){return m(this,void 0,void 0,(function*(){Bi.addPdfFont(t,e);}))}static getFonts(){return Bi.getPdfFonts()}static delete(t){const e=y(this,ai,"f",li).indexOf(t);if(e>=0&&(y(this,ai,"f",li).splice(e,1),0===y(this,ai,"f",li).length&&!y(this,ai,"f",ui))){if(y(this,ai,"f",ci)){bi.logD("pdfReader destroy");const t=y(this,ai,"f",ci);x(this,ai,null,"f",ci),t.terminate();}if(y(this,ai,"f",di)){bi.logD("imageReader destroy");const t=y(this,ai,"f",di);x(this,ai,null,"f",di),t.terminate();}}}static createTask(t,e,i){const s={api:t,id:null!=i?i:"",params:[],promise:[],resolves:[],rejects:[],retry:0};for(const t of e)s.params.push(t);const n=new Promise((function(t,e){s.resolves.push(t),s.rejects.push(e);}));return s.promise.push(n),y(this,ai,"m",yi).call(this,s),n}static cancelTask(t,e,i){if(-1!==Ui.indexOf(t)){const s={api:t,id:null!=i?i:"",params:[],promise:[],resolves:[],rejects:[],retry:0};for(const t of e)s.params.push(t);y(this,ai,"f",hi).remove(s);}}static initPdfReaderFunctionMap(){var t,e,i,s,n,o,r,a,l;y(this,ai,"f",pi).findPdfText=null===(t=y(this,ai,"f",ci))||void 0===t?void 0:t.findText,y(this,ai,"f",pi).getPdfPageInfos=null===(e=y(this,ai,"f",ci))||void 0===e?void 0:e.getPageInfos,y(this,ai,"f",pi).getPdfInfo=null===(i=y(this,ai,"f",ci))||void 0===i?void 0:i.getPdfInfo,y(this,ai,"f",pi).readPdfPageAnnot=null===(s=y(this,ai,"f",ci))||void 0===s?void 0:s.readPageAnnot,y(this,ai,"f",pi).readPdfPage=null===(n=y(this,ai,"f",ci))||void 0===n?void 0:n.readPageEx,y(this,ai,"f",pi).readPdfPageImageInfos=null===(o=y(this,ai,"f",ci))||void 0===o?void 0:o.readPageImageInfos,y(this,ai,"f",pi).getPdfCharInfos=null===(r=y(this,ai,"f",ci))||void 0===r?void 0:r.getCharInfos,y(this,ai,"f",pi).getPdfPageType=null===(a=y(this,ai,"f",ci))||void 0===a?void 0:a.getPdfPageType,y(this,ai,"f",pi).renderPdfPage=null===(l=y(this,ai,"f",ci))||void 0===l?void 0:l.renderPage;}static initImageReaderFunctionMap(){var t,e,i,s,n,o;y(this,ai,"f",gi).readImage=null===(t=y(this,ai,"f",di))||void 0===t?void 0:t.readImage,y(this,ai,"f",gi).getImageFormat=null===(e=y(this,ai,"f",di))||void 0===e?void 0:e.getImageFormat,y(this,ai,"f",gi).readImageInfo=null===(i=y(this,ai,"f",di))||void 0===i?void 0:i.readImageInfo,y(this,ai,"f",gi).getTiffInfo=null===(s=y(this,ai,"f",di))||void 0===s?void 0:s.getTiffInfo,y(this,ai,"f",gi).readTiffPage=null===(n=y(this,ai,"f",di))||void 0===n?void 0:n.readTiffPage,y(this,ai,"f",gi).getTiffPageInfos=null===(o=y(this,ai,"f",di))||void 0===o?void 0:o.getTiffPageInfos;}}ai=Oi,mi=function(t,e,i){let s=null!=t?t:this;y(s,ai,"f",ci)&&y(s,ai,"f",ci)!==e&&y(s,ai,"f",ci).workerChanged(i),y(s,ai,"f",di)&&y(s,ai,"f",di)!==e&&y(s,ai,"f",di).workerChanged(i);},yi=function(t){y(this,ai,"f",hi).add(t),y(this,ai,"f",ui)||(x(this,ai,!0,"f",ui),y(this,ai,"m",wi).call(this));},xi=function(){try{y(this,ai,"f",di)&&y(this,ai,"f",di).makeSureWorkerMemoryNotExceed(),y(this,ai,"f",ci)&&y(this,ai,"f",ci).makeSureWorkerMemoryNotExceed();}catch(t){}},wi=function(){return m(this,void 0,void 0,(function*(){do{if(y(this,ai,"f",hi).isEmpty()||!y(this,ai,"f",ci)||!y(this,ai,"f",di))break;const t=y(this,ai,"f",hi).pop();if(t)try{let e,i=y(this,ai,"f",pi)[t.api];if(i){const i=this.getFonts().length;y(this,ai,"f",fi)!==i&&(y(this,ai,"f",vi)&&(y(this,ai,"f",ci).makeSureWorkerChanged(),x(this,ai,!1,"f",vi)),x(this,ai,i,"f",fi)),e=yield y(this,ai,"f",pi)[t.api].apply(y(this,ai,"f",ci),t.params),"renderPdfPage"===t.api&&t.id&&(e.id=t.id),y(this,ai,"f",ci).makeSureWorkerMemoryNotExceed(),x(this,ai,!0,"f",vi);}else i=y(this,ai,"f",gi)[t.api],i&&(e=yield y(this,ai,"f",gi)[t.api].apply(y(this,ai,"f",di),t.params),y(this,ai,"f",di).makeSureWorkerMemoryNotExceed());null==t||t.resolves.forEach((t=>{t(e);}));}catch(e){bi.logD(e),t.retry<1&&-80202!==(null==e?void 0:e.code)?(t.retry+=1,y(this,ai,"m",xi).call(this),y(this,ai,"f",hi).push(t)):null==t||t.rejects.forEach((t=>{t(e);}));}}while(!y(this,ai,"f",hi).isEmpty());x(this,ai,!1,"f",ui);}))},li={value:[]},hi={value:new Li},ci={value:void 0},di={value:void 0},ui={value:!1},pi={value:Object.create(null)},gi={value:Object.create(null)},fi={value:0},vi={value:!1};class Ni{constructor(){Oi.add(this);}destroy(){Oi.delete(this);}readImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){return Oi.createTask("readImage",[t,e,i,s,n])}))}getImageFormat(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getImageFormat",[t])}))}readImageInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("readImageInfo",[t])}))}cancelReadImage(t,e){return Oi.cancelTask("readImage",[t,e])}getTiffInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getTiffInfo",[t,!1])}))}readTiffPage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){return Oi.createTask("readTiffPage",[t,e,i,s,n])}))}cancelReadTiffPage(t,e){return Oi.cancelTask("readTiffPage",[t,e])}getTiffPageInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getTiffPageInfos",[t,e])}))}}var _i,Wi,Fi,Hi,Vi,zi,$i,ji,Xi,Gi,Yi,qi,Ji,Zi,Qi,Ki,ts,es,is,ss;!function(t){t[t.NearestNeighbour=1]="NearestNeighbour",t[t.Bilinear=2]="Bilinear",t[t.Bicublic=3]="Bicublic",t[t.BestQuality=5]="BestQuality";}(Fi||(Fi={}));class ns extends Ri{constructor(t){super(Si.ImageProcModule,t),_i.add(this);}initImage(t,e,i,s,n){return m(this,void 0,void 0,(function*(){e=null!=e&&e,i=null!=i?i:0,s=null!=s?s:0,n=null!=n&&n;let o=this,r=o._createTask("InitImageObject");if(r.params.input=[t,i,s],e||n){const i=yield o._readFile(t);r.params.input[0]=i,e?r.params.input.push(k.IT_RGBA):r.params.input.push(k.IT_BGRA),o._addTask(r);}else {const e=yield o._readFile(t);r.params.input[0]=e,r.params.input.push(k.IT_ALL),o._addTask(r);}const a=yield r.promise;if(a.srcBuffer){let e=Object.prototype.toString.call(t);"[object ArrayBuffer]"!=e&&"[object Uint8ClampedArray]"!=e&&delete a.srcBuffer;}return a}))}restore(){return this._addTask(this._createTask("BackToOriginal",null,this._handleBooleanResult))}filter(t,e,i){var s,n,o,r,a,l,h,c,d;let u=this;e=null!=e?e:{},i=null!=i?i:{};let p=u._createTask("Filter");if(p.params.input=[],p.params.input.push(t),"toBW"===t)p.params.input.push(JSON.stringify(y(u,_i,"m",Wi).call(u,e)));else if("toGray"===t)p.params.input.push(JSON.stringify(y(u,_i,"m",Wi).call(u,e)));else if("removeShadow"===t)p.params.input.push(JSON.stringify(y(u,_i,"m",Wi).call(u,e)));else if("enhance"===t)p.params.input.push(JSON.stringify(y(u,_i,"m",Wi).call(u,e)));else if("invert"===t)p.params.input.push(JSON.stringify(y(u,_i,"m",Wi).call(u,e)));else if("brightnessAndContrast"===t){let t=null!==(s=e.brightness)&&void 0!==s?s:0,i=null!==(n=e.contrast)&&void 0!==n?n:0;p.params.input.push(t),p.params.input.push(i);}let g=i.outputType,f=null!==(o=i.returnType)&&void 0!==o?o:D.RT_AUTO,v=null!==(r=i.jpegQuality)&&void 0!==r?r:this._jpegQuality,m=null!==(a=i.bRGBA)&&void 0!==a&&a,x=null!==(l=i.bitDepth)&&void 0!==l?l:0,w=null!==(h=i.xdpi)&&void 0!==h?h:0,b=null!==(c=i.ydpi)&&void 0!==c?c:0;g=m&&null==g?k.IT_JPG:null!=g?g:k.IT_ALL;let S=null!==(d=i.is1BitTo8Bit)&&void 0!==d&&d;return p.params.input.push([g,x,w,b,!1,v,!1,S]),p.params.returnBlob=f===D.RT_AUTO,p.handleResult=this._handleImageData,u._addTask(p),p.promise}rotate(t,e,i,s){return t=null!=t?t:0,i=null!=i&&i,s=null!=s?s:Fi.Bicublic,e=null!=e?e:"FFFFFF",(t<0||t>360)&&(t%=360)<0&&(t+=360),this._addTask(this._createTask("RotateEx",[t,i,s,e],this._handleBooleanResult))}flip(t){t=null!=t?t:1;let e=this._createTask("");return e.handleResult=this._handleBooleanResult,1===t?e.func="Flip":-1===t&&(e.func="Mirror"),this._addTask(e),e.promise}erase(t,e,i,s,n){let o=this,r=o._createTask("Erase");return r.handleResult=this._handleBooleanResult,r.params.input=[t,e,i,s,JSON.stringify(y(o,_i,"m",Wi).call(o,n))],o._addTask(r),r.promise}crop(t,e,i,s){return this._addTask(this._createTask("Crop",[t,e,i,s],this._handleBooleanResult))}resize(t,e,i){return i=null!=i?i:Fi.BestQuality,this._addTask(this._createTask("ChangeImageSize",[t,e,i],this._handleBooleanResult))}toGrayscaleLevel(t){(t=null!=t?t:1)<1&&(t=1),t>3&&(t=3);let e={};return 2===t?(e.clean=!0,e.sigma=3,e.scaleLimit=720,e.alpha=1.05):3===t&&(e.clean=!0,e.sigma=5,e.scaleLimit=1080,e.alpha=1.05),this.toGrayscale(e)}toGrayscale(t){return this._addTask(this._createTask("ConvertToGrayScale",JSON.stringify(y(this,_i,"m",Wi).call(this,t)),this._handleBooleanResult))}toBinaryLevel(t,e){(e=null!=e?e:1)<1&&(e=1),e>3&&(e=3);let i={};return null!=t&&(t?i.method="adaptiveThreshold":(i.method="threshold",2===e?(i.clean=!0,i.sigma=3,i.scaleLimit=720,i.alpha=1.05):3===e&&(i.clean=!0,i.sigma=5,i.scaleLimit=1080,i.alpha=1.05))),this.toBinary(i)}toBinary(t){return this._addTask(this._createTask("ConvertToBW",JSON.stringify(y(this,_i,"m",Wi).call(this,t)),this._handleBooleanResult))}invert(){return this._addTask(this._createTask("Invert",null,this._handleBooleanResult))}setImageWidth(t,e){return this._addTask(this._createTask("SetImageWidth",[t,JSON.stringify(y(this,_i,"m",Wi).call(this,e))],this._handleBooleanResult))}setImageHeight(t,e){return this._addTask(this._createTask("SetImageHeight",[t,JSON.stringify(y(this,_i,"m",Wi).call(this,e))],this._handleBooleanResult))}setDPI(t,e,i,s,n,o){return n=null!=n&&n,o=null!=o?o:Fi.Bilinear,this._addTask(this._createTask("SetDPI",[t,e,i,s,n,o],this._handleBooleanResult))}getImage(t,e,i,s,n,o,r,a,l){t=null!=t?t:this._jpegQuality,e=null==e||e,i=null!=i&&i,s=null!=s?s:0,n=null!=n?n:0,o=null!=o?o:0,r=null!=r?r:D.RT_AUTO,a=i&&null==a?k.IT_JPG:null!=a?a:k.IT_ALL,l=null!=l&&l;let h=this._createTask("GetCurrentImage");return h.params.input=[a,s,n,o,!1,t,e,l],h.params.returnBlob=r===D.RT_AUTO,h.handleResult=this._handleImageData,this._addTask(h)}getSkewAngle(t){return this._addTask(this._createTask("GetSkewAngle",[JSON.stringify(y(this,_i,"m",Wi).call(this,t))],(function(t,e){return t.skewAngle})))}freeReservedData(){return this._addTask(this._createTask("FreeReservedData",null,this._handleBooleanResult))}detectDocument(t,e,i,s,n){return t=null!=t?t:Fi.Bilinear,e=null!=e?e:75,i=null!=i?i:100,s=null!=s?s:0,n=null!=n?n:"",this._addTask(this._createTask("DocumentDetect",[t,e/100,i,s/255,n,"1"]))}perspective(t,e,i,s,n,o,r,a){return this._addTask(this._createTask("Perspective",[t,e,i,s,n,o,r,a],this._handleBooleanResult))}changeBrightness(t,e){return t=null!=t?t:0,0!=(e=null!=e?e:1)&&1!=e&&(e=0),1===e?this._addTask(this._createTask("ChangeBrightnessAndContrast",[t,0],this._handleBooleanResult)):this._addTask(this._createTask("ChangeBrightness",[Math.floor(t/1e3*255)],this._handleBooleanResult))}changeContrast(t,e){return t=null!=t?t:0,0!=(e=null!=e?e:1)&&1!=e&&(e=0),1===e?this._addTask(this._createTask("ChangeBrightnessAndContrast",[0,t],this._handleBooleanResult)):this._addTask(this._createTask("ChangeContrast",[1+t/1e3],this._handleBooleanResult))}changeBrightnessAndContrast(t,e){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("ChangeBrightnessAndContrast",[t,e],this._handleBooleanResult))}removeShadowLevel(t,e){e=null!=e?e:1.05,(t=null!=t?t:1)<1&&(t=1),t>3&&(t=3);let i={};return 1===t&&(i.sigma=3,i.scaleLimit=720,i.alpha=e),2===t?(i.sigma=5,i.scaleLimit=1080,i.alpha=e):3===t&&(i.sigma=10,i.scaleLimit=0,i.alpha=e),this.removeShadow(i)}removeShadow(t){return this._addTask(this._createTask("ShadowRemovel",[JSON.stringify(y(this,_i,"m",Wi).call(this,t))],this._handleBooleanResult))}enhanceAndSharpenImage(){return this._addTask(this._createTask("EnhanceAndSharpen",[""],this._handleBooleanResult))}brighten(){return this._addTask(this._createTask("Brighten",[""],this._handleBooleanResult))}getBlurryScore(){return this._addTask(this._createTask("GetBlurScore",[""],(function(t,e){return t.blurryScore})))}drawQuadrangle(t,e,i,s,n,o,r,a,l){return this._addTask(this._createTask("DrawQuadrangle",[t,e,i,s,n,o,r,a,JSON.stringify(y(this,_i,"m",Wi).call(this,l))],this._handleBooleanResult))}getImageInfo(){return this._addTask(this._createTask("GetImageInfo",[]))}}_i=new WeakSet,Wi=function(t){let e={};if(null!=t&&"object"==typeof t)for(let i in t)e[i]=t[i];return e};class os{constructor(){Oi.add(this);}destroy(){Oi.delete(this);}static addPdfFont(t,e){return m(this,void 0,void 0,(function*(){return Oi.addFont(t,e)}))}static getPdfFonts(){return Oi.getFonts()}getPdfInfo(t){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfInfo",[t])}))}getPdfPageType(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfPageType",[t,e])}))}readPage(t,e,i,s,n,o,r,a){return m(this,void 0,void 0,(function*(){return this.readPageEx(t,e,{convertMode:s,renderOptions:{resolution:i}},n,o,r,a)}))}readPageEx(t,e,i,s,n,o,r){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPage",[t,e,i,s,n,o,r])}))}renderPage(t,e,i,s,n,o){return m(this,void 0,void 0,(function*(){return Oi.createTask("renderPdfPage",[t,e,i,s,n],o)}))}cancelReadPage(t,e){return Oi.cancelTask("readPdfPage",[t,e])}cancelRenderPage(t){return Oi.cancelTask("renderPdfPage",[],t)}readPageImageInfos(t,e,i,s,n,o,r){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPageImageInfos",[t,e,i,s,n,o,r])}))}readPageAnnot(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("readPdfPageAnnot",[t,e])}))}findText(t,e,i,s){return m(this,void 0,void 0,(function*(){return Oi.createTask("findPdfText",[t,e,i,s])}))}getCharInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfCharInfos",[t,e])}))}getPageInfos(t,e){return m(this,void 0,void 0,(function*(){return Oi.createTask("getPdfPageInfos",[t,e])}))}}!function(t){t[t.auto=0]="auto",t[t.store=1]="store";}(ji||(ji={}));class rs extends Ri{constructor(t){super(Si.PdfWriterModule,t),Hi.add(this);}initPdfSetting(t){return m(this,void 0,void 0,(function*(){let e=this,i=e._createTask("CreateDocument");return i.params.input=[JSON.stringify(y(e,Hi,"m",$i).call(e,t))],i.handleResult=this._handleBooleanResult,yield y(this,Hi,"m",Vi).call(this),e._addTask(i)}))}appendPage(t,e){return m(this,void 0,void 0,(function*(){let i=this,s=i._createTask("InsertImagePage");e=null!=e&&e;const n=yield i._readFile(t);return s.params.input=[n,-1,e],s.handleResult=i._handleBooleanResult,i._addTask(s),s.promise}))}insertPage(t,e,i){return m(this,void 0,void 0,(function*(){let s=this,n=s._createTask("InsertImagePage");i=null!=i&&i;const o=yield s._readFile(t);return n.params.input=[o,e,i],n.handleResult=s._handleBooleanResult,s._addTask(n),n.promise}))}writePdf(t){return m(this,void 0,void 0,(function*(){let e=this._createTask("GetCurrentPdf");return e.params.returnType=null!=t?t:D.RT_AUTO,e.params.returnBlob=t===D.RT_AUTO,e.handleResult=this._handleImageData,this._addTask(e)}))}insertBlankPage(t,e,i){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:595,i=null!=i?i:842,this._addTask(this._createTask("InsertBlankPage",[t,e,i]))}))}insertBlankPages(t,e,i,s){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:595,i=null!=i?i:842,s=null!=s?s:1,this._addTask(this._createTask("InsertBlankPages",[t,e,i,s]))}))}deletePage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("DeletePage",[t],this._handleBooleanResult))}))}movePages(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:[],this._addTask(this._createTask("MovePages",[t,e],this._handleBooleanResult))}))}pageSetRotation(t,e){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,0!=(e=((e=null!=e?e:0)%360+360)%360)&&90!==e&&180!==e&&270!==e&&(e=0);let i=this._createTask("SetPageRotation");return i.params.input=[t,e],i.handleResult=this._handleBooleanResult,this._addTask(i)}))}pageSetCropBox(t,e,i,s,n){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,e=null!=e?e:0,i=null!=i?i:0,(s=null!=s?s:e)<e&&(s=e),(n=null!=n?n:i)<i&&(n=i);let o=this._createTask("SetPageCropBox");return o.params.input=[t,e,i,s,n],o.handleResult=this._handleBooleanResult,this._addTask(o)}))}pageSetMediaBox(t,e,i,s,n){return m(this,void 0,void 0,(function*(){t=null!=t?t:0,e=null!=e?e:0,i=null!=i?i:0,(s=null!=s?s:e)<e&&(s=e),(n=null!=n?n:i)<i&&(n=i);let o=this._createTask("SetPageMediaBox");return o.params.input=[t,e,i,s,n],o.handleResult=this._handleBooleanResult,this._addTask(o)}))}pageAddImage(t,e,i,s,n,o){return m(this,void 0,void 0,(function*(){o=null!=o&&o;let r=this,a=r._createTask("PageAddImage"),l=JSON.stringify(y(r,Hi,"m",$i).call(r,i));const h=yield r._readFile(t);return a.params.input=[h,e,l,s,n,o],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}pageAddText(t,e){return m(this,void 0,void 0,(function*(){let i=JSON.stringify(e);return this._addTask(this._createTask("PageAddText",[t,i],this._handleBooleanResult))}))}pageAddPath(t,e){return m(this,void 0,void 0,(function*(){let i=JSON.stringify(e);return this._addTask(this._createTask("PageAddPath",[t,i],this._handleBooleanResult))}))}pageClearObjects(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("PageClearObjects",[t],this._handleBooleanResult))}))}pageSetAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("SetPageAnnot",[t,i],this._handleBooleanResult))}))}pageFlattenAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("FlattenPageAnnot",[t,i],this._handleBooleanResult))}))}pageRedact(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("PageRedact",[t,i],this._handleBooleanResult))}))}getFontFromTextObject(t){return t.fontName?t.fontName:""}getFontFromAnnot(t){let e=[];t&&t.normalAppearance&&t.normalAppearance.objs&&t.normalAppearance.objs.forEach((t=>{if("text"===t.type){const i=t,s=this.getFontFromTextObject(i);s&&e.push(s);}}));const i=new Set(e);return e=[...i],e}getFontFromAnnots(t){let e=[];Array.isArray(t)?t.forEach((t=>{const i=this.getFontFromAnnot(t);e=e.concat(i);})):e=this.getFontFromAnnot(t);const i=new Set(e);return e=[...i],e}pageAddAnnot(t,e){return m(this,void 0,void 0,(function*(){let i;return t=null!=t?t:0,Array.isArray(e)?(i="[",e.forEach(((t,e)=>{e>0&&(i+=","),i+=JSON.stringify(t);})),i+="]"):i=JSON.stringify(e),this._addTask(this._createTask("PageAddAnnot",[t,i],this._handleBooleanResult))}))}pageDeleteAnnot(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("DeletePageAnnot",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotByTypes(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotByTypes",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotExceptTypes(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotExceptTypes",[t,e],this._handleBooleanResult))}))}pageDeleteAnnotByNames(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:"",this._addTask(this._createTask("DeletePageAnnotByNames",[t,e],this._handleBooleanResult))}))}mergePdf(t,e,i,s,n){return m(this,void 0,void 0,(function*(){s=null!=s?s:-1,i=null!=i?i:[],e=null!=e?e:"",n=null!=n&&n;let o,r=this,a=r._createTask("MergePdfPages");return o=t instanceof Blob?t:yield r._readFile(t),a.params.input=[o,s,e,i,n],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}replacePdfPages(t,e,i,s,n){return m(this,void 0,void 0,(function*(){i=null!=i?i:[],s=null!=s?s:[],e=null!=e?e:"",n=null!=n&&n;let o,r=this,a=r._createTask("ReplacePdfPages");return o=t instanceof Blob?t:yield r._readFile(t),a.params.input=[o,e,i,s,n],a.handleResult=r._handleBooleanResult,r._addTask(a),a.promise}))}pageFlatten(t,e){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,e=null!=e?e:0,this._addTask(this._createTask("PageFlatten",[t,e],this._handleBooleanResult))}))}GetFontInfo(t){return m(this,void 0,void 0,(function*(){const e=yield this._readFile(t);return this._addTask(this._createTask("GetFontInfo",[e]))}))}IfFontsExist(t){return m(this,void 0,void 0,(function*(){let e=JSON.stringify(t);return yield y(this,Hi,"m",Vi).call(this),this._addTask(this._createTask("IfFontsExist",[e]))}))}UnloadPage(t){return m(this,void 0,void 0,(function*(){return t=null!=t?t:0,this._addTask(this._createTask("UnloadPdfPage",[t]))}))}}Hi=new WeakSet,Vi=function(){return m(this,void 0,void 0,(function*(){if(bi.logD("["+this.id+"] load font in worker "+this.workerId),0===Object.keys(Bi.fonts).length)return null;if(Si.FontUseFileReadMode.save)return this._addTask(this._createTask("LoadFonts",[Bi.fonts]));const t=Bi.fonts,e=Object.keys(t);for(let i of e){const e=t[i],s=yield Ci.read(e);s&&(yield y(this,Hi,"m",zi).call(this,i,s));}}))},zi=function(t,e){return m(this,void 0,void 0,(function*(){return this._addTask(this._createTask("LoadFont",[e,t]))}))},$i=function(t){let e={};if(null!=t&&"object"==typeof t)for(let i in t)e[i]=t[i];return e},function(t){t.Text="Text",t.Link="Link",t.FreeText="FreeText",t.Line="Line",t.Square="Square",t.Circle="Circle",t.Polygon="Polygon",t.PolyLine="PolyLine",t.Hignlight="Highlight",t.Underline="Underline",t.Squiggly="Squiggly",t.StrikeOut="StrikeOut",t.Stamp="Stamp",t.Caret="Caret",t.Ink="Ink",t.Popup="Popup";}(Xi||(Xi={})),function(t){t.None="none",t.Invisible="invisible",t.Hidden="hidden",t.Print="print",t.NoZoom="nozoom",t.NoRotate="norotate",t.NoView="noview",t.ReadOnly="readonly",t.Locked="locked",t.ToggleNoView="togglenoview",t.LockedContents="lockedcontents";}(Gi||(Gi={})),function(t){t.Solid="S",t.Dashed="D",t.Beveled="B",t.Insert="I",t.Underline="U";}(Yi||(Yi={})),function(t){t.NoEffect="S",t.Cloudy="C";}(qi||(qi={})),function(t){t.Comment="Comment",t.Key="Key",t.Note="Note",t.Help="Help",t.NewParagraph="NewParagraph",t.Paragraph="Paragraph",t.Insert="Insert";}(Ji||(Ji={})),function(t){t.Marked="Marked",t.Review="Review";}(Zi||(Zi={})),function(t){t.Accepted="Accepted",t.Rejected="Rejected",t.Cancelled="Cancelled",t.Completed="Completed",t.None="None";}(Qi||(Qi={})),function(t){t.None="None",t.Square="Square",t.Circle="Circle",t.Diamond="Diamond",t.OpenArrow="OpenArrow",t.ClosedArrow="ClosedArrow",t.Butt="Butt",t.ROpenArrow="ROpenArrow",t.RClosedArrow="RClosedArrow",t.Slash="Slash";}(Ki||(Ki={})),function(t){t[t.LeftJustified=0]="LeftJustified",t[t.Centered=1]="Centered",t[t.RightJustified=2]="RightJustified";}(ts||(ts={})),function(t){t.FreeText="FreeText",t.FreeTextCallout="FreeTextCallout",t.FreeTextTypeWriter="FreeTextTypeWriter";}(es||(es={})),function(t){t.LineArrow="LineArrow",t.LineDimension="LineDimension";}(is||(is={})),function(t){t.Approved="Approved",t.Experimental="Experimental",t.NotApproved="NotApproved",t.Asls="Asls",t.Expired="Expired",t.NotForPublicRelease="NotForPublicRelease",t.Confidential="Confidential",t.Final="Final",t.Sold="Sold",t.Departmental="Departmental",t.ForComment="ForComment",t.TopSecret="TopSecret",t.Draft="Draft",t.ForPublicRelease="ForPublicRelease";}(ss||(ss={}));const as="undefined"==typeof self,ls=as?{}:self;let hs,cs,ds,us,ps;"undefined"!=typeof navigator&&(hs=navigator,cs=hs.userAgent,ds=hs.platform,us=hs.mediaDevices),function(){if(!as){const t={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:hs.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},e={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:ds,search:"Win"},Mac:{str:ds},Linux:{str:ds}};let i="unknownBrowser",s=0,n="unknownOS";for(let e in t){const n=t[e]||{};let o=n.str||cs,r=n.search||e,a=n.verStr||cs,l=n.verSearch||e;if(l instanceof Array||(l=[l]),-1!=o.indexOf(r)){i=e;for(let t of l){let e=a.indexOf(t);if(-1!=e){s=parseFloat(a.substring(e+t.length+1));break}}break}}for(let t in e){const i=e[t]||{};let s=i.str||cs,o=i.search||t;if(-1!=s.indexOf(o)){n=t;break}}"Linux"==n&&-1!=cs.indexOf("Windows NT")&&(n="HarmonyOS"),ps={browser:i,version:s,OS:n};}as&&(ps={browser:"ssr",version:0,OS:"ssr"});}(),us&&us.getUserMedia;const gs="Chrome"===ps.browser&&ps.version>66||"Safari"===ps.browser&&ps.version>13||"OPR"===ps.browser&&ps.version>43||"Edge"===ps.browser&&ps.version>15,fs="\\s*([+-]?\\d+)\\s*",vs="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ms="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",ys=/^#([0-9a-f]{3,8})$/,xs=new RegExp(`^rgb\\(${fs},${fs},${fs}\\)$`),ws=new RegExp(`^rgb\\(${ms},${ms},${ms}\\)$`),bs=new RegExp(`^rgba\\(${fs},${fs},${fs},${vs}\\)$`),Ss=new RegExp(`^rgba\\(${ms},${ms},${ms},${vs}\\)$`),Cs=new RegExp(`^hsl\\(${vs},${ms},${ms}\\)$`),Ps=new RegExp(`^hsla\\(${vs},${ms},${ms},${vs}\\)$`),Ts={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};let As=class{constructor(t,e,s,n){i(this,"r",void 0),i(this,"g",void 0),i(this,"b",void 0),i(this,"opacity",void 0),this.r=t,this.g=e,this.b=s,this.opacity=n;}};function ks(t){return new As(t>>16&255,t>>8&255,255&t,1)}function Ds(t,e,i,s){return s<=0&&(t=NaN,e=NaN,i=NaN),new As(t,e,i,s)}function Rs(t,e,i,s){return s<=0?(t=NaN,e=NaN,i=NaN):i<=0||i>=1?(t=NaN,e=NaN):e<=0&&(t=NaN),{h:t,s:e,l:i,opacity:s}}function Es(t,e,i){return t<60?(e+(i-e)*t)/60*255:t<180?255*i:t<240?(e+(i-e)*(240-t))/60*255:255*e}function Ms(t){const e=t.h<0?t.h%360+360:t.h%360,i=Number.isNaN(e)||Number.isNaN(t.s)?0:t.s,{l:s}=t,n=s+(s<.5?s:1-s)*i,o=2*s-n;return new As(Es(e>=240?e-240:e+120,o,n),Es(e,o,n),Es(e<120?e+240:e-120,o,n),t.opacity)}const Is=t=>{let e,i;if(t=`${t}`.trim().toLowerCase(),ys.exec(t))switch(e=ys.exec(t),i=e[1].length,e=parseInt(e[1],16),i){case 6:return ks(e);case 3:return new As(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1);case 8:return Ds(e>>24&255,e>>16&255,e>>8&255,(255&e)/255);case 4:return Ds(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255);default:return null}return xs.exec(t)?(e=xs.exec(t),new As(e[1],e[2],e[3],1)):ws.exec(t)?(e=ws.exec(t),new As(255*e[1]/100,255*e[2]/100,255*e[3]/100,1)):bs.exec(t)?(e=bs.exec(t),Ds(e[1],e[2],e[3],e[4])):Ss.exec(t)?(e=Ss.exec(t),Ds(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4])):Cs.exec(t)?(e=Cs.exec(t),Ms(Rs(e[1],e[2]/100,e[3]/100,1))):Ps.exec(t)?(e=Ps.exec(t),Ms(Rs(e[1],e[2]/100,e[3]/100,e[4]))):Ts.hasOwnProperty(t)?ks(Ts[t]):"transparent"===t?new As(NaN,NaN,NaN,0):null},Bs=t=>t.replace(/[A-Z]/g,(t=>`-${t.toLowerCase()}`)),Us=t=>Object.prototype.toString.call(t),Ls=t=>Array.isArray?Array.isArray(t):"[object Array]"===Us(t),Os=t=>null!==t&&"[object Object]"===Us(t),Ns=t=>{let e=null;return Ls(t)&&(e||(e=[]),t.forEach((t=>{e.push(Ns(t));}))),Os(t)&&(e||(e={}),Object.keys(t).forEach((i=>{e[i]=Ns(t[i]);}))),e||t},_s=t=>void 0===t,Ws=(t,e)=>{var i;t=null!==(i=t)&&void 0!==i?i:"yyyy-MM-dd hh:mm:ss";const s=_s(e)?new Date:new Date(e),n={"M+":(s.getMonth()+1).toString(),"d+":s.getDate().toString(),"h+":s.getHours().toString(),"m+":s.getMinutes().toString(),"s+":s.getSeconds().toString(),"q+":Math.floor((s.getMonth()+3)/3).toString(),S:s.getMilliseconds().toString()};return /(y+)/.test(t)&&(t=t.replace(RegExp.$1,`${s.getFullYear()}`.substring(4-RegExp.$1.length))),Object.keys(n).forEach((e=>{new RegExp(`(${e})`).test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?n[e]:`00${n[e]}`.substring(`${n[e]}`.length)));})),t},Fs=t=>"[object ArrayBuffer]"===Us(t),Hs=t=>"[object Blob]"===Us(t),Vs=t=>"[object Boolean]"===Us(t),zs=t=>"function"==typeof t,$s=()=>"ontouchstart"in document.documentElement,js=t=>"number"==typeof t&&!Number.isNaN(t),Xs=t=>"string"==typeof t,Gs=(t,e,i)=>Math.min(Math.max(t,e),i);let Ys=0;const qs=()=>(Ys+=1,`${(new Date).getTime().toString(36)}${Ys.toString(36)}`),Js=t=>{const e=window.URL||window.webkitURL;let i="string";return Xs(t)?i="string":Hs(t)?(i="blob",t=e.createObjectURL(t)):(Fs(t)||Ls(t))&&(i="blob",t=e.createObjectURL(new Blob([t]))),{type:i,data:t}};function Zs(t){return "object"==typeof HTMLElement?t instanceof HTMLElement:t&&"object"==typeof t&&1===t.nodeType&&"string"==typeof t.nodeName}let Qs=class t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(this,"prefix",void 0),i(this,"postfix",void 0),i(this,"isDestroyed",!1),i(this,"uid",qs()),i(this,"cacheEvents",void 0),i(this,"events",void 0),i(this,"isCached",void 0),this.cacheEvents=[],this.events={},this.isCached=!1,this.prefix=t,this.postfix=e;}static create(e,i){return new t(e,i)}hasCallback(t){return this.events[t]&&this.events[t].length>0}save(){this.isCached=!0;}restore(){this.isCached=!1,this.cacheEvents.forEach((t=>{let{eventName:e,param:i}=t;this.emit(e,...i);})),this.cacheEvents.length=0;}destroy(){if(!this.isDestroyed){for(const t in this.events)if(Object.prototype.hasOwnProperty.call(this.events,t)){const e=this.events[t];e&&e.slice().forEach((t=>{let{name:e,fn:i,context:s,once:n}=t;this.off(e,i,s,n);}));}this.events={},this.isDestroyed=!0;}}on(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const{events:n}=this,o={name:t=this.format(t),uid:qs(),context:i,once:s,fn:e};return n[t]||(n[t]=[]),n[t].indexOf(o)<0&&n[t].push(o),o}once(t,e,i){return this.on(t,e,i,!0)}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];if(this.isCached)return this.cacheEvents.push({eventName:t,param:i}),!0;const{events:n}=this,o=n[t=this.format(t)];return !(!o||!o.length||(o.slice().forEach((t=>{let{fn:e,context:s}=t;e.call(s||null,...i);})),o.slice().forEach((e=>{let{fn:i,context:s,once:n}=e;n&&this.off(t,i,s,n);})),0))}off(t,e,i,s){const{events:n}=this,o=n[t=this.format(t)];if(!o)return !1;if(!arguments.length)return o.length=0,!0;for(let t=o.length-1;t>=0;t--){const n=o[t];e&&n.fn!==e||i&&n.context!==i||s&&n.once!==s||o.splice(t,1);}return !0}removeAllEventListeners(t){if(t){t=this.format(t);const e=this.cacheEvents.findIndex((e=>e.eventName===t));e>-1&&this.cacheEvents.splice(e,1),this.events[t]&&delete this.events[t];}else this.cacheEvents=[],this.events={};}getAllEvents(){return this.events}format(t){return `${this.prefix||""}${t}${this.postfix||""}`}};const Ks="default";let tn=class t{constructor(){i(this,"emitter",new Qs);}static create(){return new t}hasCallback(){return this.emitter.hasCallback(Ks)}on(t){this.emitter.on(Ks,t);}emit(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this.emitter.emit(Ks,...e);}off(t){this.emitter.off(Ks,t);}};function en(){return new tn}class sn{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,"x",void 0),i(this,"y",void 0),i(this,"z",void 0),this.x=t,this.y=e,this.z=s;}static fromPoint(t){return new sn(t.x,t.y,t.z)}static fromTwoPoint(t,e){var i,s,n,o,r,a;return new sn((null!==(i=e.x)&&void 0!==i?i:0)-(null!==(s=t.x)&&void 0!==s?s:0),(null!==(n=e.y)&&void 0!==n?n:0)-(null!==(o=t.y)&&void 0!==o?o:0),(null!==(r=e.z)&&void 0!==r?r:0)-(null!==(a=t.z)&&void 0!==a?a:0))}static fromValue(t,e,i){return new sn(t,e,i)}setFromVector(t){var e;this.x=t.x,this.y=t.y,this.z=null!==(e=t.z)&&void 0!==e?e:0;}clone(){return new sn(this.x,this.y,this.z)}norm(){return Math.hypot(this.x,this.y,this.z)}dot(t){var e;return this.x*t.x+this.y*t.y+this.z*(null!==(e=t.z)&&void 0!==e?e:0)}projectionTo(t){const e=Math.hypot(t.x,t.y,t.z);return this.dot(t)/e}angle(t){const e=this.norm()*Math.hypot(t.x,t.y,t.z),i=e&&this.dot(t)/e;return Math.acos(Gs(i,-1,1))}equals(t){var e;return this.x===t.x&&this.y===t.y&&this.z===(null!==(e=t.z)&&void 0!==e?e:0)}distance(t){var e;return Math.hypot(this.x-t.x,this.y-t.y,this.z-(null!==(e=t.z)&&void 0!==e?e:0))}lerp(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:s,y:n,z:o}=this;return new sn(s+i*(t.x-s),n+i*(t.y-n),o+i*((null!==(e=t.z)&&void 0!==e?e:0)-o))}normalize(){const t=this,e=t.norm();return t.x/=e,t.y/=e,t.z/=e,this}negate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}cross(t){const e=this;return {x:e.y*t.z-e.z*t.y,y:e.z*t.x-e.x*t.z,z:e.x*t.y-e.y*t.x}}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}}function nn(t,e){return sn.fromTwoPoint(t,e)}class on{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,"x",void 0),i(this,"y",void 0),i(this,"z",void 0),this.x=t,this.y=e,this.z=s;}static fromPoint(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new on(t.x,t.y,t.z)}matrixTransform(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{x:e,y:i,z:s}=this,{m11:n,m21:o,m31:r,m41:a,m12:l,m22:h,m32:c,m42:d,m13:u,m23:p,m33:g,m43:f,m14:v,m24:m,m34:y,m44:x}=t,w=v*e+m*i+y*s+x;return rn({x:(n*e+o*i+r*s+a)/w,y:(l*e+h*i+c*s+d)/w,z:(u*e+p*i+g*s+f)/w})}setFromPoint(t){return this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this}clone(){return rn(this)}equals(t){const{x:e=0,y:i=0,z:s=0}=t,n=this;return n.x===e&&n.y===i&&n.z===s}distanceTo(t){const{x:e=0,y:i=0,z:s=0}=t,n=this;return Math.hypot(n.x-e,n.y-i,n.z-s)}lerpTo(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:i=0,y:s=0,z:n=0}=t,o=this;return rn({x:o.x+e*(i-o.x),y:o.y+e*(s-o.y),z:o.z+e*(n-o.z)})}footPointInSegment(t,e){const i=nn(t,this),s=nn(t,e),n=s.norm(),o=rn(t);if(0===n)return o;const r=i.projectionTo(s)/n;return o.lerpTo(e,r)}perpendicularToSegment(t,e){const i=this.footPointInSegment(t,e);return this.distanceTo(i)}}function rn(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return js(t)?new on(t,e,i):new on(t.x,t.y,t.z)}function an(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}class ln{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,"x",0),i(this,"y",0),i(this,"left",0),i(this,"top",0),i(this,"right",0),i(this,"bottom",0),i(this,"width",0),i(this,"height",0),this.update(t,e,s,n);}update(t,e,i,s){this.x=t,this.y=e,this.left=t,this.top=e,this.right=t+i,this.bottom=e+s,this.width=i,this.height=s;}toJSON(){}}const hn=new class{constructor(){i(this,"tasks",[]);}createTimer(t,e){const i=qs();return this.tasks.push({uid:i,callback:t,time:e}),this.executeTimer(i),i}executeTimer(t){const e=this.tasks.find((e=>e.uid===t));if(!e)return;const i=()=>{e.callback(),null!==e.timer&&(e.timer=setTimeout(i,e.time));};e.timer=setTimeout(i,e.time);}clearTimer(t){const e=this.tasks.findIndex((e=>e.uid===t));e>-1&&(clearTimeout(this.tasks[e].timer),this.tasks[e].timer=null,this.tasks.splice(e,1));}};function cn(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}function dn(t){const{type:e,value:i}=t;return "hex"===e?`#${i}`:"literal"===e?i:"rgb"===e?`rgb(${i.join(",")})`:`rgba(${i.join(",")})`}const un=function(){const t={linearGradient:/^(linear\-gradient)/i,repeatingLinearGradient:/^(repeating\-linear\-gradient)/i,radialGradient:/^(radial\-gradient)/i,repeatingRadialGradient:/^(repeating\-radial\-gradient)/i,conicGradient:/^(conic\-gradient)/i,sideOrCorner:/^to (left (top|bottom)|right (top|bottom)|top (left|right)|bottom (left|right)|left|right|top|bottom)/i,extentKeywords:/^(closest\-side|closest\-corner|farthest\-side|farthest\-corner|contain|cover)/,positionKeywords:/^(left|center|right|top|bottom)/i,pixelValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))px/,percentageValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))\%/,emValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))em/,angleValue:/^(-?(([0-9]*\.[0-9]+)|([0-9]+\.?)))deg/,startCall:/^\(/,endCall:/^\)/,comma:/^,/,hexColor:/^\#([0-9a-fA-F]+)/,literalColor:/^([a-zA-Z]+)/,rgbColor:/^rgb/i,rgbaColor:/^rgba/i,number:/^(([0-9]*\.[0-9]+)|([0-9]+\.?))/};let e="";function i(t){throw new Error(`${e}: ${t}`)}function s(){return n("linear-gradient",t.linearGradient,r)||n("repeating-linear-gradient",t.repeatingLinearGradient,r)||n("radial-gradient",t.radialGradient,a)||n("repeating-radial-gradient",t.repeatingRadialGradient,a)||n("conic-gradient",t.conicGradient,a)}function n(e,s,n){return o(s,(s=>{const o=n();return o&&(y(t.comma)||i("Missing comma before color stops")),{type:e,orientation:o,colorStops:u(p)}}))}function o(e,s){const n=y(e);if(n){y(t.startCall)||i("Missing (");const e=s(n);return y(t.endCall)||i("Missing )"),e}}function r(){return m("directional",t.sideOrCorner,1)||m("angular",t.angleValue,1)}function a(){let i,s,n=l();return n&&(i=[],i.push(n),s=e,y(t.comma)&&(n=l(),n?i.push(n):e=s)),i}function l(){let t=function(){const t=m("shape",/^(circle)/i,0);return t&&(t.style=v()||h()),t}()||function(){const t=m("shape",/^(ellipse)/i,0);return t&&(t.style=f()||h()),t}();if(t)t.at=c();else {const e=h();if(e){t=e;const i=c();i&&(t.at=i);}else {const e=d();e&&(t={type:"default-radial",at:e});}}return t}function h(){return m("extent-keyword",t.extentKeywords,1)}function c(){if(m("position",/^at/,0)){const t=d();return t||i("Missing positioning value"),t}}function d(){const t={x:f(),y:f()};if(t.x||t.y)return {type:"position",value:t}}function u(e){let s=e();const n=[];if(s)for(n.push(s);y(t.comma);)s=e(),s?n.push(s):i("One extra comma");return n}function p(){const e=m("hex",t.hexColor,1)||o(t.rgbaColor,(()=>({type:"rgba",value:u(g)})))||o(t.rgbColor,(()=>({type:"rgb",value:u(g)})))||m("literal",t.literalColor,0);return e||i("Expected color definition"),e.length=f(),e}function g(){return y(t.number)[1]}function f(){return m("%",t.percentageValue,1)||m("position-keyword",t.positionKeywords,1)||v()}function v(){return m("px",t.pixelValue,1)||m("em",t.emValue,1)}function m(t,e,i){const s=y(e);if(s)return {type:t,value:s[i]}}function y(t){const i=/^[\n\r\t\s]+/.exec(e);i&&x(i[0].length);const s=t.exec(e);return s&&x(s[0].length),s}function x(t){e=e.substring(t);}return function(t){return e=t,function(){const t=u(s);return e.length>0&&i("Invalid input not EOF"),t}()}}();const pn={"&amp;":"&","&gt;":">","&lt;":"<","&nbsp;":" ","&quot;":'"',"&#x27;":"'"},gn={};let fn;function vn(t,e){const i=Object.keys(t);let s=0;for(;s<i.length;s++){const n=i[s];if(!1===e.call(null,t[n],n,t))break}}vn(pn,((t,e)=>{gn[t]=e;}));const mn=t=>{const{parentNode:e}=t,{children:i}=e;for(let e=0;e<i.length;e++)if(i[e]===t)return e;return -1},yn=(t,e,i)=>{try{void 0===e?i.appendChild(t):i.insertBefore(t,e);}catch(t){}},xn=()=>{const t=window;if(t){if(t.devicePixelRatio)return t.devicePixelRatio;if(t.screen.deviceXDPI&&t.screen.logicalXDPI)return t.screen.deviceXDPI/t.screen.logicalXDPI}return 1};function wn(t){let e="0px",i="",s="solid";if(!_s(t)&&""!==t){const n=document.createElement("div");n.style.border=t;const{borderWidth:o,borderColor:r,borderStyle:a}=n.style;"initial"!==o&&""!==o&&(e=o),"initial"!==r&&""!==r&&(i=r),"initial"!==a&&""!==a&&(s=a);}return {borderWidth:e,borderColor:i,borderStyle:s}}const bn=t=>{const{pointerType:e}=t;return "touch"===e||"pen"===e||void 0===e};let Sn;function Cn(){return void 0===Sn&&(Sn=/Mac OS/.test(navigator.userAgent)),Sn}function Pn(t){return Cn()?Rn(t,3):Rn(t,2)}function Tn(t){return Cn()&&Rn(t,3)||Rn(t,2)}function An(t){return Rn(t,5)}function kn(t){return Rn(t,1)}function Dn(t){return Rn(t,0)}function Rn(t,e){const{ctrlKey:i,metaKey:s,altKey:n,shiftKey:o}=t;switch(e){case 0:return i||s||n||o;case 1:return !(i||s||n||o);case 2:return i&&!s&&!n&&!o;case 3:return !i&&s&&!n&&!o;case 4:return !i&&!s&&n&&!o;case 5:return !i&&!s&&!n&&o;default:return !1}}const En=function(t,e){const i=t.indexOf(e);return !(i<0||(t.splice(i,1),0))},Mn=function(t,e,i){if(js(i)){let s=[],n=[];if(e.includes(i)){const t=e.length;if(t>1){const o=e.indexOf(i);0===o?n=e.slice(1):o===t-1?s=e.slice(0,-1):(s=e.slice(0,o),n=e.slice(o+1));}}else s=e;const o=t[i],r=s.map((e=>t[e])),a=n.map((e=>t[e]));r.forEach((e=>{const i=t.indexOf(e);i>-1&&t.splice(i,1);})),a.forEach((e=>{const i=t.indexOf(e);i>-1&&t.splice(i,1);}));const l=t.indexOf(o);t.splice(l+1,0,...a),t.splice(l,0,...r);}else e.map((e=>t[e])).forEach((e=>{const i=t.indexOf(e);t.splice(i,1),t.push(e);}));return !0},In=function(t,e,i){if(e===i)return !0;const s=t[e];return t[e]=t[i],t[i]=s,!0},Bn=function(t,e){const i=e.length;return !(t.length!==i||!i||(e.every(((t,e)=>t===e))||e.map((e=>t[e])).forEach(((e,i)=>{t[i]=e;})),0))};function Un(t){return null==t}const Ln=(t,e)=>t in e,On=(t,e)=>{const i=[];for(;t;){const s=t.match(e);if(!s)break;i.push(s),t=t.substring(s.index+s[0].length);}return i};function Nn(t,e){return Object.keys(t).forEach((i=>{(function(t){return "__proto__"===t||"constructor"===t||"prototype"===t})(i)||(_s(e[i])?e[i]=t[i]:Os(t[i])?Nn(t[i],e[i]):e[i]=t[i]);})),e}class _n{static read(t){return new Promise(((e,i)=>{const s=Object.prototype.toString.call(t);if("[object String]"===s){if(0===t.indexOf("blob:")||t.indexOf(".jpg")>0||t.indexOf(".jpeg")>0||t.indexOf(".png")>0||t.indexOf(".bmp")>0||t.indexOf(".dib")>0||t.indexOf(".pdf")>0||t.indexOf(".tiff")>0||t.indexOf(".tif")>0)return fetch(t,{mode:"cors"}).then((t=>t.arrayBuffer())).then((t=>e(t))).catch((t=>Promise.reject(t)));i("Error url: Can not read the file URL");}else if("[object Blob]"===s||"[object FileList]"===s||"[object File]"===s){let n=t;"[object FileList]"!==s&&"[object File]"!==s||(n=t[0]?t[0]:t),l(_n,_n,Wn).call(_n,n,e,i);}else "[object ArrayBuffer]"===s||"[object Uint8ClampedArray]"===s?e(t):i(`Not support source type: ${s}`);}))}}function Wn(t,e,i){let s,n,o=0;try{s=new ArrayBuffer(t.size),n=new Uint8Array(s);}catch(t){i(t);}!function r(){const a=new FileReader;a.onload=function(a){var l;if(null!=a&&null!==(l=a.target)&&void 0!==l&&l.result){const i=a.target.result;n.set(new Uint8Array(i),o),o+=i.byteLength,o<t.size?r():e(s);}else i(a);},a.onerror=function(t){i(t);},a.onabort=function(t){i(t);};const l=Math.min(o+1048576,t.size),h=t.slice(o,l);a.readAsArrayBuffer(h);}();}async function Fn(t){let e;if(t instanceof ArrayBuffer)t.byteLength>12&&(e=new Uint8Array(t.slice(0,12)));else if(t instanceof Blob&&t.size>12){const i=t.slice(0,12),s=await _n.read(i);e=new Uint8Array(s);}if(e){if(function(t){return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]}(e))return "application/pdf";if(function(t){return 137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]}(e))return "image/png";if(function(t){return 255===t[0]&&216===t[1]}(e))return "image/jpeg";if(function(t){return 66===t[0]&&77===t[1]}(e))return "image/bmp";if(function(t){return 73===t[0]&&73===t[1]&&42===t[2]&&0===t[3]||77===t[0]&&77===t[1]&&0===t[2]&&42===t[3]}(e))return "image/tiff";if(function(t){return 0===t[0]&&0===t[1]&&0===t[2]&&12===t[3]&&106===t[4]&&80===t[5]&&32===t[6]&&32===t[7]||255===t[0]&&79===t[1]&&255===t[2]&&81===t[3]}(e))return "image/jp2";if(function(t){return 82===t[0]&&73===t[1]&&70===t[2]&&70===t[3]&&87===t[8]&&69===t[9]&&66===t[10]&&80===t[11]}(e))return null;if(t instanceof Blob&&("application/pdf"===t.type||"image/bmp"===t.type||"image/jp2"===t.type||"image/jpeg"===t.type||"image/png"===t.type||"image/tiff"===t.type||"image/rgba"===t.type))return t.type}return t instanceof Blob&&"application/ddv-blank-image"===t.type?t.type:null}function Hn(t,e,i,s){if(function(t,e,i,s){return Math.min(t[0],e[0])<=Math.max(i[0],s[0])&&Math.min(i[0],s[0])<=Math.max(t[0],e[0])&&Math.min(t[1],e[1])<=Math.max(i[1],s[1])&&Math.min(i[1],s[1])<=Math.max(t[1],e[1])}(t,e,i,s)&&function(t,e,i,s){let n=t[0]*(i[1]-e[1])+e[0]*(t[1]-i[1])+i[0]*(e[1]-t[1]),o=t[0]*(s[1]-e[1])+e[0]*(t[1]-s[1])+s[0]*(e[1]-t[1]);return !((n^o)>=0&&0!==n&&0!==o||(n=i[0]*(t[1]-s[1])+s[0]*(i[1]-t[1])+t[0]*(s[1]-i[1]),o=i[0]*(e[1]-s[1])+s[0]*(i[1]-e[1])+e[0]*(s[1]-i[1]),(n^o)>=0&&0!==n&&0!==o))}(t,e,i,s)){let n=(s[0]-i[0])*(t[1]-e[1])-(e[0]-t[0])*(i[1]-s[1]),o=(t[1]-i[1])*(e[0]-t[0])*(s[0]-i[0])+i[0]*(s[1]-i[1])*(e[0]-t[0])-t[0]*(e[1]-t[1])*(s[0]-i[0]);if(0===n||0===o){const n=Vn(t,e),o=Vn(i,s),r=n[0],a=n[1],l=o[0],h=o[1];if(a[0]===l[0]&&a[1]===l[1])return a;if(r[0]===h[0]&&r[1]===h[1])return r;if(zn(a,o)&&zn(l,n))return [l,a];if(zn(r,o)&&zn(h,n))return [r,h];if(zn(r,o)&&zn(a,o))return [r,a];if(zn(l,o)&&zn(h,o))return [l,h]}const r=o/n;return n=(t[0]-e[0])*(s[1]-i[1])-(e[1]-t[1])*(i[0]-s[0]),o=e[1]*(t[0]-e[0])*(s[1]-i[1])+(s[0]-e[0])*(s[1]-i[1])*(t[1]-e[1])-s[1]*(i[0]-s[0])*(e[1]-t[1]),[r,o/n]}return !1}function Vn(t,e){return t[0]===e[0]?t[1]<e[1]?[t,e]:[e,t]:t[0]<e[0]?[t,e]:[e,t]}function zn(t,e){return e[0][0]===e[1][0]?t[1]>=e[0][1]&&t[1]<=e[1][1]:t[0]>=e[0][0]&&t[0]<=e[1][0]}function $n(t){const e=[];let i=null;const s=t.slice(0,8).concat(t[0],t[1]);for(let t=0;t<4;t++){const n=s[2*(t+1)+1]-s[2*t+1],o=s[2*(t+1)]-s[2*t];i=0===n&&0===o?0:n/o,e.push(i);}return e}function jn(t,e){return Number.parseFloat(t.toFixed(e))}function Xn(t){const[e,i,s,n,o,r,a,l]=t,h=(a-e)*(n-i)-(l-i)*(s-e),c=(e-s)*(r-n)-(i-n)*(o-s),d=(s-o)*(l-r)-(n-r)*(a-o),u=(o-a)*(i-l)-(r-l)*(e-a);if(h*c*d*u<0)return !1;const p=t.slice().concat(t.slice(0,2)),g=$n(t);if(g.length)for(let t=0;t<2;t++)if(g[t]!==g[t+2]&&Hn(p.slice(2*t,2*(t+1)),p.slice(2*(t+1),2*(t+2)),p.slice(2*(t+2),2*(t+3)),p.slice(2*(t+3),2*(t+4))))return !1;return h*c*d*u>0}function Gn(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return e===i?t:js(t)?s?jn(t/e*i,2):t/e*i:Ls(t)?t.map((t=>Ls(t)?[s?jn(t[0]/e*i,2):t[0]/e*i,s?jn(t[1]/e*i,2):t[1]/e*i]:s?jn(t/e*i,2):t/e*i)):(t={...t},Object.keys(t).forEach((n=>{t[n]=s?jn(t[n]/e*i,2):t[n]/e*i;})),t)}function Yn(t,e){return t.every(((t,i)=>{let[s,n]=t;const[o,r]=e[i];return s===o&&n===r}))}function qn(t,e){return Number.parseFloat(t.toFixed(e))}function Jn(t){if(0===t.length)return !0;if(1===t.length)return 0===t[0];t.length%2!=0&&(t=t.concat(t));for(let e=1;e<t.length;e+=2)if(0!==t[e])return !1;return !0}class Zn{constructor(){i(this,"disposed",!1),i(this,"toDispose",new Set);}get isDisposed(){return this.disposed}add(t){if(!t)return t;if(t===this)throw new Error("Cannot register a disposable on itself!");return this.disposed||this.toDispose.add(t),t}delete(t){if(t){if(t===this)throw new Error("Cannot dispose a disposable on itself!");this.toDispose.delete(t),t.dispose();}}dispose(){this.disposed||(this.disposed=!0,this.clear());}clear(){try{for(const t of this.toDispose)if(t)try{t.dispose();}catch(t){throw new Error("can not dispose an object")}}finally{this.toDispose.clear();}}}class Qn{constructor(){i(this,"store",new Zn);}dispose(){this.store.dispose();}register(t){if(t===this)throw new Error("Cannot register a disposable on itself!");return this.store.add(t)}}class Kn{static create(t){return new Kn(t)}constructor(t){i(this,"isDisposed",!1),i(this,"listeners",void 0),i(this,"options",void 0),this.options=t,this.listeners=[];}dispose(){this.isDisposed||(this.isDisposed=!0,this.listeners&&(this.listeners=[]));}hasCallback(){var t;return (null===(t=this.listeners)||void 0===t?void 0:t.length)>0}on(t,e,i){var s,n,o,r;if(this.isDisposed)return {dispose:()=>{}};const a={uid:qs(),callback:t,context:e};this.listeners.length?this.listeners.push(a):(null!==(s=this.options)&&void 0!==s&&null!==(n=s.beforeAddFirstListener)&&void 0!==n&&n.call(s,this),this.listeners.push(a),null===(o=this.options)||void 0===o||null===(r=o.afterAddFirstListener)||void 0===r||r.call(o,this));const l={dispose:()=>{this.remove(a);}};return i instanceof Zn?i.add(l):Array.isArray(i)?i.push(l):i instanceof Qn&&i.register(l),l}remove(t){var e,i,s,n;if(null!==(e=this.options)&&void 0!==e&&null!==(i=e.beforeRemoveListener)&&void 0!==i&&i.call(e,this),!this.listeners)return;if(1===this.listeners.length)return this.listeners=[],void(null===(s=this.options)||void 0===s||null===(n=s.afterRemoveLastListener)||void 0===n||n.call(s,this));const o=this.listeners.indexOf(t);o>=0&&this.listeners.splice(o,1);}off(t){if(this.isDisposed||!this.listeners)return;const e=this.listeners.findIndex((e=>e.callback===t));e>-1&&this.listeners.splice(e,1);}emit(t){this.listeners&&this.listeners.length&&this.listeners.slice().forEach((e=>{try{e.context?e.callback.call(e.context,t):e.callback(t);}catch(e){}}));}}function to(t){const e=t.register(new Kn);return {on:(i,s)=>e.on(i,t,s),emit:t=>{e.hasCallback()&&e.emit(t);},hasCallback:()=>e.hasCallback()}}function eo(t,e,i){return {on:(s,n)=>{const o=new Kn({beforeAddFirstListener:()=>{t.addEventListener(e,s,n);},afterRemoveLastListener:()=>{t.removeEventListener(e,s);}});i.register(o.on((()=>{}))),i.register(o);}}}var io,so;!function(t){t.core="ddv-core",t.reader="ddv-reader",t.detector="ddv-detector",t.loader="ddv-loader";}(so||(so={}));class no{static get isApple(){return r(this,no,mo)}static get version(){return Si.ImageIOModule.ver}static enableDebugOutput(t,e){if(t){const t=t=>{var i,s,n;let o=Ns(t);o.srcBuffer&&(o.srcBuffer=l(this,no,oo).call(this,o.srcBuffer)),null!==(i=o.result)&&void 0!==i&&i.srcBuffer&&(o.result.srcBuffer=l(this,no,oo).call(this,o.result.srcBuffer)),null!==(s=o.result)&&void 0!==s&&s.imageData&&(o.result.imageData=l(this,no,oo).call(this,o.result.imageData)),null!==(n=o.result)&&void 0!==n&&n.pdfData&&(o.result.pdfData=l(this,no,oo).call(this,o.result.pdfData)),o.imageData&&(o.imageData=l(this,no,oo).call(this,o.imageData)),e&&(Xs(o)&&(o=`[${Date.now()}]${o}`),e(o));};Si.setLogFunc("logDebug",t);}else Si.setLogFunc("",void 0);}static hasDebugOutput(){return Si.hasLogFunc()}static get blobReadModeSettings(){const{FontUseFileReadMode:t}=Si;return {minBlobSize:Si.FileReadModeSize,fontForLoad:t.load,fontForSave:t.save}}static set blobReadModeSettings(t){"number"==typeof t.minBlobSize&&(Si.FileReadModeSize=t.minBlobSize),Si.FontUseFileReadMode={load:t.fontForLoad,save:t.fontForSave};}static getMemoryUsed(){return Ai.Instance.getMemoryUsed()}static get heapConfig(){return Si.HeapConfig}static updateHeapConfig(t,e,i){Si.UpdateHeapConfig(t,e,i),r(this,no,xo)[t]||(r(this,no,xo)[t]={}),e&&(r(this,no,xo)[t].maxHeapSize=e),i&&(r(this,no,xo)[t].initHeapSize=i);}static async getLicenseInfo(t,e,i){this.Init(t,e,i),await Oi.updateLicense(r(this,no,lo),r(this,no,ho),r(this,no,co));const s=new Ei(r(this,no,lo));try{return await s.getLicenseInfo()}finally{s.terminate();}}static Init(t,e,i){var s;a(this,no,lo,null!=t?t:r(this,no,lo)),void 0!==e&&a(this,no,ho,e?1:0),a(this,no,co,null!=i?i:r(this,no,co));const n={bMac:"Mac"===ps.OS,biPhone:"iPhone"===ps.OS,biPad:"iPad"===ps.OS};a(this,no,mo,n.bMac||n.biPhone||n.biPad),Si.NavInfo=n,Si.License=r(this,no,lo),Si.UUID=r(this,no,co),Si.LicMode=r(this,no,ho),l(this,no,ao).call(this),Si.UpdateHeapConfig(so.detector,null!==(s=l(this,no,ro).call(this,so.detector))&&void 0!==s?s:100);}static async isResourceDirValid(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;l(this,no,ao).call(this);let i=0;for(;i<t;){try{const t=Si.PdfReaderModule;if(r(this,no,yo)===t.script)return !0;const e={...t.fetchOptions};e.method="HEAD";if((await fetch(t.script,e)).ok)return a(this,no,yo,t.script),!0}catch(t){}await new Promise((t=>setTimeout(t,e))),i+=1;}return !1}static async isResourceVersionMatch(){l(this,no,ao).call(this);const t=new Ei(r(this,no,lo));try{return this.version===await t.getWasmVersion()}catch(t){return !1}finally{t.terminate();}}static async loadPdfReader(t,e,i){return this.Init(t,e,i),r(this,no,fo)||(await Ai.Instance.loadModule(Si.ImageProcModule),a(this,no,fo,Ai.Instance.loadModule(Si.PdfReaderModule)),await r(this,no,fo)),r(this,no,fo)}static async loadMain(t,e,i){return this.Init(t,e,i),r(this,no,vo)||Ai.Instance.loadModule(Si.ImageProcModule),r(this,no,vo)}static async load(t,e,i){Ai.Instance.terminate(!0),this.Init(t,e,i),await this.loadMain(t,e,i);}static async preloadModule(t){let e;Si.PdfReaderModule;const i={...Si.ImageProcModule};switch(t){case"core":case"pdf":if(r(this,no,vo)){e=r(this,no,vo);break}a(this,no,vo,Ai.Instance.loadModule(Si.ImageIOModule)),e=r(this,no,vo),await r(this,no,vo);break;case"proc":if(r(this,no,fo)){e=r(this,no,fo);break}a(this,no,fo,Ai.Instance.loadModule(i)),e=r(this,no,fo),await r(this,no,fo);}return e}static unloadMainWorker(){a(this,no,vo,void 0),Ai.Instance.terminateWorker(Si.ImageIOModule.workerName);}static unloadPdfReaderWorker(){a(this,no,fo,void 0),Ai.Instance.terminateWorker(Si.PdfReaderModule.workerName);}static unloadDocumentDetectorWorker(){Ai.Instance.terminateWorker(Si.DetectorModule.workerName);}static async unloadWorker(){a(this,no,vo,void 0),a(this,no,fo,void 0),await Ai.Instance.terminate(!0);}static async unload(){Ai.unload(),Oi.unload(),Si.unload(),a(this,no,vo,void 0),a(this,no,fo,void 0);try{await Ai.Instance.terminate(!0);}catch(t){}}static getUseSimd(){if(this.enableSimd){var t;const e=navigator;if(null!==(t=e.userAgentData)&&void 0!==t&&t.brands)for(const{brand:t,version:i}of e.userAgentData.brands)if(t&&("Chromium"===t||"Google Chrome"===t)&&i&&parseInt(i,10)>=94)return !0}return !1}static getPdfFonts(){return os.getPdfFonts()}static async getPdfInfo(t,e){let i;try{i=new os;const s=await i.getPdfInfo({fileSource:t,password:e});return i.destroy(),s}catch(t){return null}finally{i&&i.destroy();}}}function oo(t){return t instanceof ArrayBuffer?{type:"ArrayBuffer",length:t.byteLength}:t instanceof Uint8ClampedArray?{type:"Uint8ClampedArray",length:t.byteLength}:{type:Object.prototype.toString.call(t)}}function ro(t){return void 0!==r(this,io,xo)[t]?r(this,io,xo)[t].maxHeapSize:null}function ao(){this.enableSimd?Si.UseSimd=this.getUseSimd():Si.UseSimd=!1,Si.UseBrotli=this.enableWasmCompression;const t={resourceDir:this.resourceDir,workerScript:"",useFastCompEdition:!1,useSimd:Si.UseSimd,fetchOptions:this.fetchOptions,useBrotli:Si.UseBrotli};t.workerScript=Si.ImageIOWorkerJS,Si.ImageIOResource=t;const e={...t};e.workerScript=Si.UseSimd?Si.ImageProcSimdWorkerJS:Si.ImageProcWorkerJS,Si.ImageProcResource=e;}io=no,i(no,"resourceDir","");var lo={writable:!0,value:""},ho={writable:!0,value:T.LONG_KEY},co={writable:!0,value:""};i(no,"fetchOptions",{mode:"cors",credentials:"same-origin",retries:3,retryDelay:500}),i(no,"enableSimd",!0),i(no,"enableWasmCompression",!1);var uo,po,go,fo={writable:!0,value:void 0},vo={writable:!0,value:void 0},mo={writable:!0,value:!1},yo={writable:!0,value:void 0},xo={writable:!0,value:Object.create(null)};class wo{constructor(){i(this,"processor",void 0),this.processor=new ns;}async initImage(t){return this.processor.initImage(t.source,t.isRGBA,t.width,t.height,t.isBGRA)}async getImage(t){return await this.processor.getImage(t.jpegQuality,t.ifDeleteObject,t.isRGBA,t.bitDepth,t.xDpi,t.yDpi,t.returnType,t.outputType,no.isApple)}async getImageInfo(){return await this.processor.getImageInfo()}async freeReservedData(){this.processor.freeReservedData();}async toBinaryLevel(t,e){return this.processor.toBinaryLevel(t,e)}async toGrayscale(t){return this.processor.toGrayscale(t)}async removeShadowLevel(t,e){return this.processor.removeShadowLevel(t,e)}async brighten(){return this.processor.brighten()}async invert(){return this.processor.invert()}async changeBrightnessAndContrast(t,e){return this.processor.changeBrightnessAndContrast(t,e)}async perspective(t){return this.processor.perspective(t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1],t[3][0],t[3][1])}async getSkewAngle(t){return this.processor.getSkewAngle(t)}async rotate(t){return this.processor.rotate(t.angle,t.fillColor,t.keepSize,t.mode)}async flip(){return this.processor.flip()}async resize(t,e,i){return this.processor.resize(t,e,i)}async resizeWidth(t,e){return this.processor.setImageWidth(t,e)}async resizeHeight(t,e){return this.processor.setImageHeight(t,e)}async crop(t){return this.processor.crop(t.left,t.top,t.left+t.width,t.top+t.height)}async erase(t,e){return this.processor.erase(t.left,t.top,t.left+t.width,t.top+t.height,e)}async setDpi(t){return this.processor.setDPI(t.rawResolutionX,t.rawResolutionY,t.resolutionX,t.resolutionY,t.resample,t.mode)}async drawQuadrangle(t){return this.processor.drawQuadrangle(t.location[0][0],t.location[0][1],t.location[1][0],t.location[1][1],t.location[2][0],t.location[2][1],t.location[3][0],t.location[3][1],t)}async filter(t,e,i){return this.processor.filter(t,e,i)}async setImageWidth(t,e){return this.processor.setImageWidth(t,e)}async setImageHeight(t,e){return this.processor.setImageHeight(t,e)}terminate(t){return this.processor.terminate(t)}}class bo{constructor(){i(this,"reader",void 0),this.reader=new Ni;}async readImage(t){return await this.reader.readImage(t.source,t.outputType,t.jpegQuality,t.returnType,no.isApple)}async readImageInfo(t){return await this.reader.readImageInfo(t)}cancelReadImage(t,e){this.reader.cancelReadImage(t,e);}async readTiffPage(t){return await this.reader.readTiffPage(t.source,t.index,t.outputType,t.returnType,no.isApple)}async readTiffPageInfo(t,e){const{imageInfos:i}=await this.reader.getTiffPageInfos(t,e);return i}async getTiffPageCount(t){return (await this.reader.getTiffInfo(t)).pageCount}cancelReadTiffPage(t,e){this.reader.cancelReadTiffPage(t,e);}destroy(){var t;null===(t=this.reader)||void 0===t||t.destroy(),this.reader=void 0;}}!function(t){t[t.RGBA=1]="RGBA",t[t.BGRA=2]="BGRA",t[t.JPEG=3]="JPEG",t[t.PNG=4]="PNG";}(uo||(uo={})),function(t){t[t.IT_DIB=-1]="IT_DIB",t[t.IT_RGBA=-2]="IT_RGBA",t[t.IT_BGRA=-3]="IT_BGRA",t[t.IT_BMP=0]="IT_BMP",t[t.IT_JPG=1]="IT_JPG",t[t.IT_PNG=3]="IT_PNG",t[t.IT_ALL=5]="IT_ALL";}(po||(po={})),function(t){t[t.RT_AUTO=-1]="RT_AUTO",t[t.RT_BINARY=1]="RT_BINARY",t[t.RT_BASE64=2]="RT_BASE64";}(go||(go={}));class So{constructor(){i(this,"writer",void 0),this.writer=new Ei;}terminate(){var t;null===(t=this.writer)||void 0===t||t.terminate(),this.writer=void 0;}createTiff(){return this.writer.createTiff()}addTiffTag(t,e,i){return this.writer.addTag(t,e,i)}async appendImage(t,e){var i;e=null!==(i=e)&&void 0!==i?i:{};return await this.writer.appendImage(t,e.inputType,e.tiffFormat,e.jpegQuality,e.is1Bit)}async getTiff(){return (await this.writer.getTiff(go.RT_AUTO)).imageData}async saveImage(t,e){var i;e=null!==(i=e)&&void 0!==i?i:{};return (await this.writer.saveImage(t,e.outputType,e.jpegQuality,e.returnType,e.is1Bit)).imageData}}class Co{constructor(){i(this,"reader",void 0),this.reader=new os;}initFonts(t){if(t)for(const e of t)e.name&&e.data&&Co.addPdfFont(e.name,e.data);}static addPdfFont(t,e){os.addPdfFont(t,e);}async readPageImageInfos(t){var e;await this.initFonts(null===(e=t.readOptions)||void 0===e||null===(e=e.renderOptions)||void 0===e?void 0:e.fonts);const{imageInfos:i}=await this.reader.readPageImageInfos(t.source,t.indices,t.readOptions,t.outputType,t.isInfoOnly,t.returnType,no.isApple);return i}async readPage(t){var e;await this.initFonts(null===(e=t.readOptions)||void 0===e||null===(e=e.renderOptions)||void 0===e?void 0:e.fonts);return await this.reader.readPageEx(t.source,t.index,t.readOptions,t.outputType,t.isInfoOnly,t.returnType,no.isApple)}async renderPage(t,e){var i;if(e.canceled)return null;if(await this.initFonts(null===(i=t.renderOptions)||void 0===i?void 0:i.fonts),e.canceled)return null;const s=await this.reader.renderPage(t.source,t.index,t.width,t.height,{rect:[t.rect[0],t.rect[1],t.rect[2],t.rect[3]],renderOptions:t.renderOptions,outputType:t.outputType,returnType:t.returnType,is1BitTo8Bit:no.isApple},e.taskUid);return e.canceled?null:s}cancelReadPage(t,e){this.reader.cancelReadPage(t,e);}cancelRenderPage(t){this.reader.cancelRenderPage(t.taskUid);}async getPdfPageCount(t,e){var i;await this.initFonts(null==e||null===(i=e.renderOptions)||void 0===i?void 0:i.fonts);return (await this.reader.getPdfInfo(t)).PdfCount}async getPdfPageContentType(t,e){const i=await this.reader.getPdfPageType(t,e);return 1===i.pageContentType?"application/pdf/text":2===i.pageContentType?"application/pdf/image":"application/pdf"}async readAnnotations(t,e){const{annot:{annots:i}}=await this.reader.readPageAnnot(t,e);return i}async findText(t,e,i,s){return await this.reader.findText(t,e,i,s)}async getCharInfos(t,e){return (await this.reader.getCharInfos(t,e)).pageCharInfos}destroy(){this.reader.destroy(),this.reader=null;}}class Po{constructor(){i(this,"writer",void 0),this.writer=new rs;}terminate(){var t;null===(t=this.writer)||void 0===t||t.terminate(),this.writer=null;}async initPdfSetting(t){return this.writer.initPdfSetting(t)}async insertBlankPage(t,e,i){return this.writer.insertBlankPage(t,e,i)}async insertBlankPages(t,e,i,s){return this.writer.insertBlankPages(t,e,i,s)}async appendPage(t,e){return this.writer.appendPage(t,e)}async addImageToPages(t,e,i,s,n,o){return this.writer.pageAddImage(t,e,i,s,n,o)}async mergeRawPdfPages(t,e,i){return this.writer.mergePdf(t,e,i)}async replaceRawPdfPages(t,e,i,s){return this.writer.replacePdfPages(t,e,i,s)}async setPageRotation(t,e){return this.writer.pageSetRotation(t,e)}async clearPageObjects(t){return this.writer.pageClearObjects(t)}async setPageCropBox(t,e,i,s,n){return this.writer.pageSetCropBox(t,e,i,s,n)}async setPageMediaBox(t,e,i,s,n){return this.writer.pageSetMediaBox(t,e,i,s,n)}async setPageAnnotations(t,e){return this.writer.pageSetAnnot(t,e)}async addAnnotationsToPage(t,e){return this.writer.pageAddAnnot(t,e)}async flattenPageAnnotations(t,e){return this.writer.pageFlattenAnnot(t,e)}async deletePageAnnotationsByTypes(t,e){return this.writer.pageDeleteAnnotByTypes(t,e)}async deletePageAnnotationsExceptTypes(t,e){return this.writer.pageDeleteAnnotExceptTypes(t,e)}async deletePageAnnotations(t){return this.writer.pageDeleteAnnot(t)}async flattenPage(t,e){return this.writer.pageFlatten(t,e)}async redactPage(t,e){return this.writer.pageRedact(t,e)}async deletePage(t){return this.writer.deletePage(t)}async movePages(t,e){return this.writer.movePages(t,e)}async getPdf(t){return (await this.writer.writePdf(t)).pdfData}async getFontInfo(t){return await this.writer.GetFontInfo(t)}async ifFontsExist(t){return (await this.writer.IfFontsExist(t)).fontsExist}async unloadPage(t){var e,i;await(null===(e=(i=this.writer).UnloadPage)||void 0===e?void 0:e.call(i,t));}}class To{constructor(t){i(this,"items",[]),t&&(this.items=t);}push(t){this.items.push(t);}pop(){return this.items.pop()}peek(){return this.items[this.items.length-1]}isEmpty(){return 0===this.items.length}size(){return this.items.length}remove(t){const e=this.items.findIndex((e=>e.api===t.api));if(-1!==e){const t=this.items[e];this.items.splice(e,1),t.resolve(null);}}}var Ao=new WeakMap,ko=new WeakMap,Do=new WeakSet;class Ro{constructor(){v(this,Do),f(this,Ao,{writable:!0,value:new To}),f(this,ko,{writable:!0,value:!1});}handler(t){return Promise.resolve(null)}createTask(t,e,i){const o={api:t,taskInfo:i,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)o.params.push(t);return o.promise=new Promise(((t,e)=>{o.resolve=t,o.reject=e;})),s(this,Ao).push(o),s(this,ko)||(n(this,ko,!0),p(this,Do,Eo).call(this)),o.promise}cancelTask(t,e,i){const n={api:t,taskInfo:i,params:[],promise:void 0,resolve:void 0,reject:void 0,retry:0};for(const t of e)n.params.push(t);s(this,Ao).remove(n);}}async function Eo(){if(s(this,Ao).isEmpty())n(this,ko,!1);else {for(;!s(this,Ao).isEmpty();){const t=s(this,Ao).pop();if(t.taskInfo.canceled)t.resolve(null);else try{const e=await this.handler(t);e&&(e.taskInfo=t.taskInfo),t.resolve(e);}catch(e){t.retry<1?(t.retry+=1,s(this,Ao).push(t)):null==t||t.reject(e);}}n(this,ko,!1);}}const Mo={[uo.BGRA]:po.IT_BGRA,[uo.RGBA]:po.IT_RGBA,[uo.PNG]:po.IT_PNG,[uo.JPEG]:po.IT_JPG},Io={[po.IT_BGRA]:uo.BGRA,[po.IT_RGBA]:uo.RGBA,[po.IT_PNG]:uo.PNG,[po.IT_JPG]:uo.JPEG},Bo={displayResolution:96,dataResolution:72,pdfResolution:72,enableResolution:!0,autoReleaseImg:$s(),autoReleaseBlob:!0,loadRawPageTimeout:2e4,defaultRenderPageWidth:1654,defaultRenderPageHeight:2339};class Uo{constructor(){i(this,"db",void 0),this.db=new Map;}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}getSaverConstructor(t){return this.db.get(t)}setSaverConstructor(t,e){this.db.set(t,e);}deleteSaverConstructor(t){this.db.delete(t);}clear(){this.db.clear();}}const Lo=new Uo,Oo=new Uo;const No=new class{constructor(t,e){i(this,"saverConstructorRepo",void 0),i(this,"customSaverConstructorRepo",void 0),this.saverConstructorRepo=t,this.customSaverConstructorRepo=e;}execute(t){let e=this.customSaverConstructorRepo.getSaverConstructor(t);e||(e=this.saverConstructorRepo.getSaverConstructor(t));return new e}}(Lo,Oo),_o=new class{constructor(t){i(this,"saverConstructorRepo",void 0),this.saverConstructorRepo=t;}execute(t){let{mime:e,saverConstructor:i}=t;this.saverConstructorRepo.setSaverConstructor(e,i);}}(Lo),Wo=new class{constructor(t){i(this,"saverConstructorRepo",void 0),this.saverConstructorRepo=t;}execute(t){this.saverConstructorRepo.deleteSaverConstructor(t);}}(Lo);var Fo,Ho,Vo,zo;!function(t){t.TIFF_AUTO="tiff/auto",t.TIFF_FAX3="tiff/fax3",t.TIFF_FAX4="tiff/fax4",t.TIFF_LZW="tiff/lzw",t.TIFF_JPEG="tiff/jpeg";}(Fo||(Fo={})),function(t){t.PDF_AUTO="pdf/auto",t.PDF_FAX4="pdf/fax4",t.PDF_LZW="pdf/lzw",t.PDF_JPEG="pdf/jpeg",t.PDF_JP2000="pdf/jp2000",t.PDF_JBIG2="pdf/jbig2";}(Ho||(Ho={})),function(t){t.PAGE_DEFAULT="page/default",t.PAGE_A4="page/a4",t.PAGE_A4_REVERSE="page/a4reverse",t.PAGE_A3="page/a3",t.PAGE_A3_REVERSE="page/a3reverse",t.PAGE_LETTER="page/letter",t.PAGE_LETTER_REVERSE="page/letterreverse",t.PAGE_LEGAL="page/legal",t.PAGE_LEGAL_REVERSE="page/legalreverse";}(Vo||(Vo={})),function(t){t.PRINT="print",t.MODIFY_CONTENTS="modify_contents",t.COPY_CONTENTS="copy_contents",t.EXTRACT_CONTENTS="extract_contents",t.MODIFY_ANNOTATIONS="modify_annotations",t.FILL_IN="fill_in",t.ASSEMBLY="assembly",t.DEGRADED_PRINT="degraded_print";}(zo||(zo={})),new Map([[zo.PRINT,2052],[zo.MODIFY_CONTENTS,8],[zo.COPY_CONTENTS,16],[zo.MODIFY_ANNOTATIONS,32],[zo.FILL_IN,256],[zo.EXTRACT_CONTENTS,512],[zo.ASSEMBLY,1024],[zo.DEGRADED_PRINT,4]]);const $o=new Map([[Vo.PAGE_DEFAULT,0],[Vo.PAGE_A4,2],[Vo.PAGE_A4_REVERSE,3],[Vo.PAGE_A3,4],[Vo.PAGE_A3_REVERSE,5],[Vo.PAGE_LETTER,6],[Vo.PAGE_LETTER_REVERSE,7],[Vo.PAGE_LEGAL,8],[Vo.PAGE_LEGAL_REVERSE,9]]),jo=new Map([[Ho.PDF_AUTO,0],[Ho.PDF_FAX4,2],[Ho.PDF_LZW,3],[Ho.PDF_JPEG,5],[Ho.PDF_JP2000,6],[Ho.PDF_JBIG2,7]]),Xo=new Map([[Fo.TIFF_AUTO,0],[Fo.TIFF_FAX3,1],[Fo.TIFF_FAX4,2],[Fo.TIFF_LZW,3],[Fo.TIFF_JPEG,5]]);var Go=new WeakMap,Yo=new WeakMap,qo=new WeakMap;class Jo{constructor(){f(this,Go,{writable:!0,value:void 0}),f(this,Yo,{writable:!0,value:void 0}),f(this,qo,{writable:!0,value:void 0}),n(this,Go,new Po),n(this,Yo,new Map);}destroy(){var t;null===(t=s(this,Go))||void 0===t||t.terminate(),n(this,Go,void 0);}convertPageSize(t,e){let i=0,s=0,n=0,o=0,r=0,a=0,l=0,h=0;const{pdfResolution:c,displayResolution:d}=Bo;switch(t){case Vo.PAGE_A4:n=210/25.4*c,o=297/25.4*c,l=n,a=o;break;case Vo.PAGE_A4_REVERSE:n=297/25.4*c,o=210/25.4*c,l=n,a=o;break;case Vo.PAGE_A3:n=297/25.4*c,o=420/25.4*c,l=n,a=o;break;case Vo.PAGE_A3_REVERSE:n=420/25.4*c,o=297/25.4*c,l=n,a=o;break;case Vo.PAGE_LETTER:n=8.5*c,o=11*c,l=n,a=o;break;case Vo.PAGE_LETTER_REVERSE:n=11*c,o=8.5*c,l=n,a=o;break;case Vo.PAGE_LEGAL:n=8.5*c,o=14*c,l=n,a=o;break;case Vo.PAGE_LEGAL_REVERSE:n=14*c,o=8.5*c,l=n,a=o;break;default:i=e.mediaBox.left/d*c,s=e.mediaBox.top/d*c,n=e.mediaBox.width/d*c,o=e.mediaBox.height/d*c,r=e.cropBox.left/d*c,a=2*s+o-e.cropBox.top/d*c,l=Math.max(r+e.cropBox.width/d*c,r+1),h=Math.min(a-e.cropBox.height/d*c,a-1);}return {left:i,top:s,width:n,height:o,cropLeft:r,cropTop:a,cropRight:l,cropBottom:h}}convertPdfSettings(t){const e={};return e.author=null==t?void 0:t.author,e.compression=null!=t&&t.compression?jo.get(t.compression):void 0,e.creationDate=null==t?void 0:t.creationDate,e.creator=null==t?void 0:t.creator,e.keyWords=null==t?void 0:t.keyWords,e.modifiedDate=null==t?void 0:t.modifiedDate,e.pageType=null!=t&&t.pageType?$o.get(t.pageType):void 0,e.producer=null==t?void 0:t.producer,e.quality=null==t?void 0:t.quality,e.subject=null==t?void 0:t.subject,e.title=null==t?void 0:t.title,e.version=null==t?void 0:t.version,null!=t&&t.password&&(e.encryptOptions={},e.encryptOptions.enabled=!0,e.encryptOptions.userPassword=t.password),e}async init(t){n(this,qo,t||{});const e=this.convertPdfSettings(t);await s(this,Go).initPdfSetting(e);}async appendBlankPages(t,e,i){await s(this,Go).insertBlankPages(-1,t,e,i);}async applyImageToPage(t,e,i){const{mediaBox:n,cropBox:o}=i,r=this.convertPageSize(s(this,qo).pageType,i);await s(this,Go).setPageMediaBox(t,r.left,r.top,r.left+r.width,r.top+r.height),i.rotation&&await s(this,Go).setPageRotation(t,i.rotation);const{displayResolution:a,pdfResolution:l}=Bo;let h=r.width,c=r.height,d=0,u=0;if(s(this,qo).pageType&&s(this,qo).pageType!==Vo.PAGE_DEFAULT){const e={width:o.width/a*l,height:o.height/a*l},i=r.width/e.width,p=r.height/e.height;if(i<p){const t=e.height*i;u=(r.height-t)/2,h=r.width,c=t;}else {const t=e.width*p;d=(r.width-t)/2,h=t,c=r.height;}const g=o.left/a*l,f=(n.height-(o.top+o.height))/a*l;s(this,Yo).set(t,[h/e.width,0,0,c/e.height,d-h/e.width*g,u-c/e.height*f]);}d+=r.left,u+=r.top;let p=i.width,g=i.height,f=e;if(s(this,qo).imageScaleFactor){let t=Math.floor(i.width*s(this,qo).imageScaleFactor+.5),n=Math.floor(i.height*s(this,qo).imageScaleFactor+.5);if(t<1&&(t=1),n<1&&(n=1),t!==p&&n!==g){const i=new wo;await i.initImage({source:e}),await i.resize(t,n);f=(await i.getImage({})).imageData,p=t,g=n,await i.freeReservedData();}}const v=await s(this,Go).addImageToPages(f,[t],{imageWidth:h,imageHeight:c,position:[d,u]},p,g,1===i.bitDepth);return await s(this,Go).setPageCropBox(t,r.cropLeft,r.cropBottom,r.cropRight,r.cropTop),await s(this,Go).unloadPage(t),v}async appendImagePage(t,e){const{mediaBox:i}=e,n=this.convertPageSize(s(this,qo).pageType,e);let o=await s(this,Go).insertBlankPage(-1,n.left+n.width,n.top+n.height);const{pageIndex:r}=o;await s(this,Go).setPageMediaBox(r,n.left,n.top,n.left+n.width,n.top+n.height),e.rotation&&await s(this,Go).setPageRotation(r,e.rotation);const{displayResolution:a,pdfResolution:l}=Bo;let h=n.width,c=n.height,d=0,u=0;if(s(this,qo).pageType&&s(this,qo).pageType!==Vo.PAGE_DEFAULT){const t={width:i.width/a*l,height:i.height/a*l},e=n.width/t.width,o=n.height/t.height;if(e<o){const i=t.height*e;u=(n.height-i)/2,h=n.width,c=i;}else {const e=t.width*o;d=(n.width-e)/2,h=e,c=n.height;}s(this,Yo).set(r,[h/t.width,0,0,c/t.height,d,u]);}d+=n.left,u+=n.top;let p=e.width,g=e.height,f=t;if(s(this,qo).imageScaleFactor){let i=Math.floor(e.width*s(this,qo).imageScaleFactor+.5),n=Math.floor(e.height*s(this,qo).imageScaleFactor+.5);if(i<1&&(i=1),n<1&&(n=1),i!==p&&n!==g){const e=new wo;await e.initImage({source:t}),await e.resize(i,n);f=(await e.getImage({})).imageData,p=i,g=n,await e.freeReservedData();}}return o=await s(this,Go).addImageToPages(f,[r],{imageWidth:h,imageHeight:c,position:[d,u]},p,g,1===e.bitDepth),await s(this,Go).setPageCropBox(r,n.cropLeft,n.cropBottom,n.cropRight,n.cropTop),await s(this,Go).unloadPage(r),o}async appendRawPdfPages(t,e,i){await s(this,Go).mergeRawPdfPages(t,e,i);}async replaceRawPdfPages(t,e,i,n){await s(this,Go).replaceRawPdfPages(t,e,i,n);}async changePageImage(t,e,i){const n=this.convertPageSize(Vo.PAGE_DEFAULT,i);await s(this,Go).clearPageObjects(t);return await s(this,Go).addImageToPages(e,[t],{imageWidth:n.width,imageHeight:n.height,position:[n.left,n.top]},i.width,i.height)}async setPageInfo(t){for(const[e,i]of t){const t=this.convertPageSize(Vo.PAGE_DEFAULT,i),{rotation:n}=i;await s(this,Go).setPageCropBox(e,t.cropLeft,t.cropBottom,t.cropRight,t.cropTop),await s(this,Go).setPageRotation(e,(n%360+360)%360);}}async setPageRotation(t){for(const[e,i]of t){const t=(i%360+360)%360;await s(this,Go).setPageRotation(e,t);}}async getPdf(t){if("application/pdf"===(t=t||"application/pdf"))return s(this,Go).getPdf(go.RT_AUTO);const e=await s(this,Go).getPdf(go.RT_BINARY);return new Blob([e],{type:t})}updateAnnotPoint(t,e){return [t[0]*e[0]+t[1]*e[2]+e[4],t[0]*e[1]+t[1]*e[3]+e[5]]}fixAnnotationPosition(t,e){s(this,Yo).has(t)&&e.forEach((e=>{const i=this.updateAnnotPoint([e.rect[0],e.rect[1]],s(this,Yo).get(t)),n=this.updateAnnotPoint([e.rect[2],e.rect[3]],s(this,Yo).get(t));if(e.rect=[i[0],i[1],n[0],n[1]],"Highlight"===e.type||"StrikeOut"===e.type||"Underline"===e.type||"Squiggly"===e.type)e.quadPoints.forEach(((i,n)=>{const o=this.updateAnnotPoint([i[0],i[1]],s(this,Yo).get(t)),r=this.updateAnnotPoint([i[2],i[3]],s(this,Yo).get(t)),a=this.updateAnnotPoint([i[4],i[5]],s(this,Yo).get(t)),l=this.updateAnnotPoint([i[6],i[7]],s(this,Yo).get(t));e.quadPoints[n]=[o[0],o[1],r[0],r[1],a[0],a[1],l[0],l[1]];}));else if("Line"===e.type){const i=this.updateAnnotPoint([e.line[0],e.line[1]],s(this,Yo).get(t)),n=this.updateAnnotPoint([e.line[2],e.line[3]],s(this,Yo).get(t));e.line=[i[0],i[1],n[0],n[1]];}else if("Ink"===e.type)e.inkList.forEach((e=>{for(let i=0;i<e.length;i+=2){const[n,o]=this.updateAnnotPoint([e[i],e[i+1]],s(this,Yo).get(t));e[i]=n,e[i+1]=o;}}));else if("Polygon"===e.type||"PolyLine"===e.type)for(let i=0;i<e.vertices.length;i+=2){const[n,o]=this.updateAnnotPoint([e.vertices[i],e.vertices[i+1]],s(this,Yo).get(t));e.vertices[i]=n,e.vertices[i+1]=o;}}));}async removePageAnnotations(t){await s(this,Go).deletePageAnnotationsExceptTypes(t,"Widget");}async setPageAnnotations(t,e,i){let n;return e&&e.length>0&&this.fixAnnotationPosition(t,e),i?e&&e.length>0&&(n=await s(this,Go).addAnnotationsToPage(t,e)):n=await s(this,Go).setPageAnnotations(t,e),n}async flattenPageAnnotations(t,e){e&&e.length>0&&this.fixAnnotationPosition(t,e);return await s(this,Go).flattenPageAnnotations(t,e)}async flattenPage(t){return await s(this,Go).flattenPage(t)}async redactPageAnnotations(t,e){e&&e.length>0&&this.fixAnnotationPosition(t,e);return await s(this,Go).redactPage(t,e)}async getFontInfo(t){return await s(this,Go).getFontInfo(t)}async ifFontsExist(t){return await s(this,Go).ifFontsExist(t)}}class Zo{constructor(){i(this,"imageWriter",void 0),this.imageWriter=new So;}destroy(){var t;null===(t=this.imageWriter)||void 0===t||t.terminate(),this.imageWriter=void 0;}async save(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await this.imageWriter.saveImage(t,{outputType:e.outputType,jpegQuality:e.jpegQuality,returnType:e.returnType,is1Bit:e.is1Bit})}}class Qo{constructor(){i(this,"imageWriter",void 0),i(this,"tiffCompression",void 0),i(this,"tiffQuality",void 0),this.imageWriter=new So,this.tiffCompression=Xo.get(Fo.TIFF_AUTO);}destroy(){var t;null===(t=this.imageWriter)||void 0===t||t.terminate(),this.imageWriter=void 0;}async init(t){if(await this.imageWriter.createTiff(),t&&(this.tiffQuality=t.quality,t.compression&&(this.tiffCompression=Xo.get(t.compression)),t.customTag))for(let e=0;e<t.customTag.length;e++)await this.imageWriter.addTiffTag(t.customTag[e].id,t.customTag[e].content,t.customTag[e].contentIsBase64);}async appendPage(t,e){await this.imageWriter.appendImage(t,{inputType:void 0,tiffFormat:this.tiffCompression,jpegQuality:this.tiffQuality,is1Bit:null==e?void 0:e.is1Bit});}async getTiff(){return this.imageWriter.getTiff()}}class Ko{constructor(t){i(this,"uid",void 0),this.uid=t||qs();}equals(t){return null!=t&&void 0!==t&&(this===t||!!function(t){return t instanceof Ko}(t)&&this.uid===t.uid)}}class tr extends Ko{}class er{constructor(t){i(this,"type",void 0),i(this,"uid",void 0),this.type=t,this.uid=qs();}}class ir{constructor(t){i(this,"bubbles",!0),i(this,"cancelBubble",!0),i(this,"cancelable",!1),i(this,"composed",!1),i(this,"currentTarget",void 0),i(this,"defaultPrevented",!1),i(this,"eventPhase",ir.prototype.NONE),i(this,"isTrusted",void 0),i(this,"returnValue",void 0),i(this,"srcElement",void 0),i(this,"target",void 0),i(this,"timeStamp",void 0),i(this,"type",void 0),i(this,"detail",void 0),i(this,"view",void 0),i(this,"which",void 0),i(this,"path",void 0),i(this,"immediatePropagationStopped",!1),i(this,"propagationStopped",!1),i(this,"nativeEvent",void 0),i(this,"originalEvent",void 0),i(this,"eventService",void 0),i(this,"NONE",0),i(this,"CAPTURING_PHASE",1),i(this,"AT_TARGET",2),i(this,"BUBBLING_PHASE",3),this.eventService=t;}initUIEvent(t,e,i,s,n){}composedPath(){const{path:t,eventService:e,target:i}=this;return !e||t&&t[this.path.length-1]===i||(this.path=i?e.getPropagationPath(i):[]),this.path}bindEvents(t,e,i){}preventDefault(){const{nativeEvent:t}=this;t instanceof Event&&t.cancelable&&t.preventDefault(),this.defaultPrevented=!0;}stopImmediatePropagation(){this.immediatePropagationStopped=!0;}stopPropagation(){this.propagationStopped=!0;}}function sr(t,e){e.isTrusted=t.isTrusted,e.srcElement=t.srcElement,e.timeStamp=performance.now(),e.type=t.type,e.detail=t.detail,e.view=t.view,e.which=t.which;}class nr extends ir{constructor(t,e){super(null),this.type=t,this.detail=e;}}class or{constructor(){i(this,"pubsub",Qs.create());}addEventListener(t,e,i){let s,n=Vs(i)&&i;Os(i)&&(n=i.capture,s=i.once),t=n?`${t}:capture`:t,e=zs(e)?e:e.handleEvent,this.pubsub.on(t,e,this,s);}dispatchEvent(t){const e=this.ownerDocument||this.document;var i;e&&(t.eventService=(null===(i=e.defaultView)||void 0===i?void 0:i.eventService)||null,t.defaultPrevented=!1,t.path=[],t.target=this,ar(t));return !t.defaultPrevented}removeEventListener(t,e,i){let s=Vs(i)&&i;Os(i)&&(s=i.capture),t=s?`${t}:capture`:t,e=zs(e)?e:e.handleEvent,this.pubsub.off(t,e);}removeAllEventListeners(){this.pubsub.removeAllEventListeners();}getAllEvents(){return this.pubsub.getAllEvents()}}function rr(t,e){const i=t.currentTarget.getAllEvents()[e]||[];for(let e=0,s=i.length;e<s;e++){if(t.immediatePropagationStopped)return;const{context:s,fn:n}=i[e];n.call(s,t);}}function ar(t,e){var i;if(e=null!==(i=e)&&void 0!==i?i:t.type,t.propagationStopped=!1,t.immediatePropagationStopped=!1,!t.target)return;const s=t.composedPath(),n=s.length;t.eventPhase=t.CAPTURING_PHASE;for(let i=0;i<n-1;i++){t.currentTarget=s[i];if(rr(t,`${e}:capture`),lr(t))return}if(t.eventPhase=t.AT_TARGET,t.currentTarget=t.target,rr(t,e),!lr(t)){t.eventPhase=t.BUBBLING_PHASE;for(let i=n-2;i>=0;i--)if(t.currentTarget=s[i],rr(t,e),lr(t))return}}function lr(t){return t.propagationStopped||t.immediatePropagationStopped}const hr=t=>t/180*Math.PI,cr=t=>t/Math.PI*180;class dr{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,"x",0),i(this,"y",0),this.x=t,this.y=e;}static fromValue(t,e){return new dr(t,e)}static fromPoint(t){return new dr(t.x,t.y)}static fromTwoPoint(t,e){var i,s,n,o;return new dr((null!==(i=e.x)&&void 0!==i?i:0)-(null!==(s=t.x)&&void 0!==s?s:0),(null!==(n=e.y)&&void 0!==n?n:0)-(null!==(o=t.y)&&void 0!==o?o:0))}static create(){return new dr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)}setFromVector(t){this.x=t.x,this.y=t.y;}clone(){return new dr(this.x,this.y)}norm(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}projectionTo(t){const e=Math.hypot(t.x,t.y);return this.dot(t)/e}angle(t){const e=this.norm()*Math.hypot(t.x,t.y);return Math.acos(this.dot(t)/e)}equals(t){return this.x===t.x&&this.y===t.y}distance(t){return Math.hypot(this.x-t.x,this.y-t.y)}lerp(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;const{x:i,y:s}=this;return new dr(i+(t.x-i)*e,s+(t.y-s)*e)}normalize(){const t=this.norm();return this.x/=t,this.y/=t,this}negate(){return this.x*=-1,this.y*=-1,this}cross(t){return this.x*t.y-this.y*t.x}add(t){return new dr(this.x+t.x,this.y+t.y)}addSelf(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return new dr(this.x-t.x,this.y-t.y)}subSelf(t){return this.x-=t.x,this.y-=t.y,this}multiply(t){return new dr(this.x*t.x,this.y*t.y)}multiplySelf(t){return this.x*=t.x,this.y*=t.y,this}}class ur{constructor(t){i(this,"a",1),i(this,"b",0),i(this,"c",0),i(this,"d",1),i(this,"e",0),i(this,"f",0),i(this,"m11",1),i(this,"m12",0),i(this,"m13",0),i(this,"m21",0),i(this,"m22",1),i(this,"m23",0),i(this,"m31",0),i(this,"m32",0),i(this,"m33",1),t&&this.setFromMatrix(t);}static compose(t,e,i){const s=hr(i),n=Math.cos(s),o=Math.sin(s),r=e.x*n,a=e.x*o,l=-e.y*o,h=e.y*n,c=t.x,d=t.y;return ur.fromMatrix({m11:r,m21:l,m31:c,m12:a,m22:h,m32:d,m13:0,m23:0,m33:1})}static create(t){return new ur(t)}static fromMatrix(t){return (new ur).setFromMatrix(t)}static createRotationMatrix(t,e){const i=vr(t,e);return ur.fromMatrix(i)}static createTranslationMatrix(t){const e=gr(t.x,t.y);return ur.fromMatrix(e)}static createScaleMatrix(t){const e=fr(t.x,t.y);return ur.fromMatrix(e)}setFromMatrix(t){if(Array.isArray(t)){const[e,i,s,n,o,r]=t;this.m11=e,this.m12=i,this.m13=0,this.m21=s,this.m22=n,this.m23=0,this.m31=o,this.m32=r,this.m33=1;}else {var e,i,s,n,o,r,a,l,h,c,d,u,p,g,f;this.m11=null!==(e=null!==(i=t.m11)&&void 0!==i?i:t.a)&&void 0!==e?e:1,this.m12=null!==(s=null!==(n=t.m12)&&void 0!==n?n:t.b)&&void 0!==s?s:0,this.m13=null!==(o=t.m13)&&void 0!==o?o:0,this.m21=null!==(r=null!==(a=t.m21)&&void 0!==a?a:t.c)&&void 0!==r?r:0,this.m22=null!==(l=null!==(h=t.m22)&&void 0!==h?h:t.d)&&void 0!==l?l:1,this.m23=null!==(c=t.m23)&&void 0!==c?c:0,this.m31=null!==(d=null!==(u=t.m31)&&void 0!==u?u:t.e)&&void 0!==d?d:0,this.m32=null!==(p=null!==(g=t.m32)&&void 0!==g?g:t.f)&&void 0!==p?p:0,this.m33=null!==(f=t.m33)&&void 0!==f?f:1;}return this.a=this.m11,this.b=this.m12,this.c=this.m21,this.d=this.m22,this.e=this.m31,this.f=this.m32,this}clone(){return ur.fromMatrix(this)}translate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.clone().translateSelf(t,e)}translateSelf(){const t=gr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0);return this.multiplySelf(t)}multiplySelf(){const t=pr(this,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return this.setFromMatrix(t)}preMultiplySelf(){const t=pr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this);return this.setFromMatrix(t)}multiply(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.clone().multiplySelf(t)}scaleSelf(t,e,i,s){var n,o;void 0===e&&(e=t),null!==(n=i)&&void 0!==n||(i=0),null!==(o=s)&&void 0!==o||(s=0),0===i&&0===s||this.translateSelf(i,s);const r=fr(t,e);return this.multiplySelf(r)}scale(t,e,i,s){return this.clone().scaleSelf(t,e,i,s)}rotateSelf(t,e,i){var s,n;null!==(s=e)&&void 0!==s||(e=0),null!==(n=i)&&void 0!==n||(i=0);const o=vr(t,{x:e,y:i});return this.multiplySelf(o)}rotate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.clone().rotateSelf(t)}invertSelf(){const t=function(t){const{m11:e,m21:i,m31:s,m12:n,m22:o,m32:r}=t,a=1/(e*o-n*i);return {m11:o*a,m21:-i*a,m31:(i*r-o*s)*a,m12:-n*a,m22:e*a,m32:(n*s-e*r)*a,m13:0,m23:0,m33:1}}(this);return this.setFromMatrix(t)}inverse(){return this.clone().invertSelf()}getScaling(){const t=Math.hypot(this.m11,this.m12),e=Math.hypot(this.m21,this.m22);return new dr(t,e)}getScaleMatrix(){const t=this.getScaling(),e=fr(t.x,t.y);return ur.fromMatrix(e)}getTranslation(){return new dr(this.m31,this.m32)}getRotationMatrix(){const t=this.getScaling(),e={m11:this.m11/t.x,m12:this.m12/t.x,m13:0,m21:this.m21/t.y,m22:this.m22/t.y,m23:0,m31:0,m32:0,m33:1};return ur.fromMatrix(e)}getRotation(){const t=Math.atan2(this.m12,this.m11);return cr(t)}decompose(){let{m11:t,m12:e,m21:i,m22:s}=this;const n={x:this.m31,y:this.m32},o={x:Math.hypot(t,e),y:Math.hypot(i,s)};t*s-e*i<0&&(t<s?o.x=-o.x:o.y=-o.y),o.x&&(t/=o.x,e/=o.x),o.y&&(i/=o.y,s/=o.y);const r=Math.atan2(e,t);return {translation:n,scale:o,rotation:cr(r)}}transformPoint(t){const{m11:e,m12:i,m21:s,m22:n,m31:o,m32:r}=this;return {x:t.x*e+t.y*s+o,y:t.x*i+t.y*n+r}}}function pr(t,e){const i={},{m11:s,m21:n,m31:o,m12:r,m22:a,m32:l,m13:h,m23:c,m33:d}=t,{m11:u,m21:p,m31:g,m12:f,m22:v,m32:m,m13:y,m23:x,m33:w}=e;return i.m11=s*u+n*f+o*y,i.m21=s*p+n*v+o*x,i.m31=s*g+n*m+o*w,i.m12=r*u+a*f+l*y,i.m22=r*p+a*v+l*x,i.m32=r*g+a*m+l*w,i.m13=h*u+c*f+d*y,i.m23=h*p+c*v+d*x,i.m33=h*g+c*m+d*w,i}function gr(){return {m11:1,m21:0,m31:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,m12:0,m22:1,m32:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,m13:0,m23:0,m33:1}}function fr(){return {m11:arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,m21:0,m31:0,m12:0,m22:arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,m32:0,m13:0,m23:0,m33:1}}function vr(){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{x:0,y:0};const e=hr(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0),i=Math.cos(e),s=Math.sin(e),{x:n,y:o}=t;return {m11:i,m21:-s,m31:n-n*i+o*s,m12:s,m22:i,m32:o-n*s-o*i,m13:0,m23:0,m33:1}}const mr=new class{recursiveUpdateHierarchy(t){const{transform:e,childNodes:i}=t;e.frozen||(e.frozen=!0,(e.localDirty||e.worldDirty)&&this.updateHierarchy(t),i.forEach((t=>{this.recursiveUpdateHierarchy(t);})));}querySelector(t,e){return t.startsWith("#")?e.find((e=>e.id===t.substring(1))):null}querySelectorAll(t,e){return []}append(t,e,i){t.parentNode&&this.remove(t),t.parentNode=e;const{childNodes:s,sortable:n}=e;void 0!==i?s.splice(i,0,t):s.push(t),n&&(n.dirty=!0);const{transform:o}=t;o&&this.dirtyWorld(t,o),o.frozen&&this.unfreezeParentToRoot(t);}remove(t){const{parentNode:e}=t;let i=!0;if(!e)return i=!1,i;const{sortable:s}=e;s&&(s.dirty=!0);const{childNodes:n}=e,o=n.indexOf(t);o>-1?(i=!0,n.splice(o,1)):i=!1;const{transform:r}=t;return r&&this.dirtyWorld(t,r),t.parentNode=null,i}isChildExist(t){const{parentNode:e}=t;if(!e)return !1;const{childNodes:i}=e;return !(i.indexOf(t)<0)}setOrigin(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;js(e)&&(e=dr.fromValue(e,i));const{transform:s}=t;s.origin.equals(e)||(s.origin.setFromVector(e),this.dirtyLocal(t,s));}getOrigin(t){return t.transform.origin.clone()}setPosition(t,e){const{transform:i}=t,s=this.getPosition(t);if(s.equals(e))return;let n=this.getWorldTransform(t);if(i.position.setFromVector(e),t.hasParentTransform()){n=ur.create().translateSelf(e.x-s.x,e.y-s.y).multiply(n);const{worldTransform:o}=t.parentNode.transform,r=o.inverse().multiply(n),a=this.getOrigin(t),l=r.getScaleMatrix().inverse(),h=r.translate(a.x,a.y).multiply(l),c=h.getRotationMatrix().inverse(),d=h.multiply(c).getTranslation();d.subSelf(a),i.localPosition.setFromVector(d);}else i.localPosition.setFromVector(e);this.dirtyLocal(t,i);}setLocalPosition(t,e){const{transform:i}=t;i.localPosition.equals(e)||(i.localPosition.setFromVector(e),this.dirtyLocal(t,i));}getPosition(t){const e=this.getWorldTransform(t),{transform:i}=t,s=e.getTranslation();return i.position.setFromVector(s),t.transform.position.clone()}getLocalPosition(t){return t.transform.localPosition.clone()}translate(t,e){if(0===e.x&&0===e.y)return;const i=this.getPosition(t);i.addSelf(e),this.setPosition(t,i);}translateLocal(t,e){const{transform:i}=t;if(0===e.x&&0===e.y)return;const s=dr.fromPoint(e).multiplySelf(i.localScale),n=ur.createRotationMatrix(i.localRotation).transformPoint(s);i.localPosition.addSelf(n),this.dirtyLocal(t,i);}scaleLocal(t,e){const{transform:i}=t;i.localScale.multiplySelf(e),this.dirtyLocal(t,i);}setLocalScale(t,e){const{transform:i}=t;i.localScale.equals(e)||(i.localScale.setFromVector(e),this.dirtyLocal(t,i));}getScale(t){const{transform:e}=t,i=this.getWorldTransform(t).getScaling();return e.scale.setFromVector(i),e.scale.clone()}getLocalScale(t){return t.transform.localScale.clone()}getRotation(t){const{transform:e}=t,i=this.getWorldTransform(t).getRotation();return e.rotation=i,i}getLocalRotation(t){return t.transform.localRotation}rotate(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e)return;const{transform:i}=t;if(t.hasParentTransform()){const s=this.getRotation(t),n=-this.getRotation(t.parentNode)+e+s;i.localRotation=n,this.dirtyLocal(t,i);}else this.rotateLocal(t,e);}rotateLocal(t,e){const{transform:i}=t;i.localRotation+=e,this.dirtyLocal(t,i);}setAngle(t,e){const{transform:i}=t;if(t.hasParentTransform()){const s=this.getRotation(t.parentNode);i.localRotation=-s+e,this.dirtyLocal(t,i);}else this.setLocalAngle(t,e);}setLocalAngle(t,e){const{transform:i}=t;i.localRotation=e,this.dirtyLocal(t,i);}getAngle(t){return this.getWorldTransform(t).getRotation()}getLocalAngle(t){return this.getLocalRotation(t)}setLocalTransform(t,e){const i=this.getOrigin(t),{rotation:s,scale:n}=e.decompose(),o=ur.createScaleMatrix(n).inverse(),r=e.translate(i.x,i.y).multiply(o).getTranslation();r.subSelf(i),this.setLocalPosition(t,r),this.setLocalAngle(t,s),this.setLocalScale(t,n);}resetLocalTransform(t){this.setLocalScale(t,new dr(1,1)),this.setLocalPosition(t,new dr(0,0)),this.setLocalAngle(t,0);}getWorldTransform(t){const{transform:e}=t;if(!e.worldDirty&&!e.localDirty)return e.worldTransform;const{parentNode:i}=t;return i&&i.transform&&this.getWorldTransform(i),this.updateHierarchy(t),e.worldTransform.clone()}getLocalTransform(t){const{transform:e}=t;return e.localDirty&&e.updateLocalTransform(),e.localTransform.clone()}getBounds(t,e){const{renderable:i,childNodes:s}=t;if(e&&!i.renderBoundsDirty&&i)return i.renderBounds;if(!e&&!i.boundsDirty&&i.bounds)return i.bounds;let n=this.getTransformedGeometryBounds(t,e);s.forEach((t=>{const i=this.getBounds(t,e);i&&(n?n.addBounds(i):n=ll.fromBounds(i));}));const{clipPath:o}=t.style;if(o){const e=this.getTransformedGeometryBounds(o,!0);let i=null;e&&(i=ll.create(),i.setFromTransformedBounds(this.getWorldTransform(t),e)),n?i&&(n=i.intersection(n)):n=i;}return e?(i.renderBoundsDirty=!1,n&&(i.renderBounds=n)):(i.boundsDirty=!1,n&&(i.bounds=n)),n||ll.create()}getLocalBounds(t){const{parentNode:e}=t;if(e){let i=ur.create();if(e.transform){i=this.getWorldTransform(e).inverse();}const s=this.getBounds(t);if(!ll.isEmpty(s)){const t=ll.create();return t.setFromTransformedBounds(i,s),t}}return this.getBounds(t)}getGeometryBounds(t,e){const{geometry:i}=t;return (e?i.renderBounds:i.contentBounds)||ll.create()}getBoundingClientRect(t){var e;let i;const s=this.getGeometryBounds(t);ll.isEmpty(s)||(i=ll.create(),i.setFromTransformedBounds(this.getWorldTransform(t),s));const n=null===(e=t.ownerDocument)||void 0===e?void 0:e.defaultView.getContextService().getBoundingClientRect();return i?{x:i.minX+((null==n?void 0:n.left)||0),y:i.minY+((null==n?void 0:n.top)||0),width:i.maxX-i.minX,height:i.maxY-i.minY}:{x:(null==n?void 0:n.left)||0,y:(null==n?void 0:n.top)||0,width:0,height:0}}updateHierarchy(t){const{transform:e}=t;if(e.localDirty&&e.updateLocalTransform(),e.worldDirty){var i;let s=null==t||null===(i=t.parentNode)||void 0===i?void 0:i.transform;t.parentNode&&s||(s=new br),e.updateWorldTransform(s);}}getTransformedGeometryBounds(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=this.getGeometryBounds(t,e);if(!ll.isEmpty(i)){const e=ll.create();return e.setFromTransformedBounds(this.getWorldTransform(t),i),e}return null}dirtyLocal(t,e){e.localDirty||(e.localDirty=!0,e.worldDirty||this.dirtyWorld(t,e));}dirtyWorld(t,e){e.worldDirty||this.unfreezeParentToRoot(t),this.recursiveDirtyWorld(t,e),function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t;for(;i;){const{renderable:t}=i;t&&(t.boundsDirty=!0,t.renderBoundsDirty=!0),i=i.parentNode;}const s=new nr("bounds-changed",{affectChildren:e});t.dispatchEvent(s);}(t,!0);}recursiveDirtyWorld(t,e){if(e.worldDirty)return;e.worldDirty=!0,e.frozen=!1,t.childNodes.forEach((t=>{const{transform:e}=t;e.worldDirty||this.recursiveDirtyWorld(t,e);}));const{renderable:i}=t;i&&(i.boundsDirty=!0,i.renderBoundsDirty=!0);const s=new Sl("DOMAttrModified",t,null,null,"modelMatrix",Sl.MODIFICATION,null,null);t.dispatchEvent(s);}unfreezeParentToRoot(t){let e=t;for(;e;){const{transform:t}=e;t&&(t.frozen=!1),e=e.parentNode;}}};class yr{constructor(){i(this,"contentBounds",void 0),i(this,"renderBounds",void 0);}}class xr{constructor(){i(this,"boundsDirty",!0),i(this,"bounds",void 0),i(this,"renderBoundsDirty",!0),i(this,"renderBounds",void 0);}isRenderable(){return this.boundsDirty||this.renderBoundsDirty}toRenderable(){this.boundsDirty=!0,this.renderBoundsDirty=!0;}}class wr{constructor(){i(this,"renderOrder",0),i(this,"lastSortedIndex",void 0),i(this,"sorted",void 0),i(this,"dirty",!1);}}let br=class{constructor(){i(this,"frozen",!0),i(this,"worldDirty",!1),i(this,"localDirty",!1),i(this,"localRotation",0),i(this,"rotation",0),i(this,"localScale",dr.create(1,1)),i(this,"scale",dr.create(1,1)),i(this,"localPosition",dr.create(0,0)),i(this,"position",dr.create(0,0)),i(this,"localSkew",dr.create(0,0)),i(this,"skew",dr.create(0,0)),i(this,"origin",dr.create(0,0)),i(this,"worldTransform",ur.create()),i(this,"localTransform",ur.create());}updateLocalTransform(){const{origin:t,localScale:e,localPosition:i,localRotation:s}=this,n=ur.create();n.translateSelf(t.x,t.y);const o=ur.compose(i,e,s);n.multiplySelf(o),n.translateSelf(-t.x,-t.y),this.localTransform.setFromMatrix(n),this.localDirty=!1;}updateWorldTransform(t){const e=t.worldTransform.clone();e.multiplySelf(this.localTransform),this.worldTransform.setFromMatrix(e),this.worldDirty=!1;}};function Sr(t,e){if(Number.isNaN(e))return {unit:"px",value:0};if(Un(e))return {unit:"px",value:0};if(js(e))return {unit:"px",value:e};if(e=e.trim().toLowerCase(),Number.isFinite(Number(e))&&"px".search(t)>=0)return {unit:"px",value:Number(e)};const i=[];e=e.replace(t,(t=>(i.push(t),`U${t}`)));const s=`U(${t.source})`;return i.map((t=>({unit:t,value:Number(e.replace(new RegExp(`U${t}`,"g"),"").replace(new RegExp(s,"g"),"*0"))})))[0]}const Cr=t=>Sr(/px|pt/g,t),Pr=t=>Sr(/px|%|em/g,t),Tr=t=>Sr(/deg|rad|grad|turn/g,t);class Ar{constructor(t,e,s){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];i(this,"r",void 0),i(this,"g",void 0),i(this,"b",void 0),i(this,"alpha",void 0),i(this,"isNone",void 0),i(this,"formatted",""),this.r=t,this.g=e,this.b=s,this.alpha=n,this.isNone=o,this.formatted=`rgba(${t}, ${e}, ${s}, ${n})`;}clone(){return new Ar(this.r,this.g,this.b,this.alpha)}}class kr{constructor(t,e){i(this,"type",void 0),i(this,"value",void 0),this.type=t,this.value=e;}clone(){return new kr(this.type,this.value)}}const Dr={left:180,top:-90,bottom:90,right:0,"left top":225,"top left":225,"left bottom":135,"bottom left":135,"right top":-45,"top right":-45,"right bottom":45,"bottom right":45},Rr=t=>{let e;return e="angular"===t.type?Number(t.value):Dr[t.value]||0,{value:e,unit:"deg"}},Er=t=>{if(t.includes("linear")||t.includes("radial")){return un(t).map((t=>{let{type:e,orientation:i,colorStops:s}=t;!function(t){var e;const{length:i}=t;var s;t[i-1].length=null!==(e=t[i-1].length)&&void 0!==e?e:{type:"%",value:"100"},i>1&&(t[0].length=null!==(s=t[0].length)&&void 0!==s?s:{type:"%",value:"0"});let n=0,o=Number(t[0].length.value);for(let e=1;e<i;e++){var r;const i=null===(r=t[e].length)||void 0===r?void 0:r.value;if(!Un(i)&&!Un(o)){for(let s=1;s<e-n;s++)t[n+s].length={type:"%",value:`${o+(Number(i)-o)*s/(e-n)}`};n=e,o=Number(i);}}}(s);const n=s.map((t=>({offset:{value:t.length.value,unit:"%"},color:dn(t)})));if("linear-gradient"===e)return new kr(1,{angle:i?Rr(i):{value:0,unit:"deg"},steps:n});if("radial-gradient"===e){i||(i=[{type:"shape",value:"circle"}]);const t=i[0];if("shape"===(null==t?void 0:t.type)&&"circle"===(null==t?void 0:t.value)){const{cx:i,cy:s}=(t=>{let e=50,i=50,s="%",n="%";if("position"===(null==t?void 0:t.type)){const{x:o,y:r}=t.value;"position-keyword"===(null==o?void 0:o.type)&&("left"===o.value?e=0:"center"===o.value?e=50:"right"===o.value?e=100:"top"===o.value?i=0:"bottom"===o.value&&(i=100)),"position-keyword"===(null==r?void 0:r.type)&&("left"===r.value?e=0:"center"===r.value?i=50:"right"===r.value?e=100:"top"===r.value?i=0:"bottom"===r.value&&(i=100)),"px"!==(null==o?void 0:o.type)&&"%"!==(null==o?void 0:o.type)&&"em"!==(null==o?void 0:o.type)||(s=null==o?void 0:o.type,e=Number(o.value)),"px"!==(null==r?void 0:r.type)&&"%"!==(null==r?void 0:r.type)&&"em"!==(null==r?void 0:r.type)||(n=null==r?void 0:r.type,i=Number(r.value));}return {cx:{value:e,unit:s},cy:{value:i,unit:n}}})(null==t?void 0:t.at);let o;if(null!=t&&t.style){const{type:i,value:s}=t.style;o="extent-keyword"===i?s:{value:s,unit:e};}return new kr(2,{cx:i,cy:s,size:o,steps:n})}}}))}};function Mr(t){const e=t.replace(/rgba?\(/,"").replace(/\)/,"").replace(/[\s+]/g,"").split(","),i=parseFloat(e[3]||"1"),s=Math.floor(i*parseInt(e[0],10)+255*(1-i)),n=Math.floor(i*parseInt(e[1],10)+255*(1-i)),o=Math.floor(i*parseInt(e[2],10)+255*(1-i));return `#${`0${s.toString(16)}`.slice(-2)}${`0${n.toString(16)}`.slice(-2)}${`0${o.toString(16)}`.slice(-2)}`}function Ir(t){return /^hsla?\(.+\)$/i.test(t)}function Br(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(Un(t))return null;if("currentColor"===t&&(t="black"),"transparent"===t)return new Ar(0,0,0,0);const e=Er(t);if(e)return e;if(Ir){const e=document.createElement("div");e.style.color=t,t=e.style.color;}const i=Is(t),s=[0,0,0,0];return null!==i&&(s[0]=parseInt(i.r,10)||0,s[1]=parseInt(i.g,10)||0,s[2]=parseInt(i.b,10)||0,s[3]=parseFloat(i.opacity)),new Ar(...s)}function Ur(t){let e=null;Ls(t)&&(e=t),Xs(t)&&(e=t.split(" "));for(let t=0;t<3;t++)e[t]?e[t]=Cr(e[t]).value:e[t]=0;const i=Br(e[3]);return e[3]=i?i.formatted:"black",e.slice(0,4)}function Lr(t){const e=[];return Xs(t)?t.split(" ").forEach((t=>{const i=Cr(t);i&&e.push(i.value);})):e.push(...t),1===e.length?[e[0],e[0]]:e}const Or=t=>{let e=t;if(Xs(t)){const i=Pr(t);"%"===i.unit&&(e=i.value/100),"px"===i.unit&&(e=i.value);}return e>1&&(e=1),e},Nr={visibility:"visible",x:0,y:0,zIndex:0,anchor:[0,0],lineDash:[0,0],opacity:1,fillOpacity:1,borderOpacity:1,miterLimit:10,lineDashOffset:0,lineJoin:"miter",lineCap:"butt",borderColor:"black",renderBlendMode:"normal"},_r={color:"rgb(0,0,0)",fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",fontSize:20};function Wr(t){const e=[];return t.forEach((t=>{e.push({..._r,...t,fontSize:Cr(t.fontSize||_r.fontSize)});})),e}function Fr(t,e,i,s){const{x:n=0,y:o=0}=i.parsedStyle,{x:r,y:a}=i.getLocalPosition();i.boundsDirty=!0,"x"===s&&n===r||"y"===s&&o===a||i.setLocalPosition(n,o);}function Hr(t,e,i){if(!(i instanceof ja||i instanceof Xa||i instanceof Fa))return;if(t===e)return;i.pathDirty=!0,i.boundsDirty=!0,i.getPath();const{left:s,top:n}=i.getBoundingRect();i.updatePosition(s,n),i.updateOrigin();}function Vr(t,e,i){!(i instanceof Ga)||i instanceof Qa||i instanceof Wa||t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath(),i.updateOrigin());}function zr(t,e,i){(i instanceof Oa||i instanceof Na||i instanceof _a)&&t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function $r(t,e,i){if(!(i instanceof qa||i instanceof Xa))return;if(t===e)return;i.pathDirty=!0,i.boundsDirty=!0,i.getPath();const{left:s,top:n}=i.getBoundingRect();i.updatePosition(s,n),i.updateOrigin();}function jr(t,e,i){t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function Xr(t,e,i){i instanceof Ya&&t!==e&&(i.pathDirty=!0,i.boundsDirty=!0,i.getPath());}function Gr(t,e,i,s){var n;if(!(i instanceof Ka))return;if(t===e)return;i.setLimitWidth(i.parsedStyle.width.value),i.pathDirty=!0,i.boundsDirty=!0;const o="freeTextWriter"!==i.textType;if(["x","y"].includes(s)&&null!==(n=i.lines)&&void 0!==n&&n.length){const n=e-t;return "x"===s?i.updateTextLinesForTranslate(n,0):i.updateTextLinesForTranslate(0,n),void i.getPath()}if(o||!o&&["width","textContents"].includes(s)){var r;if(null==i||null===(r=i.textEditEventHandler)||void 0===r||!r.editMode)return void(i.linesDirty=!0);i.calculateTextLines();}i.getPath();}class Yr{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,"x",void 0),i(this,"y",void 0),this.x=t,this.y=e;}static fromPoint(t){return new Yr(t.x,t.y)}setFromPoint(t){return this.x=t.x||0,this.y=t.y||0,this}clone(){return new Yr(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}distanceTo(t){return Math.hypot(this.x-t.x,this.y-t.y)}lerpTo(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;return new Yr(this.x+e*(t.x-this.x),this.y+e*(t.y-this.y))}footPointInSegment(t,e){const i=dr.fromTwoPoint(t,this),s=dr.fromTwoPoint(t,e),n=s.norm(),o=Yr.fromPoint(t);if(0===n)return o;const r=i.projectionTo(s)/n;return o.lerpTo(e,r)}perpendicularToSegment(t,e){const i=this.footPointInSegment(t,e);return this.distanceTo(i)}}function qr(t,e,i){const s=t.x-e.x,n=t.y-e.y;let o=(i.x-t.x)*s+(i.y-t.y)*n;o/=s*s+n*n;return new Yr(t.x+o*s,t.y+o*n)}function Jr(t,e,i,s){let n=t[0]*(i[1]-e[1])+e[0]*(t[1]-i[1])+i[0]*(e[1]-t[1]),o=t[0]*(s[1]-e[1])+e[0]*(t[1]-s[1])+s[0]*(e[1]-t[1]);return !((n^o)>=0&&0!==n&&0!==o)&&(n=i[0]*(t[1]-s[1])+s[0]*(i[1]-t[1])+t[0]*(s[1]-i[1]),o=i[0]*(e[1]-s[1])+s[0]*(i[1]-e[1])+e[0]*(s[1]-i[1]),!((n^o)>=0&&0!==n&&0!==o))}function Zr(t,e){return ((t.x-e.x)**2+(t.y-e.y)**2)**.5}function Qr(t,e,i,s,n){const o=n||[],r=t[e],a=t[i];let l=0,h=1;for(let s=e+1;s<i;s++){const e=Zr(qr(r,a,t[s]),t[s]);e>l&&(l=e,h=s);}return l>=s?(Qr(t,e,h,s,o),Qr(t,h,i,s,o)):(!o.length&&r&&o.push(r),o.push(a)),o}function Kr(t,e,i,s,n,o){const r=function(t,e,i,s,n,o){const r=function(t,e,i){const s=Math.cos(t),n=Math.sin(t);return function(t,o){return {x:s*(t-e)+n*(o-i),y:-n*(t-e)+s*(o-i)}}}((p=n-t,g=o-e,Math.atan2(g,p)),(t+n)/2,(e+o)/2),a=r(t,e),l=r(i,s),h=r(n,o),c=Math.abs(a.x),[d,u]=[l.y/2,0].sort(((t,e)=>t-e));var p,g;let f,v;l.x>=a.x&&l.x<=h.y?[f,v]=[a.x,h.x]:l.x>0?[f,v]=[a.x,.5*(l.x+c*c/l.x)]:[f,v]=[.5*(l.x+c*c/l.x),h.x];return function(t,e,i){const s=r(t,e);return !(s.x<f-i||s.x>v+i)&&!(s.y<d-i||s.y>u+i)}}(t,e,i,s,n,o),{getDistance:a}=function(t,e,i,s,n,o){const r=[i-t,s-e],a=[t-2*i+n,e-2*s+o],l=[2*r[0],2*r[1]],h=1/ea(a,a),c=h*ea(r,a),d=c*c,u=ea(r,r),p=3**.5,g=0===ea(a,a)?function(t){return 0===u?0:ta(-ea(r,t)/2/u,0,1)}:function(t){const e=h*(2*u+ea(t,a))/3,i=h*ea(t,r),s=e-d,n=c*(2*d-3*e)+i;let o=n*n+4*(s*s*s);if(o>=0){o=Math.sqrt(o);const t=(o-n)/2,e=(-o-n)/2;return ta(Math.sign(t)*Math.abs(t)**(1/3)+Math.sign(e)*Math.abs(e)**(1/3)-c,0,1)}const l=Math.sqrt(-s),g=Math.acos(n/(s*l*2))/3,f=Math.cos(g),v=Math.sin(g)*p;return [ta((f+f)*l-c,0,1),ta((-v-f)*l-c,0,1)]};return {getDistance(i,s){const n=[t-i,e-s],o=g(n);if("number"==typeof o)return Math.sqrt(ia((l[0]+a[0]*o)*o+n[0],(l[1]+a[1]*o)*o+n[1]));const[r,h]=o;return Math.sqrt(Math.min(ia(n[0]+(l[0]+a[0]*r)*r,n[1]+(l[1]+a[1]*r)*r),ia(n[0]+(l[0]+a[0]*h)*h,n[1]+(l[1]+a[1]*h)*h)))}}}(t,e,i,s,n,o);return {isHit:function(t,e){return function(t,e,i){return !!r(t,e,i)&&a(t,e)<=i}(t[0],t[1],e)}}}function ta(t,e,i){return Math.min(Math.max(t,e),i)}function ea(t,e){return t[0]*e[0]+t[1]*e[1]}function ia(t,e){return t*t+e*e}function sa(t,e,i,s,n){const{PI:o,cos:r,sin:a,min:l,max:h,tan:c}=Math;n-s>2*o&&(n=s+2*o);let d=h(o/12,(n-s)/12);const u=[];for(u.push({x:t+i*r(s),y:e+i*a(s)});s<n;){const o=t+i*r(s),h=e+i*a(s),p=l(n,s+d);d=l(n-s,d);const g=t+i*r(p),f=e+i*a(p),v=i*c(d/3),m={x:o-(h-e)/i*v,y:h+(o-t)/i*v},y={x:g+(f-e)/i*v,y:f-(g-t)/i*v},x={x:g,y:f};u.push(m,y,x),s+=d;}return u}function na(t,e,i,s){const n=t-i,o=t+i,r=e-s,a=e+s,l=.551915024494,h=l*i,c=l*s,d=[];return d.push({x:o,y:e}),d.push({x:o,y:e+c},{x:t+h,y:a},{x:t,y:a}),d.push({x:t-h,y:a},{x:n,y:e+c},{x:n,y:e}),d.push({x:n,y:e-c},{x:t-h,y:r},{x:t,y:r}),d.push({x:t+h,y:r},{x:o,y:e-c},{x:o,y:e}),d}function oa(t,e){return {type:t,data:e,close:arguments.length>2&&void 0!==arguments[2]&&arguments[2]}}function ra(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=t.length;if(i<=1)return [];const s=[],[n]=t;s.push(oa("moveTo",[n]));for(let e=0;e+3<i;e+=3){const i=t[e+1],n=t[e+2],o=t[e+3];s.push(oa("bezierCurveTo",[i,n,o]));}return e&&t.length>2&&s.push(oa("lineTo",[n])),s}function aa(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function la(t,e){const i=t.length;if(i<=1)return [];if(2===i)return [{index:0,ops:[oa("moveTo",[t[0]])]},{index:1,ops:[oa("lineTo",[t[1]])]}];let s=i-e;i<=e&&(s=0);const n=[];let o=[],r={index:s,ops:[]};if(n.push(r),i<=e){const e=oa("moveTo",[t[0]]);r.ops.push(e),o=[...t];}else o=t.slice(-e);const a=function(t,e,i){const s=[];for(let n=1;n<t.length-1;n++){const o=180*$a(Va(t[n-1],t[n]),Va(t[n],t[n+1]))/Math.PI;o>=e&&o<=i&&s.push(n);}return s}(o,45,135),l=[];for(let e=0;e<o.length;e++)if(a.includes(e)){const i=t[e-1],n=t[e+1],r=aa(t[e],i),a=aa(t[e],n);let h,c;r>6&&(h=ga(i,t[e],.2),l.push({val:h})),l.push({index:e+s,val:o[e]}),a>6&&(c=ga(n,t[e],.2),l.push({val:c}));}else l.push({index:e+s,val:o[e]});for(let t=0;t<l.length;t++){var h,c,d,u,p,g;const e=l[t],i=l[t].val,o=null!==(h=null===(c=l[t-1])||void 0===c?void 0:c.val)&&void 0!==h?h:i,a=null!==(d=null===(u=l[t+1])||void 0===u?void 0:u.val)&&void 0!==d?d:i,f=ha(o,i,a,null!==(p=null===(g=l[t+2])||void 0===g?void 0:g.val)&&void 0!==p?p:a);void 0!==e.index&&(e.index!==s&&(r={index:void 0,ops:[]},n.push(r)),r.index=e.index),r.ops.push(f);}return n}function ha(t,e,i,s){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:5;const o=aa(e,i);let r={x:e.x+(i.x-t.x)/n,y:e.y+(i.y-t.y)/n},a={x:i.x-(s.x-e.x)/n,y:i.y-(s.y-e.y)/n};const l=aa(r,e),h=aa(a,i);l>o&&(r=ga(r,e,o)),h>o&&(a=ga(a,i,o));return oa("bezierCurveTo",[r,a,i])}function ca(t,e,i){const s=(t.x+e.x)/2,n=(t.y+e.y)/2,o=(e.x+i.x)/2,r=(e.y+i.y)/2;return oa("bezierCurveTo",[{x:s+2*(e.x-s)/3,y:n+2*(e.y-n)/3},{x:o+2*(e.x-o)/3,y:r+2*(e.y-r)/3},e])}function da(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[];let[s]=t;i.push(oa("moveTo",[s]));for(let e=1;e<t.length;e++)s=t[e],i.push(oa("lineTo",[s]));return e&&t.length>2&&([s]=t,i.push(oa("lineTo",[s]))),i}function ua(t,e){const{data:i,type:s}=e,[n,o,r]=i;switch(s){case"moveTo":t.moveTo(n.x,n.y);break;case"lineTo":t.lineTo(n.x,n.y);break;case"bezierCurveTo":t.bezierCurveTo(n.x,n.y,o.x,o.y,r.x,r.y);break;case"quadraticCurveTo":t.quadraticCurveTo(n.x,n.y,o.x,o.y);}}function pa(t){let{x:e,y:i}=t[0],s=e,n=i;for(let o=1;o<t.length;o++){const{x:r,y:a}=t[o];e=Math.min(e,r),s=Math.max(s,r),i=Math.min(i,a),n=Math.max(n,a);}return {left:e,top:i,right:s,bottom:n,width:s-e,height:n-i}}function ga(t,e,i){const s=e.x-t.x,n=e.y-t.y,o=Math.abs(s)/Math.abs(n);let r=Math.sqrt(i*i/(o*o+1)),a=r*o;return 0===s&&(a=0,r=Math.sqrt(i)),0===n&&(r=0,a=Math.sqrt(i)),{x:e.x-(s>=0?a:-a),y:e.y-(n>=0?r:-r)}}function fa(t){if(t.length<1)return [];const e=[];let i=[];for(let s=0;s<t.length;s++){const n=t[s];if(0===n.step)s>0&&e.push({step:i,close:t[s-1].close}),i=[],i.push(oa("moveTo",[{x:n.x,y:n.y}]));else if(1===n.step)i.push(oa("lineTo",[{x:n.x,y:n.y}]));else if(2===n.step&&s+2<t.length&&2===t[s+1].step&&2===t[s+2].step){const e=t[s+1],o=t[s+2];i.push(oa("bezierCurveTo",[n,e,o])),s+=2;}}return e.push({step:i,close:t[t.length-1].close}),e}function va(t){return 180*t/Math.PI}function ma(t){return t<0?t%360+360:t%360}function ya(t,e,i,s){return t/(i*i)+e/(s*s)}function xa(t,e,i,s){let n=0,o=0,r=0,a=0;const l=[t,e],h=pa(l),c=function(t,e,i,s){let n=s/2,o=s/2;const r=e.y-t.y,a=e.x-t.x;if(0===r||0===a)return [a,r];const l=-1/((e.y-t.y)/(e.x-t.x)),h=Math.atan(l);return "square"===i?(n=Math.sqrt(2)*s/2,o=Math.sqrt(2)*s/2):"round"===i?(n=s/2,o=s/2):(n=Math.abs(Math.cos(h)*s)/2,o=Math.abs(Math.sin(h)*s)/2),[n,o]}(l[0],l[1],s,i||0);return 0===c[1]?(n=h.left,o=h.top-i/2,r=h.width,a=h.height+i,"square"!==s&&"round"!==s||(n-=i/2,r+=i)):0===c[0]?(n=h.left-i/2,o=h.top,r=h.width+i,a=h.height,"square"!==s&&"round"!==s||(o-=i/2,a+=i)):(n=h.left-c[0],o=h.top-c[1],r=h.width+2*c[0],a=h.height+2*c[1]),{left:n,top:o,width:r,height:a}}function wa(t){return Math.abs(t)<1e-6?0:t<0?-1:1}function ba(t,e,i,s){const{x:n,y:o}=t,{x:r,y:a}=e,{x:l,y:h}=s,c=Math.min(n,r),d=Math.max(n,r),u=Math.min(o,a),p=Math.max(o,a),g=i/2;return l>=c-g&&l<=d+g&&h>=u-g&&h<=p+g&&function(t,e,i,s,n,o){const r=[i-t,s-e];if(new dr(r[0],r[1]).equals({x:0,y:0}))return Math.sqrt((n-t)*(n-t)+(o-e)*(o-e));const a=[-r[1],r[0]],l=new dr(a[0],a[1]);l.normalize();const h=[n-t,o-e],c=new dr(h[0],h[1]);return Math.abs(c.dot(l))}(n,o,r,a,l,h)<=i/2}function Sa(t,e,i){let s=!1;const n=t.length;if(n<=2)return !1;for(let l=0;l<n;l++){const h=t[l],c=t[(l+1)%n];if(r=c,((a={x:e,y:i}).x-(o=h).x)*(r.y-o.y)==(r.x-o.x)*(a.y-o.y)&&Math.min(o.x,r.x)<=a.x&&a.x<=Math.max(o.x,r.x)&&Math.min(o.y,r.y)<=a.y&&a.y<=Math.max(o.y,r.y))return !0;wa(h.y-i)>0!=wa(c.y-i)>0&&wa(e-(i-h.y)*(h.x-c.x)/(h.y-c.y)-h.x)<0&&(s=!s);}var o,r,a;return s}function Ca(t,e,i,s,n){const o=t.length;if(o<2)return !1;for(let n=0;n<o-1;n++)if(ba(t[n],t[n+1],e,{x:i,y:s}))return !0;if(n){if(ba(t[0],t[o-1],e,{x:i,y:s}))return !0}return !1}function Pa(t,e,i,s,n,o){return n>=t&&n<=t+i&&o>=e&&o<=e+s}function Ta(t,e,i,s,n,o){const r=o;let a=s.x,l=s.y,h=n.x,c=n.y;0===e&&(a=n.x,l=n.y,h=s.x,c=s.y);let d=Math.PI/2;const u=h-a>=0?1:-1,p=c-l>=0?1:-1;a!==h&&(d=Math.atan(Math.abs(c-l)/Math.abs(h-a)));const g=Math.cos(d),f=Math.sin(d),v=i?1:-1,m={x:h+7.8*v*r*g*u-4.5*r*f*u,y:c+7.8*v*r*f*p+4.5*r*g*p,step:0,close:!1},y={x:h,y:c,step:1,close:!1};i&&(y.x=h+r*v*g*u,y.y=c+r*v*f*p);const x={x:h+7.8*v*r*g*u+4.5*r*f*u,y:c+7.8*v*r*f*p-4.5*r*g*p,step:1,close:!1};t.push(m,y,x);}function Aa(t,e,i,s,n,o){const r=o;let a=s.x,l=s.y,h=n.x,c=n.y;0===e&&(a=n.x,l=n.y,h=s.x,c=s.y);let d=Math.PI/2;const u=h-a>=0?1:-1,p=c-l>=0?1:-1;a!==h&&(d=Math.atan(Math.abs(c-l)/Math.abs(h-a)));const g=Math.cos(d),f=Math.sin(d),v=i?1:-1,m={x:h+7.8*v*r*g*u-4.5*r*f*u,y:c+7.8*v*r*f*p+4.5*r*g*p,step:0,close:!1},y={x:h,y:c,step:1,close:!1};i&&(y.x=h+r*v*g*u,y.y=c+r*v*f*p);const x={x:h+7.8*v*r*g*u+4.5*r*f*u,y:c+7.8*v*r*f*p-4.5*r*g*p,step:1,close:!0};t.push(m,y,x);}function ka(t,e,i,s,n){const o=n;let r=i.x,a=i.y,l=s.x,h=s.y;0===e&&(r=s.x,a=s.y,l=i.x,h=i.y);let c=Math.PI/2;const d=l-r>=0?1:-1,u=h-a>=0?1:-1;r!==l&&(c=Math.atan(Math.abs(h-a)/Math.abs(l-r)));const p=Math.cos(c),g=Math.sin(c),f={x:l-3*o*g*d,y:h+3*o*p*u,step:0,close:!1},v={x:l+3*o*g*d,y:h-3*o*p*u,step:1,close:!1};t.push(f,v);}function Da(t,e,i,s,n){const o=n;let r=i.x,a=i.y,l=s.x,h=s.y;0===e&&(r=s.x,a=s.y,l=i.x,h=i.y);let c=Math.PI/2;const d=l-r>=0?1:-1,u=h-a>=0?1:-1,p=h>=a&&l>=r||h<=a&&l<=r?-1:1;r!==l&&(c=Math.atan(Math.abs(h-a)/Math.abs(l-r)));const g=Math.cos(c),f=Math.sin(c),v=4.5*Math.sqrt(3)*o,m={x:l+4.5*o*g*d-v*f*d*p,y:h+4.5*o*f*u+v*g*u*p,step:0,close:!1},y={x:l-4.5*o*g*d+v*f*d*p,y:h-4.5*o*f*u-v*g*u*p,step:1,close:!1};t.push(m,y);}function Ra(t,e,i,s,n){const o=n;let{x:r,y:a}=s;0===e&&(r=i.x,a=i.y);const l={x:r-3*o,y:a-3*o,step:0,close:!1},h={x:r+3*o,y:a-3*o,step:1,close:!1},c={x:r+3*o,y:a+3*o,step:1,close:!1},d={x:r-3*o,y:a+3*o,step:1,close:!0};t.push(l,h,c,d);}function Ea(t,e,i,s,n){const o=n;let{x:r,y:a}=s;0===e&&(r=i.x,a=i.y);const l={x:r-3*o,y:a,step:0,close:!1},h={x:r,y:a-3*o,step:1,close:!1},c={x:r+3*o,y:a,step:1,close:!1},d={x:r,y:a+3*o,step:1,close:!0};t.push(l,h,c,d);}function Ma(t,e,i,s,n){const o=n;let{x:r,y:a}=s;0===e&&(r=i.x,a=i.y);const l=3*o-0*o,h=na(r,a,l,l);h.forEach(((e,i)=>{const s=0===i?0:2,n=i===h.length-1,o={x:e.x,y:e.y,step:s,close:n};t.push(o);}));}class Ia{constructor(t){i(this,"lineAlign",void 0),i(this,"owner",void 0),this.owner=t,this.reset();}reset(){this.lineAlign=.5;}get x(){return this.owner.getAttribute("x")}set x(t){this.owner.setAttribute("x",t);}get y(){return this.owner.getAttribute("y")}set y(t){this.owner.setAttribute("y",t);}get r(){return this.owner.getAttribute("r")}set r(t){this.owner.setAttribute("r",t);}get width(){return this.owner.getAttribute("width")}set width(t){this.owner.setAttribute("width",t);}get height(){return this.owner.getAttribute("height")}set height(t){this.owner.setAttribute("height",t);}get points(){return this.owner.getAttribute("points")}set points(t){this.owner.setAttribute("points",t);}get origin(){return this.owner.getAttribute("origin")}set origin(t){this.owner.setAttribute("origin",t);}get anchor(){return this.owner.getAttribute("anchor")}set anchor(t){this.owner.setAttribute("anchor",t);}get visibility(){return this.owner.getAttribute("visibility")}set visibility(t){this.owner.setAttribute("visibility",t);}get zIndex(){return this.owner.getAttribute("zIndex")}set zIndex(t){this.owner.setAttribute("zIndex",t);}get borderWidth(){return this.owner.getAttribute("borderWidth")}set borderWidth(t){this.owner.setAttribute("borderWidth",t);}get borderColor(){return this.owner.getAttribute("borderColor")}set borderColor(t){this.owner.setAttribute("borderColor",t);}get opacity(){return this.owner.getAttribute("opacity")}set opacity(t){this.owner.setAttribute("opacity",t);}get fillOpacity(){return this.owner.getAttribute("fillOpacity")}set fillOpacity(t){this.owner.setAttribute("fillOpacity",t);}get borderOpacity(){return this.owner.getAttribute("borderOpacity")}set borderOpacity(t){this.owner.setAttribute("borderOpacity",t);}get background(){return this.owner.getAttribute("background")}set background(t){this.owner.setAttribute("background",t);}get clipPath(){return this.owner.getAttribute("clipPath")}set clipPath(t){this.owner.setAttribute("clipPath",t);}get cursor(){return this.owner.getAttribute("cursor")}set cursor(t){this.owner.setAttribute("cursor",t);}get hitArea(){return this.owner.getAttribute("hitArea")}set hitArea(t){this.owner.setAttribute("hitArea",t);}get pointerEvents(){return this.owner.getAttribute("pointerEvents")}set pointerEvents(t){this.owner.setAttribute("pointerEvents",t);}get miterLimit(){return this.owner.getAttribute("miterLimit")}set miterLimit(t){this.owner.setAttribute("miterLimit",t);}get roundedRadius(){return this.owner.getAttribute("roundedRadius")}set roundedRadius(t){this.owner.setAttribute("roundedRadius",t);}get lineCap(){return this.owner.getAttribute("lineCap")}set lineCap(t){this.owner.setAttribute("lineCap",t);}get lineJoin(){return this.owner.getAttribute("lineJoin")}set lineJoin(t){this.owner.setAttribute("lineJoin",t);}get lineDash(){return this.owner.getAttribute("lineDash")}set lineDash(t){this.owner.setAttribute("lineDash",t);}get lineDashOffset(){return this.owner.getAttribute("lineDashOffset")}set lineDashOffset(t){this.owner.setAttribute("lineDashOffset",t);}get shadow(){return this.owner.getAttribute("shadow")}set shadow(t){this.owner.setAttribute("shadow",t);}get shadowOffsetX(){return this.owner.getAttribute("shadowOffsetX")}set shadowOffsetX(t){this.owner.setAttribute("shadowOffsetX",t);}get shadowOffsetY(){return this.owner.getAttribute("shadowOffsetY")}set shadowOffsetY(t){this.owner.setAttribute("shadowOffsetY",t);}get shadowBlur(){return this.owner.getAttribute("shadowBlur")}set shadowBlur(t){this.owner.setAttribute("shadowBlur",t);}get shadowColor(){return this.owner.getAttribute("shadowColor")}set shadowColor(t){this.owner.setAttribute("shadowColor",t);}get startAngle(){return this.owner.getAttribute("startAngle")}set startAngle(t){this.owner.setAttribute("startAngle",t);}get endAngle(){return this.owner.getAttribute("endAngle")}set endAngle(t){this.owner.setAttribute("endAngle",t);}get rx(){return this.owner.getAttribute("rx")}set rx(t){this.owner.setAttribute("rx",t);}get ry(){return this.owner.getAttribute("ry")}set ry(t){this.owner.setAttribute("ry",t);}get img(){return this.owner.getAttribute("img")}set img(t){this.owner.setAttribute("img",t);}get src(){return this.owner.getAttribute("src")}set src(t){this.owner.setAttribute("src",t);}get text(){return this.owner.getAttribute("text")}set text(t){this.owner.setAttribute("text",t);}get wordWarp(){return this.owner.getAttribute("wordWarp")}set wordWarp(t){this.owner.setAttribute("wordWarp",t);}get wordBreak(){return this.owner.getAttribute("wordBreak")}set wordBreak(t){this.owner.setAttribute("wordBreak",t);}get textMaxWidth(){return this.owner.getAttribute("textMaxWidth")}set textMaxWidth(t){this.owner.setAttribute("textMaxWidth",t);}get letterSpacing(){return this.owner.getAttribute("letterSpacing")}set letterSpacing(t){this.owner.setAttribute("letterSpacing",t);}get textBaseLine(){return this.owner.getAttribute("textBaseLine")}set textBaseLine(t){this.owner.setAttribute("textBaseLine",t);}get color(){return this.owner.getAttribute("color")}set color(t){this.owner.setAttribute("color",t);}get fontStyle(){return this.owner.getAttribute("fontStyle")}set fontStyle(t){this.owner.setAttribute("fontStyle",t);}get fontVariant(){return this.owner.getAttribute("fontVariant")}set fontVariant(t){this.owner.setAttribute("fontVariant",t);}get fontWeight(){return this.owner.getAttribute("fontWeight")}set fontWeight(t){this.owner.setAttribute("fontWeight",t);}get fontSize(){return this.owner.getAttribute("fontSize")}set fontSize(t){this.owner.setAttribute("fontSize",t);}get lineHeight(){return this.owner.getAttribute("lineHeight")}set lineHeight(t){this.owner.setAttribute("lineHeight",t);}get fontFamily(){return this.owner.getAttribute("fontFamily")}set fontFamily(t){this.owner.setAttribute("fontFamily",t);}get font(){return this.owner.getAttribute("font")}set font(t){this.owner.setAttribute("font",t);}get startPoint(){return this.owner.getAttribute("startPoint")}set startPoint(t){this.owner.setAttribute("startPoint",t);}get endPoint(){return this.owner.getAttribute("endPoint")}set endPoint(t){this.owner.setAttribute("endPoint",t);}get lineEnding(){return this.owner.getAttribute("lineEnding")}set lineEnding(t){this.owner.setAttribute("lineEnding",t);}get segments(){return this.owner.getAttribute("segments")}set segments(t){this.owner.setAttribute("segments",t);}get stampPoints(){return this.owner.getAttribute("stampPoints")}set stampPoints(t){this.owner.setAttribute("stampPoints",t);}get imageData(){return this.owner.getAttribute("imageData")}set imageData(t){this.owner.setAttribute("imageData",t);}get iconName(){return this.owner.getAttribute("iconName")}set iconName(t){this.owner.setAttribute("iconName",t);}get textContents(){return this.owner.getAttribute("textContents")}set textContents(t){this.owner.setAttribute("textContents",function(t){const e=[];return t.forEach((t=>{t.content.length&&e.push(t);})),e}(t));}get textAlign(){return this.owner.getAttribute("textAlign")}set textAlign(t){this.owner.setAttribute("textAlign",t);}get renderBlendMode(){return this.owner.getAttribute("renderBlendMode")}set renderBlendMode(t){this.owner.setAttribute("renderBlendMode",t);}get lines(){return this.owner.getAttribute("lines")}set lines(t){this.owner.setAttribute("lines",t);}}const Ba=new class{constructor(){i(this,"parsers",void 0),i(this,"updaters",void 0),this.parsers=new Map,this.updaters=new Map,this.initParser(),this.initUpdater();}getStyleParser(t){return this.parsers.get(t)}getStyleUpdaters(t){return this.updaters.get(t)}initParser(){this.bindHandler(["borderWidth","letterSpacing","lineDashOffset","shadowOffsetX","shadowOffsetY","shadowBlur","textMaxWidth","roundedRadius"],Cr,void 0),this.bindHandler(["startAngle","endAngle"],Tr,void 0),this.bindHandler(["r","rx","ry","width","height","fontSize"],Cr,void 0),this.bindHandler(["borderColor","background","shadowColor","color"],Br,void 0),this.bindHandler(["opacity","fillOpacity","borderOpacity"],Or,void 0),this.bindHandler(["lineDash"],Lr,void 0),this.bindHandler(["shadow"],Ur,void 0),this.bindHandler(["textContents"],Wr,void 0);}initUpdater(){this.bindHandler(["borderWidth"],void 0,jr),this.bindHandler(["x","y"],void 0,Fr),this.bindHandler(["width","height"],void 0,Vr),this.bindHandler(["r","rx","ry","startAngle","endAngle"],void 0,zr),this.bindHandler(["points","segments"],void 0,Hr),this.bindHandler(["startPoint","endPoint","lineEnding"],void 0,$r),this.bindHandler(["stampPoints"],void 0,Xr),this.bindHandler(["x","y","width","height","textContents","textAlign","borderWidth"],void 0,Gr);}bindHandler(t,e,i){for(let s=0;s<t.length;s++)if(e&&this.parsers.set(t[s],e),i){const e=this.updaters.get(t[s])||[];e.push(i),this.updaters.set(t[s],e);}}};class Ua extends or{constructor(t){super(),i(this,"attributes",{}),i(this,"id",void 0),i(this,"pageUid",void 0),i(this,"index",void 0),i(this,"name",void 0),i(this,"renderable",new xr),i(this,"sortable",new wr),i(this,"geometry",new yr),i(this,"transform",new br),i(this,"parsedStyle",{}),i(this,"style",void 0),i(this,"isDestroyed",!1),i(this,"childNodes",[]),i(this,"nodeName",""),i(this,"nodeType",0),i(this,"nodeValue",null),i(this,"ownerDocument",null),i(this,"parentNode",null),i(this,"isConnected",!1),i(this,"textContent",void 0),i(this,"shapeType",void 0),i(this,"config",void 0),i(this,"boundsDirty",!0),i(this,"bounds",void 0),i(this,"path",void 0),i(this,"pathDirty",!0),i(this,"steps",void 0),i(this,"renderClipPath",void 0),i(this,"renderClipStep",void 0),i(this,"strokePath",void 0),i(this,"strokeSteps",void 0),i(this,"externalMatrices",[]),i(this,"clippable",!1),i(this,"imageData",null),this.config=t,this.id=t.id||t.uid||"",this.name=t.name||"",this.index=t.index,this.nodeName=t.type||"container",this.pageUid=t.pageUid||"",(t.className||t.class)&&(this.className=t.className||t.class),this.style=new Ia(this),this.initAttributes(t);}static isNode(t){return !!t.childNodes}set className(t){this.setAttribute("class",t);}get className(){return this.getAttribute("class")||""}get classList(){return this.className.split(" ").filter((t=>""!==t))}get tagName(){return this.nodeName}get children(){return this.childNodes}get childElementCount(){return this.childNodes.length}get firstElementChild(){return this.firstChild}get lastElementChild(){return this.lastChild}get firstChild(){return this.childNodes.length>0?this.childNodes[0]:null}get lastChild(){const{childNodes:t}=this;return t.length>0?t[t.length-1]:null}get nextSibling(){const{parentNode:t}=this;if(t){const e=t.childNodes.indexOf(this);return t.childNodes[e+1]}return null}get parentElement(){return this.parentNode}get previousSibling(){const{parentNode:t}=this;if(t){const e=t.childNodes.indexOf(this);return t.childNodes[e-1]}return null}getAttribute(t){const e=this.attributes[t];return null==e?null:e}getElementsByName(t){return mr.querySelectorAll(`[name="${t}"]`,this)}getElementsByClassName(t){return mr.querySelectorAll(`.${t}`,this)}getElementsByTagName(t){return mr.querySelectorAll(t,this)}hasAttribute(t){return Object.keys(this.attributes).indexOf(t)>-1}removeAttribute(t){this.setAttribute(t,null),delete this.attributes[t];}appendChild(t,e){mr.append(t,this,e);const i=new nr("child-inserted",{child:t});this.dispatchEvent(i);const s=new Sl("DOMNodeInserted",this,"","","",0,"","");return t.dispatchEvent(s),t}cloneNode(t){return null}insertBefore(t,e){if(e){const i=this.childNodes.indexOf(e);this.appendChild(t,i-1);}else this.appendChild(t);return t}removeChild(t){const e=new Sl("removed",this,"","","",0,"","");t.dispatchEvent(e);const i=new nr("child-removed",{child:t});return this.dispatchEvent(i),mr.remove(t),t}isChildExist(t){return mr.isChildExist(t)}replaceChild(t,e){const i=this.childNodes.indexOf(e);return this.removeChild(e),this.appendChild(t,i),e}destroy(){const t=new nr("destroy",{});this.dispatchEvent(t),this.remove(),this.removeAllEventListeners(),this.isDestroyed=!0;}after(){const{parentNode:t}=this;if(t){const n=t.childNodes.indexOf(this);for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];i.forEach(((e,i)=>{null==t||t.appendChild(e,n+i+1);}));}}before(){const{parentNode:t}=this;if(t){const n=t.childNodes.indexOf(this);for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];i.forEach(((e,i)=>{null==t||t.appendChild(e,n+i);}));}}remove(){this.parentNode&&this.parentNode.removeChild(this);}replaceWith(){this.after(...arguments),this.remove();}append(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach((t=>{this.appendChild(t);}));}prepend(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach(((t,e)=>{this.appendChild(t,e);}));}querySelector(t){return mr.querySelector(t,this)}querySelectorAll(t){return mr.querySelectorAll(t,this)}find(t){let e=null;return this.recursiveCall((i=>!(i!==this||!t(i))&&(e=i,!0))),e}findAll(t){const e=[];return this.recursiveCall((i=>{i===this&&t(i)&&e.push(i);})),e}contains(t){let e=t;for(;e&&this!==e;)e=e.parentNode;return !!e}getRootNode(t){return this.parentNode?this.parentNode.getRootNode(t):this}hasChildNodes(){return this.childNodes.length>0}isEqualNode(t){return this===t}isSameNode(t){return this.isEqualNode(t)}normalize(){throw new Error("Method to be implemented")}recursiveCall(t){t(this)||this.childNodes.forEach((e=>{e.recursiveCall(t);}));}hasParentTransform(){return !(!this.parentNode||!this.parentNode.transform)}getGeometryBounds(){return mr.getGeometryBounds(this)}getRenderBounds(){return mr.getBounds(this,!0)}getBounds(){return mr.getBounds(this)}getLocalBounds(){return mr.getLocalBounds(this)}getBoundingClientRect(){return mr.getBoundingClientRect(this)}get isVisible(){return "visible"===this.parsedStyle.visibility}get isInteractive(){return "none"!==this.parsedStyle.pointerEvents}get width(){return this.parsedStyle.width.value*Math.abs(this.getScale().x)}get height(){return this.parsedStyle.height.value*Math.abs(this.getScale().y)}initAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(const e in t)if(Ln(e,t)){if("style"===e)continue;this.attributes[e]=t[e];}for(const e in t.style)Ln(e,t.style)&&(this.parseStyleProperty(e,t.style[e]),this.attributes[e]=t.style[e]);this.renderable.toRenderable();}setAttribute(t,e){if(_s(e))return;const i="x"===t||"y"===t,s=this.attributes[t];(e!==this.attributes[t]||i)&&(this.attributes[t]=e,Object.keys(this.config).includes(t)||(this.parseStyleProperty(t,e),this.updateStyleProperty(t,s,e)));}parseStyleProperty(t,e){const i=Ba.getStyleParser(t);this.parsedStyle[t]=i?i(e,this,t):e;}updateStyleProperty(t,e,i){const s=Ba.getStyleUpdaters(t);s&&s.forEach((s=>{s(e,i,this,t);}));}toFront(){const{parentNode:t}=this;if(t){const e=Math.max(...t.children.map((t=>t.style.zIndex)));this.style.zIndex=e+1;}return this}toBack(){const{parentNode:t}=this;if(t){const e=Math.min(...t.children.map((t=>t.style.zIndex)));this.style.zIndex=e-1;}return this}setOrigin(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return mr.setOrigin(this,t,e),this}getOrigin(){return mr.getOrigin(this)}setPosition(t){return t=La(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),mr.setPosition(this,t),this}setLocalPosition(t){return t=La(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),mr.setLocalPosition(this,t),this}getPosition(){return mr.getPosition(this)}getLocalPosition(){return mr.getLocalPosition(this)}translate(t){return t=La(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),mr.translate(this,t),this}translateLocal(t){return t=La(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0),mr.translateLocal(this,t),this}scale(t,e){return this.scaleLocal(t,e)}scaleLocal(t,e){return js(t)&&(t={x:t,y:e=e||t}),mr.scaleLocal(this,t),this}setLocalScale(t,e){return js(t)&&(t={x:t,y:e=e||t}),mr.setLocalScale(this,t),this}getScale(){return mr.getScale(this)}getLocalScale(){return mr.getLocalScale(this)}rotate(t){return mr.rotate(this,t),this}rotateLocal(t){return mr.rotateLocal(this,t),this}setAngle(t){return mr.setAngle(this,t),this}setLocalAngle(t){return mr.setLocalAngle(this,t),this}getAngle(){return mr.getAngle(this)}getLocalAngle(){return mr.getLocalAngle(this)}getLocalTransform(){return mr.getLocalTransform(this)}getWorldTransform(){return mr.getWorldTransform(this)}setLocalTransform(t){return mr.setLocalTransform(this,t),this}resetLocalTransform(){return mr.resetLocalTransform(this),this}getPath(){}getBoundingRect(){return {left:0,top:0,width:0,height:0}}isPointInPath(t){return !1}updateStyle(t){Object.keys(t).forEach((e=>{Ln(e,t)&&(this.style[e]=t[e]);}));}updatePosition(t,e){this.style.x=t||0,this.style.y=e||0;}updateOrigin(){const{width:t,height:e}=this.getBoundingRect();this.setOrigin(t/2,e/2);}getBoundingRectObject(){const{left:t,top:e,width:i,height:s}=this.getBoundingRect();return new Ga({style:{x:t,y:e,width:i,height:s,borderWidth:1,background:"transparent"}})}}function La(t,e){return js(t)?{x:t,y:e}:t}class Oa extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"arc",style:{...Nr,r:0,startAngle:0,endAngle:1.5*Math.PI,...t},...e}),i(this,"shapeType","arc");const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}normAngle(){const{startAngle:t,endAngle:e}=this.style;let i=Tr(t).value,s=Tr(e).value;if(i>s){const t=i;i=s,s=t;}if(Math.abs(s-i)>=2*Math.PI-1e-5&&(i=0,s=2*Math.PI),i<-2*Math.PI||s<-2*Math.PI){const t=Math.max(Math.floor(i/(-2*Math.PI)),Math.floor(s/(-2*Math.PI)));i+=2*Math.PI*t,s+=2*Math.PI*t;}if(i>2*Math.PI||s>2*Math.PI){const t=Math.max(Math.floor(i/(2*Math.PI)),Math.floor(s/(2*Math.PI)));i-=2*Math.PI*t,s-=2*Math.PI*t;}this.parsedStyle.startAngle=Tr(i),this.parsedStyle.endAngle=Tr(s);}updateOrigin(){const{width:t,height:e,left:i,top:s}=this.getBoundingRect(),n=i-this.style.x+t/2,o=s-this.style.y+e/2;this.setOrigin(n,o);}getPath(){if(!this.pathDirty)return this.path;this.normAngle();const{r:t,borderWidth:e,startAngle:i,endAngle:s}=this.parsedStyle,n=.5*((null==e?void 0:e.value)||0),o=i.value,r=s.value;return this.path=sa(0,0,t.value-n,o,r),this.steps=ra(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,r:i,startAngle:s,endAngle:n,borderWidth:o}=this.parsedStyle,r=i.value,a=s.value,l=n.value;null==o||o.value;if(s===n)return {left:t-r-0,top:e-r-0,width:2*r+0,height:2*r+0};const{sin:h,cos:c,PI:d}=Math,u=[t+r*c(a),t+r*c(l)],p=[e+r*h(a),e+r*h(l)];return a<0&&l>0&&u.push(t+r),(a<.5*d&&l>.5*d||a<-1.5*d&&l>-1.5*d)&&p.push(e+r),(a<d&&l>d||a<-d&&l>-d)&&u.push(t-r),(a<1.5*d&&l>1.5*d||a<-.5*d&&l>-.5*d)&&p.push(e-r),u.sort(((t,e)=>t-e)),p.sort(((t,e)=>t-e)),this.boundsDirty=!1,this.bounds={left:u[0]-0,top:p[0]-0,width:u[u.length-1]-u[0]+0,height:p[p.length-1]-p[0]+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:s,r:n,startAngle:o,endAngle:r,background:a,borderWidth:l}=this.parsedStyle,h=ma(va(o.value)),c=ma(va(r.value)),d=ma(va(o.value+r.value)/2),u=Xs(this.style.background)&&""!==this.style.background,p=l&&l.value,g=u?0:e,f=(l.value+g||0)/2,v=n.value-f,m=new Yr(i+v*Math.cos(h*Math.PI/180),s+v*Math.sin(h*Math.PI/180)),y=new Yr(i+v*Math.cos(c*Math.PI/180),s+v*Math.sin(c*Math.PI/180)),x=new Yr(i+v*Math.cos(d*Math.PI/180),s+v*Math.sin(d*Math.PI/180)),w=new Yr(t.x,t.y),b=w.distanceTo({x:i,y:s}),S=Jr([m.x,m.y],[x.x,x.y],[w.x,w.y],[i,s]),C=Jr([y.x,y.y],[x.x,x.y],[w.x,w.y],[i,s]),P=Jr([m.x,m.y],[y.x,y.y],[w.x,w.y],[i,s]);if(b>v+f)return !1;const T=ba(m,y,2*f,t);if(c-h<180&&c-h>0||c-h<-180){if(a&&P||T)return !0;if(!a&&p&&b>=v-f&&b<=v+f&&P)return !0}else if(180===Math.abs(c-h)){if(a){if(S||C)return !0;if(function(t,e,i,s){const{x:n,y:o}=t,{x:r,y:a}=e,{x:l,y:h}=i,{x:c,y:d}=s;return !(((c-n)*(a-o)-(d-o)*(r-n))*((l-n)*(a-o)-(h-o)*(r-n))<=0||((c-l)*(a-h)-(d-h)*(r-l))*((n-l)*(a-h)-(o-h)*(r-l))<=0||((c-n)*(h-o)-(d-o)*(l-n))*((r-n)*(h-o)-(a-o)*(l-n))<=0)}(m,x,y,t))return !0}if(!a&&p&&b>=v-f&&b<=v+f&&(S||C))return !0}else {if(a){if(S||C)return !0;if(!P)return !0}if(!a&&p&&b>=v-f&&b<=v+f&&(S||C))return !0}return !!T}}class Na extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"circle",style:{...Nr,r:0,anchor:[.5,.5],...t},...e}),i(this,"shapeType","circle");const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}updateOrigin(){this.setOrigin(0,0);}getPath(){if(!this.pathDirty)return this.path;const{r:t,borderWidth:e}=this.parsedStyle;let i=.5*((null==e?void 0:e.value)||0);return t.value===i&&(i=0),this.path=sa(0,0,t.value-i,0,2*Math.PI),this.steps=ra(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,r:i}=this.parsedStyle,s=i.value;return this.boundsDirty=!1,this.bounds={left:t-s-0,top:e-s-0,width:2*s+0,height:2*s+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:s,r:n,background:o,borderWidth:r}=this.parsedStyle,a=Xs(this.style.background)&&""!==this.style.background,l=r&&r.value,h=a?0:e,c=(r.value+h||0)/2,d=n.value-c,u=new Yr(t.x,t.y).distanceTo({x:i,y:s});return o&&l?u<=d+c:o?u<=d:!!l&&(u>=d-c&&u<=d+c)}}let _a=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"ellipse",style:{...Nr,rx:"",ry:"",borderWidth:0,anchor:[.5,.5],...t},...e}),i(this,"shapeType","ellipse");const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}updateOrigin(){this.setOrigin(0,0);}getPath(){if(!this.pathDirty)return this.path;const{rx:t,ry:e,borderWidth:i}=this.parsedStyle,s=.5*i.value;return this.path=na(0,0,t.value-s,e.value-s),this.steps=ra(this.path),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,rx:i,ry:s}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t-i.value-0,top:e-s.value-0,width:2*i.value+0,height:2*s.value+0},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{x:i,y:s,rx:n,ry:o,borderWidth:r}=this.parsedStyle,a=Xs(this.style.background)&&""!==this.style.background,l=r&&r.value,h=a?0:e,c=(r.value||0)/2,d=n.value-c,u=o.value-c,p=(t.x-i)*(t.x-i),g=(t.y-s)*(t.y-s);return a&&l?ya(p,g,d+c,u+c)<=1:a?ya(p,g,d,u)<=1:!!l&&(ya(p,g,d-c-h/2,u-c-h/2)>=1&&ya(p,g,d+c+h/2,u+c+h/2)<=1)}},Wa=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"image",style:{...Nr,width:0,height:0,img:"",...t},...e}),i(this,"shapeType","image"),i(this,"meteData",void 0),i(this,"visiblePartData",void 0),this.meteData=(null==e?void 0:e.metadata)||null;const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:s}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:s.value},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}},Fa=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"ink",style:{...Nr,segments:[],lineJoin:"round",lineCap:"round",borderWidth:2,miterLimit:10,...t},...e}),i(this,"shapeType","ink"),i(this,"inkPaths",[]),i(this,"inkSteps",[]),i(this,"inkRenderPaths",[]),i(this,"inkOriginalRenderPath",void 0),i(this,"inkRenderSteps",[]),i(this,"initialRect",void 0),i(this,"douglasPeuckerPoints",[]),i(this,"partDirty",!1),i(this,"optimizedOpSteps",[]),i(this,"positionDirty",!1),this.getPath(),this.initialRect=this.getBoundingRect(),this.updatePosition(this.initialRect.left,this.initialRect.top),this.setOrigin(this.initialRect.width,this.initialRect.height);}addSegment(){const{segments:t}=this.style;t[t.length-1].length&&this.style.segments.push([]);}addPoint(t){const e=[...this.style.segments],i=this.style.segments.length,s=e[i-1],n=s[s.length-1];if((null==n?void 0:n.x)!==t.x||(null==n?void 0:n.y)!==t.y){this.partDirty=!0;const s=this.getBoundingRect(),n=this.parsedStyle.borderWidth.value/2;(t.x<s.left+n||t.y<s.top+n)&&(this.positionDirty=!0),e[i-1].push(t),this.style.segments=e;const o=this.getBoundingRect();(t.x<o.left||t.y<o.top||t.x>o.left+o.width||t.y>o.top+o.height)&&(this.boundsDirty=!0);}}getPath(){if(!this.pathDirty&&!this.partDirty)return this.path;const{segments:t}=this.parsedStyle;if(this.partDirty){const e=t.length;if(e>1)for(let i=0;i<e-1;i++){const e=t[i];if(!this.optimizedOpSteps[i]){let t=[...e];1===t.length?t=this.offsetPoints(e[0],.1):(t=Qr(t,0,t.length-1,1),t.length<=3&&t.push({...t[t.length-1]}));const s=la(t,t.length).map((t=>t.ops)).flat(2);this.optimizedOpSteps[i]=s;}if(this.positionDirty||!this.inkRenderSteps[i]){const t=this.getRenderStep(this.optimizedOpSteps[i]);this.inkRenderSteps[i]=t;}}let i=t[e-1];1===i.length?i=this.offsetPoints(i[0],.1):i.length<=3&&i.push(i[i.length-1]),i=this.getRenderPath(i);const s=function(t){const e=t.length;if(e<=1)return [];if(2===e)return [oa("moveTo",[t[0]]),oa("lineTo",[t[1]])];const i=[oa("moveTo",[t[0]])];for(let s=0;s<e-1;s++){const e=t[s-1]||t[s],n=t[s],o=t[s+1]||t[s];i.push(ca(e,n,o));}return i}(i);this.inkRenderSteps[e-1]=s;}else this.pathDirty&&(this.reset(),t.forEach(((t,e)=>{if(0===t.length)return;let i=[...t];1===t.length?i=this.offsetPoints(t[0],.1):(i=Qr(i,0,i.length-1,1),i.length<=3&&i.push({...i[i.length-1]})),this.inkPaths[e]=i;const s=la(i,i.length);this.inkSteps[e]=s.map((t=>t.ops)).flat(2);const n=this.getRenderPath(i),o=la(n,n.length).map((t=>t.ops)).flat(2);this.inkRenderSteps[e]=o;})));return this.pathDirty=!1,this.partDirty=!1,this.positionDirty=!1,this.path}offsetPoints(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.001;const{x:i,y:s}=t;return [{x:i-e,y:s-e},{x:i+e,y:s-e},{x:i+e,y:s+e},{x:i-e,y:s+e}]}getRenderStep(t){return t.map((t=>({...t,data:this.getRenderPath(t.data)})))}getInkOriginalRenderPath(){if(!this.pathDirty&&this.inkOriginalRenderPath)return;const{segments:t}=this.parsedStyle,e=[];for(let i=0;i<t.length;i++){const s=this.getRenderPath(t[i]);e.push(s);}this.inkOriginalRenderPath=e;}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),s=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||s.push({x:t.x-e,y:t.y-i});})),s}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t}=this.parsedStyle,e=[],i=[];this.parsedStyle.segments.forEach((t=>{t.forEach((t=>{t&&(e.push(t.x),i.push(t.y));}));}));const{min:s,max:n}=Ha(e),{min:o,max:r}=Ha(i),a=t.value/2;return this.boundsDirty=!1,this.bounds={left:s-a,top:o-a,width:n-s+2*a,height:r-o+2*a},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i}=this.parsedStyle;for(let s=0;s<this.inkSteps.length;s++){const n=this.inkSteps[s];for(let s=1;s<n.length;s+=2){const o=n[s-1].data[0],r=n[s].data[0],a=n[s].data[1];if(Kr(o.x,o.y,r.x,r.y,a.x,a.y).isHit([t.x,t.y],i.value+e))return !0}}return !1}reset(){this.inkPaths=[],this.inkSteps=[],this.inkRenderPaths=[],this.inkRenderSteps=[];}};function Ha(t){if(0===t.length)return {min:void 0,max:void 0};let e=t[0],i=t[0];for(let s=1;s<t.length;s++)t[s]<e&&(e=t[s]),t[s]>i&&(i=t[s]);return {min:e,max:i}}function Va(t,e){return {x:e.x-t.x,y:e.y-t.y}}function za(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function $a(t,e){const i=function(t,e){return t.x*e.x+t.y*e.y}(t,e),s=za(t),n=za(e);return Math.acos(i/(s*n))}let ja=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"polygon",style:{...Nr,points:[{x:0,y:0},{x:10,y:10}],miterLimit:10,borderWidth:2,...t},...e}),i(this,"shapeType","polygon"),i(this,"renderPath",void 0),i(this,"isControls",!1),i(this,"basePath",void 0),i(this,"baseRenderPath",void 0),this.isControls=e.isControls||!1,0===this.parsedStyle.points.length&&(this.style.points=[{x:0,y:0},{x:10,y:10}]);const{left:s,top:n,width:o,height:r}=this.getBoundingRect();this.updatePosition(s,n),this.setOrigin(o/2,r/2);}addPoint(t){const e=[...this.style.points];e.push(t),this.style.points=e;}updatePoints(){const{renderPath:t}=this,e=this.getLocalPosition(),i=[];t.forEach((t=>{i.push({x:t.x+e.x,y:t.y+e.y});})),this.style.points=i;}getPath(){if(!this.pathDirty)return this.path;const{left:t,top:e,width:i,height:s}=this.getBoundingRect();return this.path=this.parsedStyle.points,this.basePath=this.path,this.renderPath=this.parsedStyle.points.map((i=>({x:i.x-t,y:i.y-e}))),this.baseRenderPath=this.renderPath,this.steps=da(this.renderPath,!0),this.isControls||(this.renderClipPath=[{x:0,y:0},{x:i,y:0},{x:i,y:s},{x:0,y:s}],this.renderClipStep=da(this.renderClipPath,!0)),this.pathDirty=!1,this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,points:e,lineCap:i}=this.parsedStyle;if(2===e.length)return this.boundsDirty=!1,this.bounds=xa(e[0],e[1],t.value,i),this.bounds;const s=pa(e);let n=0;return n=this.isControls?t.value/2||0:t.value||0,this.boundsDirty=!1,this.bounds={left:s.left-n,top:s.top-n,width:s.width+2*n,height:s.height+2*n},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i,points:s}=this.parsedStyle,n=Xs(this.style.background)&&""!==this.style.background,o=n?0:e;let r=!1;return i&&i.value&&(r=Ca(s,i.value+o,t.x,t.y,!0)),!r&&n&&(r=Sa(s,t.x,t.y)),r}},Xa=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"polyline",style:{...Nr,points:[{x:0,y:0},{x:0,y:0}],lineEnding:null,borderWidth:2,miterLimit:10,...t},...e}),i(this,"shapeType","polyline"),i(this,"renderPath",void 0),i(this,"basePath",void 0),i(this,"baseRenderPath",void 0),this.getPath();const{left:s,top:n}=this.getBoundingRect();this.updatePosition(s,n),this.updateOrigin();}initPath(){const {points:t,lineEnding:e}=this.parsedStyle,s=[];if(t.forEach(((t,e)=>{0===e?s.push({x:t.x,y:t.y,step:0,close:!1}):s.push({x:t.x,y:t.y,step:1,close:!1});})),this.basePath=[...t],e&&s.length>1)for(let t=0;t<e.length;t++)switch(e[t]){case"OpenArrow":this.addOpenArrow(s,t,!1);break;case"ROpenArrow":this.addOpenArrow(s,t,!0);break;case"ClosedArrow":this.addCloseArrow(s,t,!1);break;case"RClosedArrow":this.addCloseArrow(s,t,!0);break;case"Butt":this.addButt(s,t);break;case"Slash":this.addSlash(s,t);break;case"Square":this.addSquare(s,t);break;case"Diamond":this.addDiamond(s,t);break;case"Circle":this.addCircle(s,t);}return s}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),s=[],n=[];return t.forEach(((t,o)=>{if(t&&!Number.isNaN(t.x)&&!Number.isNaN(t.y)){const r={x:t.x-e,y:t.y-i,step:t.step,close:t.close};s.push(r),o<this.basePath.length&&n.push(r);}})),this.baseRenderPath=n,s}addPoint(t){const e=[...this.style.points];e.push(t),this.style.points=e;}updatePoints(){const{length:t}=this.parsedStyle.points,e=this.getLocalPosition(),i=[];this.renderPath.slice(0,t).forEach((t=>{i.push({x:t.x+e.x,y:t.y+e.y});})),this.style.points=i;}updatePoint(){const t=this.getLocalPosition(),e=this.parsedStyle.points.length,i=[];for(let s=0;s<e;s++)i.push({x:this.renderPath[s].x+t.x,y:this.renderPath[s].y+t.y});this.updateStyle({points:i});}getPath(){if(!this.pathDirty)return this.path;this.path=this.initPath(),this.renderPath=this.getRenderPath(this.path),this.steps=fa(this.renderPath),this.pathDirty=!1;const{width:t,height:e}=this.getBoundingRect();return this.renderClipPath=[{x:0,y:0},{x:t,y:0},{x:t,y:e},{x:0,y:e}],this.renderClipStep=da(this.renderClipPath,!0),this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,lineCap:e}=this.parsedStyle;if(2===this.path.length)return this.boundsDirty=!1,this.bounds=xa(this.path[0],this.path[1],t.value,e),this.bounds;const i=pa(this.path),s=t.value||0;return this.boundsDirty=!1,this.bounds={left:i.left-s,top:i.top-s,width:i.width+2*s,height:i.height+2*s},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{borderWidth:i,points:s}=this.parsedStyle;return Ca(s,i.value+e,t.x,t.y,!1)}isLineArrow(){const{lineEnding:t}=this.parsedStyle;return !!t&&("None"!==t[0]||"None"!==t[1])}addOpenArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{points:s,borderWidth:n}=this.parsedStyle,{length:o}=s;let r=s[o-2],a=s[o-1];0===e&&(r={...s[0]},a={...s[1]}),Ta(t,e,i,r,a,n.value);}addCloseArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{points:s,borderWidth:n}=this.parsedStyle,{length:o}=s;let r=s[o-2],a=s[o-1];0===e&&(r={...s[0]},a={...s[1]}),Aa(t,e,i,r,a,n.value);}addCircle(t,e){const{points:i,borderWidth:s}=this.parsedStyle,{length:n}=i;Ma(t,e,i[0],i[n-1],s.value);}addDiamond(t,e){const{points:i,borderWidth:s}=this.parsedStyle,{length:n}=i;Ea(t,e,i[0],i[n-1],s.value);}addSquare(t,e){const{points:i,borderWidth:s}=this.parsedStyle,{length:n}=i;Ra(t,e,i[0],i[n-1],s.value);}addSlash(t,e){const{points:i,borderWidth:s}=this.parsedStyle,{length:n}=i;let o=i[n-2],r=i[n-1];0===e&&(o={...i[0]},r={...i[1]}),Da(t,e,o,r,s.value);}addButt(t,e){const{points:i,borderWidth:s}=this.parsedStyle,{length:n}=i;let o=i[n-2],r=i[n-1];0===e&&(o={...i[0]},r={...i[1]}),ka(t,e,o,r,s.value);}},Ga=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"rect",style:{...Nr,width:0,height:0,...t},...e}),i(this,"shapeType","rect");const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}getPath(){if(!this.pathDirty)return this.path;const{width:t,height:e,borderWidth:i}=this.parsedStyle,s=(null==i?void 0:i.value)||0,n=s,o=s,r=t.value-2*s,a=e.value-2*s;return this.path=[{x:n,y:o},{x:n+r,y:o},{x:n+r,y:o+a},{x:n,y:o+a}],this.steps=da(this.path),this.pathDirty=!1,this.path}getStrokePath(){const{width:t,height:e,borderWidth:i}=this.parsedStyle,s=.5*((null==i?void 0:i.value)||0),n=s,o=s,r=t.value-2*s,a=e.value-2*s;this.strokePath=[{x:n,y:o},{x:n+r,y:o},{x:n+r,y:o+a},{x:n,y:o+a}],this.strokeSteps=da(this.strokePath);}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:s}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:s.value},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{x:i,y:s,borderWidth:n,width:o,height:r}=this.parsedStyle,a=Xs(this.style.background)&&""!==this.style.background,l=n&&n.value,h=e/2;return a?Pa(i,s,o.value,r.value,t.x,t.y):!!l&&function(t,e,i,s,n,o,r){return Pa(t,e,i,n,o,r)||Pa(t,e,n,s,o,r)||Pa(t,e+s-n,i,n,o,r)||Pa(t+i-n,e,n,s,o,r)}(i-h,s-h,o.value+e,r.value+e,n.value+e,t.x,t.y)}};class Ya extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stampPath",style:{...Nr,stampPoints:[],lineJoin:"miter",lineCap:"butt",borderWidth:2,miterLimit:4,...t},...e}),i(this,"shapeType","stampPath"),i(this,"renderPath",void 0),i(this,"clipped",!1),t.clipped&&(this.clipped=!0),this.getPath();}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),s=[];return t.forEach((t=>{!t||Number.isNaN(t.x)||Number.isNaN(t.y)||s.push({x:t.x-e,y:t.y-i,step:t.step,close:t.close});})),s}isLinePath(){const t=this.path;if(t.length<2)return !0;let e=!0,i=!0;const s=t[0].x,n=t[0].y;for(let o=1;o<t.length;o++)t[o].x!==s&&(e=!1),t[o].y!==n&&(i=!1);return e||i}getPath(){return this.pathDirty?(this.path=this.parsedStyle.stampPoints,this.renderPath=this.getRenderPath(this.path),this.steps=function(t){if(t.length<1)return [];const e=[];for(let i=0;i<t.length;i++){const s=t[i];if(0===s.step)e.push(oa("lineTo",[s],s.close));else if(1===s.step){if(i+2<t.length&&1===t[i+1].step&&1===t[i+2].step){const n=t[i+1],o=t[i+2];e.push(oa("bezierCurveTo",[s,n,o],s.close)),i+=2;}}else 2===s.step&&e.push(oa("moveTo",[s],s.close));}return e}(this.renderPath),this.pathDirty=!1,this.path):this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,stampPoints:e,lineCap:i}=this.parsedStyle;if(2===e.length)return this.boundsDirty=!1,this.bounds=xa(e[0],e[1],t.value,i),this.bounds;const s=pa(e),n=t.value/2;return this.boundsDirty=!1,this.bounds={left:s.left-n,top:s.top-n,width:s.width+2*n,height:s.height+2*n},this.bounds}}let qa=class extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"line",style:{...Nr,startPoint:{x:0,y:0},endPoint:{x:0,y:0},lineEnding:["None","None"],borderWidth:2,...t},...e}),i(this,"shapeType","line"),i(this,"renderPath",void 0),i(this,"basePath",void 0),i(this,"baseRenderPath",void 0),this.getPath();const{left:s,top:n}=this.getBoundingRect();this.updatePosition(s,n),this.updateOrigin();}initPath(){const{startPoint:t,endPoint:e,lineEnding:i}=this.parsedStyle,s=[{...t,step:0,close:!1},{...e,step:1,close:!1}];if(this.basePath=[...s],i)for(let t=0;t<i.length;t++)switch(i[t]){case"OpenArrow":this.addOpenArrow(s,t,!1);break;case"ROpenArrow":this.addOpenArrow(s,t,!0);break;case"ClosedArrow":this.addCloseArrow(s,t,!1);break;case"RClosedArrow":this.addCloseArrow(s,t,!0);break;case"Butt":this.addButt(s,t);break;case"Slash":this.addSlash(s,t);break;case"Square":this.addSquare(s,t);break;case"Diamond":this.addDiamond(s,t);break;case"Circle":this.addCircle(s,t);}return s}getRenderPath(t){const{left:e,top:i}=this.getBoundingRect(),s=[],n=[];return t.forEach(((t,o)=>{if(t&&!Number.isNaN(t.x)&&!Number.isNaN(t.y)){const r={x:t.x-e,y:t.y-i,step:t.step,close:t.close};s.push(r),o<this.basePath.length&&n.push(r);}})),this.baseRenderPath=n,s}updatePoints(){const t=this.getLocalPosition();this.updateStyle({startPoint:{x:this.renderPath[0].x+t.x,y:this.renderPath[0].y+t.y},endPoint:{x:this.renderPath[1].x+t.x,y:this.renderPath[1].y+t.y}});}getPath(){return this.pathDirty?(this.path=this.initPath(),this.renderPath=this.getRenderPath(this.path),this.steps=fa(this.renderPath),this.pathDirty=!1,this.path):this.path}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{borderWidth:t,lineCap:e}=this.parsedStyle,i=pa(this.path);if(2===this.path.length)return this.boundsDirty=!1,this.bounds=xa(this.path[0],this.path[1],t.value,e),this.bounds;const s=t.value/2||0;return this.boundsDirty=!1,this.bounds={left:i.left-s,top:i.top-s,width:i.width+2*s,height:i.height+2*s},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.getBoundingRectObject().isPointInPath(t,e))return !1;const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;return ba(i,s,n.value+e,t)}isLineArrow(){const{lineEnding:t}=this.parsedStyle;return !!t&&("None"!==t[0]||"None"!==t[1])}addCircle(t,e){const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;Ma(t,e,i,s,n.value);}addDiamond(t,e){const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;Ea(t,e,i,s,n.value);}addSquare(t,e){const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;Ra(t,e,i,s,n.value);}addSlash(t,e){const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;Da(t,e,i,s,n.value);}addButt(t,e){const{startPoint:i,endPoint:s,borderWidth:n}=this.parsedStyle;ka(t,e,i,s,n.value);}addOpenArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{startPoint:s,endPoint:n,borderWidth:o}=this.parsedStyle;Ta(t,e,i,s,n,o.value);}addCloseArrow(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{startPoint:s,endPoint:n,borderWidth:o}=this.parsedStyle;Aa(t,e,i,s,n,o.value);}};class Ja extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stampText",style:{...Nr,text:"",color:"black",fontSize:12,fontFamily:"Microsoft YaHei",fontWeight:"normal",fontStyle:"normal",...t},...e}),i(this,"shapeType","stampText"),this.setTextFont();const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}setTextFont(){const{fontStyle:t,fontWeight:e,fontFamily:i,fontSize:s}=this.parsedStyle,n=""===(null==i?void 0:i.trim())?"sans-serif":i;null!=i&&i.includes(" ")?this.style.font=`${t} ${e} ${s.value}${s.unit} '${n}'`:this.style.font=`${t} ${e} ${s.value}${s.unit} ${n}`;}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,text:i,fontSize:s,font:n}=this.parsedStyle,o=document.createElement("canvas").getContext("2d");o.font=n;const{width:r}=o.measureText(i);return this.boundsDirty=!1,this.bounds={left:t,top:e-s.value,width:r,height:s.value},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}}let Za=class extends Ga{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"stamp",style:{...t,background:"transparent",borderColor:"transparent"},...e}),i(this,"shapeType","stamp"),i(this,"stampConfig",[]),i(this,"stampItemShapes",[]),i(this,"renderType","stamp"),i(this,"initialWidth",0),i(this,"initialHeight",0),this.stampConfig=t.stampConfig||[];}initStamp(){this.stampConfig&&(this.renderType="stamp",this.initStampItem(),this.initStampStyle());}initStampItem(){if(!Ls(this.stampConfig))return;this.stampItemShapes=[];const{stampConfig:t,stampItemShapes:e}=this,{renderBlendMode:i}=this.parsedStyle;for(let s=0;s<t.length;s++){let n;"path"===t[s].type&&(n=new Ya({style:{opacity:this.style.opacity,renderBlendMode:i,...t[s]}})),"text"===t[s].type&&(n=new Ja({style:{opacity:this.style.opacity,renderBlendMode:i,...t[s]}})),"image"===t[s].type&&(n=new Wa({style:{opacity:this.style.opacity,renderBlendMode:i,...t[s]}})),n&&e.push(n);}}initStampStyle(){if(!Ls(this.stampConfig))return;const t=[],e=[],{stampItemShapes:i}=this,s=i.some((t=>t instanceof Ya));for(const n of i){if(s&&!(n instanceof Ya)){this.appendChild(n);continue}if(n instanceof Ya&&n.clipped){this.appendChild(n);continue}const{left:i,top:o,width:r,height:a}=n.getBoundingRect();t.push(i,i+r),e.push(o,o+a),this.appendChild(n);}this.initialWidth=Math.max(...t)-Math.min(...t),this.initialHeight=Math.max(...e)-Math.min(...e);const n=Math.min(...t),o=Math.min(...e);this.updateStyle({x:n,y:o,width:this.initialWidth,height:this.initialHeight});for(let t=0;t<i.length;t++){const{left:e,top:s}=i[t].getBoundingRect();let n=s-this.style.y;i[t]instanceof Ja&&(n+=i[t].parsedStyle.fontSize.value),i[t].setLocalPosition(e-this.style.x,n);}this.updateOrigin();}isPointInPath(t,e){return super.isPointInPath(t,0)}};class Qa extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"roundedRect",style:{...Nr,roundedRadius:0,width:0,height:0,...t},...e}),i(this,"shapeType","roundedRect");const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.updateOrigin();}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,width:i,height:s}=this.parsedStyle;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:i.value,height:s.value},this.bounds}isPointInPath(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{x:i,y:s,width:n,height:o,borderWidth:r}=this.parsedStyle,a=(r.value+e||0)/2;return Pa(i-a,s-a,n.value+2*a,o.value+2*a,t.x,t.y)}getCenterPosition(){const{width:t,height:e}=this.parsedStyle,i=new Na({style:{x:t.value/2,y:e.value/2}});this.appendChild(i);const{x:s,y:n}=i.getPosition();return i.destroy(),{x:s,y:n}}}class Ka extends Ua{constructor(){let{style:t,...e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"freeText",style:{...Nr,width:0,height:0,textAlign:"left",...t},...e}),i(this,"shapeType","freeText"),i(this,"lines",void 0),i(this,"textType","textBox"),i(this,"lineHeightOffset",.2),i(this,"totalTextHeight",0),i(this,"limitWidth",1),i(this,"textMaxWidth",0),i(this,"borderOffset",0),i(this,"padding",1),i(this,"linesDirty",!1),this.textType=t.freeTextType||"textBox",this.setLimitWidth(this.parsedStyle.width.value),this.calculateTextLines();const{x:s,y:n}=this.parsedStyle;this.setLocalPosition(s,n),this.boundsDirty=!0,this.updateOrigin();}updateOrigin(){const{width:t,height:e}=this.getBoundingRect();this.setOrigin(t/2,e/2);}organizeLine(){if(0===this.lines.length)return;const{y:t}=this.parsedStyle;let e=t+this.borderOffset+this.padding,i=0,s=0;this.lines.forEach(((t,n)=>{s=0,i=Math.max(t.width,i);let o=0,r="";if(0===t.width&&""===t.words[0].text){const e=tl(" ",t.words[0].style);t.width=e,t.words[0].wordWidth=e,t.words[0].text=" ";}if(t.words.forEach((t=>{r+=t.text,o=Math.max(o,t.wordHeight),t.widthWithoutLf=il(t.text)?tl(t.text,t.style,!0):t.wordWidth,s+=t.widthWithoutLf;})),"textBox"===this.textType&&"justify"===this.style.textAlign&&n!==this.lines.length-1){const e=[],i=/\S+/g;let n,o=0;for(;null!==(n=i.exec(r));)0===e.length&&0!==n.index?e.push(0):e.push(n.index);if(e.length>1){let i=this.limitWidth-s;i<0&&(i=0);const n=i/(e.length-1),r=t=>{for(let i=0;i<e.length;i++)if(e[i]>t)return i;return e.length};t.words.forEach(((t,e)=>{e>0&&(t.x+=n*(r(o)-1)),o+=t.text.length;})),s=this.limitWidth,t.width=this.limitWidth;}}const{lineHeightOffset:a}=this;t.widthWithoutLF=s,t.height=o,t.y=o*(1-a)+e,e+=o,n>0&&(t.y+=this.lines[n-1].height*a,e+=this.lines[n-1].height*a);})),this.textMaxWidth=i;}getTextAlignOffset(t){if("freeTextWriter"===this.textType)return 0;const{limitWidth:e}=this,{textAlign:i}=this.parsedStyle,s=t?t.widthWithoutLF:0;let n=0;return "center"===i?n=(Math.max(e,this.textMaxWidth)-s)/2:"right"===i&&(n=Math.max(e,this.textMaxWidth)-s),n}getPath(){var t;if(!this.pathDirty)return this.path;const{width:e,height:i}=this.getBoundingRect(),s=.5*((null===(t=this.parsedStyle.borderWidth)||void 0===t?void 0:t.value)||0),n=s,o=s,r=e-2*s,a=i-2*s;if(this.path=[{x:n,y:o},{x:n+r,y:o},{x:n+r,y:o+a},{x:n,y:o+a}],this.steps=da(this.path),"textBox"===this.textType){const t=this.borderOffset/2;this.renderClipPath=[{x:n+t,y:o+t},{x:n+r-t,y:o+t},{x:n+r-t,y:o+a-t},{x:n+t,y:o+a-t}],this.renderClipStep=da(this.renderClipPath);}return this.pathDirty=!1,this.path}setLimitWidth(t){const{borderWidth:e,borderColor:i}=this.parsedStyle;"textBox"===this.textType&&e.value&&!i.isNone&&(this.borderOffset=e.value,this.padding=e.value),this.limitWidth=t-2*this.borderOffset-2*this.padding;}updateTextLinesForTranslate(t,e){this.lines.forEach((i=>{i.x+=t,i.y+=e,i.words.forEach((e=>{e.x+=t;}));}));}calculateTextLines(){const{textContents:t,x:e}=this.parsedStyle;if(null==t||!t.length||this.limitWidth<=0)return this.lines=[],void this.calculateTotalHeight();const i=e+this.borderOffset+this.padding;this.lines=function(t,e,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const n=document.createElement("div"),o=nl(n,e,t);document.body.appendChild(n);const r=[];let a,l=[],h={};const c=()=>{if(!l.length)return;h.x=i,h.words=l;const t=l.reduce(((t,e)=>t+e.wordWidth),0);h.width=t,r.push(h),l=[],h={};},d=(e,n,o,r)=>{const h=t[o];if(s){const s=[],r=/\S+/g;let c;for(;null!==(c=r.exec(e));)0===s.length&&0!==c.index?s.push(0):s.push(c.index);let d=n-(a||0)+i;for(let i=0;i<s.length;i++){const n=s[i],r=i===s.length-1?e.length:s[i+1],a=e.slice(n,r),c=tl(a,t[o]);l.push({freeContentIndex:o,originText:a,style:h,text:a,wordHeight:h.fontSize.value,wordWidth:c,x:d}),d+=c;}}else l.push({freeContentIndex:o,originText:e,style:h,text:e,wordHeight:h.fontSize.value,wordWidth:r,x:n-(a||0)+i});},u=(t,e)=>{d("\n",a||0,t,e),c();};for(let e=0;e<o.length;e++){const i=ol(o[e]);if(0===i.length)continue;const s=t[e].content.replace(/\r\n/g,"\n"),n=s.length,r=sl(s).length,l=s.slice(r),h=tl("\n",t[e]);if(r)for(let t=0;t<r;t++)u(e,h);i.length&&_s(a)&&(a=i[0].x);const p=i.map(((t,e)=>({obj:t,index:e,oldIndex:e,minIndex:void 0}))).filter((t=>{let{obj:e,index:i}=t;return e.x===a&&0!==i}));i.length&&i[0].x===a&&c();const g=i[i.length-1];if(n===i.length)if(p.length){let t=0;p.forEach((n=>{const{index:o}=n,r=s.slice(t,o),a=i[o-1],l=i[t].x;t=o,d(r,l,e,a.x-l+a.width),c();}));const n=s.slice(t),o=i[t].x;d(n,o,e,g.x-o+g.width);}else {const t=g.x-i[0].x+g.width;d(s,i[0].x,e,t);}else {const t=rl(l);for(let e=0;e<t.length;e++)p.forEach((i=>{i.index>=t[e]&&(i.index===t[e]&&_s(null==i?void 0:i.minIndex)&&(i.minIndex=t[e]),i.index+=1);}));if(p.length){let s=0,n=0;p.forEach(((t,o)=>{const{index:r,oldIndex:a,minIndex:p}=t;let g=0;if(_s(p)||(g=r-p),g){const t=l.slice(s,r-g+1),o=i[a-1],p=i[n].x,f=o.x-p+o.width+h;d(t,p,e,f),c();for(let t=0;t<g-1;t++)u(e,h);}else {const t=l.slice(s,r),o=i[a-1],h=i[n].x;d(t,h,e,o.x-h+o.width),c();}s=r,n=a;}));const o=t.filter((t=>t>p[p.length-1].index)).length,r=l.slice(s,l.length-o+1),a=i[i.length-1],g=i[p[p.length-1].oldIndex].x,f=o>0?a.x-g+a.width+h:a.x-g+a.width;d(r,g,e,f);for(let t=0;t<o-1;t++)0===t&&c(),u(e,h);}else if(t.length){const s=l.slice(0,l.length-t.length+1),n=g.x-i[0].x+g.width+h;d(s,i[0].x,e,n),c();for(let i=0;i<t.length-1;i++)u(e,h);}else {const t=g.x-i[0].x+g.width;d(l,i[0].x,e,t);}}}return c(),n.remove(),r}(t,this.limitWidth,i,"justify"===this.style.textAlign),this.organizeLine(),this.calculateTotalHeight();}calculateTotalHeight(){const{y:t,height:e}=this.parsedStyle,i=this.lines.length;if(i){const s=this.lines[i-1];let n=s.y+s.height*this.lineHeightOffset-t+2*this.borderOffset;il(s.words[0].text)&&(n+=s.height*(1+this.lineHeightOffset)),this.totalTextHeight=n>e.value?n:e.value;}else this.totalTextHeight=e.value;}getBoundingRect(){if(!this.boundsDirty)return this.bounds;const{x:t,y:e,height:i}=this.parsedStyle,s="freeTextWriter"===this.textType?this.totalTextHeight:i.value,n="freeTextWriter"===this.textType?this.textMaxWidth+2*this.borderOffset+2*this.padding:this.parsedStyle.width.value;return this.boundsDirty=!1,this.bounds={left:t,top:e,width:n,height:s},this.bounds}isPointInPath(t){return this.getBoundingRectObject().isPointInPath(t)}getTextEditor(){const t=document.createElement("div");nl(t,this.parsedStyle.width.value,this.parsedStyle.textContents,!0);const{borderWidth:e,borderColor:i,background:s,textAlign:n,opacity:o}=this.style,{lineDash:r}=this.parsedStyle;if(t.style.pointerEvents="auto",t.style.cursor="text",t.style.lineHeight="0",t.style.opacity=o.toString(),"textBox"===this.textType){const{height:o}=this.getBoundingRect();t.style.padding=`${this.padding}px`,t.style.boxSizing="border-box",t.style.minHeight=`${o}px`,t.style.border=`${e}px ${Jn(r)?"solid":"dashed"} ${i}`,t.style.background=s,t.style.textAlign=n,t.style.height="auto";}else {var a;const e=(null===(a=t.textContent)||void 0===a?void 0:a.replace(/\u200B/g,""))||"";t.style.border="1px solid black",t.style.maxWidth=`${this.parsedStyle.width.value}px`,t.style.border=e.length?"none":"1px solid black",t.style.minWidth="10px",t.style.width="max-content";}return t}}function tl(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{fontSize:s,fontStyle:n,fontFamily:o,fontWeight:r}=e,a=document.createElement("canvas").getContext("2d"),l=""===(null==o?void 0:o.trim())?"sans-serif":o;null!=o&&o.includes(" ")?a.font=`${n} ${r} ${s.value}${s.unit} '${l}'`:a.font=`${n} ${r} ${s.value}${s.unit} ${l}`;let h=0;for(let e=0;e<t.length;e++){const s=t.charAt(e);i&&el(s)||(h+=a.measureText(s).width);}return h}function el(t){return /^[\r\n]+$/.test(t)}function il(t){return t.endsWith("\n")||t.endsWith("\r")||t.endsWith("\r\n")}function sl(t){const e=t.match(/^(?:\r\n|\r|\n)*/);if(e){const t=e[0];let i=0;for(const e of t)"\n"!==e&&"\r"!==e||(i+=1);return t.includes("\r\n")&&(i-=1),Array.from({length:i},(()=>"\n"))}return []}function nl(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=[],o=document.createDocumentFragment();return t.style.width=`${e}px`,t.style.wordBreak="break-word",t.style.position="absolute",i.forEach((t=>{const{fontSize:e,fontStyle:i,fontFamily:r,fontWeight:a,color:l,content:h,underline:c,lineThrough:d}=t;if(!h.length)return;const u=""===(null==r?void 0:r.trim())?"sans-serif":r,p=null!=r&&r.includes(" ")?`${i} ${a} ${e.value}${e.unit} '${u}'`:`${i} ${a} ${e.value}${e.unit} ${u}`,g=document.createElement("div");if(g.style.font=p,g.style.letterSpacing="0px",g.style.whiteSpace="pre-wrap",g.style.display="inline",g.style.color=l,f=h,new RegExp(`([A-Za-z0-9])\\1{${10-1},}`).test(f)&&!s)for(let t=0;t<h.length;t++)if("\n"===h[t]||"\r"===h[t]||"\n\r"===h[t])g.appendChild(document.createElement("br"));else if(" "===h[t])g.appendChild(document.createTextNode(" "));else {const e=document.createElement("span");e.style.display="inline-block",e.innerText=h[t],g.appendChild(e);}else g.innerText=h;var f;o.appendChild(g),n.push(g);})),t.appendChild(o),n}function ol(t){const e=[],i=document.createRange(),s=function(t){const e=[],i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null);let s;for(;s=i.nextNode();)e.push(s);return e}(t);return s.forEach((t=>{i.selectNodeContents(t);const s=t.nodeValue;for(let n=0;n<s.length;n++){i.setStart(t,n),i.setEnd(t,n+1);const o=i.getClientRects(),r=o.length>1?o[1]:o[0];e.push({text:s[n],x:r.left,y:r.top,width:r.width,height:r.height});}})),function(t){const e=new Map;t.forEach((t=>{var i;e.has(t.y)||e.set(t.y,[]),null===(i=e.get(t.y))||void 0===i||i.push(t);})),e.forEach((t=>{t.sort(((t,e)=>t.x-e.x));}));const i=[];return e.forEach((t=>{i.push(...t);})),i}(e)}function rl(t){const e=/(\r\n|[\r\n])/g;let i;const s=[];for(;null!==(i=e.exec(t));)s.push(i.index);return s}const al=1/0;class ll{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:al,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:al,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1/0;i(this,"minX",void 0),i(this,"maxX",void 0),i(this,"minY",void 0),i(this,"maxY",void 0),i(this,"rect",void 0),i(this,"updateId",void 0),this.minX=t,this.maxX=e,this.minY=s,this.maxY=n,this.rect=null,this.updateId=-1;}static isEmpty(t){return t.minX===t.maxX&&t.minY===t.maxY}static fromBounds(t){return (new ll).setFromBounds(t)}static create(){return new ll}setFromBounds(t){return this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY,this}clear(){return this.minX=al,this.maxX=-1/0,this.minY=al,this.maxY=-1/0,this}getRect(t){const{minX:e,minY:i,maxX:s,maxY:n}=this;if(e>s||i>n)return new ln(0,0,0,0);const o=t||new ln;return o.update(e,i,s-e,n-i),o}addPoint(t){return this.addBounds({minX:t.x,maxX:t.x,minY:t.y,maxY:t.y})}addBounds(t){const e=cl(this,t);return this.setFromBounds(e)}addBoundsMask(t,e){const i=hl(t,e);if(i.minX<=i.maxX&&i.minY<=i.maxY){const t=cl(i,this);this.setFromBounds(t);}return this}intersection(t){if(i=t,!((e=this).minX<=i.maxX&&e.maxX>=i.minX&&e.minY<=i.maxY&&e.maxY>=i.minY))return null;var e,i;const s=hl(this,t);return ll.fromBounds(s)}union(t){const e=cl(this,t);return ll.fromBounds(e)}addBoundsArea(t,e){const{x:i,y:s,width:n,height:o}=e,r={minX:i,minY:s,maxX:i+n,maxY:s+o};return this.addBoundsMask(t,r)}addFrame(t,e){return this.setFromTransformedBounds(t.worldTransform,e)}setFromTransformedBounds(t,e){for(let i=0;i<2;i++){const s=t.transformPoint({x:i?e.maxX:e.minX,y:i?e.maxY:e.minY});this.addPoint(s);}return this}addQuad(t){for(let e=0;e<4;e++)this.addPoint({x:t[2*e],y:t[2*e+1]});}}function hl(t,e){return {minX:t.minX>e.minX?t.minX:e.minX,minY:t.minY>e.minY?t.minY:e.minY,maxX:t.maxX<e.maxX?t.maxX:e.maxX,maxY:t.maxY<e.maxY?t.maxY:e.maxY}}function cl(t,e){return {minX:t.minX<e.minX?t.minX:e.minX,minY:t.minY<e.minY?t.minY:e.minY,maxX:t.maxX>e.maxX?t.maxX:e.maxX,maxY:t.maxY>e.maxY?t.maxY:e.maxY}}class dl extends Ua{constructor(){super({}),i(this,"name","Document"),i(this,"defaultView",void 0),i(this,"documentElement",void 0),i(this,"timeLine",void 0),this.nodeName="document",this.documentElement=new Ua({name:"Root",id:"root",style:{visibility:"visible"}}),this.documentElement.ownerDocument=this,this.documentElement.parentNode=this,this.childNodes=[this.documentElement];}get children(){return this.childNodes}get childElementCount(){return this.childNodes.length}get firstElementChild(){return this.firstChild}get lastElementChild(){return this.lastChild}createElement(t,e){const i=this.defaultView.customElements.get(t);return new i(e)}getElementById(t){return null}getElementsByName(t){return this.documentElement.getElementsByTagName(t)}getElementsByTagName(t){return this.documentElement.getElementsByTagName(t)}getElementsByClassName(t){return this.documentElement.getElementsByClassName(t)}append(){return this.documentElement.append(...arguments)}prepend(){return this.documentElement.prepend(...arguments)}querySelector(t){return this.documentElement.querySelector(t)}querySelectorAll(t){return this.documentElement.querySelectorAll(t)}find(t){return this.documentElement.find(t)}findAll(t){return this.documentElement.findAll(t)}appendChild(t){return this.documentElement.appendChild(t)}cloneNode(t){return this.documentElement.cloneNode(t)}insertBefore(t,e){return this.documentElement.insertBefore(t,e)}removeChild(t){return this.documentElement.removeChild(t)}replaceChild(t,e){return this.documentElement.replaceChild(t,e)}destroy(){}}class ul extends ir{constructor(){super(...arguments),i(this,"altKey",void 0),i(this,"button",void 0),i(this,"buttons",void 0),i(this,"ctrlKey",void 0),i(this,"metaKey",void 0),i(this,"shiftKey",void 0),i(this,"relatedTarget",void 0),i(this,"client",new Yr),i(this,"movement",new Yr),i(this,"offset",new Yr),i(this,"page",new Yr),i(this,"screen",new Yr),i(this,"global",new Yr),i(this,"canvas",new Yr);}initEvent(t,e,i){throw new Error("Method not implemented.")}get clientX(){return this.client.x}get clientY(){return this.client.y}get x(){return this.client.x}get y(){return this.client.y}get movementX(){return this.movement.x}get movementY(){return this.movement.x}get offsetX(){return this.offset.x}get offsetY(){return this.offset.y}get pageX(){return this.page.x}get pageY(){return this.page.y}get screenX(){return this.screen.x}get screenY(){return this.screen.y}get globalX(){return this.global.x}get globalY(){return this.global.y}get canvasX(){return this.canvas.x}get canvasY(){return this.canvas.y}getModifierState(t){return "getModifierState"in this.nativeEvent&&this.nativeEvent.getModifierState(t)}initMouseEvent(t,e,i,s,n,o,r,a,l,h,c,d,u,p,g){throw this.initUIEvent(t,i,i,s,n),new Error("initMouseEvent() DOM API is deprecated.")}}function pl(t,e){e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey,e.relatedTarget=null,e.client.setFromPoint(t.client),e.movement.setFromPoint(t.movement),e.offset.setFromPoint(t.offset),e.page.setFromPoint(t.page),e.screen.setFromPoint(t.screen),e.global.setFromPoint(t.global),e.canvas.setFromPoint(t.canvas);}class gl extends ul{constructor(){super(...arguments),i(this,"deltaMode",void 0),i(this,"deltaX",void 0),i(this,"deltaY",void 0),i(this,"deltaZ",void 0),i(this,"DOM_DELTA_PIXEL",0),i(this,"DOM_DELTA_LINE",1),i(this,"DOM_DELTA_PAGE",2);}}function fl(t,e){e.deltaMode=t.deltaMode,e.deltaX=t.deltaX,e.deltaY=t.deltaY,e.deltaZ=t.deltaZ;}class vl extends ul{constructor(t){super(t),i(this,"height",0),i(this,"isPrimary",void 0),i(this,"pointerId",void 0),i(this,"pointerType",void 0),i(this,"pressure",void 0),i(this,"tangentialPressure",void 0),i(this,"tiltX",void 0),i(this,"tiltY",void 0),i(this,"twist",void 0),i(this,"width",0),i(this,"getCoalescedEvents",void 0),i(this,"getPredictedEvents",void 0),this.isPrimary=!1,this.height=0,this.width=0;}}function ml(t,e){e.isPrimary=t.isPrimary,e.width=t.width,e.height=t.height,e.tiltX=t.tiltX,e.tiltY=t.tiltY,e.pointerType=t.pointerType,e.pointerId=t.pointerId,e.pressure=t.pressure,e.twist=t.twist,e.tangentialPressure=t.tangentialPressure;}class yl{constructor(t,e){i(this,"root",void 0),i(this,"cursor","default"),i(this,"events",void 0),i(this,"trackingData",void 0),i(this,"contextService",void 0),this.root=t,this.contextService=e,this.events={},this.trackingData={},this.on("pointerdown",this.onPointerdown.bind(this)),this.on("pointermove",this.onPointermove.bind(this)),this.on("pointerout",this.onPointerout.bind(this)),this.on("pointerleave",this.onPointerout.bind(this)),this.on("pointerover",this.onPointerover.bind(this)),this.on("pointerup",this.onPointerup.bind(this)),this.on("wheel",this.onWheel.bind(this));}clientToCanvas(t){const e=this.contextService.getBoundingClientRect();return new Yr(t.x-(e.x||0),t.y-(e.y||0))}canvasToClient(t){const e=this.root.defaultView.contextService.getBoundingClientRect();return new Yr(t.x+(e.x||0),t.y+(e.y||0))}getPropagationPath(t){const e=[t];for(;Ua.isNode(t)&&t!==this.root;)t=t.parentNode,e.push(t);return e.reverse()}getHitTarget(t,e){const{root:i}=this,{isInteractive:s}=i,n=bl(i,s,new Yr(t,e));return n?n[0]:null}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push({fn:e,order:0}),this.events[t].sort(((t,e)=>t.order-e.order));}emit(t){if(!this.root)return;const e=this.events[t.type]||[];for(let i=0;i<e.length;i++)e[i].fn(t);}onPointerdown(t){if(!(t instanceof vl))return;const e=this.generatePointerEvent(t);let i;ar(e,"pointerdown"),"touch"===e.pointerType?i="touchstart":xl(e)&&(i=2===e.button?"rightdown":"mousedown"),ar(e,i);this.getTrackingData(t.pointerId).pressTargetsByButton[t.button]=e.composedPath();}onPointermove(t){if(!(t instanceof vl))return;const e=this.generatePointerEvent(t),i=xl(e),s=this.getTrackingData(t.pointerId),n=wl(s.overTargets);if(n&&n!==e.target){const s="mousemove"===t.type?"mouseout":"pointerout",o=this.generatePointerEvent(t,s,n);ar(o,"pointerout"),i&&ar(o,"mouseout");const r=e.composedPath();if(!r.includes(n)){const e=this.generatePointerEvent(t,"pointerleave",n);for(e.eventPhase=e.AT_TARGET;e.target&&!r.includes(e.target);)e.currentTarget=e.target,rr(e,e.type),i&&rr(e,"mouseleave"),e.target=e.target.parentNode;}}if(n!==e.target){const s="mousemove"===t.type?"mouseover":"pointerover",o=this.clonePointerEvent(e,s);ar(o,"pointerover"),i&&ar(o,"mouseover");let r=Ua.isNode(n)&&(null==n?void 0:n.parentNode);for(;r&&r!==(Ua.isNode(this.root)&&this.root.parentNode)&&r!==e.target;)r=r.parentNode;if(!r||r===this.root.parentNode){const t=this.clonePointerEvent(e,"pointerenter");for(t.eventPhase=t.AT_TARGET;t.target&&t.target!==n&&t.target!==this.root.parentNode;)t.currentTarget=t.target,rr(t,t.type),i&&rr(t,"mouseenter"),t.target=t.target.parentNode;}}var o;(ar(e,"pointermove"),"touch"===e.pointerType&&ar(e,"touchmove"),i)&&(ar(e,"mousemove"),this.cursor=null===(o=e.target)||void 0===o?void 0:o.cursor);s.overTargets=e.composedPath();}onPointerup(t){if(!(t instanceof vl))return;const e=performance.now(),i=this.generatePointerEvent(t);ar(i,"pointerup");const{pointerType:s}=i;let n;"touch"===s?n="touchend":xl(i)&&(n=2===i.button?"rightup":"mouseup"),ar(i,n);const o=this.getTrackingData(t.pointerId),r=wl(o.pressTargetsByButton[t.button]);let a=r;const l=i.composedPath();if(r&&!l.includes(r)){let e=r;for(;e&&!l.includes(e);)i.currentTarget=e,rr(i,"pointerupoutside"),"touch"===s?n="touchendoutside":xl(i)&&(n=2===i.button?"rightupoutside":"mouseupoutside"),rr(i,n),e=e.parentNode;delete o.pressTargetsByButton[t.button],a=e;}if(a){const r=this.clonePointerEvent(i,"click");r.target=a,r.path=null,o.clicksByButton[t.button]||(o.clicksByButton[t.button]={clickCount:0,target:r.target,timeStamp:e});const l=o.clicksByButton[t.button];l.target===r.target&&e-l.timeStamp<200?l.clickCount+=1:l.clickCount=1,l.target=r.target,l.timeStamp=e,r.detail=l.clickCount,n="mouse"===s?"click":"touch"===s?"tap":"pointertap",ar(r,n);}}onPointerout(t){if(!(t instanceof vl))return;const e=this.getTrackingData(t.pointerId);if(e.overTargets){const i=xl(t),s=wl(e.overTargets),n=this.generatePointerEvent(t,"pointerout",s);ar(n),i&&ar(n,"mouseout");const o=this.generatePointerEvent(t,"pointerleave",s);for(o.eventPhase=o.AT_TARGET;o.target&&o.target!==this.root.parentNode;)o.currentTarget=o.target,rr(o,o.type),i&&rr(o,"mouseleave"),o.target=o.target.parentNode;e.overTargets=null;}this.cursor=null;}onPointerover(t){if(!(t instanceof vl))return;const e=this.getTrackingData(t.pointerId),i=this.generatePointerEvent(t),s=xl(t);var n;(ar(i,"pointerover"),s&&ar(i,"mouseover"),"mouse"===i.pointerType)&&(this.cursor=null===(n=i.target)||void 0===n?void 0:n.cursor);const o=this.clonePointerEvent(i,"pointerenter");for(o.eventPhase=o.AT_TARGET;o.target&&o.target!==this.root.parentNode;)o.currentTarget=i.target,rr(o,o.type),s&&rr(o,"mouseenter"),o.target=o.target.parentNode;e.overTargets=i.composedPath();}onWheel(t){if(!(t instanceof gl))return;ar(this.generateWheelEvent(t));}generatePointerEvent(t,e,i){const s=new vl(this);return ml(t,s),pl(t,s),sr(t,s),s.nativeEvent=t.nativeEvent,s.originalEvent=t,s.target=null!=i?i:this.getHitTarget(s.globalX,s.globalY),s.type=null!=e?e:s.type,s}generateWheelEvent(t){const e=new gl(this);return fl(t,e),pl(t,e),sr(t,e),e.nativeEvent=t.nativeEvent,e.originalEvent=t,e.target=this.getHitTarget(e.globalX,e.globalY),e}clonePointerEvent(t,e){const i=new vl(this);return ml(t,i),pl(t,i),sr(t,i),i.nativeEvent=t.nativeEvent,i.originalEvent=t,i.target=t.target,i.path=t.composedPath().slice(),i}getTrackingData(t){return this.trackingData[t]||(this.trackingData[t]={pressTargetsByButton:{},clicksByButton:{},overTargets:null}),this.trackingData[t]}}function xl(t){const{pointerType:e}=t;return "mouse"===e||"pen"===e}function wl(t){if(!t)return null;let e=t[0]||null;for(let i=1,s=t.length;i<s&&t[i].parentNode===e;i++)e=t[i];return e}function bl(t,e,i){if(!t||"visible"!==t.style.visibility)return null;const{hitArea:s}=t.style;if(s){const{x:e,y:n}=t.transform.worldTransform.transformPoint(i);if(!s.contains(e,n))return null}const{clipPath:n}=t.style;if(n&&!n.containPoint(i))return null;if(t.isChildrenInteractive&&t.children){const{children:s}=t;for(let n=s.length-1;n>=0;n--){const o=s[n],r=bl(o,e||o.isInteractive,i);if(r)return (r.length>0||t.isInteractive)&&r.push(t),r}}return e&&t.containPoint(i)?t.isInteractive?[t]:[]:null}i(class{constructor(){i(this,"canvasConfig",void 0),i(this,"contextService",void 0),i(this,"renderingContext",void 0),i(this,"eventService",void 0),i(this,"rootPointerEvent",new vl(null)),i(this,"rootWheelEvent",new gl(null)),i(this,"autoPreventDefault",!0);}init(t){const{renderingService:e,renderingContext:i,contextService:s,canvasConfig:n}=t;this.eventService=new yl(i.root.parentNode,s),t.eventService=this.eventService,this.renderingContext=i,this.contextService=s,this.canvasConfig=n,e.hooks.wheel.on(this.onWheel),e.hooks.pointerdown.on(this.onPointerdown),e.hooks.pointermove.on(this.onPointermove),e.hooks.pointerup.on(this.onPointerup),e.hooks.pointerout.on(this.onPointermove),e.hooks.pointerover.on(this.onPointermove);}destroy(){}onWheel(t){const e=this.normalizeWheelEvent(t);this.eventService.emit(e);}onPointerdown(t){if(this.isTouchEvent(t))return;const e=this.normalizeToPointerEvent(t);if(this.autoPreventDefault&&e.isNormalized){(t.cancelable||!("cancelable"in t))&&t.preventDefault();}const i=this.bootstrapEvent(e,this.rootPointerEvent);this.eventService.emit(i),this.setCursor(this.eventService.cursor);}onPointermove(t){if(this.isTouchEvent(t))return;const e=this.normalizeToPointerEvent(t),i=this.bootstrapEvent(e,this.rootPointerEvent);this.eventService.emit(i),this.setCursor(this.eventService.cursor);}onPointerup(t){if(this.isTouchEvent(t))return;const e=this.contextService.getDomElement(),i=t.target===e?"":"outside",s=this.normalizeToPointerEvent(t),n=this.bootstrapEvent(s,this.rootPointerEvent);n.type+=i,this.eventService.emit(n),this.setCursor(this.eventService.cursor);}setCursor(t){this.contextService.setCursor(t||this.canvasConfig.cursor||"default");}normalizeWheelEvent(t){const e=this.rootWheelEvent;e.nativeEvent=t,this.transferMouseData(t,e),fl(t,e);const i=new Yr(t.clientX,t.clientY),{x:s,y:n}=this.eventService.clientToCanvas(i);return e.canvas.x=s,e.canvas.y=n,e.offset.setFromPoint(e.canvas),e.global.setFromPoint(e.canvas),sr(t,e),e}normalizeToPointerEvent(t){const e=this.renderingContext.root.ownerDocument.defaultView;if(e.supportTouchEvent&&t instanceof TouchEvent){const e=t;e.isNormalized=!0,e.pointerType="touch";}else if(!MouseEvent||t instanceof MouseEvent&&(!e.supportPointerEvent||!(t instanceof PointerEvent))){const e=t;e.isPrimary=!0,e.width=1,e.height=1,e.tiltX=0,e.tiltY=0,e.pointerType="mouse",e.pointerId=1,e.pressure=.5,e.twist=0,e.tangentialPressure=0,e.isNormalized=!0;}return t}bootstrapEvent(t,e){this.renderingContext.root.ownerDocument.defaultView,e.originalEvent=null,e.nativeEvent=t,ml(t,e),this.transferMouseData(t,e);const{x:i,y:s}=this.eventService.clientToCanvas(new Yr(t.clientX,t.clientY));return e.canvas.x=i,e.canvas.y=s,e.offset.setFromPoint(e.canvas),e.global.setFromPoint(e.canvas),sr(t,e),"pointerleave"===e.type&&(e.type="pointerout"),e.type.startsWith("mouse")&&e.type.replace("mouse","pointer"),e}transferMouseData(t,e){e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey,e.relatedTarget=null,e.client.x=t.clientX,e.client.y=t.clientY,e.movement.x=t.movementX,e.movement.y=t.movementY,e.page.x=t.pageX,e.page.y=t.pageY,e.screen.x=t.screenX,e.screen.y=t.screenY;}isTouchEvent(t){return this.renderingContext.root.ownerDocument.defaultView.supportTouchEvent&&"touch"===t.pointerType}},"moduleName","Event");class Sl extends ir{constructor(t,e,s,n,o,r,a,l){super(null),i(this,"relatedNode",void 0),i(this,"prevValue",void 0),i(this,"newValue",void 0),i(this,"attrName",void 0),i(this,"attrChange",void 0),i(this,"prevParsedValue",void 0),i(this,"newParsedValue",void 0),this.type=t,this.relatedNode=e,this.prevValue=s,this.newValue=n,this.attrName=o,this.attrChange=r,this.prevParsedValue=a,this.newParsedValue=l;}}i(Sl,"ADDITION",2),i(Sl,"MODIFICATION",1),i(Sl,"REMOVAL",3);class Cl{constructor(t){i(this,"contextService",void 0),i(this,"renderingPlugins",[]),i(this,"config",{autoRendering:!0}),Object.assign(this.config,t);}use(t){this.renderingPlugins.includes(t)||this.renderingPlugins.push(t);}initPlugins(t){this.renderingPlugins.forEach((e=>{e.init(t);}));}destroyPlugins(){this.renderingPlugins.forEach((t=>{t.destroy();}));}getPlugins(){return this.renderingPlugins}getAnnotationConfig(){return this.config}}class Pl{constructor(t){i(this,"hooks",{init:tn.create(),beginFrame:tn.create(),beforeRender:tn.create(),render:tn.create(),afterRender:tn.create(),putImageData:tn.create(),endFrame:tn.create(),destroy:tn.create(),pointerdown:tn.create(),pointerup:tn.create(),pointermove:tn.create(),pointerout:tn.create(),pointerover:tn.create(),pointerCancel:tn.create(),wheel:tn.create()}),i(this,"isInited",!1),i(this,"zIndexCounter",0),i(this,"renderingContext",void 0),this.renderingContext=t;}init(){this.hooks.init.emit(),this.isInited=!0;}destroy(){this.isInited=!1,this.hooks.destroy.emit();}render(){const{root:t}=this.renderingContext;this.zIndexCounter=0,mr.recursiveUpdateHierarchy(t),this.isInited&&(this.renderDisplayObject(t),this.renderingContext.dirty&&(this.hooks.endFrame.emit(),this.renderingContext.dirty=!1),this.renderingContext.renderCondition.clear());}renderDisplayObject(t){if(!t.isVisible)return;const{sortable:e}=t;if(e.renderOrder=this.zIndexCounter,this.zIndexCounter+=1,this.renderingContext.dirty||(this.renderingContext.dirty=!0,this.hooks.beginFrame.emit()),t.imageData)return void this.hooks.putImageData.emit(t);this.hooks.beforeRender.emit(t),this.hooks.render.emit(t),this.hooks.afterRender.emit(t);let i=!1;e.dirty&&(e.sorted=t.childNodes.slice().sort(Tl),e.dirty=!1,i=!0);let s=e.sorted||t.childNodes;t.isTab?(s=t.visibleChildren,s.sort(((t,e)=>t.index-e.index)),s.length>1&&s.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),s.forEach((t=>{this.renderDisplayObject(t);}))):(s.sort(((t,e)=>t.index-e.index)),s.length>1&&s.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),s.forEach((t=>{this.renderDisplayObject(t);}))),s.sort(((t,e)=>t.index-e.index)),i&&t.recursiveCall((t=>{const e=new nr("renderOrderChanged",{renderOrder:t.sortable.renderOrder});t.dispatchEvent(e);}));}dirty(){this.renderingContext.renderCondition.add(0);}}function Tl(t,e){const i=Number(t.style.zIndex),s=Number(e.style.zIndex);if(i===s&&t.parentNode){const{childNodes:i=[]}=t.parentNode;return i.indexOf(t)-i.indexOf(e)}return i-s}class Al extends or{constructor(t){super(),i(this,"document",void 0),i(this,"customElements",void 0),i(this,"devicePixelRatio",void 0),i(this,"eventService",void 0),i(this,"renderingService",void 0),i(this,"renderingContext",void 0),i(this,"canvasConfig",void 0),i(this,"renderer",void 0),i(this,"supportTouchEvent",void 0),i(this,"supportPointerEvent",void 0),i(this,"limit1px",!1),i(this,"contextService",void 0);const{renderer:e,dpr:s,width:n,height:o,canvas:r,supportPointerEvent:a,supportTouchEvent:l}=t;this.supportPointerEvent=null!=a?a:!!globalThis.PointerEvent,this.supportTouchEvent=null!=l?l:"touchstart"in window;let h=n,c=o,d=s;r&&(d=s||window.devicePixelRatio||1,h=n||r.width/d,c=o||r.height/d),this.canvasConfig={...t,width:h,height:c,dpr:d},this.canvasConfig=t,this.renderer=e,this.document=new dl,this.document.defaultView=this,this.initRenderingContext(),this.renderingService=new Pl(this.renderingContext),this.initRenderer(e);}initRenderingContext(){this.renderingContext={root:this.document.documentElement,force:!1,dirty:!1,renderCondition:new Set},this.document.documentElement.addEventListener("child-inserted",(t=>{this.mountChildren(t.detail.child);})),this.document.documentElement.addEventListener("child-removed",(t=>{this.unmountChildren(t.detail.child);}));}initRenderer(t){this.renderingService.init(),t.initPlugins(this),this.contextService.init();t.getAnnotationConfig().autoRendering&&this.render(),this.document.documentElement.recursiveCall((t=>{const{renderable:e}=t;e&&(e.boundsDirty=!0,e.renderBoundsDirty=!0);})),this.mountChildren(this.document.documentElement);}render(){const t=new nr("beforeRender",{});this.dispatchEvent(t),this.contextService.clearCanvas(),this.renderingService.render();}setDPR(t){this.canvasConfig.dpr=t,this.contextService.setDPR(t);}resize(t,e){this.canvasConfig.width=t,this.canvasConfig.height=e,this.contextService.resize(t,e);}getContextService(){return this.contextService}getEventService(){return this.eventService}appendChild(t,e){return this.document.documentElement.appendChild(t,e)}insertBefore(t,e){return this.document.documentElement.insertBefore(t,e)}removeChild(t){return this.document.documentElement.removeChild(t)}getBoundingClientRect(){return this.contextService.getBoundingClientRect()}mountChildren(t){t.recursiveCall((t=>{if(!t.isConnected){t.isConnected=!0,t.ownerDocument=this.document;const e=new nr("DOMNodeInsertedIntoDocument",{});t.dispatchEvent(e);}}));}unmountChildren(t){const e=[];t.recursiveCall((t=>{t.isConnected&&e.push(t);})),e.reverse().forEach((t=>{t.isConnected=!1;const e=new nr("DOMNodeRemovedFromDocument",{});t.dispatchEvent(e),t!==this.document.documentElement&&(t.ownerDocument=null);}));}}class kl{}class Dl extends kl{constructor(t){super(),i(this,"close",!0),i(this,"shape",void 0),i(this,"ctx",void 0),i(this,"rCanvas",void 0),this.rCanvas=t;}render(t,e){const{background:i,borderColor:s,visibility:n}=t.parsedStyle;if("hidden"===n)return;const o=!Un(i)&&!i.isNone,r=!Un(s)&&!s.isNone;t.renderClipStep&&(e.beginPath(),t.renderClipStep.forEach((t=>{ua(e,t);})),e.closePath(),e.clip()),this.renderPath(t,e),o&&this.renderFill(t,e),this.renderStrokePath(t,e),r&&this.renderStroke(t,e);}renderPath(t,e){t.getPath(),e.beginPath(),t.steps.forEach((t=>{ua(e,t);})),this.close&&t.steps.length>2&&e.closePath();}renderStrokePath(t,e){zs(null==t?void 0:t.getStrokePath)&&(t.getStrokePath(),0!==t.strokePath.length&&(e.beginPath(),t.strokeSteps.forEach((t=>{ua(e,t);})),this.close&&t.strokeSteps.length>2&&e.closePath()));}renderFill(t,e){const{parsedStyle:i}=t,{background:s,opacity:n,fillOpacity:o,renderBlendMode:r}=i;if(e.save(),e.globalAlpha=n*o,"normal"!==r&&(e.globalCompositeOperation=r),Array.isArray(s)){this.setShapeGradientOrigin(t,e);for(let i=0;i<s.length;i++)0===i&&this.setShadow(t,e),e.fillStyle=this.getColor(t,s[i],e),e.fill();}else this.setShadow(t,e),e.fillStyle=s.formatted,e.fill();e.restore();}renderStroke(t,e){const{parsedStyle:i}=t,{borderWidth:s,borderColor:n,opacity:o,lineCap:r,lineJoin:a,miterLimit:l,lineDash:h,lineDashOffset:c,borderOpacity:d,renderBlendMode:u}=i;if(s&&s.value>0){if(e.save(),!Un(s)){const i=t.getScale();this.rCanvas.limit1px?e.lineWidth=Math.max(1/i.x,s.value):e.lineWidth=s.value;}"normal"!==u&&(e.globalCompositeOperation=u),e.miterLimit=l,e.globalAlpha=o*d,e.lineCap=r,e.lineJoin=a,e.setLineDash(Jn(h)?[0,0]:h),e.lineDashOffset=c.value,Array.isArray(n)?(this.setShapeGradientOrigin(t,e),n.forEach((i=>{e.strokeStyle=this.getColor(t,i,e),e.stroke();}))):(e.strokeStyle=n.formatted,e.stroke()),e.restore();}}setShadow(t,e){const{shadow:i,shadowOffsetX:s,shadowOffsetY:n,shadowBlur:o,shadowColor:r}=t.parsedStyle;(i||r)&&(e.shadowOffsetX=(null==s?void 0:s.value)||i[0],e.shadowOffsetY=(null==n?void 0:n.value)||i[1],e.shadowBlur=(null==o?void 0:o.value)||i[2],e.shadowColor=(null==r?void 0:r.formatted)||i[3]);}getColor(t,e,i){let s;if(1===e.type||2===e.type){const n=t.getBoundingRect(),{width:o,height:r}=n;s=function(t,e){const{type:i,steps:s,width:n,height:o,angle:r,cx:a,cy:l,size:h}=t;let c=null;if(1===i){const{x1:t,y1:i,x2:s,y2:a}=function(t,e,i){const s=i*Math.PI/180,n=0+t/2,o=0+e/2,r=Math.abs(t*Math.cos(s))+Math.abs(e*Math.sin(s));return {x1:n-Math.cos(s)*r/2,y1:o-Math.sin(s)*r/2,x2:n+Math.cos(s)*r/2,y2:o+Math.sin(s)*r/2}}(n,o,r.value);c=e.createLinearGradient(t,i,s,a);}else if(2===i){const{x:t,y:i,r:s}=function(t,e,i,s,n){let o=i.value,r=s.value;"%"===i.unit&&(o=i.value/100*t),"%"===s.unit&&(r=s.value/100*e);let a=Math.max(cn({x:0,y:0},{x:o,y:r}),cn({x:0,y:e},{x:o,y:r}),cn({x:t,y:e},{x:o,y:r}),cn({x:t,y:0},{x:o,y:r}));return n&&(Os(n)?a=n.value:Xs(n)&&("closest-side"===n?a=Math.min(o,t-o,r,e-r):"farthest-side"===n?a=Math.max(o,t-o,r,e-r):"closest-corner"===n&&(a=Math.min(cn({x:0,y:0},{x:o,y:r}),cn({x:0,y:e},{x:o,y:r}),cn({x:t,y:e},{x:o,y:r}),cn({x:t,y:0},{x:o,y:r}))))),{x:o,y:r,r:a}}(n,o,a,l,h);c=e.createRadialGradient(t,i,0,t,i,s);}c&&s.forEach((t=>{let{offset:e,color:i}=t;var s;"%"===e.unit&&(null===(s=c)||void 0===s||s.addColorStop(e.value/100,i.toString()));}));return c}({type:e.type,...e.value,width:o,height:r},i);}return s}setShapeGradientOrigin(t,e){const{type:i}=t.config;switch(i){case"circle":case"arc":{const{r:i}=t.parsedStyle;e.translate(0-i.value,0-i.value);break}case"ellipse":{const{rx:i,ry:s}=t.parsedStyle;e.translate(0-i.value,0-s.value);break}default:e.translate(0,0);}}}class Rl extends Dl{constructor(t){super(t),this.close=!1;}}class El extends Dl{}class Ml extends Dl{}class Il extends Dl{async render(t,e){const{width:i,height:s,img:n,opacity:o,visibility:r}=t.parsedStyle;if("hidden"!==r){if(n&&!Xs(n)){if(e.save(),e.globalAlpha=o,n instanceof ImageData)e.putImageData(n,0,0);else {e.imageSmoothingEnabled=!0,e.imageSmoothingQuality&&(e.imageSmoothingQuality="high");try{e.drawImage(n,0,0,i.value,s.value);}catch(t){}}e.restore();}if(t.defaultRenderPage&&(e.save(),e.drawImage(t.defaultRenderPage,0,0,i.value,s.value),e.restore()),t.visiblePartData){const{x:i}=t.visiblePartData.visiblePart,{y:s}=t.visiblePartData.visiblePart;e.save();const n=t.visiblePartData.visiblePart.imageScale;e.scale(1/n.x,1/n.y),e.drawImage(t.visiblePartData.data,i,s,t.visiblePartData.visiblePart.width/devicePixelRatio,t.visiblePartData.visiblePart.height/devicePixelRatio),e.restore();}}}}class Bl extends Dl{constructor(){super(...arguments),i(this,"close",!1);}render(t,e){const{visibility:i}=t.parsedStyle;"hidden"!==i&&(this.renderPath(t,e),this.renderStroke(t,e));}renderPath(t,e){t.getPath(),e.beginPath(),t.inkRenderSteps.forEach((t=>{t.forEach((t=>{ua(e,t);}));}));}}class Ul extends Dl{}class Ll extends Dl{render(t,e){const{background:i,borderColor:s,visibility:n}=t.parsedStyle;if("hidden"===n)return;const o=!Un(i)&&!i.isNone,r=!Un(s)&&!s.isNone;t.renderClipStep&&(e.beginPath(),t.renderClipStep.forEach((t=>{ua(e,t);})),e.closePath(),e.clip()),t.getPath();const a=t.steps.length;for(let i=0;i<a;i++){const s=t.steps[i];e.beginPath(),s.step.forEach((t=>{ua(e,t);})),s.close&&(e.closePath(),o&&this.renderFill(t,e)),r&&this.renderStroke(t,e);}}}class Ol extends Dl{}class Nl extends Dl{constructor(){super(...arguments),i(this,"close",!0);}renderPath(t,e){t.getPath(),e.beginPath(),t.steps.forEach((t=>{ua(e,t),t.close&&e.closePath();}));}}class _l extends Dl{render(t,e){const{background:i,borderColor:s,visibility:n}=t.parsedStyle;if("hidden"===n)return;const o=!Un(i)&&!i.isNone,r=!Un(s)&&!s.isNone;t.getPath();const a=t.steps.length;for(let i=0;i<a;i++){const s=t.steps[i];e.beginPath(),s.step.forEach((t=>{ua(e,t);})),s.close&&(e.closePath(),o&&this.renderFill(t,e)),r&&this.renderStroke(t,e);}}}class Wl extends Dl{render(t,e){const{width:i,height:s,roundedRadius:n,background:o,borderWidth:r,visibility:a}=t.parsedStyle;if("hidden"!==a){for(let t=0;t<4;t++){e.beginPath();const t=n.value;if(0===t)e.rect(0,0,i.value,s.value);else {const{PI:n}=Math;e.arc(t,t,t,n,3*n/2),e.arc(i.value-t,t,t,3*n/2,2*n),e.arc(i.value-t,s.value-t,t,0,n/2),e.arc(t,s.value-t,t,n/2,n);}}e.closePath(),o&&this.renderFill(t,e),r.value>0&&this.renderStroke(t,e);}}}class Fl extends Dl{render(t,e){t&&"hidden"!==t.parsedStyle.visibility&&(this.renderBox(t,e),e.save(),t.renderClipStep&&(e.beginPath(),t.renderClipStep.forEach((t=>{ua(e,t);})),e.closePath(),e.clip()),this.renderText(t,e),e.restore());}renderBox(t,e){const{background:i,borderColor:s}=t.parsedStyle,n="textBox"===t.textType&&!Un(i)&&!i.isNone,o="textBox"===t.textType&&!Un(s)&&!s.isNone;this.renderPath(t,e),n&&this.renderFill(t,e),o&&this.renderStroke(t,e);}renderText(t,e){const{parsedStyle:i,lines:s}=t,{opacity:n,y:o,x:r}=i;e.globalAlpha=n,s.forEach((i=>{const s=i.height/30,n=t.getTextAlignOffset(i);i.words.forEach((t=>{const{color:a,fontFamily:l,fontSize:h,fontStyle:c,fontWeight:d,lineThrough:u,underline:p}=t.style;e.fillStyle=a;const g=""===l.trim()?"sans-serif":l,f=l.includes(" ")?`'${g}'`:g;e.font=`${c} ${d} ${h.value}${h.unit} ${f}`;let v=t.x-r+n;if(function(t){return /[\u0600-\u06FF]/.test(t)}(t.text))e.fillText(t.text,v,i.y-o);else for(let s=0;s<t.text.length;s++){const n=t.text.charAt(s);e.fillText(n,v,i.y-o),v+=e.measureText(n).width;}p&&e.fillRect(t.x-r+n,i.y-o+s,t.widthWithoutLf,s),u&&e.fillRect(t.x-r+n,i.y-t.wordHeight/3-o,t.widthWithoutLf,h.value/30);}));}));}}class Hl extends Dl{render(t,e){t&&"hidden"!==t.parsedStyle.visibility&&this.renderText(t,e);}renderText(t,e){const{parsedStyle:i}=t;t.setTextFont();const{text:s,font:n,opacity:o,color:r,y:a}=i;e.save(),e.globalAlpha=o,e.font=n,e.fillStyle=r.formatted,e.textBaseline="alphabetic",e.fillText(s,0,0),e.restore();}}class Vl{constructor(t){i(this,"canvasConfig",void 0),i(this,"container",void 0),i(this,"canvas",void 0),i(this,"dpr",void 0),i(this,"context",void 0),i(this,"shapeRenderers",{}),this.canvasConfig=t;}init(){const{container:t,canvas:e,dpr:i,willReadFrequently:s}=this.canvasConfig;if(e){this.canvas=e;const{parentElement:i}=e;t&&i!==t&&t.appendChild(e),this.container=i,this.canvasConfig.container=i;}else if(t&&(this.container=t,Xs(t)&&(this.container=document.getElementById(t)),this.container)){const t=document.createElement("canvas");this.container.appendChild(t),this.canvas=t;}this.context=this.canvas.getContext("2d",{willReadFrequently:s}),this.dpr=i||xn(),this.resize(this.canvasConfig.width,this.canvasConfig.height);}registerShapeRenderer(t,e){this.shapeRenderers[t]||(this.shapeRenderers[t]=e);}getShapeRenderer(t){return this.shapeRenderers[t]}destroy(){const{canvas:t,container:e}=this;e&&null!=t&&t.parentNode&&e.removeChild(t);}resize(t,e){const{canvas:i,dpr:s}=this;i&&(i.width=t*s,i.height=e*s,this.context.scale(s,s));}getDPR(){return this.dpr}setDPR(t){this.canvasConfig.dpr=t,this.dpr=t;}getContext(){return this.context}getDomElement(){return this.canvas}getCanvas(){return this.canvas}setCursor(t){var e;null!=this&&null!==(e=this.container)&&void 0!==e&&e.style&&(this.container.style.cursor=t);}getBoundingClientRect(){var t;return null===(t=this.canvas)||void 0===t?void 0:t.getBoundingClientRect()}clearCanvas(){this.canvas&&(this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.scale(this.dpr,this.dpr));}}class zl{constructor(){i(this,"restoreStack",[]);}init(t){const{hooks:e}=t.renderingService;e.endFrame.on((()=>{const{contextService:e}=t,i=e.getContext();this.restoreStack.forEach((()=>{i.restore();})),this.restoreStack=[];})),e.render.on((e=>{this.renderDisplayObject(e,t);})),e.putImageData.on((e=>{if(e.imageData){const{x:i,y:s}=e.getPosition(),n=t.contextService.getContext(),o=t.contextService.getDPR();n.putImageData(e.imageData,Math.floor(i*o+.5),Math.floor(s*o+.5));}}));}renderDisplayObject(t,e){if(!t.isVisible)return;const{contextService:i}=e,s=i.getContext();let n=this.restoreStack[this.restoreStack.length-1];for(;n&&t.parentNode!==n;)s.restore(),this.restoreStack.pop(),n=this.restoreStack[this.restoreStack.length-1];s.save(),this.applyTransform(s,t);const{clipPath:o}=t.style;o&&(s.save(),this.applyTransform(s,o),s.restore(),s.clip()),this.useAnchor(s,t);const r=i.getShapeRenderer(t.shapeType);r&&(r.render(t,s),t.clippable&&s.clip()),this.restoreStack.push(t);}applyTransform(t,e){e.externalMatrices.length&&e.externalMatrices.slice().reverse().forEach((e=>{const{a:i,b:s,c:n,d:o,e:r,f:a}=e;t.transform(i,s,n,o,r,a);}));const i=e.getLocalTransform(),{a:s,b:n,c:o,d:r,e:a,f:l}=i;t.transform(s,n,o,r,a,l);}applyAttributes(t,e,i){}useAnchor(t,e){const{anchor:i}=e.parsedStyle||{};if(!i||0===i[0]&&0===i[1])return;const s=e.getGeometryBounds().getRect();t.translate(-(i&&i[0]||0)*s.width,-(i&&i[1]||0)*s.height);}destroy(){}}i(zl,"moduleName",void 0);class $l{init(t){const e=new Vl(t.canvasConfig);t.contextService=e;[{name:"arc",renderer:new Rl(t)},{name:"circle",renderer:new El(t)},{name:"ellipse",renderer:new Ml(t)},{name:"line",renderer:new _l(t)},{name:"image",renderer:new Il(t)},{name:"ink",renderer:new Bl(t)},{name:"polygon",renderer:new Ul(t)},{name:"polyline",renderer:new Ll(t)},{name:"rect",renderer:new Ol(t)},{name:"stampText",renderer:new Hl(t)},{name:"stampPath",renderer:new Nl(t)},{name:"roundedRect",renderer:new Wl(t)},{name:"freeText",renderer:new Fl(t)}].forEach((t=>{let{name:i,renderer:s}=t;e.registerShapeRenderer(i,s);}));}destroy(){}}class jl extends Cl{constructor(t){super(t),this.use(new $l),this.use(new zl);}}function Xl(t,e,i){const s=e.x-t.x,n=e.y-t.y,o=i.x-t.x,r=s*(i.y-t.y)-n*o,a=an(t,e),l=an(t,i);let h=(a**2+l**2-an(e,i)**2)/(2*a*l);h<-1&&(h=-1),h>1&&(h=1);let c=180*Math.acos(h)/Math.PI;return c=Math.round(100*c)/100,r<0?-c:c}function Gl(t,e,i){const s=dr.fromTwoPoint(e,t);return dr.fromTwoPoint(e,i).angle(s)>Math.PI/2}function Yl(t,e){return (e=t.getWorldTransform().inverse().transformPoint(e)).x+=t.parsedStyle.x,e.y+=t.parsedStyle.y,e}function ql(t){if(!t)return !1;const{shapeType:e}=t;return "annotationRect"===e||"annotationFreeText"===e&&"textBox"===t.textType||"annotationStamp"===e&&"image"===t.renderType}function Jl(t){return !!t&&("annotationPolyline"===t.shapeType||"annotationPolygon"===t.shapeType||"annotationLine"===t.shapeType)}function Zl(t){return !!t&&("annotationFreeText"===t.shapeType||"annotationTextBox"===t.shapeType)}function Ql(t){return !!t&&("annotationUnderline"===t.shapeType||"annotationStrikeout"===t.shapeType||"annotationHighlight"===t.shapeType)}function Kl(t,e){e.controls||e.context.initControls(),e.context.renderControls();const i=[],s=e.controls.getVertexesPosition();i.push(...s);const{x:n,y:o}=t.getPosition(),{width:r,height:a}=t.parsedStyle,l=t.getScale(),h=Math.abs(l.x),c=Math.abs(l.y),d=function(t,e){let i=e[0].x,s=e[0].x,n=e[0].y,o=e[0].y;for(let t=1;t<e.length;t++){const{x:r,y:a}=e[t];r<i&&(i=r),r>s&&(s=r),a<n&&(n=a),a>o&&(o=a);}return !(t.x2<i||s<t.x1)&&(!(t.y2<n||o<t.y1)&&function(t,e){const i=t.x1,s=t.y1,n=t.x2,o=t.y2;for(let t=0;t<e.length;t++){const r=e[t],a=e[(t+1)%e.length],l=a.y-r.y,h=r.x-a.x;if(0===l&&0===h)continue;const c=l*i+h*s,d=l*i+h*o,u=l*n+h*s,p=l*n+h*o;let g=c,f=c;d<g?g=d:d>f&&(f=d),u<g?g=u:u>f&&(f=u),p<g?g=p:p>f&&(f=p);let v=l*e[0].x+h*e[0].y,m=v;for(let t=1;t<e.length;t++){const i=l*e[t].x+h*e[t].y;i<v?v=i:i>m&&(m=i);}if(f<v||m<g)return !1}return !0}(t,e))}({x1:n,y1:o,x2:n+r.value*h,y2:o+a.value*c},i);return d}function th(t,e){const i=window.TouchEvent&&e instanceof TouchEvent?e.targetTouches[0]:e,s=t.getBoundingClientRect();return {offsetX:i.pageX-window.scrollX-s.left,offsetY:i.pageY-window.scrollY-s.top}}function eh(t){return /^[\r\n]+$/.test(t)}function ih(t,e,i){return t.slice(0,e)+t.slice(i+1)}function sh(t,e){const{textContents:i}=t.style,s=[];return i.forEach((t=>{s.push({...t,...e});})),s}function nh(t,e){const{textContents:i}=t.style,{textSelection:s}=t.textEditEventHandler;if(!s.length)return i;const[n,o]=s,r=n.freeContentIndex,a=o.freeContentIndex,l=i.slice(0,r),h=i.slice(r,a+1),c=i.slice(a+1),d=[];if(n.freeContentIndex===o.freeContentIndex){const{content:t}=h[0],i=t.slice(0,n.indexInFreeContent),s=t.slice(n.indexInFreeContent,o.indexInFreeContent+1),r=t.slice(o.indexInFreeContent+1);i&&d.push({...h[0],content:i}),s&&d.push({...h[0],...e,content:s}),r&&d.push({...h[0],content:r});}else for(let t=0;t<h.length;t++){const i=h[t];0===t?(0!==n.indexInFreeContent&&d.push({...i,content:i.content.slice(0,n.indexInFreeContent)}),d.push({...i,...e,content:i.content.slice(n.indexInFreeContent)})):t===h.length-1?(d.push({...i,...e,content:i.content.slice(0,o.indexInFreeContent+1)}),o.indexInFreeContent+1<i.content.length&&d.push({...i,content:i.content.slice(o.indexInFreeContent+1)})):d.push({...i,...e});}return [...l,...d,...c]}function oh(t){if(!t)return !1;let e=t,i="visible"===e.parsedStyle.visibility;for(;e;)e.parsedStyle.visibility&&"hidden"===e.parsedStyle.visibility&&(i=!1),e=e.parentNode;return i}var rh;!function(t){t.REJECTED="SBRejected",t.ACCEPTED="SHAccepted",t.INITIAL_HERE="SHInitialHere",t.SIGN_HERE="SHSignHere",t.WITNESS="SHWitness",t.APPROVED="SBApproved",t.NOT_APPROVED="SBNotApproved",t.DRAFT="SBDraft",t.FINAL="SBFinal",t.COMPLETED="SBCompleted",t.CONFIDENTIAL="SBConfidential",t.VOID="SBVoid";}(rh||(rh={}));const ah={border:"1px solid #59626A",background:"transparent",ctrlBorderRadius:"6px",ctrlWidth:"12px",ctrlHeight:"12px",ctrlBorder:"1px solid #59626A",ctrlBackground:"white"},lh={content:"Insert text here...",fontSize:32,color:"red",lineThrough:!1,underline:!1,fontFamily:"Times New Roman",fontStyle:"normal",fontWeight:"normal"},hh={opacity:1,background:"",borderColor:"red",borderWidth:4,lineDash:[0,0],lineEnding:["None","None"],stampIcon:rh.DRAFT,imageData:null,textAlign:"left",textContent:{...lh}},ch={enableControl:!0,useDefaultControls:!0,enableEdit:!0,enableMove:!0,enableRotate:!0},dh={showOnTopWhenSelected:!1,enableContinuousDrawing:!1,enableDeleteWithKeyboard:!0,enableMoveWithKeyboard:!0,enableMultipleSelectWidthCtrl:!0,inkCreateDelay:3e3,controlsStyle:ah,defaultStyleConfig:{},eraserStyle:{background:"rgba(0,0,0)",borderColor:"rgba(0,0,0)",opacity:.3,borderWidth:8},selectionStyle:{background:"transparent",borderWidth:2,borderColor:"#59626A",lineDash:[5,5]}};class uh{constructor(t){i(this,"shape",void 0),i(this,"startTime",void 0),i(this,"startPoint",void 0),i(this,"lastPoint",void 0),i(this,"limitPosition",void 0),i(this,"limitAngle",void 0),i(this,"unLimitPosition",void 0),i(this,"unLimitScale",void 0),i(this,"unLimitStyle",void 0),i(this,"limitArea",void 0),this.shape=t;}setLimitArea(t){this.limitArea=t;}updateShapeByLimitArea(){const{shapeType:t}=this.shape,{left:e,right:i,top:s,bottom:n}=this.isOutOfLimitArea(1,1),o=e||i||s||n,r=ql(this.shape)||"annotationEllipse"===t;o?(r?this.shape.updateStyle(this.unLimitStyle||{}):this.shape.setLocalScale(this.unLimitScale||this.shape.getLocalScale()),this.shape.setLocalPosition(this.unLimitPosition||this.shape.getLocalPosition())):(r&&(this.unLimitStyle={width:this.shape.style.width,height:this.shape.style.height,rx:this.shape.style.rx,ry:this.shape.style.ry}),this.unLimitPosition=this.shape.getLocalPosition().clone(),this.unLimitScale=this.shape.getLocalScale().clone());}getShapeOriginPosition(){const{left:t,top:e,width:i,height:s}=this.shape.getBoundingRect(),n=new Na({style:{x:t-this.shape.style.x+i/2,y:e-this.shape.style.y+s/2}});this.shape.appendChild(n);const{x:o,y:r}=n.getPosition();return n.destroy(),{x:o,y:r}}getShapeControlPointPosition(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"vertexes";const{left:e,top:i,width:s,height:n}=this.shape.getBoundingRect(),o=[];for(let r=0;r<4;r++){let a=e-this.shape.style.x,l=i-this.shape.style.y;if("vertexes"===t)switch(r){case 1:a+=s;break;case 2:a+=s,l+=n;break;case 3:l+=n;}else switch(r){case 1:a+=s,l+=n/2;break;case 2:a+=s/2,l+=n;break;case 3:l+=n/2;break;default:a+=s/2;}const h=new Na({style:{x:a,y:l}});this.shape.appendChild(h);const{x:c,y:d}=h.getPosition();o.push({x:c,y:d}),h.destroy();}return o}isOutOfLimitArea(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(!this.limitArea)return {left:!1,right:!1,top:!1,bottom:!1};const{left:s,top:n,width:o,height:r}=this.limitArea,a=i||this.getShapeControlPointPosition();let l=!1,h=!1,c=!1,d=!1;for(let i=0;i<4;i++){const{x:u,y:p}=a[i];l=u<s-t||l,h=u>s+o+t||h,c=p<n-e||c,d=p>n+r+e||d;}return {left:l,right:h,top:c,bottom:d}}getLimitPosition(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.limitArea)return null;const e=t||this.getShapeControlPointPosition(),{x:i,y:s}=e[0],{left:n,top:o,width:r,height:a}=this.limitArea,l=e[1].x-i,h=e[2].x-i,c=e[3].x-i,d=e[1].y-s,u=e[2].y-s,p=e[3].y-s;let g=n-Math.min(l,h,c),f=n+r-Math.max(l,h,c),v=o-Math.min(d,u,p),m=o+a-Math.max(d,u,p);if(l>=0&&h>=0&&c>=0?g=n:l<=0&&h<=0&&c<=0&&(f=n+r),d>=0&&u>=0&&p>=0?v=o:d<=0&&u<=0&&p<=0&&(m=o+a),(y=this.shape)&&("annotationEllipse"===y.shapeType||"annotationCircle"===y.shapeType)){const{x:t,y:e}=this.getShapeOriginPosition(),n=t-i,o=e-s;g+=n,f+=n,v+=o,m+=o;}var y;return {minPosX:g,maxPosX:f,minPosY:v,maxPosY:m}}getLimitRotateAngle(){if(!this.limitArea)return [];const t=function(t,e){const i=t,[s,n,o,r]=i,{left:a,top:l,width:h,height:c}=e,d=a+h,u=l+c,p=(s.x+n.x+o.x+r.x)/4,g=(s.y+n.y+o.y+r.y)/4,f=Math.sqrt((p-s.x)**2+(g-s.y)**2),v=p-f,m=p+f,y=g-f,x=g+f;if(v>a&&y>l&&m<d&&x<u)return [];const w=t=>{const e=f*f-(t-p)**2;return [{x:t,y:g-Math.sqrt(e)},{x:t,y:g+Math.sqrt(e)}]},b=t=>{const e=f*f-(t-g)**2;return [{x:p-Math.sqrt(e),y:t},{x:p+Math.sqrt(e),y:t}]},S=(e,i)=>{const s=[];return e.forEach((e=>{t.forEach((t=>{let n=Xl({x:p,y:g},t,e);0===n&&(n=p>t.x?g>t.y?-0:0:g>t.y?0:-0,"top"!==i&&"bottom"!==i||(n=-n)),s.push(n);}));})),s},C=[];if(v<a){const t=w(a);C.push(...S(t,"left"));}if(y<l){const t=b(l);C.push(...S(t,"top"));}if(m>d){const t=w(d);C.push(...S(t,"right"));}if(x>u){const t=b(u);C.push(...S(t,"bottom"));}return C}(this.getShapeControlPointPosition(),this.limitArea);if(0===t.length)return [];let e=0;if(t.forEach((t=>{0===t&&e++;})),e>=2)return [0,0];const{maxNegative:i,minPositive:s}=function(t){let e=-1/0,i=1/0;for(let s=0;s<t.length;s++)t[s]<0&&t[s]>e||Object.is(t[s],-0)?e=t[s]:(t[s]>0&&t[s]<i||Object.is(t[s],0))&&(i=t[s]);return e===-1/0&&(e=0),i===1/0&&(i=0),{maxNegative:e,minPositive:i}}(t);return [i,s]}moveByKeyboard(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const{shape:i}=this,{controlsFlags:s}=i.context;if(t.preventDefault(),!s.enableMove)return !1;let n=0,o=0;const r=Math.max(1,Math.round(e*(An(t)?8:1)));switch(t.key){case"ArrowLeft":n=-r;break;case"ArrowRight":n=r;break;case"ArrowUp":o=-r;break;case"ArrowDown":o=r;}const a=i.getPosition();let l=a.x+n,h=a.y+o;const{left:c,right:d,top:u,bottom:p}=this.isOutOfLimitArea(1,1),g=c||d||u||p,f=this.getLimitPosition();if(f&&!g){const{minPosX:t,maxPosX:e,minPosY:i,maxPosY:s}=f;l<t&&(l=t),l>e&&(l=e),h<i&&(h=i),h>s&&(h=s);}return this.shape.setPosition({x:l,y:h}),Jl(i)&&i.pointEventsHandler.updateLineControls(),!0}moveShape(t){const{shape:e,startPoint:i}=this,{lastWorldPosition:s,controlsFlags:n}=e.context;if(!n.enableMove)return;if(new Yr(t.x,t.y).distanceTo(i)<0)return;const o=t.x-i.x,r=t.y-i.y;let a=s.x+o,l=s.y+r;const{left:h,right:c,top:d,bottom:u}=this.isOutOfLimitArea(1,1),p=h||c||d||u;if(this.limitPosition&&!p){const{minPosX:t,maxPosX:e,minPosY:i,maxPosY:s}=this.limitPosition;a<t&&(a=t),a>e&&(a=e),l<i&&(l=i),l>s&&(l=s);}this.shape.setPosition({x:a,y:l});}moveVertex(t){const{shape:e}=this,{context:i,shapeType:s}=e,{hitControlPoint:n,lastLocalScale:o,lastControlsWidth:r,lastControlsHeight:a,keepAspectRatio:l,lastHitControlPoint:h,lastShareAxisYPoint:c,lastShareAxisXPoint:d,lastLocalTransform:u}=i,p=qr(h,d,t).distanceTo(d)||1;if(Gl(h,d,t))return;let g=p-r,f=p/r;const v=qr(h,c,t).distanceTo(c)||1;if(Gl(h,c,t))return;let m=v-a,y=v/a;l&&(f<=y?(y=f,m=y*a-a):(f=y,g=f*r-r));const{left:x,right:w,top:b,bottom:S}=this.isOutOfLimitArea(1,1),C=x||w||b||S,P="annotationEllipse"===s;if(ql(e))this.moveRectVertex(n,g,m);else if(P)this.moveEllipseVertex(n,g,m);else {n<2&&(m=-m),0!==n&&3!==n||(g=-g),e.setLocalTransform(u);const{x:t,y:i}=e.getScale();g/=Math.abs(t),m/=Math.abs(i),e.translateLocal(g/2,m/2),e.setLocalScale(f*o.x,y*o.y);}C||0===e.getAngle()||this.updateShapeByLimitArea();}moveEllipseVertex(t,e,i){const{shape:s}=this,{x:n,y:o}=s.getScale(),{lastShapeWidth:r,lastShapeHeight:a,lastLocalTransform:l}=this.shape.context;e/=Math.abs(n),i/=Math.abs(o),s.style.rx=Math.max(1,(r+e)/2),s.style.ry=Math.max(1,(a+i)/2),t<2&&(i=-i),0!==t&&3!==t||(e=-e),s.setLocalTransform(l),s.translateLocal(e/2,i/2);}moveRectVertex(t,e,i){const{shape:s}=this,{x:n,y:o}=s.getScale(),{lastShapeWidth:r,lastShapeHeight:a,lastWorldPosition:l,lastLocalTransform:h}=this.shape.context;if(e/=Math.abs(n),i/=Math.abs(o),s.style.width=Math.max(r+e,1),s.style.height=Math.max(a+i,1),2===t)s.setPosition(l);else switch(s.setLocalTransform(h),t){case 1:s.translateLocal(0,-i);break;case 3:s.translateLocal(-e,0);break;default:s.translateLocal(-e,-i);}}moveMidpoints(t){const{shape:e}=this,{context:i,shapeType:s}=e,{lastLocalScale:n,lastWorldTransform:o,lastHitControlPoint:r,lastShareAxisPoint:a,hitControlPoint:l,lastWorldPosition:h,lastControlsWidth:c,lastControlsHeight:d,lastHitControlPointCenter:u,lastParentWorldAngle:p}=i,g=l-4,f=qr(r,a,t).distanceTo(a);if(Gl(r,a,t))return;const v="annotationEllipse"===s,m=f/c*n.x,y=f/d*n.y,{left:x,right:w,top:b,bottom:S}=this.isOutOfLimitArea(1,1),C=x||w||b||S,P={x:t.x-(r.x-u.x),y:t.y-(r.y-u.y)};if(ql(e))this.moveRectMidPoint(g,P);else if(v)this.moveEllipseMidPoint(g,P);else {const t=o.inverse(),i=t.transformPoint(P),s=t.transformPoint(h),r={...n};0===g?(r.y=y,90===p?s.x=i.x:s.y=i.y):1===g?r.x=m:2===g?r.y=y:3===g&&(r.x=m,90===p?s.y=i.y:s.x=i.x),this.shape.setLocalScale(r);const a=o.transformPoint(s);e.setPosition(a);}C||0===e.getAngle()||this.updateShapeByLimitArea();}moveRectMidPoint(t,e){const{shape:i}=this,{lastShapeHeight:s,lastWorldPosition:n,lastShapeWidth:o}=i.context,r=i.getWorldTransform().clone(),a=r.inverse().transformPoint(e),l=r.inverse().transformPoint(n),h=l;0===t?(i.style.height=s-(a.y-l.y),h.y=a.y):1===t?i.style.width=Math.max(1,a.x-l.x):2===t?i.style.height=Math.max(1,a.y-l.y):3===t&&(i.style.width=o-(a.x-l.x),h.x=a.x);const c=r.transformPoint(h);i.setPosition(c);}moveEllipseMidPoint(t,e){const{shape:i}=this,{lastShapeHeight:s,lastShapeWidth:n,lastWorldPosition:o}=i.context,r=i.getWorldTransform(),a=r.inverse().transformPoint(e),l=r.inverse().transformPoint(o),h=l;if(0===t){const t=(s/2-(a.y-l.y))/2;i.style.ry=t,h.y=a.y+t;}else if(1===t){const t=(n/2+(a.x-l.x))/2;i.style.rx=t,h.x=a.x-t;}else if(2===t){const t=(s/2+(a.y-l.y))/2;i.style.ry=t,h.y=a.y-t;}else if(3===t){const t=(n/2-(a.x-l.x))/2;i.style.rx=t,h.x=a.x+t;}const c=r.transformPoint(h);i.setPosition(c);}moveRotationPoint(t){const{startPoint:e,shape:i}=this,{lastOriginWorldPosition:s,lastLocalTransform:n}=i.context,o=Xl(s,e,t);this.shape.setLocalTransform(n),this.shape.rotateLocal(o);}isHit(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{shape:i}=this,{context:s,parsedStyle:n}=i;if("hidden"===n.visibility||!s.controlsFlags.enableControl)return -1;if(s.isGrouped)return s.unHitShape(),-1;let{controls:o}=i,r=!0;o||(r=!1,s.initControls(),s.renderControls(),o=i.controls);let a=o.checkHitArea(t.x,t.y);return Jl(i)&&!i.context.controlsFlags.useDefaultControls&&(8===a?a=-1:a>0&&(a=9),-1!==i.pointEventsHandler.isHitPoint(t)&&(a=0)),Ql(i)&&!i.context.controlsFlags.useDefaultControls&&(8===a?a=-1:a>0&&(a=9),a=i.textAssistEventHandler.isHitPoint(t)),a<0?(e&&(s.unHitShape(),r||i.context.destroyControls()),-1):a}startHandler(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.isHit(t);if(-1===i&&!e)return;-1===i&&e&&(i=9);const{shape:s}=this,{context:n}=s;n.isStart=!0,this.lastPoint={...t},this.startPoint={...t},this.startTime=(new Date).getTime(),Jl(s)&&(s.pointEventsHandler.enableEditMode(),s.pointEventsHandler.editStartHandler(t)),Zl(s)&&s.textEditEventHandler.editStartHandler(t),Ql(s)&&s.textAssistEventHandler.editStartHandler(t);const o=this.getShapeControlPointPosition();if(this.limitPosition=this.getLimitPosition(o),n.controlsFlags.useDefaultControls){if(n.hitShape(),n.hitControlPoint=i,i<4){const{x:e,y:s}=o[i];n.lastHitControlPoint={...t},n.lastHitControlPointCenter={x:e,y:s},n.lastShareAxisYPoint={x:o[3-i].x+t.x-e,y:o[3-i].y+t.y-s},n.lastShareAxisXPoint={x:o[i%2?i-1:i+1].x+t.x-e,y:o[i%2?i-1:i+1].y+t.y-s};}else if(i<8){const e=this.getShapeControlPointPosition("mid"),{x:s,y:o}=e[i-4];n.lastHitControlPoint={...t},n.lastHitControlPointCenter={x:s,y:o},n.lastShareAxisPoint={x:e[(i-2)%4].x+t.x-s,y:e[(i-2)%4].y+t.y-o};}}else n.isHit=!0,n.hitControlPoint=9,n.lastWorldPosition=s.getPosition(),n.lastControlsWorldPosition=s.controls.getPosition();}moveHandler(t,e){const{shape:i}=this,{context:s,controls:n}=i,{isHit:o,isStart:r,hitControlPoint:a}=s;if(!o||!r||!n)return;this.lastPoint={...t};const l=Jl(i);if(l&&-1!==i.pointEventsHandler.hitIndex)return void i.pointEventsHandler.editMoveHandler(t);if(Zl(i)&&i.textEditEventHandler.editMode)return void i.textEditEventHandler.editMoveHandler(t);Ql(i)&&i.textAssistEventHandler.isEditMode?i.textAssistEventHandler.editMoveHandler(t):a<4?(s.keepAspectRatio=e,this.moveVertex(t)):a<8?this.moveMidpoints(t):a<9?this.moveRotationPoint(t):(this.moveShape(t),l&&i.pointEventsHandler.updateLineControls());}endHandler(t){const{shape:e,startPoint:i,lastPoint:s}=this,{context:n}=e,{isStart:o,isHit:r}=e.context;if(!o||!r)return;const a=(new Date).getTime()-this.startTime,l=s.x-i.x,h=s.y-i.y,c=a<=200&&(l**2+h**2)**.5<2,d=Jl(e),u=Zl(e),p=Ql(e);if(d&&e.pointEventsHandler.editEndHandler(),u&&e.textEditEventHandler.editEndHandler(),p&&e.textAssistEventHandler.editEndHandler(),!n.isActive&&c&&(n.isActive=!0),t){if(u&&e.textEditEventHandler.editMode)return void(n.hitControlPoint=-1);if(p&&e.textAssistEventHandler.isEditMode)return void(n.hitControlPoint=-1);const i=[];e instanceof Ph?i.push(...e.shapes):i.push(e);const s=[],o=[];let r=!1,a=!1,l=!1,h=!1;if(8===n.hitControlPoint&&this.shape.getAngle()!==(null==n?void 0:n.lastWorldAngle))o.push("rotated"),r=!0;else {const{lastControlsWorldPosition:t,lastControlsWidth:i,lastControlsHeight:s,lastWorldPosition:r}=n;e.context.renderControls();const{width:c,height:u}=e.controls.getLength(),p=e.controls.getPosition(),g=e.getPosition(),f=e instanceof mh?t:r,v=e instanceof mh?p:g;if(v.x.toFixed(1)===f.x.toFixed(1)&&v.y.toFixed(1)===f.y.toFixed(1)||(o.push("moved"),a=!0),!(e instanceof Ph)){const t=d&&-1!==e.pointEventsHandler.hitIndex;if(!(!i||!s)&&(c.toFixed(3)!==i.toFixed(3)||u.toFixed(3)!==s.toFixed(3)))o.push("resized"),l=!0;else if(t){const{hitIndex:t,hitPointPos:i}=e.pointEventsHandler,s=e.path[t];s.x.toFixed(2)===i.x.toFixed(2)&&s.y.toFixed(2)===i.y.toFixed(2)||(o.push("resized"),h=!0);}}}if(r||a||l||h){i.forEach((t=>{const e=t.getAnnotationConfig(),i={style:{},transform:Ns(e.transform)};(a||l||h)&&(_s(e.style.x)||(i.style.x=e.style.x),_s(e.style.y)||(i.style.y=e.style.y),_s(e.style.points)||(i.style.points=e.style.points),_s(e.style.segments)||(i.style.segments=e.style.segments),l&&(_s(e.style.width)||(i.style.width=e.style.width),_s(e.style.height)||(i.style.height=e.style.height))),(h||a||l)&&(_s(e.style.startPoint)||(i.style.startPoint=e.style.startPoint),_s(e.style.endPoint)||(i.style.endPoint=e.style.endPoint)),s.push({shape:t,changedOptions:i});}));const e=[...new Set(o)];t.emitModifyAnnotation(e,s);}}n.isHit=!1,n.keepAspectRatio=!1;}}class ph extends Ua{constructor(t,e){super({type:"annotationControls",style:{visibility:"visible"}}),i(this,"shapeType","annotationControls"),i(this,"container",void 0),i(this,"rotationPoint",void 0),i(this,"rotationPointOffset",30),i(this,"vertexes",[]),i(this,"midpoints",[]),i(this,"boxRenderPath",[]),i(this,"boxRenderSteps",[]),i(this,"rotationRenderPath",[]),i(this,"rotationRenderSteps",[]),i(this,"controlPointsRenderPaths",[]),this.container=t;for(const t in e)Ln(t,e)&&(this[t]=e[t]);this.updateControlPoints(this.vertexes),this.getPath();}get isVisible(){return "hidden"!==this.parsedStyle.visibility&&oh(null==this?void 0:this.container)}calculateMidpoints(t){const e=[];for(let i=0,s=t.length;i<s;i++){const n=new Yr((t[i].x+t[(i+1)%s].x)/2,(t[i].y+t[(i+1)%s].y)/2);e.push(n);}return e}calculateRotationPoint(t){const e=t[0].distanceTo(t[2]),i=this.rotationPointOffset/e+1;return t[2].lerpTo(t[0],i)}update(t){this.updateControlPoints(t),this.getPath(),this.updateOrigin();}updateOrigin(){const t=this.midpoints[0].x-this.vertexes[0].x,e=this.midpoints[3].y-this.vertexes[0].y;this.setOrigin(t,e);}updateControlPoints(t){this.vertexes=t,this.midpoints=this.calculateMidpoints(this.vertexes),this.rotationPoint=this.calculateRotationPoint(this.midpoints);}getLength(){const t=this.midpoints[2].y-this.midpoints[0].y;return {width:this.midpoints[1].x-this.midpoints[3].x,height:t}}setVisible(t){this.style.visibility=t;}setBoxVisible(t){if("hidden"===t)this.boxRenderPath=[],this.boxRenderSteps=[];else {const t=pa(this.vertexes);this.boxRenderPath=this.vertexes.map((e=>({x:e.x-t.left,y:e.y-t.top}))),this.boxRenderSteps=da(this.boxRenderPath,!0);}}setRotationPointVisible(t){if("hidden"===t)this.rotationRenderPath=[],this.rotationRenderSteps=[];else {const t=pa(this.vertexes);this.rotationRenderPath=[this.midpoints[0],this.rotationPoint].map((e=>({x:e.x-t.left,y:e.y-t.top}))),this.rotationRenderSteps=da(this.rotationRenderPath,!0);}}setControlPointVisible(t){if("hidden"===t)this.controlPointsRenderPaths=[];else {const t=pa(this.vertexes);this.controlPointsRenderPaths=[...this.vertexes,...this.midpoints].map((e=>({x:e.x-t.left,y:e.y-t.top})));}}checkHitArea(t,e){const i=this.getWorldTransform().inverse().transformPoint({x:t,y:e}),{x:s,y:n}=this.vertexes[0],o={x:i.x+s,y:i.y+n},{ctrlWidth:r,ctrlHeight:a,ctrlBorderWidth:l,borderWidth:h,background:c}=this.container.context.parsedControlsStyle,d=(l+($s()?10:0)||0)/2,u=r/2,p=a/2,g=r+2*d,f=a+2*d,v=(t,e)=>Pa(t-u-d,e-p-d,g,f,o.x,o.y);if(this.controlPointsRenderPaths.length){for(let t=0;t<this.vertexes.length;t++)if(v(this.vertexes[t].x,this.vertexes[t].y))return t;for(let t=0;t<this.midpoints.length;t++)if(v(this.midpoints[t].x,this.midpoints[t].y))return this.vertexes.length+t}if(this.rotationRenderPath.length&&v(this.rotationPoint.x,this.rotationPoint.y))return 8;if(this.boxRenderPath.length){const t=pa(this.vertexes);if(o.x<t.left||o.x>t.left+t.width||o.y<t.top||o.y>t.top+t.height)return -1;const e=Xs(c)&&""!==c,i=h&&h>0;if(!i&&!e)return -1;let s=!1;if(i&&(s=Ca(this.vertexes,h,o.x,o.y,!0)),!s&&e&&(s=Sa(this.vertexes,o.x,o.y)),s)return 9}return -1}getPath(){const{enableRotate:t,enableEdit:e}=this.container.context.controlsFlags;this.setBoxVisible("visible"),this.setRotationPointVisible(t?"visible":"hidden"),this.setControlPointVisible(e?"visible":"hidden");}getVertexesPosition(){const t=[],e=this.getWorldTransform();let i=!1;return this.controlPointsRenderPaths.length||(this.setControlPointVisible("visible"),i=!0),this.controlPointsRenderPaths.forEach((i=>{t.push(e.transformPoint(i));})),i&&this.setControlPointVisible("hidden"),t}destroy(){this.parentNode&&(this.parentNode.removeChild(this),this.container.controls=null);}}class gh{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,"shape",void 0),i(this,"referencePoint",void 0),i(this,"controlsStyle",void 0),i(this,"controlsFlags",void 0),i(this,"parsedControlsStyle",void 0),i(this,"tempData",{}),i(this,"keepAspectRatio",!1),i(this,"isInGroup",!1),i(this,"isGrouped",!1),i(this,"isActive",!1),i(this,"isStart",!1),i(this,"isHit",!1),i(this,"hitControlPoint",-1),i(this,"lastHitControlPoint",void 0),i(this,"lastHitControlPointCenter",void 0),i(this,"lastLocalTransform",void 0),i(this,"lastWorldTransform",void 0),i(this,"lastWorldPosition",void 0),i(this,"lastLocalScale",void 0),i(this,"lastOriginWorldPosition",void 0),i(this,"lastWorldAngle",void 0),i(this,"lastParentWorldAngle",void 0),i(this,"lastControlsWorldPosition",void 0),i(this,"lastControlsWidth",void 0),i(this,"lastControlsHeight",void 0),i(this,"lastShareAxisPoint",void 0),i(this,"lastShareAxisXPoint",void 0),i(this,"lastShareAxisYPoint",void 0),i(this,"lastShapeWidth",void 0),i(this,"lastShapeHeight",void 0),this.shape=t,this.controlsStyle={...ah,...e},this.controlsFlags={...ch},this.parseControlsStyle();}initReferenceBox(){if(this.referencePoint)return void this.updateReferenceBox();const{left:t,top:e}=this.shape.getBoundingRect(),i=t-this.shape.style.x,s=e-this.shape.style.y,n=new Na({style:{x:i,y:s,r:0}});this.shape.appendChild(n),this.referencePoint=n;}updateReferenceBox(){if(!this.referencePoint)return;const{left:t,top:e}=this.shape.getBoundingRect(),i=t-this.shape.style.x,s=e-this.shape.style.y;this.referencePoint.updateStyle({x:i,y:s});}getControlVertexes(){const{shape:t}=this,{left:e,top:i,width:s,height:n}=t.getBoundingRect();return [new Yr(e,i),new Yr(e+s,i),new Yr(e+s,i+n),new Yr(e,i+n)]}getScaledControlVertexes(){const{shape:t}=this,{x:e,y:i}=t.getScale(),{left:s,top:n,width:o,height:r}=t.getBoundingRect(),a=o*Math.abs(e)||1,l=r*Math.abs(i)||1;return [new Yr(s,n),new Yr(s+a,n),new Yr(s+a,n+l),new Yr(s,n+l)]}showControls(){this.initReferenceBox();const{shape:t,referencePoint:e}=this,{x:i,y:s}=e.getPosition(),n=t.getAngle(),o=i,r=s;t.controls.setAngle(n),t.controls.setPosition({x:o,y:r});}parseControlsStyle(){if(!this.controlsStyle)return;this.parsedControlsStyle={};const{background:t,border:e,ctrlWidth:i,ctrlHeight:s,ctrlBackground:n,ctrlBorderRadius:o,ctrlBorder:r}=this.controlsStyle,a=e||ah.border,{borderColor:l,borderStyle:h,borderWidth:c}=wn(a),d=Cr(c).value,u=r||ah.ctrlBorder,{borderColor:p,borderStyle:g,borderWidth:f}=wn(u),v=Cr(f).value,m=Cr(i).value,y=Pr(""===o?ah.ctrlBorderRadius:o),x="%"===y.unit?y.value/100*m:y.value;this.parsedControlsStyle={background:t||ah.background,ctrlBackground:n||ah.ctrlBackground,ctrlBorderRadius:x,borderColor:l,borderWidth:d,lineDash:"solid"===h?[0,0]:[2*d,d],ctrlWidth:m,ctrlHeight:Cr(s).value,ctrlBorderColor:p,ctrlBorderWidth:v,ctrlLineDash:"solid"===g?[0,0]:[2*v,v]};}updateControlsFlags(t){const{enableEdit:e,enableRotate:i,enableControl:s,isVisible:n}=t;this.shape.controls&&(Vs(e)&&this.shape.controls.setControlPointVisible(e?"visible":"hidden"),Vs(i)&&this.shape.controls.setRotationPointVisible(i?"visible":"hidden"),Vs(s)&&!s&&this.destroyControls()),Vs(n)&&(this.shape.style.visibility=n?"visible":"hidden"),this.controlsFlags={...this.controlsFlags,...t};}hitShape(){var t;const{shape:e}=this,{shapeType:i,controls:s}=e;this.isHit=!0,this.lastWorldPosition=e.getPosition(),this.lastLocalTransform=e.getLocalTransform(),this.lastWorldTransform=e.getLocalTransform(),this.lastLocalScale=e.getLocalScale(),this.lastControlsWorldPosition=s.getPosition(),this.lastControlsWidth=s.getLength().width,this.lastControlsHeight=s.getLength().height;const n=e.getBoundingRect();this.lastParentWorldAngle=Math.round(Math.abs(null==e||null===(t=e.parentNode)||void 0===t?void 0:t.getAngle())),this.lastWorldAngle=e.getAngle(),this.lastOriginWorldPosition=e.getWorldTransform().transformPoint({x:n.left-e.style.x+n.width/2,y:n.top-e.style.y+n.height/2});"annotationEllipse"===i&&(this.lastShapeWidth=2*e.parsedStyle.rx.value,this.lastShapeHeight=2*e.parsedStyle.ry.value),ql(this.shape)&&(this.lastShapeWidth=e.parsedStyle.width.value,this.lastShapeHeight=e.parsedStyle.height.value);}unHitShape(){const{context:t}=this.shape;t.isStart=!1,t.isHit=!1,t.isActive=!1,t.hitControlPoint=-1,Zl(this.shape)&&this.shape.textEditEventHandler.disableEditMode(),Jl(this.shape)&&this.shape.pointEventsHandler.disableEditMode(),Ql(this.shape)&&this.shape.textAssistEventHandler.disableEditMode();}initControls(){const{shape:t}=this,e=this.getControlVertexes(),i=new ph(t,{vertexes:e});t.controls=i,t.getRootNode().appendChild(i),this.updateControlsFlags(this.controlsFlags);}updateControls(){var t,e;const{shape:i}=this,s=this.getScaledControlVertexes();JSON.stringify(s)!==JSON.stringify(null===(t=i.controls)||void 0===t?void 0:t.vertexes)&&(null===(e=i.controls)||void 0===e||e.update(s));}renderControls(){const{shape:t,isStart:e,isActive:i,controlsFlags:s,isInGroup:n}=this,{useDefaultControls:o}=s,{controls:r}=t;if(!r)return;let a="hidden";o&&(e||i||n)&&(a="visible"),r&&r.setVisible(a),this.updateControls(),this.showControls();}destroyControls(){var t,e;null===(t=this.referencePoint)||void 0===t||t.destroy(),this.referencePoint=null,null===(e=this.shape.controls)||void 0===e||e.destroy(),this.shape.controls=null;}getTransform(){const{parentNode:t}=this.shape,e=t instanceof Ph&&this.shape.context.isGrouped;e&&t.delete(this.shape,!1);const i={...this.shape.getLocalPosition()},s=this.shape.getLocalAngle(),n={...this.shape.getLocalScale()};return e&&t.add(this.shape),{angle:s,scale:n,position:i}}setTransform(t){if(t){const{scale:e,angle:i,position:s}=t;s&&this.shape.setLocalPosition(s),_s(i)||this.shape.setLocalAngle(i),_s(e)||this.shape.setLocalScale(e);}}getCommonStyleConfig(){const{lineCap:t,lineJoin:e,lineDash:i,background:s,opacity:n,miterLimit:o,borderColor:r,borderWidth:a}=this.shape.attributes;return {lineCap:t,lineJoin:e,lineDash:i,background:s,opacity:n,borderColor:r,borderWidth:a,miterLimit:o}}getRealTimeBoundingBox(){this.shape.boundsDirty=!0;const{left:t,top:e,width:i,height:s}=this.shape.getBoundingRect(),n=[],{useDefaultControls:o,enableRotate:r}=this.shape.context.controlsFlags,a=o&&r?5:4;for(let o=0;o<a;o++){let r=t-this.shape.style.x,a=e-this.shape.style.y;1!==o&&2!==o||(r+=i),2!==o&&3!==o||(a+=s),4===o&&(r+=i/2,a-=30/this.shape.getScale().y);const l=new Na({style:{x:r,y:a,r:0}});this.shape.appendChild(l);const{x:h,y:c}=l.getPosition();n.push({x:h,y:c}),l.destroy();}return pa(n)}}class fh extends Oa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationArc",...t}),i(this,"shapeType","annotationArc"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}getAnnotationConfig(){const t=this.context.getTransform(),{position:e}=t,{r:i,startAngle:s,endAngle:n}=this.attributes;return {type:"annotationArc",style:{x:e.x,y:e.y,r:i,startAngle:s,endAngle:n,...this.context.getCommonStyleConfig()},transform:t}}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}}class vh extends Na{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationCircle",...t}),i(this,"shapeType","annotationCircle"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{position:e}=t,{r:i}=this.attributes;return {type:"annotationCircle",style:{x:e.x,y:e.y,r:i,...this.context.getCommonStyleConfig()},transform:t}}}class mh extends _a{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationEllipse",...t}),i(this,"shapeType","annotationEllipse"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{rx:e,ry:i}=this.parsedStyle,{position:s}=t;return {type:"annotationEllipse",style:{x:s.x-e.value,y:s.y-i.value,width:2*e.value,height:2*i.value,...this.context.getCommonStyleConfig()},transform:t}}}class yh extends Wa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationImage",...t}),i(this,"shapeType","annotationImage"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const{x:t,y:e,img:i,opacity:s,visibility:n,width:o,height:r}=this.attributes;return {type:"annotationImage",style:{x:t,y:e,width:o,height:r,img:i,opacity:s,visibility:n},meteData:this.meteData,transform:this.context.getTransform()}}}class xh extends Fa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationInk",...t}),i(this,"shapeType","annotationInk"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t),this.update();}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}setUseDouglasPeucker(t){t&&(this.boundsDirty=!0,this.pathDirty=!0);}getAnnotationConfig(){var t;let e=this.attributes.segments;const i=this.context.getTransform(),s=this.getBoundingRect(),{position:n}=i;(n.x!==s.left||n.y!==s.top)&&(e=[],this.attributes.segments.forEach((t=>{const i=[];t.forEach((t=>{i.push({x:t.x-s.left+n.x,y:t.y-s.top+n.y});})),e.push(i);})),this.context.isGrouped||(this.style.segments=e));return {type:"annotationInk",style:{renderBlendMode:null==this||null===(t=this.style)||void 0===t?void 0:t.renderBlendMode,segments:e,...this.context.getCommonStyleConfig()},transform:i}}}class wh extends Ga{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationRect",...t}),i(this,"shapeType","annotationRect"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t=this.context.getTransform(),{width:e,height:i}=this.attributes,{position:s}=t;return {type:"annotationRect",id:this.id,style:{x:s.x,y:s.y,width:e,height:i,...this.context.getCommonStyleConfig()},transform:t}}getPath(){if(!this.pathDirty)return this.path;const{width:t,height:e,borderWidth:i}=this.parsedStyle,s=.5*((null==i?void 0:i.value)||0),n=s,o=s,r=t.value-2*s,a=e.value-2*s;return this.path=[{x:n,y:o},{x:n+r,y:o},{x:n+r,y:o+a},{x:n,y:o+a}],this.steps=da(this.path),this.pathDirty=!1,this.path}getStrokePath(){return this.strokePath=[],[]}}class bh{constructor(t){i(this,"shape",void 0),i(this,"textCursor",void 0),i(this,"textCursorInitCache",void 0),i(this,"inputComposition",!1),i(this,"startChar",void 0),i(this,"startDirection",void 0),i(this,"startPoint",void 0),i(this,"textRects",[]),i(this,"virtualChar",void 0),i(this,"isStart",!1),i(this,"canvas",void 0),i(this,"textClipboard",[]),i(this,"startTextContent",void 0),i(this,"oldEnableMove",!0),i(this,"lineChars",void 0),i(this,"flatChars",void 0),i(this,"editMode",void 0),i(this,"textarea",void 0),i(this,"textSelection",[]),this.shape=t,this.calculateCharPosition();}getLineIndexByMoved(t){const{lines:e,lineHeightOffset:i}=this.shape;let s=0;for(let n=0;n<e.length;n++){const{y:o,height:r}=e[n],a=o-r*(1-i);t.y>a&&(s=n);}return s}getLineIndexByPosition(t){const{lines:e,lineHeightOffset:i}=this.shape,{width:s}=this.shape.bounds;for(let n=0;n<e.length;n++){const o=e[n],{x:r,y:a,height:l,widthWithoutLF:h}=o,c=n===e.length-1?1:1+i;if(new Ga({style:{x:r,y:a-l*(1-i),width:Math.max(s,h),height:l*c,borderWidth:1,background:"transparent"}}).isPointInPath(t))return n}return -1}getCharByPosition(t,e){if(-1===e)return null;const{lineChars:i}=this,{lineHeightOffset:s}=this.shape,n=i[e];for(let e=0;e<n.length;e++){const o=n[e],{x:r,y:a,charWidth:l,charHeight:h}=o,c=o.lineIndex===i.length-1?1:1+s;if(new Ga({style:{x:r,y:a-h*(1-s),width:l,height:h*c,borderWidth:1,background:"transparent"}}).isPointInPath(t))return o}return null}getCharAndDirection(t){const e=this.getLineIndexByPosition(t);let i,s=1;if(-1===e)return i=this.flatChars[this.flatChars.length-1],s=1,{char:i,direction:s};const n="textBox"===this.shape.textType;if(i=this.getCharByPosition(t,e),i){const{x:e,charWidth:n}=i;s=t.x<e+n/2?0:1;}else {const o=this.lineChars[e];i=o[o.length-1],s=1,n&&t.x<o[0].x&&(i=o[0],s=0);}return "\r"!==i.text&&"\n"!==i.text&&"\r\n"!==i.text||(s=0),0===s&&0!==i.indexInLine&&(i=this.lineChars[i.lineIndex][i.indexInLine-1],s=1),{char:i,direction:s}}createCursor(t,e,i,s){if(!this.textCursor){const n=document.createElement("div");return n.className="ddv-annotation-cursor",n.style.left=t-.5+"px",n.style.top=`${e}px`,n.style.transform=`rotate(${i}deg)`,n.style.width="1px",n.style.height=`${s}px`,this.canvas.parentNode.appendChild(n),void(this.textCursor=n)}this.textCursor.style.left=t-.5+"px",this.textCursor.style.top=`${e}px`,this.textCursor.style.height=`${s}px`,this.textCursor.style.transform=`rotate(${i}deg)`,this.textCursor.style.animation="none",this.textCursor.offsetWidth,this.textCursor.style.animation="";}showTextCursor(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const{lineHeightOffset:s}=this.shape,n=(t,e)=>{const{x:i,y:n,charWidth:o,charHeight:r,lineIndex:a}=t,l=e?i+o:i,h=n-r*(1-s),c=a>=this.lineChars.length-1?1:1+s;return new Ga({style:{x:l-this.shape.style.x,y:h-this.shape.style.y,borderWidth:"1px",height:r*c}})},o=t=>{this.shape.appendChild(t);const e=this.shape.getScale().y,i=t.getAngle();t.setAngle(0);const{x:s,y:n}=t.getPosition();t.destroy(),this.createCursor(s,n,i,t.parsedStyle.height.value*e);};if(!this.editMode)return void(this.textCursor&&this.hideTextCursor());const{flatChars:r,shape:a}=this;if(!r.length&&this.virtualChar){const{fontSize:t}=this.shape.freeTextContentStyle,e=Cr(t).value;if(e!==this.virtualChar.charHeight){const{borderOffset:t,padding:i}=this.shape,{y:n}=this.shape.style;this.virtualChar.charHeight=e,this.virtualChar.y=n+t+i+e*(1-s);}return o(n(this.virtualChar,1)),void(this.textCursorInitCache={char:{totalIndex:0},isBack:1})}let l=r[t];if(_s(t)&&(l=r[0],e=0),!r[t])return;"justify"===a.style.textAlign&&"textBox"===a.textType&&" "===l.text&&e&&r[l.totalIndex+1]&&(l=r[l.totalIndex+1],e=0);const h=r[l.totalIndex+1];let c;eh(l.text)&&e&&h&&(l=h,e=0),c=eh(l.text)&&e&&!h?n(this.virtualChar,1):n(l,e),o(c),this.startChar=l,this.startDirection=e,this.textCursorInitCache={char:l,isBack:e},i&&this.shape.hooks.selectTextChars.emit({startChar:l,endChar:l,isBack:!!e,needUpdate:!1});}moveTextCursor(t){const{textSelection:e}=this;let i,s;if(2===e.length){const[n,o]=e;switch(t){case"up":case"left":i=n.totalIndex,s=0;break;default:i=o.totalIndex,s=1;}return this.hideTextSelection(),this.shape.hooks.reRenderText.emit(),void this.showTextCursor(i,s)}const n=this.flatChars,o=n.length,{startChar:r,startDirection:a}=this;if(r){if("left"===t){const t=a?r.totalIndex-1:r.totalIndex-2;i=t>=0?t:0,s=t>=0?1:0;}else if("right"===t){const t=a?r.totalIndex+1:r.totalIndex;i=t>o-1?o-1:t,s=1;}else {const{x:e,charWidth:o,lineIndex:l}=r;if(0===l&&"up"===t)i=0,s=0;else if(l===this.lineChars.length-1&&"down"===t)i=n.length-1,s=1;else {const n=a?e+o:e,r="up"===t?this.lineChars[l-1]:this.lineChars[l+1];i=r[0].totalIndex,s=0,r.forEach((t=>{n>t.x+o/2&&!eh(t.text)&&(i=t.totalIndex,s=1);}));}}this.showTextCursor(i,s);}}hideTextCursor(){this.textCursor&&(this.textCursor.remove(),this.textCursor=null);}showTextSelection(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=[],{lines:n,parsedStyle:o,textType:r,lineHeightOffset:a}=this.shape;if(this.hideTextSelection(),this.textSelection=[t,e],!t||!e)return;const l=["right","justify"].includes(o.textAlign)&&"textBox"===r;if(t.y===e.y){const i=eh(t.text),o=eh(e.text);if(i&&o)return;const r=t.x===e.x?t.charWidth:o?e.x-t.x:e.x-t.x+e.charWidth;s.push({left:t.x,top:t.y,lineIndex:t.lineIndex,width:r,height:n[t.lineIndex].height});}else {const i=this.shape.getTextAlignOffset(n[t.lineIndex]),{x:o,height:r}=n[t.lineIndex],a=l?n[t.lineIndex].widthWithoutLF:n[t.lineIndex].width;if(s.push({left:t.x,top:t.y,lineIndex:t.lineIndex,width:o+a+i-t.x,height:r}),e.lineIndex-t.lineIndex>1)for(let i=t.lineIndex+1;i<e.lineIndex;i++){const{x:t,y:e,height:o}=n[i],r=l?n[i].widthWithoutLF:n[i].width,a=this.shape.getTextAlignOffset(n[i]);s.push({left:t+a,top:e,width:r,height:o,lineIndex:i});}const h=this.shape.getTextAlignOffset(n[e.lineIndex]),{x:c,y:d,height:u}=n[e.lineIndex],p=l&&eh(e.text)?0:e.charWidth;s.push({left:c+h,top:d,width:e.x+p-c-h,height:u,lineIndex:e.lineIndex});}const{x:h,y:c}=this.shape.style;this.hideTextCursor(),s.forEach((t=>{const e=t.lineIndex===this.lineChars.length-1?1:1+a,i=new Ga({style:{x:t.left-h,y:t.top-c-t.height*(1-a),width:t.width,height:t.height*e,background:"rgba(0, 123, 255, 0.5)"}});this.shape.appendChild(i),this.textRects.push(i);})),this.shape.hooks.selectTextChars.emit({startChar:t,endChar:e,isBack:!0,needUpdate:i});}hideTextSelection(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.textRects.forEach((t=>{t.destroy();})),this.textSelection=[],this.textRects=[],t){const{char:t,isBack:e}=this.textCursorInitCache;this.showTextCursor(t.totalIndex,e);}}addText(t,e,i){if(!i||""===i)return;if(!t){const t={...this.shape.freeTextContentStyle,content:i};return this.shape.context.updateControlsFlags({useDefaultControls:!1}),this.shape.updateStyle({textContents:[t]}),this.showTextCursor(i.length-1,1),void this.shape.hooks.textContentUpdatedByChar.emit()}const s=Ns(this.shape.style.textContents),{freeContentIndex:n,indexInFreeContent:o}=t,r=s[n];if(!r)return;const a=(null==r?void 0:r.content)||"",l=Sh(this.shape.freeTextContentStyle,r),h=()=>({...this.shape.freeTextContentStyle,content:i});if(e&&o===a.length-1)l?r.content+=i:s.splice(n+1,0,h());else if(e||o)if(l){const t=0===e?o:o+1;r.content=a.slice(0,t)+i+a.slice(t);}else {const t=[],i=a.slice(0,e?o+1:o),l=a.slice(e?o+1:o);i&&t.push({...r,content:i}),t.push(h()),l&&t.push({...r,content:l}),s.splice(n,1,...t);}else if(n){const t=s[n-1];Sh(this.shape.freeTextContentStyle,t)?s[n-1].content+=i:s.splice(n,0,h());}else l?r.content=i+((null==r?void 0:r.content)||""):s.unshift(h());this.shape.updateStyle({textContents:[...s]}),this.shape.hooks.textContentUpdatedByChar.emit();const{char:c,isBack:d}=this.textCursorInitCache;d?this.showTextCursor(c.totalIndex+i.length,1):this.showTextCursor(c.totalIndex+i.length-1,1);}deleteText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=Ns(this.shape.style.textContents);if(!i.length)return;let s=0;if(2===this.textSelection.length){const[t,e]=this.textSelection;if(t.freeContentIndex===e.freeContentIndex){const s=i[t.freeContentIndex];s.content=ih(s.content,t.indexInFreeContent,e.indexInFreeContent);}else {const s=i[t.freeContentIndex],n=i[e.freeContentIndex];s.content=s.content.substring(0,t.indexInFreeContent),n.content=n.content.substring(e.indexInFreeContent+1);for(let s=t.freeContentIndex+1;s<e.freeContentIndex;s++)i[s].content="";}s=t.totalIndex-1;}else {const{startChar:t,startDirection:o}=this;if(!t)return;let r=o?t:this.flatChars[t.totalIndex-1];if(e){var n;const t=_s(null===(n=r)||void 0===n?void 0:n.totalIndex)?0:r.totalIndex+1;r=this.flatChars[t];}if(!r)return;const{freeContentIndex:a,indexInFreeContent:l}=r,h=i[a];if(!h.color)return;h.content=ih(h.content,l,l),s=r.totalIndex-1;}this.hideTextSelection(),this.shape.updateStyle({textContents:[...i]}),t&&this.shape.hooks.textContentUpdatedByChar.emit(),-1===s?this.showTextCursor(0,0,!1):this.showTextCursor(s,1,!1),this.shape.hooks.reRenderText.emit();}copyText(){if(!this.textSelection.length)return;this.textClipboard=[];const{textContents:t}=this.shape.style,[e,i]=this.textSelection,s=[],n=e.freeContentIndex,o=i.freeContentIndex;if(n===o){const o=t[n],r=o.content.slice(e.indexInFreeContent,i.indexInFreeContent+1);s.push({...o,content:r});}else for(let r=n;r<=o;r++){const a={...t[r]},l=a.content;r===n?a.content=l.slice(e.indexInFreeContent):r===o&&(a.content=l.slice(0,i.indexInFreeContent+1)),s.push({...a});}this.textClipboard=[...s],function(t){let e="";t.forEach((t=>{e+=t.content;}));try{navigator.clipboard.writeText(e);}catch(t){}}(s);}pasteText(){this.textSelection.length&&this.deleteText(!1);const{isBack:t,char:e}=this.textCursorInitCache,{textContents:i}=this.shape.style,s=t?e:this.flatChars[e.totalIndex-1];let n=0,o=(null==s?void 0:s.totalIndex)||-1;if(this.textClipboard.forEach((t=>{n+=t.content.length;})),s)if(this.flatChars.length){const t=i[e.freeContentIndex];if(t.content.length===s.indexInFreeContent+1)i.splice(e.freeContentIndex+1,0,...Ns(this.textClipboard)),this.shape.updateStyle({textContents:[...i]});else {const{content:n}=t,{indexInFreeContent:o}=s,r=[{...t,content:n.slice(0,o+1)},...Ns(this.textClipboard),{...t,content:n.slice(o+1)}];i.splice(e.freeContentIndex,1,...r),this.shape.updateStyle({textContents:[...i]});}}else this.shape.updateStyle({textContents:Ns(this.textClipboard)}),o=-1;else i.unshift(...Ns(this.textClipboard)),this.shape.updateStyle({textContents:i});this.showTextCursor(o+n,1),this.shape.hooks.textContentUpdatedByChar.emit();}selectAllText(){if(!this.flatChars.length)return;const t=this.flatChars[0],e=this.flatChars[this.flatChars.length-1];this.showTextSelection(t,e),this.shape.hooks.reRenderText.emit();}updateTextSelection(){if(!this.textSelection.length)return;const[t,e]=this.textSelection,i=this.flatChars[t.totalIndex],s=this.flatChars[e.totalIndex];this.showTextSelection(i,s,!0),this.shape.hooks.reRenderText.emit();}calculateCharPosition(){const{borderOffset:t,padding:e,lineHeightOffset:i,lines:s}=this.shape,n=[];let o=0,r=0,a=0,l=0;s.forEach(((t,e)=>{const i=t.height,s=[],h=this.shape.getTextAlignOffset(t),c=(t,n,a,h,c)=>{const d={text:t,x:n,y:a,charWidth:h,charHeight:i,freeContentIndex:c,lineIndex:e,indexInLine:r,indexInFreeContent:o,totalIndex:l};s.push(d);};r=0,t.words.forEach((e=>{const{wordWidth:i,freeContentIndex:s,x:n,text:d}=e;if(s!==a&&(o=0,a=s),1===e.text.length)c(d,n+h,t.y,i,s),l+=1,r+=1,o+=1;else {let i=e.x+h;for(let n=0;n<d.length;n++){const a=d.charAt(n),h=tl(a,e.style);c(a,i,t.y,h,s),i+=h,l+=1,o+=1,r+=1;}e.text.length!==e.originText.length&&(o+=e.originText.length-e.text.length);}})),n.push(s);}));const h=this.shape.getTextAlignOffset();if(this.flatChars=n.flat(),this.lineChars=n,this.virtualChar=null,!s.length){const{x:s,y:n,textAlign:o}=this.shape.parsedStyle,{fontSize:r}=this.shape.freeTextContentStyle,a=Cr(r).value,l="right"===o?s+e+h:s+t+e+h;return void(this.virtualChar={x:l,y:n+t+e+a*(1-i),charWidth:1,charHeight:a,lineIndex:0})}const c=this.flatChars[this.flatChars.length-1];eh(c.text)&&(this.virtualChar={x:this.shape.lines[0].x+h,y:c.y+s[c.lineIndex].height*(1+i),charWidth:1,charHeight:c.charHeight,lineIndex:c.lineIndex+1});}updateCursor(){if(!this.textCursor||!this.textCursorInitCache)return;const{char:t,isBack:e}=this.textCursorInitCache;this.showTextCursor(t.totalIndex,e);}enableEditMode(t,e){if(this.editMode)return;"freeTextWriter"===this.shape.textType&&(this.shape.pathDirty=!0,this.shape.boundsDirty=!0,this.shape.calculateTextLines(),this.shape.hooks.reRenderText.emit()),this.calculateCharPosition(),this.editMode=!0,this.canvas=e;let i=!1;if("textBox"===this.shape.textType){const{totalTextHeight:t,textMaxWidth:e}=this.shape,{height:i,width:s}=this.shape.parsedStyle;(t!==i.value||e>s.value)&&(this.shape.boundsDirty=!0,this.shape.pathDirty=!0);}if(this.flatChars.length){const e=Yl(this.shape,t),i=this.getCharAndDirection(e),{char:s,direction:n}=i;this.startChar=s,this.startDirection=n,this.showTextCursor(s.totalIndex,n);}else this.showTextCursor(void 0,void 0),"freeTextWriter"===this.shape.textType&&(i=!0);this.oldEnableMove=this.shape.context.controlsFlags.enableMove,this.shape.context.updateControlsFlags({useDefaultControls:i,enableMove:!1}),this.openTextarea(t),this.resetStartTextContent(),this.shape.hooks.enableTextEditMode.emit();}disableEditMode(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.editMode){if(this.textClipboard=[],this.editMode=!1,this.hideTextCursor(),this.hideTextSelection(),this.shape.lastIsBack=null,this.shape.lastSelectedEndChar=null,this.shape.context.updateControlsFlags({useDefaultControls:!0,enableMove:this.oldEnableMove}),this.textarea&&(this.textarea.blur(),this.textarea.remove()),"textBox"===this.shape.textType){const{totalTextHeight:t,textMaxWidth:e,maxEditWidth:i}=this.shape,{height:s,width:n}=this.shape.parsedStyle;(t!==s.value||e>n.value||i>n.value)&&(this.shape.boundsDirty=!0,this.shape.pathDirty=!0,this.shape.updateOrigin(),this.shape.hooks.reRenderText.emit());}t||(this.shape.maxEditWidth=0,this.shape.hooks.disableTextEditMode.emit(),this.emitTextContentUpdated());}}editStartHandler(t){if(!this.editMode)return;if(!this.flatChars.length)return void this.showTextCursor(void 0,void 0);const e=Yl(this.shape,t),i=this.getCharAndDirection(e);this.hideTextSelection();const{char:s,direction:n}=i;this.showTextCursor(s.totalIndex,n),this.isStart=!0,this.startChar=s,this.startDirection=n,this.startPoint=e,this.shape.hooks.reRenderText.emit();}editMoveHandler(t){if(!this.editMode||!this.isStart)return;const{lineChars:e}=this,i=Yl(this.shape,t),s=this.getLineIndexByMoved(i);let{startChar:n,startDirection:o}=this,r=null;const a=e[s],l=s===this.startChar.lineIndex?i.x>this.startPoint.x:i.y>this.startPoint.y,{lineIndex:h,indexInLine:c}=this.startChar;if(!this.startDirection&&!l){if(0===n.totalIndex)return void this.hideTextSelection(!0);const t=n.lineIndex===e.length-1;if(t&&i.y<this.startPoint.y)n=this.flatChars[n.totalIndex-1],o=1;else if(t)return void this.hideTextSelection(!0)}if(l&&o&&(n=e[h][c+1],o=0,!n))return void this.hideTextSelection(!0);if(l&&i.x<a[0].x+a[0].charWidth/2&&n.lineIndex!==s){const t=e[s-1];return r=t[t.length-1],void this.showTextSelection(n,r)}if(l)a.forEach(((t,e)=>{const{x:s,charWidth:n}=t;i.x>s+n/2&&(r=a[e]);}));else for(let t=a.length-1;t>=0;t--){const{x:e,charWidth:s}=a[t];e+s/2>i.x&&(r=a[t]);}if(!r)return void this.hideTextSelection(!0);const{lineIndex:d,indexInLine:u}=n,{lineIndex:p,indexInLine:g}=r;l&&d===p&&u===g+1||!l&&d===p&&u===g-1?this.hideTextSelection(!0):l?this.showTextSelection(n,r):this.showTextSelection(r,n);}editEndHandler(){this.isStart=!1;}editClickHandler(t,e){this.editMode&&(this.canvas=e,this.openTextarea(t));}openTextarea(t){if(this.editMode){if(this.textarea)this.canvas.parentNode.appendChild(this.textarea);else {const t=document.createElement("textarea");t.className="ddv-annotation-textarea",this.canvas.parentNode.appendChild(t),this.textarea=t,t.addEventListener("input",(t=>{this.inputComposition||this.textareaInput(t);}),!1),t.addEventListener("compositionstart",(t=>this.textareaCompositionstart(t)),!1),t.addEventListener("compositionend",(t=>{this.inputComposition=!1,this.textareaInput(t);}),!1),t.addEventListener("keydown",(t=>this.textareaKeydown(t)),!1),t.addEventListener("paste",(t=>this.textareaPaste(t)),!1);}t&&(this.textarea.style.left="50%",this.textarea.style.top="50%"),this.textarea.value="",this.textarea.focus();}}destroyTextarea(){this.textarea&&(this.textarea.remove(),this.textarea=null);}emitTextContentUpdated(){(function(t,e){let i="",s="";for(let e=0;e<t.length;e++)i+=t[e].content;for(let t=0;t<e.length;t++)s+=e[t].content;return i===s})(this.startTextContent,this.shape.style.textContents)||(this.startTextContent=Ns(this.shape.style.textContents),this.shape.hooks.textContentUpdated.emit());}resetStartTextContent(){this.startTextContent=Ns(this.shape.style.textContents);}textareaInput(t){const e=this.textarea.value;if(2===this.textSelection.length&&this.deleteText(!1),this.flatChars.length){const{char:t,isBack:i}=this.textCursorInitCache;this.addText(t,i,e);}else this.addText(void 0,void 0,e);this.textarea.value="";}textareaCompositionstart(t){this.inputComposition=!0;}textareaKeydown(t){if(this.inputComposition||"Backspace"!==t.key||8!==t.keyCode)if(this.inputComposition||"Delete"!==t.key)switch(Pn(t)&&("c"===t.key||"C"===t.key?this.copyText():"x"===t.key||"X"===t.key?(this.copyText(),this.textSelection.length&&this.deleteText()):("v"!==t.key&&"V"!==t.key||!this.textClipboard.length)&&("z"===t.key||"Z"===t.key?(t.preventDefault(),t.stopPropagation()):"a"!==t.key&&"A"!==t.key||this.selectAllText())),t.key){case"ArrowLeft":this.moveTextCursor("left");break;case"ArrowRight":this.moveTextCursor("right");break;case"ArrowUp":this.moveTextCursor("up");break;case"ArrowDown":this.moveTextCursor("down");}else this.deleteText(!0,!0);else this.deleteText();}textareaPaste(t){var e;const i=null===(e=t.clipboardData)||void 0===e?void 0:e.getData("text/plain");let s="";this.textClipboard.length&&(s=this.textClipboard.map((t=>t.content)).join(""),i!==s?this.textClipboard=[]:(t.preventDefault(),this.pasteText()));}}function Sh(t,e){return t.color===e.color&&t.fontFamily===e.fontFamily&&t.fontSize===e.fontSize&&t.fontStyle===e.fontStyle&&t.fontWeight===e.fontWeight&&t.lineThrough===e.lineThrough&&t.underline===e.underline}class Ch extends Ka{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"textBox",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:lh;super({type:"annotationFreeText",id:t.id,style:{freeTextType:e,...t.style}}),i(this,"lastSelectedEndChar",void 0),i(this,"lastIsBack",void 0),i(this,"shapeType","annotationFreeText"),i(this,"textEditEventHandler",void 0),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"freeTextContentStyle",void 0),i(this,"inputModeTimer",void 0),i(this,"maxEditWidth",0),i(this,"hooks",{reRenderText:en(),selectTextChars:en(),enableTextEditMode:en(),disableTextEditMode:en(),textContentUpdated:en(),textContentUpdatedByChar:en(),positionUpdated:en()}),this.freeTextContentStyle=s,this.init(t.transform,t.selectableStyle),"freeTextWriter"===this.textType&&this.context.updateControlsFlags({enableEdit:!1,enableRotate:!1}),this.hooks.selectTextChars.on((t=>{const e=t.endChar;if(this.isSameChar(e,this.lastSelectedEndChar)&&t.isBack===this.lastIsBack&&!t.needUpdate)return;let i=e.freeContentIndex;e.indexInFreeContent||!e.freeContentIndex||t.isBack||(i-=1);const s=this.style.textContents[i];this.lastSelectedEndChar=e,this.lastIsBack=t.isBack,this.freeTextContentStyle={...s,content:this.freeTextContentStyle.content};}));}get isEditMode(){var t;return null===(t=this.textEditEventHandler)||void 0===t?void 0:t.editMode}get hasSelectedChars(){var t;return (null===(t=this.textEditEventHandler)||void 0===t?void 0:t.textSelection.length)>0}init(t,e){this.context=new gh(this,e),this.textEditEventHandler=new bh(this),this.eventHandler=new uh(this),this.context.setTransform(t);}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.textEditEventHandler.disableEditMode(!0),this.textEditEventHandler.destroyTextarea(),this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}getAnnotationConfig(){const t="textBox"===this.textType?"annotationTextBox":"annotationFreeText",e=this.getPosition();this.updateOrigin(),this.setPosition({...e});const i=this.context.getTransform(),{position:s}=i,{width:n,height:o,textContents:r}=this.attributes,a={type:t,style:{x:s.x,y:s.y,textContents:Ns(r),textAlign:this.style.textAlign,...this.context.getCommonStyleConfig(),width:n},transform:i};return "textBox"===this.textType&&(a.style.height=o),a}calculateTotalHeight(){var t,e;const i=Cr((null===(t=this.freeTextContentStyle)||void 0===t?void 0:t.fontSize)||16);if(null!==(e=this.lines)&&void 0!==e&&e.length)super.calculateTotalHeight();else if("freeTextWriter"===this.textType)this.totalTextHeight=i.value+2*this.borderOffset;else {const{height:t}=this.parsedStyle;this.totalTextHeight=t.value>i.value+2*this.borderOffset?t.value:i.value+2*this.borderOffset+2*this.padding;}}getBoundingRect(){var t;if(!this.boundsDirty)return this.bounds;const{x:e,y:i}=this.parsedStyle;if("freeTextWriter"===this.textType&&(null===(t=this.lines)||void 0===t||!t.length)){var s;const t=Cr((null===(s=this.freeTextContentStyle)||void 0===s?void 0:s.fontSize)||16);return this.boundsDirty=!1,this.bounds={left:e,top:i,width:tl("  ",{...this.freeTextContentStyle,fontSize:t}),height:t.value+2*this.padding},this.bounds}return super.getBoundingRect(),"textBox"===this.textType&&this.isEditMode&&(this.bounds.height=this.totalTextHeight,this.textMaxWidth>this.bounds.width&&(this.bounds.width=this.textMaxWidth+2*this.borderOffset+2*this.padding),this.maxEditWidth=Math.max(this.maxEditWidth,this.bounds.width),this.maxEditWidth>this.bounds.width&&(this.bounds.width=this.maxEditWidth)),this.bounds}updateFreeTextContentStyle(t){this.freeTextContentStyle=t,this.textEditEventHandler.updateCursor();const{flatChars:e}=this.textEditEventHandler;this.isEditMode&&!e.length&&(this.pathDirty=!0,this.boundsDirty=!0,this.calculateTotalHeight(),this.hooks.reRenderText.emit(),this.hooks.enableTextEditMode.emit());}focusTexture(){const t=$s();this.isEditMode&&this.textEditEventHandler.textarea&&(t||this.textEditEventHandler.textarea.focus());}updateCursor(){this.textEditEventHandler.updateCursor();}isSameChar(t,e){return !(!t||!e)&&(t.charHeight===e.charHeight&&t.charWidth===e.charWidth&&t.freeContentIndex===e.freeContentIndex&&t.indexInFreeContent===e.indexInFreeContent&&t.indexInLine===e.indexInLine&&t.text===e.text&&t.totalIndex===e.totalIndex)}}class Ph extends Ga{constructor(t){super({id:t,type:"annotationGroup",style:{visibility:"hidden",background:"transparent",borderColor:"transparent"}}),i(this,"shapeType","annotationGroup"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"parent",void 0),i(this,"shapes",[]),i(this,"clickedShape",null),i(this,"state",!1),i(this,"groupMode",0),this.context=new gh(this),this.eventHandler=new uh(this),this.eventHandler.isHit=this.isHit.bind(this),this.groupMode?this.context.updateControlsFlags({enableEdit:!1}):this.context.updateControlsFlags({useDefaultControls:!1});}isHit(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{context:i,parsedStyle:s}=this;let{controls:n}=this;if(!this.state||"hidden"===s.visibility||!i.controlsFlags.enableControl)return this.clickedShape=null,-1;n||(i.initControls(),i.renderControls(),n=this.controls);let o=-1;if(this.groupMode)o=n.checkHitArea(t.x,t.y);else for(let e=0;e<this.shapes.length;e++)if(this.shapes[e].controls||(this.shapes[e].context.initControls(),this.shapes[e].context.renderControls()),this.shapes[e].controls.checkHitArea(t.x,t.y)>=0){this.clickedShape=this.shapes[e],o=9;break}return o<0&&e?(this.clickedShape=null,i.unHitShape(),this.context.destroyControls(),-1):o}init(){this.style.visibility="visible",this.parent.appendChild(this),this.shapes.forEach((t=>{t instanceof Ch&&t.isEditMode&&t.textEditEventHandler.disableEditMode(),this.appendChild(t),t.context.isGrouped=!0;})),this.update(),this.context.initControls();}add(t){const e=(Array.isArray(t)?t:[t]).filter((t=>"hidden"!==t.parsedStyle.visibility&&!this.shapes.includes(t)));if(0!==e.length){if(!this.parent&&e.length>0&&(this.parent=e[0].parentNode),e.forEach((t=>{t.context.isInGroup=!0,this.shapes.push(t);})),this.state){const t=[];for(let e=0;e<this.shapes.length;e++)t.push(this.shapes[e].getWorldTransform().clone());for(let t=0;t<e.length;t++){const i=e[t];i instanceof Ch&&i.isEditMode&&i.textEditEventHandler.disableEditMode(),i.context.isGrouped=!0,this.appendChild(i),this.groupMode||this.showAllControls(i);}const i=this.getWorldTransform().inverse();for(let e=0;e<this.shapes.length;e++){const s=i.multiply(t[e]);this.shapes[e].setLocalTransform(s);}this.update();}this.shapes.length>=2&&!1===this.state&&(this.state=!0,this.init());}}update(){let t=-1/0,e=1/0,i=-1/0,s=1/0,n=!0;const o=[];for(let r=0;r<this.shapes.length;r++){const a=this.shapes[r];a.controls||a.context.initControls(),a.context.renderControls(),this.groupMode&&a.context.unHitShape(),a.context.controlsFlags.enableMove||(n=!1);const l=a.controls.getVertexesPosition();for(let n=0;n<l.length;n++){const{x:o,y:r}=l[n];o>t&&(t=o),o<e&&(e=o),r>i&&(i=r),r<s&&(s=r);}o.push(a.getWorldTransform().clone());}this.updateStyle({x:0,y:0,width:t-e,height:i-s}),this.context.updateControlsFlags({enableMove:n}),this.setAngle(180===this.parent.getAngle()?179.99:0),this.setLocalScale(1,1);const{x:r,y:a}=this.getScale();this.scale(1/Math.abs(r),1/Math.abs(a)),this.setPosition({x:e,y:s}),this.updateOrigin(),this.context.updateControls();const l=this.getWorldTransform().inverse();for(let t=0;t<this.shapes.length;t++){const e=l.multiply(o[t]);this.shapes[t].setLocalTransform(e);}}delete(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.parent||!this.shapes.includes(t))return;const i=t.getWorldTransform().clone();this.parent.appendChild(t);const s=this.parent.getWorldTransform().inverse().multiply(i);t.setLocalTransform(s),t.context.isInGroup=!1,t.context.isGrouped=!1,t.context.isActive=!1,t.context.destroyControls(),"freeTextWriter"!==(null==t?void 0:t.textType)&&(t.context.updateControlsFlags({enableRotate:!Vs(t.context.tempData.enableRotate)||t.context.tempData.enableRotate}),delete t.context.tempData.enableRotate),Jl(t)&&t.pointEventsHandler.disableEditMode(),this.shapes.splice(this.shapes.indexOf(t),1),e&&this.update(),0===this.shapes.length&&this.clear();}clear(){const{length:t}=this.shapes;for(let e=t-1;e>=0;e--)this.delete(this.shapes[e],!1);this.context.destroyControls(),this.reset();}reset(){this.parent&&this.parent.removeChild(this),this.updateStyle({x:0,y:0,width:0,height:0}),this.resetLocalTransform(),this.shapes=[],this.parent=null,this.state=!1,this.style.visibility="hidden";}destroy(){const{length:t}=this.shapes;for(let e=t-1;e>=0;e--)this.shapes[e].destroy();this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.shapes=[],this.state=!1,this.parent=null,this.style.visibility="hidden",this.updateStyle({x:0,y:0,width:0,height:0});}showAllControls(t){if(!this.state)return;if(this.groupMode)return;const e=t=>{Jl(t)&&t.pointEventsHandler.enableEditMode(),t.controls||t.context.initControls(),t.context.controlsFlags.enableRotate&&(t.context.tempData.enableRotate=t.context.controlsFlags.enableRotate,t.context.updateControlsFlags({enableRotate:!1})),t.context.isActive=!0,t.context.renderControls();};t?e(t):this.shapes.forEach((t=>{e(t);}));}getAnnotationConfig(){return {type:"annotationGroup"}}}class Th extends Ga{constructor(t){super(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),i(this,"shapeType","annotationLineControls"),i(this,"container",void 0),this.container=t;}get isVisible(){return "hidden"!==this.parsedStyle.visibility&&oh(null==this?void 0:this.container)}checkHitPoint(t,e){const i=this.getWorldTransform().inverse().transformPoint({x:t,y:e}),s={x:i.x+this.style.x,y:i.y+this.style.y},{ctrlWidth:n,ctrlHeight:o,ctrlBorderWidth:r}=this.container.context.parsedControlsStyle,a=(r+($s()?10:0)||0)/2,l=this.container.baseRenderPath||[],{x:h,y:c}=this.container.getScale();for(let t=0;t<l.length;t++){const e=l[t];if(d=e.x*h,u=e.y*c,Pa(d-n/2-a,u-o/2-a,n+2*a,o+2*a,s.x,s.y))return t}var d,u;return -1}}class Ah{constructor(t){i(this,"shape",void 0),i(this,"editMode",void 0),i(this,"hitIndex",-1),i(this,"hitPointPos",void 0),i(this,"startPoint",void 0),i(this,"controlsBox",void 0),this.shape=t;}initLineControls(){const{shape:t}=this;t.updatePoints();const{x:e,y:i}=this.shape.getScale(),{borderColor:s,borderWidth:n,lineDash:o,background:r}=t.context.parsedControlsStyle,a=this.shape.getBoundingRect();this.controlsBox=new Th(this.shape,{style:{width:a.width*e,height:a.height*i,borderColor:s,borderWidth:n,background:r,lineDash:o}}),this.controlsBox.setAngle(this.shape.getAngle()),this.controlsBox.setPosition(this.shape.getPosition()),this.shape.getRootNode().appendChild(this.controlsBox);}isHitPoint(t){return this.editMode&&this.shape.context.controlsFlags.enableEdit?this.controlsBox.checkHitPoint(t.x,t.y):-1}updateLineControls(){if(!this.controlsBox)return;if(!this.editMode)return;const{x:t,y:e}=this.shape.getScale(),i=this.shape.getBoundingRect();this.controlsBox.updateStyle({width:i.width*t,height:i.height*e}),this.controlsBox.setAngle(this.shape.getAngle()),this.controlsBox.setPosition(this.shape.getPosition()),this.shape.controls&&(this.shape.context.lastControlsWidth=this.shape.controls.getLength().width,this.shape.context.lastControlsHeight=this.shape.controls.getLength().height);}destroyLineControls(){var t;null===(t=this.controlsBox)||void 0===t||t.destroy(),this.controlsBox=null;}enableEditMode(){const{shape:t}=this;t.path||this.shape.getPath(),t.path.length>t.pointerLimitCount||(this.editMode||this.initLineControls(),this.editMode=!0,t.context.isHit=!0,t.controls&&(t.context.lastControlsWidth=t.controls.getLength().width,t.context.lastControlsHeight=t.controls.getLength().height));}disableEditMode(){this.destroyLineControls(),this.editMode=!1;}editStartHandler(t){if(!this.editMode)return;this.hitIndex=-1;const e=this.isHitPoint(t);-1!==e&&(this.hitIndex=e,this.hitPointPos={...this.shape.path[this.hitIndex]}),this.startPoint=t,this.shape.context.lastLocalTransform=this.shape.getLocalTransform();}editMoveHandler(t){if(!this.editMode||-1===this.hitIndex)return;const{shape:e}=this,i="annotationLine"===e.shapeType,s=i?[...e.path]:[...e.parsedStyle.points],n=Yl(e,t);s[this.hitIndex]=n,i?e.updateStyle({startPoint:{x:s[0].x,y:s[0].y},endPoint:{x:s[1].x,y:s[1].y}}):e.style.points=s,this.updateLineControls();}editEndHandler(){this.editMode&&this.shape.updatePoints();}}class kh extends ja{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationPolygon",...t}),i(this,"shapeType","annotationPolygon"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),i(this,"pointerLimitCount",200),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.pointEventsHandler=new Ah(this),this.eventHandler=new uh(this),this.context.setTransform(t),this.parsedStyle.points.length<this.pointerLimitCount&&this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),e=this.getBoundingRect(),{position:i}=t,s=i.x!==e.left||i.y!==e.top;let n=this.attributes.points;s&&(n=[],this.attributes.points.forEach((t=>{n.push({x:t.x-e.left+i.x,y:t.y-e.top+i.y});})));return {type:"annotationPolygon",style:{points:n,...this.context.getCommonStyleConfig()},transform:t}}}class Dh extends Xa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationPolyline",...t}),i(this,"shapeType","annotationPolyline"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),i(this,"pointerLimitCount",200),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.pointEventsHandler=new Ah(this),this.eventHandler=new uh(this),this.context.setTransform(t),this.parsedStyle.points.length<this.pointerLimitCount&&this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),e=this.getBoundingRect(),{position:i}=t,s=i.x!==e.left||i.y!==e.top;let n=this.attributes.points;s&&(n=[],this.attributes.points.forEach((t=>{n.push({x:t.x-e.left+i.x,y:t.y-e.top+i.y});})));return {type:"annotationPolyline",style:{points:n,lineEnding:this.attributes.lineEnding,...this.context.getCommonStyleConfig()},transform:t}}}class Rh extends qa{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super({type:"annotationLine",...t}),i(this,"shapeType","annotationLine"),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"pointEventsHandler",void 0),this.init(t.transform,t.selectableStyle);}init(t,e){this.context=new gh(this,e),this.pointEventsHandler=new Ah(this),this.eventHandler=new uh(this),this.context.setTransform(t),this.context.updateControlsFlags({useDefaultControls:!1,enableRotate:!1});}update(){this.updateOrigin(),this.context.updateControls();}destroy(){this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy(),this.pointEventsHandler.destroyLineControls();}getAnnotationConfig(){const t=this.context.getTransform(),{left:e,top:i}=this.getBoundingRect(),{startPoint:s,endPoint:n,lineEnding:o}=this.attributes,{position:r}=t,a=r.x!==e||r.y!==i;return {type:"annotationLine",style:{startPoint:a?{x:s.x-e+r.x,y:s.y-i+r.y}:s,endPoint:a?{x:n.x-e+r.x,y:n.y-i+r.y}:n,lineEnding:o,...this.context.getCommonStyleConfig()},transform:t}}}const Eh=[{type:"path",stampPoints:[{x:417.4818115234375,y:261.32421875,step:2},{x:408.92578125,y:267.67313639322913,step:1},{x:404.0755208333333,y:276.6470947265625,step:1},{x:403.69010416666663,y:277.0937093098958,step:1},{x:403.40885416666663,y:276.3788655598958,step:1},{x:401.96875,y:272.3411458333333,step:1},{x:401.8802083333333,y:270.8835042317708,step:1},{x:399.3177083333333,y:272.16080729166663,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:399.7317708333333,y:277.8567708333333,step:1},{x:403.5690511067708,y:284.59375,step:1},{x:403.7773030598958,y:284.56766764322913,step:1},{x:406.17447916666663,y:274.89322916666663,step:1},{x:422.41666666666663,y:265.8476155598958,step:1},{x:418.98832194010413,y:263.60477701822913,step:1},{x:417.4140625,y:261.35746256510413,step:1},{x:417.4818115234375,y:261.32421875,step:1}],borderWidth:0,borderColor:"rgba(0,0,0,1)",background:"linear-gradient(to right bottom, #a9d776, #40691b)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:417.4818115234375,y:261.32421875,step:2},{x:408.92578125,y:267.67313639322913,step:1},{x:404.0755208333333,y:276.6470947265625,step:1},{x:403.69010416666663,y:277.0937093098958,step:1},{x:403.40885416666663,y:276.3788655598958,step:1},{x:401.96875,y:272.3411458333333,step:1},{x:401.8802083333333,y:270.8835042317708,step:1},{x:399.3177083333333,y:272.16080729166663,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:395.36454264322913,y:272.4173583984375,step:1},{x:399.7317708333333,y:277.8567708333333,step:1},{x:403.5690511067708,y:284.59375,step:1},{x:403.7773030598958,y:284.56766764322913,step:1},{x:406.17447916666663,y:274.89322916666663,step:1},{x:422.41666666666663,y:265.8476155598958,step:1},{x:418.98832194010413,y:263.60477701822913,step:1},{x:417.4140625,y:261.35746256510413,step:1},{x:417.4818115234375,y:261.32421875,step:1}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"round",lineJoin:"round",miterLimit:4}],Mh=[{type:"path",stampPoints:[{x:424.45703125,y:294.07291666666663,step:2},{x:424.45703125,y:298.47265625,step:1},{x:420.83984375,y:302.07291666666663,step:1},{x:416.4192708333333,y:302.07291666666663,step:1},{x:222.49481201171875,y:302.07291666666663,step:0},{x:218.07421875,y:302.07291666666663,step:1},{x:214.45703125,y:298.47265625,step:1},{x:214.45703125,y:294.07291666666663,step:1},{x:214.45703125,y:252.07291666666666,step:0},{x:214.45703125,y:247.67313639322916,step:1},{x:218.07421875,y:244.07291666666666,step:1},{x:222.49481201171875,y:244.07291666666666,step:1},{x:416.4192708333333,y:244.07291666666666,step:0},{x:420.83984375,y:244.07291666666666,step:1},{x:424.45703125,y:247.67313639322916,step:1},{x:424.45703125,y:252.07291666666666,step:1},{x:424.45703125,y:294.07291666666663,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:424.0677083333333,y:293.9374593098958,step:2},{x:424.0677083333333,y:298.3358968098958,step:1},{x:420.45048014322913,y:301.9374593098958,step:1},{x:416.02994791666663,y:301.9374593098958,step:1},{x:222.10614013671875,y:301.9374593098958,step:0},{x:217.685546875,y:301.9374593098958,step:1},{x:214.06837972005206,y:298.3358968098958,step:1},{x:214.06837972005206,y:293.9374593098958,step:1},{x:214.06837972005206,y:251.93684895833331,step:0},{x:214.06837972005206,y:247.53715006510416,step:1},{x:217.685546875,y:243.93684895833331,step:1},{x:222.10614013671875,y:243.93684895833331,step:1},{x:416.02994791666663,y:243.93684895833331,step:0},{x:420.45048014322913,y:243.93684895833331,step:1},{x:424.0677083333333,y:247.53715006510416,step:1},{x:424.0677083333333,y:251.93684895833331,step:1},{x:424.0677083333333,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(41,66,18,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:234.81705729166666,y:280.5859375,step:2},{x:231.83074951171875,y:287.9374593098958,step:0},{x:226.009765625,y:287.9374593098958,step:0},{x:238.44596354166666,y:259.6288655598958,step:0},{x:245.4388224283854,y:259.6288655598958,step:0},{x:248.38736979166666,y:287.9374593098958,step:0},{x:242.67903645833331,y:287.9374593098958,step:0},{x:242.150390625,y:280.5859375,step:0},{x:234.81705729166666,y:280.5859375,step:0},{x:241.9238077799479,y:275.9661458333333,step:2},{x:241.43166097005206,y:269.8769124348958,step:0},{x:241.318359375,y:268.3229573567708,step:1},{x:241.205078125,y:266.0553792317708,step:1},{x:241.0917765299479,y:264.33268229166663,step:1},{x:240.978515625,y:264.33268229166663,step:0},{x:240.33528645833331,y:266.0553792317708,step:1},{x:239.6171671549479,y:268.2389729817708,step:1},{x:238.93684895833331,y:269.8769124348958,step:1},{x:236.44270833333331,y:275.9661458333333,step:0},{x:241.9238077799479,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:255.87109375,y:260.1335042317708,step:2},{x:257.5345052083333,y:259.67057291666663,step:1},{x:260.06705729166663,y:259.41861979166663,step:1},{x:262.52410888671875,y:259.41861979166663,step:1},{x:264.83009847005206,y:259.41861979166663,step:1},{x:267.43815104166663,y:259.8391927083333,step:1},{x:269.2903645833333,y:261.30924479166663,step:1},{x:271.02931722005206,y:262.56901041666663,step:1},{x:272.0501302083333,y:264.58463541666663,step:1},{x:272.0501302083333,y:267.314453125,step:1},{x:272.0501302083333,y:270.884765625,step:1},{x:270.5755208333333,y:273.6145833333333,step:1},{x:268.61002604166663,y:275.2942708333333,step:1},{x:266.5305989583333,y:277.1015625,step:1},{x:263.544921875,y:277.94010416666663,step:1},{x:260.4446818033854,y:277.94010416666663,step:1},{x:259.5384318033854,y:277.94010416666663,step:1},{x:258.78190104166663,y:277.81510416666663,step:1},{x:258.21486409505206,y:277.7734375,step:1},{x:256.4759114583333,y:287.9374593098958,step:0},{x:251.146484375,y:287.9374593098958,step:0},{x:255.87109375,y:260.1335042317708,step:0},{x:259.0462239583333,y:272.8170979817708,step:2},{x:259.61328125,y:272.9427083333333,step:1},{x:260.2181193033854,y:273.0266927083333,step:1},{x:261.1634318033854,y:273.0266927083333,step:1},{x:264.4140625,y:273.0266927083333,step:1},{x:266.56901041666663,y:270.6751302083333,step:1},{x:266.56901041666663,y:267.861328125,step:1},{x:266.56901041666663,y:265.130859375,step:1},{x:264.7923177083333,y:264.24869791666663,step:1},{x:262.712890625,y:264.24869791666663,step:1},{x:261.6927083333333,y:264.24869791666663,step:1},{x:260.9368489583333,y:264.33268229166663,step:1},{x:260.48307291666663,y:264.4167073567708,step:1},{x:259.0462239583333,y:272.8170979817708,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:277.19010416666663,y:260.1335042317708,step:2},{x:278.85353597005206,y:259.67057291666663,step:1},{x:281.3860677083333,y:259.41861979166663,step:1},{x:283.84246826171875,y:259.41861979166663,step:1},{x:286.14845784505206,y:259.41861979166663,step:1},{x:288.75651041666663,y:259.8391927083333,step:1},{x:290.6087239583333,y:261.30924479166663,step:1},{x:292.34765625,y:262.56901041666663,step:1},{x:293.3685099283854,y:264.58463541666663,step:1},{x:293.3685099283854,y:267.314453125,step:1},{x:293.3685099283854,y:270.884765625,step:1},{x:291.8938802083333,y:273.6145833333333,step:1},{x:289.92836507161456,y:275.2942708333333,step:1},{x:287.84962972005206,y:277.1015625,step:1},{x:284.86328125,y:277.94010416666663,step:1},{x:281.763671875,y:277.94010416666663,step:1},{x:280.8567708333333,y:277.94010416666663,step:1},{x:280.10028076171875,y:277.81510416666663,step:1},{x:279.533203125,y:277.7734375,step:1},{x:277.794921875,y:287.9374593098958,step:0},{x:272.4648234049479,y:287.9374593098958,step:0},{x:277.19010416666663,y:260.1335042317708,step:0},{x:280.36525472005206,y:272.8170979817708,step:2},{x:280.93229166666663,y:272.9427083333333,step:1},{x:281.537109375,y:273.0266927083333,step:1},{x:282.482421875,y:273.0266927083333,step:1},{x:285.732421875,y:273.0266927083333,step:1},{x:287.88736979166663,y:270.6751302083333,step:1},{x:287.88736979166663,y:267.861328125,step:1},{x:287.88736979166663,y:265.130859375,step:1},{x:286.1106974283854,y:264.24869791666663,step:1},{x:284.03192138671875,y:264.24869791666663,step:1},{x:283.0110677083333,y:264.24869791666663,step:1},{x:282.2552286783854,y:264.33268229166663,step:1},{x:281.80145263671875,y:264.4167073567708,step:1},{x:280.36525472005206,y:272.8170979817708,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:298.583984375,y:260.1335042317708,step:2},{x:300.2845052083333,y:259.67057291666663,step:1},{x:302.8548380533854,y:259.41861979166663,step:1},{x:305.3880208333333,y:259.41861979166663,step:1},{x:307.80731201171875,y:259.41861979166663,step:1},{x:310.3020833333333,y:259.79752604166663,step:1},{x:312.078125,y:261.056640625,step:1},{x:313.7415364583333,y:262.1491292317708,step:1},{x:314.9134318033854,y:263.91276041666663,step:1},{x:314.9134318033854,y:266.5592854817708,step:1},{x:314.9134318033854,y:270.7591145833333,step:1},{x:312.41861979166663,y:273.4049072265625,step:1},{x:309.1302083333333,y:274.58072916666663,step:1},{x:309.1302083333333,y:274.70703125,step:0},{x:310.642578125,y:275.46354166666663,step:1},{x:311.322265625,y:277.3098958333333,step:1},{x:311.54949951171875,y:279.8723958333333,step:1},{x:311.88930257161456,y:283.06510416666663,step:1},{x:312.078125,y:286.76041666666663,step:1},{x:312.53190104166663,y:287.9374593098958,step:1},{x:306.93752034505206,y:287.9374593098958,step:0},{x:306.7109375,y:287.18094889322913,step:1},{x:306.4466145833333,y:284.74479166666663,step:1},{x:306.21940104166663,y:281.2591145833333,step:1},{x:305.955078125,y:277.81510416666663,step:1},{x:304.89650472005206,y:276.765625,step:1},{x:302.7415364583333,y:276.765625,step:1},{x:301.07877604166663,y:276.765625,step:0},{x:299.1888020833333,y:287.9374593098958,step:0},{x:293.82096354166663,y:287.9374593098958,step:0},{x:298.583984375,y:260.1335042317708,step:0},{x:301.9101359049479,y:272.22855631510413,step:2},{x:304.1399739583333,y:272.22855631510413,step:0},{x:307.08917236328125,y:272.22855631510413,step:1},{x:309.24346923828125,y:270.25455729166663,step:1},{x:309.24346923828125,y:267.48246256510413,step:1},{x:309.24346923828125,y:265.1731770833333,step:1},{x:307.5423380533854,y:264.16471354166663,step:1},{x:305.35026041666663,y:264.16471354166663,step:1},{x:304.330078125,y:264.16471354166663,step:1},{x:303.6868693033854,y:264.24869791666663,step:1},{x:303.2337239583333,y:264.3749593098958,step:1},{x:301.9101359049479,y:272.22855631510413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:327.236328125,y:288.3984375,step:2},{x:320.6210734049479,y:288.3984375,step:1},{x:316.91668701171875,y:283.19010416666663,step:1},{x:316.91668701171875,y:276.59635416666663,step:1},{x:316.91668701171875,y:271.47330729166663,step:1},{x:318.61783854166663,y:266.39127604166663,step:1},{x:321.603515625,y:263.19921875,step:1},{x:323.98502604166663,y:260.6790364583333,step:1},{x:327.236328125,y:259.16666666666663,step:1},{x:330.90236409505206,y:259.16666666666663,step:1},{x:337.63087972005206,y:259.16666666666663,step:1},{x:341.18424479166663,y:264.20703125,step:1},{x:341.18424479166663,y:270.9693603515625,step:1},{x:341.18424479166663,y:276.1354573567708,step:1},{x:339.55859375,y:281.17447916666663,step:1},{x:336.6477864583333,y:284.3255208333333,step:1},{x:334.2669270833333,y:286.8880615234375,step:1},{x:331.0540364583333,y:288.3984375,step:1},{x:327.2734375,y:288.3984375,step:1},{x:327.236328125,y:288.3984375,step:0},{x:328.02994791666663,y:283.35941569010413,step:2},{x:329.6555989583333,y:283.35941569010413,step:1},{x:331.12957763671875,y:282.6028645833333,step:1},{x:332.30143229166663,y:281.3021240234375,step:1},{x:334.3040364583333,y:279.0755208333333,step:1},{x:335.40104166666663,y:274.41276041666663,step:1},{x:335.40104166666663,y:271.13736979166663,step:1},{x:335.40104166666663,y:267.6087239583333,step:1},{x:334.2669270833333,y:264.20703125,step:1},{x:330.2597452799479,y:264.20703125,step:1},{x:328.55922444661456,y:264.20703125,step:1},{x:327.04689534505206,y:265.0045166015625,step:1},{x:325.8749796549479,y:266.34891764322913,step:1},{x:323.83400472005206,y:268.57486979166663,step:1},{x:322.69986979166663,y:272.9849853515625,step:1},{x:322.69986979166663,y:276.3880208333333,step:1},{x:322.69986979166663,y:280.3775634765625,step:1},{x:324.3255208333333,y:283.35941569010413,step:1},{x:327.99151611328125,y:283.35941569010413,step:1},{x:328.02994791666663,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:347.61002604166663,y:287.9374593098958,step:2},{x:344.435546875,y:259.6288655598958,step:0},{x:350.06705729166663,y:259.6288655598958,step:0},{x:351.201171875,y:273.1106770833333,step:0},{x:351.4661458333333,y:276.1354573567708,step:1},{x:351.6549886067708,y:278.8646240234375,step:1},{x:351.80594889322913,y:281.8046468098958,step:1},{x:351.88151041666663,y:281.8046468098958,step:0},{x:352.82682291666663,y:279.03385416666663,step:1},{x:354.03641764322913,y:276.0091552734375,step:1},{x:355.283203125,y:273.068359375,step:1},{x:360.9915771484375,y:259.6288655598958,step:0},{x:367.07743326822913,y:259.6288655598958,step:0},{x:353.9232177734375,y:287.9374593098958,step:0},{x:347.61002604166663,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:381.7805989583333,y:275.88285319010413,step:2},{x:372.74674479166663,y:275.88285319010413,step:0},{x:371.5755208333333,y:282.7708333333333,step:0},{x:381.7434895833333,y:282.7708333333333,step:0},{x:380.87369791666663,y:287.9374593098958,step:0},{x:365.224609375,y:287.9374593098958,step:0},{x:370.06315104166663,y:259.6288655598958,step:0},{x:385.1451416015625,y:259.6288655598958,step:0},{x:384.2376708984375,y:264.79496256510413,step:0},{x:374.6366780598958,y:264.79496256510413,step:0},{x:373.57877604166663,y:270.8014729817708,step:0},{x:382.68815104166663,y:270.8014729817708,step:0},{x:381.7805989583333,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:389.52994791666663,y:260.048828125,step:2},{x:391.7220052083333,y:259.6288655598958,step:1},{x:394.103515625,y:259.41861979166663,step:1},{x:396.5989990234375,y:259.41861979166663,step:1},{x:400.5677083333333,y:259.41861979166663,step:1},{x:403.705078125,y:260.42704264322913,step:1},{x:405.8593343098958,y:262.4849853515625,step:1},{x:407.93876139322913,y:264.33268229166663,step:1},{x:409.22391764322913,y:267.146484375,step:1},{x:409.22391764322913,y:271.3470052083333,step:1},{x:409.22391764322913,y:276.8073323567708,step:1},{x:407.1444905598958,y:281.5521240234375,step:1},{x:404.0071614583333,y:284.3671875,step:1},{x:401.05924479166663,y:287.01298014322913,step:1},{x:397.3170166015625,y:288.1458333333333,step:1},{x:391.7981770833333,y:288.1458333333333,step:1},{x:388.73636881510413,y:288.1458333333333,step:1},{x:386.0904541015625,y:287.85282389322913,step:1},{x:384.80533854166663,y:287.5598958333333,step:1},{x:389.52994791666663,y:260.048828125,step:0},{x:391.080078125,y:283.1067708333333,step:2},{x:391.7220052083333,y:283.19010416666663,step:1},{x:392.5162353515625,y:283.2317708333333,step:1},{x:393.4609375,y:283.2317708333333,step:1},{x:396.40946451822913,y:283.2317708333333,step:1},{x:399.017578125,y:282.0573323567708,step:1},{x:400.6809895833333,y:279.9569905598958,step:1},{x:402.4198811848958,y:277.7317708333333,step:1},{x:403.32682291666663,y:274.7916259765625,step:1},{x:403.32682291666663,y:271.38871256510413,step:1},{x:403.32682291666663,y:266.8952229817708,step:1},{x:401.0970052083333,y:264.24869791666663,step:1},{x:396.5989990234375,y:264.24869791666663,step:1},{x:395.6536865234375,y:264.24869791666663,step:1},{x:394.8600667317708,y:264.33268229166663,step:1},{x:394.2923583984375,y:264.458984375,step:1},{x:391.080078125,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(41,66,18,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Ih=[{type:"path",stampPoints:[{x:523.234375,y:293.9374593098958,step:2},{x:523.234375,y:298.3358968098958,step:1},{x:519.3333333333333,y:301.9374593098958,step:1},{x:514.5638020833333,y:301.9374593098958,step:1},{x:305.404296875,y:301.9374593098958,step:0},{x:300.6360677083333,y:301.9374593098958,step:1},{x:296.73504638671875,y:298.3358968098958,step:1},{x:296.73504638671875,y:293.9374593098958,step:1},{x:296.73504638671875,y:251.93745930989581,step:0},{x:296.73504638671875,y:247.53645833333331,step:1},{x:300.6360677083333,y:243.93745930989581,step:1},{x:305.404296875,y:243.93745930989581,step:1},{x:514.5638020833333,y:243.93745930989581,step:0},{x:519.3333333333333,y:243.93745930989581,step:1},{x:523.234375,y:247.53645833333331,step:1},{x:523.234375,y:251.93745930989581,step:1},{x:523.234375,y:293.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:523.234375,y:293.9374593098958,step:2},{x:523.234375,y:298.3358968098958,step:1},{x:519.3333333333333,y:301.9374593098958,step:1},{x:514.5638020833333,y:301.9374593098958,step:1},{x:305.404296875,y:301.9374593098958,step:0},{x:300.6360677083333,y:301.9374593098958,step:1},{x:296.73504638671875,y:298.3358968098958,step:1},{x:296.73504638671875,y:293.9374593098958,step:1},{x:296.73504638671875,y:251.93745930989581,step:0},{x:296.73504638671875,y:247.53645833333331,step:1},{x:300.6360677083333,y:243.93745930989581,step:1},{x:305.404296875,y:243.93745930989581,step:1},{x:514.5638020833333,y:243.93745930989581,step:0},{x:519.3333333333333,y:243.93745930989581,step:1},{x:523.234375,y:247.53645833333331,step:1},{x:523.234375,y:251.93745930989581,step:1},{x:523.234375,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:329.54166666666663,y:287.13798014322913,step:2},{x:328.1810099283854,y:287.80985514322913,step:1},{x:325.91276041666663,y:288.35673014322913,step:1},{x:322.8515625,y:288.35673014322913,step:1},{x:316.0852864583333,y:288.35673014322913,step:1},{x:311.58660888671875,y:283.8203125,step:1},{x:311.58660888671875,y:276.3437093098958,step:1},{x:311.58660888671875,y:269.9609375,step:1},{x:314.15690104166663,y:265.046875,step:1},{x:318.0130411783854,y:262.1901448567708,step:1},{x:320.65885416666663,y:260.1745198567708,step:1},{x:323.75844319661456,y:259.2083333333333,step:1},{x:327.349609375,y:259.2083333333333,step:1},{x:330.1087443033854,y:259.2083333333333,step:1},{x:332.18817138671875,y:259.92191569010413,step:1},{x:332.943359375,y:260.38541666666663,step:1},{x:331.43166097005206,y:265.29947916666663,step:0},{x:330.71356201171875,y:264.8802490234375,step:1},{x:329.01236979166663,y:264.3749593098958,step:1},{x:326.8203125,y:264.3749593098958,step:1},{x:324.62760416666663,y:264.3749593098958,step:1},{x:322.5488077799479,y:265.1302083333333,step:1},{x:320.99867757161456,y:266.5598958333333,step:1},{x:318.8821614583333,y:268.4895833333333,step:1},{x:317.4837239583333,y:271.7239583333333,step:1},{x:317.4837239583333,y:275.6718343098958,step:1},{x:317.4837239583333,y:280.16666666666663,step:1},{x:319.78971354166663,y:283.19010416666663,step:1},{x:324.25002034505206,y:283.19010416666663,step:1},{x:326.064453125,y:283.19010416666663,step:1},{x:327.84051513671875,y:282.85416666666663,step:1},{x:329.087890625,y:282.265625,step:1},{x:329.54166666666663,y:287.13798014322913,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:342.9987386067708,y:288.3984375,step:2},{x:336.3841145833333,y:288.3984375,step:1},{x:332.67970784505206,y:283.19010416666663,step:1},{x:332.67970784505206,y:276.59635416666663,step:1},{x:332.67970784505206,y:271.4739990234375,step:1},{x:334.380859375,y:266.390625,step:1},{x:337.3665364583333,y:263.19791666666663,step:1},{x:339.74806722005206,y:260.6796875,step:1},{x:342.9987386067708,y:259.16666666666663,step:1},{x:346.6653645833333,y:259.16666666666663,step:1},{x:353.3938802083333,y:259.16666666666663,step:1},{x:356.94730631510413,y:264.2083333333333,step:1},{x:356.94730631510413,y:270.96875,step:1},{x:356.94730631510413,y:276.1354573567708,step:1},{x:355.3216145833333,y:281.17447916666663,step:1},{x:352.4107666015625,y:284.3255208333333,step:1},{x:350.0292561848958,y:286.8880615234375,step:1},{x:346.8170979817708,y:288.3984375,step:1},{x:343.0364583333333,y:288.3984375,step:1},{x:342.9987386067708,y:288.3984375,step:0},{x:343.79296875,y:283.35941569010413,step:2},{x:345.4185791015625,y:283.35941569010413,step:1},{x:346.892578125,y:282.6015625,step:1},{x:348.0638020833333,y:281.3021240234375,step:1},{x:350.06705729166663,y:279.0755208333333,step:1},{x:351.1634114583333,y:274.4140625,step:1},{x:351.1634114583333,y:271.13798014322913,step:1},{x:351.1634114583333,y:267.609375,step:1},{x:350.0292561848958,y:264.2083333333333,step:1},{x:346.0227864583333,y:264.2083333333333,step:1},{x:344.3216552734375,y:264.2083333333333,step:1},{x:342.8098958333333,y:265.00516764322913,step:1},{x:341.6380208333333,y:266.34891764322913,step:1},{x:339.5970052083333,y:268.5755208333333,step:1},{x:338.46291097005206,y:272.9843343098958,step:1},{x:338.46291097005206,y:276.3880208333333,step:1},{x:338.46291097005206,y:280.3775634765625,step:1},{x:340.087890625,y:283.35941569010413,step:1},{x:343.75455729166663,y:283.35941569010413,step:1},{x:343.79296875,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:379.5130208333333,y:287.9374593098958,step:2},{x:381.06315104166663,y:276.26041666666663,step:0},{x:381.478515625,y:273.1953125,step:1},{x:382.04557291666663,y:269.33072916666663,step:1},{x:382.76371256510413,y:265.2161865234375,step:1},{x:382.6503499348958,y:265.2161865234375,step:0},{x:381.2519124348958,y:268.8671875,step:1},{x:379.66471354166663,y:272.7734375,step:1},{x:378.26627604166663,y:275.88285319010413,step:1},{x:373.04886881510413,y:287.4739990234375,step:0},{x:368.8157958984375,y:287.4739990234375,step:0},{x:367.908203125,y:276.00785319010413,step:0},{x:367.68168131510413,y:272.90104166666663,step:1},{x:367.4928792317708,y:268.9948323567708,step:1},{x:367.34183756510413,y:265.2161865234375,step:1},{x:367.26627604166663,y:265.2161865234375,step:0},{x:366.54752604166663,y:268.953125,step:1},{x:365.79166666666663,y:273.2369384765625,step:1},{x:365.14908854166663,y:276.26041666666663,step:1},{x:362.6165364583333,y:287.9374593098958,step:0},{x:357.626953125,y:287.9374593098958,step:0},{x:364.0150146484375,y:259.6302083333333,step:0},{x:371.3105061848958,y:259.6302083333333,step:0},{x:372.10416666666663,y:270.42191569010413,step:0},{x:372.255859375,y:273.06766764322913,step:1},{x:372.5201416015625,y:276.26041666666663,step:1},{x:372.5579427083333,y:279.4114583333333,step:1},{x:372.708984375,y:279.4114583333333,step:0},{x:373.69205729166663,y:276.26041666666663,step:1},{x:375.052734375,y:272.9427083333333,step:1},{x:376.1491292317708,y:270.3802083333333,step:1},{x:380.87369791666663,y:259.6302083333333,step:0},{x:388.2447509765625,y:259.6302083333333,step:0},{x:384.80533854166663,y:287.9374593098958,step:0},{x:379.5130208333333,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:393.99027506510413,y:260.1328125,step:2},{x:395.6536865234375,y:259.6718343098958,step:1},{x:398.1862386067708,y:259.4192708333333,step:1},{x:400.64322916666663,y:259.4192708333333,step:1},{x:402.94921875,y:259.4192708333333,step:1},{x:405.5572509765625,y:259.83854166666663,step:1},{x:407.40946451822913,y:261.3098958333333,step:1},{x:409.1484375,y:262.56766764322913,step:1},{x:410.1692708333333,y:264.5859375,step:1},{x:410.1692708333333,y:267.31510416666663,step:1},{x:410.1692708333333,y:270.8854573567708,step:1},{x:408.6946614583333,y:273.6145833333333,step:1},{x:406.72855631510413,y:275.2942708333333,step:1},{x:404.6503499348958,y:277.1015625,step:1},{x:401.66410319010413,y:277.94010416666663,step:1},{x:398.5644124348958,y:277.94010416666663,step:1},{x:397.656982421875,y:277.94010416666663,step:1},{x:396.9010823567708,y:277.81510416666663,step:1},{x:396.333984375,y:277.7734375,step:1},{x:394.59574381510413,y:287.9374593098958,step:0},{x:389.26566569010413,y:287.9374593098958,step:0},{x:393.99027506510413,y:260.1328125,step:0},{x:397.1659749348958,y:272.8177083333333,step:2},{x:397.73246256510413,y:272.9427083333333,step:1},{x:398.337890625,y:273.02604166666663,step:1},{x:399.28251139322913,y:273.02604166666663,step:1},{x:402.5331624348958,y:273.02604166666663,step:1},{x:404.68815104166663,y:270.6745198567708,step:1},{x:404.68815104166663,y:267.859375,step:1},{x:404.68815104166663,y:265.1302083333333,step:1},{x:402.91141764322913,y:264.25,step:1},{x:400.8326416015625,y:264.25,step:1},{x:399.81180826822913,y:264.25,step:1},{x:399.05533854166663,y:264.3333333333333,step:1},{x:398.60221354166663,y:264.4167073567708,step:1},{x:397.1659749348958,y:272.8177083333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:415.421875,y:259.6302083333333,step:2},{x:420.8645833333333,y:259.6302083333333,step:0},{x:416.9348958333333,y:282.64579264322913,step:0},{x:426.7239583333333,y:282.64579264322913,step:0},{x:425.8177083333333,y:287.9374593098958,step:0},{x:410.58329264322913,y:287.9374593098958,step:0},{x:415.421875,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.54947916666663,y:275.88285319010413,step:2},{x:436.515625,y:275.88285319010413,step:0},{x:435.3437093098958,y:282.7708333333333,step:0},{x:445.51041666666663,y:282.7708333333333,step:0},{x:444.6419270833333,y:287.9374593098958,step:0},{x:428.9921875,y:287.9374593098958,step:0},{x:433.83072916666663,y:259.6302083333333,step:0},{x:448.9127197265625,y:259.6302083333333,step:0},{x:448.00516764322913,y:264.7942708333333,step:0},{x:438.4036458333333,y:264.7942708333333,step:0},{x:437.34635416666663,y:270.8021240234375,step:0},{x:446.45572916666663,y:270.8021240234375,step:0},{x:445.54947916666663,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:457.0780843098958,y:264.92191569010413,step:2},{x:450.3489990234375,y:264.92191569010413,step:0},{x:451.2942708333333,y:259.6302083333333,step:0},{x:470.2317708333333,y:259.6302083333333,step:0},{x:469.32548014322913,y:264.92191569010413,step:0},{x:462.5208333333333,y:264.92191569010413,step:0},{x:458.58988444010413,y:287.9374593098958,step:0},{x:453.1458333333333,y:287.9374593098958,step:0},{x:457.0780843098958,y:264.92191569010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:485.0130208333333,y:275.88285319010413,step:2},{x:475.97782389322913,y:275.88285319010413,step:0},{x:474.8059895833333,y:282.7708333333333,step:0},{x:484.9739583333333,y:282.7708333333333,step:0},{x:484.10416666666663,y:287.9374593098958,step:0},{x:468.45572916666663,y:287.9374593098958,step:0},{x:473.2942708333333,y:259.6302083333333,step:0},{x:488.37504069010413,y:259.6302083333333,step:0},{x:487.46875,y:264.7942708333333,step:0},{x:477.8671875,y:264.7942708333333,step:0},{x:476.8098958333333,y:270.8021240234375,step:0},{x:485.9192708333333,y:270.8021240234375,step:0},{x:485.0130208333333,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:492.76041666666663,y:260.04947916666663,step:2},{x:494.953125,y:259.6302083333333,step:1},{x:497.33463541666663,y:259.4192708333333,step:1},{x:499.8294270833333,y:259.4192708333333,step:1},{x:503.7981770833333,y:259.4192708333333,step:1},{x:506.9348958333333,y:260.42704264322913,step:1},{x:509.0911458333333,y:262.4843343098958,step:1},{x:511.1692708333333,y:264.3333333333333,step:1},{x:512.4544270833333,y:267.14579264322913,step:1},{x:512.4544270833333,y:271.34635416666663,step:1},{x:512.4544270833333,y:276.8073323567708,step:1},{x:510.37504069010413,y:281.5521240234375,step:1},{x:507.2382405598958,y:284.3671875,step:1},{x:504.28910319010413,y:287.01298014322913,step:1},{x:500.546875,y:288.1458333333333,step:1},{x:495.0286865234375,y:288.1458333333333,step:1},{x:491.9661458333333,y:288.1458333333333,step:1},{x:489.3203125,y:287.8515218098958,step:1},{x:488.03641764322913,y:287.5598958333333,step:1},{x:492.76041666666663,y:260.04947916666663,step:0},{x:494.3099365234375,y:283.1067708333333,step:2},{x:494.953125,y:283.19010416666663,step:1},{x:495.7473958333333,y:283.2317708333333,step:1},{x:496.6927083333333,y:283.2317708333333,step:1},{x:499.640625,y:283.2317708333333,step:1},{x:502.2473958333333,y:282.0573323567708,step:1},{x:503.91141764322913,y:279.95572916666663,step:1},{x:505.6510823567708,y:277.7317708333333,step:1},{x:506.5572509765625,y:274.7916259765625,step:1},{x:506.5572509765625,y:271.3880615234375,step:1},{x:506.5572509765625,y:266.8958740234375,step:1},{x:504.32816569010413,y:264.25,step:1},{x:499.8294270833333,y:264.25,step:1},{x:498.8841145833333,y:264.25,step:1},{x:498.0911458333333,y:264.3333333333333,step:1},{x:497.52347819010413,y:264.45829264322913,step:1},{x:494.3099365234375,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Bh=[{type:"path",stampPoints:[{x:545.5651041666666,y:293.9374593098958,step:2},{x:545.5651041666666,y:298.3358968098958,step:1},{x:540.8880615234375,y:301.9374593098958,step:1},{x:535.1718343098958,y:301.9374593098958,step:1},{x:284.4602864583333,y:301.9374593098958,step:0},{x:278.74416097005206,y:301.9374593098958,step:1},{x:274.06837972005206,y:298.3358968098958,step:1},{x:274.06837972005206,y:293.9374593098958,step:1},{x:274.06837972005206,y:251.93745930989581,step:0},{x:274.06837972005206,y:247.53645833333331,step:1},{x:278.74416097005206,y:243.93745930989581,step:1},{x:284.4602864583333,y:243.93745930989581,step:1},{x:535.1718343098958,y:243.93745930989581,step:0},{x:540.8880615234375,y:243.93745930989581,step:1},{x:545.5651041666666,y:247.53645833333331,step:1},{x:545.5651041666666,y:251.93745930989581,step:1},{x:545.5651041666666,y:293.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #e4f1ff, #c9cee2)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:545.5651041666666,y:293.9374593098958,step:2},{x:545.5651041666666,y:298.3358968098958,step:1},{x:540.8880615234375,y:301.9374593098958,step:1},{x:535.1718343098958,y:301.9374593098958,step:1},{x:284.4602864583333,y:301.9374593098958,step:0},{x:278.74416097005206,y:301.9374593098958,step:1},{x:274.06837972005206,y:298.3358968098958,step:1},{x:274.06837972005206,y:293.9374593098958,step:1},{x:274.06837972005206,y:251.93745930989581,step:0},{x:274.06837972005206,y:247.53645833333331,step:1},{x:278.74416097005206,y:243.93745930989581,step:1},{x:284.4602864583333,y:243.93745930989581,step:1},{x:535.1718343098958,y:243.93745930989581,step:0},{x:540.8880615234375,y:243.93745930989581,step:1},{x:545.5651041666666,y:247.53645833333331,step:1},{x:545.5651041666666,y:251.93745930989581,step:1},{x:545.5651041666666,y:293.9374593098958,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(24,37,100,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:306.875,y:287.13798014322913,step:2},{x:305.51434326171875,y:287.80985514322913,step:1},{x:303.24609375,y:288.35673014322913,step:1},{x:300.1848958333333,y:288.35673014322913,step:1},{x:293.41861979166663,y:288.35673014322913,step:1},{x:288.91994222005206,y:283.8203125,step:1},{x:288.91994222005206,y:276.3437093098958,step:1},{x:288.91994222005206,y:269.9609375,step:1},{x:291.490234375,y:265.046875,step:1},{x:295.34637451171875,y:262.1901448567708,step:1},{x:297.9921875,y:260.1745198567708,step:1},{x:301.0917765299479,y:259.2083333333333,step:1},{x:304.6829427083333,y:259.2083333333333,step:1},{x:307.44207763671875,y:259.2083333333333,step:1},{x:309.52150472005206,y:259.92191569010413,step:1},{x:310.2766927083333,y:260.38541666666663,step:1},{x:308.7649943033854,y:265.29947916666663,step:0},{x:308.04689534505206,y:264.8802490234375,step:1},{x:306.345703125,y:264.3749593098958,step:1},{x:304.1536458333333,y:264.3749593098958,step:1},{x:301.9609375,y:264.3749593098958,step:1},{x:299.88214111328125,y:265.1302083333333,step:1},{x:298.3320109049479,y:266.5598958333333,step:1},{x:296.21549479166663,y:268.4895833333333,step:1},{x:294.81705729166663,y:271.7239583333333,step:1},{x:294.81705729166663,y:275.6718343098958,step:1},{x:294.81705729166663,y:280.16666666666663,step:1},{x:297.123046875,y:283.19010416666663,step:1},{x:301.5833536783854,y:283.19010416666663,step:1},{x:303.3977864583333,y:283.19010416666663,step:1},{x:305.17384847005206,y:282.85416666666663,step:1},{x:306.4212239583333,y:282.265625,step:1},{x:306.875,y:287.13798014322913,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:320.3320109049479,y:288.3984375,step:2},{x:313.71744791666663,y:288.3984375,step:1},{x:310.0130411783854,y:283.19010416666663,step:1},{x:310.0130411783854,y:276.59635416666663,step:1},{x:310.0130411783854,y:271.4739990234375,step:1},{x:311.7141927083333,y:266.390625,step:1},{x:314.69986979166663,y:263.19791666666663,step:1},{x:317.0814005533854,y:260.6796875,step:1},{x:320.3320109049479,y:259.16666666666663,step:1},{x:323.99867757161456,y:259.16666666666663,step:1},{x:330.72721354166663,y:259.16666666666663,step:1},{x:334.28057861328125,y:264.2083333333333,step:1},{x:334.28057861328125,y:270.96875,step:1},{x:334.28057861328125,y:276.1354573567708,step:1},{x:332.65494791666663,y:281.17447916666663,step:1},{x:329.74416097005206,y:284.3255208333333,step:1},{x:327.3626505533854,y:286.8880615234375,step:1},{x:324.150390625,y:288.3984375,step:1},{x:320.36981201171875,y:288.3984375,step:1},{x:320.3320109049479,y:288.3984375,step:0},{x:321.1263020833333,y:283.35941569010413,step:2},{x:322.751953125,y:283.35941569010413,step:1},{x:324.2259114583333,y:282.6015625,step:1},{x:325.39711507161456,y:281.3021240234375,step:1},{x:327.400390625,y:279.0755208333333,step:1},{x:328.49676513671875,y:274.4140625,step:1},{x:328.49676513671875,y:271.13798014322913,step:1},{x:328.49676513671875,y:267.609375,step:1},{x:327.3626505533854,y:264.2083333333333,step:1},{x:323.35611979166663,y:264.2083333333333,step:1},{x:321.65494791666663,y:264.2083333333333,step:1},{x:320.14322916666663,y:265.00516764322913,step:1},{x:318.97135416666663,y:266.34891764322913,step:1},{x:316.93033854166663,y:268.5755208333333,step:1},{x:315.7962443033854,y:272.9843343098958,step:1},{x:315.7962443033854,y:276.3880208333333,step:1},{x:315.7962443033854,y:280.3775634765625,step:1},{x:317.4212239583333,y:283.35941569010413,step:1},{x:321.087890625,y:283.35941569010413,step:1},{x:321.1263020833333,y:283.35941569010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:335.56512451171875,y:287.9374593098958,step:2},{x:340.4036458333333,y:259.6302083333333,step:0},{x:346.79166666666663,y:259.6302083333333,step:0},{x:350.1556396484375,y:270.42191569010413,step:0},{x:351.17643229166663,y:274.03385416666663,step:1},{x:351.8573811848958,y:276.9739583333333,step:1},{x:352.46158854166663,y:280.0833740234375,step:1},{x:352.57486979166663,y:280.0833740234375,step:0},{x:352.6888427734375,y:277.18485514322913,step:1},{x:353.06640625,y:274.0755208333333,step:1},{x:353.74674479166663,y:269.9192708333333,step:1},{x:355.4857177734375,y:259.6302083333333,step:0},{x:360.58854166666663,y:259.6302083333333,step:0},{x:355.75,y:287.9374593098958,step:0},{x:350.11783854166663,y:287.9374593098958,step:0},{x:346.5650634765625,y:276.6380208333333,step:0},{x:345.4309895833333,y:272.7734375,step:1},{x:344.75065104166663,y:270.2135823567708,step:1},{x:344.0697021484375,y:266.7682698567708,step:1},{x:343.9563802083333,y:266.7682698567708,step:0},{x:343.69205729166663,y:269.54166666666663,step:1},{x:343.0872395833333,y:273.53129069010413,step:1},{x:342.3313802083333,y:278.0234375,step:1},{x:340.63087972005206,y:287.9374593098958,step:0},{x:335.56512451171875,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:365.57743326822913,y:259.6302083333333,step:2},{x:380.50846354166663,y:259.6302083333333,step:0},{x:379.6009521484375,y:264.7942708333333,step:0},{x:370.1516927083333,y:264.7942708333333,step:0},{x:368.9798177083333,y:271.42972819010413,step:0},{x:377.86258951822913,y:271.42972819010413,step:0},{x:376.9557698567708,y:276.51298014322913,step:0},{x:368.11063639322913,y:276.51298014322913,step:0},{x:366.1823323567708,y:287.9374593098958,step:0},{x:360.7395833333333,y:287.9374593098958,step:0},{x:365.57743326822913,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.22265625,y:259.6302083333333,step:2},{x:385.3847249348958,y:287.9374593098958,step:0},{x:379.94071451822913,y:287.9374593098958,step:0},{x:384.7792561848958,y:259.6302083333333,step:0},{x:390.22265625,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:395.1737874348958,y:260.04947916666663,step:2},{x:397.36649576822913,y:259.6302083333333,step:1},{x:399.748046875,y:259.4192708333333,step:1},{x:402.24283854166663,y:259.4192708333333,step:1},{x:406.21158854166663,y:259.4192708333333,step:1},{x:409.3489990234375,y:260.42704264322913,step:1},{x:411.50260416666663,y:262.4843343098958,step:1},{x:413.58329264322913,y:264.3333333333333,step:1},{x:414.8671875,y:267.14579264322913,step:1},{x:414.8671875,y:271.34635416666663,step:1},{x:414.8671875,y:276.8073323567708,step:1},{x:412.7890625,y:281.5521240234375,step:1},{x:409.6510823567708,y:284.3671875,step:1},{x:406.7030843098958,y:287.01298014322913,step:1},{x:402.9609375,y:288.1458333333333,step:1},{x:397.4420166015625,y:288.1458333333333,step:1},{x:394.380859375,y:288.1458333333333,step:1},{x:391.734375,y:287.8515218098958,step:1},{x:390.4491780598958,y:287.5598958333333,step:1},{x:395.1737874348958,y:260.04947916666663,step:0},{x:396.7239583333333,y:283.1067708333333,step:2},{x:397.36649576822913,y:283.19010416666663,step:1},{x:398.16015625,y:283.2317708333333,step:1},{x:399.10477701822913,y:283.2317708333333,step:1},{x:402.0540364583333,y:283.2317708333333,step:1},{x:404.662109375,y:282.0573323567708,step:1},{x:406.3249104817708,y:279.95572916666663,step:1},{x:408.0638020833333,y:277.7317708333333,step:1},{x:408.970703125,y:274.7916259765625,step:1},{x:408.970703125,y:271.3880615234375,step:1},{x:408.970703125,y:266.8958740234375,step:1},{x:406.74088541666663,y:264.25,step:1},{x:402.24283854166663,y:264.25,step:1},{x:401.2974853515625,y:264.25,step:1},{x:400.5038655598958,y:264.3333333333333,step:1},{x:399.9368489583333,y:264.45829264322913,step:1},{x:396.7239583333333,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:432.7096761067708,y:275.88285319010413,step:2},{x:423.67447916666663,y:275.88285319010413,step:0},{x:422.50260416666663,y:282.7708333333333,step:0},{x:432.6718343098958,y:282.7708333333333,step:0},{x:431.80204264322913,y:287.9374593098958,step:0},{x:416.1536865234375,y:287.9374593098958,step:0},{x:420.9921875,y:259.6302083333333,step:0},{x:436.07291666666663,y:259.6302083333333,step:0},{x:435.16666666666663,y:264.7942708333333,step:0},{x:425.56510416666663,y:264.7942708333333,step:0},{x:424.5077718098958,y:270.8021240234375,step:0},{x:433.61722819010413,y:270.8021240234375,step:0},{x:432.7096761067708,y:275.88285319010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:435.69535319010413,y:287.9374593098958,step:2},{x:440.53385416666663,y:259.6302083333333,step:0},{x:446.921875,y:259.6302083333333,step:0},{x:450.2864583333333,y:270.42191569010413,step:0},{x:451.3072509765625,y:274.03385416666663,step:1},{x:451.98697916666663,y:276.9739583333333,step:1},{x:452.59244791666663,y:280.0833740234375,step:1},{x:452.70572916666663,y:280.0833740234375,step:0},{x:452.8190511067708,y:277.18485514322913,step:1},{x:453.1978759765625,y:274.0755208333333,step:1},{x:453.87760416666663,y:269.9192708333333,step:1},{x:455.61722819010413,y:259.6302083333333,step:0},{x:460.71875,y:259.6302083333333,step:0},{x:455.8802083333333,y:287.9374593098958,step:0},{x:450.24869791666663,y:287.9374593098958,step:0},{x:446.6953125,y:276.6380208333333,step:0},{x:445.56119791666663,y:272.7734375,step:1},{x:444.8802083333333,y:270.2135823567708,step:1},{x:444.2005208333333,y:266.7682698567708,step:1},{x:444.0872395833333,y:266.7682698567708,step:0},{x:443.8228759765625,y:269.54166666666663,step:1},{x:443.21875,y:273.53129069010413,step:1},{x:442.4622802734375,y:278.0234375,step:1},{x:440.76041666666663,y:287.9374593098958,step:0},{x:435.69535319010413,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:469.4127197265625,y:264.92191569010413,step:2},{x:462.6848958333333,y:264.92191569010413,step:0},{x:463.6302490234375,y:259.6302083333333,step:0},{x:482.5677083333333,y:259.6302083333333,step:0},{x:481.65885416666663,y:264.92191569010413,step:0},{x:474.85550944010413,y:264.92191569010413,step:0},{x:470.92447916666663,y:287.9374593098958,step:0},{x:465.4818115234375,y:287.9374593098958,step:0},{x:469.4127197265625,y:264.92191569010413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:490.9583740234375,y:259.6302083333333,step:2},{x:486.1197509765625,y:287.9374593098958,step:0},{x:480.67704264322913,y:287.9374593098958,step:0},{x:485.51566569010413,y:259.6302083333333,step:0},{x:490.9583740234375,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:498.1770833333333,y:280.5859375,step:2},{x:495.1913655598958,y:287.9374593098958,step:0},{x:489.3697509765625,y:287.9374593098958,step:0},{x:501.8072509765625,y:259.6302083333333,step:0},{x:508.79947916666663,y:259.6302083333333,step:0},{x:511.7473958333333,y:287.9374593098958,step:0},{x:506.0403645833333,y:287.9374593098958,step:0},{x:505.51041666666663,y:280.5859375,step:0},{x:498.1770833333333,y:280.5859375,step:0},{x:505.28385416666663,y:275.9661458333333,step:2},{x:504.79166666666663,y:269.87760416666663,step:0},{x:504.6796875,y:268.3229573567708,step:1},{x:504.5650634765625,y:266.05472819010413,step:1},{x:504.4530843098958,y:264.3333333333333,step:1},{x:504.3385009765625,y:264.3333333333333,step:0},{x:503.6966552734375,y:266.05472819010413,step:1},{x:502.9792073567708,y:268.2396240234375,step:1},{x:502.2981770833333,y:269.87760416666663,step:1},{x:499.80204264322913,y:275.9661458333333,step:0},{x:505.28385416666663,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:519.3463541666666,y:259.6302083333333,step:2},{x:524.7890625,y:259.6302083333333,step:0},{x:520.8568115234375,y:282.64579264322913,step:0},{x:530.6484375,y:282.64579264322913,step:0},{x:529.7395833333333,y:287.9374593098958,step:0},{x:514.5077718098958,y:287.9374593098958,step:0},{x:519.3463541666666,y:259.6302083333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Uh=[{type:"path",stampPoints:[{x:480.32816569010413,y:291.3645833333333,step:2},{x:480.32816569010413,y:297.2317708333333,step:1},{x:474.28125,y:302.03125,step:1},{x:466.8880615234375,y:302.03125,step:1},{x:350.91019694010413,y:302.03125,step:0},{x:343.51822916666663,y:302.03125,step:1},{x:337.4700724283854,y:297.2317708333333,step:1},{x:337.4700724283854,y:291.3645833333333,step:1},{x:337.4700724283854,y:254.3671875,step:0},{x:337.4700724283854,y:248.50069173177081,step:1},{x:343.51822916666663,y:243.70052083333331,step:1},{x:350.91019694010413,y:243.70052083333331,step:1},{x:466.8880615234375,y:243.70052083333331,step:0},{x:474.28125,y:243.70052083333331,step:1},{x:480.32816569010413,y:248.50069173177081,step:1},{x:480.32816569010413,y:254.3671875,step:1},{x:480.32816569010413,y:291.3645833333333,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #e4f1ff, #c9cee2)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:480.32816569010413,y:291.3645833333333,step:2},{x:480.32816569010413,y:297.2317708333333,step:1},{x:474.28125,y:302.03125,step:1},{x:466.8880615234375,y:302.03125,step:1},{x:350.91019694010413,y:302.03125,step:0},{x:343.51822916666663,y:302.03125,step:1},{x:337.4700724283854,y:297.2317708333333,step:1},{x:337.4700724283854,y:291.3645833333333,step:1},{x:337.4700724283854,y:254.3671875,step:0},{x:337.4700724283854,y:248.50069173177081,step:1},{x:343.51822916666663,y:243.70052083333331,step:1},{x:350.91019694010413,y:243.70052083333331,step:1},{x:466.8880615234375,y:243.70052083333331,step:0},{x:474.28125,y:243.70052083333331,step:1},{x:480.32816569010413,y:248.50069173177081,step:1},{x:480.32816569010413,y:254.3671875,step:1},{x:480.32816569010413,y:291.3645833333333,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(24,37,100,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:356.54886881510413,y:260.048828125,step:2},{x:358.7415364583333,y:259.6288655598958,step:1},{x:361.12308756510413,y:259.41861979166663,step:1},{x:363.61722819010413,y:259.41861979166663,step:1},{x:367.5865478515625,y:259.41861979166663,step:1},{x:370.7239583333333,y:260.42704264322913,step:1},{x:372.8782552083333,y:262.4849853515625,step:1},{x:374.9577229817708,y:264.33268229166663,step:1},{x:376.24283854166663,y:267.146484375,step:1},{x:376.24283854166663,y:271.3470052083333,step:1},{x:376.24283854166663,y:276.8073323567708,step:1},{x:374.1634114583333,y:281.5521240234375,step:1},{x:371.0267333984375,y:284.3671875,step:1},{x:368.07743326822913,y:287.01298014322913,step:1},{x:364.3352864583333,y:288.1458333333333,step:1},{x:358.8170979817708,y:288.1458333333333,step:1},{x:355.7552083333333,y:288.1458333333333,step:1},{x:353.10868326822913,y:287.85282389322913,step:1},{x:351.8235677083333,y:287.5598958333333,step:1},{x:356.54886881510413,y:260.048828125,step:0},{x:358.0989990234375,y:283.1067708333333,step:2},{x:358.7415364583333,y:283.19010416666663,step:1},{x:359.53515625,y:283.2317708333333,step:1},{x:360.47977701822913,y:283.2317708333333,step:1},{x:363.4284261067708,y:283.2317708333333,step:1},{x:366.0370686848958,y:282.0573323567708,step:1},{x:367.69986979166663,y:279.9569905598958,step:1},{x:369.4388020833333,y:277.7317708333333,step:1},{x:370.34574381510413,y:274.7916259765625,step:1},{x:370.34574381510413,y:271.38871256510413,step:1},{x:370.34574381510413,y:266.8952229817708,step:1},{x:368.1158447265625,y:264.24869791666663,step:1},{x:363.61722819010413,y:264.24869791666663,step:1},{x:362.67252604166663,y:264.24869791666663,step:1},{x:361.8782552083333,y:264.33268229166663,step:1},{x:361.31180826822913,y:264.458984375,step:1},{x:358.0989990234375,y:283.1067708333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:382.3288167317708,y:260.1335042317708,step:2},{x:384.0292561848958,y:259.67057291666663,step:1},{x:386.599609375,y:259.41861979166663,step:1},{x:389.1321614583333,y:259.41861979166663,step:1},{x:391.5520833333333,y:259.41861979166663,step:1},{x:394.0462239583333,y:259.79752604166663,step:1},{x:395.8228759765625,y:261.056640625,step:1},{x:397.48636881510413,y:262.1491292317708,step:1},{x:398.658203125,y:263.91276041666663,step:1},{x:398.658203125,y:266.5592854817708,step:1},{x:398.658203125,y:270.7591145833333,step:1},{x:396.1634114583333,y:273.4049072265625,step:1},{x:392.8743489583333,y:274.58072916666663,step:1},{x:392.8743489583333,y:274.70703125,step:0},{x:394.38671875,y:275.46354166666663,step:1},{x:395.06705729166663,y:277.3098958333333,step:1},{x:395.2942708333333,y:279.8723958333333,step:1},{x:395.6341145833333,y:283.06510416666663,step:1},{x:395.8228759765625,y:286.76041666666663,step:1},{x:396.2766927083333,y:287.9374593098958,step:1},{x:390.6823323567708,y:287.9374593098958,step:0},{x:390.45572916666663,y:287.18094889322913,step:1},{x:390.1907552083333,y:284.74479166666663,step:1},{x:389.96415201822913,y:281.2591145833333,step:1},{x:389.69921875,y:277.81510416666663,step:1},{x:388.6412353515625,y:276.765625,step:1},{x:386.486328125,y:276.765625,step:1},{x:384.8236083984375,y:276.765625,step:0},{x:382.9329427083333,y:287.9374593098958,step:0},{x:377.5657958984375,y:287.9374593098958,step:0},{x:382.3288167317708,y:260.1335042317708,step:0},{x:385.6549886067708,y:272.22855631510413,step:2},{x:387.88541666666663,y:272.22855631510413,step:0},{x:390.833984375,y:272.22855631510413,step:1},{x:392.9876708984375,y:270.25455729166663,step:1},{x:392.9876708984375,y:267.48246256510413,step:1},{x:392.9876708984375,y:265.1731770833333,step:1},{x:391.287109375,y:264.16471354166663,step:1},{x:389.0950520833333,y:264.16471354166663,step:1},{x:388.07421875,y:264.16471354166663,step:1},{x:387.431640625,y:264.24869791666663,step:1},{x:386.978515625,y:264.3749593098958,step:1},{x:385.6549886067708,y:272.22855631510413,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:406.9739583333333,y:280.5859375,step:2},{x:403.9876302083333,y:287.9374593098958,step:0},{x:398.1659749348958,y:287.9374593098958,step:0},{x:410.6028645833333,y:259.6288655598958,step:0},{x:417.59635416666663,y:259.6288655598958,step:0},{x:420.5442708333333,y:287.9374593098958,step:0},{x:414.8359375,y:287.9374593098958,step:0},{x:414.30729166666663,y:280.5859375,step:0},{x:406.9739583333333,y:280.5859375,step:0},{x:414.08072916666663,y:275.9661458333333,step:2},{x:413.58854166666663,y:269.8769124348958,step:0},{x:413.4753011067708,y:268.3229573567708,step:1},{x:413.36197916666663,y:266.0553792317708,step:1},{x:413.24869791666663,y:264.33268229166663,step:1},{x:413.1353759765625,y:264.33268229166663,step:0},{x:412.4921468098958,y:266.0553792317708,step:1},{x:411.7734375,y:268.2389729817708,step:1},{x:411.0937093098958,y:269.8769124348958,step:1},{x:408.599609375,y:275.9661458333333,step:0},{x:414.08072916666663,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:428.1419677734375,y:259.6288655598958,step:2},{x:443.07291666666663,y:259.6288655598958,step:0},{x:442.1653645833333,y:264.79496256510413,step:0},{x:432.71610514322913,y:264.79496256510413,step:0},{x:431.5442708333333,y:271.4309895833333,step:0},{x:440.42704264322913,y:271.4309895833333,step:0},{x:439.51822916666663,y:276.51298014322913,step:0},{x:430.67447916666663,y:276.51298014322913,step:0},{x:428.7460530598958,y:287.9374593098958,step:0},{x:423.3033447265625,y:287.9374593098958,step:0},{x:428.1419677734375,y:259.6288655598958,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:451.1614583333333,y:264.9206136067708,step:2},{x:444.43229166666663,y:264.9206136067708,step:0},{x:445.37760416666663,y:259.6288655598958,step:0},{x:464.3151448567708,y:259.6288655598958,step:0},{x:463.40885416666663,y:264.9206136067708,step:0},{x:456.6041259765625,y:264.9206136067708,step:0},{x:452.6731770833333,y:287.9374593098958,step:0},{x:447.22916666666663,y:287.9374593098958,step:0},{x:451.1614583333333,y:264.9206136067708,step:0}],borderWidth:0,borderColor:"rgba(24,37,100,1)",background:"rgba(24,37,100,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Lh=[{type:"path",stampPoints:[{x:470.0130208333333,y:291.0103759765625,step:2},{x:470.0130208333333,y:296.87760416666663,step:1},{x:464.83203125,y:301.67704264322913,step:1},{x:458.4973958333333,y:301.67704264322913,step:1},{x:359.1308186848958,y:301.67704264322913,step:0},{x:352.7974853515625,y:301.67704264322913,step:1},{x:347.61588541666663,y:296.87760416666663,step:1},{x:347.61588541666663,y:291.0103759765625,step:1},{x:347.61588541666663,y:254.01236979166666,step:0},{x:347.61588541666663,y:248.14583333333331,step:1},{x:352.7974853515625,y:243.345703125,step:1},{x:359.1308186848958,y:243.345703125,step:1},{x:458.4973958333333,y:243.345703125,step:0},{x:464.83203125,y:243.345703125,step:1},{x:470.0130208333333,y:248.14583333333331,step:1},{x:470.0130208333333,y:254.01236979166666,step:1},{x:470.0130208333333,y:291.0103759765625,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f1f6ea, #cedfc5)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:470.0130208333333,y:291.0103759765625,step:2},{x:470.0130208333333,y:296.87760416666663,step:1},{x:464.83203125,y:301.67704264322913,step:1},{x:458.4973958333333,y:301.67704264322913,step:1},{x:359.1308186848958,y:301.67704264322913,step:0},{x:352.7974853515625,y:301.67704264322913,step:1},{x:347.61588541666663,y:296.87760416666663,step:1},{x:347.61588541666663,y:291.0103759765625,step:1},{x:347.61588541666663,y:254.01302083333331,step:0},{x:347.61588541666663,y:248.14652506510416,step:1},{x:352.7974853515625,y:243.34635416666666,step:1},{x:359.1308186848958,y:243.34635416666666,step:1},{x:458.4973958333333,y:243.34635416666666,step:0},{x:464.83203125,y:243.34635416666666,step:1},{x:470.0130208333333,y:248.14652506510416,step:1},{x:470.0130208333333,y:254.01302083333331,step:1},{x:470.0130208333333,y:291.0103759765625,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,106,28,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:365.95768229166663,y:259.62955729166663,step:2},{x:380.888671875,y:259.62955729166663,step:0},{x:379.9810791015625,y:264.79496256510413,step:0},{x:370.5318603515625,y:264.79496256510413,step:0},{x:369.36002604166663,y:271.431640625,step:0},{x:378.24283854166663,y:271.431640625,step:0},{x:377.3359375,y:276.51298014322913,step:0},{x:368.4908447265625,y:276.51298014322913,step:0},{x:366.5625,y:287.9374593098958,step:0},{x:361.1197509765625,y:287.9374593098958,step:0},{x:365.95768229166663,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.6028645833333,y:259.62955729166663,step:2},{x:385.76493326822913,y:287.9374593098958,step:0},{x:380.3210042317708,y:287.9374593098958,step:0},{x:385.1595052083333,y:259.62955729166663,step:0},{x:390.6028645833333,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:390.79166666666663,y:287.9374593098958,step:2},{x:395.62955729166663,y:259.62955729166663,step:0},{x:402.01822916666663,y:259.62955729166663,step:0},{x:405.3822021484375,y:270.423828125,step:0},{x:406.4030354817708,y:274.03641764322913,step:1},{x:407.0833333333333,y:276.9739583333333,step:1},{x:407.68815104166663,y:280.0833740234375,step:1},{x:407.8013916015625,y:280.0833740234375,step:0},{x:407.91471354166663,y:277.18485514322913,step:1},{x:408.29300944010413,y:274.078125,step:1},{x:408.97330729166663,y:269.91861979166663,step:1},{x:410.7109375,y:259.62955729166663,step:0},{x:415.81510416666663,y:259.62955729166663,step:0},{x:410.97660319010413,y:287.9374593098958,step:0},{x:405.34440104166663,y:287.9374593098958,step:0},{x:401.79166666666663,y:276.6380208333333,step:0},{x:400.6569417317708,y:272.775390625,step:1},{x:399.9771728515625,y:270.212890625,step:1},{x:399.2962239583333,y:266.7689208984375,step:1},{x:399.18290201822913,y:266.7689208984375,step:0},{x:398.9185791015625,y:269.541015625,step:1},{x:398.31315104166663,y:273.53129069010413,step:1},{x:397.5579427083333,y:278.0260823567708,step:1},{x:395.8567708333333,y:287.9374593098958,step:0},{x:390.79166666666663,y:287.9374593098958,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:422.9974365234375,y:280.5859375,step:2},{x:420.0103759765625,y:287.9374593098958,step:0},{x:414.1888427734375,y:287.9374593098958,step:0},{x:426.625,y:259.62955729166663,step:0},{x:433.61722819010413,y:259.62955729166663,step:0},{x:436.5677083333333,y:287.9374593098958,step:0},{x:430.859375,y:287.9374593098958,step:0},{x:430.3294270833333,y:280.5859375,step:0},{x:422.9974365234375,y:280.5859375,step:0},{x:430.1028645833333,y:275.9661458333333,step:2},{x:429.61197916666663,y:269.8769124348958,step:0},{x:429.4973958333333,y:268.322265625,step:1},{x:429.38541666666663,y:266.0553792317708,step:1},{x:429.27079264322913,y:264.33268229166663,step:1},{x:429.15751139322913,y:264.33268229166663,step:0},{x:428.515625,y:266.0553792317708,step:1},{x:427.796875,y:268.2389729817708,step:1},{x:427.1171468098958,y:269.8769124348958,step:1},{x:424.6223958333333,y:275.9661458333333,step:0},{x:430.1028645833333,y:275.9661458333333,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:444.1640625,y:259.62955729166663,step:2},{x:449.6068115234375,y:259.62955729166663,step:0},{x:445.67704264322913,y:282.64579264322913,step:0},{x:455.4661458333333,y:282.64579264322913,step:0},{x:454.5598958333333,y:287.9374593098958,step:0},{x:439.32548014322913,y:287.9374593098958,step:0},{x:444.1640625,y:259.62955729166663,step:0}],borderWidth:0,borderColor:"rgba(65,106,28,1)",background:"rgba(65,106,28,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Oh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(65,50,130,1)",background:"linear-gradient(to right bottom, #ccc2ff, #8677c7)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:386.35221354166663,y:267.82421875,step:2},{x:384.50846354166663,y:278.6067708333333,step:0},{x:382.435546875,y:278.6067708333333,step:0},{x:384.27799479166663,y:267.82421875,step:0},{x:386.35221354166663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:386.4237874348958,y:278.6067708333333,step:2},{x:388.2669677734375,y:267.82421875,step:0},{x:390.7005208333333,y:267.82421875,step:0},{x:391.982421875,y:271.935546875,step:0},{x:392.37113444010413,y:273.3118489583333,step:1},{x:392.6302490234375,y:274.4322509765625,step:1},{x:392.8606770833333,y:275.6145833333333,step:1},{x:392.9036458333333,y:275.6145833333333,step:0},{x:392.94730631510413,y:274.51298014322913,step:1},{x:393.0911458333333,y:273.32816569010413,step:1},{x:393.3503011067708,y:271.744140625,step:1},{x:394.0124104817708,y:267.82421875,step:0},{x:395.9563802083333,y:267.82421875,step:0},{x:394.1132405598958,y:278.6067708333333,step:0},{x:391.9680989583333,y:278.6067708333333,step:0},{x:390.61393229166663,y:274.3046468098958,step:0},{x:390.1823323567708,y:272.83203125,step:1},{x:389.9232177734375,y:271.8561604817708,step:1},{x:389.66410319010413,y:270.5435791015625,step:1},{x:389.6204833984375,y:270.5435791015625,step:0},{x:389.52018229166663,y:271.599609375,step:1},{x:389.28971354166663,y:273.11979166666663,step:1},{x:389.0013020833333,y:274.83203125,step:1},{x:388.353515625,y:278.6067708333333,step:0},{x:386.4237874348958,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:399.88736979166663,y:267.82421875,step:2},{x:398.0442708333333,y:278.6067708333333,step:0},{x:395.970703125,y:278.6067708333333,step:0},{x:397.8138020833333,y:267.82421875,step:0},{x:399.88736979166663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:403.2141927083333,y:269.83984375,step:2},{x:400.65104166666663,y:269.83984375,step:0},{x:401.0110677083333,y:267.82421875,step:0},{x:408.22526041666663,y:267.82421875,step:0},{x:407.87955729166663,y:269.83984375,step:0},{x:405.28776041666663,y:269.83984375,step:0},{x:403.7897542317708,y:278.6067708333333,step:0},{x:401.71610514322913,y:278.6067708333333,step:0},{x:403.2141927083333,y:269.83984375,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:411.421875,y:267.82421875,step:2},{x:409.5780843098958,y:278.6067708333333,step:0},{x:407.50455729166663,y:278.6067708333333,step:0},{x:409.3489990234375,y:267.82421875,step:0},{x:411.421875,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:414.1718343098958,y:275.80729166666663,step:2},{x:413.0338948567708,y:278.6067708333333,step:0},{x:410.8177490234375,y:278.6067708333333,step:0},{x:415.55472819010413,y:267.82421875,step:0},{x:418.21875,y:267.82421875,step:0},{x:419.3411458333333,y:278.6067708333333,step:0},{x:417.16666666666663,y:278.6067708333333,step:0},{x:416.9661458333333,y:275.80729166666663,step:0},{x:414.1718343098958,y:275.80729166666663,step:0},{x:416.8802083333333,y:274.04691569010413,step:2},{x:416.6927083333333,y:271.7278645833333,step:0},{x:416.6484375,y:271.1360677083333,step:1},{x:416.6054280598958,y:270.2714436848958,step:1},{x:416.5625,y:269.61588541666663,step:1},{x:416.5181884765625,y:269.61588541666663,step:0},{x:416.27347819010413,y:270.2714436848958,step:1},{x:416,y:271.1034749348958,step:1},{x:415.7421875,y:271.7278645833333,step:1},{x:414.79166666666663,y:274.04691569010413,step:0},{x:416.8802083333333,y:274.04691569010413,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:422.2357177734375,y:267.82421875,step:2},{x:424.3099365234375,y:267.82421875,step:0},{x:422.81254069010413,y:276.5911458333333,step:0},{x:426.5417073567708,y:276.5911458333333,step:0},{x:426.19535319010413,y:278.6067708333333,step:0},{x:420.39322916666663,y:278.6067708333333,step:0},{x:422.2357177734375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:433.97135416666663,y:267.82421875,step:2},{x:433.25260416666663,y:272.0163167317708,step:0},{x:436.76566569010413,y:272.0163167317708,step:0},{x:437.48441569010413,y:267.82421875,step:0},{x:439.5729573567708,y:267.82421875,step:0},{x:437.7292073567708,y:278.6067708333333,step:0},{x:435.65629069010413,y:278.6067708333333,step:0},{x:436.4192708333333,y:274.0638020833333,step:0},{x:432.8905843098958,y:274.0638020833333,step:0},{x:432.12760416666663,y:278.6067708333333,step:0},{x:430.05472819010413,y:278.6067708333333,step:0},{x:431.8983968098958,y:267.82421875,step:0},{x:433.97135416666663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.9530843098958,y:274.015625,step:2},{x:442.5103759765625,y:274.015625,step:0},{x:442.06510416666663,y:276.640625,step:0},{x:445.9374593098958,y:276.640625,step:0},{x:445.6068115234375,y:278.6067708333333,step:0},{x:439.6458740234375,y:278.6067708333333,step:0},{x:441.48832194010413,y:267.82421875,step:0},{x:447.234375,y:267.82421875,step:0},{x:446.8880615234375,y:269.7916259765625,step:0},{x:443.23173014322913,y:269.7916259765625,step:0},{x:442.828125,y:272.08011881510413,step:0},{x:446.29691569010413,y:272.08011881510413,step:0},{x:445.9530843098958,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:448.9192708333333,y:268.0163167317708,step:2},{x:449.5677490234375,y:267.83984375,step:1},{x:450.546875,y:267.744140625,step:1},{x:451.51041666666663,y:267.744140625,step:1},{x:452.43229166666663,y:267.744140625,step:1},{x:453.3827718098958,y:267.8880615234375,step:1},{x:454.0598958333333,y:268.36783854166663,step:1},{x:454.6927083333333,y:268.78385416666663,step:1},{x:455.1405843098958,y:269.45572916666663,step:1},{x:455.1405843098958,y:270.46354166666663,step:1},{x:455.1405843098958,y:272.0638020833333,step:1},{x:454.1888427734375,y:273.07157389322913,step:1},{x:452.9375,y:273.5208333333333,step:1},{x:452.9375,y:273.5677083333333,step:0},{x:453.5130208333333,y:273.8567708333333,step:1},{x:453.77079264322913,y:274.5598958333333,step:1},{x:453.8580322265625,y:275.5364583333333,step:1},{x:453.98697916666663,y:276.75260416666663,step:1},{x:454.0598958333333,y:278.1588948567708,step:1},{x:454.2317708333333,y:278.6067708333333,step:1},{x:452.1015625,y:278.6067708333333,step:0},{x:452.01566569010413,y:278.3203125,step:1},{x:451.9140625,y:277.3919270833333,step:1},{x:451.828125,y:276.0638020833333,step:1},{x:451.7265625,y:274.75260416666663,step:1},{x:451.32291666666663,y:274.3515218098958,step:1},{x:450.50260416666663,y:274.3515218098958,step:1},{x:449.86979166666663,y:274.3515218098958,step:0},{x:449.1484375,y:278.6067708333333,step:0},{x:447.1041259765625,y:278.6067708333333,step:0},{x:448.9192708333333,y:268.0163167317708,step:0},{x:450.1862386067708,y:272.6236572265625,step:2},{x:451.0364583333333,y:272.6236572265625,step:0},{x:452.15885416666663,y:272.6236572265625,step:1},{x:452.9792073567708,y:271.87174479166663,step:1},{x:452.9792073567708,y:270.8157958984375,step:1},{x:452.9792073567708,y:269.935546875,step:1},{x:452.3307698567708,y:269.5521240234375,step:1},{x:451.4973958333333,y:269.5521240234375,step:1},{x:451.1067708333333,y:269.5521240234375,step:1},{x:450.8620198567708,y:269.583984375,step:1},{x:450.69010416666663,y:269.6314697265625,step:1},{x:450.1862386067708,y:272.6236572265625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:461.79166666666663,y:274.015625,step:2},{x:458.3515625,y:274.015625,step:0},{x:457.90360514322913,y:276.640625,step:0},{x:461.77860514322913,y:276.640625,step:0},{x:461.44657389322913,y:278.6067708333333,step:0},{x:455.48441569010413,y:278.6067708333333,step:0},{x:457.328125,y:267.82421875,step:0},{x:463.07291666666663,y:267.82421875,step:0},{x:462.7292073567708,y:269.7916259765625,step:0},{x:459.0703125,y:269.7916259765625,step:0},{x:458.66666666666663,y:272.08011881510413,step:0},{x:462.1380208333333,y:272.08011881510413,step:0},{x:461.79166666666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(65,50,130,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Nh=[{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f8eae7, #ffc6c6)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,0.2)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:551.4908854166666,y:293.8854573567708,step:2},{x:551.4908854166666,y:298.2864583333333,step:1},{x:546.6080729166666,y:301.8854573567708,step:1},{x:540.6393229166666,y:301.8854573567708,step:1},{x:278.845703125,y:301.8854573567708,step:0},{x:272.87760416666663,y:301.8854573567708,step:1},{x:267.99477132161456,y:298.2864583333333,step:1},{x:267.99477132161456,y:293.8854573567708,step:1},{x:267.99477132161456,y:251.88545735677081,step:0},{x:267.99477132161456,y:247.48502604166666,step:1},{x:272.87760416666663,y:243.88545735677081,step:1},{x:278.845703125,y:243.88545735677081,step:1},{x:540.6393229166666,y:243.88545735677081,step:0},{x:546.6080729166666,y:243.88545735677081,step:1},{x:551.4908854166666,y:247.48502604166666,step:1},{x:551.4908854166666,y:251.88545735677081,step:1},{x:551.4908854166666,y:293.8854573567708,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:281.60611979166663,y:288,step:2},{x:286.44403076171875,y:259.69205729166663,step:0},{x:292.83270263671875,y:259.69205729166663,step:0},{x:296.1966145833333,y:270.4856770833333,step:0},{x:297.21744791666663,y:274.0989583333333,step:1},{x:297.89711507161456,y:277.0377197265625,step:1},{x:298.50260416666663,y:280.1458333333333,step:1},{x:298.61588541666663,y:280.1458333333333,step:0},{x:298.72914632161456,y:277.2473958333333,step:1},{x:299.10744222005206,y:274.14066569010413,step:1},{x:299.78774007161456,y:269.9817708333333,step:1},{x:301.52604166666663,y:259.69205729166663,step:0},{x:306.62957763671875,y:259.69205729166663,step:0},{x:301.791015625,y:288,step:0},{x:296.15887451171875,y:288,step:0},{x:292.60546875,y:276.70182291666663,step:0},{x:291.47137451171875,y:272.837890625,step:1},{x:290.791015625,y:270.27604166666663,step:1},{x:290.1106974283854,y:266.83203125,step:1},{x:289.99737548828125,y:266.83203125,step:0},{x:289.73305257161456,y:269.6041259765625,step:1},{x:289.12760416666663,y:273.59375,step:1},{x:288.3724161783854,y:278.0885823567708,step:1},{x:286.67057291666663,y:288,step:0},{x:281.60611979166663,y:288,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:318.19596354166663,y:288.4622395833333,step:2},{x:311.58074951171875,y:288.4622395833333,step:1},{x:307.8763020833333,y:283.25394694010413,step:1},{x:307.8763020833333,y:276.66015625,step:1},{x:307.8763020833333,y:271.5364583333333,step:1},{x:309.57682291666663,y:266.4544270833333,step:1},{x:312.56378173828125,y:263.26236979166663,step:1},{x:314.9446614583333,y:260.7421875,step:1},{x:318.19596354166663,y:259.2298177083333,step:1},{x:321.86195882161456,y:259.2298177083333,step:1},{x:328.5911458333333,y:259.2298177083333,step:1},{x:332.14322916666663,y:264.27018229166663,step:1},{x:332.14322916666663,y:271.0325520833333,step:1},{x:332.14322916666663,y:276.1979573567708,step:1},{x:330.51822916666663,y:281.2369384765625,step:1},{x:327.60805257161456,y:284.3880208333333,step:1},{x:325.2265421549479,y:286.9505615234375,step:1},{x:322.0136515299479,y:288.4622395833333,step:1},{x:318.23307291666663,y:288.4622395833333,step:1},{x:318.19596354166663,y:288.4622395833333,step:0},{x:318.9895833333333,y:283.42191569010413,step:2},{x:320.6145833333333,y:283.42191569010413,step:1},{x:322.08854166666663,y:282.66666666666663,step:1},{x:323.26041666666663,y:281.3645833333333,step:1},{x:325.26430257161456,y:279.13798014322913,step:1},{x:326.3606974283854,y:274.4765218098958,step:1},{x:326.3606974283854,y:271.2005208333333,step:1},{x:326.3606974283854,y:267.6718343098958,step:1},{x:325.2265421549479,y:264.27018229166663,step:1},{x:321.2200520833333,y:264.27018229166663,step:1},{x:319.51822916666663,y:264.27018229166663,step:1},{x:318.00649007161456,y:265.06766764322913,step:1},{x:316.83465576171875,y:266.412109375,step:1},{x:314.79361979166663,y:268.6380208333333,step:1},{x:313.65948486328125,y:273.0481770833333,step:1},{x:313.65948486328125,y:276.4505208333333,step:1},{x:313.65948486328125,y:280.44010416666663,step:1},{x:315.28515625,y:283.42191569010413,step:1},{x:318.95182291666663,y:283.42191569010413,step:1},{x:318.9895833333333,y:283.42191569010413,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:340.64906819661456,y:264.98368326822913,step:2},{x:333.92055257161456,y:264.98368326822913,step:0},{x:334.865234375,y:259.69205729166663,step:0},{x:353.8033447265625,y:259.69205729166663,step:0},{x:352.8958740234375,y:264.98368326822913,step:0},{x:346.091796875,y:264.98368326822913,step:0},{x:342.16080729166663,y:288,step:0},{x:336.71744791666663,y:288,step:0},{x:340.64906819661456,y:264.98368326822913,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:366.0124104817708,y:280.64969889322913,step:2},{x:363.02604166666663,y:288,step:0},{x:357.2044270833333,y:288,step:0},{x:369.640625,y:259.69205729166663,step:0},{x:376.6341145833333,y:259.69205729166663,step:0},{x:379.58203125,y:288,step:0},{x:373.8743489583333,y:288,step:0},{x:373.3450520833333,y:280.64969889322913,step:0},{x:366.0124104817708,y:280.64969889322913,step:0},{x:373.11844889322913,y:276.0299886067708,step:2},{x:372.626953125,y:269.94010416666663,step:0},{x:372.513671875,y:268.38602701822913,step:1},{x:372.400390625,y:266.1184895833333,step:1},{x:372.2864583333333,y:264.3958333333333,step:1},{x:372.1731770833333,y:264.3958333333333,step:0},{x:371.5305989583333,y:266.1184895833333,step:1},{x:370.81254069010413,y:268.3020833333333,step:1},{x:370.1321614583333,y:269.94010416666663,step:1},{x:367.63736979166663,y:276.0299886067708,step:0},{x:373.11844889322913,y:276.0299886067708,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:387.06640625,y:260.1966552734375,step:2},{x:388.7292073567708,y:259.7337239583333,step:1},{x:391.2624104817708,y:259.4818115234375,step:1},{x:393.71940104166663,y:259.4818115234375,step:1},{x:396.0247395833333,y:259.4818115234375,step:1},{x:398.63346354166663,y:259.90234375,step:1},{x:400.4856770833333,y:261.3723958333333,step:1},{x:402.22391764322913,y:262.6321614583333,step:1},{x:403.2447509765625,y:264.6477864583333,step:1},{x:403.2447509765625,y:267.37760416666663,step:1},{x:403.2447509765625,y:270.94791666666663,step:1},{x:401.77079264322913,y:273.6783447265625,step:1},{x:399.8052978515625,y:275.35807291666663,step:1},{x:397.7259114583333,y:277.1640625,step:1},{x:394.7395833333333,y:278.00394694010413,step:1},{x:391.6399739583333,y:278.00394694010413,step:1},{x:390.73307291666663,y:278.00394694010413,step:1},{x:389.9771728515625,y:277.87760416666663,step:1},{x:389.41015625,y:277.8359375,step:1},{x:387.6712239583333,y:288,step:0},{x:382.3411458333333,y:288,step:0},{x:387.06640625,y:260.1966552734375,step:0},{x:390.2415364583333,y:272.8802490234375,step:2},{x:390.80863444010413,y:273.0058186848958,step:1},{x:391.4134114583333,y:273.0898030598958,step:1},{x:392.35807291666663,y:273.0898030598958,step:1},{x:395.609375,y:273.0898030598958,step:1},{x:397.763671875,y:270.7382405598958,step:1},{x:397.763671875,y:267.92447916666663,step:1},{x:397.763671875,y:265.19401041666663,step:1},{x:395.98697916666663,y:264.3118489583333,step:1},{x:393.908203125,y:264.3118489583333,step:1},{x:392.8880615234375,y:264.3118489583333,step:1},{x:392.13151041666663,y:264.3958333333333,step:1},{x:391.67838541666663,y:264.4798177083333,step:1},{x:390.2415364583333,y:272.8802490234375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:408.3847249348958,y:260.1966552734375,step:2},{x:410.0481770833333,y:259.7337239583333,step:1},{x:412.58072916666663,y:259.4818115234375,step:1},{x:415.0378011067708,y:259.4818115234375,step:1},{x:417.3437093098958,y:259.4818115234375,step:1},{x:419.9517822265625,y:259.90234375,step:1},{x:421.8033447265625,y:261.3723958333333,step:1},{x:423.5417073567708,y:262.6321614583333,step:1},{x:424.5638020833333,y:264.6477864583333,step:1},{x:424.5638020833333,y:267.37760416666663,step:1},{x:424.5638020833333,y:270.94791666666663,step:1},{x:423.08854166666663,y:273.6783447265625,step:1},{x:421.12369791666663,y:275.35807291666663,step:1},{x:419.0442708333333,y:277.1640625,step:1},{x:416.05729166666663,y:278.00394694010413,step:1},{x:412.9583740234375,y:278.00394694010413,step:1},{x:412.0520833333333,y:278.00394694010413,step:1},{x:411.2956136067708,y:277.87760416666663,step:1},{x:410.7292073567708,y:277.8359375,step:1},{x:408.9896240234375,y:288,step:0},{x:403.66019694010413,y:288,step:0},{x:408.3847249348958,y:260.1966552734375,step:0},{x:411.5598958333333,y:272.8802490234375,step:2},{x:412.12760416666663,y:273.0058186848958,step:1},{x:412.7317708333333,y:273.0898030598958,step:1},{x:413.67704264322913,y:273.0898030598958,step:1},{x:416.9270833333333,y:273.0898030598958,step:1},{x:419.08203125,y:270.7382405598958,step:1},{x:419.08203125,y:267.92447916666663,step:1},{x:419.08203125,y:265.19401041666663,step:1},{x:417.3059895833333,y:264.3118489583333,step:1},{x:415.2265625,y:264.3118489583333,step:1},{x:414.20572916666663,y:264.3118489583333,step:1},{x:413.45048014322913,y:264.3958333333333,step:1},{x:412.9974365234375,y:264.4798177083333,step:1},{x:411.5598958333333,y:272.8802490234375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:429.77860514322913,y:260.1966552734375,step:2},{x:431.4792073567708,y:259.7337239583333,step:1},{x:434.0494384765625,y:259.4818115234375,step:1},{x:436.58329264322913,y:259.4818115234375,step:1},{x:439.00260416666663,y:259.4818115234375,step:1},{x:441.4973958333333,y:259.8606770833333,step:1},{x:443.2734375,y:261.11979166666663,step:1},{x:444.9362386067708,y:262.2122395833333,step:1},{x:446.10807291666663,y:263.9759114583333,step:1},{x:446.10807291666663,y:266.6223958333333,step:1},{x:446.10807291666663,y:270.82230631510413,step:1},{x:443.6145833333333,y:273.46879069010413,step:1},{x:440.3255208333333,y:274.64322916666663,step:1},{x:440.3255208333333,y:274.7708333333333,step:0},{x:441.83719889322913,y:275.5260823567708,step:1},{x:442.5181884765625,y:277.37369791666663,step:1},{x:442.7447509765625,y:279.93619791666663,step:1},{x:443.08463541666663,y:283.12760416666663,step:1},{x:443.2734375,y:286.82425944010413,step:1},{x:443.7265625,y:288,step:1},{x:438.1328125,y:288,step:0},{x:437.90625,y:287.24479166666663,step:1},{x:437.640625,y:284.8073323567708,step:1},{x:437.4140625,y:281.3229573567708,step:1},{x:437.1497395833333,y:277.87760416666663,step:1},{x:436.0911458333333,y:276.82816569010413,step:1},{x:433.9374593098958,y:276.82816569010413,step:1},{x:432.27347819010413,y:276.82816569010413,step:0},{x:430.3841145833333,y:288,step:0},{x:425.01566569010413,y:288,step:0},{x:429.77860514322913,y:260.1966552734375,step:0},{x:433.1054280598958,y:272.2916259765625,step:2},{x:435.3359375,y:272.2916259765625,step:0},{x:438.2838948567708,y:272.2916259765625,step:1},{x:440.43876139322913,y:270.31766764322913,step:1},{x:440.43876139322913,y:267.54557291666663,step:1},{x:440.43876139322913,y:265.2362874348958,step:1},{x:438.73697916666663,y:264.2279052734375,step:1},{x:436.5442708333333,y:264.2279052734375,step:1},{x:435.5247395833333,y:264.2279052734375,step:1},{x:434.88151041666663,y:264.3118489583333,step:1},{x:434.42838541666663,y:264.4381103515625,step:1},{x:433.1054280598958,y:272.2916259765625,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:458.43094889322913,y:288.4622395833333,step:2},{x:451.81510416666663,y:288.4622395833333,step:1},{x:448.1119384765625,y:283.25394694010413,step:1},{x:448.1119384765625,y:276.66015625,step:1},{x:448.1119384765625,y:271.5364583333333,step:1},{x:449.8125,y:266.4544270833333,step:1},{x:452.79947916666663,y:263.26236979166663,step:1},{x:455.1796468098958,y:260.7421875,step:1},{x:458.43094889322913,y:259.2298177083333,step:1},{x:462.09765625,y:259.2298177083333,step:1},{x:468.8255208333333,y:259.2298177083333,step:1},{x:472.3802083333333,y:264.27018229166663,step:1},{x:472.3802083333333,y:271.0325520833333,step:1},{x:472.3802083333333,y:276.1979573567708,step:1},{x:470.75390625,y:281.2369384765625,step:1},{x:467.8437093098958,y:284.3880208333333,step:1},{x:465.4622802734375,y:286.9505615234375,step:1},{x:462.24869791666663,y:288.4622395833333,step:1},{x:458.4687093098958,y:288.4622395833333,step:1},{x:458.43094889322913,y:288.4622395833333,step:0},{x:459.22391764322913,y:283.42191569010413,step:2},{x:460.85026041666663,y:283.42191569010413,step:1},{x:462.32421875,y:282.66666666666663,step:1},{x:463.49609375,y:281.3645833333333,step:1},{x:465.5,y:279.13798014322913,step:1},{x:466.59635416666663,y:274.4765218098958,step:1},{x:466.59635416666663,y:271.2005208333333,step:1},{x:466.59635416666663,y:267.6718343098958,step:1},{x:465.4622802734375,y:264.27018229166663,step:1},{x:461.45572916666663,y:264.27018229166663,step:1},{x:459.75390625,y:264.27018229166663,step:1},{x:458.2421875,y:265.06766764322913,step:1},{x:457.0703125,y:266.412109375,step:1},{x:455.0286865234375,y:268.6380208333333,step:1},{x:453.8958333333333,y:273.0481770833333,step:1},{x:453.8958333333333,y:276.4505208333333,step:1},{x:453.8958333333333,y:280.44010416666663,step:1},{x:455.5208740234375,y:283.42191569010413,step:1},{x:459.1875,y:283.42191569010413,step:1},{x:459.22391764322913,y:283.42191569010413,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:478.8046875,y:288,step:2},{x:475.6302490234375,y:259.69205729166663,step:0},{x:481.2630208333333,y:259.69205729166663,step:0},{x:482.3958740234375,y:273.1737874348958,step:0},{x:482.6614583333333,y:276.1979573567708,step:1},{x:482.8489990234375,y:278.9284261067708,step:1},{x:483.0013020833333,y:281.8684895833333,step:1},{x:483.07682291666663,y:281.8684895833333,step:0},{x:484.0208740234375,y:279.09635416666663,step:1},{x:485.23173014322913,y:276.07291666666663,step:1},{x:486.47916666666663,y:273.13151041666663,step:1},{x:492.1862386067708,y:259.69205729166663,step:0},{x:498.27213541666663,y:259.69205729166663,step:0},{x:485.1171468098958,y:288,step:0},{x:478.8046875,y:288,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:512.9766031901041,y:275.9466145833333,step:2},{x:503.94266764322913,y:275.9466145833333,step:0},{x:502.7708333333333,y:282.8333333333333,step:0},{x:512.9388020833333,y:282.8333333333333,step:0},{x:512.0690104166666,y:288,step:0},{x:496.4192708333333,y:288,step:0},{x:501.2578125,y:259.69205729166663,step:0},{x:516.3411458333333,y:259.69205729166663,step:0},{x:515.4323323567708,y:264.85807291666663,step:0},{x:505.83203125,y:264.85807291666663,step:0},{x:504.7734375,y:270.8646240234375,step:0},{x:513.8828125,y:270.8646240234375,step:0},{x:512.9766031901041,y:275.9466145833333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:520.7252604166666,y:260.1119384765625,step:2},{x:522.9166259765625,y:259.69205729166663,step:1},{x:525.2994791666666,y:259.4818115234375,step:1},{x:527.7942708333333,y:259.4818115234375,step:1},{x:531.7630208333333,y:259.4818115234375,step:1},{x:534.8997395833333,y:260.4901936848958,step:1},{x:537.0547281901041,y:262.5482177734375,step:1},{x:539.1340738932291,y:264.3958333333333,step:1},{x:540.4192708333333,y:267.20963541666663,step:1},{x:540.4192708333333,y:271.4101155598958,step:1},{x:540.4192708333333,y:276.86979166666663,step:1},{x:538.33984375,y:281.61588541666663,step:1},{x:535.203125,y:284.4296875,step:1},{x:532.25390625,y:287.0755208333333,step:1},{x:528.5116780598958,y:288.20963541666663,step:1},{x:522.9935302734375,y:288.20963541666663,step:1},{x:519.9309895833333,y:288.20963541666663,step:1},{x:517.2851155598958,y:287.91666666666663,step:1},{x:516,y:287.6223958333333,step:1},{x:520.7252604166666,y:260.1119384765625,step:0},{x:522.2747802734375,y:283.1692708333333,step:2},{x:522.9166259765625,y:283.25394694010413,step:1},{x:523.7109375,y:283.29557291666663,step:1},{x:524.65625,y:283.29557291666663,step:1},{x:527.6041666666666,y:283.29557291666663,step:1},{x:530.2135416666666,y:282.11979166666663,step:1},{x:531.8763020833333,y:280.0208333333333,step:1},{x:533.6145833333333,y:277.7942708333333,step:1},{x:534.5221354166666,y:274.85416666666663,step:1},{x:534.5221354166666,y:271.45182291666663,step:1},{x:534.5221354166666,y:266.95829264322913,step:1},{x:532.2917073567708,y:264.3118489583333,step:1},{x:527.7942708333333,y:264.3118489583333,step:1},{x:526.8489990234375,y:264.3118489583333,step:1},{x:526.0547281901041,y:264.3958333333333,step:1},{x:525.4870198567708,y:264.52213541666663,step:1},{x:522.2747802734375,y:283.1692708333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],_h=[{type:"path",stampPoints:[{x:420.5598958333333,y:265.5247395833333,step:2},{x:416.81119791666663,y:261.8561604817708,step:0},{x:409.3333333333333,y:269.3333333333333,step:0},{x:401.9127197265625,y:261.912109375,step:0},{x:398.3177490234375,y:265.50846354166663,step:0},{x:405.7382405598958,y:272.9290364583333,step:0},{x:398.3151448567708,y:280.3515218098958,step:0},{x:402.0638020833333,y:284.01822916666663,step:0},{x:409.48832194010413,y:276.5989583333333,step:0},{x:416.95703125,y:284.06766764322913,step:0},{x:420.5520833333333,y:280.4713134765625,step:0},{x:413.08203125,y:273.0032552083333,step:0},{x:420.5598958333333,y:265.5247395833333,step:0,close:!0}],borderWidth:0,borderColor:"rgba(0,0,0,1)",background:"linear-gradient(to right bottom, #f89077, #b21f10)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:420.5598958333333,y:265.5247395833333,step:2},{x:416.81119791666663,y:261.8561604817708,step:0},{x:409.3333333333333,y:269.3333333333333,step:0},{x:401.9127197265625,y:261.912109375,step:0},{x:398.3177490234375,y:265.50846354166663,step:0},{x:405.7382405598958,y:272.9290364583333,step:0},{x:398.3151448567708,y:280.3515218098958,step:0},{x:402.0638020833333,y:284.01822916666663,step:0},{x:409.48832194010413,y:276.5989583333333,step:0},{x:416.95703125,y:284.06766764322913,step:0},{x:420.5520833333333,y:280.4713134765625,step:0},{x:413.08203125,y:273.0032552083333,step:0},{x:420.5598958333333,y:265.5247395833333,step:0,close:!0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Wh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(110,0,5,1)",background:"linear-gradient(to right bottom, #f89077, #cc4a31)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:397.2669270833333,y:276.1119384765625,step:2},{x:397.8430989583333,y:276.4791259765625,step:1},{x:398.64908854166663,y:276.78385416666663,step:1},{x:399.556640625,y:276.78385416666663,step:1},{x:400.3483479817708,y:276.78385416666663,step:1},{x:401.08268229166663,y:276.3671875,step:1},{x:401.08268229166663,y:275.5364583333333,step:1},{x:401.08268229166663,y:274.9114583333333,step:1},{x:400.6653645833333,y:274.5286458333333,step:1},{x:399.77274576822913,y:274,step:1},{x:398.75,y:273.3919270833333,step:1},{x:397.77079264322913,y:272.5598958333333,step:1},{x:397.77079264322913,y:271.16796875,step:1},{x:397.77079264322913,y:268.9921875,step:1},{x:399.4700520833333,y:267.6640625,step:1},{x:401.5865478515625,y:267.6640625,step:1},{x:402.75321451822913,y:267.6640625,step:1},{x:403.44462076822913,y:267.95182291666663,step:1},{x:403.86258951822913,y:268.1920979817708,step:1},{x:403.2141927083333,y:270.111328125,step:0},{x:402.8977864583333,y:269.919921875,step:1},{x:402.220703125,y:269.6314697265625,step:1},{x:401.4140625,y:269.6477864583333,step:1},{x:400.4491780598958,y:269.6477864583333,step:1},{x:399.9452718098958,y:270.17582194010413,step:1},{x:399.9452718098958,y:270.767578125,step:1},{x:399.9452718098958,y:271.3919270833333,step:1},{x:400.53580729166663,y:271.775390625,step:1},{x:401.35611979166663,y:272.28776041666663,step:1},{x:402.53776041666663,y:272.9759114583333,step:1},{x:403.2720947265625,y:273.83984375,step:1},{x:403.2720947265625,y:275.13541666666663,step:1},{x:403.2720947265625,y:277.5364583333333,step:1},{x:401.48636881510413,y:278.7682698567708,step:1},{x:399.34049479166663,y:278.7682698567708,step:1},{x:398.0013020833333,y:278.75260416666663,step:1},{x:397.0221761067708,y:278.3671875,step:1},{x:396.5755208333333,y:278,step:1},{x:397.2669270833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:408.052734375,y:267.82421875,step:2},{x:406.20963541666663,y:278.6067708333333,step:0},{x:404.1361083984375,y:278.6067708333333,step:0},{x:405.97916666666663,y:267.82421875,step:0},{x:408.052734375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:416.1302083333333,y:278.1119384765625,step:2},{x:415.3958740234375,y:278.3827718098958,step:1},{x:414.2161458333333,y:278.71879069010413,step:1},{x:412.9921875,y:278.71879069010413,step:1},{x:411.66666666666663,y:278.71879069010413,step:1},{x:410.5572509765625,y:278.3358968098958,step:1},{x:409.765625,y:277.5364583333333,step:1},{x:408.98832194010413,y:276.78385416666663,step:1},{x:408.5423177083333,y:275.5833333333333,step:1},{x:408.5423177083333,y:274.2083333333333,step:1},{x:408.5423177083333,y:272.1920979817708,step:1},{x:409.27665201822913,y:270.44791666666663,step:1},{x:410.515625,y:269.279296875,step:1},{x:411.609375,y:268.2714436848958,step:1},{x:413.12109375,y:267.7115478515625,step:1},{x:414.8059895833333,y:267.7115478515625,step:1},{x:416.05859375,y:267.7115478515625,step:1},{x:416.9948323567708,y:267.98368326822913,step:1},{x:417.3697509765625,y:268.1920979817708,step:1},{x:416.75,y:270.1438802083333,step:0},{x:416.3177490234375,y:269.919921875,step:1},{x:415.55472819010413,y:269.69596354166663,step:1},{x:414.69010416666663,y:269.69596354166663,step:1},{x:413.7265625,y:269.69596354166663,step:1},{x:412.8763020833333,y:270,step:1},{x:412.2292073567708,y:270.5598958333333,step:1},{x:411.37890625,y:271.29557291666663,step:1},{x:410.8177490234375,y:272.57621256510413,step:1},{x:410.8177490234375,y:274.04691569010413,step:1},{x:410.8177490234375,y:275.8567708333333,step:1},{x:411.7812093098958,y:276.7682698567708,step:1},{x:413.3072509765625,y:276.7682698567708,step:1},{x:413.796875,y:276.7682698567708,step:1},{x:414.12894694010413,y:276.6875,step:1},{x:414.37504069010413,y:276.5755208333333,step:1},{x:414.7630615234375,y:274.3046468098958,step:0},{x:413.2499593098958,y:274.3046468098958,step:0},{x:413.58203125,y:272.46354166666663,step:0},{x:417.109375,y:272.46354166666663,step:0},{x:416.1302083333333,y:278.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:417.81510416666663,y:278.6067708333333,step:2},{x:419.65885416666663,y:267.82421875,step:0},{x:422.09244791666663,y:267.82421875,step:0},{x:423.37504069010413,y:271.935546875,step:0},{x:423.7630208333333,y:273.3118489583333,step:1},{x:424.0221761067708,y:274.4322509765625,step:1},{x:424.25260416666663,y:275.6145833333333,step:1},{x:424.2956136067708,y:275.6145833333333,step:0},{x:424.3385009765625,y:274.51298014322913,step:1},{x:424.4817708333333,y:273.32816569010413,step:1},{x:424.7421875,y:271.744140625,step:1},{x:425.4036458333333,y:267.82421875,step:0},{x:427.3489990234375,y:267.82421875,step:0},{x:425.50516764322913,y:278.6067708333333,step:0},{x:423.359375,y:278.6067708333333,step:0},{x:422.00516764322913,y:274.3046468098958,step:0},{x:421.5729573567708,y:272.83203125,step:1},{x:421.31510416666663,y:271.8561604817708,step:1},{x:421.05472819010413,y:270.5435791015625,step:1},{x:421.0130208333333,y:270.5435791015625,step:0},{x:420.91141764322913,y:271.599609375,step:1},{x:420.6809895833333,y:273.11979166666663,step:1},{x:420.39322916666663,y:274.83203125,step:1},{x:419.7447509765625,y:278.6067708333333,step:0},{x:417.81510416666663,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:433.97135416666663,y:267.82421875,step:2},{x:433.25260416666663,y:272.0163167317708,step:0},{x:436.76566569010413,y:272.0163167317708,step:0},{x:437.48441569010413,y:267.82421875,step:0},{x:439.5729573567708,y:267.82421875,step:0},{x:437.7292073567708,y:278.6067708333333,step:0},{x:435.65629069010413,y:278.6067708333333,step:0},{x:436.4192708333333,y:274.0638020833333,step:0},{x:432.8905843098958,y:274.0638020833333,step:0},{x:432.12760416666663,y:278.6067708333333,step:0},{x:430.05472819010413,y:278.6067708333333,step:0},{x:431.8983968098958,y:267.82421875,step:0},{x:433.97135416666663,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:445.9530843098958,y:274.015625,step:2},{x:442.5103759765625,y:274.015625,step:0},{x:442.06510416666663,y:276.640625,step:0},{x:445.9374593098958,y:276.640625,step:0},{x:445.6068115234375,y:278.6067708333333,step:0},{x:439.6458740234375,y:278.6067708333333,step:0},{x:441.48832194010413,y:267.82421875,step:0},{x:447.234375,y:267.82421875,step:0},{x:446.8880615234375,y:269.7916259765625,step:0},{x:443.23173014322913,y:269.7916259765625,step:0},{x:442.828125,y:272.08011881510413,step:0},{x:446.29691569010413,y:272.08011881510413,step:0},{x:445.9530843098958,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:448.9192708333333,y:268.0163167317708,step:2},{x:449.5677490234375,y:267.83984375,step:1},{x:450.546875,y:267.744140625,step:1},{x:451.51041666666663,y:267.744140625,step:1},{x:452.43229166666663,y:267.744140625,step:1},{x:453.3827718098958,y:267.8880615234375,step:1},{x:454.0598958333333,y:268.36783854166663,step:1},{x:454.6927083333333,y:268.78385416666663,step:1},{x:455.1405843098958,y:269.45572916666663,step:1},{x:455.1405843098958,y:270.46354166666663,step:1},{x:455.1405843098958,y:272.0638020833333,step:1},{x:454.1888427734375,y:273.07157389322913,step:1},{x:452.9375,y:273.5208333333333,step:1},{x:452.9375,y:273.5677083333333,step:0},{x:453.5130208333333,y:273.8567708333333,step:1},{x:453.77079264322913,y:274.5598958333333,step:1},{x:453.8580322265625,y:275.5364583333333,step:1},{x:453.98697916666663,y:276.75260416666663,step:1},{x:454.0598958333333,y:278.1588948567708,step:1},{x:454.2317708333333,y:278.6067708333333,step:1},{x:452.1015625,y:278.6067708333333,step:0},{x:452.01566569010413,y:278.3203125,step:1},{x:451.9140625,y:277.3919270833333,step:1},{x:451.828125,y:276.0638020833333,step:1},{x:451.7265625,y:274.75260416666663,step:1},{x:451.32291666666663,y:274.3515218098958,step:1},{x:450.50260416666663,y:274.3515218098958,step:1},{x:449.86979166666663,y:274.3515218098958,step:0},{x:449.1484375,y:278.6067708333333,step:0},{x:447.1041259765625,y:278.6067708333333,step:0},{x:448.9192708333333,y:268.0163167317708,step:0},{x:450.1862386067708,y:272.6236572265625,step:2},{x:451.0364583333333,y:272.6236572265625,step:0},{x:452.15885416666663,y:272.6236572265625,step:1},{x:452.9792073567708,y:271.87174479166663,step:1},{x:452.9792073567708,y:270.8157958984375,step:1},{x:452.9792073567708,y:269.935546875,step:1},{x:452.3307698567708,y:269.5521240234375,step:1},{x:451.4973958333333,y:269.5521240234375,step:1},{x:451.1067708333333,y:269.5521240234375,step:1},{x:450.8620198567708,y:269.583984375,step:1},{x:450.69010416666663,y:269.6314697265625,step:1},{x:450.1862386067708,y:272.6236572265625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:461.79166666666663,y:274.015625,step:2},{x:458.3515625,y:274.015625,step:0},{x:457.90360514322913,y:276.640625,step:0},{x:461.77860514322913,y:276.640625,step:0},{x:461.44657389322913,y:278.6067708333333,step:0},{x:455.48441569010413,y:278.6067708333333,step:0},{x:457.328125,y:267.82421875,step:0},{x:463.07291666666663,y:267.82421875,step:0},{x:462.7292073567708,y:269.7916259765625,step:0},{x:459.0703125,y:269.7916259765625,step:0},{x:458.66666666666663,y:272.08011881510413,step:0},{x:462.1380208333333,y:272.08011881510413,step:0},{x:461.79166666666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(110,0,5,1)",background:"rgba(0,0,0,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Fh=[{type:"path",stampPoints:[{x:465.87760416666663,y:290.62760416666663,step:2},{x:465.87760416666663,y:296.4948323567708,step:1},{x:461.0780843098958,y:301.2942708333333,step:1},{x:455.2109375,y:301.2942708333333,step:1},{x:363.1640625,y:301.2942708333333,step:0},{x:357.2974853515625,y:301.2942708333333,step:1},{x:352.4973958333333,y:296.4948323567708,step:1},{x:352.4973958333333,y:290.62760416666663,step:1},{x:352.4973958333333,y:253.63081868489581,step:0},{x:352.4973958333333,y:247.7642822265625,step:1},{x:357.2974853515625,y:242.96415201822916,step:1},{x:363.1640625,y:242.96415201822916,step:1},{x:455.2109375,y:242.96415201822916,step:0},{x:461.0780843098958,y:242.96415201822916,step:1},{x:465.87760416666663,y:247.7642822265625,step:1},{x:465.87760416666663,y:253.63081868489581,step:1},{x:465.87760416666663,y:290.62760416666663,step:0}],borderWidth:0,borderColor:"rgba(0,0,0,0.8509803921568627)",background:"linear-gradient(to right bottom, #f8eae7, #ffc6c6)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:10},{type:"path",stampPoints:[{x:465.87760416666663,y:290.62760416666663,step:2},{x:465.87760416666663,y:296.4948323567708,step:1},{x:461.0780843098958,y:301.2942708333333,step:1},{x:455.2109375,y:301.2942708333333,step:1},{x:363.1640625,y:301.2942708333333,step:0},{x:357.2974853515625,y:301.2942708333333,step:1},{x:352.4973958333333,y:296.4948323567708,step:1},{x:352.4973958333333,y:290.62760416666663,step:1},{x:352.4973958333333,y:253.63081868489581,step:0},{x:352.4973958333333,y:247.7642822265625,step:1},{x:357.2974853515625,y:242.96415201822916,step:1},{x:363.1640625,y:242.96415201822916,step:1},{x:455.2109375,y:242.96415201822916,step:0},{x:461.0780843098958,y:242.96415201822916,step:1},{x:465.87760416666663,y:247.7642822265625,step:1},{x:465.87760416666663,y:253.63081868489581,step:1},{x:465.87760416666663,y:290.62760416666663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(145,15,5,1)",background:null,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:371.2519124348958,y:286.9765625,step:2},{x:368.0761311848958,y:258.6692708333333,step:0},{x:373.708984375,y:258.6692708333333,step:0},{x:374.84183756510413,y:272.15043131510413,step:0},{x:375.1073811848958,y:275.17447916666663,step:1},{x:375.2962239583333,y:277.90360514322913,step:1},{x:375.447265625,y:280.8450520833333,step:1},{x:375.5228271484375,y:280.8450520833333,step:0},{x:376.46805826822913,y:278.07291666666663,step:1},{x:377.677734375,y:275.0494384765625,step:1},{x:378.923828125,y:272.1087239583333,step:1},{x:384.6321614583333,y:258.6692708333333,step:0},{x:390.71805826822913,y:258.6692708333333,step:0},{x:377.564453125,y:286.9765625,step:0},{x:371.2519124348958,y:286.9765625,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:399.7519124348958,y:287.4388427734375,step:2},{x:393.1373291015625,y:287.4388427734375,step:1},{x:389.4329427083333,y:282.2318115234375,step:1},{x:389.4329427083333,y:275.63798014322913,step:1},{x:389.4329427083333,y:270.51298014322913,step:1},{x:391.1347249348958,y:265.4309895833333,step:1},{x:394.1204427083333,y:262.2389729817708,step:1},{x:396.501953125,y:259.7193603515625,step:1},{x:399.7519124348958,y:258.20768229166663,step:1},{x:403.4185791015625,y:258.20768229166663,step:1},{x:410.14847819010413,y:258.20768229166663,step:1},{x:413.7005615234375,y:263.2473958333333,step:1},{x:413.7005615234375,y:270.0091552734375,step:1},{x:413.7005615234375,y:275.17447916666663,step:1},{x:412.0755208333333,y:280.2161865234375,step:1},{x:409.1634114583333,y:283.3645833333333,step:1},{x:406.7831624348958,y:285.9270833333333,step:1},{x:403.5697021484375,y:287.4388427734375,step:1},{x:399.791015625,y:287.4388427734375,step:1},{x:399.7519124348958,y:287.4388427734375,step:0},{x:400.5462239583333,y:282.3984375,step:2},{x:402.1712239583333,y:282.3984375,step:1},{x:403.646484375,y:281.64322916666663,step:1},{x:404.818359375,y:280.3411458333333,step:1},{x:406.8210042317708,y:278.1145833333333,step:1},{x:407.91727701822913,y:273.453125,step:1},{x:407.91727701822913,y:270.1771240234375,step:1},{x:407.91727701822913,y:266.64908854166663,step:1},{x:406.7831624348958,y:263.2473958333333,step:1},{x:402.7753499348958,y:263.2473958333333,step:1},{x:401.0761311848958,y:263.2473958333333,step:1},{x:399.5631917317708,y:264.044921875,step:1},{x:398.39127604166663,y:265.38871256510413,step:1},{x:396.3509114583333,y:267.6145833333333,step:1},{x:395.21683756510413,y:272.0247395833333,step:1},{x:395.21683756510413,y:275.4270833333333,step:1},{x:395.21683756510413,y:279.4167073567708,step:1},{x:396.84183756510413,y:282.3984375,step:1},{x:400.50846354166663,y:282.3984375,step:1},{x:400.5462239583333,y:282.3984375,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:425.1536458333333,y:258.6692708333333,step:2},{x:420.3151448567708,y:286.9765625,step:0},{x:414.8723958333333,y:286.9765625,step:0},{x:419.7109375,y:258.6692708333333,step:0},{x:425.1536458333333,y:258.6692708333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:430.10416666666663,y:259.0892333984375,step:2},{x:432.29691569010413,y:258.6692708333333,step:1},{x:434.6796875,y:258.458984375,step:1},{x:437.1744384765625,y:258.458984375,step:1},{x:441.1431884765625,y:258.458984375,step:1},{x:444.2786458333333,y:259.46683756510413,step:1},{x:446.43485514322913,y:261.5247395833333,step:1},{x:448.51298014322913,y:263.373046875,step:1},{x:449.79947916666663,y:266.1868896484375,step:1},{x:449.79947916666663,y:270.38736979166663,step:1},{x:449.79947916666663,y:275.8463134765625,step:1},{x:447.71875,y:280.59375,step:1},{x:444.58072916666663,y:283.40625,step:1},{x:441.6328125,y:286.0521240234375,step:1},{x:437.8905843098958,y:287.1874593098958,step:1},{x:432.3724365234375,y:287.1874593098958,step:1},{x:429.3098958333333,y:287.1874593098958,step:1},{x:426.6640625,y:286.89322916666663,step:1},{x:425.3802083333333,y:286.5989583333333,step:1},{x:430.10416666666663,y:259.0892333984375,step:0},{x:431.6536865234375,y:282.1458333333333,step:2},{x:432.29691569010413,y:282.2318115234375,step:1},{x:433.0911458333333,y:282.2734375,step:1},{x:434.03641764322913,y:282.2734375,step:1},{x:436.98441569010413,y:282.2734375,step:1},{x:439.59375,y:281.09635416666663,step:1},{x:441.2552083333333,y:278.9973958333333,step:1},{x:442.9948323567708,y:276.7708333333333,step:1},{x:443.90104166666663,y:273.83072916666663,step:1},{x:443.90104166666663,y:270.42899576822913,step:1},{x:443.90104166666663,y:265.9348958333333,step:1},{x:441.6718343098958,y:263.28971354166663,step:1},{x:437.1744384765625,y:263.28971354166663,step:1},{x:436.2292073567708,y:263.28971354166663,step:1},{x:435.4348958333333,y:263.373046875,step:1},{x:434.8671875,y:263.4993489583333,step:1},{x:431.6536865234375,y:282.1458333333333,step:0}],borderWidth:0,borderColor:"rgba(145,15,5,1)",background:"rgba(145,15,5,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}],Hh=[{type:"path",stampPoints:[{x:347.4140625,y:272.89908854166663,step:2},{x:369.1386311848958,y:288.7083333333333,step:0},{x:463.5677490234375,y:288.7083333333333,step:0},{x:468.39322916666663,y:288.7083333333333,step:1},{x:472.33984375,y:285.10941569010413,step:1},{x:472.33984375,y:280.7083333333333,step:1},{x:472.33984375,y:264.2591145833333,step:0},{x:472.33984375,y:259.8587239583333,step:1},{x:468.39322916666663,y:256.2591145833333,step:1},{x:463.5677490234375,y:256.2591145833333,step:1},{x:369.1386311848958,y:256.2591145833333,step:0},{x:347.4140625,y:272.89908854166663,step:0}],borderWidth:1.3333333333333333,borderColor:"rgba(213,177,66,1)",background:"linear-gradient(to right bottom, #f7fc93, #f8fb4f)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:409.1328125,y:278.6067708333333,step:2},{x:408.75846354166663,y:267.82421875,step:0},{x:410.8606770833333,y:267.82421875,step:0},{x:410.8606770833333,y:272.6236572265625,step:0},{x:410.8606770833333,y:273.9348958333333,step:1},{x:410.83203125,y:275.1510009765625,step:1},{x:410.80338541666663,y:276.12760416666663,step:1},{x:410.83203125,y:276.12760416666663,step:0},{x:411.17704264322913,y:275.07157389322913,step:1},{x:411.52347819010413,y:273.9674886067708,step:1},{x:411.96875,y:272.6555989583333,step:1},{x:413.7109375,y:267.82421875,step:0},{x:415.98697916666663,y:267.82421875,step:0},{x:415.9583333333333,y:272.6399739583333,step:0},{x:415.9439697265625,y:273.9348958333333,step:1},{x:415.9140625,y:275.0078125,step:1},{x:415.8567708333333,y:276.0638020833333,step:1},{x:415.88541666666663,y:276.0638020833333,step:0},{x:416.21744791666663,y:274.9427083333333,step:1},{x:416.5780843098958,y:273.7916259765625,step:1},{x:416.9661458333333,y:272.6236572265625,step:1},{x:418.6366780598958,y:267.82421875,step:0},{x:420.8255208333333,y:267.82421875,step:0},{x:416.54947916666663,y:278.6067708333333,step:0},{x:414.28910319010413,y:278.6067708333333,step:0},{x:414.23050944010413,y:274.1927490234375,step:0},{x:414.2161458333333,y:272.912109375,step:1},{x:414.2447509765625,y:271.82421875,step:1},{x:414.3020833333333,y:270.607421875,step:1},{x:414.27347819010413,y:270.607421875,step:0},{x:413.9270833333333,y:271.759765625,step:1},{x:413.58203125,y:272.927734375,step:1},{x:413.1067708333333,y:274.2396240234375,step:1},{x:411.4375,y:278.6067708333333,step:0},{x:409.1328125,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:424.0234375,y:267.82421875,step:2},{x:422.1796875,y:278.6067708333333,step:0},{x:420.10546875,y:278.6067708333333,step:0},{x:421.9478759765625,y:267.82421875,step:0},{x:424.0234375,y:267.82421875,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:427.3489990234375,y:269.83984375,step:2},{x:424.7851155598958,y:269.83984375,step:0},{x:425.1458333333333,y:267.82421875,step:0},{x:432.359375,y:267.82421875,step:0},{x:432.01432291666663,y:269.83984375,step:0},{x:429.421875,y:269.83984375,step:0},{x:427.92447916666663,y:278.6067708333333,step:0},{x:425.8515218098958,y:278.6067708333333,step:0},{x:427.3489990234375,y:269.83984375,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:431.6823323567708,y:278.6067708333333,step:2},{x:433.52604166666663,y:267.82421875,step:0},{x:435.95963541666663,y:267.82421875,step:0},{x:437.2421875,y:271.935546875,step:0},{x:437.6302490234375,y:273.3118489583333,step:1},{x:437.88932291666663,y:274.4322509765625,step:1},{x:438.1197509765625,y:275.6145833333333,step:1},{x:438.16276041666663,y:275.6145833333333,step:0},{x:438.20572916666663,y:274.51298014322913,step:1},{x:438.3503011067708,y:273.32816569010413,step:1},{x:438.6093343098958,y:271.744140625,step:1},{x:439.27079264322913,y:267.82421875,step:0},{x:441.2161458333333,y:267.82421875,step:0},{x:439.3723958333333,y:278.6067708333333,step:0},{x:437.2265625,y:278.6067708333333,step:0},{x:435.8723958333333,y:274.3046468098958,step:0},{x:435.44010416666663,y:272.83203125,step:1},{x:435.18229166666663,y:271.8561604817708,step:1},{x:434.921875,y:270.5435791015625,step:1},{x:434.8802083333333,y:270.5435791015625,step:0},{x:434.77860514322913,y:271.599609375,step:1},{x:434.5481770833333,y:273.11979166666663,step:1},{x:434.26041666666663,y:274.83203125,step:1},{x:433.61197916666663,y:278.6067708333333,step:0},{x:431.6823323567708,y:278.6067708333333,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:447.58072916666663,y:274.015625,step:2},{x:444.1380208333333,y:274.015625,step:0},{x:443.6927083333333,y:276.640625,step:0},{x:447.56510416666663,y:276.640625,step:0},{x:447.234375,y:278.6067708333333,step:0},{x:441.2734375,y:278.6067708333333,step:0},{x:443.1171468098958,y:267.82421875,step:0},{x:448.8620198567708,y:267.82421875,step:0},{x:448.515625,y:269.7916259765625,step:0},{x:444.859375,y:269.7916259765625,step:0},{x:444.45572916666663,y:272.08011881510413,step:0},{x:447.92578125,y:272.08011881510413,step:0},{x:447.58072916666663,y:274.015625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:449.1497395833333,y:276.1119384765625,step:2},{x:449.7265625,y:276.4791259765625,step:1},{x:450.5312093098958,y:276.78385416666663,step:1},{x:451.44010416666663,y:276.78385416666663,step:1},{x:452.2317708333333,y:276.78385416666663,step:1},{x:452.9661458333333,y:276.3671875,step:1},{x:452.9661458333333,y:275.5364583333333,step:1},{x:452.9661458333333,y:274.9114583333333,step:1},{x:452.546875,y:274.5286458333333,step:1},{x:451.65629069010413,y:274,step:1},{x:450.6328125,y:273.3919270833333,step:1},{x:449.6536865234375,y:272.5598958333333,step:1},{x:449.6536865234375,y:271.16796875,step:1},{x:449.6536865234375,y:268.9921875,step:1},{x:451.3529052734375,y:267.6640625,step:1},{x:453.46875,y:267.6640625,step:1},{x:454.63541666666663,y:267.6640625,step:1},{x:455.328125,y:267.95182291666663,step:1},{x:455.7447509765625,y:268.1920979817708,step:1},{x:455.09635416666663,y:270.111328125,step:0},{x:454.7812093098958,y:269.919921875,step:1},{x:454.10416666666663,y:269.6314697265625,step:1},{x:453.29691569010413,y:269.6477864583333,step:1},{x:452.33207194010413,y:269.6477864583333,step:1},{x:451.828125,y:270.17582194010413,step:1},{x:451.828125,y:270.767578125,step:1},{x:451.828125,y:271.3919270833333,step:1},{x:452.4192708333333,y:271.775390625,step:1},{x:453.2395833333333,y:272.28776041666663,step:1},{x:454.4192708333333,y:272.9759114583333,step:1},{x:455.1536458333333,y:273.83984375,step:1},{x:455.1536458333333,y:275.13541666666663,step:1},{x:455.1536458333333,y:277.5364583333333,step:1},{x:453.3697509765625,y:278.7682698567708,step:1},{x:451.22391764322913,y:278.7682698567708,step:1},{x:449.8841145833333,y:278.75260416666663,step:1},{x:448.90494791666663,y:278.3671875,step:1},{x:448.4583333333333,y:278,step:1},{x:449.1497395833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4},{type:"path",stampPoints:[{x:456.4934895833333,y:276.1119384765625,step:2},{x:457.0703125,y:276.4791259765625,step:1},{x:457.87504069010413,y:276.78385416666663,step:1},{x:458.7838134765625,y:276.78385416666663,step:1},{x:459.5755208333333,y:276.78385416666663,step:1},{x:460.3099365234375,y:276.3671875,step:1},{x:460.3099365234375,y:275.5364583333333,step:1},{x:460.3099365234375,y:274.9114583333333,step:1},{x:459.8919270833333,y:274.5286458333333,step:1},{x:459,y:274,step:1},{x:457.9765625,y:273.3919270833333,step:1},{x:456.9974365234375,y:272.5598958333333,step:1},{x:456.9974365234375,y:271.16796875,step:1},{x:456.9974365234375,y:268.9921875,step:1},{x:458.6966145833333,y:267.6640625,step:1},{x:460.81254069010413,y:267.6640625,step:1},{x:461.97916666666663,y:267.6640625,step:1},{x:462.6718343098958,y:267.95182291666663,step:1},{x:463.08854166666663,y:268.1920979817708,step:1},{x:462.44010416666663,y:270.111328125,step:0},{x:462.125,y:269.919921875,step:1},{x:461.4478759765625,y:269.6314697265625,step:1},{x:460.6405843098958,y:269.6477864583333,step:1},{x:459.67704264322913,y:269.6477864583333,step:1},{x:459.1718343098958,y:270.17582194010413,step:1},{x:459.1718343098958,y:270.767578125,step:1},{x:459.1718343098958,y:271.3919270833333,step:1},{x:459.7630208333333,y:271.775390625,step:1},{x:460.58329264322913,y:272.28776041666663,step:1},{x:461.7642822265625,y:272.9759114583333,step:1},{x:462.49869791666663,y:273.83984375,step:1},{x:462.49869791666663,y:275.13541666666663,step:1},{x:462.49869791666663,y:277.5364583333333,step:1},{x:460.71354166666663,y:278.7682698567708,step:1},{x:458.5677083333333,y:278.7682698567708,step:1},{x:457.22782389322913,y:278.75260416666663,step:1},{x:456.2499593098958,y:278.3671875,step:1},{x:455.80204264322913,y:278,step:1},{x:456.4934895833333,y:276.1119384765625,step:0}],borderWidth:0,borderColor:"rgba(213,177,66,1)",background:"rgba(35,31,32,1)",lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4}];class Vh extends Za{constructor(t){var e;super({type:"annotationStamp",...t,style:{...t.style,stampConfig:(null==t||null===(e=t.style)||void 0===e?void 0:e.stampConfig)||zh(null==t?void 0:t.style.iconName)}}),i(this,"shapeType","annotationStamp"),i(this,"stampType","base"),i(this,"controls",void 0),i(this,"eventHandler",void 0),i(this,"context",void 0),i(this,"shapes",[]),i(this,"initialRect",void 0),i(this,"iconName",void 0),i(this,"imageLoadedByDraw",!1),i(this,"initByDraw",!1),i(this,"hooks",{reRenderImage:en()}),this.initByDraw=(null==t?void 0:t.initByDraw)||!1,this.initStamp(),this.init(t.transform,t.selectableStyle),this.initSize(t.style,t.transform);}init(t,e){this.eventHandler=new uh(this),this.context=new gh(this,e),this.context.setTransform(t),this.initialRect=this.getBoundingRect();}initStamp(){var t;const{imageData:e,width:i,height:s}=this.style;if(this.stampItemShapes.forEach((t=>{t.destroy();})),this.stampItemShapes=[],(null==this||null===(t=this.style)||void 0===t?void 0:t.img)instanceof HTMLImageElement&&this.style.img.src&&URL.revokeObjectURL(this.style.img.src),e){this.renderType="image",this.imageLoadedByDraw=!1;const t=e instanceof Blob?URL.createObjectURL(e):e,n=new Image;n.src=t,this.style.img=n,n.onload=()=>{if(this.initByDraw||!js(i)||!js(s)){const{width:t,height:e}=n;let i=t,s=e;if(t>400||e>400){const n=Math.max(t/400,e/400);i/=n,s/=n;}this.updateStyle({width:i,height:s}),this.setLocalScale(1,1),this.initialWidth=i,this.initialHeight=s,this.initByDraw=!1,this.imageLoadedByDraw=!0;}this.hooks.reRenderImage.emit();};}else this.initByDraw=!1,super.initStamp();this.getPath(),this.renderClipStep=this.steps;}initSize(t,e){if("image"===this.renderType){const{x:t,y:e}=this.getLocalScale();1===t&&1===e||this.updateSize(this.parsedStyle.width.value,this.parsedStyle.height.value);}const i={},s=this.getAnnotationConfig(),{x:n,y:o}=(null==e?void 0:e.scale)||{x:1,y:1};var r;js(null==t?void 0:t.x)&&(null==t?void 0:t.x)!==s.style.x&&(i.x=t.x),js(null==t?void 0:t.y)&&(null==t?void 0:t.y)!==s.style.y&&(i.y=t.y),js(null==t?void 0:t.width)&&t.width*n!==s.style.width&&(i.width=t.width),js(null==t?void 0:t.height)&&t.height*o!==s.style.height&&(i.height=t.height),r=i,(0!==Object.keys(r).length||r.constructor!==Object)&&this.updateStampStyle(i);}update(){this.updateOrigin(),this.context.updateControls();}updateSize(t,e){const{x:i,y:s}=this.getLocalScale(),{x:n,y:o}=this.getPosition();if("image"===this.renderType){const{x:n,y:o}=this.getLocalPosition(),r=this.getAngle(),a=t*i,l=e*s;this.setAngle(0),this.setLocalScale(1,1),this.updateStyle({width:a,height:l});const h=n+(t-a)/2,c=o+(e-l)/2;return this.initialWidth=a,this.initialHeight=l,this.setLocalPosition({x:h,y:c}),void this.setAngle(r)}const{width:r,height:a}=this.parsedStyle,l=t||r.value*i,h=e||a.value*s;this.setLocalScale(l/r.value,h/a.value),this.setPosition({x:n,y:o});}updateStampStyle(t){const{x:e,y:i}=this.getLocalPosition(),{x:s,y:n}=this.getLocalScale(),{width:o,height:r}=this.parsedStyle,{width:a,height:l}=t,{imageData:h,iconName:c}=this.style;let d=e,u=i;h||_s(null==t?void 0:t.imageData)||this.setLocalScale(1),null!=t&&t.imageData&&t.imageData!==h?(this.style.imageData=t.imageData,this.initStamp()):null!=t&&t.iconName&&t.iconName!==c&&(this.style.imageData=null,this.style.iconName=t.iconName,this.stampConfig=zh(t.iconName),this.initStamp()),js(null==t?void 0:t.opacity)&&(null==t?void 0:t.opacity)!==this.style.opacity&&(this.style.opacity=t.opacity),this.updateSize(js(a)?a:o.value*s,js(l)?l:r.value*n);const{x:p,y:g}=this.getLocalScale();if(js(null==t?void 0:t.x)){const e=this.initialWidth*p;d=t.x-(this.initialWidth-e)/2;}if(js(null==t?void 0:t.y)){const e=this.initialHeight*g;u=t.y-(this.initialHeight-e)/2;}this.setLocalPosition(d,u);}getAnnotationConfig(){const t=this.context.getTransform(),{x:e,y:i}=this.style,s=Ns(t);if(s.position.x===e&&s.position.y===i&&1===s.scale.x&&1===s.scale.y&&(delete s.position,delete s.scale),this.style.imageData)return {type:"annotationStamp",style:{x:t.position.x,y:t.position.y,width:this.style.width,height:this.style.height,opacity:this.style.opacity,imageData:this.style.imageData},transform:{...s}};const{initialWidth:n,initialHeight:o}=this,r=n*t.scale.x,a=o*t.scale.y;return {type:"annotationStamp",style:{x:t.position.x+(n-r)/2,y:t.position.y+(o-a)/2,width:r,height:a,opacity:this.style.opacity,stampConfig:[...this.stampConfig],iconName:this.style.iconName},transform:{...s}}}destroy(){var t;(null==this||null===(t=this.style)||void 0===t?void 0:t.img)instanceof HTMLImageElement&&this.style.img.src&&(this.style.img.complete?URL.revokeObjectURL(this.style.img.src):this.style.img.onload=()=>{URL.revokeObjectURL(this.style.img.src);}),this.parentElement&&this.parentElement.removeChild(this),this.controls&&this.controls.destroy();}}function zh(t){const e=[rh.REJECTED,rh.ACCEPTED,rh.APPROVED,rh.NOT_APPROVED,rh.COMPLETED,rh.DRAFT,rh.FINAL,rh.VOID,rh.CONFIDENTIAL,rh.INITIAL_HERE,rh.SIGN_HERE,rh.WITNESS];return [_h,Eh,Mh,Nh,Ih,Uh,Lh,Fh,Bh,Oh,Wh,Hh][e.indexOf(t)]}class $h extends Vh{constructor(t){super({...t}),i(this,"stampType","raw"),i(this,"annotationRaw",void 0),this.annotationRaw=t.style.annotationRaw,this.context.updateControlsFlags({enableControl:!1});}getAnnotationConfig(){const t=super.getAnnotationConfig();return this.annotationRaw&&(t.style.annotationRaw=this.annotationRaw),t}}class jh{constructor(t){i(this,"shape",void 0),i(this,"isEditMode",void 0),i(this,"controlsBox",void 0),i(this,"controlsPoints",[]),this.shape=t;}isHitPoint(t){return this.shape.outCtx.isHitPoint(t)}enableEditMode(){this.isEditMode=!0,this.shape.context.isHit=!0,this.shape.outCtx.isCtrlPointOoutOfCropBox();}disableEditMode(){this.destroyControls(),this.isEditMode=!1,this.shape.context.isHit=!1;}editStartHandler(t){this.isEditMode&&this.shape.context.isActive&&this.shape.outCtx.startHandler(t);}editMoveHandler(t){this.isEditMode&&this.shape.outCtx.moveHandler(t);}editEndHandler(){this.isEditMode&&this.shape.outCtx.endHandler();}destroyControls(){var t;null===(t=this.controlsBox)||void 0===t||t.destroy(),this.controlsPoints.forEach((t=>{t.destroy(),t=null;})),this.controlsBox=null,this.controlsPoints=[];}}class Xh extends Ua{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;s.style={visibility:"visible",borderWidth:"annotationHighlight"===t?0:1,renderBlendMode:"multiply",lineCap:"butt",lineJoin:"miter",lineDash:[0,0],miterLimit:10,...s.style},super({type:t,name:e,...s}),i(this,"lines",[]),i(this,"textAssistEventHandler",void 0),i(this,"eventHandler",void 0),i(this,"controls",void 0),i(this,"context",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"isBlankTextAssist",!1),i(this,"isMatchText",!1),i(this,"outCtx",void 0),i(this,"isOutOfCropBox",!1),this.outCtx=n,this.outCtx&&this.outCtx.setShape(this),this.shapeType=t,this.init(s.transform,s.selectableStyle),this.updateLines(s.style.lines),this.updatePosition(0,0);}init(t,e){this.context=new gh(this,e),this.textAssistEventHandler=new jh(this),this.eventHandler=new uh(this),this.context.updateControlsFlags({useDefaultControls:!1,enableMove:!1});}update(){}updateStyle(t){super.updateStyle(t),this.updateLines(this.style.lines);}getAnnotationConfig(){const t=this.context.getTransform();return {type:this.shapeType,style:{lines:this.style.lines,...this.context.getCommonStyleConfig()},transform:t,startCharRect:this.startCharRect,endCharRect:this.endCharRect,startTextPosition:this.startTextPosition,endTextPosition:this.endTextPosition}}updateLines(t){this.lines=t,this.updateBoundingBox();}getBoundingRect(){return this.bounds}updateBoundingBox(){let t=1/0,e=1/0,i=-1/0,s=-1/0;for(let n=0;n<this.lines.length;n++){const o=this.lines[n];t=Math.min(t,o.left),e=Math.min(e,o.top),i=Math.max(i,o.left+o.width),s=Math.max(s,o.top+o.height);}this.bounds={left:t,top:e,width:i-t,height:s-e};}isPointInPath(t){var e;return !(null===(e=this.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}isPointOnActiveShape(t){if(this.context.isActive)if(this.startCharRect){if(this.isPointOnStartCtrl(t))return !0}else if(this.endCharRect&&this.isPointOnEndCtrl(t))return !0;return this.isPointOnBody(t)}isPointOnBody(t){return t.x>=this.bounds.left&&t.x<=this.bounds.left+this.bounds.width&&t.y>=this.bounds.top&&t.y<=this.bounds.top+this.bounds.height}isPointOnStartCtrl(t){if(!this.startCharRect)return !1;if(!this.context.controlsFlags.enableEdit)return !1;if(Gh(t,this.startCharRect))return !0;const e=this.getScale().x,i=this.context.parsedControlsStyle.ctrlBorderRadius/e;return Zr({x:this.startCharRect.left+this.startCharRect.width/2,y:this.startCharRect.top-i},t)<=i}isPointOnEndCtrl(t){if(!this.endCharRect)return !1;if(!this.context.controlsFlags.enableEdit)return !1;if(Gh(t,this.endCharRect))return !0;const e=this.getScale().x,i=this.context.parsedControlsStyle.ctrlBorderRadius/e;return Zr({x:this.endCharRect.left+this.endCharRect.width/2,y:this.endCharRect.top+this.endCharRect.height+i},t)<=i}}function Gh(t,e){return t.x>=e.left&&t.x<=e.left+e.width&&t.y>=e.top&&t.y<=e.top+e.height}class Yh extends Xh{constructor(){super("annotationHighlight","AnnotationHighlight",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationHighlight"),i(this,"textAssistType","highlight");}}class qh extends Xh{constructor(){super("annotationStrikeout","AnnotationStrikeout",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationStrikeout"),i(this,"textAssistType","strikeout");}}class Jh extends Xh{constructor(){super("annotationUnderline","AnnotationUnderline",arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:null),i(this,"shapeType","annotationUnderline"),i(this,"textAssistType","underline");}updateLines(t){this.lines=t,this.updateBoundingBoxForUnderline();}updateBoundingBoxForUnderline(){let t=1/0,e=1/0,i=-1/0,s=-1/0;for(let n=0;n<this.lines.length;n++){const o=this.lines[n];t=Math.min(t,o.left),e=Math.min(e,o.top),i=Math.max(i,o.left+o.width),s=Math.max(s,o.top+o.height);}this.bounds={left:t,top:e,width:i-t,height:s-e};}}const Zh={annotationRect:"rectangle",annotationEllipse:"ellipse",annotationPolygon:"polygon",annotationPolyline:"polyline",annotationLine:"line",annotationInk:"ink",annotationTextBox:"textBox",annotationFreeText:"textTypewriter",annotationStamp:"stamp"};class Qh{constructor(t){i(this,"eraserPath",void 0),i(this,"erasedShapeIds",[]),i(this,"selectionBox",void 0),i(this,"startCanvasPoint",void 0),i(this,"startLocalPoint",void 0),i(this,"lastMovePoint",void 0),i(this,"resetActivatedZIndex",!0),i(this,"isSeparateText",!1),i(this,"lastClickPointerType",""),i(this,"drawType","annotationRect"),i(this,"isStartEdit",!1),i(this,"isStartDraw",!1),i(this,"controller",void 0),i(this,"eventArea",void 0),i(this,"eventMode","none"),i(this,"defaultGroup",void 0),i(this,"activatedShape",void 0),i(this,"activatedZIndex",0),i(this,"drawLineShape",!1),i(this,"stampPreview",void 0),i(this,"inkDelayTimeout",void 0),i(this,"drawInkShape",!1),i(this,"isArrowKeyDown",!1),i(this,"arrowKeyDownSuccessful",!1),this.controller=t,this.defaultGroup=new Ph("ddvDefaultGroup"),this.defaultGroup.style.zIndex=1e5;}isDefaultGroup(t){return t===this.defaultGroup}getDrawInitStyle(t,e){var i,s;const{defaultStyleConfig:n,eraserStyle:o,selectionStyle:r}=this.controller.interactiveConfig,a={x:e.x,y:e.y};let l=[{...hh.textContent,..."annotationFreeText"===t?null==n||null===(i=n.textTypewriter)||void 0===i?void 0:i.textContent:null==n||null===(s=n.textBox)||void 0===s?void 0:s.textContent}];""===l[0].content&&(l=[]);let h={};switch(t){case"annotationInk":h={lineCap:"round",lineJoin:"round",segments:[[e]]};break;case"annotationPolygon":case"annotationPolyline":h={points:[e]};break;case"annotationLine":h={startPoint:e,endPoint:e};break;case"annotationFreeText":case"annotationTextBox":h={...a,textContents:l};break;default:h=a;}let c={...hh,...n[Zh[t]]||{}};return "select"===this.eventMode?c={...r,zIndex:999}:"erase"===this.eventMode&&(c=o),{...c,...h}}getDrawUpdateStyle(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=(e.x+this.startLocalPoint.x)/2,n=(e.y+this.startLocalPoint.y)/2,o=e.x-this.startLocalPoint.x,r=e.y-this.startLocalPoint.y;const a=["annotationCircle","annotationEllipse"].includes(t),l=Math.min(Math.abs(o),Math.abs(r));i&&(o=e.x>=this.startLocalPoint.x?l:-l,r=e.y>=this.startLocalPoint.y?l:-l,a&&(s=(2*this.startLocalPoint.x+o)/2,n=(2*this.startLocalPoint.y+r)/2));let h={};switch(t){case"annotationFreeText":break;case"annotationCircle":case"annotationArc":h={x:s,y:n,r:l};break;case"annotationEllipse":h={x:s,y:n,rx:Math.abs(o)/2,ry:Math.abs(r)/2};break;case"annotationLine":h={endPoint:e};break;default:h={width:o,height:r};}return h}limitPointToEventArea(t,e){if(!this.eventArea)return;const i=this.activatedShape,{left:s,top:n,width:o,height:r}=this.eventArea;let a=0,l=0,h=0;if(e){const{lastHitControlPoint:t,lastHitControlPointCenter:e}=i.context;t&&e&&(l=t.x-e.x,h=t.y-e.y);}else {const{borderWidth:t}=i.parsedStyle;a=ql(i)?t.value*i.getScale().x:0;}t.x<s+a+l&&(t.x=s+a+l),t.y<n+a+h&&(t.y=n+a+h),t.x>s+o+l&&(t.x=s+o+l),t.y>n+r+h&&(t.y=n+r+h);}executeErase(){var t;"erase"===this.eventMode&&(this.erasedShapeIds.length>0&&this.controller.deleteShape(this.erasedShapeIds),this.controller.deleteShape([null===(t=this.eraserPath)||void 0===t?void 0:t.id],!1),this.eraserPath=null,this.activatedShape=null,this.erasedShapeIds=[]);}executeBoxSelect(){if("select"!==this.eventMode)return;const{shapeArrMap:t,containerId:e}=this.controller,{width:i,height:s}=this.selectionBox.parsedStyle,n=i.value<2&&s.value<2,o=[],r=t.get(e);if(n){const t=[];r.forEach((e=>{if(!e.isVisible||!e.context.controlsFlags.enableControl||e===this.selectionBox||"annotationGroup"===e.shapeType)return;const i=Yl(e,this.startCanvasPoint);e.isPointInPath(i,this.getHitBorderOffset(e))&&!e.context.isGrouped&&t.push(e);})),t.length&&(t.sort(((t,e)=>t.style.zIndex-e.style.zIndex)),o.push(t[t.length-1]));}else r.forEach((t=>{"annotationGroup"!==t.shapeType&&t.isVisible&&t.context.controlsFlags.enableControl&&t!==this.selectionBox&&Kl(this.selectionBox,t)&&o.push(t);}));1===o.length?this.selectShapes([o[0]]):o.length>1?this.selectShapes(o):(this.activatedShape=null,this.controller.hooks.emitSelectAnnotation(null)),this.controller.deleteShape([this.selectionBox.id],!1),this.selectionBox=null,this.controller.hooks.emitAnnotationRender();}activateShape(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!t.isVisible||!t.context.controlsFlags.enableControl)return;const s=this.activatedShape===t,{showOnTopWhenSelected:n}=this.controller.interactiveConfig;if(!s||!t.context.isActive){var o;if(this.activatedShape&&!s)if(e){if(n&&(this.activatedShape.style.zIndex=this.activatedZIndex),this.defaultGroup.parent&&this.defaultGroup.parent!==this.controller.container&&this.defaultGroup.clear(),!this.isDefaultGroup(this.activatedShape)&&!this.defaultGroup.shapes.includes(this.activatedShape))(null===(o=this.activatedShape)||void 0===o?void 0:o.parentNode)===(null==t?void 0:t.parentNode)?this.defaultGroup.add(this.activatedShape):this.inactivateShape();}else this.inactivateShape();this.activatedShape=t,this.activatedShape.context.isActive=!0,n&&(this.resetActivatedZIndex&&(this.activatedZIndex=this.activatedShape.style.zIndex),this.resetActivatedZIndex=!0,this.activatedShape.style.zIndex=99999),this.activatedShape.eventHandler.setLimitArea(this.eventArea),this.activatedShape.controls||t.context.initControls(),t.context.renderControls(),Jl(t)&&t.pointEventsHandler.enableEditMode(),Ql(t)&&t.textAssistEventHandler.enableEditMode(),this.isDefaultGroup(t)&&t.showAllControls(),e||this.controller.hooks.emitSelectAnnotation(t),i&&this.controller.hooks.emitAnnotationRender();}}inactivateShape(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.activatedShape)return;const{showOnTopWhenSelected:i}=this.controller.interactiveConfig;if(i&&!this.isDefaultGroup(this.activatedShape)&&(this.activatedShape.style.zIndex=this.activatedZIndex),this.drawInkShape&&this.activatedShape instanceof xh&&(this.drawInkShape=!1,clearTimeout(this.inkDelayTimeout)),this.activatedShape.context.unHitShape(),this.activatedShape.context.destroyControls(),this.isDefaultGroup(this.activatedShape)&&this.activatedShape.clear(),this.activatedShape instanceof Ch&&"freeTextWriter"===this.activatedShape.textType){const{textContents:t}=this.activatedShape.style;let e="";t.forEach((t=>{e+=(null==t?void 0:t.content)||"";})),0===e.length&&this.controller.deleteShape([this.activatedShape.id],!0);}if(this.isArrowKeyDown){this.isArrowKeyDown=!1;const t=[];this.activatedShape instanceof Ph?t.push(...this.activatedShape.shapes):t.push(this.activatedShape);const e=t.map((t=>{const e=t.getAnnotationConfig(),i={style:{}};return _s(e.style.x)||(i.style.x=e.style.x),_s(e.style.y)||(i.style.y=e.style.y),_s(e.style.points)||(i.style.points=e.style.points),_s(e.style.segments)||(i.style.segments=e.style.segments),_s(e.style.startPoint)||(i.style.startPoint=e.style.startPoint),_s(e.style.endPoint)||(i.style.endPoint=e.style.endPoint),{shape:t,changedOptions:i}}));this.controller.hooks.emitModifyAnnotation(["moved"],e),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape);}this.activatedShape=null,this.controller.hooks.emitAnnotationRender(),t&&this.controller.hooks.emitSelectAnnotation(null,e);}setEventArea(t){this.eventArea=t,this.activatedShape&&this.activatedShape.eventHandler.setLimitArea(this.eventArea);}setEventMode(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"annotationRect";if("draw"===this.eventMode&&this.activatedShape&&("annotationInk"===this.drawType&&this.activatedShape instanceof xh&&this.activatedShape.setUseDouglasPeucker(!0),this.drawLineShape)){const t=[...this.activatedShape.style.points];$s()||t.pop(),this.activatedShape.style.points=t;}this.drawLineShape&&this.controller.hooks.emitAddAnnotation("draw",[this.activatedShape]),(this.drawInkShape||this.drawLineShape)&&(clearTimeout(this.inkDelayTimeout),this.inactivateShape(!1)),this.isStartDraw=!1,this.drawLineShape=!1,this.drawInkShape=!1,this.eventMode=t,this.drawType=e,this.stampPreview&&(this.controller.deleteShape([this.stampPreview.id],!1),this.stampPreview=null,this.controller.hooks.emitAnnotationRender()),"none"!==t&&(this.inactivateShape(!0),"erase"===t&&(this.drawType="annotationInk"),"select"===t&&(this.drawType="annotationRect"));}getFreeTextLimitWidth(t,e,i,s,n,o,r,a){const l=t,h=e,c=Math.round(i),d=Math.round(o);if(!l)return 0;let u=l,p=s;if(d!==c){if(0===d)switch(c){case 90:return n+a/2+r/2;case-180:case 180:return s+r;case-90:u=h,p=n+a/2-r/2;}if(-90===d)switch(c){case 0:return n+a/2+r/2;case 90:return s+r;case-180:case 180:u=h,p=n+a/2-r/2;}if(180===d||-180===d)switch(c){case 0:return s+r;case-90:return n+a/2+r/2;case 90:u=h,p=n+a/2-r/2;}if(90===d)switch(c){case-180:case 180:return n+a/2+r/2;case-90:return s+r;case 0:u=h,p=n+a/2-r/2;}}let g=u-p;return g<0&&(g=u),g}selectShapes(t){const e=[];return t.forEach((t=>{"visible"===t.parsedStyle.visibility&&t.context.controlsFlags.enableControl&&e.push(t);})),this.inactivateShape(!t.length),!!e.length&&(this.defaultGroup.clear(),1===e.length?this.activateShape(e[0],!1,!0):(this.defaultGroup.add(e),this.activateShape(this.defaultGroup,!1,!0)),!0)}editStartHandler(t){if("none"!==this.eventMode)return;if(!this.activatedShape)return;const{offsetX:e,offsetY:i}=th(this.controller.canvas,t),s={x:e,y:i};this.isStartEdit=!0,180===this.activatedShape.getAngle()&&this.activatedShape.setAngle(179.99),this.activatedShape.eventHandler.startHandler(s,!0),this.controller.hooks.emitBeforeAnnotationEdit(this.activatedShape);}editMoveHandler(t){if(!this.activatedShape||"none"!==this.eventMode||!this.isStartEdit)return;const{offsetX:e,offsetY:i}=th(this.controller.canvas,t),s={x:e,y:i};this.limitPointToEventArea(s,!0),this.activatedShape.eventHandler.moveHandler(s,An(t)),this.controller.hooks.emitAnnotationRender();}editEndHandler(t){this.isStartEdit=!1,this.activatedShape&&"none"===this.eventMode&&(this.activatedShape.eventHandler.endHandler(this.controller.hooks),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape));}drawStartHandler(t){if(!this.controller.container||"none"===this.eventMode)return;if("draw"===this.eventMode&&"annotationStamp"===this.drawType)return void("touch"!==t.pointerType&&"pen"!==t.pointerType||this.drawStampMoveHandler(t,!1));if(!this.eventArea)return;const{controller:e}=this,{drawType:i,drawLineShape:s,eventMode:n}=this,{offsetX:o,offsetY:r}=th(e.canvas,t),{left:a,top:l,width:h,height:c}=this.eventArea;if(o<a||o>a+h||r<l||r>l+c)return;const d={x:o,y:r},u=e.container.getWorldTransform().inverse().transformPoint(d);if(this.isStartDraw=!0,this.startCanvasPoint=d,this.startLocalPoint=u,this.lastMovePoint=null,"select"===n&&(this.inactivateShape(),this.controller.hooks.emitBeforeAnnotationEdit(null)),this.drawInkShape&&clearTimeout(this.inkDelayTimeout),"draw"===n&&(s||this.drawInkShape)){const e=this.activatedShape instanceof xh;return e&&this.activatedShape.addSegment(),this.activatedShape.addPoint(u),void(e||"touch"!==t.pointerType&&"pen"!==t.pointerType||this.controller.hooks.emitAnnotationRender())}-1!==["annotationPolyline","annotationPolygon"].indexOf(i)&&(this.drawLineShape=!0),"draw"===n&&-1!==["annotationInk"].indexOf(i)&&(this.drawInkShape=!0);const p={style:this.getDrawInitStyle(this.drawType,u)};if("annotationFreeText"===this.drawType){const{cropBoxRect:t}=this.controller.container.parentNode.parentNode.parentNode,e=this.getFreeTextLimitWidth(t.width,t.height,this.controller.container.getAngle(),p.style.x-t.left||0,p.style.y-t.top||0,0,0,0);p.style.width=e||p.style.width;}const g=this.controller.addShape(this.drawType,p,!1);g.style.zIndex=999;const f=()=>{0!==this.controller.container.getAngle()&&Kh(g)&&(g.setAngle(0),g.setPosition(d));},{container:v}=this.controller;if("draw"===n)this.controller.hooks.emitBeforeAnnotationDraw(g),f();else if("erase"===n){if(g.style.background=null,v){const t=g.style.borderWidth/v.getScale().x;g.style.borderWidth=t;}this.eraserPath=g;}else {if(v){const t=g.style.borderWidth/v.getScale().x;g.style.borderWidth=t;}this.selectionBox=g,f();}this.activatedShape=g,this.controller.hooks.emitAnnotationRender();}drawMoveHandler(t,e){const{activatedShape:i,eventMode:s,isStartDraw:n,drawType:o}=this;if("none"===s)return;if("draw"===s&&"annotationStamp"===o)return void this.drawStampMoveHandler(t,e);if("draw"===s&&"annotationFreeText"===o)return;if(!n)return;const{offsetX:r,offsetY:a}=th(this.controller.canvas,t),l={x:r,y:a};this.limitPointToEventArea(l,!1);const h=this.controller.container.getWorldTransform().inverse().transformPoint(l);if("annotationPolyline"===o||"annotationPolygon"===o){const t=Ns(i.parsedStyle.points),e=t.length;1===e?t[e]=h:t[e-1]=h,i.style.points=t;}else if("annotationInk"===o)i.addPoint(h);else {const e=this.getDrawUpdateStyle(this.drawType,h,An(t)),s=this.controller.container.getAngle();if(0!==s&&Kh(i)){if(90===Math.abs(Math.round(s))){const t=e.width;e.width=e.height,e.height=t;}e.width=l.x-this.startCanvasPoint.x>0?Math.abs(e.width):-Math.abs(e.width),e.height=l.y-this.startCanvasPoint.y>0?Math.abs(e.height):-Math.abs(e.height),i.updateStyle(e),i.setPosition({...this.startCanvasPoint});}else i.updateStyle(e);}this.controller.hooks.emitAnnotationRender();}drawStampMoveHandler(t,e){const{offsetX:i,offsetY:s}=th(this.controller.canvas,t),n={x:i,y:s},o=this.controller.container.getRootNode(),r=o.getWorldTransform().inverse().transformPoint(n),a=()=>{if(!this.stampPreview)return;const t=this.stampPreview.getBoundingRect();this.stampPreview.style.visibility=e?"hidden":"visible",this.stampPreview.setLocalPosition(r.x-t.width/2,r.y-t.height/2);};if(!this.stampPreview){const{defaultStyleConfig:t}=this.controller.interactiveConfig,{stamp:e}=t,i=(null==e?void 0:e.stampIcon)||(null==hh?void 0:hh.stampIcon),s=(null==e?void 0:e.imageData)||(null==hh?void 0:hh.imageData),n=(null==e?void 0:e.stampConfig)||null;if(this.stampPreview=this.controller.createShape("annotationStamp",{style:{iconName:n?null:i,imageData:s,stampConfig:n,opacity:js(e.opacity)?e.opacity:.5,zIndex:9999},initByDraw:!0}),o.appendChild(this.stampPreview),!s&&i){const{width:t,height:e}=this.stampPreview.parsedStyle;if(e.value>60){const i=e.value/60;this.stampPreview.updateSize(t.value/i,e.value/i);}this.stampPreview.hooks.reRenderImage.on((()=>{this.controller.hooks.emitAnnotationRender();}));}else this.stampPreview.hooks.reRenderImage.on((()=>{"visible"===this.stampPreview.style.visibility&&a(),this.controller.hooks.emitAnnotationRender();}));}a(),this.controller.hooks.emitAnnotationRender();}eraseMoveHandler(t){const{eraserStyle:e}=this.controller.interactiveConfig,{eventMode:i,isStartDraw:s,erasedShapeIds:n,controller:o}=this;if("erase"!==i||!o.container||!s)return;const r=o.shapeArrMap.get(o.containerId);if(!r.size)return;const{offsetX:a,offsetY:l}=th(o.canvas,t),h={x:a,y:l};this.lastMovePoint||(this.lastMovePoint=h),r.forEach((t=>{t!==this.eraserPath&&-1===n.indexOf(t.id)&&"visible"===t.parsedStyle.visibility&&t.context.controlsFlags.enableControl&&function(t,e,i,s){const n=Yl(t,e),o=an(e,i),r=t.isPointInPath(n,5);if(r||o<=.9)return r;const a=o/1,l=(e.x-i.x)/a,h=(e.y-i.y)/a;for(let e=0;e<Math.abs(a);e++){const s=Yl(t,{x:i.x+l*e,y:i.y+h*e});if(t.isPointInPath(s,5))return !0}return !1}(t,h,this.lastMovePoint,e.borderWidth)&&(t.style.opacity=.5,n.push(t.id));})),this.lastMovePoint=h;}drawEndHandler(t){const{eventMode:e,isStartDraw:i,drawLineShape:s,drawType:n,activatedShape:o,controller:r}=this;if("draw"===e&&"annotationStamp"===n)return void this.drawStampEndHandler(t);if("none"===e||!i||s)return;this.isStartDraw=!1;if(["annotationRect","annotationTextBox"].includes(n)){const{width:t,height:e,borderWidth:i}=o.parsedStyle,{x:s,y:n}=o.getPosition(),{x:r,y:a}=o.getScale(),l=(null==i?void 0:i.value)||0;let h=s,c=n;t.value<0&&(h=s-(-t.value+l)*r,o.style.width=-t.value+2*l),e.value<0&&(c=n-(-e.value+l)*a,o.style.height=-e.value+2*l),o.setPosition({x:h,y:c});}if("annotationEllipse"===n){const t=Math.abs(Math.round(this.controller.container.getAngle()));if(0!==t&&(o.setAngle(0),90===t)){const{rx:t,ry:e}=o.parsedStyle;o.style.rx=e.value,o.style.ry=t.value;}}if("draw"===e&&this.drawInkShape){if(o.setUseDouglasPeucker(!0),this.controller.hooks.emitAnnotationRender(),1===this.activatedShape.style.segments.length)r.hooks.emitAddAnnotation("draw",[this.activatedShape]);else {const t={style:{segments:this.activatedShape.getAnnotationConfig().style.segments}};r.hooks.emitModifyAnnotation(["resized"],[{shape:this.activatedShape,changedOptions:t}]);}return void(this.inkDelayTimeout=setTimeout((()=>{this.drawInkShape&&(this.drawInkShape=!1,this.activatedShape&&this.activatedShape instanceof xh&&(this.activatedShape.setUseDouglasPeucker(!0),this.inactivateShape(!1,!1)));}),this.controller.interactiveConfig.inkCreateDelay))}if("draw"===e&&"annotationFreeText"!==n&&"annotationStamp"!==n){const{offsetX:e,offsetY:i}=th(r.canvas,t);((this.startCanvasPoint.x-e)**2+(this.startCanvasPoint.y-i)**2)**.5<2&&"annotationStamp"!==o.shapeType&&(r.deleteShape([o.id],!1),r.hooks.emitAfterAnnotationDraw(null),this.activatedShape=null);}const a=(t,e)=>{if(t instanceof Ch){const{enableControl:i}=t.context.controlsFlags;if(!i)return;t.textEditEventHandler.enableEditMode(this.startCanvasPoint,e),"textBox"===t.textType&&this.controller.hooks.emitAnnotationRender(),"freeTextWriter"===t.textType&&setTimeout((()=>{document.activeElement instanceof HTMLTextAreaElement||t.textEditEventHandler.enableEditMode(this.startCanvasPoint,e);}),10);}};if("draw"===e&&this.activatedShape){const t=this.activatedShape,{canvas:e}=this.controller;r.hooks.emitAddAnnotation("draw",[this.activatedShape]),r.interactiveConfig.enableContinuousDrawing?o instanceof Ch?(this.eventMode="none",this.resetActivatedZIndex=!1,this.activateShape(this.activatedShape,!1,!0),a(o,e)):this.activatedShape=null:(this.controller.setAnnotationMode("none",!0),r.hooks.emitAfterAnnotationDraw(t),this.resetActivatedZIndex=!1,this.activateShape(this.activatedShape,!1,!0),a(o,e));}"erase"===e&&this.executeErase(),"select"===e&&this.executeBoxSelect();}drawStampEndHandler(t){const{offsetX:e,offsetY:i}=th(this.controller.canvas,t);if(!this.stampPreview)return;if(!this.eventArea)return;if(this.stampPreview&&"image"===this.stampPreview.renderType&&!this.stampPreview.imageLoadedByDraw)return void(this.stampPreview.style.visibility="hidden");const{left:s,top:n,width:o,height:r}=this.eventArea;if(e<s||e>o+s||i<n||i>r+n)return;const{defaultStyleConfig:a}=this.controller.interactiveConfig,{stamp:l}=a,h=js(null==l?void 0:l.opacity)?null==l?void 0:l.opacity:null==hh?void 0:hh.opacity,c=this.stampPreview;c.style.opacity=h;const{containerId:d,container:u,shapeArrMap:p}=this.controller,g={...c.getPosition()},f={...c.getScale()},v=u.getScale(),m=f.x/v.x,y=f.y/v.y;if(p.get(d).set(c.id,c),c.index=p.get(d).size,c.pageUid=d,u.appendChild(c),c.style.imageData){const{width:t,height:e}=c.parsedStyle;c.updateStyle({width:t.value*m,height:e.value*y}),c.setLocalScale(1,1);}else c.setLocalScale(m,y);c.setAngle(0),c.setPosition(g),this.stampPreview=null,this.controller.hooks.emitBeforeAnnotationDraw(c),this.controller.hooks.emitAddAnnotation("draw",[c]),this.controller.interactiveConfig.enableContinuousDrawing?$s()&&this.createStampPreviewForMobile():(this.resetActivatedZIndex=!1,this.controller.setAnnotationMode("none",!0),this.activateShape(c,!1,!0),this.controller.hooks.emitAfterAnnotationDraw(c));}dblClickHandler(t){const{activatedShape:e,controller:i}=this;if(!e)return;const{shapeType:s}=e;if(this.drawLineShape&&("annotationPolygon"===s||"annotationPolyline"===s)){const t=[...e.style.points],s=t.length;return $s()?an(t[s-1],t[s-2])<=15&&t.pop():t.pop(),"mouse"===this.lastClickPointerType&&(t.pop(),this.lastClickPointerType=""),t.length<2?(i.deleteShape([e.id],!1),this.activatedShape=null):(e.style.points=t,this.controller.hooks.emitAddAnnotation("draw",[this.activatedShape])),this.isStartDraw=!1,this.drawLineShape=!1,void(!i.interactiveConfig.enableContinuousDrawing&&this.activatedShape?(this.controller.setAnnotationMode("none",!0),this.controller.hooks.emitAfterAnnotationDraw(e),this.resetActivatedZIndex=!1,this.activateShape(e,!1,!0)):this.activatedShape=null)}if("annotationFreeText"===s&&!this.isSeparateText){const{offsetX:i,offsetY:s}=th(this.controller.canvas,t),{textEditEventHandler:n}=e,o={x:i,y:s};if(this.activatedShape instanceof Ch&&"freeTextWriter"===this.activatedShape.textType&&!this.activatedShape.isEditMode){const{cropBoxRect:t}=this.controller.container.parentNode.parentNode.parentNode,e=this.activatedShape.getBoundingRect(),i=this.getFreeTextLimitWidth(t.width,t.height,this.controller.container.getAngle(),this.activatedShape.getLocalPosition().x-t.left,this.activatedShape.getLocalPosition().y-t.top,this.activatedShape.getAngle(),e.width,e.height);if(i!==this.activatedShape.style.width){this.activatedShape.style.width=i,this.activatedShape.pathDirty=!0,this.activatedShape.boundsDirty=!0,this.activatedShape.calculateTextLines();this.activatedShape.getBoundingRect().width!==e.width&&this.controller.hooks.emitModifyAnnotation(["appearanceChanged"],[{shape:this.activatedShape,changedOptions:{style:{width:i}}}]);}}n.enableEditMode(o,this.controller.canvas),this.controller.hooks.emitAnnotationRender();}}clickHandler(t,e){const{activatedShape:i,eventMode:s}=this;if(!i)return;const{shapeType:n}=i,o=()=>{if("annotationFreeText"===n){const{offsetX:e,offsetY:s}=th(this.controller.canvas,t),{textEditEventHandler:n}=i,o={x:e,y:s};n.editClickHandler(o,this.controller.canvas);}};if(this.lastClickPointerType=null==t?void 0:t.pointerType,this.isSeparateText=!1,"none"===s){const s=Pn(t);if((s||e&&!s)&&this.controller.interactiveConfig.enableMultipleSelectWidthCtrl){if(this.isDefaultGroup(i)){const{clickedShape:t}=i;this.defaultGroup.delete(t);const{shapes:e}=this.defaultGroup;if(e.length<2&&(this.defaultGroup.context.isActive=!1),1===e.length){const t=e[0];this.activateShape(t,!1,!1),this.isSeparateText=t instanceof Ch;}}else this.defaultGroup.parent&&this.defaultGroup.parent!==this.controller.container&&this.defaultGroup.clear(),this.defaultGroup.add(this.activatedShape),this.defaultGroup.shapes.length>=2?(this.defaultGroup.context.isActive=!0,this.activateShape(this.defaultGroup,!1,!1)):(this.controller.hooks.emitSelectAnnotation(i),o());return void this.controller.hooks.emitAnnotationRender()}o();}}keyDownHandler(t,e){const{activatedShape:i}=this;if(!i)return;const s=()=>(this.isStartDraw&&(this.isStartDraw=!1),this.drawInkShape?(this.drawLineShape=!1,void this.controller.hooks.emitAnnotationModeChanged("none")):this.drawLineShape?(this.drawLineShape=!1,this.controller.deleteShape([this.activatedShape.id]),void this.controller.hooks.emitAnnotationRender()):(this.inactivateShape(!0),void this.defaultGroup.clear()));switch(t.key){case"Escape":s();break;case"Delete":case"Backspace":if(Zl(i)&&i.textEditEventHandler.editMode)return;if(!this.controller.interactiveConfig.enableDeleteWithKeyboard)return;if(this.drawInkShape||this.drawLineShape)return;t.preventDefault(),this.controller.deleteShape([i.id]),this.inactivateShape();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":if(!this.controller.interactiveConfig.enableMoveWithKeyboard)return void t.preventDefault();if(i instanceof Ch&&i.isEditMode)return;if(this.drawInkShape||this.drawLineShape)return;this.isArrowKeyDown=!0;i.eventHandler.moveByKeyboard(t,e)&&(this.controller.hooks.emitBeforeAnnotationEdit(i),this.arrowKeyDownSuccessful=!0,this.controller.hooks.emitAnnotationRender());break;case"Home":case"End":case"PageUp":case"PageDown":this.controller.interactiveConfig.enableMoveWithKeyboard||t.preventDefault();}}keyUpHandler(t){if(this.isArrowKeyDown&&(this.isArrowKeyDown=!1,["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(t.key)&&this.arrowKeyDownSuccessful)){this.arrowKeyDownSuccessful=!1;const t=[];this.activatedShape instanceof Ph?t.push(...this.activatedShape.shapes):t.push(this.activatedShape);const e=t.map((t=>{const e=t.getAnnotationConfig(),i={style:{}};return _s(e.style.x)||(i.style.x=e.style.x),_s(e.style.y)||(i.style.y=e.style.y),_s(e.style.points)||(i.style.points=e.style.points),_s(e.style.segments)||(i.style.segments=e.style.segments),_s(e.style.startPoint)||(i.style.startPoint=e.style.startPoint),_s(e.style.endPoint)||(i.style.endPoint=e.style.endPoint),{shape:t,changedOptions:i}}));this.controller.hooks.emitModifyAnnotation(["moved"],e),this.controller.hooks.emitAfterAnnotationEdit(this.activatedShape);}}getHitBorderOffset(t){if(!t)return 10;const e=t.getScale();if(e.x<1||e.y<1){const t=Math.min(e.x,e.y);return Math.round(Math.abs(10/t))}return 10}createStampPreviewForMobile(){if(this.stampPreview)return;const{defaultStyleConfig:t}=this.controller.interactiveConfig,{stamp:e}=t,i=(null==e?void 0:e.stampIcon)||(null==hh?void 0:hh.stampIcon),s=(null==e?void 0:e.imageData)||(null==hh?void 0:hh.imageData),n=(null==e?void 0:e.stampConfig)||null,o=this.controller.container.getRootNode();if(this.stampPreview=this.controller.createShape("annotationStamp",{style:{iconName:n?null:i,imageData:s,stampConfig:n,opacity:js(e.opacity)?e.opacity:.5,zIndex:9999,visibility:!1},initByDraw:!0}),o.appendChild(this.stampPreview),!s&&i){const{width:t,height:e}=this.stampPreview.parsedStyle;if(e.value>60){const i=e.value/60;this.stampPreview.updateSize(t.value/i,e.value/i);}}}}function Kh(t){return ["annotationFreeText","annotationTextBox","annotationRect"].includes(t.shapeType)}var tc=new WeakMap;class ec extends Qn{constructor(){super(...arguments),i(this,"renderAnnotation",to(this)),i(this,"addAnnotation",to(this)),i(this,"deleteAnnotation",to(this)),i(this,"selectAnnotation",to(this)),i(this,"modifyAnnotation",to(this)),i(this,"annotationModeChanged",to(this)),i(this,"beforeAnnotationEdit",to(this)),i(this,"afterAnnotationEdit",to(this)),i(this,"beforeAnnotationDraw",to(this)),i(this,"afterAnnotationDraw",to(this)),i(this,"annotationTextEditorResized",to(this)),i(this,"annotationTextPositionUpdated",to(this)),i(this,"annotationTextContentUpdated",to(this)),i(this,"selectAnnotationTextChars",to(this)),i(this,"enableAnnotationTextEditMode",to(this)),i(this,"disableAnnotationTextEditMode",to(this)),f(this,tc,{writable:!0,value:[]}),i(this,"renderTimer",null);}emitAddAnnotation(t,e){const i=[];e.forEach((t=>{i.push({uid:t.id,shape:t});})),this.addAnnotation.emit({action:t,shapes:i});}emitDeleteAnnotation(t){const e=[];t.forEach((t=>{e.push({uid:t.id,shape:t});})),this.deleteAnnotation.emit({shapes:e});}emitSelectAnnotation(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[];t instanceof Ph?t.shapes.forEach((t=>{i.push(t.id);})):t&&i.push(t.id),(i.length||s(this,tc).length)&&(this.selectAnnotation.emit({newAnnotationUids:[...i],oldAnnotationsUids:[...s(this,tc)],emitSelected:e}),n(this,tc,i));}emitModifyAnnotation(t,e){this.modifyAnnotation.emit({actions:t,shapes:e});}emitAnnotationModeChanged(t){this.annotationModeChanged.emit(t);}emitBeforeAnnotationEdit(t){t instanceof Ch&&t.textEditEventHandler.editMode||this.beforeAnnotationEdit.emit(t);}emitAfterAnnotationEdit(t){this.afterAnnotationEdit.emit(t);}emitAnnotationRender(){this.renderTimer||(this.renderTimer=setTimeout((()=>{this.renderTimer=null,this.renderAnnotation.emit();}),17));}emitSelectAnnotationTextChar(t){this.selectAnnotationTextChars.emit(t);}emitBeforeAnnotationDraw(t){this.beforeAnnotationDraw.emit(t);}emitAfterAnnotationDraw(t){this.afterAnnotationDraw.emit(t);}emitEnableAnnotationTextEditMode(t){this.enableAnnotationTextEditMode.emit(t);}emitDisableAnnotationTextEditMode(t){this.disableAnnotationTextEditMode.emit(t);}emitAnnotationTextContentUpdated(t){this.annotationTextContentUpdated.emit(t);}emitAnnotationTextPositionUpdated(t){this.annotationTextPositionUpdated.emit(t);}}class ic{constructor(t){i(this,"shapeArrMap",void 0),i(this,"shapeMap",void 0),i(this,"annotationMode","none"),i(this,"brush","annotationRect"),i(this,"tempTextStyle",void 0),i(this,"isEnterCtrl",!1),i(this,"canvas",void 0),i(this,"hooks",void 0),i(this,"interactiveConfig",Ns(dh)),i(this,"eventService",void 0),i(this,"containerId",void 0),i(this,"container",void 0),this.canvas=t,this.eventService=new Qh(this),this.hooks=new ec,this.shapeArrMap=new Map,this.shapeMap=new Map;}set drawType(t){this.brush=t,"draw"===this.annotationMode&&this.eventService.setEventMode("draw",t);}get drawType(){return this.brush}clearShapeArrMap(){this.shapeArrMap.forEach((t=>{t.clear();})),this.shapeArrMap.clear();}deleteShapeArrMap(t){this.shapeArrMap.has(t)&&(this.shapeArrMap.get(t).clear(),this.shapeArrMap.delete(t));}bindFreeTextHooks(t){if(!(t instanceof Ch))return;const e=t.hooks;e.reRenderText.on((()=>{this.hooks.emitAnnotationRender();})),e.textContentUpdated.on((e=>{this.hooks.emitModifyAnnotation(["contentChanged"],[{shape:t,changedOptions:{style:{textContents:Ns(t.style.textContents)}}}]);})),e.positionUpdated.on((()=>{this.hooks.emitAnnotationTextPositionUpdated(t);})),e.textContentUpdatedByChar.on((()=>{this.hooks.emitAnnotationTextContentUpdated(t);})),e.selectTextChars.on((e=>{var i;const{freeTextContentStyle:s}=t,n="freeTextWriter"===t.textType?"textTypewriter":"textBox",{defaultStyleConfig:o}=this.interactiveConfig;o[n]||(o[n]={}),o[n].textContent={...s,content:null===(i=o[n])||void 0===i||null===(i=i.textContent)||void 0===i?void 0:i.content},this.hooks.emitSelectAnnotationTextChar(t);})),e.enableTextEditMode.on((e=>{this.tempTextStyle=Ns(this.interactiveConfig.defaultStyleConfig["textBox"===t.textType?"textBox":"textTypewriter"]),this.hooks.emitEnableAnnotationTextEditMode(t);})),e.disableTextEditMode.on((e=>{this.interactiveConfig.defaultStyleConfig["textBox"===t.textType?"textBox":"textTypewriter"]=this.tempTextStyle,this.tempTextStyle=null,this.hooks.emitDisableAnnotationTextEditMode(t);}));}bindStampHooks(t){t instanceof Vh&&t.hooks.reRenderImage.on((()=>{this.hooks.emitAnnotationRender();}));}isHitShape(t){const{offsetX:e,offsetY:i}=th(this.canvas,t),{activatedShape:s,defaultGroup:n}=this.eventService,o={x:e,y:i},{shapeArrMap:r,shapeMap:a,containerId:l}=this,h=r.get(l)||a,c=n===this.eventService.activatedShape&&(null==n?void 0:n.parentNode)===this.container;if(s&&(c||h.has(s.id))){const t=s.eventHandler.isHit(o,!1);if(-1!==t)return {isHit:!0,isHitSelected:!0,hitControlPointIndex:t,shape:s}}let d=!1,u=null;const p=Array.from(h.values()).filter((t=>"hidden"!==t.style.visibility&&t.context.controlsFlags.enableControl&&t!==s&&!t.context.isGrouped)).sort(((t,e)=>e.style.zIndex-t.style.zIndex));for(const t of p){const e=Yl(t,o);if(t.isPointInPath(e,this.eventService.getHitBorderOffset(t))){d=!0,u=t;break}}return {isHit:d,shape:u,isHitSelected:!1,hitControlPointIndex:-1}}isInTextEditMode(){return !!(this.eventService.activatedShape&&this.eventService.activatedShape instanceof Ch)&&this.eventService.activatedShape.isEditMode}setAnnotationMode(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.annotationMode=t,this.eventService.setEventMode(t,this.drawType),$s()&&"draw"===t&&"annotationStamp"===this.drawType&&this.eventService.createStampPreviewForMobile(),"none"!==t&&this.eventService.inactivateShape(),e&&this.hooks.emitAnnotationModeChanged(t);}setAnnotationContainer(t,e){if(e!==this.container){const{activatedShape:t,drawLineShape:e,drawInkShape:i,drawType:s}=this.eventService;if("draw"===this.eventService.eventMode&&t){if(i&&t instanceof xh&&(clearTimeout(this.eventService.inkDelayTimeout),t.setUseDouglasPeucker(!0),this.eventService.drawInkShape=!1),e){const e=[...t.style.points];t.style.points=e,this.eventService.drawLineShape=!1,this.eventService.isStartDraw=!1;}"annotationInk"!==s&&(this.hooks.emitAddAnnotation("draw",[t]),this.interactiveConfig.enableContinuousDrawing||(this.setAnnotationMode("none",!0),this.hooks.emitAfterAnnotationDraw(t)),this.eventService.activatedShape=null);}}this.containerId=t,this.container=e,this.shapeArrMap.get(t)||this.shapeArrMap.set(t,new Map);}setAnnotationInteractiveConfig(t){if(this.tempTextStyle){const e=this.eventService.activatedShape;if(e instanceof Ch){const i=t.defaultStyleConfig["textBox"===e.textType?"textBox":"textTypewriter"];if(i){const t=this.tempTextStyle.textContent;this.tempTextStyle={...this.tempTextStyle,...i},this.tempTextStyle.textContent={...t,...i.textContent};}}}const e=Ns(t),{controlsStyle:i,defaultStyleConfig:s,eraserStyle:n,selectionStyle:o}=this.interactiveConfig;e.defaultStyleConfig=(null==e?void 0:e.defaultStyleConfig)||{};const{stamp:r}=s,{stamp:a}=e.defaultStyleConfig,l=(null==r?void 0:r.stampIcon)||hh.stampIcon,h=null==r?void 0:r.stampConfig,c=(null==r?void 0:r.imageData)||hh.imageData,d=null==a?void 0:a.stampIcon,u=null==a?void 0:a.stampConfig,p=null==a?void 0:a.imageData;this.interactiveConfig={...this.interactiveConfig,...e,controlsStyle:Nn((null==e?void 0:e.controlsStyle)||{},i),defaultStyleConfig:Nn((null==e?void 0:e.defaultStyleConfig)||{},s),eraserStyle:Nn((null==e?void 0:e.eraserStyle)||{},n),selectionStyle:Nn((null==e?void 0:e.selectionStyle)||{},o)},(d||u||p)&&(p||(this.interactiveConfig.defaultStyleConfig.stamp.imageData=null),u||(this.interactiveConfig.defaultStyleConfig.stamp.stampConfig=null)),null!=e&&e.controlsStyle&&this.updateAllShapeControlsStyle(this.interactiveConfig.controlsStyle);const{stampPreview:g}=this.eventService;var f;(g&&g.style.opacity!==(null==a?void 0:a.opacity)&&(this.eventService.stampPreview.style.opacity=null==a?void 0:a.opacity),l===d&&c===p&&h===u||!this.eventService.stampPreview)||(null===(f=this.eventService.stampPreview)||void 0===f||f.destroy(),this.eventService.stampPreview=null);}setAnnotationFlags(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const s=this.getShape(t);if(!(s instanceof $h)&&s){s!==this.eventService.activatedShape||!1!==e.enableControl&&!1!==e.isVisible||this.eventService.drawInkShape||this.eventService.inactivateShape(!0),s.context.updateControlsFlags({...e});const{isVisible:t,enableControl:n,enableEdit:o}=s.context.controlsFlags;if(s.context.isInGroup&&(!t||!n)){const{defaultGroup:t,activatedShape:e}=this.eventService;t.delete(s),e===t&&1===t.shapes.length&&this.eventService.activateShape(t.shapes[0],!1,!0);}Jl(s)&&s.pointEventsHandler.editMode&&!o&&(s.pointEventsHandler.disableEditMode(),s.pointEventsHandler.enableEditMode()),i&&this.hooks.emitAnnotationRender();}}getShape(t){if("ddvDefaultGroup"===t)return this.eventService.defaultGroup;const e=this.shapeMap.get(t);return e||null}getSelectedShapeUids(){const{activatedShape:t}=this.eventService;if(!t)return [];const e=[];return t instanceof Ph?t.shapes.forEach((t=>{e.push(t.id);})):e.push(t.id),e}createShape(t,e,i){var s,n;let o;if(e.selectableStyle={...this.interactiveConfig.controlsStyle,...e.selectableStyle},"annotationEllipse"===t){const{style:t}=e;t.x+=t.width/2||0,t.y+=t.height/2||0,t.rx=t.width/2||t.rx,t.ry=t.height/2||t.ry;}const{defaultStyleConfig:r}=this.interactiveConfig;switch(t){case"annotationRect":o=new wh(e);break;case"annotationGroup":o=new Ph(null==e?void 0:e.id);break;case"annotationArc":o=new fh(e);break;case"annotationCircle":o=new vh(e);break;case"annotationEllipse":o=new mh(e);break;case"annotationLine":o=new Rh(e);break;case"annotationInk":o=new xh(e);break;case"annotationPolygon":o=new kh(e);break;case"annotationPolyline":o=new Dh(e);break;case"annotationFreeText":o=new Ch(e,"freeTextWriter",{...hh.textContent,...null===(s=r.textTypewriter)||void 0===s?void 0:s.textContent});break;case"annotationTextBox":o=new Ch(e,"textBox",{...hh.textContent,...null===(n=r.textBox)||void 0===n?void 0:n.textContent});break;case"annotationImage":o=new yh(e);break;case"annotationStamp":o=new Vh(e);break;case"annotationHighlight":o=new Yh(e,i);break;case"annotationUnderline":o=new Jh(e,i);break;case"annotationStrikeout":o=new qh(e,i);break;default:o=new $h(e);}return o?(o.id||(o.id=qs()),this.shapeMap.set(o.id,o),o):null}addShape(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(null!=e&&e.id){const t=this.getShape(null==e?void 0:e.id);if(t)return t}const n=this.createShape(t,e,s);return this.containerId&&this.shapeArrMap.get(this.containerId).set(n.id,n),this.container&&(n.index=this.shapeArrMap.get(this.containerId).size,n.pageUid=this.containerId,this.container.appendChild(n),i&&this.hooks.emitAddAnnotation("data",[n])),this.bindFreeTextHooks(n),this.bindStampHooks(n),n}updateShape(t,e){const i=this.getShape(t);if(!i)return !1;const{isGrouped:s}=i.context;if(s&&this.eventService.defaultGroup.delete(i),null!=e&&e.style)if(i instanceof Vh)i.updateStampStyle({...e.style});else {if(i instanceof mh){const{x:t,y:s,width:n,height:o}=e.style,{x:r,y:a}=i.getLocalPosition(),l=i.getAnnotationConfig(),h=n?Cr(n).value/2:l.style.width/2,c=o?Cr(o).value/2:l.style.height/2,d=js(t)?t+h:r-l.style.width/2+h,u=js(s)?s+c:a-l.style.height/2+c,p=h,g=c;e.style={...e.style,x:d,y:u,rx:p,ry:g};}i.updateStyle({...e.style}),i instanceof Ch&&i.updateOrigin();}if(null!=e&&e.transform){const{angle:t,scale:s}=e.transform;_s(t)||i.setLocalAngle(t),_s(s)||i instanceof Vh||i.setLocalScale(s);}return s&&this.eventService.defaultGroup.add(i),!0}updateAllShapeControlsStyle(t){let e=!1;this.shapeMap.forEach((i=>{if(i.context.controlsStyle=t,i.context.parseControlsStyle(),i.controls){i.controls.isVisible&&(e=!0),i.context.destroyControls(),i.context.initControls(),i.context.renderControls();}})),e&&this.hooks.emitAnnotationRender();}updateFreeTextDefaultConfig(){const{defaultStyleConfig:t}=this.interactiveConfig;this.shapeMap.forEach((e=>{if(e instanceof Ch){const i=hh.textContent,s="freeTextWriter"===e.textType?"textTypewriter":"textBox",{textContent:n}=t[s]||{};e.updateFreeTextContentStyle({...i,...n,content:i.content});}}));}updateLayer(t,e){const i=this.getShape(t);return !!i&&(this.interactiveConfig.showOnTopWhenSelected&&this.eventService.activatedShape===i?this.eventService.activatedZIndex=e:i.updateStyle({zIndex:e}),this.interactiveConfig.showOnTopWhenSelected&&this.interactiveConfig.enableContinuousDrawing&&"draw"===this.eventService.eventMode&&i.updateStyle({zIndex:e}),!0)}deleteShape(t){var e;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const n=[],{eventService:o}=this,r=t.includes(null==o||null===(e=o.activatedShape)||void 0===e?void 0:e.id);if(t.forEach((t=>{const e=this.getShape(t);e&&(e instanceof Ph?(n.push(...e.shapes),e.clear()):n.push(e));})),!n.length)return !1;i&&this.hooks.emitDeleteAnnotation(n),n.forEach((t=>{t.context.isInGroup&&this.eventService.defaultGroup.delete(t),this.shapeMap.delete(t.id),this.shapeArrMap.get(t.pageUid)&&this.shapeArrMap.get(t.pageUid).delete(t.id),t.destroy();}));const{activatedShape:a,defaultGroup:l}=o,h=a===l&&!l.state;return (r||h)&&this.eventService.inactivateShape(!0,s),!0}selectShape(t){const e=[];return t.forEach((t=>{e.push(this.getShape(t));})),this.eventService.selectShapes(e)}moveShape(t,e,i){t.forEach((t=>{const s=this.getShape(t);if(!s)return;const n=s.pageUid,o=this.shapeArrMap.get(n);o&&o.delete(t),this.shapeArrMap.get(e)||this.shapeArrMap.set(e,new Map),this.shapeArrMap.get(e).set(t,s),s.context.isGrouped&&s.parentNode.delete(s,!0),i.appendChild(s);}));}clickHandler(t){this.eventService.clickHandler(t,this.isEnterCtrl);}dblClickHandler(t){this.eventService.dblClickHandler(t);}keyDownHandler(t,e){this.eventService.keyDownHandler(t,e);}keyUpHandler(t){this.eventService.keyUpHandler(t);}startHandler(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.isHitShape(t);this.isEnterCtrl=Pn(t);const s=this.isEnterCtrl&&this.interactiveConfig.enableMultipleSelectWidthCtrl;if("none"===this.annotationMode&&e&&(i.isHit?this.eventService.activateShape(i.shape,s,!0):this.eventService.inactivateShape()),"draw"!==this.annotationMode||i.isHit||this.annotationMode===this.eventService.eventMode){if("draw"===this.annotationMode&&!this.eventService.drawLineShape&&"annotationInk"!==this.brush&&"annotationStamp"!==this.brush&&i.isHit)this.eventService.setEventMode("none"),this.eventService.activateShape(i.shape,s,!0);else if("select"===this.annotationMode){const{isHitSelected:t,isHit:e}=i;t?this.eventService.setEventMode("none"):!t&&e&&s?(this.eventService.setEventMode("none"),this.eventService.activateShape(i.shape,s,!0)):(this.eventService.setEventMode("select"),this.eventService.defaultGroup.clear());}}else this.eventService.setEventMode(this.annotationMode,this.brush);this.eventService.editStartHandler(t),this.eventService.drawStartHandler(t);}moveHandler(t,e){this.eventService.editMoveHandler(t),this.eventService.drawMoveHandler(t,e),this.eventService.eraseMoveHandler(t);}endHandler(t){this.eventService.editEndHandler(t),this.eventService.drawEndHandler(t);}cursorHandler(t){if(!this.container)return null;if("erase"===this.annotationMode)return 12;if("draw"===this.annotationMode){if("annotationInk"===this.drawType||"annotationStamp"===this.drawType)return 3;if(["annotationHighlight","annotationUnderline","annotationStrikeout"].includes(this.drawType))return 16}const e=this.isHitShape(t);if(e.isHit){if(e.isHitSelected){let t=null;switch(e.hitControlPointIndex){case 8:t=11;break;case 9:t=e.shape instanceof Ch&&e.shape.isEditMode?16:e.shape.context.controlsFlags.enableMove?4:1;break;case 10:t=16;break;default:t=1;}return t}return 13}return "select"===this.annotationMode?2:"draw"===this.annotationMode?3:"none"===this.annotationMode?14:null}}class sc extends Dl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class nc extends sc{constructor(t){super(t),this.close=!1;}}class oc extends sc{render(t,e){super.render(t,e);}}class rc extends sc{}class ac extends _l{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class lc extends sc{}class hc extends Il{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class cc extends Bl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class dc extends sc{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class uc extends Ll{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&(t.pointEventsHandler.updateLineControls(),t.context.renderControls()));}}class pc extends sc{}class gc extends Dl{render(t,e){if("hidden"!==t.parsedStyle.visibility){if("stamp"===t.renderType)super.render(t,e);else {const{width:i,height:s,img:n,opacity:o}=t.parsedStyle;if(Xs(n))return;e.save(),e.globalAlpha=o,e.imageSmoothingEnabled=!0,e.imageSmoothingQuality&&(e.imageSmoothingQuality="high"),e.drawImage(n,0,0,i.value,s.value),e.restore();}t.controls&&t.context.renderControls();}}}class fc extends Fl{render(t,e){"hidden"!==t.parsedStyle.visibility&&(super.render(t,e),t.controls&&t.context.renderControls());}}class vc extends Dl{render(t,e){if("hidden"===t.parsedStyle.visibility)return;mc(t,e);const{background:i,borderColor:s,borderWidth:n}=t.container.context.parsedControlsStyle,o=i&&""!==i,r=s&&""!==s&&n>0;if(t.boxRenderSteps.length&&(o||r)&&(this.renderSteps(t,e,t.boxRenderSteps),this.renderFill(t,e),this.renderStroke(t,e)),t.rotationRenderSteps.length&&r&&(this.renderSteps(t,e,t.rotationRenderSteps),this.renderStroke(t,e),this.renderControlPoints(t,e,t.rotationRenderPath[1])),t.controlPointsRenderPaths.length)for(const i of t.controlPointsRenderPaths)this.renderControlPoints(t,e,i);}renderSteps(t,e,i){e.beginPath(),i.forEach((t=>{ua(e,t);})),i.length>2&&e.closePath();}renderFill(t,e){const{background:i}=t.container.context.parsedControlsStyle;i&&""!==i&&(e.save(),e.fillStyle=i,e.fill(),e.restore());}renderStroke(t,e){const{borderColor:i,borderWidth:s,lineDash:n}=t.container.context.parsedControlsStyle;i&&""!==i&&s>0&&(e.save(),e.lineWidth=s,e.strokeStyle=i,e.setLineDash(n),e.stroke(),e.restore());}renderControlPoints(t,e,i){const{ctrlBackground:s,ctrlBorderColor:n,ctrlBorderRadius:o,ctrlBorderWidth:r,ctrlLineDash:a,ctrlWidth:l,ctrlHeight:h}=t.container.context.parsedControlsStyle;for(let t=0;t<4;t++){e.beginPath();const t=o;if(0===t)e.rect(i.x-l/2,i.y-h/2,l,h);else {const{PI:s}=Math;e.arc(i.x-l/2+t,i.y-h/2+t,t,s,3*s/2),e.arc(i.x+l/2-t,i.y-h/2+t,t,3*s/2,2*s),e.arc(i.x+l/2-t,i.y+h/2-t,t,0,s/2),e.arc(i.x-l/2+t,i.y+h/2-t,t,s/2,s);}}e.closePath(),s&&(e.save(),e.fillStyle=s,e.fill(),e.restore()),r>0&&(e.save(),e.lineWidth=r,e.strokeStyle=n,e.setLineDash(a),e.stroke(),e.restore());}}function mc(t,e){const{container:i}=t,s=t.parentNode;if(!s)return;const n=s.getLocalTransform(),{a:o,b:r,c:a,d:l,e:h,f:c}=n;let d=null,u=i.parentNode;for(;!d&&u;)"pageCropBox"===u.name&&(d=u),u=u.parentNode;if(d){const{x:t,y:i,width:s,height:n}=function(t){let{x:e,y:i}=t.getPosition(),{width:s,height:n}=t;const o=t.parentNode.parentNode,r=(o.rotation%360+360)%360/90,a=devicePixelRatio;1===r?e-=n:2===r?(e-=s,i-=n):3===r&&(i-=s);if(1===r||3===r){const t=s;s=n,n=t;}return {x:e*a,y:i*a,width:s*a,height:n*a}}(d);e.save(),e.setTransform(o,r,a,l,h,c),e.beginPath(),e.moveTo(t,i),e.lineTo(t+s,i),e.lineTo(t+s,i+n),e.lineTo(t,i+n),e.closePath(),e.restore(),e.clip();}}class yc extends Dl{render(t,e){if("hidden"===t.parsedStyle.visibility)return;if(mc(t,e),super.render(t,e),!t.container.context.controlsFlags.enableEdit)return;const i=t.container.baseRenderPath||[],{x:s,y:n}=t.container.getScale();for(const o of i){const i={x:o.x*s,y:o.y*n};this.renderControlPoints(t,e,i);}}renderControlPoints(t,e,i){const{ctrlBackground:s,ctrlBorderColor:n,ctrlBorderRadius:o,ctrlBorderWidth:r,ctrlLineDash:a,ctrlWidth:l,ctrlHeight:h}=t.container.context.parsedControlsStyle;for(let t=0;t<4;t++){e.beginPath();const t=o;if(0===t)e.rect(i.x-l/2,i.y-h/2,l,h);else {const{PI:s}=Math;e.arc(i.x-l/2+t,i.y-h/2+t,t,s,3*s/2),e.arc(i.x+l/2-t,i.y-h/2+t,t,3*s/2,2*s),e.arc(i.x+l/2-t,i.y+h/2-t,t,0,s/2),e.arc(i.x-l/2+t,i.y+h/2-t,t,s/2,s);}}e.closePath(),s&&(e.save(),e.fillStyle=s,e.fill(),e.restore()),r>0&&(e.save(),e.lineWidth=r,e.strokeStyle=n,e.setLineDash(a),e.stroke(),e.restore());}}class xc{constructor(t){i(this,"rCanvas",void 0),this.rCanvas=t;}render(t,e){"hidden"!==t.parsedStyle.visibility&&(this.renderTextAssist(t,e),t.controls&&t.context.renderControls());}renderTextAssist(t,e){e.save(),e.globalCompositeOperation=t.parsedStyle.renderBlendMode,e.globalAlpha=t.parsedStyle.opacity;const{background:i,borderColor:s,borderWidth:n}=t.parsedStyle;if("annotationHighlight"===t.shapeType?(e.fillStyle=i.formatted,e.beginPath(),t.lines.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath()):(e.lineWidth=n.value,e.strokeStyle=s.formatted,"annotationStrikeout"===t.shapeType?(e.beginPath(),t.lines.forEach((t=>{let{left:i,top:s,width:n,height:o}=t;e.moveTo(i,s+o/2),e.lineTo(i+n,s+o/2);})),e.closePath(),e.stroke()):(e.beginPath(),t.lines.forEach((t=>{let{left:i,top:s,width:o,height:r}=t;e.moveTo(i,s+r-n.value/2),e.lineTo(i+o,s+r-n.value/2);})),e.closePath(),e.stroke())),t.context.isActive){e.globalAlpha=1;const{ctrlBorderRadius:i,ctrlBorderWidth:s,ctrlBorderColor:n,ctrlHeight:o,ctrlWidth:r,ctrlBackground:a,ctrlLineDash:l}=t.context.parsedControlsStyle,h=t.getScale().x,{left:c,top:d,width:u,height:p}=t.bounds;if(e.strokeStyle=n,e.fillStyle=a,e.lineWidth=s/h,e.setLineDash(Jn(l)?[0,0]:l),e.strokeRect(c,d,u,p),t.context.controlsFlags.enableEdit&&!t.context.isGrouped){const s=i/h,n=[];if(!t.isOutOfCropBox){if(t.startCharRect){const{startCharRect:e}=t;n.push({x:e.left+e.width/2-r/2/h,y:e.top-o/h});}if(t.endCharRect){const{endCharRect:e}=t;n.push({x:e.left+e.width/2-r/2/h,y:e.top+e.height});}}0===i?n.forEach((t=>{e.beginPath(),e.rect(t.x,t.y,r/h,o/h),e.closePath(),a&&e.fill(),e.stroke();})):n.forEach((t=>{e.beginPath();const{PI:i}=Math;e.arc(t.x+s,t.y+s,s,i,3*i/2),e.arc(t.x+r/h-s,t.y+s,s,3*i/2,2*i),e.arc(t.x+r/h-s,t.y+o/h-s,s,0,i/2),e.arc(t.x+s,t.y+o/h-s,s,i/2,i),e.closePath(),a&&e.fill(),e.stroke();}));}}e.restore();}}class wc{init(t){[{name:"annotationArc",renderer:new nc(t)},{name:"annotationCircle",renderer:new oc(t)},{name:"annotationEllipse",renderer:new rc(t)},{name:"annotationLine",renderer:new ac(t)},{name:"annotationImage",renderer:new hc(t)},{name:"annotationInk",renderer:new cc(t)},{name:"annotationPolygon",renderer:new dc(t)},{name:"annotationPolyline",renderer:new uc(t)},{name:"annotationRect",renderer:new pc(t)},{name:"annotationFreeText",renderer:new fc(t)},{name:"annotationGroup",renderer:new lc(t)},{name:"annotationStamp",renderer:new gc(t)},{name:"annotationControls",renderer:new vc(t)},{name:"annotationLineControls",renderer:new yc(t)},{name:"annotationHighlight",renderer:new xc(t)},{name:"annotationUnderline",renderer:new xc(t)},{name:"annotationStrikeout",renderer:new xc(t)}].forEach((e=>{let{name:i,renderer:s}=e;t.contextService.registerShapeRenderer(i,s);})),t.renderingService.hooks.beforeRender.on((t=>{if(t instanceof Ch&&t.linesDirty){const s=t.lines;if(t.calculateTextLines(),t.pathDirty=!0,t.boundsDirty=!0,"freeTextWriter"===t.textType)if(s.length){const e=t.getPosition(),i=t.getOrigin();t.updateOrigin();const s=t.getOrigin();i.x===s.x&&i.y===s.y||(t.setPosition({...e}),t.hooks.positionUpdated.emit());}else t.updateOrigin();var e,i;if(t.getPath(),null!=t&&t.textEditEventHandler)null==t||null===(e=t.textEditEventHandler)||void 0===e||e.calculateCharPosition(),null==t||null===(i=t.textEditEventHandler)||void 0===i||i.updateTextSelection(),null==t||t.updateCursor();t.linesDirty=!1;}}));}destroy(){}}function bc(t,e,i){var s;(i instanceof vh||i instanceof mh||i instanceof fh)&&t!==e&&(null===(s=i.context)||void 0===s||s.updateControls());}function Sc(t,e,i){t!==e&&i.childNodes.length>0&&i.childNodes.forEach((t=>{t&&t.style&&(t.style.opacity=e);}));}function Cc(t,e,i){var s;(i instanceof xh||i instanceof kh||i instanceof Dh)&&t!==e&&(null===(s=i.context)||void 0===s||s.updateControls());}function Pc(t,e,i){if(!(i instanceof kh||i instanceof Dh||i instanceof Rh||i instanceof xh))return;if(t===e)return;const{left:s,top:n}=i.getBoundingRect();i.updatePosition(s,n),i.updateOrigin();}function Tc(t,e,i){var s;(i instanceof wh||i instanceof Ch)&&t!==e&&(null===(s=i.context)||void 0===s||s.updateControls());}function Ac(t,e,i){var s;i instanceof Rh&&t!==e&&(null==i||null===(s=i.context)||void 0===s||s.updateControls());}function kc(t,e,i){i instanceof Ch&&t!==e&&(i.linesDirty||(i.textEditEventHandler.calculateCharPosition(),i.textEditEventHandler.updateTextSelection(),i.updateCursor(),i.hooks.reRenderText.emit()));}function Dc(t,e,i){i instanceof Ch&&t!==e&&(i.linesDirty||(i.textEditEventHandler.calculateCharPosition(),i.textEditEventHandler.updateTextSelection(),i.hooks.reRenderText.emit()));}function Rc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Bo.displayResolution;const i={left:0,top:0,width:t.imageWidth/t.imageXResolution*e,height:t.imageHeight/t.imageYResolution*e};return {fileIndex:0,mediaBox:i,cropBox:{...i},resource:{data:t.imageData,width:t.imageWidth,height:t.imageHeight,resolutionX:t.imageXResolution,resolutionY:t.imageYResolution,bitDepth:t.imageBitDepth}}}const Ec=new class extends Ro{async handler(t){const[e,i]=t.params;if(t.taskInfo.canceled)return null;const s=new wo;if(await s.initImage({source:e,isRGBA:i.sourceType===po.IT_RGBA,width:i.sourceWidth,height:i.sourceHeight,isBGRA:i.sourceType===po.IT_BGRA}),t.taskInfo.canceled)return s.terminate(),null;if(await s.crop(i.rect),t.taskInfo.canceled)return s.terminate(),null;if(await s.resize(i.width,i.height),t.taskInfo.canceled)return s.terminate(),null;const n=await s.getImage({ifDeleteObject:!0,isRGBA:!0,outputType:po.IT_RGBA,returnType:go.RT_BINARY});s.terminate();return {blobType:n.blobType,code:n.code,message:n.message,pageIndex:0,imageData:n.imageData,imageInfo:{imageWidth:n.imageWidth,imageHeight:n.imageHeight,imageXResolution:n.imageXResolution,imageYResolution:n.imageYResolution,imageType:n.imageType,curImageBitDepth:n.curImageBitDepth,imageBitDepth:n.imageBitDepth}}}};class Mc extends Ko{constructor(){super(),i(this,"type","imageParser"),i(this,"once",!1),i(this,"imgReader",void 0),i(this,"isDestroy",!1),i(this,"source",void 0),i(this,"parserOptions",void 0),i(this,"info",void 0),i(this,"rgba",void 0),i(this,"count",0),this.imgReader=new bo;}initParser(t,e){this.source={fileSource:t},e&&(this.parserOptions=e);}async getPageCount(){return 1}destroy(){var t;null===(t=this.imgReader)||void 0===t||t.destroy(),this.imgReader=null,this.source=null,this.isDestroy=!0;}async parse(){if(this.isDestroy)return null;const t=Rc(await this.imgReader.readImageInfo(this.source));return this.info={mediaBox:t.mediaBox,cropBox:t.cropBox,resolutionX:t.resource.resolutionX,resolutionY:t.resource.resolutionY,imageWidth:t.resource.width,imageHeight:t.resource.height},[t]}async parseAnnotations(t,e){return []}async getPage(){var t;if(this.isDestroy)return null;const e={"image/jpeg":po.IT_JPG,"image/png":po.IT_PNG,"image/bmp":po.IT_BMP},{outputType:i,jpegQuality:s,returnBase64:n}=null!==(t=this.parserOptions)&&void 0!==t?t:{},o=await this.imgReader.readImage({source:this.source,outputType:null!=i?i:e[this.source.fileSource.type],jpegQuality:s,returnType:n?go.RT_BASE64:go.RT_AUTO});if(o){return Rc(o)}return null}async getPageInternal(){var t;if(this.isDestroy)return;if(this.rgba)return;const{outputType:e,jpegQuality:i,returnBase64:s}=null!==(t=this.parserOptions)&&void 0!==t?t:{},n=await this.imgReader.readImage({source:this.source,outputType:po.IT_RGBA,jpegQuality:i,returnType:s?go.RT_BASE64:go.RT_AUTO});n&&(this.rgba=n.imageData);}cancelGetPage(t){var e;if(this.isDestroy)return;const{outputType:i}=null!==(e=this.parserOptions)&&void 0!==e?e:{};this.imgReader.cancelReadImage(this.source,i);}async renderPage(t,e,i){if(this.isDestroy||!this.source)return null;const s=this.info.resolutionX/Bo.dataResolution,n={left:t.rect[0]*s,top:t.rect[1]*s,width:(t.rect[2]-t.rect[0])*s,height:(t.rect[3]-t.rect[1])*s};if(n.top=this.info.imageHeight-n.top-n.height,n.left=Math.max(0,Math.min(Math.round(n.left),this.info.imageWidth-1)),n.top=Math.max(0,Math.min(Math.round(n.top),this.info.imageHeight-1)),n.width=Math.max(1,Math.min(Math.round(n.width),this.info.imageWidth-n.left)),n.height=Math.max(1,Math.min(Math.round(n.height),this.info.imageHeight-n.top)),this.rgba||await this.getPageInternal(),e.canceled)return null;this.count+=1;let o=await Ec.createTask("renderImage",[i||this.rgba,{sourceType:po.IT_RGBA,sourceWidth:this.info.imageWidth,sourceHeight:this.info.imageHeight,index:t.index,width:t.width,height:t.height,rect:n,outputType:t.outputType}],e);return this.count-=1,o}cancelRenderPage(t){!this.isDestroy&&this.source&&Ec.cancelTask("renderImage",[],t);}getPageTexts(t){return null}}class Ic{constructor(){i(this,"type","tiffParser"),i(this,"once",!1),i(this,"imgReader",void 0),i(this,"parserOptions",void 0),i(this,"source",void 0),i(this,"isDestroy",!1),i(this,"rgbas",[]),i(this,"infos",[]),this.imgReader=new bo;}initParser(t,e){this.source={fileSource:t},e&&(this.parserOptions=e);}async getPageCount(){return this.imgReader.getTiffPageCount(this.source)}destroy(){var t;null===(t=this.imgReader)||void 0===t||t.destroy(),this.imgReader=void 0,this.source=null,this.isDestroy=!0;}async parse(t){if(this.isDestroy||!this.source)return null;const e=await this.imgReader.readTiffPageInfo(this.source,t);t.forEach(((t,i)=>{this.infos[t]=e[i];}));return e.map((t=>{const e=Rc(t);return e.fileIndex=t.pageIndex,e}))}async parseAnnotations(t,e){return []}async getPage(t){var e;if(this.isDestroy||!this.source)return null;const{outputType:i,returnBase64:s}=null!==(e=this.parserOptions)&&void 0!==e?e:{},n=await this.imgReader.readTiffPage({source:this.source,index:t,outputType:i,returnType:s?go.RT_BASE64:go.RT_AUTO});if(n){const t=Rc(n);return t.fileIndex=n.pageIndex,t}return null}async getPageInternal(t){var e;if(this.isDestroy||!this.source)return;if(this.rgbas[t])return;const{outputType:i,returnBase64:s}=null!==(e=this.parserOptions)&&void 0!==e?e:{},n=await this.imgReader.readTiffPage({source:this.source,index:t,outputType:po.IT_RGBA,returnType:s?go.RT_BASE64:go.RT_AUTO});n&&(this.rgbas[t]=n.imageData);}cancelGetPage(t){!this.isDestroy&&this.source&&this.imgReader.cancelReadTiffPage(this.source,t);}async renderPage(t,e){if(this.isDestroy||!this.source)return null;const i=this.infos[t.index],s=i.imageXResolution/Bo.dataResolution,n={left:t.rect[0]*s,top:t.rect[1]*s,width:(t.rect[2]-t.rect[0])*s,height:(t.rect[3]-t.rect[1])*s};n.top=i.imageHeight-n.top-n.height,n.left=Math.max(0,Math.min(Math.round(n.left),i.imageWidth-1)),n.top=Math.max(0,Math.min(Math.round(n.top),i.imageHeight-1)),n.width=Math.max(1,Math.min(Math.round(n.width),i.imageWidth-n.left)),n.height=Math.max(1,Math.min(Math.round(n.height),i.imageHeight-n.top));let o=this.rgbas[t.index];if(o||(await this.getPageInternal(t.index),o=this.rgbas[t.index]),e.canceled)return null;return await Ec.createTask("renderImage",[o,{sourceType:po.IT_RGBA,sourceWidth:i.imageWidth,sourceHeight:i.imageHeight,index:t.index,width:t.width,height:t.height,rect:n,outputType:t.outputType}],e)}cancelRenderPage(t){!this.isDestroy&&this.source&&Ec.cancelTask("renderImage",[],t);}getPageTexts(t){return null}}function Bc(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=Br(t),n=e||1;if(Ls(s)&&s[0]&&s[0]instanceof kr){const t=s[0].value.steps,{length:e}=s[0].value.steps,n=[0,0,0];t.forEach((t=>{const e=Br(t.color);n[0]+=e.r,n[1]+=e.g,n[2]+=e.b;}));const o=[n[0]/e,n[1]/e,n[2]/e];return i&&(o[3]=255),o}const{r:o,g:r,b:a,alpha:l}=s,h=[o,r,a];return i&&(h[3]=Math.floor(l*n*255+.5)),h}function Uc(t,e){return {strokeColor:t?Bc(t,1,!1):null,fillColor:e?Bc(e,1,!1):null}}function Lc(t,e,i){let s,n;return s=t?Bc(t,i,!0):null,n=e?Bc(e,i,!0):null,{apStrokeColor:s,apFillColor:n}}function Oc(t,e,i){const s=t.value?t.value/i:0,n=Vc(e||[],i);return n.length?{width:s,style:"D",dash:n}:{width:s}}function Nc(t){const e=t.getLocalTransform().clone(),{a:i,b:s,c:n,d:o}=e;return [Kc(i),-Kc(s),-Kc(n),Kc(o),0,0]}function _c(t,e){const{min:i,max:s}=Math;let n=t[0][0],o=t[0][1],r=t[0][0],a=t[0][1];for(let e=1;e<t.length;e++){const l=t[e];n=i(n,l[0]),r=s(r,l[0]),a=i(a,l[1]),o=s(o,l[1]);}return n===r&&(n-=1,r+=1),a===o&&(a-=1,o+=1),[n-e/2,a-e/2,r+e/2,o+e/2]}function Wc(t,e,i,s,n,o){let r=arguments.length>6&&void 0!==arguments[6]&&arguments[6];const a=[],l=pa(e),h=r?i:i/2,c=[{x:l.left-h*s,y:l.bottom+h*n},{x:l.right+h*s,y:l.bottom+h*n},{x:l.right+h*s,y:l.top-h*n},{x:l.left-h*s,y:l.top-h*n}],d=t.getLocalTransform();return c.forEach((t=>{const e=d.transformPoint({x:t.x,y:t.y});a.push([e.x/s,o-e.y/n]);})),_c(a,0)}function Fc(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[],{length:s}=t;if(s>50&&e){const e=Math.floor(s/2),n=Math.floor(s/4);i.push(t[0][0],t[0][1]),i.push(t[n][0],t[n][1]),i.push(t[e][0],t[e][1]),i.push(t[s-n][0],t[s-n][1]),i.push(t[s-1][0],t[s-1][1]),i.push(t[0][0],t[0][1]);}else t.forEach((t=>{i.push(t[0],t[1]);}));return i}function Hc(t){const e=[];for(let i=0;i<t.length;i++){const s=[];t[i].forEach((t=>{s.push(t[0],t[1]);})),e.push(s);}return e}function Vc(t,e){if(!t)return [];if(2===t.length&&0===t[0]&&0===t[1])return [];return t.map((t=>t/e))}function zc(t){return Math.max(["butt","round","square"].indexOf(t),0)}function $c(t){return Math.max(["miter","round","bevel"].indexOf(t),0)}function jc(t){const e=[],i=t.getLocalTransform();return t.renderPath.forEach((t=>{const s=i.transformPoint({x:t.x,y:t.y});e.push({x:s.x,y:s.y});})),e}function Xc(t,e){const i=Br(t);let s=0,n=0,o=99999,r=99999;if(Ls(i)&&i[0]&&i[0]instanceof kr){const i=(t=>{const e=t.match(/(to\s+\w+\s+\w+)|(#\w+)/g);if(!e)return null;const i=e[0],s=e.slice(1);return {direction:i.replace(/\s+/g," ").trim(),colors:s.map((t=>t.trim()))}})(t);e.forEach((t=>{s=Math.max(s,t[0]),o=Math.min(o,t[0]),n=Math.max(n,t[1]),r=Math.min(r,t[1]);}));const a=[o,n,s,r];i.direction.includes("left")&&(a[0]=s,a[2]=o),i.direction.includes("top")&&(a[1]=r,a[3]=n);const l=Br(i.colors[0]),h=Br(i.colors[1]);return {coords:a,extend:[!0,!0],function:[{bounds:[],domain:[0,1],encode:[0,1],functions:[{c0:[l.r/255,l.g/255,l.b/255],c1:[h.r/255,h.g/255,h.b/255],domain:[0,1],n:1,type:"exponentialInterpolation"}],type:"stitching"}],shadingType:"axial",type:"shading"}}return null}function Gc(t){const e=t.map((t=>t.toLowerCase())),i=[];return e.includes("print")&&i.push("print"),e.includes("noview")&&i.push("noview"),e.includes("readonly")&&i.push("readonly"),i}function Yc(t,e,i,s,n){const{width:o,height:r}=t.parsedStyle;let a=o.value,l=r.value;if(t instanceof Ch){const{width:e,height:i}=t.getBoundingRect();a=e,l=i;}const{x:h,y:c}=t.getLocalPosition(),d=e/2,u=h/i,p=n-c/s,g=a/i,f=l/s;return [[u+d,p-f+d,2,!1],[u+g-d,p-f+d,0,!1],[u+g-d,p-d,0,!1],[u+d,p-d,0,!1],[u+d,p-f+d,0,!0]]}function qc(t,e,i,s){t.renderPath||t.getPath();const{renderPath:n}=t,o=[],{x:r,y:a}=t.getLocalPosition();let l=[];for(let t=0;t<n.length;t++){const{step:h,close:c}=n[t],d=(n[t].x+r)/e,u=s-(n[t].y+a)/i;0!==t?0!==h||0===t?2===h?l.push([d,u,1,c]):l.push([d,u,0,c]):(o.push(l),l=[],l.push([d,u,2,c])):l.push([d,u,2,c]);}return o.push(l),o}function Jc(t,e,i,s,n,o){let r=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],a=arguments.length>7&&void 0!==arguments[7]&&arguments[7];const{lineDash:l}=t.parsedStyle,h=Nc(t),c=_c(n,a?2*s:s),d=[];r&&d.push(Zc(t,n,e,i,s,Vc(l,o)));return {bbox:c,matrix:h,transform:c,objs:d,blendMode:id(t.style.renderBlendMode)||"Normal"}}function Zc(t,e,i,s,n,o){const{miterLimit:r,lineCap:a,lineJoin:l}=t.parsedStyle;return {dashArray:o,dashPhase:0,fillColor:i||[0,0,0,0],fillType:i?2:0,isStroke:n>0,lineCap:zc(a),lineJoin:$c(l),blendMode:id(t.style.renderBlendMode)||"Normal",lineWidth:n,miterLimit:r,objMatrix:[1,0,0,1,0,0],segments:e,strokeColor:s||[0,0,0,0],type:"path"}}function Qc(t,e,i,s){const{fontSize:n,fontFamily:o,fontWeight:r,fontStyle:a,opacity:l,text:h}=t.parsedStyle,{color:c,borderColor:d}=t.style,{x:u,y:p}=t.getLocalPosition(),{apStrokeColor:g,apFillColor:f}=Lc(d,c,l);return {type:"text",charSpace:0,wordSpace:0,fillColor:f||[0,0,0,255],strokeColor:g||[0,0,0,255],fontName:o,renderMode:0,fontIsBold:td(r),fontIsItalic:"italic"===a,fontSize:n.value/e,fontPitchFamily:16,text:h,position:[u/e,p/i],objMatrix:[1,0,0,1,u/e,s-p/i],blendMode:id(t.style.renderBlendMode)||"Normal"}}function Kc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;const i=t.toFixed(e);return Number.parseFloat(i)}function td(t){return "bold"===t||js(t)&&t>=600}function ed(t,e,i){return t.replace(new RegExp(e,"g"),i)}function id(t){return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()}function sd(t,e,i,s,n,o){const{segments:r,lineWidth:a,strokeColor:l,fillType:h,fillColor:c,dashArray:d,lineCap:u,lineJoin:p,miterLimit:g,isStroke:f,pattern:v}=t;let m=!1;if(o)for(let t=0;t<r.length;t++){const e=r[t];if(e[0]<o[0]||e[0]>o[2]||e[1]<o[1]||e[1]>o[3]){m=!0;break}}const y={type:"path",stampPoints:hd(r,i,s,n),borderWidth:f?(a||1)*i:0,borderColor:ud(l,e),background:h>0?ud(c,e):null,lineDash:pd(d,i),lineCap:cd(u),lineJoin:dd(p),miterLimit:g,clipped:m};return v&&(y.background=function(t,e,i,s){var n,o,r,a;const{coords:l,type:h}=t;if("shading"!==h)return null;const c={x:l[0]*e,y:s-l[1]*i},d={x:l[2]*e,y:s-l[3]*i},u=c.x<d.x?"right":"left",p=c.y===d.y?"":c.y<d.y?"bottom":"top";if(!t||null==t||!t.function||null==t||null===(n=t.function[0])||void 0===n||!n.functions)return null;let g=null==t||null===(o=t.function[0])||void 0===o||null===(o=o.functions[0])||void 0===o?void 0:o.c0,f=null==t||null===(r=t.function[0])||void 0===r||null===(r=r.functions[0])||void 0===r?void 0:r.c1;if(!g||!f)return null;const v=(null==t||null===(a=t.function[0])||void 0===a?void 0:a.encode)||[1,0];if(v[0]>v[v.length-1]){const t=f;f=g,g=t;}const m=`rgb(${255*g[0]},${255*g[1]},${255*g[2]})`,y=`rgb(${255*f[0]},${255*f[1]},${255*f[2]})`;return `linear-gradient(to ${u} ${p}, ${Mr(m)}, ${Mr(y)})`}(v,i,s,n)||y.background),y}function nd(t,e,i,s,n){const{text:o,renderMode:r,fontIsBold:a,fontIsItalic:l,fillColor:h,fontSize:c,fontName:d,strokeColor:u,objMatrix:p}=t,g=ur.create(p),{scale:f}=g.decompose(),v=function(t,e,i,s,n,o){const r=rd(t,e,o),a=r[0],l=r[1];return [a*i,(n-l)*s]}(p[4],p[5],i,s,n,[1,0,0,1,0,0]);return {type:"text",text:o,color:ud(h,e),borderWidth:r?i:"0px",borderColor:ud(u,e),fontWeight:a?"bold":"normal",fontStyle:l?"italic":"normal",fontSize:c*i*Math.abs(f.x),fontFamily:d,textBaseLine:"alphabetic",x:v[0],y:v[1]}}function od(t,e,i){const s=function(t,e){const i=t.replace(/[^A-Za-z0-9\+\/]/g,""),s=i.length,n=e?Math.ceil((3*s+1>>>2)/e)*e:3*s+1>>>2,o=new Uint8Array(n);for(let t,e,r=0,a=0,l=0;l<s;l++)if(e=3&l,r|=fd(i.charCodeAt(l))<<18-6*e,3===e||s-l==1){for(t=0;t<3&&a<n;t++,a++)o[a]=r>>>(16>>>t&24)&255;r=0;}return o}(t),n=new ImageData(new Uint8ClampedArray(s),e,i);let o=document.createElement("canvas");o.width=e,o.height=i;o.getContext("2d").putImageData(n,0,0);const r=o.toDataURL();return o=null,r}function rd(t,e,i){return [i[0]*t+i[2]*e+i[4],i[1]*t+i[3]*e+i[5]]}function ad(t,e,i,s,n,o){let r=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],a=!(arguments.length>7&&void 0!==arguments[7])||arguments[7];const l=ur.create(i),h=l.decompose(),c={x:(e[2]+e[0])/2,y:(e[1]+e[3])/2},d=(e[2]-e[0])/2,u=(e[1]-e[3])/2,p=l.transformPoint(c),g={x:(p.x-d)*s,y:(o-p.y+u)*n},f=-h.rotation,v={x:h.scale.x,y:h.scale.y};let m=g;var y;r&&(m=null!==(y=function(t,e,i,s,n,o){let r=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const a=[];let l=!0;if(t.forEach((t=>{let i;"path"===t.type?(i=sd(t,1,s,n,o,e),l=!1,r||(i.clipped=!1)):"text"===t.type&&(i=nd(t,1,s,n,o),l=!1),i&&a.push(i);})),l)return null;if(a.length){const t=function(t,e,i,s,n){const o={x:e[0]*i,y:(n-e[3])*s},r=[],a=[];if(t.forEach((t=>{if("path"!==t.type)return;if(t.clipped)return;const{borderWidth:e,stampPoints:i,lineCap:s}=t;if(2===i.length){const t=xa(i[0],i[1],Cr(e).value,s);r.push(t.left,t.left+t.width),a.push(t.top,t.top+t.height);}else {const t=pa(i),s=Cr(e).value/2,n=t.left-s,o=t.top-s,l=t.width+2*s,h=t.height+2*s;r.push(n,n+l),a.push(o,o+h);}})),0===r.length)return {offsetX:0,offsetY:0};const l=Math.min(...r),h=Math.min(...a);return {offsetX:l-o.x,offsetY:h-o.y}}(a,e,s,n,o);i.x+=t.offsetX,i.y+=t.offsetY;}return i}(t,e,{...g},s,n,o,a))&&void 0!==y?y:m);return {position:m,angle:f,scale:v}}function ld(t,e,i,s){const n=[];return t.forEach((t=>{n.push({x:t[0]*e,y:(s-t[1])*i});})),n}function hd(t,e,i,s){const n=[];return t.forEach((t=>{const o=t[0],r=t[1];n.push({x:o*e,y:(s-r)*i,step:t[2],close:t[3]});})),n}function cd(t){return ["butt","round","square"][null!=t?t:0]}function dd(t){return ["miter","round","bevel"][null!=t?t:0]}function ud(t,e){if(!t)return null;if((null==t?void 0:t.length)<3)return null;if(4===(null==t?void 0:t.length)){const i=0===e?255:t[3];return `rgba(${t.slice(0,3).join()},${i/255/(e||1)})`}return `rgb(${t.join()})`}function pd(t,e){if(!t||0===t.length)return [0,0];return t.map((t=>t*e))}function gd(t){if(!Ls(t))return [null];let e=[];for(let i=0;i<t.length;i++)t[i]instanceof Array?e=e.concat(gd(t[i])):e.push(Ns(t[i]));return e}function fd(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:43===t?62:47===t?63:0}function vd(t,e){if(!t)return "";let i="";return t.split(";").forEach((t=>{const s=t.split(":");s[0].trim()===e&&(i=s[1].trim());})),i}function md(t){if(!t)return {contents:[],textStyle:{}};const e=new DOMParser,i='xmlns="http://www.w3.org/1999/xhtml"';let s=t;t.includes('xmlns="')||(s=t.replace(/<body/,`<body ${i}`)),s=ed(s,'xmlns=""',i);const n=e.parseFromString(s,"text/xml"),o=n.getElementsByTagName("body")[0],r=n.getElementsByTagName("span"),a=n.getElementsByTagName("p"),l=t=>{for(const e in t)null!==t[e]&&void 0!==t[e]&&""!==t[e]||delete t[e];return t},{color:h,fontFamily:c,fontSize:d,fontWeight:u,fontStyle:p,textDecoration:g}=o.style,f=l({color:h,fontFamily:c,fontSize:d,fontWeight:u,fontStyle:p,lineThrough:g.includes("line-through"),underline:g.includes("word")||g.includes("underline")}),v=[],m=t=>{for(let e=0;e<t.length;e++){const i=t[e],{color:s,fontFamily:n,fontSize:o,fontStyle:r,fontWeight:a}=i.style||{},h=vd(i.getAttribute("style"),"text-decoration"),c=l({content:i.textContent,color:s,fontFamily:n,fontSize:o,fontWeight:a,fontStyle:r,lineThrough:h.includes("line-through")||void 0,underline:h.includes("word")||h.includes("underline")||void 0});v.push(c);}};return r.length?m(r):m(a),{textStyle:f,contents:v}}function yd(t,e,i){if(1!==Math.abs(e[0])||1!==Math.abs(e[3])||0!==Math.abs(e[4])||0!==Math.abs(e[5])){const s=rd(i[0],i[1],e),n=rd(i[2],i[3],e);t.forEach((t=>{t.segments.forEach((t=>{const i=rd(t[0],t[1],e);t[0]=i[0],t[1]=i[1];}));})),i[0]=s[0],i[1]=s[1],i[2]=n[0],i[3]=n[1];for(let t=0;t<6;t++)e[t]=0===t||3===t?1:0;}}function xd(t,e,i,s,n,o){var r;const{objs:a}=t||{},l=t&&(null==a?void 0:a.length)>0&&"path"===a[0].type,h=l?a[0]:null,c=(l?h.strokeColor:e)||[0,0,0],d=(l?h.fillColor:i)||null,u=l?h.fillType>0:!Un(d),p=ud(c,s),g=d?ud(d,s):"",f=pd(l?h.dashArray:null==n?void 0:n.dash,o),v=cd(l?h.lineCap:0),m=dd(l?h.lineJoin:0),y=l?h.miterLimit:10;let x=(null!==(r=null==n?void 0:n.width)&&void 0!==r?r:1)*o||0;var w;l&&(x=(null!==(w=null==h?void 0:h.lineWidth)&&void 0!==w?w:1)*o||0);return {useObj:l,hasFill:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,borderWidth:x}}class wd{constructor(){i(this,"pageWidth",void 0),i(this,"pageHeight",void 0),i(this,"ratioX",0),i(this,"ratioY",0);}setParserConfig(t,e,i,s){this.pageWidth=t,this.pageHeight=e,this.ratioX=i,this.ratioY=s;}parseAnnotation(t){let e=null;switch(t.type){case"Square":e=this.parseRect(t);break;case"Circle":e=this.parseCircle(t);break;case"Line":e=this.parseLine(t);break;case"Polygon":e=this.parsePolygon(t);break;case"PolyLine":e=this.parsePolyline(t);break;case"Ink":e=this.parseInk(t);break;case"FreeText":e=t.intent&&"freetext"!==t.intent.toLocaleLowerCase()?"freetexttypewriter"===t.intent.toLocaleLowerCase()?this.parseFreeText(t):this.parseIncomplete(t):this.parseTextBox(t);break;case"Stamp":e=this.parseStamp(t);break;case"Highlight":e=this.parseTextAssist(t,"highlight");break;case"StrikeOut":e=this.parseTextAssist(t,"strikeout");break;case"Underline":e=this.parseTextAssist(t,"underline");break;case"Widget":e=this.parseUnknown(t);break;default:e=t.normalAppearance?this.parseIncomplete(t):this.parseUnknown(t);}if(e||(t.normalAppearance?(e=this.parseIncomplete(t),e||(e=this.parseUnknown(t))):e=this.parseUnknown(t)),e){var i;const{opacity:s}=t,n=e.style;if(e.raw=t,n.opacity=js(n.opacity)?n.opacity:null!=s?s:1,null!=t&&t.normalAppearance){const{blendMode:i}=t.normalAppearance;e.style.renderBlendMode=i.toLowerCase();}null!==(i=e)&&void 0!==i&&i.transform&&e.transform.angle<0&&(e.transform.angle+=360),e.uid=qs();}return e}isSegmentsRect(t){if(5!==t.length&&4!==t.length)return !1;if(5===t.length&&(t[0][0]!==t[4][0]||t[0][1]!==t[4][1]))return !1;if(t[0][0]===t[2][0]&&t[0][1]===t[2][1]||t[1][0]===t[3][0]&&t[1][1]===t[3][1])return !1;for(let e=1;e<t.length;e++)if(0!==t[e][2])return !1;for(let e=1;e<t.length;e++)if(t[e][0]!==t[e-1][0]&&t[e][1]!==t[e-1][1])return !1;return t[0][0]===t[3][0]||t[0][1]===t[3][1]}parseRect(t){const{normalAppearance:e,interiorColor:i,borderStyle:s,opacity:n,color:o,rect:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this,{useObj:c,hasFill:d,borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,borderWidth:m}=xd(e,o,i,n,s,a);let y=null,x=0,w=0,b=0,S=0;if(e){const{bbox:t,objs:i,transform:n}=e,{position:o,angle:r,scale:d}=ad(i||null,t,n,a,l,h,!(null==i||!i.length));if(b=o.x,S=o.y,y={angle:r,scale:d},c){const{lineWidth:t,segments:e}=i[0];if(!this.isSegmentsRect(e))return null;x=(e[1][0]-e[0][0]+t)*this.ratioX,w=(e[2][1]-e[0][1]+t)*this.ratioY;}else {var C,P;x=(t[2]-t[0]-(null!==(C=null==s?void 0:s.width)&&void 0!==C?C:1))*this.ratioX,w=(t[3]-t[1]-(null!==(P=null==s?void 0:s.width)&&void 0!==P?P:1))*this.ratioY;}}else {var T,A,k,D;b=(r[0]+(null!==(T=null==s?void 0:s.width)&&void 0!==T?T:1)/2)*this.ratioX,S=(h-r[3]+(null!==(A=null==s?void 0:s.width)&&void 0!==A?A:1)/2)*this.ratioY,x=(r[2]-r[0]-(null!==(k=null==s?void 0:s.width)&&void 0!==k?k:1))*this.ratioX,w=(r[3]-r[1]-(null!==(D=null==s?void 0:s.width)&&void 0!==D?D:1))*this.ratioY;}return {type:"rectangle",style:{x:b,y:S,width:x,height:w,borderWidth:m,borderColor:u,background:d?p:"",lineDash:g,lineCap:f,lineJoin:v},iconColor:d?p:u,transform:y}}parseCircle(t){const{normalAppearance:e,interiorColor:i,borderStyle:s,opacity:n,color:o,rect:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this,{objs:c}=e||{},{hasFill:d,borderColor:u,background:p,lineDash:g,borderWidth:f}=xd(e,o,i,n,s,a);let v=null,m=0,y=0,x=0,w=0;if(e){const{bbox:t,transform:i}=e,{position:s,angle:n,scale:o}=ad(c||null,t,i,a,l,h,!(null==c||!c.length));x=s.x,w=s.y,v={angle:n,scale:o},m=(t[2]-t[0])*this.ratioX,y=(t[3]-t[1])*this.ratioY;}else x=r[0]*this.ratioX,w=(h-r[3])*this.ratioY,m=(r[2]-r[0])*this.ratioX,y=(r[3]-r[1])*this.ratioY;return {type:"ellipse",style:{x:x,y:w,width:m,height:y,borderWidth:f,borderColor:u,background:d?p:"",lineDash:g},transform:v,iconColor:d?p:u}}parseLine(t){if(null!=t&&t.intent&&"linedimension"===t.intent.toLocaleLowerCase())return null;const{normalAppearance:e,interiorColor:i,borderStyle:s,lineEnding:n,opacity:o,color:r,line:a}=t,{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{useObj:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,borderWidth:x}=xd(e,r,i,o,s,l);let w,b={x:a[0]*this.ratioX,y:(this.pageHeight-a[1])*this.ratioY},S={x:a[2]*this.ratioX,y:(this.pageHeight-a[3])*this.ratioY};if(e){const{bbox:t}=e,{transform:i}=e;if(u){const{segments:e}=d[0];yd(d,i,t),b={x:e[0][0]*this.ratioX,y:(this.pageHeight-e[0][1])*this.ratioY},S={x:e[1][0]*this.ratioX,y:(this.pageHeight-e[1][1])*this.ratioY};}const{position:s,angle:n,scale:o}=ad(gd(d),t,i,l,h,c,!(null==d||!d.length));w={position:s,scale:o,angle:n};}return {type:"line",style:{startPoint:b,endPoint:S,lineEnding:n||["None","None"],borderColor:p,borderWidth:x,background:g||"",lineCap:v,lineJoin:m,lineDash:f,miterLimit:y},transform:w,iconColor:p}}parsePolygon(t){const{normalAppearance:e,interiorColor:i,borderStyle:s,opacity:n,color:o,vertices:r,intent:a}=t;if(a&&["polygondimension","polygoncloud"].includes(a.toLocaleLowerCase()))return null;const{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{hasFill:u,borderColor:p,background:g,lineDash:f,lineCap:v,lineJoin:m,miterLimit:y,useObj:x,borderWidth:w}=xd(e,o,i,n,s,this.ratioX);let b,S;if(x){const{bbox:t}=e,{transform:i}=e;yd(d,i,t),b=ad(gd(d),t,i,l,h,c,!1);const{segments:s}=d[0];S=ld(s,this.ratioX,this.ratioY,this.pageHeight);}else {const t=[];for(let e=0;e<r.length;e+=2)t.push([r[e],r[e+1]]);S=ld(t,this.ratioX,this.ratioY,this.pageHeight);}var C,P;return S.length>2&&(C=S[0],P=S[S.length-1],C.x===P.x&&C.y===P.y)&&S.pop(),{type:"polygon",style:{points:S,borderWidth:w,borderColor:p,background:u?g:"",lineDash:f,lineCap:v,lineJoin:m,miterLimit:y},transform:b,iconColor:u?g:p}}parsePolyline(t){const{normalAppearance:e,interiorColor:i,opacity:s,color:n,vertices:o,borderStyle:r,intent:a}=t;if(a&&"polylinedimension"===a.toLocaleLowerCase())return null;const{ratioX:l,ratioY:h,pageHeight:c}=this,{objs:d}=e||{},{borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,miterLimit:m,useObj:y,borderWidth:x}=xd(e,n,i,s,r,this.ratioX);let w,b;if(y){const{bbox:t}=e,{transform:i}=e;yd(d,i,t),w=ad(gd(d),t,i,l,h,c,!1);const{segments:s}=d[0];b=ld(s,this.ratioX,this.ratioY,this.pageHeight);}else {const t=[];for(let e=0;e<o.length;e+=2)t.push([o[e],o[e+1]]);b=ld(t,this.ratioX,this.ratioY,this.pageHeight);}return {type:"polyline",style:{points:b,borderWidth:x,borderColor:u,background:p,lineDash:g,lineCap:f,lineJoin:v,lineEnding:t.lineEnding||["None","None"],miterLimit:m},transform:w,iconColor:u}}parseInk(t){const{normalAppearance:e,inkList:i,opacity:s,borderStyle:n,interiorColor:o,color:r}=t,{ratioX:a,ratioY:l,pageHeight:h}=this;if(!i)return null;const{borderColor:c,background:d,lineDash:u,lineCap:p,lineJoin:g,miterLimit:f,borderWidth:v}=xd(e,r,o,s,n,this.ratioX),m=[];for(let t=0;t<i.length;t++){const e=i[t],s=[];for(let t=0;t<e.length;t+=2){const i=e[t],n=e[t+1];s.push([i,n,1,!1]);}const n=ld(s,this.ratioX,this.ratioY,this.pageHeight);m.push(n);}let y=null;if(e){const{objs:t,transform:i,bbox:s}=e;for(let e=0;e<t.length;e++)if(!1===t[e].isStroke)return null;y=ad(gd(t),s,i,a,l,h,!(null==t||!t.length),!1);}return {type:"ink",style:{segments:m,borderWidth:v,borderColor:c,background:d,lineDash:u,lineCap:p,lineJoin:g,miterLimit:f},transform:y,iconColor:c}}parseFreeText(t){const{normalAppearance:e,richText:i,rect:s,defaultAppearanceData:n,defaultStyle:o}=t,{ratioX:r,ratioY:a,pageHeight:l}=this;let h,c,d,u,p=0;if(e){const{bbox:t,transform:i,objs:s}=e,{position:n,angle:o,scale:u}=ad(gd(s),t,i,r,a,l,s.length&&"path"===s[0].type);p=o,c=n.x,d=n.y,h={angle:p,scale:u};}else c=s[0]*this.ratioX,d=(l-s[3])*this.ratioY;(Math.round(p)+360)/90%2==0?(u=(s[2]-s[0])*this.ratioX,0===p&&(u+=12),u+c>this.pageWidth*this.ratioX&&(u=this.pageWidth*this.ratioX-c)):(u=(s[3]-s[1])*this.ratioY,u+c>this.pageHeight*this.ratioY&&(u=this.pageHeight*this.ratioY-c));const{fontName:g,fontSize:f,fontColor:v}=n,m={content:"",fontFamily:g,color:vd(o,"color")||`rgb(${v[0]},${v[1]},${v[2]})`,fontSize:f},y=md(i),x=[];y.contents.forEach((t=>{const e={...m,...y.textStyle,...t},i=Cr(e.fontSize);e.fontFamily=e.fontFamily.replace(/^"|"$/g,""),(js(e.fontSize)||"pt"===i.unit)&&(e.fontSize=i.value*this.ratioX),x.push(e);}));return {type:"textTypewriter",style:{x:c,y:d,width:u,textContents:x},transform:h,iconColor:m.color}}parseTextBox(t){const{normalAppearance:e,richText:i,defaultAppearanceData:s,defaultStyle:n,opacity:o,borderStyle:r,color:a,rect:l}=t,{ratioX:h,ratioY:c,pageHeight:d}=this,{hasFill:u,borderColor:p,background:g,borderWidth:f,lineDash:v,useObj:m}=xd(e,null==s?void 0:s.fontColor,a,o,r,h);let y,x,w,b,S;if(e&&e.objs.length){var C,P;const{bbox:t,transform:i,objs:s}=e,{position:n,angle:o,scale:a}=ad(gd(s),t,i,h,c,d,"path"===s[0].type);y=n.x,x=n.y,S={angle:o,scale:a};const{segments:l,lineWidth:u}=s[0];w=m&&"path"===s[0].type?(l[1][0]-l[0][0]+u)*this.ratioX:(t[2]-t[0]-(null!==(C=null==r?void 0:r.width)&&void 0!==C?C:1))*this.ratioX,b="path"===s[0].type?(l[2][1]-l[0][1]+u)*this.ratioY:(t[3]-t[1]-(null!==(P=null==r?void 0:r.width)&&void 0!==P?P:1))*this.ratioY;}else {var T,A,k,D;y=(l[0]+(null!==(T=null==r?void 0:r.width)&&void 0!==T?T:1)/2)*this.ratioX,x=(d-l[3]+(null!==(A=null==r?void 0:r.width)&&void 0!==A?A:1)/2)*this.ratioY,w=(l[2]-l[0]-(null!==(k=null==r?void 0:r.width)&&void 0!==k?k:1))*this.ratioX,b=(l[3]-l[1]-(null!==(D=null==r?void 0:r.width)&&void 0!==D?D:1))*this.ratioY;}const{fontName:R,fontSize:E}=s,M={content:"",fontFamily:R,fontSize:E},I=md(i);let B=vd(i,"text-align")||vd(n,"text-align");"justify-center"===B&&(B="justify");const U=[];if(I.contents.forEach((t=>{const e={...M,...I.textStyle,...t},i=Cr(e.fontSize);e.fontFamily=e.fontFamily.replace(/^"|"$/g,""),(js(e.fontSize)||"pt"===i.unit)&&(e.fontSize=i.value*this.ratioX),U.push(e);})),0===U.length&&t.contents){const e={...M,content:t.contents};js(e.fontSize)&&(e.fontSize*=this.ratioX),U.push(e);}return {type:"textBox",style:{x:y,y:x,width:w,height:b,borderWidth:f,borderColor:p,background:u?g:"",lineDash:v,textContents:U,textAlign:B},transform:S,iconColor:M.color}}parseStamp(t){const{icon:e,opacity:i,normalAppearance:s}=t;if(!s)return null;const{objs:n,transform:o,bbox:r}=t.normalAppearance;if(0===n.length)return null;const a=gd(n),l=[],{ratioX:h,ratioY:c,pageHeight:d}=this,{position:u,angle:p,scale:g}=ad(a,r,o,h,c,d),f={position:u,angle:p,scale:g};for(let t=0;t<a.length;t++){let e;if("path"===a[t].type&&(e=sd(a[t],i,this.ratioX,this.ratioY,this.pageHeight,r)),"text"===a[t].type&&(e=nd(a[t],i,this.ratioX,this.ratioY,this.pageHeight)),"image"===a[t].type){const e={type:"stamp",style:{imageData:a[t].jpegBase64?`data:image/jpeg;base64,${a[t].jpegBase64}`:od(a[t].RGBABase64,a[t].width,a[t].height),width:(a[t].rect[2]-a[t].rect[0])*this.ratioX,height:(a[t].rect[3]-a[t].rect[1])*this.ratioY},transform:f};return e.transform.position.x+=(a[t].rect[0]-r[0])*this.ratioX,e.transform.position.y-=(a[t].rect[3]-r[3])*this.ratioY,e}e&&l.push(e);}return {type:"stamp",style:{iconName:e,stampConfig:l},transform:f,iconColor:"#868E96"}}parseTextAssist(t,e){const{normalAppearance:i,opacity:s,color:n}=t;if(!i)return null;const o=1e-6;if(t.quadPoints)for(let e=0;e<t.quadPoints.length;e++)if(8===t.quadPoints[e].length&&(Math.abs(t.quadPoints[e][1]-t.quadPoints[e][3])>o||Math.abs(t.quadPoints[e][5]-t.quadPoints[e][7])>o))return null;const{objs:r,transform:a,bbox:l}=t.normalAppearance;if(!r||0===r.length){const i=ud(n,1);return {type:e,style:{annotationRaw:t,lines:[],borderColor:i,borderWidth:1,background:i,lineCap:"butt",lineJoin:"miter",lineDash:[0,0],miterLimit:10,opacity:s},transform:{angle:0,position:{x:0,y:0},scale:{x:1,y:1}}}}yd(r,a,l);const h=gd(r),c=[],{ratioX:d,ratioY:u,pageHeight:p}=this,g=ad(h,l,a,d,u,p,!1);for(let t=0;t<h.length;t++)if("path"===h[t].type){const e=sd(h[t],s,d,u,p);c.push(e);}if(0===c.length)return null;const f=[];let v=0;if(c.forEach((i=>{const s=[];let n=[];for(let t=0;t<i.stampPoints.length;t++)2===i.stampPoints[t].step&&n.length>0&&(s.push(n),n=[]),n.push(i.stampPoints[t]);n.length>0&&(s.push(n),n=[]);const r=i.borderWidth;for(let n=0;n<s.length;n++){const a=s[n],l=t.quadPoints[v];v+=1;const h=l[0]*d,c=(p-l[1])*u,g=l[2]*d,m=(p-l[5])*u;let y;if(i.quadPointsRect={left:h,top:c,width:g-h,height:m-c},"highlight"===e){const t=[];for(let e=0;e<a.length;e++)2===a[e].step?t.push({x:a[e].x,y:a[e].y}):1===a[e].step?e+2<a.length&&1===a[e+2].step&&(t.push({x:a[e+2].x,y:a[e+2].y}),e+=2):e>0&&!(Math.abs(a[e].x-a[e-1].x)<=o&&Math.abs(a[e].y-a[e-1].y)<=o)&&t.push({x:a[e].x,y:a[e].y});if(t.length>=4){let e=1/0,i=1/0,s=-1/0,n=-1/0;t.forEach((t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),s=Math.max(s,t.x),n=Math.max(n,t.y);})),y={left:e,top:i,width:s-e,height:n-i};}}else if("strikeout"===e){if(a.length>=2){const t=i.quadPointsRect.top,e=a[1].y;y={left:a[1].x>a[0].x?a[0].x:a[1].x,top:t,width:a[1].x>a[0].x?a[1].x-a[0].x:a[0].x-a[1].x,height:2*Math.abs(e-t)};}}else if("underline"===e&&a.length>=2){const t=2*(i.quadPointsRect.top+i.quadPointsRect.height/2)-(a[0].y+r/2);y={left:a[1].x>a[0].x?a[0].x:a[1].x,top:t,width:a[1].x>a[0].x?a[1].x-a[0].x:a[0].x-a[1].x,height:a[0].y+r/2-t};}y&&f.push(y);}})),0===f.length)return null;const m=c[0];return {type:e,style:{annotationRaw:t,lines:f,borderColor:m.borderColor,borderWidth:m.borderWidth,background:m.background||"",lineCap:m.lineCap,lineJoin:m.lineJoin,lineDash:m.lineDash,miterLimit:m.miterLimit},transform:g}}parseIncomplete(t){const{normalAppearance:e,opacity:i}=t;if(!e)return null;const{objs:s,transform:n,bbox:o}=t.normalAppearance;if(!s||0===s.length)return null;const r=gd(s),a=[],{ratioX:l,ratioY:h,pageHeight:c}=this,{position:d,angle:u,scale:p}=ad(r,o,n,l,h,c),g={position:d,angle:u,scale:p};for(let e=0;e<r.length;e++){let s;if("path"===r[e].type)s=sd(r[e],i,l,h,c);else if("text"===r[e].type)s=nd(r[e],i,l,h,c);else if("image"===r[e].type){let i;i=r[e].jpegBase64?`data:image/jpeg;base64,${r[e].jpegBase64}`:od(r[e].RGBABase64,r[e].width,r[e].height);const s={type:"incomplete",style:{imageData:i,width:(r[e].rect[2]-r[e].rect[0])*this.ratioX,height:(r[e].rect[3]-r[e].rect[1])*this.ratioY,annotationRaw:t},transform:g};return s.transform.position.x+=(r[e].rect[0]-o[0])*this.ratioX,s.transform.position.y-=(r[e].rect[3]-o[3])*this.ratioY,s}s&&a.push(s);}return {type:"incomplete",style:{stampConfig:a,annotationRaw:t},transform:g}}parseUnknown(t){return {type:"unknown",style:{annotationRaw:t}}}}class bd{constructor(){i(this,"map",new Map),i(this,"ratioX",Bo.displayResolution/Bo.pdfResolution),i(this,"ratioY",Bo.displayResolution/Bo.pdfResolution);}async toPdfAnnotations(t,e){const i=[],s=[...t];s.sort(((t,e)=>t.layer-e.layer));for(let t=0;t<s.length;t++){const n=s[t];if(n){const t=await this.toPdfAnnotation(n,{width:e.width/this.ratioX,height:e.height/this.ratioY});if(t){t.oriIndex=n.oriIndex,t.modified=n.modified;const{flags:e}=n,s=[];["noResize","noMove","noRotate"].forEach((t=>{e.includes(t)&&s.push(t);})),s.length&&(t.customData={...n.customData||{},dynamsoftFlags:s}),i.push(t);}}}return i}async toPdfAnnotation(t,e){if("stamp"===t.type&&t.style.imageData&&(!js(t.style.width)||!js(t.style.height))){const e=new bo,i=await e.readImageInfo({fileSource:t.style.imageData});let s=i.imageWidth,n=i.imageHeight;if(s>400||n>400){const t=Math.max(s/400,n/400);s/=t,n/=t;}t.style.width=s,t.style.height=n;}const i=this.createShape(t);let s=null;switch(t.type){case"rectangle":case"ellipse":s=this.toPdfRectOrEllipse(t,e,i);break;case"polyline":case"polygon":s=this.toPdfPolygonal(t,e,i);break;case"line":s=this.toPdfLine(t,e,i);break;case"ink":s=this.toPdfInk(t,e,i);break;case"stamp":s=await this.toPdfStamp(t,e,i);break;case"textBox":s=this.toPdfFreeText(t,e,i,"textBox");break;case"textTypewriter":s=this.toPdfFreeText(t,e,i,"freeTextWriter");break;case"highlight":s=this.toPdfTextAssist(t,"Highlight",e,i);break;case"underline":s=this.toPdfTextAssist(t,"Underline",e,i);break;case"strikeout":s=this.toPdfTextAssist(t,"StrikeOut",e,i);break;case"incomplete":case"unknown":s=t.style.annotationRaw;}return s&&(s.title=t.comment.author,s.subject=t.comment.subject,s.creationdate=t.comment.creationDate),i&&i.destroy(),s}toPdfRectOrEllipse(t,e,i){const{borderColor:s,background:n,lineDash:o}=t.style,{borderWidth:r,opacity:a}=i.parsedStyle,{strokeColor:l,fillColor:h}=Uc(s,n),{apStrokeColor:c,apFillColor:d}=Lc(s,n,a),u=Oc(r,o,this.ratioX),p=u.width,g="rectangle"===t.type?Yc(i,p,this.ratioX,this.ratioY,e.height):function(t,e,i,s){const{x:n,y:o}=t.getLocalPosition();t.path||t.getPath();const{path:r}=t,a=[];for(let t=0;t<r.length;t++){const l=(r[t].x+n)/e,h=s-(r[t].y+o)/i;0===t?(a.push([l,h,2,!1]),a.push([l,h,0,!1])):t===r.length-1?a.push([l,h,1,!0]):a.push([l,h,1,!1]);}return a}(i,this.ratioX,this.ratioY,e.height),f=Jc(i,d,c,p,g,this.ratioX);i.path||i.getPath();return {annotType:"SquareCircle",type:"rectangle"===t.type?"Square":"Circle",normalAppearance:f,interiorColor:h,color:l,borderStyle:u,opacity:a,rect:Wc(i,i.path,p,this.ratioX,this.ratioY,e.height),flags:Gc([...t.flags]),date:t.comment.modificationDate,name:t.uid,contents:""}}toPdfPolygonal(t,e,i){const{borderWidth:s,opacity:n}=i.parsedStyle,{borderColor:o,background:r,lineEnding:a,lineDash:l}=t.style,h="polyline"===t.type,{strokeColor:c,fillColor:d}=Uc(o,r),{apStrokeColor:u,apFillColor:p}=Lc(o,r,n),g=Oc(s,l,this.ratioX),f=g.width;let v,m,y;h?(v=qc(i,this.ratioX,this.ratioY,e.height),m=v.flat(),y=Fc(v[0])):(v=function(t,e,i,s){t.renderPath||t.getPath();const{x:n,y:o}=t.getLocalPosition(),{renderPath:r}=t,a=[];for(let t=0;t<r.length;t++){const l=(r[t].x+n)/e,h=s-(r[t].y+o)/i;if(0!==t){if(t===r.length-1){a.push([l,h,0,!0]);break}a.push([l,h,0,!1]);}else a.push([l,h,2,!1]);}return a}(i,this.ratioX,this.ratioY,e.height),m=v,y=Fc(m));const x=Jc(i,p,u,f,m,this.ratioX,!h,!0);if(h){const t=[];v.forEach((e=>{t.push(Zc(i,e,p,u,f,Vc(l,this.ratioX)));})),x.objs=t;}const w={annotType:"PolygonPolyLine",type:h?"PolyLine":"Polygon",borderStyle:g,color:c,interiorColor:d,normalAppearance:x,vertices:y,opacity:n,rect:Wc(i,i.renderPath,f,this.ratioX,this.ratioY,e.height,!0),name:t.uid,contents:"",flags:Gc([...t.flags]),date:t.comment.modificationDate};return h&&i.isLineArrow()&&(w.lineEnding=a),w}toPdfLine(t,e,i){const{borderWidth:s,opacity:n}=i.parsedStyle,{borderColor:o,background:r,lineEnding:a,lineDash:l}=t.style,{strokeColor:h,fillColor:c}=Uc(o,r),{apStrokeColor:d,apFillColor:u}=Lc(o,r,n),p=Oc(s,l,this.ratioX),g=p.width,f=qc(i,this.ratioX,this.ratioY,e.height),v=f.flat(),m=[];f.forEach((t=>{m.push(Zc(i,t,u,d,g,Vc(l,this.ratioX)));}));const y=Jc(i,u,d,g,v,this.ratioX,!1);y.objs=m;const x={annotType:"Line",type:"Line",line:[v[0][0],v[0][1],v[1][0],v[1][1]],interiorColor:c,color:h,normalAppearance:y,borderStyle:p,opacity:n,rect:Wc(i,i.renderPath,g,this.ratioX,this.ratioY,e.height),name:t.uid,contents:"",flags:Gc([...t.flags]),date:t.comment.modificationDate,toJsonString:()=>""};return i.isLineArrow()&&(x.lineEnding=a,x.intent="LineArrow"),x}toPdfInk(t,e,i){const{borderWidth:s,opacity:n}=i.parsedStyle,{borderColor:o,background:r,lineDash:a}=t.style,{strokeColor:l}=Uc(o,r),{apStrokeColor:h,apFillColor:c}=Lc(o,r,n),d=Oc(s,a,this.ratioX),u=d.width,p=function(t,e,i,s){t.inkOriginalRenderPath||t.getInkOriginalRenderPath();const{x:n,y:o}=t.getLocalPosition(),{inkOriginalRenderPath:r}=t,a=[];for(let t=0;t<r.length;t++){const l=r[t],h=[];for(let t=0;t<l.length;t++){const r=(l[t].x+n)/e,a=s-(l[t].y+o)/i;0===t?h.push([r,a,2,!1]):h.push([r,a,1,!1]);}if(h.length&&h.length<4)for(;h.length<4;){const t=h[h.length-1];h.push([...t]);}a.push(h);}return a}(i,this.ratioX,this.ratioY,e.height),g=p.flat(),f=[],{x:v,y:m}=i.getLocalPosition();i.getPath();const{inkRenderSteps:y}=i,x=[];y.forEach((t=>{const i=[];t.forEach(((t,s)=>{if(0===s){const s=(t.data[0].x+v)/this.ratioX,n=e.height-(t.data[0].y+m)/this.ratioY;i.push([s,n,2,!1]);}else t.data.forEach((t=>{const s=(t.x+v)/this.ratioX,n=e.height-(t.y+m)/this.ratioY;i.push([s,n,1,!1]);}));})),x.push(i);})),x.forEach((t=>{f.push(Zc(i,t,c,h,u,Vc(a,this.ratioX)));}));const w=Jc(i,c,h,u,g,this.ratioX,!1);w.objs=f;return {annotType:"Ink",type:"Ink",color:l,normalAppearance:w,borderStyle:d,opacity:n,inkList:Hc(p),rect:Wc(i,i.inkOriginalRenderPath.flat(),u,this.ratioX,this.ratioY,e.height),name:t.uid,contents:"",flags:Gc([...t.flags]),date:t.comment.modificationDate}}async toPdfStamp(t,e,i){const{imageData:s,iconName:n,opacity:o}=t.style;if(s){return await this.toPdfStampImage(t,e,i)}const r=i.childNodes,{segments:a,unClippedSegments:l}=function(t,e,i,s){const n=t.childNodes,o=[],r=[];for(let t=0;t<n.length;t++){if(!(n[t]instanceof Ya))continue;const a=[],{renderPath:l}=n[t],{x:h,y:c}=n[t].getLocalPosition();l.forEach(((t,n)=>{var o;const r=[(t.x+h)/e,s-(t.y+c)/i,t.step,null!==(o=t.close)&&void 0!==o&&o];n===l.length-1&&void 0===t.close&&(r[3]=!0),a.push(r);})),o.push(a),n[t].clipped||r.push(a);}return {segments:o,unClippedSegments:r}}(i,this.ratioX,this.ratioY,e.height),h=[],c=[];let d=0,u=0;for(let i=0;i<r.length;i++){let s;const n=r[i].parsedStyle.opacity;if(r[i].style.opacity=n/(t.style.opacity||1),r[i]instanceof Ya){if(!r[i].clipped){const t=jc(r[i]);c.push(...t);}const{borderWidth:t,lineDash:e}=r[i].parsedStyle,{borderColor:n,background:l}=r[i].style,{apStrokeColor:p,apFillColor:g}=Lc(n,l,o),f=Oc(t,e,this.ratioX).width,v=Xc(l,a[d]);u=Math.max(f,u),s=Zc(r[i],a[d],g,p,f,Vc(e,this.ratioX)),v&&(s.pattern=v),d+=1,h.push(s);}r[i]instanceof Ja&&(s=Qc(r[i],this.ratioX,this.ratioY,e.height),h.push(s));}const p=Jc(i,null,null,u,l.flat(),this.ratioX,!1);p.objs=h;return {annotType:"Stamp",type:"Stamp",icon:n,rect:Wc(i,c,u,this.ratioX,this.ratioY,e.height),normalAppearance:p,opacity:o,name:t.uid,contents:"",flags:Gc([...t.flags]),date:t.comment.modificationDate}}async toPdfStampImage(t,e,i){const{imageData:s,opacity:n}=t.style;let o=s,r=[];Xs(s)&&(r=s.split(","),r[0].match(/:(.*?);/)[1],o=function(t){let e=null;const i=t.split(","),s=i[0].match(/:(.*?);/)[1],n=window.atob(i[1]);let o=n.length;const r=new Uint8Array(o);for(;o--;)r[o]=n.charCodeAt(o);return e=new Blob([r],{type:s}),e}(s));const{width:a,height:l}=i.parsedStyle,h=Nc(i),c=[0,0,a.value/this.ratioX,l.value/this.ratioY],d=await async function(t,e,i,s){const{width:n,height:o}=t.parsedStyle,r=n.value/i,a=o.value/s;let l;if("image/jpeg"===e.type){const t=new bo,i=await t.readImage({source:{fileSource:e},outputType:po.IT_JPG,returnType:go.RT_BASE64});t.destroy(),l={type:"image",jpegBase64:i.imageData,objMatrix:[r,0,0,a,0,0],rect:[0,0,r,a]};}else {const t=new bo,i=await t.readImage({source:{fileSource:e},outputType:po.IT_RGBA,returnType:go.RT_BASE64});t.destroy(),l={type:"image",RGBABase64:i.imageData,height:i.imageHeight,width:i.imageWidth,objMatrix:[r,0,0,a,0,0],rect:[0,0,r,a]};}return l}(i,o,this.ratioX,this.ratioY),u=function(t,e,i,s){const{width:n,height:o}=t.parsedStyle,{x:r,y:a}=t.getLocalScale(),{x:l,y:h}=t.getLocalPosition(),c=t.getAngle(),d=l+n.value/2,u=h+o.value/2,p=n.value*r*.5,g=s*i-o.value*a*.5-u;let f=new Ga({style:{x:d-p,y:s*i-o.value*a-g,width:n.value*r,height:o.value*a}});f.setAngle(c),f.getPath();const v=Wc(f,f.path,0,e,i,s);return f=null,v}(i,this.ratioX,this.ratioY,e.height);return {annotType:"Stamp",type:"Stamp",normalAppearance:{bbox:c,matrix:h,objs:[d],transform:h},rect:u,opacity:n,name:t.uid,contents:"",flags:Gc([...t.flags]),date:t.comment.modificationDate}}toPdfFreeText(t,e,i,s){const{opacity:n,textContents:o,borderColor:r,background:a,lineDash:l,textAlign:h}=t.style;"freeTextWriter"===s&&(i.style.borderWidth=0);const{borderWidth:c}=i.parsedStyle,{strokeColor:d,fillColor:u}=Uc(r,a),{apStrokeColor:p,apFillColor:g}=Lc(r,a,n),f="textBox"===s?Oc(c,l,this.ratioX):{width:0},v=f.width,m=Jc(i,g,p,v,Yc(i,v,this.ratioX,this.ratioY,e.height),this.ratioX,"textBox"===s),y=function(t,e,i,s){const{lines:n}=t,{opacity:o}=t.parsedStyle,r=[],a=(t,e,i)=>({type:"path",strokeColor:t,fillColor:t,fillType:0,isStroke:!0,lineCap:0,lineJoin:0,miterLimit:10,lineWidth:i,objMatrix:[1,0,0,1,0,0],segments:e,dashArray:[],dashPhase:0});return n.forEach((n=>{const l=n.height/30,h=t.getTextAlignOffset(n);n.words.forEach((c=>{const{fontFamily:d,fontSize:u,fontStyle:p,fontWeight:g,color:f,underline:v,lineThrough:m}=c.style,y=Bc(f,1,!1),x=y?[...y,255*o]:[0,0,0,255],w=(c.x+h)/e,b=s-n.y/i,S={type:"text",charSpace:0,wordSpace:0,renderMode:0,fontPitchFamily:0,strokeColor:[0,0,0,255],fillColor:x,fontName:d,fontIsBold:td(g),fontIsItalic:"italic"===p,fontSize:u.value/e,text:(C=c.text,C.replace(/\r?\n?$/,"")),objMatrix:[1,0,0,1,w,b],position:[w,b],blendMode:id(t.style.renderBlendMode)||"Normal"};var C;if(r.push(S),v){const t=s-(n.y+l)/i,o=a(x,[[w,t,2,!1],[w+c.widthWithoutLf/e,t,0,!1]],l/i);r.push(o);}if(m){const t=s-(n.y-c.wordHeight/3)/i,o=a(x,[[w,t,2,!1],[w+c.widthWithoutLf/e,t,0,!1]],l/i);r.push(o);}}));})),r}(i,this.ratioX,this.ratioY,e.height);"textBox"===s?m.objs.push(...y):m.objs=y;const{defaultAppearance:x,defaultAppearanceData:w,defaultStyle:b}=function(t,e,i,s,n){const o=i[0]||{color:"rgb(0,0,0)",fontFamily:"Times Roman",fontStyle:"normal",fontWeight:"normal",fontSize:"12px"},{fontFamily:r,fontSize:a,fontStyle:l,fontWeight:h,color:c}=o,d=Bc(c,1,!1),u=Mr(`rgb(${d[0]}, ${d[1]}, ${d[2]})`),p=Cr(a).value/n,g=ed(r," ","");return {defaultAppearance:"textBox"===t?`${e[0]/255} ${e[1]/255} ${e[2]/255} rg /${g} ${p} Tf`:`${d[0]/255} ${d[1]/255} ${d[2]/255} rg /${g} ${p} Tf`,defaultStyle:`font:${"bold"===h?"bold":""} ${"italic"===l?"italic":""} '${r}' ${p}pt; text-align:${"justify"===s?"justify-center":s}; color:${u.toLocaleUpperCase()}`,defaultAppearanceData:{fontColor:d,fontSize:p,fontName:r}}}(s,d||[0,0,0],o,"freeTextWriter"===s?"left":h,this.ratioX);i.getPath();const S=Wc(i,i.path,v,this.ratioX,this.ratioY,e.height);let C="";o.forEach((t=>{C+=t.content;}));const P=function(t,e,i){if(!t||!t.length)return null;const s=document.implementation.createDocument(null,"body",null),n=s.documentElement;n.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),n.setAttribute("xmlns:xfa","http://www.xfa.org/schema/xfa-data/1.0/"),n.setAttribute("xfa:APIVersion","Acrobat:18.11.0"),n.setAttribute("xfa:spec","2.0.2");const o=t=>`font-size:${Cr(t).value/i}pt;`,r=t=>`font-weight:${"bold"===t?"bold":"normal"};`,a=t=>`font-style:${"italic"===t?"italic":"normal"};`,l=t=>`color:${Mr(Br(t).formatted)};`,h=t=>`font-family:'${t}';`,c=t[0],{fontFamily:d,fontSize:u,fontStyle:p,fontWeight:g,color:f}=c,v=Br(f),m=`${o(u)}text-align:${"justify"===e?"justify-center":e};${l(v.formatted)}${r(g)}${a(p)}${h(d)}font-stretch:normal;`;n.setAttribute("style",m);const y=s.createElement("p");y.setAttribute("dir","ltr"),t.forEach((t=>{if(!t.content.length)return;const e=s.createElement("span"),i=s.createTextNode(t.content);e.appendChild(i);let n="";d!==t.fontFamily&&(n+=h(t.fontFamily)),u!==t.fontSize&&(n+=o(t.fontSize)),p!==t.fontStyle&&(n+=a(t.fontStyle)),g!==t.fontWeight&&(n+=r(t.fontWeight)),f!==t.color&&(n+=l(t.color)),(t.lineThrough||t.underline)&&(n+=`text-decoration:${t.underline?"word":""} ${t.lineThrough?"line-through":""}`),n&&e.setAttribute("style",n),y.appendChild(e);})),n.appendChild(y);const x=`<?xml version="1.0"?>${(new XMLSerializer).serializeToString(s)}`,w='xmlns="http://www.w3.org/1999/xhtml"';return x.includes(w)?ed(x,'xmlns=""',w):ed(x.replace(/<body/,`<body ${w}`),'xmlns=""',w)}(o,h,this.ratioX),T={borderStyle:f,annotType:"FreeText",type:"FreeText",color:u,normalAppearance:m,defaultAppearance:x,defaultAppearanceData:w,defaultStyle:b,rect:S,name:t.uid,contents:C,opacity:n,flags:Gc([...t.flags]),date:t.comment.modificationDate};return "freeTextWriter"===s&&(T.intent="FreeTextTypeWriter"),P&&(T.richText=P),T}toPdfTextAssist(t,e,i,s){const{opacity:n,borderColor:o,background:r}=t.style,{lineDash:a,borderWidth:l,lineCap:h,lineJoin:c,miterLimit:d}=s.parsedStyle,{strokeColor:u,fillColor:p}=Uc(o,r),{apStrokeColor:g,apFillColor:f}=Lc(o,r,n),v="Highlight"===e?0:Oc(l,a,this.ratioX).width,m={blendMode:id(s.style.renderBlendMode),dashArray:Vc(a,this.ratioX),dashPhase:0,fillColor:f||[0,0,0,0],fillType:f||"Highlight"===e?2:0,isStroke:"Highlight"!==e&&v>0,lineCap:zc(h),lineJoin:$c(c),lineWidth:v,miterLimit:d,objMatrix:[1,0,0,1,0,0],segments:void 0,strokeColor:g||[0,0,0,0],type:"path"},y=[],x=[],w=[1/0,1/0,-1/0,-1/0],b=[];s.lines.forEach((t=>{const e=t.left/this.ratioX,n=(t.left+t.width)/this.ratioX,o=i.height-t.top/this.ratioY,r=i.height-(t.top+t.height)/this.ratioY;let a;"annotationHighlight"===s.shapeType?a=[[e,o,2,!1],[n,o,0,!1],[n,r,0,!1],[e,r,0,!1],[e,o,0,!0]]:"annotationUnderline"===s.shapeType?a=[[e,r+v/2,2,!1],[n,r+v/2,0,!1]]:"annotationStrikeout"===s.shapeType&&(a=[[e,(o+r)/2,2,!1],[n,(o+r)/2,0,!1]]),w[0]=Math.min(w[0],e),w[1]=Math.min(w[1],r),w[2]=Math.max(w[2],n),w[3]=Math.max(w[3],o),b.push(...a),x.push([e,o,n,o,e,r,n,r]);}));const S=Ns(m);S.segments=b,y.push(S);return {annotType:"TextMarkup",type:e,color:"Highlight"===e?p:u,rect:[...w],normalAppearance:{bbox:w,blendMode:id(s.style.renderBlendMode),matrix:[1,0,0,1,-w[0],-w[1]],objs:y,transform:[1,0,0,1,0,0]},opacity:n,quadPoints:x,name:t.uid,flags:Gc([...t.flags]),date:t.comment.modificationDate}}createShape(t){const{type:e,transform:i,style:s}=Ns(t),n={id:t.uid,style:s,transform:i};let o;switch("ellipse"===e&&(s.x+=s.width/2||0,s.y+=s.height/2||0,s.rx=s.width/2||s.rx,s.ry=s.height/2||s.ry),e){case"rectangle":o=new wh(n);break;case"ellipse":o=new mh(n);break;case"line":o=new Rh(n);break;case"ink":o=new xh(n);break;case"polygon":o=new kh(n);break;case"polyline":o=new Dh(n);break;case"textTypewriter":o=new Ch(n,"freeTextWriter",{});break;case"textBox":o=new Ch(n,"textBox");break;case"stamp":o=new Vh(n);break;case"highlight":o=new Yh(n);break;case"underline":o=new Jh(n);break;case"strikeout":o=new qh(n);}return o}}class Sd{constructor(){i(this,"annotationParser",new wd),i(this,"annotationWriter",new bd);}getParsedAnnotations(t,e,i){const s=Bo.displayResolution/Bo.pdfResolution;t=t.filter((t=>null!==t)),this.annotationParser.setParserConfig(e,i,s,s),this.moveAddReply(t);const n=[];return t.forEach(((t,e)=>{var i;if(t){const r=this.annotationParser.parseAnnotation(t);if(r){var s,o;switch(r.flags=this.parseFlags(t.flags||[]),null!=t&&null!==(s=t.customData)&&void 0!==s&&null!==(s=s.dynamsoftFlags)&&void 0!==s&&s.length&&r.flags.push(...t.customData.dynamsoftFlags),r.customData={...t.customData},t.type){case"Underline":case"Highlight":case"StrikeOut":r.flags.push("noMove","noRotate");break;case"FreeText":"freetexttypewriter"===(null==t||null===(i=t.intent)||void 0===i?void 0:i.toLocaleLowerCase())&&r.flags.push("noRotate","noResize");break;case"Line":case"Polygon":case"Polyline":r.flags.push("noRotate");}const a=this.parseReply(t);null!==(o=t.replies)&&void 0!==o&&o.length&&(a.replies=t.replies.map((t=>this.parseReply(t)))||[]),r.parsedOriIndex=e,r.comment=a,n.push(r);}}})),n}moveAddReply(t){t.forEach((e=>{if(e&&"Text"===e.type&&!_s(e.inreplyto)){const i=t[e.inreplyto];"Review"===e.statemodel?(i.reviewStates||(i.reviewStates=[]),i.reviewStates.push(e)):"Marked"===e.statemodel?(i.markedStates||(i.markedStates=[]),i.markedStates.push(e)):(i.replies||(i.replies=[]),i.replies.push(e));}})),t.slice().forEach((e=>{if(!e||"Popup"===e.type||!_s(e.inreplyto)){const i=t.findIndex((t=>t===e));t.splice(i,1);}}));}parseReply(t){var e,i;const s=this.parseCommon(t);return s.subject=t.subject,null!==(e=t.reviewStates)&&void 0!==e&&e.length&&(s.reviewStates=t.reviewStates.map((t=>this.parseState(t)))),null!==(i=t.markedStates)&&void 0!==i&&i.length&&(s.markedStates=t.markedStates.map((t=>this.parseState(t)))),s}parseFlags(t){const e=[],i={readonly:"readOnly",noview:"noView"};return t.forEach((t=>{e.push(i[t]||t);})),t.includes("hidden")&&!e.includes("noView")&&e.push("noView"),e}parseState(t){return {...this.parseCommon(t),state:t.state,stateModel:t.statemodel}}parseCommon(t){const e=t.creationdate,i=t.date;return {uid:qs(),author:t.title,contents:t.contents,type:t.type,creationDate:e||i,modifiedDate:i||e,flags:t.flags?[...t.flags]:[]}}parseDate(t){if(!t)return;let e=2;if(!t)return "";const i=[4,2,2,2,2,2].map((i=>{const s=t.slice(e,e+i);return e+=i,parseInt(s,10)}));i[1]-=1;const s=new Date(...i).getTime();return Ws("yyyy.MM.dd hh:mm:ss",s)}async getOriginalAnnotations(t,e){return await this.annotationWriter.toPdfAnnotations(t,e)}}var Cd,Pd;function Td(t){return {left:t[0],top:t[1],width:t[2]-t[0],height:t[3]-t[1]}}!function(t){t.CM_RENDERALL="cm/renderall",t.CM_IMAGEONLY="cm/imageonly",t.CM_AUTO="cm/auto";}(Cd||(Cd={})),function(t){t.NO_ANNOTATIONS="noAnnotations",t.RENDER_ANNOTATIONS="renderAnnotations",t.LOAD_ANNOTATIONS="loadAnnotations";}(Pd||(Pd={}));var Ad=new WeakSet;class kd{constructor(){v(this,Ad),i(this,"type","pdfParser"),i(this,"once",!1),i(this,"pdfReader",void 0),i(this,"parserOptions",{convertMode:Cd.CM_AUTO}),i(this,"source",void 0),i(this,"isDestroy",!1),i(this,"annotationMapper",void 0),i(this,"count",0),this.pdfReader=new Co,this.annotationMapper=new Sd;}initParser(t,e){this.parserOptions=null!=e?e:{convertMode:Cd.CM_AUTO},this.source={fileSource:t,password:this.parserOptions.password};}async getPageCount(){return this.pdfReader.getPdfPageCount(this.source,p(this,Ad,Dd).call(this))}destroy(){var t;null===(t=this.pdfReader)||void 0===t||t.destroy(),this.pdfReader=null,this.source=null,this.parserOptions=null,this.isDestroy=!0;}splitArrayIntoChunks(t,e){const i=[];for(let s=0;s<t.length;s+=e){const n=t.slice(s,s+e);i.push(n);}return i}async parseAnnotations(t,e){var i;const s=[];if(this.parserOptions.convertMode===Cd.CM_IMAGEONLY||(null===(i=this.parserOptions.renderOptions)||void 0===i?void 0:i.renderAnnotations)!==Pd.LOAD_ANNOTATIONS)return s;for(let i=0;i<t.length;i++){const n=e[t[i]],o=n.nativeMediaBox;if(1===n.realReadMode&&n.pdfOptions.annotCount>0){if(this.isDestroy)return [];const e=await this.pdfReader.readAnnotations(this.source,t[i]),r={pageUid:n.pageUid,fileIndex:t[i],annotations:[]};e.length&&(r.annotations=this.annotationMapper.getParsedAnnotations(e,2*o.left+o.width,2*o.top+o.height),n.pdfOptions.parsedAnnotCount=r.annotations.length,n.annotations=r.annotations),s.push(r);}}return s}async parse(t){const e=[],i=this.parserOptions.convertMode===Cd.CM_RENDERALL?[t]:this.splitArrayIntoChunks(t,100);for(let t=0;t<i.length;t++){const o=await this.pdfReader.readPageImageInfos({source:this.source,indices:i[t],readOptions:p(this,Ad,Dd).call(this),outputType:po.IT_JPG,isInfoOnly:!1,returnType:go.RT_BINARY}),{displayResolution:r,pdfResolution:a}=Bo;for(let t=0;t<o.length;++t){var s,n;const i=o[t];i.mediaBox[0]>i.mediaBox[2]&&([i.mediaBox[0],i.mediaBox[2]]=[i.mediaBox[2],i.mediaBox[0]]),i.mediaBox[1]>i.mediaBox[3]&&([i.mediaBox[1],i.mediaBox[3]]=[i.mediaBox[3],i.mediaBox[1]]),i.cropBox[0]>i.cropBox[2]&&([i.cropBox[0],i.cropBox[2]]=[i.cropBox[2],i.mediaBox[0]]),i.cropBox[1]>i.cropBox[3]&&([i.cropBox[1],i.cropBox[3]]=[i.cropBox[3],i.cropBox[1]]);const l=1===i.realReadMode,h=l?Td(i.mediaBox):{left:0,top:0,width:i.imageWidth/i.imageXResolution*a,height:i.imageHeight/i.imageYResolution*a},c=l?Td([i.cropBox[0],i.mediaBox[1]+i.mediaBox[3]-i.cropBox[3],i.cropBox[2],i.mediaBox[1]+i.mediaBox[3]-i.cropBox[1]]):{...h},d=Gn(h,a,r),u=Gn(c,a,r),p={fileIndex:i.pageIndex,rotation:i.rotation,mediaBox:d,cropBox:u,nativeMediaBox:h,nativeCropBox:c,resource:{width:i.imageWidth,height:i.imageHeight,resolutionX:i.imageXResolution,resolutionY:i.imageYResolution,bitDepth:i.imageBitDepth},pdfOptions:{convertMode:l?Cd.CM_RENDERALL:Cd.CM_IMAGEONLY,renderOptions:{renderAnnotations:null===(s=this.parserOptions.renderOptions)||void 0===s?void 0:s.renderAnnotations,renderGrayscale:null===(n=this.parserOptions.renderOptions)||void 0===n?void 0:n.renderGrayscale},rotation:i.rotation,mediaBox:{...d},cropBox:{...u},annotCount:i.annotCount},realReadMode:i.realReadMode,annotations:[]};e.push(p);}}return e}async getPage(t){if(this.isDestroy||!this.source)return null;const e=await this.pdfReader.readPage({source:this.source,index:t,readOptions:p(this,Ad,Dd).call(this),outputType:po.IT_JPG,isInfoOnly:!1,returnType:go.RT_AUTO});if(e&&0===e.code){const{displayResolution:t,pdfResolution:i}=Bo,s=e.imageInfos[0];return {fileIndex:e.pageIndex,rotation:e.rotation,mediaBox:Gn(Td(e.mediaBox),i,t),cropBox:Gn(Td(e.cropBox),i,t),resource:{data:e.imageData,width:s.imageWidth,height:s.imageHeight,resolutionX:s.imageXResolution,resolutionY:s.imageYResolution,bitDepth:s.imageBitDepth}}}return null}async renderPage(t,e){if(this.isDestroy||!this.source)return null;const i=p(this,Ad,Dd).call(this).renderOptions;this.count+=1;const s=await this.pdfReader.renderPage({source:this.source,index:t.index,width:t.width,height:t.height,rect:t.rect,renderOptions:i,outputType:t.outputType,isInfoOnly:!1,returnType:go.RT_BINARY},e);return this.count-=1,s}cancelRenderPage(t){!this.isDestroy&&this.source&&this.pdfReader.cancelRenderPage(t);}async getPageTexts(t){if(this.isDestroy||!this.source)return null;return await this.pdfReader.getCharInfos(this.source,(null==t?void 0:t.slice())||[])}cancelGetPage(t){!this.isDestroy&&this.source&&this.pdfReader.cancelReadPage(this.source,t);}}function Dd(){var t,e;if(this.isDestroy)return null;if(!this.parserOptions)return null;const i={[Pd.NO_ANNOTATIONS]:0,[Pd.RENDER_ANNOTATIONS]:1,[Pd.LOAD_ANNOTATIONS]:2};return {convertMode:{[Cd.CM_IMAGEONLY]:2,[Cd.CM_RENDERALL]:1,[Cd.CM_AUTO]:3}[(null===(t=this.parserOptions)||void 0===t?void 0:t.convertMode)||Cd.CM_AUTO],renderOptions:{...this.parserOptions.renderOptions||{},renderAnnotations:i[null===(e=this.parserOptions.renderOptions)||void 0===e?void 0:e.renderAnnotations]||0,renderIgnoreCrop:!0,ignorePageRotation:!0}}}class Rd{constructor(){i(this,"type","rgbaParser"),i(this,"once",!1),i(this,"processor",void 0),i(this,"cachePage",[]),i(this,"source",void 0),i(this,"parserOptions",void 0),i(this,"isDestroy",!1),this.processor=new wo;}initParser(t,e){this.source=t,this.parserOptions=e;}async getPageCount(){return 1}destroy(){var t;null===(t=this.processor)||void 0===t||t.terminate(),this.processor=void 0,this.source=null;}async parse(){var t;const{outputType:e,jpegQuality:i,returnBase64:s,width:n,height:o,bitDepth:r,xResolution:a,yResolution:l}=null!==(t=this.parserOptions)&&void 0!==t?t:{},h=await this.source.arrayBuffer();await this.processor.initImage({source:h,isRGBA:!0,width:n,height:o,isBGRA:!1});const c=await this.processor.getImage({jpegQuality:i,ifDeleteObject:!0,isRGBA:!0,bitDepth:r,xDpi:a,yDpi:l,outputType:e,returnType:go.RT_AUTO}),d=Rc(c);return c.srcBuffer,this.cachePage=[d],this.cachePage}async renderPage(t,e){var i;if(this.isDestroy||!this.source)return null;const s=this.parserOptions.xResolution/Bo.dataResolution,n={left:t.rect[0]*s,top:t.rect[1]*s,width:(t.rect[2]-t.rect[0])*s,height:(t.rect[3]-t.rect[1])*s},{width:o,height:r}=null!==(i=this.parserOptions)&&void 0!==i?i:{};n.top=r-n.top-n.height,n.left=Math.max(0,Math.min(Math.round(n.left),r-1)),n.top=Math.max(0,Math.min(Math.round(n.top),r-1)),n.width=Math.max(1,Math.min(Math.round(n.width),r-n.left)),n.height=Math.max(1,Math.min(Math.round(n.height),r-n.top));const a=await this.source.arrayBuffer();return await Ec.createTask("renderImage",[a,{sourceType:po.IT_RGBA,sourceWidth:o,sourceHeight:r,index:t.index,width:t.width,height:t.height,rect:n,outputType:t.outputType}],e)}cancelRenderPage(t){!this.isDestroy&&this.source&&Ec.cancelTask("renderImage",[],t);}async parseAnnotations(t,e){return []}async getPage(){return Promise.resolve(this.cachePage[0])}cancelGetPage(t){}getPageTexts(t){return null}}class Ed{constructor(){i(this,"db",void 0),this.db=new Map;}saveByMime(t,e){this.db.set(t,e);}hasByMime(t){return this.db.has(t)}deleteConstructorByMime(t){return !!this.hasByMime(t)&&(this.db.delete(t),!0)}getConstructorByMime(t){return this.db.get(t)}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}}const Md=new class{constructor(){i(this,"db",void 0),this.db=new Map;}saveByFileUid(t,e){this.db.set(t,e);}getParserByFileUid(t){return this.db.get(t)}deleteParserByFileUid(t){return this.db.delete(t)}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}getAllParsers(){return Array.from(this.db.values())}},Id=new Ed,Bd=new Ed,Ud=new class{constructor(){i(this,"db",void 0),this.db=new Map;}getDefaultOptionsByMime(t){return this.db.get(t)}deleteDefaultOptionsByMime(t){return this.db.delete(t)}saveDefaultOptionsByMime(t,e){this.db.set(t,e);}has(t){throw new Error("Method not implemented.")}save(t){throw new Error("Method not implemented.")}clear(){this.db.clear();}};const Ld=new class{constructor(t,e,s){i(this,"parserRepo",void 0),i(this,"parserConstructorRepo",void 0),i(this,"customParserConstructorRepo",void 0),this.parserRepo=t,this.parserConstructorRepo=e,this.customParserConstructorRepo=s;}getParser(t,e){let i=this.parserRepo.getParserByFileUid(t);if(i)return i;return i=new(this.customParserConstructorRepo.getConstructorByMime(e)||this.parserConstructorRepo.getConstructorByMime(e)),i.once||this.parserRepo.saveByFileUid(t,i),i}}(Md,Id,Bd);const Od=new class{constructor(t){i(this,"parserRepo",void 0),this.parserRepo=t;}execute(t){const e=this.parserRepo.getParserByFileUid(t);e&&(e.destroy(),this.parserRepo.deleteParserByFileUid(t));}}(Md),Nd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"parserRepo",void 0),this.parserService=t,this.parserRepo=e;}execute(t){const{fileData:e,mime:i,fileUid:s,indices:n}=t;let o=this.parserRepo.getParserByFileUid(s);return o||(o=this.parserService.getParser(s,i),o.initParser(e)),o.getPageTexts(n)}}(Ld,Md),_d=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"parserRepo",void 0),this.parserService=t,this.parserRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:s,fileIndex:n}=t;let o=this.parserRepo.getParserByFileUid(s);return o||(o=this.parserService.getParser(s,i),o.initParser(e)),o.getPage(n)}}(Ld,Md),Wd=new class{constructor(t){i(this,"parserRepo",void 0),this.parserRepo=t;}execute(t){let{fileIndex:e,fileUid:i}=t;const s=this.parserRepo.getParserByFileUid(i);s&&s.cancelGetPage(e);}}(Md),Fd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"parserRepo",void 0),this.parserService=t,this.parserRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:s,fileIndex:n}=t;let o=this.parserRepo.getParserByFileUid(s);return o||(o=this.parserService.getParser(s,i),o.initParser(e)),o.renderPage(t.config,t.task)}}(Ld,Md),Hd=new class{constructor(t){i(this,"parserRepo",void 0),this.parserRepo=t;}execute(t){let{task:e,fileUid:i}=t;e.canceled=!0;const s=this.parserRepo.getParserByFileUid(i);s&&s.cancelRenderPage(e);}}(Md),Vd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:s,indices:n}=t;let{parseOptions:o}=t;o=o||this.defaultParserOptionsRepo.getDefaultOptionsByMime(i);const r=this.parserService.getParser(s,i);return r.initParser(e,o),r.parse(n)}}(Ld,Ud),zd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){const{fileData:e,mime:i,fileUid:s,indices:n,parsedPages:o}=t;let{parseOptions:r}=t;r=r||this.defaultParserOptionsRepo.getDefaultOptionsByMime(i);return this.parserService.getParser(s,i).parseAnnotations(n,o)}}(Ld,Ud),$d=new class{constructor(t){i(this,"parserConstructorRepo",void 0),this.parserConstructorRepo=t;}execute(t){let{mime:e,parser:i}=t;this.parserConstructorRepo.saveByMime(e,i);}}(Id),jd=new class{constructor(t){i(this,"parserConstructorRepo",void 0),this.parserConstructorRepo=t;}execute(t){this.parserConstructorRepo.deleteConstructorByMime(t);}}(Bd),Xd=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){let{mime:e,parser:i}=t;this.customParserConstructorRepo.saveByMime(e,i);}}(Id),Gd=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){this.customParserConstructorRepo.deleteConstructorByMime(t);}}(Bd),Yd=new class{constructor(t){i(this,"defaultParserOptionsRepo",void 0),this.defaultParserOptionsRepo=t;}execute(t){return this.defaultParserOptionsRepo.getDefaultOptionsByMime(t)}}(Ud),qd=new class{constructor(t,e,s){i(this,"defaultParserOptionsRepo",void 0),i(this,"parserConstructorRepo",void 0),i(this,"customParserConstructorRepo",void 0),this.defaultParserOptionsRepo=t,this.parserConstructorRepo=e,this.customParserConstructorRepo=s;}execute(t){let{mime:e,options:i}=t;return !(!i||!Os(i)||!this.customParserConstructorRepo.hasByMime(e)&&!this.parserConstructorRepo.hasByMime(e))&&(this.defaultParserOptionsRepo.saveDefaultOptionsByMime(e,Ns(i)),!0)}}(Ud,Id,Bd),Jd=new class{constructor(t){i(this,"customParserConstructorRepo",void 0),this.customParserConstructorRepo=t;}execute(t){return this.customParserConstructorRepo.getConstructorByMime(t)}}(Bd),Zd=new class{constructor(t,e){i(this,"parserService",void 0),i(this,"defaultParserOptionsRepo",void 0),this.parserService=t,this.defaultParserOptionsRepo=e;}async execute(t){var e,i;let{fileData:s,mime:n,fileUid:o,options:r}=t;r=r||this.defaultParserOptionsRepo.getDefaultOptionsByMime(n);const a=this.parserService.getParser(o,n);a.initParser(s,r);return {pageCount:await a.getPageCount(),batchSize:null!==(e=null===(i=r)||void 0===i?void 0:i.batchSize)&&void 0!==e?e:0}}}(Ld,Ud);class Qd{constructor(){i(this,"type",void 0),i(this,"once",!1),i(this,"cachedPage",void 0),i(this,"parserOptions",void 0);}initParser(t,e){this.parserOptions=e;}async getPageCount(){return Promise.resolve(1)}destroy(){}async parse(){const{width:t,height:e,bitDepth:i,resolutionX:s,resolutionY:n}=this.parserOptions,o=Rc({imageBitDepth:i,imageHeight:e,imageWidth:t,imageXResolution:s,imageYResolution:n});return this.cachedPage=o,[this.cachedPage]}async parseAnnotations(t,e){return []}async getPage(){const t=await this.createBlankPage(this.parserOptions.width,this.parserOptions.height);return this.cachedPage.resource.data=t,this.cachedPage}cancelGetPage(){}async createBlankPage(t,e){var i,s,n;const o=new Uint8Array([255,255,255,255]),r=new wo;await r.initImage({source:o.buffer,isRGBA:!0,width:1,height:1,isBGRA:!1}),await r.resize(t,e);const a=await r.getImage({jpegQuality:null!==(i=this.parserOptions.jpegQuality)&&void 0!==i?i:80,ifDeleteObject:!0,isRGBA:!0,bitDepth:24,xDpi:null!==(s=this.parserOptions.resolutionX)&&void 0!==s?s:96,yDpi:null!==(n=this.parserOptions.resolutionY)&&void 0!==n?n:96,outputType:Mo[uo.JPEG],returnType:go.RT_BASE64});return new Blob([a.imageData],{type:a.blobType})}async renderPage(t,e){var i,s,n;const o=new Uint8Array([255,255,255,255]),r=new wo;await r.initImage({source:o.buffer,isRGBA:!0,width:1,height:1,isBGRA:!1}),await r.resize(t.width,t.height);const a=await r.getImage({jpegQuality:null!==(i=this.parserOptions.jpegQuality)&&void 0!==i?i:80,ifDeleteObject:!0,isRGBA:!0,bitDepth:24,xDpi:null!==(s=this.parserOptions.resolutionX)&&void 0!==s?s:96,yDpi:null!==(n=this.parserOptions.resolutionY)&&void 0!==n?n:96,outputType:po.IT_RGBA,returnType:go.RT_BASE64});return {imageInfo:{imageWidth:t.width,imageHeight:t.height},imageData:a.imageData,pageIndex:t.index}}cancelRenderPage(t){Ec.cancelTask("renderImage",[],t);}getPageTexts(t){return null}}var Kd;!function(t){t.GOOD="Good",t.AUTO_CAPTURE="AutoCaptured",t.SMALL_SIZE="SmallSize",t.OFF_CENTER="OffCenter",t.SKEW="Skew",t.NOTHING_DETECTED="NothingDetected";}(Kd||(Kd={}));var tu,eu=new WeakSet,iu=new WeakSet,su=new WeakSet,nu=new WeakSet,ou=new WeakSet,ru=new WeakSet,au=new WeakSet,lu=new WeakSet,hu=new WeakSet,cu=new WeakSet;class du{constructor(){v(this,cu),v(this,hu),v(this,lu),v(this,au),v(this,ru),v(this,ou),v(this,nu),v(this,su),v(this,iu),v(this,eu),i(this,"detector",void 0),i(this,"succeedDetect",0),i(this,"failedDetect",0),i(this,"autoCaptureStartTime",0),this.succeedDetect=0,this.failedDetect=0;}destroy(){this.clear();}clear(){var t;null===(t=this.detector)||void 0===t||t.terminate(),this.detector=void 0;}async detect(t,e){return Promise.resolve({success:!1})}getStatusMsg(t){switch(t){case Kd.AUTO_CAPTURE:return "Auto capture completed.";case Kd.GOOD:return "Capturing your document... Please do not move the camera.";case Kd.SMALL_SIZE:return "The document is too small. Try moving closer.";case Kd.OFF_CENTER:return "Try holding the device at the center of the document.";case Kd.SKEW:return "Please hold the device over a document to start scanning.";case Kd.NOTHING_DETECTED:return "No document is detected."}}processDetectResult(t){if([].concat(...t.location).every((t=>0===t)))return {success:!1,confidence:0,status:Kd.NOTHING_DETECTED};let e;const i=this.calculateConfidence(t.location,t.width,t.height);e=_s(t.confidence)?this.calculateTotalConfidence(i):t.confidence;const s={success:!0,location:t.location,confidence:e},{angleConfidence:n,areaConfidence:o,centerConfidence:r}=i,{config:a}=t;if(e>=(null==a?void 0:a.acceptedPolygonConfidence))if(this.succeedDetect+=1,s.status=Kd.GOOD,this.succeedDetect,5===this.succeedDetect||this.succeedDetect,null!=a&&a.enableAutoCapture)if(this.autoCaptureStartTime<=0)this.autoCaptureStartTime=(new Date).getTime();else {(new Date).getTime()-this.autoCaptureStartTime>a.autoCaptureDelay&&(this.autoCaptureStartTime=0,s.status=Kd.AUTO_CAPTURE);}else this.autoCaptureStartTime=0;else .45*n+.45*r+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),s.status=Kd.SMALL_SIZE):.45*n+.45*o+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),s.status=Kd.OFF_CENTER):.45*o+.45*r+10>=(null==a?void 0:a.acceptedPolygonConfidence)?(this.reset(),s.status=Kd.SKEW):(s.success=!1,s.status=Kd.NOTHING_DETECTED,this.failedDetect+=1,this.autoCaptureStartTime=0);return this.failedDetect>5&&this.reset(),s.statusMsg=this.getStatusMsg(s.status),s}calculateConfidence(t,e,i){return p(this,su,pu).call(this,p(this,eu,uu).call(this,t),e,i)}calculateTotalConfidence(t){const{angleConfidence:e,areaConfidence:i,centerConfidence:s}=t;return e&&i&&s?.3*e+.3*i+.3*s+10:0}reset(){this.succeedDetect=0,this.failedDetect=0,this.autoCaptureStartTime=0;}}function uu(t){if(!t)return [0,0,0,0,0,0,0,0];return [t[0][0],t[0][1],t[1][0],t[1][1],t[2][0],t[2][1],t[3][0],t[3][1]]}function pu(t,e,i){return {angleConfidence:p(this,nu,gu).call(this,t),areaConfidence:p(this,ou,fu).call(this,t,e,i),centerConfidence:p(this,ru,vu).call(this,t,e,i)}}function gu(t){let e=0;const i=p(this,lu,yu).call(this,[t[0],t[1]],[t[2],t[3]],[t[4],t[5]]),s=p(this,lu,yu).call(this,[t[2],t[3]],[t[4],t[5]],[t[6],t[7]]),n=p(this,lu,yu).call(this,[t[4],t[5]],[t[6],t[7]],[t[0],t[1]]),o=p(this,lu,yu).call(this,[t[6],t[7]],[t[0],t[1]],[t[2],t[3]]);return e+=Math.abs(i-90),e+=Math.abs(s-90),e+=Math.abs(n-90),e+=Math.abs(o-90),Math.max(0,100*Math.min(1,1-.025*e))}function fu(t,e,i){const s=p(this,cu,wu).call(this,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]);return Math.min(100,400*Math.max(0,s/(e*i)))}function vu(t,e,i){const s=[(t[0]+t[2]+t[4]+t[6])/4,(t[1]+t[3]+t[5]+t[7])/4],n=p(this,au,mu).call(this,s,[e/2,i/2]);return Math.max(0,100*Math.min(1,1-n/Math.min(e,i)))}function mu(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function yu(t,e,i){const s=p(this,au,mu).call(this,e,t),n=p(this,au,mu).call(this,e,i),o=p(this,au,mu).call(this,t,i);return 0===s||0===n?0:Math.acos((s*s+n*n-o*o)/(2*s*n))/Math.PI*180}function xu(t,e,i,s,n,o){return (t*s+e*n+i*o-n*s-o*t-i*e)/2}function wu(t,e,i,s,n,o,r,a){return p(this,hu,xu).call(this,t,e,i,s,n,o)+p(this,hu,xu).call(this,t,e,n,o,r,a)}!function(t){t.NONE="none",t.BLACK_AND_WHITE="blackAndWhite",t.GRAY="gray",t.REMOVE_SHADOW="removeShadow",t.SAVE_INK="saveInk",t.ENHANCE="enhance",t.INVERT="invert",t.BRIGHTNESS="brightness",t.CONTRAST="contrast",t.BRIGHTNESS_AND_CONTRAST="brightnessAndContrast";}(tu||(tu={}));const bu=new Map([[tu.NONE,"None"],[tu.BLACK_AND_WHITE,"toBW"],[tu.GRAY,"toGray"],[tu.REMOVE_SHADOW,"removeShadow"],[tu.SAVE_INK,"toBW"],[tu.ENHANCE,"enhance"],[tu.INVERT,"invert"],[tu.CONTRAST,"brightnessAndContrast"],[tu.BRIGHTNESS,"brightnessAndContrast"],[tu.BRIGHTNESS_AND_CONTRAST,"brightnessAndContrast"]]);var Su,Cu=new WeakSet,Pu=new WeakSet;function Tu(t,e){const i={...e||{}};return t===tu.SAVE_INK&&(i.method="adaptiveThreshold"),i}function Au(t){var e,i;(t.bRGBA=t.outputType===po.IT_RGBA,t.returnType=null!==(e=t.returnType)&&void 0!==e?e:go.RT_AUTO,t.bRGBA&&void 0===t.outputType)?t.outputType=po.IT_JPG:t.outputType=null!==(i=t.outputType)&&void 0!==i?i:po.IT_ALL;return t.is1BitTo8Bit=no.isApple,t}class ku{static replaceMessage(t,e,i){let s=t;return e&&(s=s.replace("<%api%>",e)),i&&(s=s.replace("<%param%>",i)),s}static getLastError(){return this.lastError}static clearLastError(){this.lastError=null;}static buildError(t,e,i){if(t&&!t.code&&t.cause&&t.cause.code&&t.cause.message)return Xs(t.message)&&(t.message=this.replaceMessage(t.message,e,i)),t;const s={code:t.code,message:t.message};null!=t&&t.details&&(s.details=t.details);let n={...t};return s.code>-8e4&&0!==s.code?s.code<=-2e4||(s.code=ku.WASM_ERR.code,s.message=ku.WASM_ERR.message,n.actualCode=n.code,n.code=s.code):s.code?(s.message=this.replaceMessage(s.message,e,i),n={...s},Array.isArray(s.details)&&0!==s.details.length&&(n.details=s.details)):(s.code=ku.EXTERNAL_ERR.code,s.message=ku.EXTERNAL_ERR.message,n.actualCode=t.code,n.message=t.message,t.name&&(n.name=t.name),t.stack&&(n.stack=t.stack),n.code=s.code,n.actualError=t),new Error(s.message,{cause:n})}static warning(t,e,i){const s=ku.buildError(t,e,i);this.lastError=s,this.onWarning.emit(s);}static error(t,e,i){const s=ku.buildError(t,e,i);throw this.lastError=s,this.onError.emit(s),s}static verbose(t,e,i){this.onVerbose.emit(t);}static throw(t,e,i){const s=ku.buildError(t,e,i);throw this.lastError=s,this.onError.emit(s),s}static reject(t,e,i){const s=ku.buildError(t,e,i);return this.lastError=s,this.onError.emit(s),Promise.reject(s)}static buildInfo(t,e){const i={details:e,id:ku.infoObjCount,status:"Pending",timestamp:Date.now(),type:t};return ku.infoObjCount+=1,i}static info(t){t.timestamp=Date.now(),this.onInfo.emit(Ns(t));}static on(t,e){"error"===t?this.onError.on(e):"verbose"===t?(this.onVerbose.on(e),0!==this.verboseListenerCount&&no.hasDebugOutput()||(no.enableDebugOutput(!0,(t=>{this.verbose(t);})),this.verboseListenerCount+=1)):"warning"===t?this.onWarning.on(e):"info"===t&&this.onInfo.on(e);}static off(t,e){"error"===t?this.onError.off(e):"verbose"===t?(this.onVerbose.off(e),this.verboseListenerCount-=1,0===this.verboseListenerCount&&no.enableDebugOutput(!1,void 0)):"warning"===t?this.onWarning.off(e):"info"===t&&this.onInfo.off(e);}}function Du(t,e,i,s){return e?i?`${e}${s?"":"."}${i}`:`${e}`:i?`${t}${s?"":"."}${i}`:`${t}`}i(ku,"onError",new tn),i(ku,"onWarning",new tn),i(ku,"onVerbose",new tn),i(ku,"onInfo",new tn),i(ku,"verboseListenerCount",0),i(ku,"infoObjCount",0),i(ku,"lastError",void 0),i(ku,"LIC_EMPTY",{code:-8e4,message:"No license."}),i(ku,"LIC_INVALID",{code:-80001,message:"License string is invalid."}),i(ku,"LIC_EXPIRED",{code:-80002,message:"XXX module license has expired."}),i(ku,"LIC_MISS_MODULE",{code:-80003,message:"XXX module license is missing."}),i(ku,"LIC_VER_NOT_MATCHED",{code:-80004,message:"XXX module license version does not match."}),i(ku,"LIC_DOMAIN_NOT_MATCHED",{code:-80005,message:"Domain does not match the domain bound to the XXX module license."}),i(ku,"INIT_SHOULD_SET_CONFIG",{code:-80050,message:"DDV.Core.init() has not been set up yet."}),i(ku,"INIT_CONFIG_NOT_DONE",{code:-80051,message:"DDV.Core.init() has not been completed."}),i(ku,"RESOURCE_NOT_FOUND",{code:-80052,message:"<%api%>: Resource is not found from the specified engineResourcePath."}),i(ku,"RESOURCE_NOT_MATCHED",{code:-80053,message:"<%api%>: The resource version at the specified engineResourcePath does not match this version of Dynamsoft Document Viewer."}),i(ku,"WASM_ERR",{code:-81e3,message:"WASM Error"}),i(ku,"PARAM_INVALID",{code:-80100,message:"<%api%>: '<%param%>' is invalid."}),i(ku,"PARAM_OUT_OF_RANGE",{code:-80101,message:"<%api%>: '<%param%>' is out of range."}),i(ku,"PARAM_MISS",{code:-80102,message:"<%api%>: '<%param%>' is missing."}),i(ku,"PARAM_NOT_SUPPORT",{code:-80103,message:"<%api%>: The value for '<%param%>' is not supported."}),i(ku,"DOC_NOT_EXIST",{code:-80104,message:"<%api%>: The specified document(s) do not exist."}),i(ku,"PAGE_NOT_EXIST",{code:-80105,message:"<%api%>: The specified page(s) do not exist."}),i(ku,"ANNOTATION_NOT_EXIST",{code:-80106,message:"<%api%>: The specified annotation does not exist."}),i(ku,"DOC_DESTROYED",{code:-80108,message:"The document has been destroyed."}),i(ku,"PAGE_DESTROYED",{code:-80109,message:"The page has been destroyed."}),i(ku,"FILE_NOT_SUPPORT",{code:-80200,message:"File type is not supported."}),i(ku,"DOC_UID_DUPLICATE",{code:-80201,message:"DocUid does not allow duplicate."}),i(ku,"PAGEDATA_DESTROYED",{code:-80205,message:"The pageData has been destroyed."}),i(ku,"SEARCHER_DESTROYED",{code:-80206,message:"The DocTextSearcher has been destroyed."}),i(ku,"CONTAINER_NOT_EXIST",{code:-80301,message:"The specified container does not exist."}),i(ku,"MIN_ZOOM_INVALID",{code:-80302,message:"minZoom value cannot be larger than maxZoom value."}),i(ku,"MAX_ZOOM_INVALID",{code:-80303,message:"maxZoom value cannot be smaller than minZoom value."}),i(ku,"DOC_NOT_OPEN",{code:-80304,message:"No document opened."}),i(ku,"DOC_NO_IMAGE",{code:-80305,message:"There is no image in the current document."}),i(ku,"ZOOM_TOO_LARGE",{code:-80306,message:"The value for zoom is larger than maxZoom value."}),i(ku,"ZOOM_TOO_SMALL",{code:-80307,message:"The value for zoom is smaller than minZoom value."}),i(ku,"ROW_COLUMN_CAN_NOT_CHANGE",{code:-80308,message:"<%api%>: Not available in current displayMode."}),i(ku,"RECT_EXCEED_PAGE_BOUND",{code:-80309,message:"The specified rect exceeds the bounds of the current page."}),i(ku,"UNDO_NOOP",{code:-80310,message:"No operations to undo."}),i(ku,"REDO_NOOP",{code:-80311,message:"No operations to redo."}),i(ku,"QUAD_EXCEED_PAGE_BOUND",{code:-80312,message:"The specified quad exceeds the bounds of the current page."}),i(ku,"ELEMENT_UNSUPPORTED",{code:-80313,message:"The element '<%param%>' is not supported in <%api%> class."}),i(ku,"TOOL_MODE_NOT_AVAILABLE",{code:-80314,message:"<%api%>: Not available in current toolMode."}),i(ku,"DOC_DETECT_MISS",{code:-80315,message:"DocumentDetect needs to be configured by Dynamsoft.DDV.setProcessingHandler to enable the document detection feature."}),i(ku,"IMG_FILTER_MISS",{code:-80316,message:"ImageFilter needs to be configured by Dynamsoft.DDV.setProcessingHandler to enable the image filter feature."}),i(ku,"ANNOTATION_SELECT",{code:-80317,message:"The specified annotation(s) is not on the current page or does not exist."}),i(ku,"WASM_FONT_LOSS",{code:-80318,message:"The document contains unsupported fonts, which may result in font loss after saving."}),i(ku,"UNSELECTED_READONLY",{code:-80319,message:"ReadOnly annotation or noView annotation cannot be selected."}),i(ku,"UNSELECTED_UNKNOWN",{code:-80320,message:"Unknown annotation or incomplete annotation cannot be selected."}),i(ku,"UNSELECTED_FLATTENED",{code:-80321,message:"Flattened annotation cannot be selected."}),i(ku,"NO_RESULTS_FOUND",{code:-80322,message:"No results found."}),i(ku,"CAMERA_NOT_EXIST",{code:-80400,message:"The specified camera does not exist."}),i(ku,"CAMERA_OCCUPIED",{code:-80401,message:"The specified camera is occupied."}),i(ku,"CAMERA_NO_VIDEO",{code:-80402,message:"No video stream is played."}),i(ku,"CAMERA_NEED_HTTPS",{code:-80403,message:"Not HTTPS, failed to play the video stream."}),i(ku,"CAMERA_NOT_SUPPORT_TORCH",{code:-80404,message:"The camera does not support a flashlight."}),i(ku,"CAMERA_NO_CAMERA",{code:-80405,message:"No camera available."}),i(ku,"CAMERA_DENIED",{code:-80406,message:"The selected camera is denied by browser."}),i(ku,"CONTAINER_NO_BOUND",{code:-80407,message:"No bound container."}),i(ku,"EXTERNAL_ERR",{code:-81100,message:"External Error"});class Ru{static makeSureValid(t,e,i,s){const n=this.composeError(i,s);ku.throw(n,t,e);}static output(t,e,i,s,n){let o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const r=this.composeError(s,n);return 2===t?ku.reject(r,e,i):1===t?(ku.warning(r,e,i),o):0===t?ku.error(r,e,i):3===t?ku.verbose(r,e,i):void 0}static error(t,e,i,s){const n=this.composeError(i,s);ku.throw(n,t,e);}static warning(t,e,i,s){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=this.composeError(i,s);return ku.warning(o,t,e),n}static verbose(t,e,i,s){const n=this.composeError(i,s);ku.verbose(n,t,e);}static reject(t,e,i,s){const n=this.composeError(i,s);return ku.reject(n,t,e)}static composeError(t,e){const i={..._s(e)?ku.PARAM_INVALID:e};return t&&(i.details=t),i}static formatDetails(t,e){const i=[];if(Vs(e))e||i.push(`'${t}' is invalid.`);else {const{isValid:s,isInRange:n,isSupported:o}=e;!1===s&&i.push(`'${t}' is invalid.`),!1===n&&i.push(`'${t}' is out of range.`),!1===o&&i.push(`'${t}' is not supported.`);}return i}static formatError(t,e){const{isValid:i,isInRange:s,isSupported:n}=t;if(!1===i||!1===s||!1===n){if(e)return e;if(!i)return ku.PARAM_INVALID;if(!s)return ku.PARAM_OUT_OF_RANGE;if(!n)return ku.PARAM_NOT_SUPPORT}return null}static isArrayBufferOrBlob(t){return Fs(t)||Hs(t)}static isArrayAndMeetMinLength(t,e){return Ls(t)?js(e)?{isValid:0!==t.length,isInRange:t.length>=e}:{isValid:!0}:{isValid:!1}}static isNumberAndIsInRange(t,e,i){return js(t)?{isValid:!0,isInRange:!(!_s(e)&&t<e||!_s(i)&&t>i)}:{isValid:!1}}static isStringAndNotEmpty(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Xs(t)?e?{isValid:!0}:{isValid:0!==t.trim().length}:{isValid:!1}}static isPdfDate(t){if(!Xs(t))return {isValid:!1};const e=t.match(/^D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(?:([+-])(\d{2})['](\d{2})[']|)$/);let i=!1;if(e){const[,t,s,n,o,r,a,l,h,c]=e,d=new Date(`${t}-${s}-${n}T${o}:${r}:${a}`);if(i=!0,d.getFullYear()===parseInt(t,10)&&d.getMonth()+1===parseInt(s,10)&&d.getDate()===parseInt(n,10)&&d.getHours()===parseInt(o,10)&&d.getMinutes()===parseInt(r,10)&&d.getSeconds()===parseInt(a,10)||(i=!1),i&&l){const t=parseInt(h,10),e=parseInt(c,10);(t<0||t>12||e<0||e>59||"+"!==l&&"-"!==l)&&(i=!1);}}return {isSupported:i}}}!function(t){t[t.BlackAndWhite=1]="BlackAndWhite",t[t.Gray=2]="Gray",t[t.RemoveShadow=3]="RemoveShadow",t[t.Enhance=4]="Enhance",t[t.Invert=5]="Invert",t[t.Brightness=6]="Brightness",t[t.Contrast=7]="Contrast",t[t.BrightnessAndContrast=8]="BrightnessAndContrast",t[t.Perspective=9]="Perspective",t[t.Deskew=10]="Deskew",t[t.Rotate=11]="Rotate",t[t.Flip=12]="Flip",t[t.Resize=13]="Resize",t[t.SetHeight=14]="SetHeight",t[t.SetWidth=15]="SetWidth",t[t.SetDPI=16]="SetDPI",t[t.Crop=17]="Crop",t[t.Erase=18]="Erase",t[t.DrawPolygon=19]="DrawPolygon";}(Su||(Su={}));var Eu=new WeakSet,Mu=new WeakSet;class Iu{constructor(){v(this,Mu),v(this,Eu);}async process(t,e,i){Ls(e)||(e=[e]),p(this,Eu,Bu).call(this,e);const s=new wo,n={inputImageInfo:null,output:null,outputImageInfo:null,outputContentType:"",outputType:null};try{var o,r,a,l;const h=await s.initImage({source:t.data,isRGBA:t.type===uo.RGBA,width:t.width,height:t.height,isBGRA:t.type===uo.BGRA});h.srcBuffer&&(t.data=h.srcBuffer);for(const t of e)p(this,Mu,Uu).call(this,s,t);const c=await s.getImage({jpegQuality:null==i||null===(o=i.params)||void 0===o?void 0:o.jpegQuality,ifDeleteObject:!0,isRGBA:t.type===uo.RGBA,bitDepth:null==i||null===(r=i.params)||void 0===r?void 0:r.bitDepth,xDpi:null==i||null===(a=i.params)||void 0===a?void 0:a.xDpi,yDpi:null==i||null===(l=i.params)||void 0===l?void 0:l.yDpi,returnType:go.RT_BINARY,outputType:Mo[null==i?void 0:i.type]});await s.freeReservedData(),n.output=c.imageData,n.outputContentType=c.blobType,n.outputImageInfo={width:c.imageWidth,height:c.imageHeight,bitDepth:c.imageBitDepth,resolutionX:c.imageXResolution,resolutionY:c.imageYResolution},n.outputType=Io[c.imageType];}finally{try{await s.terminate();}catch(t){ku.warning(t);}}return n}}function Bu(t){for(const e of t)e.type&&(e.type<=0||(e.type,Su.DrawPolygon),e.params);}async function Uu(t,e){var i;const s=null!==(i=e.params)&&void 0!==i?i:{};switch(e.type){case Su.BlackAndWhite:return t.toBinaryLevel(s.saveInk,s.level);case Su.Gray:return t.toGrayscale(s.level);case Su.RemoveShadow:return t.removeShadowLevel(s.level,s.alpha);case Su.Enhance:return t.brighten();case Su.Invert:return t.invert();case Su.Contrast:return t.changeBrightnessAndContrast(void 0,s.contrast);case Su.Brightness:return t.changeBrightnessAndContrast(s.brightness,void 0);case Su.BrightnessAndContrast:return t.changeBrightnessAndContrast(s.brightness,s.contrast);case Su.Perspective:return t.perspective(s.location);case Su.Deskew:{var n;const e=await t.getSkewAngle(s.options);return t.rotate({angle:e,fillColor:s.fillColor,keepSize:null===(n=s.keepSize)||void 0===n||n,mode:s.mode})}case Su.Rotate:return t.rotate({angle:s.angle,fillColor:s.fillColor,keepSize:s.keepSize,mode:s.mode});case Su.Flip:return t.flip();case Su.Resize:{const{newWidth:e,newHeight:i,mode:n}=s;return t.resize(e,i,n)}case Su.SetHeight:{const{newHeight:e,fillColor:i}=s;return t.setImageHeight(e,i)}case Su.SetWidth:{const{newWidth:e,fillColor:i}=s;return t.setImageWidth(e,i)}case Su.SetDPI:return t.setDpi({rawResolutionX:0,rawResolutionY:0,resolutionX:s.xRes,resolutionY:s.yRes,resample:!1});case Su.Crop:return t.crop({left:s.left,top:s.top,width:s.right-s.left,height:s.bottom-s.top});case Su.Erase:return t.erase({left:s.left,top:s.top,width:s.right-s.left,height:s.bottom-s.top},s.fillColor);case Su.DrawPolygon:return t.drawQuadrangle({location:s.location,strokeColor:s.strokeColor,lineWidth:s.lineWidth})}}!as&&document.currentScript&&(document.currentScript.getAttribute("data-license")||document.currentScript.getAttribute("data-productKeys")||document.currentScript.getAttribute("data-licenseKey")||document.currentScript.getAttribute("data-handshakeCode")||document.currentScript.getAttribute("data-organizationID")),!as&&document.currentScript&&document.currentScript.getAttribute("data-sessionPassword");const Lu=function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=t;if(i._pLoad.isEmpty){let t,s,n,o=i._license||"",r=JSON.parse(JSON.stringify(i._licenseServer)),a=i._sessionPassword,l=0;if(o.startsWith("t")||o.startsWith("f"))l=0;else if(0===o.length||o.startsWith("P")||o.startsWith("L")||o.startsWith("Y")||o.startsWith("A"))l=1;else {l=2;const e=o.indexOf(":");-1!=e&&(o=o.substring(e+1));const i=o.indexOf("?");if(-1!=i&&(s=o.substring(i+1),o=o.substring(0,i)),o.startsWith("DLC2"))l=0;else {if(o.startsWith("DLS2")){let e;try{let t=o.substring(4);t=atob(t),e=JSON.parse(t);}catch(t){throw new Error("Format Error: The license string you specified is invalid, please check to make sure it is correct.")}if(o=e.handshakeCode?e.handshakeCode:e.organizationID?e.organizationID:"","number"==typeof o&&(o=JSON.stringify(o)),0===r.length){let t=[];e.mainServerURL&&(t[0]=e.mainServerURL),e.standbyServerURL&&(t[1]=e.standbyServerURL),r=(t=>{if(null==t)t=[];else {t=t instanceof Array?[...t]:[t];for(let e=0;e<t.length;++e){if(!as){let i=document.createElement("a");i.href=t[e],t[e]=i.href;}t[e].endsWith("/")||(t[e]+="/");}}return t})(t);}!a&&e.sessionPassword&&(a=e.sessionPassword),t=e.remark;}o&&"200001"!==o&&!o.startsWith("200001-")||(l=1);}}if(l&&(e||(ls.crypto||(n="Please upgrade your browser to support online key."),ls.crypto.subtle||(n="Require https to use online key in this browser."))),n){if(1!==l)throw new Error(n);l=0,i._lastErrorCode=-1,i._lastErrorString=n;}return 1===l&&(o=""),{lt:l,l:o,ls:r,sp:a,rmk:t,cv:s}}throw new Error("Can't preprocess license again is not allowed to change after `createInstance` or `loadWasm` is called.")},Ou=async(t,e,i)=>{if(!t._bNeverShowDialog)try{let s=await fetch(t.engineResourcePath+"dls.license.dialog.html");if(!s.ok)throw Error("Get license dialog fail. Network Error: "+s.statusText);let n=await s.text();if(!n.trim().startsWith("<"))throw Error("Get license dialog fail. Can't get valid HTMLElement.");let o=document.createElement("div");o.innerHTML=n;let r=[];for(let t=0;t<o.childElementCount;++t){let e=o.children[t];e instanceof HTMLStyleElement&&(r.push(e),document.head.append(e));}let a=1==o.childElementCount?o.children[0]:o;a.remove();let l,h,c,d,u,p=[a],g=a.children;for(let t of g)p.push(t);for(let t=0;t<p.length;++t)for(let e of p[t].children)p.push(e);for(let t of p)if(!l&&t.classList.contains("dls-license-mask"))l=t,t.addEventListener("click",(e=>{if(t==e.target){a.remove();for(let t of r)t.remove();}}));else if(!h&&t.classList.contains("dls-license-icon-close"))h=t,t.addEventListener("click",(()=>{a.remove();for(let t of r)t.remove();}));else if(!c&&t.classList.contains("dls-license-icon-error"))c=t,"error"!=e&&t.remove();else if(!d&&t.classList.contains("dls-license-icon-warn"))d=t,"warn"!=e&&t.remove();else if(!u&&t.classList.contains("dls-license-msg-content")){u=t;let e=i;for(;e;){let i=e.indexOf("["),s=e.indexOf("]",i),n=e.indexOf("(",s),o=e.indexOf(")",n);if(-1==i||-1==s||-1==n||-1==o){t.appendChild(new Text(e));break}i>0&&t.appendChild(new Text(e.substring(0,i)));let r=document.createElement("a"),a=e.substring(i+1,s);r.innerText=a;let l=e.substring(n+1,o);r.setAttribute("href",l),r.setAttribute("target","_blank"),t.appendChild(r),e=e.substring(o+1);}}document.body.appendChild(a);}catch(e){t._onLog&&t._onLog(e.message||e);}};var Nu=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(t){return}}();function _u(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(n){if("TypeError"!==n.name)throw n;for(var i=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),s=0;s<t.length;s+=1)i.append(t[s]);return i.getBlob(e.type)}}function Wu(t,e){e&&t.then((function(t){e(null,t);}),(function(t){e(t);}));}function Fu(t,e,i){"function"==typeof e&&t.then(e),"function"==typeof i&&t.catch(i);}function Hu(t){return "string"!=typeof t&&(t=String(t)),t}function Vu(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}const zu="local-forage-detect-blob-support";let $u;const ju={},Xu=Object.prototype.toString,Gu="readonly",Yu="readwrite";function qu(t){return "boolean"==typeof $u?Promise.resolve($u):function(t){return new Promise((function(e){var i=t.transaction(zu,Yu),s=_u([""]);i.objectStore(zu).put(s,"key"),i.onabort=function(t){t.preventDefault(),t.stopPropagation(),e(!1);},i.oncomplete=function(){var t=navigator.userAgent.match(/Chrome\/(\d+)/),i=navigator.userAgent.match(/Edge\//);e(i||!t||parseInt(t[1],10)>=43);};})).catch((function(){return !1}))}(t).then((function(t){return $u=t,$u}))}function Ju(t){var e=ju[t.name],i={};i.promise=new Promise((function(t,e){i.resolve=t,i.reject=e;})),e.deferredOperations.push(i),e.dbReady?e.dbReady=e.dbReady.then((function(){return i.promise})):e.dbReady=i.promise;}function Zu(t){var e=ju[t.name].deferredOperations.pop();if(e)return e.resolve(),e.promise}function Qu(t,e){var i=ju[t.name].deferredOperations.pop();if(i)return i.reject(e),i.promise}function Ku(t,e){return new Promise((function(i,s){if(ju[t.name]=ju[t.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},t.db){if(!e)return i(t.db);Ju(t),t.db.close();}var n=[t.name];e&&n.push(t.version);var o=Nu.open.apply(Nu,n);e&&(o.onupgradeneeded=function(e){var i=o.result;try{i.createObjectStore(t.storeName),e.oldVersion<=1&&i.createObjectStore(zu);}catch(t){if("ConstraintError"!==t.name)throw t}}),o.onerror=function(t){t.preventDefault(),s(o.error);},o.onsuccess=function(){var e=o.result;e.onversionchange=function(t){t.target.close();},i(e),Zu(t);};}))}function tp(t){return Ku(t,!1)}function ep(t){return Ku(t,!0)}function ip(t,e){if(!t.db)return !0;var i=!t.db.objectStoreNames.contains(t.storeName),s=t.version<t.db.version,n=t.version>t.db.version;if(s&&(t.version,t.version=t.db.version),n||i){if(i){var o=t.db.version+1;o>t.version&&(t.version=o);}return !0}return !1}function sp(t){var e=function(t){for(var e=t.length,i=new ArrayBuffer(e),s=new Uint8Array(i),n=0;n<e;n++)s[n]=t.charCodeAt(n);return i}(atob(t.data));return _u([e],{type:t.type})}function np(t){var e=this,i=e._initReady().then((function(){var t=ju[e._dbInfo.name];if(t&&t.dbReady)return t.dbReady}));return Fu(i,t,t),i}function op(t,e,i,s){void 0===s&&(s=1);try{var n=t.db.transaction(t.storeName,e);i(null,n);}catch(n){if(s>0&&(!t.db||"InvalidStateError"===n.name||"NotFoundError"===n.name))return Promise.resolve().then((()=>{if(!t.db||"NotFoundError"===n.name&&!t.db.objectStoreNames.contains(t.storeName)&&t.version<=t.db.version)return t.db&&(t.version=t.db.version+1),ep(t)})).then((()=>function(t){Ju(t);for(var e=ju[t.name],i=e.forages,s=0;s<i.length;s++){const t=i[s];t._dbInfo.db&&(t._dbInfo.db.close(),t._dbInfo.db=null);}return t.db=null,tp(t).then((e=>(t.db=e,ip(t)?ep(t):e))).then((s=>{t.db=e.db=s;for(var n=0;n<i.length;n++)i[n]._dbInfo.db=s;})).catch((e=>{throw Qu(t,e),e}))}(t).then((function(){op(t,e,i,s-1);})))).catch(i);i(n);}}var rp={_driver:"asyncStorage",_initStorage:function(t){var e=this,i={db:null};if(t)for(var s in t)i[s]=t[s];var n=ju[i.name];n||(n={forages:[],db:null,dbReady:null,deferredOperations:[]},ju[i.name]=n),n.forages.push(e),e._initReady||(e._initReady=e.ready,e.ready=np);var o=[];function r(){return Promise.resolve()}for(var a=0;a<n.forages.length;a++){var l=n.forages[a];l!==e&&o.push(l._initReady().catch(r));}var h=n.forages.slice(0);return Promise.all(o).then((function(){return i.db=n.db,tp(i)})).then((function(t){return i.db=t,ip(i,e._defaultConfig.version)?ep(i):t})).then((function(t){i.db=n.db=t,e._dbInfo=i;for(var s=0;s<h.length;s++){var o=h[s];o!==e&&(o._dbInfo.db=i.db,o._dbInfo.version=i.version);}}))},_support:function(){try{if(!Nu||!Nu.open)return !1;var t="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),e="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return (!t||e)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(t){return !1}}(),getItem:function(t,e){var i=this;t=Hu(t);var s=new Promise((function(e,s){i.ready().then((function(){op(i._dbInfo,Gu,(function(n,o){if(n)return s(n);try{var r=o.objectStore(i._dbInfo.storeName).get(t);r.onsuccess=function(){var t=r.result;void 0===t&&(t=null),function(t){return t&&t.__local_forage_encoded_blob}(t)&&(t=sp(t)),e(t);},r.onerror=function(){s(r.error);};}catch(t){s(t);}}));})).catch(s);}));return Wu(s,e),s},setItem:function(t,e,i){var s=this;t=Hu(t);var n=new Promise((function(i,n){var o;s.ready().then((function(){return o=s._dbInfo,"[object Blob]"===Xu.call(e)?qu(o.db).then((function(t){return t?e:(i=e,new Promise((function(t,e){var s=new FileReader;s.onerror=e,s.onloadend=function(e){var s=btoa(e.target.result||"");t({__local_forage_encoded_blob:!0,data:s,type:i.type});},s.readAsBinaryString(i);})));var i;})):e})).then((function(e){op(s._dbInfo,Yu,(function(o,r){if(o)return n(o);try{var a=r.objectStore(s._dbInfo.storeName);null===e&&(e=void 0);var l=a.put(e,t);r.oncomplete=function(){void 0===e&&(e=null),i(e);},r.onabort=r.onerror=function(){var t=l.error?l.error:l.transaction.error;n(t);};}catch(t){n(t);}}));})).catch(n);}));return Wu(n,i),n},removeItem:function(t,e){var i=this;t=Hu(t);var s=new Promise((function(e,s){i.ready().then((function(){op(i._dbInfo,Yu,(function(n,o){if(n)return s(n);try{var r=o.objectStore(i._dbInfo.storeName).delete(t);o.oncomplete=function(){e();},o.onerror=function(){s(r.error);},o.onabort=function(){var t=r.error?r.error:r.transaction.error;s(t);};}catch(t){s(t);}}));})).catch(s);}));return Wu(s,e),s},clear:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){op(e._dbInfo,Yu,(function(s,n){if(s)return i(s);try{var o=n.objectStore(e._dbInfo.storeName).clear();n.oncomplete=function(){t();},n.onabort=n.onerror=function(){var t=o.error?o.error:o.transaction.error;i(t);};}catch(t){i(t);}}));})).catch(i);}));return Wu(i,t),i},length:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){op(e._dbInfo,Gu,(function(s,n){if(s)return i(s);try{var o=n.objectStore(e._dbInfo.storeName).count();o.onsuccess=function(){t(o.result);},o.onerror=function(){i(o.error);};}catch(t){i(t);}}));})).catch(i);}));return Wu(i,t),i},keys:function(t){var e=this,i=new Promise((function(t,i){e.ready().then((function(){op(e._dbInfo,Gu,(function(s,n){if(s)return i(s);try{var o=n.objectStore(e._dbInfo.storeName).openKeyCursor(),r=[];o.onsuccess=function(){var e=o.result;e?(r.push(e.key),e.continue()):t(r);},o.onerror=function(){i(o.error);};}catch(t){i(t);}}));})).catch(i);}));return Wu(i,t),i},dropInstance:function(t,e){e=Vu.apply(this,arguments);var i,s=this.config();if((t="function"!=typeof t&&t||{}).name||(t.name=t.name||s.name,t.storeName=t.storeName||s.storeName),t.name){const e=t.name===s.name&&this._dbInfo.db?Promise.resolve(this._dbInfo.db):tp(t).then((e=>{const i=ju[t.name],s=i.forages;i.db=e;for(var n=0;n<s.length;n++)s[n]._dbInfo.db=e;return e}));i=t.storeName?e.then((e=>{if(!e.objectStoreNames.contains(t.storeName))return;const i=e.version+1;Ju(t);const s=ju[t.name],n=s.forages;e.close();for(let t=0;t<n.length;t++){const e=n[t];e._dbInfo.db=null,e._dbInfo.version=i;}const o=new Promise(((e,s)=>{const n=Nu.open(t.name,i);n.onerror=t=>{n.result.close(),s(t);},n.onupgradeneeded=()=>{n.result.deleteObjectStore(t.storeName);},n.onsuccess=()=>{const t=n.result;t.close(),e(t);};}));return o.then((t=>{s.db=t;for(let e=0;e<n.length;e++){const i=n[e];i._dbInfo.db=t,Zu(i._dbInfo);}})).catch((e=>{throw (Qu(t,e)||Promise.resolve()).catch((()=>{})),e}))})):e.then((e=>{Ju(t);const i=ju[t.name],s=i.forages;e.close();for(var n=0;n<s.length;n++){s[n]._dbInfo.db=null;}const o=new Promise(((e,i)=>{var s=Nu.deleteDatabase(t.name);s.onerror=()=>{const t=s.result;t&&t.close(),i(s.error);},s.onblocked=()=>{},s.onsuccess=()=>{const t=s.result;t&&t.close(),e(t);};}));return o.then((t=>{i.db=t;for(var e=0;e<s.length;e++){Zu(s[e]._dbInfo);}})).catch((e=>{throw (Qu(t,e)||Promise.resolve()).catch((()=>{})),e}))}));}else i=Promise.reject("Invalid arguments");return Wu(i,e),i}};const ap=new Map;function lp(t,e){let i=t.name+"/";return t.storeName!==e.storeName&&(i+=t.storeName+"/"),i}var hp={_driver:"tempStorageWrapper",_initStorage:async function(t){const e={};if(t)for(let i in t)e[i]=t[i];const i=e.keyPrefix=lp(t,this._defaultConfig);this._dbInfo=e,ap.has(i)||ap.set(i,new Map);},getItem:function(t,e){t=Hu(t);const i=this.ready().then((()=>ap.get(this._dbInfo.keyPrefix).get(t)));return Wu(i,e),i},setItem:function(t,e,i){t=Hu(t);const s=this.ready().then((()=>(void 0===e&&(e=null),ap.get(this._dbInfo.keyPrefix).set(t,e),e)));return Wu(s,i),s},removeItem:function(t,e){t=Hu(t);const i=this.ready().then((()=>{ap.get(this._dbInfo.keyPrefix).delete(t);}));return Wu(i,e),i},clear:function(t){const e=this.ready().then((()=>{const t=this._dbInfo.keyPrefix;ap.has(t)&&ap.delete(t);}));return Wu(e,t),e},length:function(t){const e=this.ready().then((()=>ap.get(this._dbInfo.keyPrefix).size));return Wu(e,t),e},keys:function(t){const e=this.ready().then((()=>[...ap.get(this._dbInfo.keyPrefix).keys()]));return Wu(e,t),e},dropInstance:function(t,e){if(e=Vu.apply(this,arguments),!(t="function"!=typeof t&&t||{}).name){const e=this.config();t.name=t.name||e.name,t.storeName=t.storeName||e.storeName;}let i;return i=t.name?new Promise((e=>{t.storeName?e(lp(t,this._defaultConfig)):e(`${t.name}/`);})).then((t=>{ap.delete(t);})):Promise.reject("Invalid arguments"),Wu(i,e),i}};const cp=(t,e)=>t===e||"number"==typeof t&&"number"==typeof e&&isNaN(t)&&isNaN(e),dp=(t,e)=>{const i=t.length;let s=0;for(;s<i;){if(cp(t[s],e))return !0;s++;}return !1},up=Array.isArray||function(t){return "[object Array]"===Object.prototype.toString.call(t)},pp={},gp={},fp={INDEXEDDB:rp,TEMPSTORAGE:hp},vp=[fp.INDEXEDDB._driver,fp.TEMPSTORAGE._driver],mp=["dropInstance"],yp=["clear","getItem","keys","length","removeItem","setItem"].concat(mp),xp={description:"",driver:vp.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function wp(t,e){t[e]=function(){const i=arguments;return t.ready().then((function(){return t[e].apply(t,i)}))};}function bp(){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(e)for(let t in e)e.hasOwnProperty(t)&&(up(e[t])?arguments[0][t]=e[t].slice():arguments[0][t]=e[t]);}return arguments[0]}class Sp{constructor(t){for(let t in fp)if(fp.hasOwnProperty(t)){const e=fp[t],i=e._driver;this[t]=i,pp[i]||this.defineDriver(e);}this._defaultConfig=bp({},xp),this._config=bp({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((()=>{}));}config(t){if("object"==typeof t){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(let e in t){if("storeName"===e&&(t[e]=t[e].replace(/\W/g,"_")),"version"===e&&"number"!=typeof t[e])return new Error("Database version must be a number.");this._config[e]=t[e];}return !("driver"in t)||!t.driver||this.setDriver(this._config.driver)}return "string"==typeof t?this._config[t]:this._config}defineDriver(t,e,i){const s=new Promise((function(e,i){try{const s=t._driver,n=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!t._driver)return void i(n);const o=yp.concat("_initStorage");for(let e=0,s=o.length;e<s;e++){const s=o[e];if((!dp(mp,s)||t[s])&&"function"!=typeof t[s])return void i(n)}const r=function(){const e=function(t){return function(){const e=new Error(`Method ${t} is not implemented by the current driver`),i=Promise.reject(e);return Wu(i,arguments[arguments.length-1]),i}};for(let i=0,s=mp.length;i<s;i++){const s=mp[i];t[s]||(t[s]=e(s));}};r();const a=function(i){pp[s],pp[s]=t,gp[s]=i,e();};"_support"in t?t._support&&"function"==typeof t._support?t._support().then(a,i):a(!!t._support):a(!0);}catch(t){i(t);}}));return Fu(s,e,i),s}driver(){return this._driver||null}getDriver(t,e,i){const s=pp[t]?Promise.resolve(pp[t]):Promise.reject(new Error("Driver not found."));return Fu(s,e,i),s}ready(t){const e=this,i=e._driverSet.then((()=>(null===e._ready&&(e._ready=e._initDriver()),e._ready)));return Fu(i,t,t),i}setDriver(t,e,i){const s=this;up(t)||(t=[t]);const n=this._getSupportedDrivers(t);function o(){s._config.driver=s.driver();}function r(t){return s._extend(t),o(),s._ready=s._initStorage(s._config),s._ready}const a=null!==this._driverSet?this._driverSet.catch((()=>Promise.resolve())):Promise.resolve();return this._driverSet=a.then((()=>{const t=n[0];return s._dbInfo=null,s._ready=null,s.getDriver(t).then((t=>{s._driver=t._driver,o(),s._wrapLibraryMethodsWithReady(),s._initDriver=function(t){return function(){let e=0;return function i(){for(;e<t.length;){let n=t[e];return e++,s._dbInfo=null,s._ready=null,s.getDriver(n).then(r).catch(i)}o();const n=new Error("No available storage method found.");return s._driverSet=Promise.reject(n),s._driverSet}()}}(n);}))})).catch((()=>{o();const t=new Error("No available storage method found.");return s._driverSet=Promise.reject(t),s._driverSet})),Fu(this._driverSet,e,i),this._driverSet}supports(t){return !!gp[t]}_extend(t){bp(this,t);}_getSupportedDrivers(t){const e=[];for(let i=0,s=t.length;i<s;i++){const s=t[i];this.supports(s)&&e.push(s);}return e}_wrapLibraryMethodsWithReady(){for(let t=0,e=yp.length;t<e;t++)wp(this,yp[t]);}createInstance(t){return new Sp(t)}}var Cp=new Sp;Date.prototype.kUtilFormat=function(t){const e={"M+":this.getUTCMonth()+1,"d+":this.getUTCDate(),"H+":this.getUTCHours(),"h+":this.getUTCHours()%12||12,"m+":this.getUTCMinutes(),"s+":this.getUTCSeconds(),"q+":Math.floor((this.getUTCMonth()+3)/3),"S+":this.getUTCMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getUTCFullYear()+"").substr(4-RegExp.$1.length)));for(let i in e)new RegExp("("+i+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[i]:("000"+e[i]).substr(("000"+e[i]).length-RegExp.$1.length)));return t},String.prototype.startsWith||(String.prototype.startsWith=function(t){return 0==this.indexOf(t)});let Pp=t=>{let e,i,s,n,o,r,a,l,h,c,d,u,p,g,f,v,m,y,x,w,b,S,C=t.fetch||ls.fetch,P=t.btoa||ls.btoa,T=t.atob||ls.atob,A=t.bd,k=t.dm,D=["https://mlts.dynamsoft.com/","https://slts.dynamsoft.com/"],R=!1,E=Promise.resolve(),M=t.lf,I=t.log&&function(){try{for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];t.log.apply(null,i);}catch(t){setTimeout((()=>{throw t}),0);}}||(()=>{}),B=A&&I||(()=>{}),U=t.fol,L=t.sutlcb,O=t.feab,N=t=>T(T(t.replace(/\n/g,"+").replace(/\s/g,"=")).substring(1)),_=t=>P(String.fromCharCode(97+25*Math.random())+P(t)).replace(/\+/g,"\n").replace(/=/g," "),W=()=>{if(S)return S;if(ls.crypto){let t=new Uint8Array(36);ls.crypto.getRandomValues(t);let e="";for(let i=0;i<36;++i){let s=t[i]%36;e+=s<10?s:String.fromCharCode(s+87);}return e}return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return ("x"==t?e:3&e|8).toString(16)}))};const F=" Check your Internet connection or contact Dynamsoft Support (support@dynamsoft.com) to acquire an offline license.";let H,V,z,$,j={dlsErrorAndCacheExpire:"Failed to connect to the Dynamsoft License Server. The cached license has expired. Please get connected to the network as soon as possible or contact the site administrator for more information.",publicTrialNetworkTimeout:"Failed to connect to the Dynamsoft License Server: network timed out."+F,networkTimeout:"Failed to connect to the Dynamsoft License Server: network timed out. Check your Internet connection or contact the site administrator for more information.",publicTrialFailConnect:"Failed to connect to the Dynamsoft License Server: network connection error."+F,failConnect:"Failed to connect to the Dynamsoft License Server: network connection error. Check your Internet connection or contact the site administrator for more information.",checkLocalTime:"Your system date and time appear to have been changed, causing the license to fail. Please correct the system data and time and try again."},X=async()=>(H=H||(async()=>{await(async()=>{M||(M=Cp);})();{let t=await M.createInstance({name:"dynamjssdkhello"});await t.setItem("dynamjssdkhello","available");}if(v=await M.createInstance({name:"dynamdlsinfo"}),m=S?null:P(P("v2")+String.fromCharCode(k.charCodeAt(k.length/2)+1)+P(k)),!S){try{let t=await v.getItem(m);if(!t){let e=await M.createInstance({name:"dynamltsinfo"});t=await e.getItem(m),t&&await v.setItem(m,t);}t&&([a,p]=JSON.parse(await N(t)));}catch(t){}try{null==a&&(a=W(),v.setItem(m,await _(JSON.stringify([a,null]))));}catch(t){}}})(),H),G=async t=>{z=Date.now(),V||(V=(async()=>{try{let g={pd:e,vm:s,v:i,dt:r||"browser",ed:"javascript",cu:a,ad:k,os:l,fn:h};u&&(g.rmk=u),n&&(-1!=n.indexOf("-")?g.hs=n:g.og=n);let f={};if(p&&!S){let t=await v.getItem(m);t&&([a,p]=JSON.parse(await N(t))),f["lts-time"]=p;}d&&(g.sp=d);let x=await Promise.race([(async()=>{let e,i=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ");p&&!S&&(v.setItem(m,await _(JSON.stringify([a,i]))),p=i);let s,n="auth/?ext="+encodeURIComponent(P(JSON.stringify(g))),r=!1,l=!1,h=async t=>{if(t&&!t.ok)try{let e=await t.text();if(e){let t=JSON.parse(e);t.errorCode&&(s=t,t.errorCode>100&&t.errorCode<200&&(o=null,r=!0,l=!0));}}catch(t){}};try{e=await C(D[0]+n,{headers:f,cache:t?"reload":"default",mode:"cors",timeout:1e4}),await h(e);}catch(t){}if(!(o||e&&e.ok||r))try{e=await C(D[1]+n,{headers:f,mode:"cors",timeout:3e4});}catch(t){}if(!(o||e&&e.ok||r))try{e=await C(D[0]+n,{headers:f,mode:"cors",timeout:3e4}),await h(e);}catch(t){}s&&151==s.errorCode&&!S&&(v.removeItem(m),v.removeItem(y),a=W(),g.cu=a,p=void 0,n="auth/?ext="+encodeURIComponent(P(JSON.stringify(g))),e=await C(D[0]+n,{headers:f,mode:"cors",timeout:3e4}),await h(e)),(()=>{if(!e||!e.ok){let t;l&&v.setItem(y,""),s?111==s.errorCode?t=s.message:(t=s.message.trim(),t.endsWith(".")||(t+="."),t=c?`An error occurred during authorization: ${t} [Contact Dynamsoft](https://www.dynamsoft.com/company/contact/) for more information.`:`An error occurred during authorization: ${t} Contact the site administrator for more information.`):t=c?j.publicTrialFailConnect:j.failConnect;let e=Error(t);throw s&&s.errorCode&&(e.ltsErrorCode=s.errorCode),e}})();let d=await e.text();try{p||S||(v.setItem(m,await _(JSON.stringify([a,i]))),p=i),v.setItem(y,d);}catch(t){}return d})(),new Promise(((t,e)=>{let i;i=c?j.publicTrialNetworkTimeout:j.networkTimeout,setTimeout((()=>e(new Error(i))),o?3e3:15e3);}))]);o=x;}catch(t){g=t;}V=null;})()),await V;},Y=async()=>{$||($=(async()=>{if(B(a),!o){if(!R)throw I(g.message),g;return}let t={dm:k};A&&(t.bd=!0),t.brtk=!0,t.ls=D[0],n&&(-1!=n.indexOf("-")?t.hs=n:t.og=n),t.cu=a,h&&(t.fn=h),e&&(t.pd=e),i&&(t.v=i),r&&(t.dt=r),l&&(t.os=l),u&&(t.rmk=u),B(o);try{t.ar=o,t.bafc=!!g;}catch(t){}B(t);try{await x(t);}catch(t){B("error updl");}await q(),R||(R=!0),$=null;})()),await $;},q=async()=>{let t=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),e=await b();if(B(e),e&&e<t)throw g?new Error(j.dlsErrorAndCacheExpire):new Error(j.checkLocalTime)},J=null;const Z=new Promise((t=>{J=()=>{Z.isPending=!1,Z.isFulfilled=!0,t();};}));let Q=null,K=async(t,e)=>(E=E.then((async()=>{try{let i=await f.keys();if(e||(Z.isFulfilled?t&&(i=i.filter((e=>e<t))):t&&i.includes(t)?i=[t]:(i=[],B("Unexpected null key"))),!i.length)return;for(let t=0;t<i.length/1e3;++t){let e=i.slice(1e3*t,1e3*(t+1)),s=[];for(let t=0;t<e.length;++t)s.push(await f.getItem(e[t]));if(p=(new Date).kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),!S){let t=await v.getItem(m);t&&([a]=JSON.parse(await N(t))),v.setItem(m,await _(JSON.stringify([a,p])));}try{let t,i,n=D[0]+"verify/v2";p&&!S&&(n+="?ltstime="+encodeURIComponent(p));try{t=C(n,{method:"POST",body:s.join(";"),keepalive:!0});}finally{!Z.isFulfilled&&gs&&J();}try{i=await t;}finally{Z.isFulfilled||J();}if(!i.ok)throw new Error("verify failed. Status Code: "+i.status);for(let t=0;t<e.length;++t)await f.removeItem(e[t]);}catch(t){throw Z.isFulfilled||J(),U&&(U(t),U=null),t}}L&&L();}catch(t){}})),await E);return {i:async t=>(e=t.pd,i=t.v,s=i.split(".")[0],t.dt&&(r=t.dt),n=t.l||"",l="string"!=typeof t.os?JSON.stringify(t.os):t.os,h=t.fn,"string"==typeof h&&(h=h.substring(0,255)),t.ls&&t.ls.length&&(D=t.ls,1==D.length&&D.push(D[0])),c=!n||"200001"===n||n.startsWith("200001-"),d=t.sp,u=t.rmk,"string"==typeof u&&(u=u.substring(0,255)),t.lf&&(M=t.lf),t.lsu&&(a=S=t.lsu),t.feab&&(O=t.feab),x=t.updl,w=t.mnet,b=t.mxet,t.sutlcb&&(L=t.sutlcb),await X(),await(async()=>{y=P(String.fromCharCode(n.charCodeAt(0)+10)+P(e)+P(n)+s+P(""+r)),f=await M.createInstance({name:"dynamdlsuns"+P(P("v2"))+P(String.fromCharCode(n.charCodeAt(0)+10)+P(e)+P(n)+s+P(""+r))});try{o=await v.getItem(y);}catch(t){}})(),await G(),await Y(),(!g||g.ltsErrorCode>=102&&g.ltsErrorCode<=120)&&K(null,!0),{ar:o,cu:a}),c:async()=>{let t=new Date;if(t.getTime()<z+36e4)return;let e=t.kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ"),i=await w(),s=await b();if(s&&s<e)await G(!0),await Y();else if(i&&i<e){let e=new Date(t.getTime());e.setMinutes(t.getMinutes()-6);let i=e.kUtilFormat("yyyy-MM-ddTHH:mm:ss.SSSZ");p<i&&G().then((()=>Y()));}},s:async(t,e,i,s)=>{if(e){try{let t;t=e.startsWith("{")&&e.endsWith("}")?await O(e):e,t?(B("bs "+i),await f.setItem(i,t),B("ss "+i)):B("ept ecpt");}catch(t){}s&&(B("bd "+i),await K(i,2==s),B("sd "+i)),Q&&clearTimeout(Q),Q=setTimeout((async()=>{await K();}),36e4);}else await K(i);},p:Z,u:async()=>(await X(),a),caret:q}};var Tp;class Ap{static init(){a(this,Ap,Ep,void 0),a(this,Ap,Mp,void 0),a(this,Ap,Ip,"init");}static reset(){a(this,Ap,Ep,void 0),a(this,Ap,Mp,void 0),a(this,Ap,Ip,"");}static setLicenseInfo(t){var e;a(this,Ap,Ip,"done"),a(this,Ap,Ep,[]),a(this,Ap,Ep,null!==(e=null==t?void 0:t.modules)&&void 0!==e?e:[]);}static setLicenseErr(t){a(this,Ap,Mp,t),a(this,Ap,Ip,"done");}static makeSureLoadLicenseExist(){return l(this,Ap,Dp).call(this,3101,5001)}static makeSureCoreLicenseExist(){return l(this,Ap,Dp).call(this,3101)}static makeSureCameraLicenseExist(){return l(this,Ap,Dp).call(this,3006,8002)}static makeSureAnnotationLicenseExist(){return l(this,Ap,Dp).call(this,15)}static annotationLicenseModuleIsExist(){return l(this,Ap,Rp).call(this,15)}static pdfRLicenseModuleIsExist(){return l(this,Ap,Rp).call(this,5001)}}function kp(t){for(const e of r(this,Tp,Ep))if(e.module===t)return e;return {code:ku.LIC_MISS_MODULE.code,message:ku.LIC_MISS_MODULE.message,module:t}}function Dp(t,e){""===r(this,Tp,Ip)&&ku.throw(ku.INIT_SHOULD_SET_CONFIG),"done"!==r(this,Tp,Ip)&&ku.throw(ku.INIT_CONFIG_NOT_DONE),r(this,Tp,Mp)&&ku.throw(r(this,Tp,Mp));const i=l(this,Tp,kp).call(this,t);0!==i.code&&(!e||e&&0!==l(this,Tp,kp).call(this,e).code)&&ku.throw({code:i.code,message:i.message});}function Rp(t){return 0===l(this,Tp,kp).call(this,t).code}Tp=Ap;var Ep={writable:!0,value:void 0},Mp={writable:!0,value:void 0},Ip={writable:!0,value:""};function Bp(t){let e;if(t){let i;const s=t.message;i=t.ltsErrorCode,js(i)?111===i?i=ku.LIC_EXPIRED.code:106===i||108===i?i=ku.LIC_INVALID.code:i>0&&(i=-(2e4+i)):i=ku.LIC_INVALID.code,e={code:i,message:s};}else e=ku.LIC_INVALID;return e}const Up="3.2.0";var Lp;!function(t){t[t.publicTrial=0]="publicTrial",t[t.privateTrial=1]="privateTrial",t[t.normal=2]="normal";}(Lp||(Lp={}));var Op,Np=new WeakMap,_p=new WeakMap,Wp=new WeakMap,Fp=new WeakMap,Hp=new WeakMap,Vp=new WeakMap,zp=new WeakMap,$p=new WeakMap,jp=new WeakSet,Xp=new WeakSet,Gp=new WeakSet,Yp=new WeakSet,qp=new WeakSet,Jp=new WeakSet;class Zp{constructor(t){v(this,Jp),v(this,qp),v(this,Yp),v(this,Gp),v(this,Xp),v(this,jp),f(this,Np,{writable:!0,value:void 0}),f(this,_p,{writable:!0,value:void 0}),f(this,Wp,{writable:!0,value:void 0}),f(this,Fp,{writable:!0,value:void 0}),f(this,Hp,{writable:!0,value:void 0}),f(this,Vp,{writable:!0,value:void 0}),f(this,zp,{writable:!0,value:void 0}),f(this,$p,{writable:!0,value:void 0}),n(this,_p,void 0),n(this,Np,void 0),n(this,Wp,""),n(this,Fp,""),n(this,Vp,Lp.publicTrial),n(this,$p,void 0),n(this,zp,"");const e=Lu({_pLoad:{isEmpty:!0},_license:t,_licenseServer:[]},!0);let i;if(e&&Xs(e.l)?(i=e.l.trim(),1===e.lt?n(this,Vp,Lp.publicTrial):2===e.lt?n(this,Vp,Lp.privateTrial):n(this,Vp,Lp.normal)):(i="",n(this,Vp,Lp.publicTrial)),""===i?n(this,Np,i):i.includes("-")?n(this,_p,i):n(this,Np,i),Ls(e.ls)){e.ls.length>0&&n(this,$p,e.ls);const t=s(this,$p);let o,r;if(t&&t.length>0){for(o=0;o<t.length;o++)r=t[o],r.endsWith("/")||(t[o]=`${r}/`);p(this,jp,Qp).call(this,t,i)&&n(this,Vp,Lp.publicTrial);}}n(this,zp,e.sp);}async init(t,e,i){let n=t;n.endsWith("/")||(n=`${n}/`),s(this,Hp)||await p(this,Gp,tg).call(this,i);try{await p(this,Jp,sg).call(this,e);}catch(t){const e=Bp(t);let i=!1;e.code===ku.LIC_EXPIRED.code?-1!==e.message.toLowerCase().indexOf("trial license")&&(i=!0):this.isPublicTrial()&&(i=!0),i&&Ou({_bNeverShowDialog:!1,engineResourcePath:n,_onLog:console.log},"error",e.message),ku.throw(e);}}getClientUUID(){return s(this,Fp)}getAuthResult(){return s(this,Wp)}isPublicTrial(){return s(this,Vp)===Lp.publicTrial}setClientUUID(t){n(this,Fp,t);}setAuthResult(t){n(this,Wp,t);}}function Qp(t,e){let i=!0;if(Ls(t)&&t.length>0){const e=t[0];if(Xs(e)&&""!==e){"mlts.dynamsoft.com"!==new URL(e).hostname&&(i=!1);}}return i&&(!e||"200001"===e||e.startsWith("200001-"))}function Kp(){return window.location.origin?window.location.origin.startsWith("http")?window.location.origin:"https://localhost":window.location.href.startsWith("http")?window.location.href:"https://localhost"}function tg(t){const e={dm:p(this,Xp,Kp).call(this),fetch:window.fetch};t&&(e.bd=!0,e.log=console.log),n(this,Hp,Pp(e));}function eg(){return this.isPublicTrial()?"":s(this,_p)||s(this,Np)}function ig(){const t=[];return t.push(ps.browser),t.push(ps.version.toString()),t.push(ps.OS),t.join(" ")}async function sg(t){if(this.getAuthResult()&&this.getClientUUID())return {ar:this.getAuthResult(),cu:this.getClientUUID()};const e={pd:"ddv",dt:"browser",v:Up,os:p(this,qp,ig).call(this),l:p(this,Yp,eg).call(this),ls:s(this,$p),sp:s(this,zp),fn:t||"",mnet(){},mxet(){}};""!==this.getClientUUID()&&(e.lsu=this.getClientUUID()),e.updateLicense=t=>{this.setAuthResult(t.ar),this.getClientUUID()||this.setClientUUID(t.cu);};const i=await s(this,Hp).i(e);return this.getAuthResult()||this.setAuthResult(i.ar),this.getClientUUID()||this.setClientUUID(i.cu),i}async function ng(e){const i=ku.buildInfo("init",{});ku.info(i);let s=e.engineResourcePath.trim();s.endsWith("/")||(s=`${s}/`),no.resourceDir=s,Ap.init();if(!await no.isResourceDirValid())return Ap.reset(),i.status="Failed",ku.info(i),ku.reject(ku.RESOURCE_NOT_FOUND,"DDV.Core.init");if(!await no.isResourceVersionMatch())return Ap.reset(),i.status="Failed",ku.info(i),ku.reject(ku.RESOURCE_NOT_MATCHED,"DDV.Core.init");let n=function(){var e;let i=null;var s;if(mapPackageRegister&&mapPackageRegister.license)i=null===(s=mapPackageRegister.license.LicenseManager)||void 0===s?void 0:s.license;else if(null!==(e=window)&&void 0!==e&&null!==(e=e.Dynamsoft)&&void 0!==e&&null!==(e=e.Core)&&void 0!==e&&null!==(e=e.mapPackageRegister)&&void 0!==e&&e.license){var n;i=null===(n=window.Dynamsoft.Core.mapPackageRegister.license.LicenseManager)||void 0===n?void 0:n.license;}return null!==i?""===i?"":(Xs(i)&&(i=i.trim()),i):null}();null!==n&&""!==n||(n=e.license.trim());let o,r,a=n.startsWith("DLS")||0===n.length,l=!1,h=!1;if(a)try{var c;let i;if(null!=mapPackageRegister&&mapPackageRegister.license?i=await mapPackageRegister.license.getAR():null!==(c=window)&&void 0!==c&&null!==(c=c.Dynamsoft)&&void 0!==c&&null!==(c=c.Core)&&void 0!==c&&null!==(c=c.mapPackageRegister)&&void 0!==c&&c.license&&(i=await window.Dynamsoft.Core.mapPackageRegister.license.getAR()),i)o=i.ar,r=i.u,l=i.pt,i.pk?(o=i.pk,a=!1):h=!0,_s(o)&&i.ae&&ku.throw(Bp(i.ae));else {const t=await async function(t,e,i,s){const n=new Zp(t);return await n.init(e,i,s),{authResult:n.getAuthResult(),clientUUID:n.getClientUUID(),bPublicTrial:n.isPublicTrial()}}(n,s,e.deviceFriendlyName||"");o=t.authResult,r=t.clientUUID,l=t.bPublicTrial;}}catch(t){throw Ap.setLicenseErr(t),i.status="Failed",ku.info(i),t}else o=n,r="";const d={licenseInfo:null};try{const t=await no.getLicenseInfo(o,a,r);d.licenseInfo=t,Ap.setLicenseInfo(t),!h&&l&&t.trial&&t.msg&&Ou({_bNeverShowDialog:!1,engineResourcePath:s,_onLog:console.log},"warn",t.msg);}catch(t){throw t&&t.code<=-8e4&&Ap.setLicenseErr(t),i.status="Failed",ku.info(i),t}return a&&(d.deviceUuid=r),i.status="Completed",ku.info(i),d}const og={scrollToLatest:!1};class rg{constructor(t){i(this,"viewerUids",void 0),i(this,"groupUid",void 0),i(this,"config",void 0),i(this,"isSetScrollToLatest",!1),this.groupUid=t,this.viewerUids=new Set,this.config=Ns(og);}getViewerUids(){return [...this.viewerUids.values()]}updateConfig(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this.config,t);}}var ag,lg;!function(t){t.LEFT="left",t.TOP="top",t.RIGHT="right",t.BOTTOM="bottom";}(ag||(ag={})),function(t){t.DEFAULT="default",t.CAPTURE="capture",t.PERSPECTIVE="perspective",t.THUMBNAIL="thumbnail";}(lg||(lg={}));class hg{constructor(){i(this,"db",void 0),this.db=new Map;}async set(t,e){return new Promise(((i,s)=>{this.db.has(t)?s(new Error(`The item ${t} already exists.`)):(this.db.set(t,e),i(`Save ${t} to database successful.`));}))}async get(t){return new Promise(((e,i)=>{this.db.has(t)?e(this.db.get(t)):i(new Error(`The item ${t} does not exist.`));}))}async remove(t){return new Promise(((e,i)=>{const s=this.db.get(t);this.db.delete(t),e(s);}))}async update(t,e){return new Promise(((i,s)=>{this.db.has(t)?(this.db.set(t,e),i(`Update ${t} successful.`)):s(new Error(`The item ${t} does not exist.`));}))}dispose(){this.db.clear();}reset(){this.db.clear();}}class cg extends Qn{constructor(){super(),i(this,"openDocument",void 0),i(this,"closeDocument",void 0),i(this,"syncDocument",void 0),i(this,"addPagesToDoc",void 0),i(this,"deletePages",void 0),i(this,"updatePage",void 0),i(this,"reorderPages",void 0),i(this,"movePages",void 0),i(this,"swapPages",void 0),i(this,"selectedPageChanged",void 0),i(this,"pageChanged",void 0),i(this,"pageChangedAfterRender",void 0),i(this,"pageExistenceChanged",void 0),i(this,"currentPageChanged",void 0),i(this,"currentIndexChanged",void 0),i(this,"pageRendered",void 0),i(this,"pagesDropped",void 0),i(this,"pagesDragged",void 0),i(this,"tabChanged",void 0),i(this,"displayModeChanged",void 0),i(this,"fitModeChanged",void 0),i(this,"filterChanged",void 0),i(this,"toolModeChanged",void 0),i(this,"zoomChanged",void 0),i(this,"visibleChanged",void 0),i(this,"beforeLayout",void 0),i(this,"afterLayout",void 0),i(this,"beforeRender",void 0),i(this,"afterRender",void 0),i(this,"destroy",void 0),i(this,"resize",void 0),i(this,"scroll",void 0),i(this,"uiInitCompleted",void 0),i(this,"cropRectDrawn",void 0),i(this,"cropRectDeleted",void 0),i(this,"cropRectModified",void 0),i(this,"cropModeChanged",void 0),i(this,"beforeCropPages",void 0),i(this,"afterCropPages",void 0),i(this,"operationsChanged",void 0),i(this,"perspectiveQuadChanged",void 0),i(this,"quadSelectionStyleChanged",void 0),i(this,"autoCaptureChanged",void 0),i(this,"autoDetectChanged",void 0),i(this,"torchChanged",void 0),i(this,"cameraPlayed",void 0),i(this,"cameraClosed",void 0),i(this,"cameraInit",void 0),i(this,"cameraChanged",void 0),i(this,"cameraCaptured",void 0),i(this,"annotationsUpdated",void 0),i(this,"annotationModeChanged",void 0),i(this,"annotationDefaultStyleChanged",void 0),i(this,"selectedAnnotationsChanged",void 0),i(this,"annotationLayerStateChanged",void 0),i(this,"beforeAnnotationEdit",void 0),i(this,"afterAnnotationEdit",void 0),i(this,"beforeAnnotationDraw",void 0),i(this,"afterAnnotationDraw",void 0),i(this,"annotationTextCharsSelected",void 0),i(this,"annotationTextContentUpdated",void 0),i(this,"annotationTextEditorResized",void 0),i(this,"searchTextChanged",void 0),i(this,"searchTextSelected",void 0),i(this,"searchTextCleared",void 0),i(this,"textSelected",void 0),i(this,"beforeTextSelected",void 0),i(this,"afterTextSelected",void 0),i(this,"layoutReason",void 0),i(this,"renderReason",void 0),this.openDocument=to(this),this.closeDocument=to(this),this.syncDocument=to(this),this.addPagesToDoc=to(this),this.deletePages=to(this),this.updatePage=to(this),this.reorderPages=to(this),this.movePages=to(this),this.swapPages=to(this),this.selectedPageChanged=to(this),this.pageChanged=to(this),this.pageChangedAfterRender=to(this),this.pageExistenceChanged=to(this),this.currentPageChanged=to(this),this.currentIndexChanged=to(this),this.pageRendered=to(this),this.pagesDragged=to(this),this.pagesDropped=to(this),this.tabChanged=to(this),this.displayModeChanged=to(this),this.fitModeChanged=to(this),this.filterChanged=to(this),this.toolModeChanged=to(this),this.zoomChanged=to(this),this.visibleChanged=to(this),this.cropModeChanged=to(this),this.beforeLayout=to(this),this.afterLayout=to(this),this.beforeRender=to(this),this.afterRender=to(this),this.resize=to(this),this.scroll=to(this),this.uiInitCompleted=to(this),this.destroy=to(this),this.cropRectDrawn=to(this),this.cropRectDeleted=to(this),this.cropRectModified=to(this),this.cropModeChanged=to(this),this.beforeCropPages=to(this),this.afterCropPages=to(this),this.operationsChanged=to(this),this.perspectiveQuadChanged=to(this),this.quadSelectionStyleChanged=to(this),this.autoCaptureChanged=to(this),this.autoDetectChanged=to(this),this.torchChanged=to(this),this.cameraPlayed=to(this),this.cameraClosed=to(this),this.cameraInit=to(this),this.cameraChanged=to(this),this.cameraCaptured=to(this),this.annotationModeChanged=to(this),this.selectedAnnotationsChanged=to(this),this.annotationLayerStateChanged=to(this),this.annotationDefaultStyleChanged=to(this),this.beforeAnnotationEdit=to(this),this.afterAnnotationEdit=to(this),this.beforeAnnotationDraw=to(this),this.afterAnnotationDraw=to(this),this.annotationsUpdated=to(this),this.annotationTextCharsSelected=to(this),this.annotationTextContentUpdated=to(this),this.annotationTextEditorResized=to(this),this.searchTextChanged=to(this),this.searchTextSelected=to(this),this.searchTextCleared=to(this),this.textSelected=to(this),this.beforeTextSelected=to(this),this.afterTextSelected=to(this),this.layoutReason=to(this),this.renderReason=to(this);}}class dg{static numberArrayIsValid(t,e,i,s,n){return l(this,dg,ug).call(this,t,1,e,i,n,s)}static stringArrayIsValid(t,e){return l(this,dg,ug).call(this,t,2,void 0,void 0,0,e)}static blobArrayIsValid(t,e){return l(this,dg,ug).call(this,t,4,void 0,void 0,void 0,e)}static quadIsValid(t,e){const i=[],s="Quad";l(this,dg,vg).call(this,i,t,6,l(this,dg,gg).call(this,s,e,void 0),4);let n=0;for(const o of t){const t=`[${n}]`;i.push(...l(this,dg,ug).call(this,o,1,void 0,void 0,2,l(this,dg,gg).call(this,s,e,t,!0))),n+=1;}return i}static docDetectConfigIsValid(t,e){const i=[],s="DocumentDetectConfig";return l(this,dg,vg).call(this,i,t,5,l(this,dg,gg).call(this,s,e)),l(this,dg,vg).call(this,i,t.autoCaptureDelay,1,l(this,dg,gg).call(this,s,e,"autoCaptureDelay")),_s(t.acceptedPolygonConfidence)||l(this,dg,vg).call(this,i,t.acceptedPolygonConfidence,1,l(this,dg,gg).call(this,s,e,"acceptedPolygonConfidence")),_s(t.enableAutoCapture)||l(this,dg,vg).call(this,i,t.enableAutoCapture,3,l(this,dg,gg).call(this,s,e,"enableAutoCapture")),i}static docDetectConfIsValid(t,e){const i=[],s="DocumentDetectConfidence";return l(this,dg,vg).call(this,i,t,5,l(this,dg,gg).call(this,s,e)),l(this,dg,vg).call(this,i,t.angleConfidence,1,l(this,dg,gg).call(this,s,e,"angleConfidence"),0,100),l(this,dg,vg).call(this,i,t.areaConfidence,1,l(this,dg,gg).call(this,s,e,"areaConfidence"),0,100),l(this,dg,vg).call(this,i,t.centerConfidence,1,l(this,dg,gg).call(this,s,e,"centerConfidence"),0,100),i}static imageDataIsValid(t,e){const i=[],s="VImageData";return l(this,dg,vg).call(this,i,t,5,l(this,dg,gg).call(this,s,e)),l(this,dg,vg).call(this,i,t.data,8,l(this,dg,gg).call(this,s,e,"data")),l(this,dg,vg).call(this,i,t.type,9,l(this,dg,gg).call(this,s,e,"type")),_s(t.height)||l(this,dg,vg).call(this,i,t.height,1,l(this,dg,gg).call(this,s,e,"height")),_s(t.width)||l(this,dg,vg).call(this,i,t.width,1,l(this,dg,gg).call(this,s,e,"width")),i}static filterTypeIsValid(t,e){const i=[];return l(this,dg,vg).call(this,i,t,10,l(this,dg,gg).call(this,"EnumImageFilterType",e)),i}static imageEncodeOptionIsValid(t,e){const i=[],s="ImageEncodeOption";return l(this,dg,vg).call(this,i,t,5,l(this,dg,gg).call(this,s,e)),l(this,dg,vg).call(this,i,t.type,9,l(this,dg,gg).call(this,s,e,"type")),_s(t.params)||l(this,dg,vg).call(this,i,t.params,5,l(this,dg,gg).call(this,s,e,"params")),i}static makeSureNumberValid(t,e,i,s,n,o){return l(this,dg,pg).call(this,l(this,dg,Ag).call(this,t,e,i),s,n,o)}static makeSureStringValid(t,e,i,s){return l(this,dg,pg).call(this,{isValid:l(this,dg,kg).call(this,t)},e,i,s)}static makeSureDetectResultValid(t,e,i,s){const n=[],o="DetectResult";l(this,dg,vg).call(this,n,t,5,l(this,dg,gg).call(this,o,s)),n.push(...dg.quadIsValid(null==t?void 0:t.location,o)),l(this,dg,vg).call(this,n,null==t?void 0:t.width,1,l(this,dg,gg).call(this,o,s,"width"),1,void 0),l(this,dg,vg).call(this,n,null==t?void 0:t.height,1,l(this,dg,gg).call(this,o,s,"height"),1,void 0),n.push(...dg.docDetectConfigIsValid(null==t?void 0:t.config,o)),null!=t&&t.confidence&&l(this,dg,vg).call(this,n,t.confidence,1,l(this,dg,gg).call(this,o,s,"confidence")),this.makeSureValid(n,e,i);}static makeSureValid(t,e,i,s){0!==t.length&&l(this,dg,fg).call(this,t,e,i,s);}static makeSureMissing(t,e,i){_s(t)&&l(this,dg,fg).call(this,void 0,e,i,ku.PARAM_MISS);}static makeSureCameraObject(t,e,i){const s=[],n=i;this.makeSureMissing(t,e,i),Xs(t)?this.makeSureStringValid(t,e,i):(l(this,dg,vg).call(this,s,t,5,l(this,dg,gg).call(this,n)),l(this,dg,vg).call(this,s,t.deviceId,2,l(this,dg,gg).call(this,n,void 0,"deviceId")),l(this,dg,vg).call(this,s,t.label,2,l(this,dg,gg).call(this,n,void 0,"label")),this.makeSureValid(s,e,i));}static initTypeCheckMap(){r(this,dg,Eg)[7]=Fs,r(this,dg,Eg)[15]=Xs,r(this,dg,Eg)[3]=Vs,r(this,dg,Eg)[5]=Os,r(this,dg,Eg)[4]=Hs,r(this,dg,Eg)[2]=l(this,dg,kg),r(this,dg,Eg)[8]=l(this,dg,yg),r(this,dg,Eg)[11]=l(this,dg,Sg),r(this,dg,Eg)[12]=l(this,dg,Cg),r(this,dg,Eg)[13]=l(this,dg,Pg),r(this,dg,Eg)[14]=l(this,dg,Tg),r(this,dg,Eg)[1]=l(this,dg,Ag),r(this,dg,Eg)[6]=l(this,dg,xg),r(this,dg,Eg)[9]=l(this,dg,wg),r(this,dg,Eg)[10]=l(this,dg,bg),r(this,dg,Eg)[16]=l(this,dg,Dg);}}function ug(t,e,i,s,n,o){const r=[],a="Array";if(l(this,Op,vg).call(this,r,t,6,l(this,Op,gg).call(this,a,o),n),r.length>0)return r;let h=0;for(const n of t){const t=`[${h}]`;l(this,Op,vg).call(this,r,n,e,l(this,Op,gg).call(this,a,o,t,!0),i,s),h+=1;}return r}function pg(t,e,i,s){const{isValid:n,isInRange:o,isSupported:r}=t,a=!!_s(n)||n,h=!!_s(o)||o,c=!!_s(r)||r;a&&h&&c||(s||(s=a?h?ku.PARAM_NOT_SUPPORT:ku.PARAM_OUT_OF_RANGE:ku.PARAM_INVALID),l(this,Op,fg).call(this,void 0,e,i,s));}function gg(t,e,i,s){return e?i?`${e}${s?"":"."}${i}`:`${e}`:i?`${t}${s?"":"."}${i}`:`${t}`}function fg(t,e,i,s){const n=_s(s)?{...ku.PARAM_INVALID}:{...s};t&&(n.details=t),ku.throw(n,e,i);}function vg(t,e,i,s,n,o){const r=l(this,Op,mg).call(this,e,i,s,n,o);r&&t.push(r);}function mg(t,e,i,s,n){if(_s(t))return `${i} is missing.`;const o=r(this,Op,Eg)[e];if(o){const e=o.bind(this)(t,s,n);if(Vs(e)){if(!e)return `${i} is invalid.`}else if(Os(e)){const{isValid:t,isInRange:s,isSupported:n}=e;if(!1===t)return `${i} is invalid.`;if(!1===s)return `${i} is out of range.`;if(!1===n)return `${i} is not supported.`}}}function yg(t){return Fs(t)||Hs(t)}function xg(t,e){return Ls(t)?js(e)&&0===t.length||!_s(e)&&t.length<e?{isValid:!1}:{isValid:!0,isInRange:!!_s(e)||t.length>=e}:{isValid:!1}}function wg(t){return js(t)?{isValid:!0,isInRange:t>=uo.RGBA&&t<=uo.PNG}:{isValid:!1}}function bg(t){return Xs(t)?{isValid:!0,isInRange:(e=t,!!bu.get(e))}:{isValid:!1};var e;}function Sg(t){return void 0!==jo.get(t)}function Cg(t){return void 0!==Xo.get(t)}function Pg(t){return void 0!==$o.get(t)}function Tg(t){if(Xs(t)){const e=t.trim();return -1!==r(this,Op,Rg).indexOf(e)}return !1}function Ag(t,e,i){let s=!0;return js(t)?(_s(e)||(s=t>=e),!_s(i)&&s&&(s=t<=i),{isValid:!0,isInRange:s}):{isValid:!1}}function kg(t){return !!Xs(t)&&0!==t.trim().length}function Dg(t){if(!l(this,Op,kg).call(this,t))return {isValid:!1};const e=t.match(/^D:(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(?:([+-])(\d{2})['](\d{2})[']|)$/);let i=!1;if(e){const[,t,s,n,o,r,a,l,h,c]=e,d=new Date(`${t}-${s}-${n}T${o}:${r}:${a}`);if(i=!0,d.getFullYear()===parseInt(t,10)&&d.getMonth()+1===parseInt(s,10)&&d.getDate()===parseInt(n,10)&&d.getHours()===parseInt(o,10)&&d.getMinutes()===parseInt(r,10)&&d.getSeconds()===parseInt(a,10)||(i=!1),i&&l){const t=parseInt(h,10),e=parseInt(c,10);("+"===l&&(t<0||t>12||e<0||e>59)||"-"===l&&(t<0||t>12||e<0||e>59))&&(i=!1);}}return {isSupported:i}}Op=dg;var Rg={writable:!0,value:["1.1","1.2","1.3","1.4","1.5","1.6","1.7"]},Eg={writable:!0,value:Object.create(null)};dg.initTypeCheckMap();class Mg{constructor(t){i(this,"maxConcurrency",void 0),i(this,"currentConcurrency",void 0),i(this,"queue",void 0),this.maxConcurrency=t,this.currentConcurrency=0,this.queue=[];}async acquire(){return new Promise((t=>{this.currentConcurrency<this.maxConcurrency?(this.currentConcurrency+=1,t(!0)):this.queue.push(t);}))}release(){if(this.queue.length>0){this.queue.shift()();}else this.currentConcurrency-=1;}}class Ig{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;i(this,"tasks",void 0),i(this,"semaphore",void 0),this.tasks=[],this.semaphore=new Mg(t);}async process(t){await this.semaphore.acquire();let e=null;try{t.cancelled||(e=await this.handler(t.taskUid));}catch(t){e=null;}if(t.completed=!0,this.tasks.includes(t)){const e=this.tasks.indexOf(t);this.tasks.splice(e,1);}t.emitter.emit(t.taskUid,e),this.semaphore.release();}async executeTask(t){return new Promise(((e,i)=>{let s=this.tasks.find((e=>e.taskUid===t));s||(s={taskUid:t,emitter:new Qs,completed:!1,cancelled:!1,running:!1},this.tasks.push(s)),s.cancelled=!1,s.emitter.on(t,(t=>{e(t);})),s.running||(s.running=!0,this.process(s));}))}cancel(t){const e=this.tasks.find((e=>e.taskUid===t));e&&(e.cancelled=!0);}destroy(){this.tasks=[];}async handler(t){return Promise.resolve(null)}}class Bg extends Ig{async handler(t){return new Promise(((e,i)=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{s.onload=null,s.onerror=null,e(s);},s.onerror=t=>{s.onload=null,s.onerror=null,e(null);},s.src=t;}))}}class Ug extends Bg{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){let e=this.core.pageService.getPage(t);if(!e||e.isDestroyed)return null;let{img:i}=e.raw;if(!i){let{url:s}=e.raw;if(!s){let i=e.raw.data;if(!i){let s=await this.core.imageDataService.getRaw(t);const n=this.core.pageService.getPage(t);if(!n)return null;if(e.isDestroyed&&!n.isDestroyed&&(s=await this.core.imageDataService.getRaw(t,!0)),!s||n.isDestroyed)return null;i=s.data;}s=URL.createObjectURL(i),e.raw.url=s;}if(i=await this.imageLoader.executeTask(s),e=this.core.pageService.getPage(t),!e||e.isDestroyed)return null;e.raw.img=i;}return i}}class Lg extends Bg{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let s=null===(e=i.original)||void 0===e?void 0:e.img;if(!s){var n;let e=null===(n=i.original)||void 0===n?void 0:n.url;if(!e){var o;let s=null===(o=i.original)||void 0===o?void 0:o.data;if(!s){let e=await this.core.imageDataService.getOriginal(t);const n=this.core.pageService.getPage(t);if(!n)return null;if(i.isDestroyed&&!n.isDestroyed&&(e=await this.core.imageDataService.getRaw(t,!0)),!e||n.isDestroyed)return null;s=e.data;}e=URL.createObjectURL(s),i.original.url=e;}if(s=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),!i||i.isDestroyed)return null;i.original.img=s;}return s}}class Og extends Bg{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let s=null===(e=i.display)||void 0===e?void 0:e.img;if(!s){var n;let e=null===(n=i.display)||void 0===n?void 0:n.url;if(!e){var o;let s=null===(o=i.display)||void 0===o?void 0:o.data;if(!s){let e=await this.core.imageDataService.getDisplay(t,!0);const n=this.core.pageService.getPage(t);if(!n)return null;if(i.isDestroyed&&!n.isDestroyed&&(e=await this.core.imageDataService.getDisplay(t,!0)),!e||n.isDestroyed)return null;s=e.data;}e=URL.createObjectURL(s),i.display.url=e;}const{filter:r}=i;if(s=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),!i||i.isDestroyed)return null;if(r!==i.filter)return this.handler(i.uid);i.display.img=s;}return s}}class Ng extends Bg{constructor(t,e){super(),i(this,"core",void 0),i(this,"imageLoader",void 0),this.core=t,this.imageLoader=e;}async handler(t){var e;let i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let s=null===(e=i.thumbnail)||void 0===e?void 0:e.img;if(!s){var n;let e=null===(n=i.thumbnail)||void 0===n?void 0:n.url;if(!e){var o;let s=null===(o=i.thumbnail)||void 0===o?void 0:o.data;if(!s){const e=await this.core.imageDataService.getThumbnail(t);if(i=this.core.pageService.getPage(t),!e||i.isDestroyed)return null;s=e.data;}e=URL.createObjectURL(s),i.thumbnail.url=e;}if(s=await this.imageLoader.executeTask(e),i=this.core.pageService.getPage(t),i.isDestroyed)return null;i.thumbnail.img=s;}return s}}class _g{constructor(t){i(this,"rawImageLoader",void 0),i(this,"originalImageLoader",void 0),i(this,"displayImageLoader",void 0),i(this,"thumbnailImageLoader",void 0);const e=new Bg;this.rawImageLoader=new Ug(t,e),this.originalImageLoader=new Lg(t,e),this.displayImageLoader=new Og(t,e),this.thumbnailImageLoader=new Ng(t,e);}async loadRawImage(t){return this.rawImageLoader.executeTask(t)}cancelLoadRawImage(t){this.rawImageLoader.cancel(t);}async loadOriginalImage(t){return this.originalImageLoader.executeTask(t)}cancelLoadOriginalImage(t){this.originalImageLoader.cancel(t);}async loadDisplayImage(t){return this.displayImageLoader.executeTask(t)}cancelLoadDisplayImage(t){this.displayImageLoader.cancel(t);}async loadThumbnailImage(t){return this.thumbnailImageLoader.executeTask(t)}cancelLoadThumbnailImage(t){this.thumbnailImageLoader.cancel(t);}}class Wg{constructor(t,e,s){i(this,"worker",void 0),i(this,"id",void 0),i(this,"manager",void 0),i(this,"callbacks",{}),i(this,"busy",!1),i(this,"counter",0),i(this,"tasks",[]),this.worker=t,this.id=e,this.manager=s,this.worker.addEventListener("message",(t=>{this.onMessage(t);}),!1);}cancel(t){t.forEach((t=>{const e=this.tasks.findIndex((e=>e.taskUid===t));if(e>=0){const t=this.tasks.splice(e,1)[0];this.callbacks[t.callbackId]&&delete this.callbacks[t.callbackId];}}));}setBusy(t){if(this.busy=t,!t)if(this.tasks.length){const t=this.tasks.shift();this.send(t);}else this.worker.terminate(),this.manager.removeActor(this);}isBusy(){return this.busy}getWorker(){return this.worker}onMessage(t){this.setBusy(!1);const{callbackId:e}=t.data,i=e?this.callbacks[e]:null;i&&i(t.data),delete this.callbacks[e];}send(t,e){if(this.busy)return void this.tasks.push({...t});this.setBusy(!0);const i=`${this.id}-${t.action}-cb-${this.counter}`;t.callback&&(this.callbacks[i]=t.callback,this.counter+=1),t.callbackId=i;const s=t.handler(),n={taskUid:t.taskUid,callbackId:i,...s};(e=n.source)?this.worker.postMessage(n,[e.data.buffer]):this.worker.postMessage(n);}}class Fg{constructor(t,e){i(this,"concurrency",1),i(this,"actors",[]),i(this,"workerUrl",void 0),this.workerUrl=t,this.concurrency=e;}send(t,e){this.getActor().send(t,e);}getActor(){const t=this.actors.filter((t=>!t.isBusy()))[0];if(t)return t;if(this.actors.length<this.concurrency){const t=new Worker(this.workerUrl),e=new Wg(t,this.actors.length,this);return this.actors.push(e),e}const e=Math.floor(Math.random()*this.concurrency);return this.actors[e]}removeActor(t){const e=this.actors.indexOf(t);this.actors.splice(e,1);}cancel(t){for(const e of this.actors)e.cancel(t);for(const t of this.actors)t.setBusy(!1);}clear(){for(const t of this.actors)t.getWorker().terminate();this.actors=[];}}function Hg(){onmessage=t=>{const{index:e}=t.data,i=t.data.sourceWidth,s=t.data.sourceHeight,n=t.data.width,o=t.data.height,r=t.data.source.data,a=n*o*4,l=new ArrayBuffer(a);let h=null;try{h=new Uint8ClampedArray(l,0,a);}catch(t){h=new Uint8Array(l,0,a);}for(let t=0;t<o;t++){const e=t*s/o,a=Math.floor(e),l=1-(e-a),c=a,d=(t+1)*s/o,u=Math.floor(d-1e-5),p=d-u,g=u;let f=t*n*4;for(let t=0;t<n;t++){const e=t*i/n,s=Math.floor(e),o=1-(e-s),a=s,d=(t+1)*i/n,u=Math.floor(d-1e-5),v=d-u,m=u;let y=0,x=0,w=0,b=0,S=0;const C=255;let P,T,A=(c+1)*i*4+4*a;for(P=c+1;P<g;++P){const t=C;y+=r[A+2]*o*t,x+=r[A+1]*o*t,w+=r[A]*o*t,b+=r[A+3]*o*t,S+=C*o,A+=4*i;}let k=(c+1)*i*4+4*m;for(P=c+1;P<g;++P){const t=C;y+=r[k+2]*v*t,x+=r[k+1]*v*t,w+=r[k]*v*t,b+=r[k+3]*v*t,S+=C*v,k+=4*i;}let D=c*i*4+4*(a+1);for(T=a+1;T<m;++T){const t=C;y+=r[D+2]*l*t,x+=r[D+1]*l*t,w+=r[D]*l*t,b+=r[D+3]*l*t,S+=C*l,D+=4;}let R=g*i*4+4*(a+1);for(T=a+1;T<m;++T){const t=C;y+=r[R+2]*p*t,x+=r[R+1]*p*t,w+=r[R]*p*t,b+=r[R+3]*p*t,S+=C*p,R+=4;}for(P=c+1;P<g;++P){let t=P*i*4+4*(a+1);for(T=a+1;T<m;++T){const e=C;y+=r[t+2]*e,x+=r[t+1]*e,w+=r[t]*e,b+=r[t+3]*e,S+=e,t+=4;}}let E=c*i*4+4*a;const M=C;y+=r[E+2]*(l*o)*M,x+=r[E+1]*(l*o)*M,w+=r[E]*(l*o)*M,b+=r[E+3]*(l*o)*M,S+=C*(l*o),E=c*i*4+4*m;const I=C;y+=r[E+2]*(l*v)*I,x+=r[E+1]*(l*v)*I,w+=r[E]*(l*v)*I,b+=r[E+3]*(l*v)*I,S+=C*(l*v),E=g*i*4+4*a;const B=C;y+=r[E+2]*(p*o)*B,x+=r[E+1]*(p*o)*B,w+=r[E]*(p*o)*B,b+=r[E+3]*(p*o)*B,S+=C*(p*o),E=g*i*4+4*m;const U=C;y+=r[E+2]*(p*v)*U,x+=r[E+1]*(p*v)*U,w+=r[E]*(p*v)*U,b+=r[E+3]*(p*v)*U,S+=C*(p*v);let L=b/S,O=0,N=0,_=0;0!==L&&(O=y/S,N=x/S,_=w/S),O+=.5,N+=.5,_+=.5,L+=.5,h[f]=Math.floor(_),f+=1,h[f]=Math.floor(N),f+=1,h[f]=Math.floor(O),f+=1,h[f]=Math.floor(L),f+=1;}}let c={index:e,target:h,taskUid:t.data.taskUid,callbackId:t.data.callbackId};try{postMessage(c,[h.buffer]);}catch(t){postMessage(c,null);}c=null,h=null,t=null;};}let Vg=class{constructor(){i(this,"actorSystem",void 0),i(this,"concurrency",3);const t=window.URL.createObjectURL(new Blob(["(",Hg.toString(),")()"],{type:"text/plain"}));this.actorSystem=new Fg(t,this.concurrency);}cancel(t){this.actorSystem.cancel(t);}optimize(t,e){return new Promise(((i,s)=>{const n={taskUid:t,action:"optimize",handler:e,callback(t){i(t);}};this.actorSystem.send(n);}))}};class zg{constructor(){}reset(){}async perspectivePreview(t,e,i,s){var n,o,r;let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const l=new wo,h=await l.initImage({source:t,isRGBA:e===uo.RGBA,width:s.width,height:s.height,isBGRA:e===uo.BGRA});h.srcBuffer&&(t=h.srcBuffer);let c=s.width,d=s.height;const u=null!==(n=s.angle)&&void 0!==n?n:0;90!==u&&270!==u||(c=s.height,d=s.width);const p=Math.min((null!==(o=a.width)&&void 0!==o?o:c)/c,(null!==(r=a.height)&&void 0!==r?r:d)/d),g=Math.floor(c*p+.5),f=Math.floor(d*p+.5);await l.resize(g,f,a.mode),null!=s&&s.angle&&await l.rotate({angle:s.angle});const v=[[Math.floor(i[0][0]*p+.5),Math.floor(i[0][1]*p+.5)],[Math.floor(i[1][0]*p+.5),Math.floor(i[1][1]*p+.5)],[Math.floor(i[2][0]*p+.5),Math.floor(i[2][1]*p+.5)],[Math.floor(i[3][0]*p+.5),Math.floor(i[3][1]*p+.5)]];await l.drawQuadrangle({location:v,strokeColor:a.strokeColor,lineWidth:a.lineWidth});const m=await l.getImage({ifDeleteObject:!0,isRGBA:e===uo.RGBA,returnType:go.RT_BINARY});await l.freeReservedData();const y={data:new Blob([m.imageData],{type:m.blobType}),width:m.imageWidth,height:m.imageHeight,resolutionX:m.imageXResolution,resolutionY:m.imageYResolution};return l.terminate(),y}async resize(t,e,i,s,n){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const r=new wo,a=await r.initImage({source:t,isRGBA:e===uo.RGBA,width:i,height:s,isBGRA:e===uo.BGRA});if(a.srcBuffer&&(t=a.srcBuffer),n>0){let t=1;t=i>s?i/n:s/n;const e=Math.floor(i/t+.5),a=Math.floor(s/t+.5);await r.resize(e,a,o.mode);}const l=await r.getImage({ifDeleteObject:!0,isRGBA:e===uo.RGBA,returnType:go.RT_BINARY});await r.freeReservedData();const h={data:new Blob([l.imageData],{type:l.blobType}),width:l.imageWidth,height:l.imageHeight,resolutionX:l.imageXResolution,resolutionY:l.imageYResolution};return r.terminate(),h}}class $g extends er{static create(t,e,i){return new $g(t,e,i)}constructor(t,e,s){super("renameDocument"),i(this,"docUid",void 0),i(this,"oldName",void 0),i(this,"newName",void 0),this.docUid=t,this.oldName=e,this.newName=s;}}class jg extends er{static create(t,e){return new jg(t,e)}constructor(t,e){super("paginationChanged"),i(this,"current",void 0),i(this,"total",void 0),this.current=t,this.total=e;}}class Xg extends er{static create(t,e){return new Xg(t,e)}constructor(t,e){super("visibleChanged"),i(this,"newVisibility",void 0),i(this,"oldVisibility",void 0),this.newVisibility=t,this.oldVisibility=e;}}class Gg extends er{static create(t,e,i){return new Gg(t,e,i)}constructor(t,e,s){super("openDocument"),i(this,"doc",void 0),i(this,"viewerUid",void 0),i(this,"groupUid",void 0),this.doc=t,this.viewerUid=e,this.groupUid=s;}}class Yg extends er{static create(t,e,i){return new Yg(t,e,i)}constructor(t,e,s){super("closeDocument"),i(this,"doc",void 0),i(this,"viewerUid",void 0),i(this,"groupUid",void 0),this.doc=t,this.viewerUid=e,this.groupUid=s;}}class qg extends er{static create(t,e,i,s){return new qg(t,e,i,s)}constructor(t,e,s,n){super("gotoPage"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"index",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=s,this.index=n;}}class Jg extends er{static create(t,e,i){return new Jg(t,e,i)}constructor(t,e,s){super("filterChanged"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"filterType",void 0),this.docUid=t,this.pageUids=e,this.filterType=s;}}class Zg extends er{static create(t,e,i,s){return new Zg(t,e,i,s)}constructor(t,e,s,n){super("currentChangedByScroll"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"current",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=s,this.current=n;}}class Qg extends er{static create(t,e,i){return new Qg(t,e,i)}constructor(t,e,s){super("perspectiveQuadChanged"),i(this,"newQuad",void 0),i(this,"oldQuad",void 0),i(this,"isFull",void 0),this.newQuad=t,this.oldQuad=e,this.isFull=s;}}class Kg extends er{static create(t,e,i){return new Kg(t,e,i)}constructor(t,e,s){super("operationsChanged"),i(this,"docUid",void 0),i(this,"undo",void 0),i(this,"redo",void 0),this.docUid=t,this.undo=e,this.redo=s;}}class tf extends er{static create(t,e,i,s,n){return new tf(t,e,i,s,n)}constructor(t,e,s,n,o){super("perspective"),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"quad",void 0),i(this,"width",void 0),i(this,"height",void 0),this.docUid=t,this.pageUid=e,this.quad=s,this.width=n,this.height=o;}}class ef extends er{static create(t){return new ef(t)}constructor(t){super("deleteDocs"),i(this,"docUids",void 0),this.docUids=t;}}class sf extends er{static create(t){return new sf(t)}constructor(t){super("viewerCreated"),i(this,"viewer",void 0),this.viewer=t;}}class nf extends er{static create(t,e){return new nf(t,e)}constructor(t,e){super("textSelected"),i(this,"text",void 0),i(this,"detail",void 0),this.text=t,this.detail=e;}}class of extends er{static create(t,e,i,s,n,o,r,a){return new of(t,e,i,s,n,o,r,a)}constructor(t,e,s,n,o,r){let a=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7&&void 0!==arguments[7]&&arguments[7];super("textSearchChanged"),i(this,"text",void 0),i(this,"searchConfig",void 0),i(this,"searchResults",void 0),i(this,"searchUid",void 0),i(this,"searchType",void 0),i(this,"addedResults",void 0),i(this,"isLastPage",void 0),i(this,"isEditPages",void 0),this.text=t,this.searchConfig=e,this.searchResults=s,this.searchUid=n,this.searchType=o,this.addedResults=r,this.isLastPage=a,this.isEditPages=l;}}class rf extends er{static create(t){return new rf(t)}constructor(t){super("cropRectDeleted"),i(this,"rect",void 0),this.rect=t;}}class af extends er{static create(t){return new af(t)}constructor(t){super("cropRectDrawn"),i(this,"rect",void 0),this.rect=t;}}class lf extends er{static create(t,e){return new lf(t,e)}constructor(t,e){super("cropRectModified"),i(this,"oldRect",void 0),i(this,"newRect",void 0),this.oldRect=t,this.newRect=e;}}class hf extends er{static create(t,e){return new hf(t,e)}constructor(t,e){super("currentIndexChanged"),i(this,"oldIndex",void 0),i(this,"newIndex",void 0),this.oldIndex=t,this.newIndex=e;}}class cf extends er{static create(t,e){return new cf(t,e)}constructor(t,e){super("displayModeChanged"),i(this,"oldDisplayMode",void 0),i(this,"newDisplayMode",void 0),this.oldDisplayMode=t,this.newDisplayMode=e;}}class df extends er{static create(t,e){return new df(t,e)}constructor(t,e){super("fitModeChanged"),i(this,"oldFitMode",void 0),i(this,"newFitMode",void 0),this.oldFitMode=t,this.newFitMode=e;}}class uf extends er{static create(t,e){return new uf(t,e)}constructor(t,e){super("toolModeChanged"),i(this,"oldToolMode",void 0),i(this,"newToolMode",void 0),this.oldToolMode=t,this.newToolMode=e;}}class pf extends er{static create(t,e){return new pf(t,e)}constructor(t,e){super("zoomChanged"),i(this,"oldZoomRatio",void 0),i(this,"newZoomRatio",void 0),this.oldZoomRatio=t,this.newZoomRatio=e;}}class gf extends er{static create(t,e,i,s){return new gf(t,e,i,s)}constructor(t,e,s,n){super("resized"),i(this,"oldWidth",void 0),i(this,"oldHeight",void 0),i(this,"newWidth",void 0),i(this,"newHeight",void 0),this.oldWidth=t,this.oldHeight=e,this.newWidth=s,this.newHeight=n;}}class ff extends er{static create(t,e){return new ff(t,e)}constructor(t,e){super("document"),i(this,"docUid",void 0),i(this,"docName",void 0),this.docUid=t,this.docName=e;}}class vf extends er{static create(t,e){return new vf(t,e)}constructor(t,e){super("CropModeChanged"),i(this,"oldCropMode",void 0),i(this,"newCropMode",void 0),this.oldCropMode=t,this.newCropMode=e;}}class mf extends er{static create(t){return new mf(t)}constructor(t){super("captured"),i(this,"pageUid",void 0),this.pageUid=t;}}class yf extends er{static create(t,e){return new yf(t,e)}constructor(t,e){super("cameraChanged"),i(this,"oldDeviceId",void 0),i(this,"newDeviceId",void 0),this.oldDeviceId=t,this.newDeviceId=e;}}class xf extends er{static create(t){return new xf(t)}constructor(t){super("autoDetectChanged"),i(this,"enableAutoDetect",void 0),this.enableAutoDetect=t;}}class wf extends er{static create(t){return new wf(t)}constructor(t){super("autoCaptureChanged"),i(this,"enableAutoCapture",void 0),this.enableAutoCapture=t;}}class bf extends er{static create(t){return new bf(t)}constructor(t){super("cameraPlayed"),i(this,"resolution",void 0),this.resolution=t;}}class Sf extends er{static create(t){return new Sf(t)}constructor(t){super("cameraInit"),i(this,"enableConvert",void 0),this.enableConvert=t;}}class Cf extends er{static create(t){return new Cf(t)}constructor(t){super("torchChanged"),i(this,"torchState",void 0),this.torchState=t;}}class Pf extends er{static create(t,e){return new Pf(t,e)}constructor(t,e){super("annotationModeChanged"),i(this,"oldAnnotationMode",void 0),i(this,"newAnnotationMode",void 0),this.oldAnnotationMode=t,this.newAnnotationMode=e;}}class Tf extends er{static create(t){return new Tf(t)}constructor(t){super("annotationLayerStateChanged"),i(this,"state",void 0),this.state=t;}}class Af extends er{static create(t,e){return new Af(t,e)}constructor(t,e){super("annotationsUpdated"),i(this,"uids",void 0),i(this,"actions",void 0),this.uids=t,this.actions=e;}}class kf extends er{static create(t,e){return new kf(t,e)}constructor(t,e){super("selectedAnnotationsChanged"),i(this,"oldAnnotationUids",void 0),i(this,"newAnnotationUids",void 0),this.oldAnnotationUids=t,this.newAnnotationUids=e;}}class Df extends er{static create(t,e){return new Df(t,e)}constructor(t,e){super("AnnotationDefaultStyleChangedEvent"),i(this,"oldStyle",void 0),i(this,"newStyle",void 0),this.oldStyle=t,this.newStyle=e;}}class Rf extends er{static create(t,e,i){return new Rf(t,e,i)}constructor(t,e,s){super("cropPages"),i(this,"docUid",void 0),i(this,"rect",void 0),i(this,"pageUids",void 0),this.docUid=t,this.rect=e,this.pageUids=s;}}class Ef extends er{static create(t,e,i,s){return new Ef(t,e,i,s)}constructor(t,e,s,n){super("copyPage"),i(this,"pageUid",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),i(this,"annotations",void 0),this.pageUid=t,this.fileUid=e,this.fileIndex=s,this.annotations=n;}}class Mf extends er{static create(t,e,i,s){return new Mf(t,e,i,s)}constructor(t,e,s,n){super("pagePreloadChanged"),i(this,"docUid",void 0),i(this,"viewerUid",void 0),i(this,"viewerMode",void 0),i(this,"changes",void 0),this.docUid=t,this.viewerUid=e,this.viewerMode=s,this.changes=n;}}class If extends er{static create(t){return new If(t)}constructor(t){super("pageExistenceChanged"),i(this,"pageCount",void 0),this.pageCount=t;}}class Bf extends er{static create(t,e){return new Bf(t,e)}constructor(t,e){super("deletePages"),i(this,"pageUids",void 0),i(this,"docUid",void 0),this.pageUids=t,this.docUid=e;}}class Uf extends er{static create(t,e,i){return new Uf(t,e,i)}constructor(t,e,s){super("rotatePages"),i(this,"docUid",void 0),i(this,"angle",void 0),i(this,"pageUids",void 0),this.docUid=t,this.angle=e,this.pageUids=s;}}class Lf extends er{static create(t,e,i,s,n){return new Lf(t,e,i,s,n)}constructor(t,e,s,n,o){super("selectPages"),i(this,"docUid",void 0),i(this,"groupUid",void 0),i(this,"viewerUid",void 0),i(this,"indices",void 0),i(this,"pageUids",void 0),this.docUid=t,this.groupUid=e,this.viewerUid=s,this.indices=n,this.pageUids=o;}}class Of extends er{static create(t,e){return new Of(t,e)}constructor(t,e){super("reorderPages"),i(this,"docUid",void 0),i(this,"indices",void 0),this.docUid=t,this.indices=e;}}class Nf extends er{static create(t,e,i){return new Nf(t,e,i)}constructor(t,e,s){super("switchPage"),i(this,"docUid",void 0),i(this,"one",void 0),i(this,"another",void 0),this.docUid=t,this.one=e,this.another=s;}}class _f extends er{static create(t,e,i){return new _f(t,e,i)}constructor(t,e,s){super("createPage"),i(this,"pageUid",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),this.pageUid=t,this.fileUid=e,this.fileIndex=s;}}class Wf extends er{static create(t,e){return new Wf(t,e)}constructor(t,e){super("pageRendered"),i(this,"index",void 0),i(this,"pageUid",void 0),this.index=t,this.pageUid=e;}}class Ff extends er{static create(t,e){return new Ff(t,e)}constructor(t,e){super("pagesDragged"),i(this,"indices",void 0),i(this,"pageUids",void 0),this.indices=t,this.pageUids=e;}}class Hf extends er{static create(t,e,i){return new Hf(t,e,i)}constructor(t,e,s){super("pagesDropped"),i(this,"indicesBefore",void 0),i(this,"indicesAfter",void 0),i(this,"pageUids",void 0),this.indicesBefore=t,this.indicesAfter=e,this.pageUids=s;}}class Vf extends er{static create(t,e,i,s){return new Vf(t,e,i,s)}constructor(t,e,s,n){super("selectedPagesChanged"),i(this,"oldIndices",void 0),i(this,"newIndices",void 0),i(this,"oldPageUids",void 0),i(this,"newPageUids",void 0),this.oldIndices=t,this.newIndices=e,this.oldPageUids=s,this.newPageUids=n;}}class zf extends er{static create(t,e,i){return new zf(t,e,i)}constructor(t,e,s){super("pagesAdded"),i(this,"docUid",void 0),i(this,"indices",void 0),i(this,"pageUids",void 0),this.docUid=t,this.indices=e,this.pageUids=s;}}class $f extends er{static create(t,e,i){return new $f(t,e,i)}constructor(t,e,s){super("pagesDeleted"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"indices",void 0),this.docUid=t,this.pageUids=e,this.indices=s;}}class jf extends er{static create(t,e,i,s){return new jf(t,e,i,s)}constructor(t,e,s,n){super("addPagesToDoc"),i(this,"docUid",void 0),i(this,"pageUids",void 0),i(this,"indices",void 0),i(this,"index",void 0),this.docUid=t,this.pageUids=e,this.indices=s,this.index=n;}}class Xf extends er{static create(t,e,i){return new Xf(t,e,i)}constructor(t,e,s){super("updatePage"),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"data",void 0),this.docUid=t,this.pageUid=e,this.data=s;}}class Gf extends er{static create(t,e,i){return new Gf(t,e,i)}constructor(t,e,s){super("movePages"),i(this,"docUid",void 0),i(this,"indices",void 0),i(this,"insertBeforeIndex",void 0),this.docUid=t,this.indices=e,this.insertBeforeIndex=s;}}let Yf=0;const qf=()=>{const t=`doc-${Date.now().toString()}-${Yf.toString()}`;return Yf+=1,t};function Jf(t){t||(t=`D:${Ws("yyyyMMddhhmmss")}`);if(/[+-]\d{2}'\d{2}'$/.test(t))return t;const e=-(new Date).getTimezoneOffset();return `${t}${e>=0?"+":"-"}${String(Math.floor(Math.abs(e)/60)).padStart(2,"0")}'${String(Math.abs(e)%60).padStart(2,"0")}'`}class Zf{constructor(){var t,e;let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"type",void 0),i(this,"uid",void 0),i(this,"name",void 0),i(this,"pages",void 0),i(this,"tags",void 0),i(this,"creationDate",void 0),i(this,"author",void 0),i(this,"isDestroyed",void 0),i(this,"pageSize",void 0),this.uid=qs(),this.name=null!==(t=s.name)&&void 0!==t?t:qf(),this.type=s.type||"document",this.pages=[],this.tags=s.tags||[],this.creationDate=Jf(s.creationDate),this.author=null!==(e=s.author)&&void 0!==e?e:"",this.pageSize="none";}dispose(){this.isDestroyed=!0;}}class Qf{constructor(){i(this,"users",void 0),this.users=[];}addUser(t){this.users.push(t);}deleteUser(t){const e=this.users.indexOf(t);e>-1&&this.users.splice(e,1);}}var Kf;!function(t){t.IMAGE_PNG="image/png",t.IMAGE_JPEG="image/jpeg",t.IMAGE_BMP="image/bmp",t.IMAGE_TIFF="image/tiff",t.IMAGE_JP2="image/jp2",t.APPLICATION_PDF="application/pdf";}(Kf||(Kf={}));class tv{constructor(t){let{uid:e,mime:s,pageCount:n}=t;i(this,"uid",void 0),i(this,"mime",void 0),i(this,"pageCount",void 0),i(this,"name",void 0),i(this,"count",void 0),i(this,"pages",void 0),this.uid=e,this.mime=s,this.count=0,this.pages=[],this.pageCount=n;for(let t=0;t<n;t++){const t=new Qf;this.pages.push(t);}}getPageByIndex(t){return this.pages[t]}addUser(t,e){const i=this.pages[t];return !!i&&(i.addUser(e),this.count+=1,!0)}deleteUser(t,e){const i=this.pages[t];return !!i&&(i.deleteUser(e),this.count-=1,!0)}}function ev(t,e,i,s){if(0===(e=(e%360+360)%360))return t;const n=e/90;for(let e=0;e<4;e++){const o=t[2*e],r=t[2*e+1];1===n?(t[2*e]=r,t[2*e+1]=s-o):2===n?(t[2*e]=i-o,t[2*e+1]=s-r):3===n&&(t[2*e]=i-r,t[2*e+1]=o);}return nv(t,8-2*n),t}function iv(t,e,i,s){if(0===(e=(e%360+360)%360))return t;const n=e/90;for(let e=0;e<4;e++){const o=t[2*e],r=t[2*e+1];1===n?(t[2*e]=s-r,t[2*e+1]=o):2===n?(t[2*e]=i-o,t[2*e+1]=s-r):3===n&&(t[2*e]=r,t[2*e+1]=i-o);}return nv(t,2*n),t}function sv(t,e,i){for(;e<i;){const s=t[e];t[e]=t[i],t[i]=s,e+=1,i-=1;}}function nv(t,e){const i=e%t.length;0!==i&&(sv(t,0,t.length-1),sv(t,0,i-1),sv(t,i,t.length-1));}const ov=t=>Array(4).fill(0).map(((e,i)=>[t[2*i],t[2*i+1]])),rv=(t,e,i)=>0===t[0][0]&&0===t[0][1]&&t[1][0]===e&&0===t[1][1]&&t[2][0]===e&&t[2][1]===i&&0===t[3][0]&&t[3][1]===i;class av{constructor(t){i(this,"data",void 0),i(this,"width",void 0),i(this,"height",void 0),i(this,"url",void 0),i(this,"img",void 0),i(this,"users",void 0),i(this,"isDestroyed",void 0),i(this,"isAvailable",void 0),i(this,"pageWidth",void 0),i(this,"pageHeight",void 0),i(this,"docPage",void 0),this.isDestroyed=!1,this.users=[],this.isAvailable=!1,this.docPage=t;}getImageDetail(){const{docPage:t}=this;return {data:this.data,width:this.width,height:this.height,pageWidth:this.pageWidth,pageHeight:this.pageHeight,resolutionX:t.resolutionX,resolutionY:t.resolutionY,url:this.url,img:this.img}}getPageSize(){return {width:this.pageWidth,height:this.pageHeight}}updateImageDetail(t){if(!t)return;t.data&&(this.isAvailable=!0,this.data=t.data);const{docPage:e}=this;this.width=t.width,this.height=t.height,this.pageWidth=t.width/e.resolutionX*Bo.displayResolution,this.pageHeight=t.height/e.resolutionY*Bo.displayResolution;}addUser(t){this.getUserIndex(t)<0&&this.users.push(t);}deleteUser(t){const e=this.getUserIndex(t);e>-1&&this.users.splice(e,1);}hasUser(){return !!this.users.length}reset(){this.resetBlob(),this.resetImg();}resetBlob(){this.isAvailable=!1,this.data=null,this.url&&URL.revokeObjectURL(this.url),this.url=null;}resetImg(){this.img&&(this.img.src&&URL.revokeObjectURL(this.img.src),this.img.src=""),this.img=null;}getUserIndex(t){return this.users.findIndex((e=>{let{viewerUid:i,docUid:s,pageUid:n}=e;return i===t.viewerUid&&s===t.docUid&&n===t.pageUid}))}dispose(){this.isDestroyed=!0,this.isAvailable=!1,this.reset();}}function lv(t){const e=function(t){const e=[...t];e.sort(((t,e)=>e[1]-t[1]));let i=Number.MAX_SAFE_INTEGER,s=0;t.forEach(((t,e)=>{t[1]<i&&([,i]=t,s=e);}));const n=(s+3)%4,o=(s+1)%4,r=hv(t[n],t[s]),a=hv(t[o],t[s]);if(a>r)return n;return s}(t),i=t.map(((e,i)=>{let s=t[i+1];return 3===i&&([s]=t),cv(s,e)}));let s=Math.max(i[e],i[(e+2)%4]),n=Math.max(i[(e+1)%4],i[(e+3)%4]);return s=Math.round(s),n=Math.round(n),{width:s,height:n}}function hv(t,e){const i=Math.abs(t[0]-e[0]),s=cv(t,e);return Math.acos(i/s)}function cv(t,e){return ((t[0]-e[0])**2+(t[1]-e[1])**2)**.5}const dv=t=>{if(!t)return;t.forEach((t=>{const e=Math.ceil(t[0]);e-t[0]<=1e-7?t[0]=e:t[0]=Math.floor(t[0]);const i=Math.ceil(t[1]);i-t[1]<=1e-7?t[1]=i:t[1]=Math.floor(t[1]);}));};function uv(t,e,i,s){e=(e%360+360)%360;const n={...t},{left:o,top:r,width:a,height:l}=t,h=Math.floor(e/90);return 1===h?(n.left=s-r-l,n.top=o):2===h?(n.left=i-o-a,n.top=s-r-l):3===h&&(n.left=r,n.top=i-o-a),h%2>0&&(n.width=l,n.height=a),n}function pv(t,e){return t.left<e.left+e.width&&t.left+t.width>e.left&&t.top<e.top+e.height&&t.top+t.height>e.top}function gv(t,e){return t.x>=e.left&&t.x<=e.left+e.width&&t.y>=e.top&&t.y<=e.top+e.height}var fv;!function(t){t.NONE="none",t.LTR="ltr",t.RTL="rtl",t.TTB="ttb",t.BTT="btt";}(fv||(fv={}));class vv{constructor(t,e){let{fileIndex:s,pageUid:n,fileUid:o,rotation:r,filter:a,perspectiveQuad:l,annotations:h,pdfOptions:c,resource:d,cropBox:u,mediaBox:p,pageSize:g}=t;i(this,"uid",void 0),i(this,"doc",void 0),i(this,"metadata",void 0),i(this,"customData",void 0),i(this,"fileUid",void 0),i(this,"fileIndex",void 0),i(this,"resolutionX",void 0),i(this,"resolutionY",void 0),i(this,"filter",void 0),i(this,"rotation",void 0),i(this,"quad",void 0),i(this,"activeQuad",void 0),i(this,"isFull",void 0),i(this,"raw",void 0),i(this,"original",void 0),i(this,"display",void 0),i(this,"thumbnail",void 0),i(this,"editedDisplay",void 0),i(this,"initRotation",void 0),i(this,"editRotation",void 0),i(this,"actionRotation",void 0),i(this,"actions",void 0),i(this,"pActions",void 0),i(this,"actionResult",void 0),i(this,"pActionResult",void 0),i(this,"isDestroyed",void 0),i(this,"annotations",void 0),i(this,"pageSize",void 0),i(this,"cropBox",void 0),i(this,"mediaBox",void 0),i(this,"resource",void 0),i(this,"editCaches",void 0),i(this,"pdfOptions",void 0),i(this,"initState",void 0),i(this,"oriTexts",void 0),i(this,"parsedTexts",void 0),i(this,"oriTextSegments",void 0),i(this,"visibleLines",void 0),i(this,"lines",[]),i(this,"lineMap",new Map),i(this,"charMap",new Map),i(this,"textBlocks",void 0),i(this,"textRect",void 0),i(this,"curTextRect",void 0),i(this,"textStr",void 0),i(this,"textStrWithoutWrap",void 0),i(this,"textStrInSearch",void 0),i(this,"isTextPage",!0),i(this,"isUpdated",!1),i(this,"defaultRenderPage",void 0),i(this,"isLoadingDefaultRenderPage",!1),i(this,"redaction",[]),i(this,"redactionType",void 0),this.uid=n,this.doc=e,this.annotations=h||[],this.resolutionX=d.resolutionX,this.resolutionY=d.resolutionY,this.fileIndex=s,this.fileUid=o,this.pageSize=null!=g?g:"none",this.resource=d,"none"===this.pageSize?(this.mediaBox={...p},this.cropBox={...u}):this.pageSize,this.filter=a,this.rotation=r||0,this.initRotation=r||0,this.editRotation=r||0,this.actionRotation=0,this.isFull=!0,this.pdfOptions=c,this.raw=new av(this),this.original=new av(this),this.display=new av(this),this.thumbnail=new av(this),this.editedDisplay=new av(this);let f={width:d.width,height:d.height};if(this.raw.updateImageDetail(f),this.initState={mediaBox:this.mediaBox,cropBox:this.cropBox,rotation:r},l){f=lv(l),this.mediaBox={left:0,top:0,width:Gn(f.width,d.resolutionX,Bo.displayResolution),height:Gn(f.height,d.resolutionY,Bo.displayResolution)},this.cropBox={...this.mediaBox};const t=this.quadToDisplayPPI(l);this.setQuad(t);}this.original.updateImageDetail(f),this.display.updateImageDetail(f),this.actions=[],this.pActions=[],this.actionResult=new Map,this.pActionResult=new Map;}textStyleEqual(t,e){if(!t||!e)return !1;return Math.abs(Math.abs(t.fontSize)-Math.abs(e.fontSize))<1e-4&&t.fontName===e.fontName&&t.fontWeight===e.fontWeight&&t.renderMode===e.renderMode&&t.fillColor[0]===e.fillColor[0]&&t.fillColor[1]===e.fillColor[1]&&t.fillColor[2]===e.fillColor[2]&&t.fillColor[3]===e.fillColor[3]&&t.strokeColor[0]===e.strokeColor[0]&&t.strokeColor[1]===e.strokeColor[1]&&t.strokeColor[2]===e.strokeColor[2]&&t.strokeColor[3]===e.strokeColor[3]&&t.isItalic===e.isItalic&&t.isBold===e.isBold}isUnicodeWhiteSpace(t){return -1!==[...[...[9,11,12,32,10,13],133,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8232,8233,8239,8287,12288],0].indexOf(t)}getDirectionFromAngle(t){const e=Math.PI/4,i=Math.PI/2,s=Math.PI,n=Math.PI/2*3,o=(t+e)%(2*Math.PI);return o>=0&&o<=i?fv.LTR:o>i&&o<=s?fv.TTB:o>s&&o<=n?fv.RTL:fv.BTT}getAngleFromCharBox(t,e){const i=t.left+t.width/2,s=t.top+t.height/2,n=e.left+e.width/2,o=e.top+e.height/2;let r=Math.atan2(o-s,n-i);return r<0&&(r+=2*Math.PI),r}setParsedTexts(t){if(null===t)return void(this.isTextPage=!1);if(this.visibleLines)return;const e=t.charInfos,{top:i,height:s}=this.mediaBox,n=[];let o=0,r=null,a=-1;const l=[],h=[];e.forEach(((e,c)=>{const d=Gn(e.looseCharBox,72,Bo.displayResolution),u=d[0],p=d[2],g=2*i+s-d[3],f=2*i+s-d[1],v={uid:qs(),oriLineUid:"",visibleIndex:c,indexInMergeLine:c,indexWithoutWrap:o,indexWithWrap:c,oriIndex:c,unicode:e.unicode,charBox:{left:u,top:g,width:p-u,height:f-g},objId:e.objId};if(n.push(v),this.charMap.set(v.uid,v),this.isUnicodeWhiteSpace(v.unicode))l.length>0&&(13!==e.unicode&&10!==e.unicode&&(l[l.length-1].isWrap?h.push(v):(o+=1,l[l.length-1].chars.push(v))),10===e.unicode&&(l[l.length-1].isWrap=!0));else {let i=!1;if(r===e.objId||this.textStyleEqual(t.textStyleInfos[r],t.textStyleInfos[e.objId]))if(l[l.length-1].charDirection!==this.getDirectionFromAngle(e.angle))i=!0;else {const t=this.getAngleFromCharBox(l[l.length-1].chars[a].charBox,v.charBox);if(a>0){const e=this.getAngleFromCharBox(l[l.length-1].chars[0].charBox,l[l.length-1].chars[a].charBox);l[l.length-1].direction===fv.NONE&&(l[l.length-1].direction=this.getDirectionFromAngle(e));const s=Math.PI,n=2*Math.PI;let o=Math.abs(t-e)%n;o=o>s?n-o:o,o>Math.PI/2&&(i=!0);}if(!i){Math.sqrt((v.charBox.left-l[l.length-1].chars[a].charBox.left)**2+(v.charBox.top-l[l.length-1].chars[a].charBox.top)**2)>2.5*(Math.abs(Math.cos(t))*l[l.length-1].avgCharSize.width+Math.abs(Math.sin(t))*l[l.length-1].avgCharSize.height)&&(i=!0);}}else i=!0;if(i)if(2===v.unicode);else {o+=1;let i=0;t.textStyleInfos[e.objId]&&(i=Gn(t.textStyleInfos[e.objId].fontSize,72,Bo.displayResolution)/3);let s={width:i,height:i},n=1;v.charBox.width>0&&v.charBox.height>0&&(s={width:(s.width*n+v.charBox.width)/(n+1),height:(s.height*n+v.charBox.height)/(n+1)},n+=1),l.push({chars:[v],isWrap:!1,charDirection:this.getDirectionFromAngle(e.angle),direction:fv.NONE,avgCharSize:s,nonWhitespaceCharsCount:n,textStyle:t.textStyleInfos[e.objId]}),h.splice(0,h.length),a=0;}else l[l.length-1].isWrap&&(l[l.length-1].isWrap=!1,h.forEach((t=>{o+=1,l[l.length-1].chars.push(t);})),h.splice(0,h.length)),o+=1,l[l.length-1].avgCharSize={width:(l[l.length-1].avgCharSize.width*l[l.length-1].nonWhitespaceCharsCount+v.charBox.width)/(l[l.length-1].nonWhitespaceCharsCount+1),height:(l[l.length-1].avgCharSize.height*l[l.length-1].nonWhitespaceCharsCount+v.charBox.height)/(l[l.length-1].nonWhitespaceCharsCount+1)},l[l.length-1].nonWhitespaceCharsCount+=1,l[l.length-1].chars.push(v),a=l[l.length-1].chars.length-1;r=e.objId;}})),this.parsedTexts=n,this.oriTextSegments=l,this.lines=l.map(((t,e)=>{const i=mv(t.chars.map((t=>t.charBox))),s={...i,uid:qs(),index:e,visibleIndex:e,isRow:i.width>i.height,chars:t.chars,right:i.left+i.width,bottom:i.top+i.height,startIndex:0,endIndex:t.chars.length-1,visibleRect:i,isWrap:t.isWrap};return this.lineMap.set(s.uid,s),s.chars.forEach(((t,e)=>{t.visibleIndex=e,t.indexInMergeLine=e,t.oriLineUid=s.uid;})),s})),this.lines.length&&this.handleCropBoxForText();}handleCropBoxForText(){const{cropBox:t}=this;this.visibleLines=this.lines.filter((e=>pv(e,t)));let e="",i=-1,s=-1,n=-1;this.visibleLines.forEach(((o,r)=>{o.visibleIndex=r,o.startIndex=o.chars.findIndex((e=>pv(e.charBox,t))),o.endIndex=-1;for(let e=o.chars.length-1;e>=0;e--)if(pv(o.chars[e].charBox,t)){o.endIndex=e;break}const a=o.chars.slice(o.startIndex,o.endIndex+1).map((t=>t.charBox));o.visibleRect=mv(a),o.chars.slice(o.startIndex,o.endIndex+1).forEach(((t,o)=>{t.visibleIndex=o;const r=String.fromCharCode(t.unicode);2!==t.unicode&&(e+=r,n+=1),i+=1,s+=1,t.indexWithWrap=i,t.indexWithoutWrap=s,t.indexInSearch=n;})),o.isWrap&&(i+=2,e+=" ",n+=1);})),this.textStrInSearch=e;const o=[];let r=this.visibleLines[0],a={lines:[{index:0,line:r}],...r};o.push(a);for(let t=1;t<this.visibleLines.length;t++){const e=this.visibleLines[t],{visibleRect:i}=e;let s=!1;if(e.isRow!==r.isRow?s=!0:r.isRow?(i.left>a.right||i.left+i.width<a.left)&&(s=!0):(i.top>a.bottom||i.top+i.height<a.top)&&(s=!0),s)a={lines:[{index:t,line:e}],...e,...i,right:i.left+i.width,bottom:i.top+i.height},o.push(a);else {a.lines.push({index:t,line:e});const i=mv([e,a]);Object.assign(a,i),a.right=a.left+a.width,a.bottom=a.top+a.height;}r=e;}this.textBlocks=o,this.textRect=mv(o);}getHoveredTextLineIndex(t){if(!this.visibleLines)return -1;return this.visibleLines.findIndex((e=>gv(t,e.visibleRect)))}getHoveredTextLineUid(t){const e=this.visibleLines.find((e=>gv(t,e.visibleRect)));return null==e?void 0:e.uid}getSelectedTextLineIndex(t,e){const{x:i,y:s}=e;{let t=-1,n=Number.MAX_VALUE;for(let o=0;o<this.visibleLines.length;o++){const r=this.visibleLines[o];for(let a=r.startIndex;a<=r.endIndex;a++){const{charBox:l}=r.chars[a];if(gv(e,l))return o;const h=Math.min(Math.abs(l.top-s),Math.abs(l.top+l.height-s))+Math.min(Math.abs(l.left-i),Math.abs(l.left+l.width-i));h<n&&(n=h,t=o);}}return t}}getSelectedTextCharIndex(t,e){if(!this.visibleLines)return -1;let i=-1;const s=this.visibleLines[t];let n=1/0,o=-1;for(let t=s.startIndex;t<=s.endIndex;t++){const{charBox:r}=s.chars[t];if(gv(e,r)){i=t;break}{let i=0;i=s.isRow?Math.min(Math.abs(r.left-e.x),Math.abs(r.left+r.width-e.x)):Math.min(Math.abs(r.top+r.height-e.y),Math.abs(r.top-e.y)),i<n&&(n=i,o=t);}}return -1===i&&(i=o),i}getSelectedTextWord(t,e){const i=this.visibleLines[t],s=this.getSelectedTextCharIndex(t,e),{startIndex:n,endIndex:o}=i;let r=s,a=s;if(32===i.chars[s].unicode)return null;if(this.isMultipleClickBoundarySelf(i.chars[s].unicode))return {start:{lineUid:i.uid,charUid:i.chars[s].uid},end:{lineUid:i.uid,charUid:i.chars[s].uid}};for(let t=s;t>=n;t--){if(this.isMultipleClickBoundary(i.chars[t].unicode)){r=t+1,t===a&&(r=t);break}r=t;}for(let t=s;t<=o;t++){if(this.isMultipleClickBoundary(i.chars[t].unicode)){a=t-1,t===r&&(a=t);break}a=t;}return {start:{lineUid:i.uid,charUid:i.chars[r].uid},end:{lineUid:i.uid,charUid:i.chars[a].uid}}}isMultipleClickBoundary(t){return !(t>=48&&t<=57)&&(!(t>=65&&t<=90)&&(!(t>=97&&t<=122)&&(95!==t&&t<128)))}isMultipleClickBoundarySelf(t){return !(t>=48&&t<=57)&&(!(t>=65&&t<=90)&&(!(t>=97&&t<=122)&&(95!==t&&(32!==t&&t<128))))}getSelectedTextSegment(t,e){let i=0,s=this.visibleLines.length-1;const n=this.lines.indexOf(this.visibleLines[t]);if(0!==this.visibleLines[t].startIndex)i=t;else for(let e=t-1;e>=0;e--){const s=this.lines.indexOf(this.visibleLines[e]);if(this.visibleLines[e].isWrap||s+t-e!==n||this.visibleLines[e].endIndex!==this.visibleLines[e].chars.length-1){i=e+1;break}if(0!==this.visibleLines[e].startIndex){i=e;break}}if(this.visibleLines[t].endIndex!==this.visibleLines[t].chars.length-1||this.visibleLines[t].isWrap)s=t;else for(let e=t+1;e<this.visibleLines.length;e++){if(this.lines.indexOf(this.visibleLines[e])!==n+e-t||0!==this.visibleLines[e].startIndex){s=e-1;break}if(this.visibleLines[e].isWrap||this.visibleLines[e].endIndex!==this.visibleLines[e].chars.length-1){s=e;break}}const o=this.visibleLines[i],r=this.visibleLines[s];return {start:{lineUid:o.uid,charUid:o.chars[o.startIndex].uid},end:{lineUid:r.uid,charUid:r.chars[r.endIndex].uid}}}getSelectedTextLine(t,e,i){const s=this.visibleLines[t];let n,o=[],r=!0;if(void 0===e&&void 0===i)n={...s.visibleRect},o=s.chars.slice(s.startIndex,s.endIndex+1);else {n=mv(s.chars.slice(e,i+1).map((t=>t.charBox))),o=s.chars.slice(e,i+1),i!==s.endIndex&&(r=!1);}let a=o.map((t=>2===t.unicode?"":String.fromCharCode(t.unicode))).join("");return s.isWrap&&r&&(a+="\r\n"),{...s,selectedRect:n,text:a}}rectUnion(t,e){const i=Math.min(t.left,e.left),s=Math.min(t.top,e.top);return {left:i,top:s,width:Math.max(t.left+t.width,e.left+e.width)-i,height:Math.max(t.top+t.height,e.top+e.height)-s}}rectIntersection(t,e){const i=Math.max(t.left,e.left),s=Math.max(t.top,e.top),n=Math.min(t.left+t.width,e.left+e.width),o=Math.min(t.top+t.height,e.top+e.height);return {left:i,top:s,width:n>i?n-i:0,height:o>s?o-s:0}}getVerticalOverlap(t,e){const i=this.rectUnion(t,e),s=1e-6;if(Math.abs(i.height-t.height)<s||Math.abs(i.height-e.height)<s)return 1;return this.rectIntersection(t,e).height/i.height}shouldMergeHorizonLines(t,e){if(0!==e.startIndex)return !1;const i=t.selectedRect,s=e.selectedRect;if(this.getVerticalOverlap(i,s)<.7)return !1;const n=i.width/(t.endIndex-t.startIndex+1)*1,o=s.width/(e.endIndex-e.startIndex+1)*1,r=i.left-n,a=i.left+i.width+n,l=s.left-o;return r<s.left+s.width+o&&a>l}mergeAdjacentLines(t){const e=[];let i=null;for(let s=0;s<t.length;s++){const n=t[s];i?this.shouldMergeHorizonLines(i,n)?(i.chars=[...i.chars,...n.chars],i.text+=n.text,i.endIndex+=n.endIndex+1,i.selectedRect=this.rectUnion(i.selectedRect,n.selectedRect),i.visibleRect=this.rectUnion(i.visibleRect,n.visibleRect),i.left=i.visibleRect.left,i.top=i.visibleRect.top,i.width=i.visibleRect.width,i.height=i.visibleRect.height,i.right=i.visibleRect.left+i.visibleRect.width,i.bottom=i.visibleRect.top+i.visibleRect.height):(e.push(i),i={...n}):i={...n};}return i&&e.push(i),e}doMergeAdjacentLines(t){let e=this.mergeAdjacentLines(t);for(;;){const t=this.mergeAdjacentLines(e);if(t.length===e.length)break;e=t;}return e}getSelectedTextLines(t,e){const i=[];for(let s=t.lineIndex;s<=e.lineIndex;s++){const n=this.visibleLines[s];let o=n.startIndex,r=n.endIndex;s===t.lineIndex&&void 0!==t.charIndex&&(o=t.charIndex),s===e.lineIndex&&void 0!==e.charIndex&&(r=e.charIndex);const a=this.getSelectedTextLine(s,o,r);i.push(a);}return this.doMergeAdjacentLines(i)}getSelectedTextsStr(t,e,i){let s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const n=this.visibleLines[t];let o=[];void 0===e&&void 0===i?o=n.chars.slice(n.startIndex,n.endIndex+1):(o=n.chars.slice(e,i+1),i!==n.endIndex&&(s=!1));let r=o.map((t=>2===t.unicode?"":String.fromCharCode(t.unicode))).join("");return n.isWrap&&s&&(r+="\r\n"),r}getEndCharRect(t,e){const i=this.visibleLines[t].chars[e].charBox;return {...i,top:i.top,height:i.height}}getSearchedText(t){var e;let i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:50;if(this.isDestroyed||null===(e=this.visibleLines)||void 0===e||!e.length)return [];const o=[];let r,a=0;for(;null!==r;)if(r=t.exec(this.textStrInSearch),null!==r){let t=r[0],e=r.index;if(i){const[,i,s]=r;t=s,e=r.index+i.length;}let l=-1,h=this.visibleLines.findIndex((t=>(l=t.chars.slice(t.startIndex,t.endIndex+1).findIndex((t=>t.indexInSearch===e)),l>-1)));-1===h&&(h=this.visibleLines.findIndex((t=>(l=t.chars.slice(t.startIndex,t.endIndex+1).findIndex((t=>t.indexInSearch===e+1)),l>-1))));let c=-1,d=this.visibleLines.findIndex((i=>(c=i.chars.slice(i.startIndex,i.endIndex+1).findIndex((i=>i.indexInSearch===e+t.length-1)),c>-1)));if(-1===d&&t.length>1&&(d=this.visibleLines.findIndex((i=>(c=i.chars.slice(i.startIndex,i.endIndex+1).findIndex((i=>i.indexInSearch===e+t.length-2)),c>-1)))),-1===l||-1===c)continue;const u=this.getSelectedTextLines({lineIndex:h,charIndex:l+this.visibleLines[h].startIndex},{lineIndex:d,charIndex:c+this.visibleLines[d].startIndex}),p=[];for(let t=0;t<u.length;t++){const e=u[t];p.push({lineIndex:h,text:e.text,box:{...e.selectedRect}});}let g=s;if(0===h)l<s&&(g=l);else for(let t=h;t>0;t--){const i=this.visibleLines[t],s=e-i.chars[i.startIndex].indexInSearch;if(s>g)break;if(this.visibleLines[t-1].isWrap){g=s;break}}const f=this.textStrInSearch.substring(Math.max(e-g,0),Math.min(e+t.length+n,this.textStrInSearch.length)),{context:v,startIndex:m}=yv(f,t,e-g>0?g:e,1,5);o.push({textUid:`${this.uid}_${a}`,pageUid:this.uid,text:t,context:v,startIndex:m,lines:p}),a+=1;}return o}isMediaBoxEqualCropBox(){const{mediaBox:t,cropBox:e}=this;return t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height}getPageSize(){return "inherit"===this.pageSize?this.doc.pageSize:this.pageSize}copy(t,e){const i=new vv({pageSize:this.getPageSize(),fileIndex:this.fileIndex,pageUid:t,fileUid:this.fileUid,rotation:this.rotation,filter:this.filter,pdfOptions:this.pdfOptions&&Ns(this.pdfOptions),mediaBox:Ns(this.mediaBox),cropBox:Ns(this.cropBox),resource:Ns(this.resource),annotations:[]},e),s=Ns(this.actions);s.forEach((t=>{t.docUid=e.uid;}));const n=Ns(this.pActions);n.forEach((t=>{t.docUid=e.uid;})),i.actions=s,i.pActions=n,i.initRotation=this.initRotation,i.actionRotation=this.actionRotation,i.editRotation=this.editRotation,i.quad=Ns(this.quad),i.activeQuad=Ns(this.activeQuad),i.isFull=this.isFull,i.actionResult=new Map(this.actionResult),i.pActionResult=new Map(this.pActionResult);const o={width:this.mediaBox.width||this.display.width||i.raw.width,height:this.mediaBox.height||this.display.height||i.raw.height};return i.original.updateImageDetail(o),i.display.updateImageDetail(o),i}setQuad(t){const e=this.isQuadFull(t);let i=!1;if(this.isFull=e,e)this.quad&&(i=!0,this.editRotation=this.rotation),this.quad=null,this.activeQuad=null;else {const{width:e,height:s}=this.raw.getPageSize(),n=ev(t.flat(),this.rotation,e,s),o=ov(n);let r,a;this.quad&&(a=this.quadToPixelPPI(o),r=this.quadToPixelPPI(this.quad),dv(r),dv(a)),this.quad&&Yn(r,a)||(this.quad=o,this.activeQuad=o,i=!0),this.editRotation=this.actionRotation;}return i&&this.clearActions(),i}isQuadChanged(t){let e=!1;if(this.isQuadFull(t))this.quad&&(e=!0);else {const{width:i,height:s}=this.raw.getPageSize(),n=ev(t.flat(),this.rotation,i,s),o=ov(n);let r,a;this.quad&&(a=this.quadToPixelPPI(o),r=this.quadToPixelPPI(this.quad),dv(r),dv(a)),this.quad&&Yn(r,a)||(e=!0);}return e}setActiveQuad(t){const{width:e,height:i}=this.raw.getPageSize();if(!this.isFull){const s=ev(t.flat(),this.rotation,e,i),n=ov(s);this.activeQuad=n;}}getQuadVertices(){let t;const{width:e,height:i}=this.raw.getPageSize();return t=this.isFull?[0,0,e,0,e,i,0,i]:this.activeQuad.flat(),t=iv(t,this.rotation,e,i),t}getProcessedQuad(){if(this.quad){let{width:t,height:e}=this.raw.getPageSize(),{quad:i}=this;i=this.quad.map((t=>[this.toPixelPPI(t[0],!1),this.toPixelPPI(t[1],!0)])),t=this.toPixelPPI(t,!1),e=this.toPixelPPI(e,!0);const s=iv(i.flat(),this.initRotation,t,e);return ov(s)}return null}toggleFull(){let t=!1;return this.isFull&&this.activeQuad?(this.isFull=!1,t=!0):this.isFull||(this.isFull=!0,t=!0),t}isQuadFull(t){let{width:e,height:i}=this.raw.getPageSize();const s=Math.abs((this.rotation%360+360)%360);if(90===s||270===s){const t=e;e=i,i=t;}return rv(t,e,i)}getEditResultForPixel(){const t=this.getEditResult();return {rWidth:this.toPixelPPI(t.rWidth,!1),rHeight:this.toPixelPPI(t.rHeight,!0),cropLeft:this.toPixelPPI(t.cropLeft,!1),cropTop:this.toPixelPPI(t.cropTop,!0),cropWidth:this.toPixelPPI(t.cropWidth,!1),cropHeight:this.toPixelPPI(t.cropHeight,!0),rotation:t.rotation}}getEditResult(){if(!this.actions.length){const t=uv(this.cropBox,this.rotation,this.mediaBox.width,this.mediaBox.height);return {rWidth:t.width,rHeight:t.height,cropLeft:this.cropBox.left,cropTop:this.cropBox.top,cropWidth:this.cropBox.width,cropHeight:this.cropBox.height,rotation:this.rotation,mediaBox:{...this.mediaBox},cropBox:{...this.cropBox}}}const t=this.actions[this.actions.length-1],{rotatedCropBox:e,cropBox:i,rotation:s}=this.actionResult.get(t.actionUid).to;return {rWidth:e.width,rHeight:e.height,cropLeft:i.left,cropTop:i.top,cropWidth:i.width,cropHeight:i.height,rotation:s,mediaBox:{...this.mediaBox},cropBox:{...i}}}getEditResultForPerspective(){const t=this.raw.getPageSize(),e={left:0,top:0,width:t.width,height:t.height};if(!this.pActions.length){const i=uv(e,this.rotation,e.width,e.height);return {rWidth:i.width,rHeight:i.height,cropLeft:0,cropTop:0,cropWidth:t.width,cropHeight:t.height,rotation:this.rotation,cropBox:{...e},mediaBox:e}}const i=this.pActions[this.pActions.length-1],{rotatedCropBox:s,cropBox:n,rotation:o}=this.pActionResult.get(i.actionUid).to;return {rWidth:s.width,rHeight:s.height,cropLeft:n.left,cropTop:n.top,cropWidth:n.width,cropHeight:n.height,rotation:o,mediaBox:e,cropBox:{...n}}}getActions(){return [...this.actions]}getPerspectiveActions(){return this.pActions}addAction(t){let e=null;if(this.actions.length){const t=this.actionResult.get(this.actions[this.actions.length-1].actionUid);e={mediaBox:{...t.to.mediaBox},cropBox:{...t.to.cropBox},rotation:t.to.rotation,rotatedCropBox:{...t.to.rotatedCropBox}};}else e={mediaBox:{...this.mediaBox},cropBox:{...this.cropBox},rotation:this.rotation,rotatedCropBox:{...this.cropBox}};if(this.actions.push(t),!this.actionResult.has(t.actionUid)){const i=function(t,e,i,s){let n={...t};const o=e.left+e.width,r=e.top+e.height;let a=i,l=uv(t,a,o,r);if("rotate"===s.type)a+=s.angle,l=uv(t,a,o,r);else if("crop"===s.type){const t=s.rect;l={left:t.left+l.left,top:t.top+l.top,width:t.width,height:t.height},n=function(t,e,i,s){e=(e%360+360)%360;const n={...t},{left:o,top:r,width:a,height:l}=t,h=Math.floor(e/90);return 1===h?(n.left=r,n.top=s-a-o):2===h?(n.left=i-a-o,n.top=s-l-r):3===h&&(n.left=i-l-r,n.top=o),h%2>0&&(n.width=l,n.height=a),n}(l,a,o,r);}return {rotatedCropBox:l,cropBox:n,mediaBox:e,rotation:a}}(e.cropBox,this.mediaBox,this.rotation,t);this.actionResult.set(t.actionUid,{from:e,to:i}),this.cropBox={...i.cropBox},this.mediaBox={...i.mediaBox};}if("rotate"===t.type){let e=null;const{width:i,height:s}=this.raw.getPageSize(),n={left:0,top:0,width:i,height:s};if(this.pActions.length){const t=this.pActionResult.get(this.pActions[this.pActions.length-1].actionUid);e={mediaBox:{...t.to.mediaBox},cropBox:{...t.to.cropBox},rotation:t.to.rotation,rotatedCropBox:{...t.to.rotatedCropBox}};}else e={mediaBox:{...n},cropBox:{...n},rotation:this.rotation,rotatedCropBox:{...n}};if(this.pActions.push(t),!this.pActionResult.has(t.actionUid)){const n=function(t,e,i,s){const n=i+s.angle;return {rotatedCropBox:uv(t,n,e.left+e.width,e.top+e.height),cropBox:t,mediaBox:e,rotation:n}}({left:0,top:0,width:i,height:s},{left:0,top:0,width:i,height:s},this.rotation,t);this.pActionResult.set(t.actionUid,{from:e,to:n});}this.rotation+=t.angle;}}deleteAction(t){var e,i;if((null===(e=this.actions[this.actions.length-1])||void 0===e?void 0:e.actionUid)===t){this.actions.pop();const e=this.actionResult.get(t);this.cropBox={...e.from.cropBox},this.mediaBox={...e.from.mediaBox},this.rotation=e.from.rotation,this.actionResult.delete(t);}(null===(i=this.pActions[this.pActions.length-1])||void 0===i?void 0:i.actionUid)===t&&(this.pActions.pop(),this.pActionResult.delete(t));}clearActions(){this.actions=[];}toDisplayPPI(t,e){const{resolutionX:i,resolutionY:s}=this;return e?t/s*Bo.displayResolution:t/i*Bo.displayResolution}toPixelPPI(t,e){const{resolutionX:i,resolutionY:s}=this;return e?t*s/Bo.displayResolution:t*i/Bo.displayResolution}quadToDisplayPPI(t){const e=Ns(t);for(let t=0;t<4;t++)e[t][0]=this.toDisplayPPI(e[t][0],!1),e[t][1]=this.toDisplayPPI(e[t][1],!0);return e}quadToPixelPPI(t){const e=Ns(t);for(let t=0;t<4;t++)e[t][0]=this.toPixelPPI(e[t][0],!1),e[t][1]=this.toPixelPPI(e[t][1],!0);return e}rectToDisplayPPI(t){const e={...t};return e.left=this.toDisplayPPI(t.left,!1),e.top=this.toDisplayPPI(t.top,!0),e.width=this.toDisplayPPI(t.width,!1),e.height=this.toDisplayPPI(t.height,!0),e}rectToPixelPPI(t){const e={...t};return e.left=this.toPixelPPI(t.left,!1),e.top=this.toPixelPPI(t.top,!0),e.width=this.toPixelPPI(t.width,!1),e.height=this.toPixelPPI(t.height,!0),e}dispose(){this.raw.reset(),this.original.reset(),this.display.reset(),this.thumbnail.reset(),this.isDestroyed=!0;}getAnnotationUids(){return [...this.annotations]}}function mv(t){let e=1/0,i=1/0,s=-1/0,n=-1/0;return t.forEach((t=>{t.width>0&&t.height>0&&(e=Math.min(e,t.left),i=Math.min(i,t.top),s=Math.max(s,t.left+t.width),n=Math.max(n,t.top+t.height));})),{left:e,top:i,width:s-e,height:n-i}}function yv(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10;const o=[];let r="",a=0;for(let e=0;e<=t.length;e++){const i=t[e];i&&!/\s/.test(i)?(""===r&&(a=e),r+=i):""!==r&&""!==r&&(o.push({text:r,startPos:a,endPos:e-1}),r="");}let l=-1;for(let t=0;t<o.length;t++){const e=o[t];if(i>=e.startPos&&i<=e.endPos){l=t;break}}const h=i+e.length-1;let c=-1;for(let t=0;t<o.length;t++){const e=o[t];if(h>=e.startPos&&h<=e.endPos){c=t;break}}if(-1===l||-1===c)return {context:t,startIndex:i};const d=Math.max(0,l-s),u=Math.min(o.length-1,c+n),p=o[d].startPos,g=o[u].endPos+1;let f=t.substring(p,g),v=i-p;const m=[".","!","?","\n","\r","","","","",";"],y=f.substring(0,v);let x=-1;for(const t of m){const e=y.lastIndexOf(t);e>x&&(x=e);}if(-1!==x){let t=x+1;for(;t<f.length&&/\s/.test(f[t]);)t+=1;f=f.substring(t),v-=t;}return {context:f,startIndex:v}}class xv extends Qn{constructor(){super(),i(this,"uid",void 0),i(this,"emitter",void 0),i(this,"repo",void 0),i(this,"onDocumentCreated",to(this)),i(this,"onDocumentDeleted",to(this)),i(this,"onDocumentRenamed",to(this)),i(this,"onPagesAddedOut",to(this)),i(this,"onAddPagesToDoc",to(this)),i(this,"onBeforeDeletePagesFromDoc",to(this)),i(this,"onDeletePagesFromDoc",to(this)),i(this,"onBeforeDeleteAllPagesFromDoc",to(this)),i(this,"onDeleteAllPagesFromDoc",to(this)),i(this,"onMovePages",to(this)),i(this,"onSwitchPage",to(this)),i(this,"onReorderPages",to(this)),i(this,"onAfterReorderPages",to(this)),i(this,"onBeforeDeleteDocs",to(this)),i(this,"onAfterDeleteDocs",to(this)),i(this,"onOpenDocument",to(this)),i(this,"onCloseDocument",to(this)),this.emitter=new Qs,this.uid=qs(),this.repo=new Map;}dispose(){this.repo.forEach((t=>t.dispose())),this.repo.clear(),super.dispose();}reset(){this.repo.clear();}createDocument(){const t=new Zf(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});this.repo.set(t.uid,t);const e=ff.create(t.uid,t.name);return this.onDocumentCreated.emit(e),t}getDocument(t){return this.repo.get(t)}getAllDocuments(){return Array.from(this.repo.values())}renameDocument(t,e){const i=this.repo.get(t);if(!i)return !1;const s=$g.create(t,i.name,e);return i.name=e,this.onDocumentRenamed.emit(s),!0}deleteDocuments(t){return t.forEach((t=>{const e=this.getDocument(t);e.dispose(),this.repo.delete(t);const i=ff.create(t,e.name);this.onDocumentDeleted.emit(i);})),!0}addPagesToDocument(t,e,i){const s=this.repo.get(t);if(!s)return !1;const{length:n}=e,o=[];let r=s.pages.length;js(i)?(s.pages.splice(i,0,...e),r=i):s.pages.push(...e);for(let t=0;t<n;t++)o.push(r+t);const a=jf.create(t,e,o,i);return this.onAddPagesToDoc.emit(a),!0}removePagesFromDocument(t,e){const i=this.getDocument(t);if(!i)return !1;const s=e.map((t=>i.pages.indexOf(t)));e.forEach((t=>{En(i.pages,t);}));const n=$f.create(t,e,s);return this.onBeforeDeletePagesFromDoc.emit(n),this.onDeletePagesFromDoc.emit(n),!0}removeAllPagesFromDocument(t){const e=this.getDocument(t);if(!e)return !1;const i=[...e.pages.keys()],s=[...e.pages];e.pages.length=0;const n=$f.create(t,s,i);return this.onBeforeDeleteAllPagesFromDoc.emit(n),this.onDeleteAllPagesFromDoc.emit(n),!0}movePages(t,e,i){const s=this.repo.get(t);if(!s)return !1;Mn(s.pages,e,i);const n=Gf.create(t,e,i);return this.onMovePages.emit(n),!0}swapPages(t,e,i){const s=this.repo.get(t);if(!s)return !1;In(s.pages,e,i);const n=Nf.create(t,e,i);return this.onSwitchPage.emit(n),!0}reorderPages(t,e){const i=this.repo.get(t);if(!i)return !1;Bn(i.pages,e);const s=Of.create(t,e);return this.onReorderPages.emit(s),this.onAfterReorderPages.emit(s),!0}}class wv{on(t,e){}emit(t){}}(new wv).on("debug",(function(){}));var bv=new WeakMap,Sv=new WeakMap,Cv=new WeakMap,Pv=new WeakMap,Tv=new WeakMap,Av=new WeakSet,kv=new WeakSet,Dv=new WeakSet;class Rv{constructor(t,e){v(this,Dv),v(this,kv),v(this,Av),f(this,bv,{writable:!0,value:void 0}),f(this,Sv,{writable:!0,value:void 0}),f(this,Cv,{writable:!0,value:!1}),f(this,Pv,{writable:!0,value:void 0}),f(this,Tv,{writable:!0,value:void 0}),n(this,Sv,t),n(this,Pv,t.core),n(this,Tv,e),n(this,bv,qs()),t.taskResponses.set(s(this,bv),this);}get uid(){return s(this,Tv)}get fileIndex(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);return p(this,Dv,Iv).call(this).fileIndex}get filter(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);return p(this,Dv,Iv).call(this).filter}get perspectiveQuad(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);const t=p(this,Dv,Iv).call(this);let{quad:e}=t;return e&&(e=t.quadToPixelPPI(e),dv(e)),e}get rotation(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);return p(this,Dv,Iv).call(this).rotation%360}get mediaBox(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);return Bv(Gn(p(this,Dv,Iv).call(this).mediaBox,Bo.displayResolution,Bo.dataResolution),2)}get cropBox(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);return Bv(Gn(p(this,Dv,Iv).call(this).cropBox,Bo.displayResolution,Bo.dataResolution),2)}async fileData(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED);const t=p(this,Dv,Iv).call(this);if(!t)return null;const e=await s(this,Sv).core.sourceStore.get(t.fileUid);return "application/ddv-blank-image"!==e.fileData.type?e.fileData:null}async raw(){s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED),p(this,Dv,Iv).call(this);const t=qs();p(this,Av,Ev).call(this,t);const e=await s(this,Pv).imageDataService.getRaw(s(this,Tv));return p(this,kv,Mv).call(this,t),{data:e.data,width:e.width,height:e.height}}async display(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED),p(this,Dv,Iv).call(this),t={getPng:!1,isGetPrintPageData:!1,renderAnnotation:!1,...t};const e=qs();p(this,Av,Ev).call(this,e);const i=await s(this,Pv).imageDataService.getEditedDisplay(s(this,Tv),t.renderAnnotation,t.isGetPrintPageData,t.getPng);return p(this,kv,Mv).call(this,e),{data:null==i?void 0:i.data,width:null==i?void 0:i.width,height:null==i?void 0:i.height}}async thumbnail(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,Cv)&&ku.throw(ku.PAGEDATA_DESTROYED),p(this,Dv,Iv).call(this),t={getPng:!1,isGetPrintPageData:!1,renderAnnotation:!1,...t};const e=qs();p(this,Av,Ev).call(this,e);const i=await s(this,Pv).imageDataService.getEditedDisplay(s(this,Tv),t.renderAnnotation,t.isGetPrintPageData,t.getPng);return p(this,kv,Mv).call(this,e),{data:i.data,width:i.width,height:i.height}}destroy(){s(this,Sv).deleteResponse(s(this,bv)),n(this,Sv,null),n(this,Cv,!0);}}function Ev(t){const e=s(this,Pv).pageService.getPage(s(this,Tv));if(e){const i={viewerUid:t,docUid:e.doc.uid,pageUid:e.uid};e.raw.addUser(i),e.original.addUser(i),e.thumbnail.addUser(i),e.display.addUser(i);}}function Mv(t){const e=s(this,Pv).pageService.getPage(s(this,Tv));if(e){const i={viewerUid:t,docUid:e.doc.uid,pageUid:e.uid};e.raw.deleteUser(i),e.original.deleteUser(i),e.thumbnail.deleteUser(i),e.display.deleteUser(i);}}function Iv(){const t=s(this,Pv).pageService.getPage(s(this,Tv));return t||ku.throw(ku.PAGE_DESTROYED),t}function Bv(t,e){let i=!0;const s=qn(t.left,e),n=qn(t.top,e),o=qn(t.width,e),r=qn(t.height,e),a=1e-7;return (Math.abs(s-t.left)>a||Math.abs(n-t.top)>a||Math.abs(o-t.width)>a||Math.abs(r-t.height)>a)&&(i=!1),i?{left:s,top:n,width:o,height:r}:t}class Uv extends Qn{constructor(t){super(),i(this,"core",void 0),i(this,"taskResponses",new Map),this.core=t,this.listenEvents();}listenEvents(){}requestPageData(t){this.core.pageService.getPage(t);return new Rv(this,t)}deleteResponse(t){this.taskResponses.delete(t);}dispose(){this.taskResponses.forEach((t=>{t.destroy();})),this.taskResponses=null,super.dispose();}}class Lv{constructor(t){i(this,"undoStack",void 0),i(this,"redoStack",void 0),i(this,"maxTimes",void 0),this.maxTimes=t||100,this.undoStack=[],this.redoStack=[];}getOperation(){return {undo:this.undoStack.length,redo:this.redoStack.length}}execute(t){return !!t.execute()&&(this.undoStack.push(t),this.checkMaxSize(this.undoStack),this.redoStack.length>0&&(this.redoStack.forEach((t=>{t.dispose();})),this.redoStack.length=0),!0)}undo(){const t=this.undoStack.pop();return t&&(t.undo(),this.redoStack.push(t),this.checkMaxSize(this.undoStack)),!!t}redo(){const t=this.redoStack.pop();return t&&(t.execute(),this.undoStack.push(t),this.checkMaxSize(this.undoStack)),!!t}checkMaxSize(t){if(t.length>this.maxTimes){var e;null===(e=t.splice(0,1)[0])||void 0===e||e.dispose();}}removeUidsFromCommand(t){this.removeFromStack(this.undoStack,t),this.removeFromStack(this.redoStack,t);}removeFromStack(t,e){t.slice().forEach((e=>{if(!e.isValid){const i=t.indexOf(e);t.splice(i,1),e.dispose();}}));}reset(){this.undoStack.forEach((t=>{t.dispose();})),this.redoStack.forEach((t=>{t.dispose();})),this.undoStack=[],this.redoStack=[];}}class Ov extends Qn{constructor(){super(),i(this,"invokers",void 0),i(this,"onOperationsChanged",to(this)),i(this,"onBeforeRefreshCommands",to(this)),i(this,"onRefreshCommands",to(this)),i(this,"maxUndoRedoTimes",void 0),this.invokers=new Map,this.maxUndoRedoTimes=100;}setMaxUndoRedoTimes(t){this.maxUndoRedoTimes=t,this.invokers.forEach((e=>{e.maxTimes=t;}));}createInvoker(t){if(!this.invokers.has(t)){const e=new Lv(this.maxUndoRedoTimes);this.invokers.set(t,e);}}deleteInvokers(t){t.forEach((t=>{if(this.invokers.has(t)){const e=this.invokers.get(t);null==e||e.reset(),this.invokers.delete(t);}}));}execute(t,e){const i=this.invokers.get(e);!(null==i||!i.execute(t))&&this.emitOperationsChanged(e);}undo(t){const e=this.invokers.get(t),i=!(null==e||!e.undo());return i&&this.emitOperationsChanged(t),i}redo(t){const e=this.invokers.get(t),i=!(null==e||!e.redo());return i&&this.emitOperationsChanged(t),i}saveOperations(t){const e=this.invokers.get(t);return !!e&&(e.reset(),this.emitOperationsChanged(t),!0)}getOperationState(t){return this.invokers.get(t).getOperation()}removePageFromCommand(t,e){this.onBeforeRefreshCommands.emit({docUid:t,pageUids:e});this.invokers.get(t).removeUidsFromCommand(e),this.emitOperationsChanged(t);}emitOperationsChanged(t){const e=this.invokers.get(t);let i=0,s=0;if(e){const t=e.getOperation();i=t.undo,s=t.redo;}const n=Kg.create(t,i,s);this.onOperationsChanged.emit(n);}dispose(){this.invokers.clear(),super.dispose();}reset(){this.invokers.forEach((t=>{t.reset();})),this.invokers.clear();}}class Nv extends Qn{constructor(){super(),i(this,"files",void 0),i(this,"onDeleteFileData",void 0),this.files=new Map,this.onDeleteFileData=to(this);}dispose(){this.files.clear(),super.dispose();}reset(){this.files.clear();}addFile(t,e,i){const s=new tv({uid:t,mime:e,pageCount:i});this.files.set(t,s);}getByUid(t){return this.files.get(t)}addUser(t,e,i){const s=this.getByUid(t);return null==s?void 0:s.addUser(e,i)}addUsersByParsedPages(t,e){e.forEach((e=>{this.addUser(t,e.fileIndex,e.pageUid);}));}deleteUser(t,e,i){const s=this.getByUid(t);return s&&(s.deleteUser(e,i),s.count||(this.onDeleteFileData.emit(t),this.files.delete(t))),!1}}class _v extends Qn{constructor(t){super(),i(this,"pages",void 0),i(this,"core",void 0),i(this,"onUpdatePage",to(this)),i(this,"onCreatePage",to(this)),i(this,"onCopyPage",to(this)),i(this,"onDeletePages",to(this)),i(this,"onBeforeDeletePages",to(this)),i(this,"onAfterDeletePages",to(this)),i(this,"onBeforeCopyPages",to(this)),i(this,"onCopyPages",to(this)),this.core=t,this.pages=new Map;}handlePagePreloadChange(t){let{viewerUid:e,viewerMode:i,docUid:s,changes:n}=t;n.forEach((t=>{let{pageUid:n,from:o,to:r}=t;const a=this.getPage(n),l={viewerUid:e,docUid:s,pageUid:n},{autoReleaseBlob:h,autoReleaseImg:c}=Bo;o&&!r?(a.raw.deleteUser(l),a.raw.hasUser()||(this.core.imageLoadService.cancelLoadRawImage(n),this.core.parserService.cancelGetPage(a.fileUid,a.fileIndex),h&&a.raw.resetBlob(),c&&a.raw.resetImg()),i!==lg.DEFAULT&&i!==lg.THUMBNAIL||(a.original.deleteUser(l),a.original.hasUser()||(this.core.imageLoadService.cancelLoadOriginalImage(n),h&&a.original.resetBlob(),c&&a.original.resetImg()),a.display.deleteUser(l),a.display.hasUser()||(this.core.imageLoadService.cancelLoadDisplayImage(n),h&&a.display.resetBlob(),c&&a.display.resetImg())),i===lg.THUMBNAIL&&(a.thumbnail.deleteUser(l),a.thumbnail.hasUser()||(this.core.imageLoadService.cancelLoadThumbnailImage(n),h&&a.thumbnail.resetBlob(),c&&a.thumbnail.resetImg())),a.raw.hasUser()||this.core.parserService.cancelGetPage(a.fileUid,a.fileIndex)):(a.raw.addUser(l),i!==lg.DEFAULT&&i!==lg.THUMBNAIL||(a.original.addUser(l),a.display.addUser(l)),i===lg.THUMBNAIL&&a.thumbnail.addUser(l));}));}dispose(){this.pages.forEach((t=>{t.dispose();})),this.pages.clear(),super.dispose();}reset(){this.pages.forEach((t=>{t.dispose();})),this.pages.clear();}getPage(t){return this.pages.get(t)}startCreatePagesByParsedPages(t,e,i){t.forEach(((t,s)=>{var n;this.createPage({...t,fileUid:e,annotations:(null===(n=t.annotations)||void 0===n?void 0:n.map((t=>t.uid)))||[]},i);}));}endCreatePagesByParsedPages(t,e){t.forEach((t=>{let{pageUid:i,fileIndex:s}=t;const n=_f.create(i,e,s);this.onCreatePage.emit(n);}));}createPage(t,e){const i=new vv(t,e);return this.pages.set(i.uid,i),i}copyPage(t,e,i){const s=i.copy(t,e);return this.pages.set(s.uid,s),Ef.create(t,s.fileUid,s.fileIndex,i.annotations.slice()),s}deletePages(t){const e=Bf.create(t);this.onBeforeDeletePages.emit(e),t.forEach((t=>{const e=this.pages.get(t);e&&e.dispose(),this.pages.delete(t);})),this.onDeletePages.emit(e),this.onAfterDeletePages.emit(e);}updatePage(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=this.pages.get(t);if(s){const{doc:n,customData:o}=s;s.dispose();const r=new vv({...i,pageUid:t},n);r.customData=o,this.pages.set(t,r);const a=Xf.create(n.uid,t,e);this.onUpdatePage.emit(a);}}getPageCount(){return this.pages.size}}var Wv=new WeakSet,Fv=new WeakSet;class Hv{constructor(t){v(this,Fv),v(this,Wv),i(this,"core",void 0),i(this,"annotationMapper",void 0),this.core=t,this.annotationMapper=new Sd;}reset(){}async saveToPng(t,e,i){var s;const n=this.core.pageService.getPage(t);if(!n)return Promise.resolve(null);const o=await this.core.sourceStore.get(n.fileUid);if("image/png"===(null===(s=o.fileData)||void 0===s?void 0:s.type)){if(!((null==e?void 0:e.saveAnnotation)&&n.annotations.length>0||p(this,Wv,Vv).call(this,n)))return i&&(i.details.current=i.details.total,i.status="InProgress",ku.info(i),i.status="Completed",ku.info(i)),o.fileData}const r=this.core.getPageData(t),a=await r.display({renderAnnotation:!(null==e||!e.saveAnnotation),getPng:!0});r.destroy();const l=no.isApple&&!(null!=e&&e.saveAnnotation&&n.annotations.length>0)&&p(this,Fv,zv).call(this,n);if(!l){if("image/png"===await Fn(a.data))return i&&(i.details.current=i.details.total,i.status="InProgress",ku.info(i),i.status="Completed",ku.info(i)),a.data}const h=this.core.saverService.getSaver("image/png");try{const t=await h.save(a.data,{outputType:3,is1Bit:l});return i&&(i.details.current=i.details.total,i.status="InProgress",ku.info(i),i.status="Completed",ku.info(i)),t}finally{h.destroy();}}async saveToJpeg(t,e,i){var s;const n=this.core.pageService.getPage(t);if(!n)return Promise.resolve(null);const o=await this.core.sourceStore.get(n.fileUid);if("image/jpeg"===(null===(s=o.fileData)||void 0===s?void 0:s.type)&&void 0===(null==e?void 0:e.quality)){if(!((null==e?void 0:e.saveAnnotation)&&n.annotations.length>0||p(this,Wv,Vv).call(this,n)))return i&&(i.details.current=i.details.total,i.status="InProgress",ku.info(i),i.status="Completed",ku.info(i)),o.fileData}const r=this.core.saverService.getSaver("image/jpeg");try{const s=this.core.getPageData(t),n=await s.display({renderAnnotation:!(null==e||!e.saveAnnotation)});s.destroy();const o=await r.save(n.data,{outputType:1,jpegQuality:null==e?void 0:e.quality});return i&&(i.details.current=i.details.total,i.status="InProgress",ku.info(i),i.status="Completed",ku.info(i)),o}finally{r.destroy();}}async saveToTiff(t,e,i){const s=this.core.saverService.getSaver("image/tiff"),n=!(null==e||!e.saveAnnotation);try{await s.init(e);for(let o=0;o<t.length;o++){const r=t[o],a=this.core.pageService.getPage(r);if(!a)break;const l=this.core.getPageData(r),h=await l.display({renderAnnotation:n});l.destroy();const c=no.isApple&&!(null!=e&&e.saveAnnotation&&a.annotations.length>0)&&p(this,Fv,zv).call(this,a);await s.appendPage(h.data,{is1Bit:c}),i&&(i.details.current=o+1,i.status="InProgress",ku.info(i));}const o=await s.getTiff();return i&&(i.details.current=i.details.total,i.status="Completed",ku.info(i)),o}finally{s.destroy();}}isPdfInfoChanged(t){return !!t.pdfOptions&&(t.rotation%360!==t.pdfOptions.rotation||(t.mediaBox.left!==t.pdfOptions.mediaBox.left||t.mediaBox.width!==t.pdfOptions.mediaBox.width||t.mediaBox.height!==t.pdfOptions.mediaBox.height||t.mediaBox.top!==t.pdfOptions.mediaBox.top||(t.cropBox.left!==t.pdfOptions.cropBox.left||t.cropBox.width!==t.pdfOptions.cropBox.width||t.cropBox.height!==t.pdfOptions.cropBox.height||t.cropBox.top!==t.pdfOptions.cropBox.top)))}async saveToPdf(t,e,i){var s;null!=e&&e.creationDate&&(e.creationDate=Jf(e.creationDate)),null!=e&&e.modifiedDate&&(e.modifiedDate=Jf(e.modifiedDate));const n=(null==e?void 0:e.mimeType)||"application/pdf";!e||"annotation"!==e.saveAnnotation&&"flatten"!==e.saveAnnotation||Ap.makeSureAnnotationLicenseExist();const o=null!==(s=null==e?void 0:e.quality)&&void 0!==s?s:80,r=this.core.saverService.getSaver("application/pdf");try{await r.init(e);const s=new Map,v=e&&e.pageType&&e.pageType!==Vo.PAGE_DEFAULT;await r.appendBlankPages(595,842,t.length);const m=[];for(let n=0;n<t.length;n++){var a,l;if(m.includes(n))continue;const u=t[n],g=this.core.pageService.getPage(u);if(!g)break;const f=await this.core.sourceStore.get(g.fileUid),y=v||(null===(a=g.pdfOptions)||void 0===a?void 0:a.convertMode)===Cd.CM_IMAGEONLY||(null===(l=g.pdfOptions)||void 0===l?void 0:l.renderOptions.renderGrayscale),x=[],w=[],b=[];if(f.fileData&&"application/pdf"===f.fileData.type&&!y)for(let i=n;i<t.length;i++){var h,c;if(n!==i&&!w.includes(n))break;const o=t[i],r=this.core.pageService.getPage(o);if(!r)continue;if(r.fileUid!==g.fileUid)continue;if(!r.isFull)continue;if("image"===(null==e?void 0:e.saveAnnotation)&&r.annotations.length>0)continue;if((null===(h=r.pdfOptions)||void 0===h?void 0:h.convertMode)===Cd.CM_IMAGEONLY||null!==(c=r.pdfOptions)&&void 0!==c&&c.renderOptions.renderGrayscale)continue;let a=!1;r.filter&&"none"!==r.filter&&(a=!0);const l=r.getActions(),d=r.getPerspectiveActions();l.every((t=>"rotate"===t.type||"crop"===t.type))&&d.every((t=>"rotate"===t.type||"crop"===t.type))||(a=!0);let u=!1;if(a){this.core.getAnnotationsByPageUid(t[n]).forEach((t=>{t.oriIndex>=0&&!t.modified&&(u=!0);}));}a&&!u||(this.isPdfInfoChanged(r)&&s.set(i,{mediaBox:r.mediaBox,cropBox:r.cropBox,rotation:r.rotation}),x.push(r.fileIndex),w.push(i),u&&b.push({pageUid:o,pageIndex:i,fileIndex:r.fileIndex}));}if(x.length>0){var d;const t=null===(d=f.loadOptions)||void 0===d?void 0:d.password,s=[];if(b.forEach((t=>{s.push(t.pageIndex);})),await r.replaceRawPdfPages(f.fileData,t,x,w),i){i.status="InProgress";for(let t=0;t<w.length;t++)s.includes(w[t])||(m.push(w[t]),i.details.current=m.length,ku.info(i));}for(let t=0;t<b.length;t++){const s=await this.core.imageDataService.getNotRotatedDisplay(b[t].pageUid,"image"===(null==e?void 0:e.saveAnnotation),!1,o);await r.changePageImage(b[t].pageIndex,s.data,{cropBox:g.cropBox,mediaBox:g.mediaBox,rotation:g.rotation,width:s.width,height:s.height}),i&&(i.status="InProgress",m.push(b[t].pageIndex),i.details.current=m.length,ku.info(i));}}else {let t;const s=1e-6;let a=!0;Math.abs(g.cropBox.left-g.mediaBox.left)<s&&Math.abs(g.cropBox.top-g.mediaBox.top)<s&&Math.abs(g.cropBox.width-g.mediaBox.width)<s&&Math.abs(g.cropBox.height-g.mediaBox.height)<s&&(a=!1),t=v&&a?await this.core.imageDataService.getNotRotatedCroppedDisplay(u,"image"===(null==e?void 0:e.saveAnnotation),!1,o):await this.core.imageDataService.getNotRotatedDisplay(u,"image"===(null==e?void 0:e.saveAnnotation),!1,o);const l=no.isApple&&!("image"===(null==e?void 0:e.saveAnnotation)&&g.annotations.length>0)&&p(this,Fv,zv).call(this,g);await r.applyImageToPage(n,t.data,{cropBox:g.cropBox,mediaBox:g.mediaBox,rotation:g.rotation,width:t.width,height:t.height,bitDepth:l?1:void 0}),i&&(m.push(n),i.details.current=m.length,i.status="InProgress",ku.info(i));}}s.size>0&&await r.setPageInfo(s);const y=[];for(let i=0;i<t.length;i++){var u;const s=this.core.pageService.getPage(t[i]);if(s)if(e&&"image"===e.saveAnnotation)(null===(u=s.pdfOptions)||void 0===u?void 0:u.annotCount)>0&&await r.removePageAnnotations(i);else {const n=s.pdfOptions&&s.pdfOptions.convertMode===Cd.CM_RENDERALL&&s.pdfOptions.renderOptions.renderAnnotations===Pd.RENDER_ANNOTATIONS,o=this.core.getAnnotationsByPageUid(t[i]);if(!o.length){!n&&s.pdfOptions&&s.pdfOptions.annotCount>0&&await r.removePageAnnotations(i);continue}e&&"none"===e.saveAnnotation&&o.forEach((t=>{!["textBox","textTypewriter"].includes(t.type)||!t.modified&&js(null==t?void 0:t.oriIndex)||t.style.textContents.forEach((t=>{y.push({family:t.fontFamily,isBold:"bold"===t.fontWeight,isItalic:"italic"===t.fontStyle});}));}));const a=[];for(let t=0;t<o.length;t++)!0===o[t].flattened&&(a.push(o[t]),o.splice(t,1),t-=1);if(a.length>0){const t=await this.annotationMapper.getOriginalAnnotations(a,{width:s.mediaBox.left+s.mediaBox.width,height:2*s.mediaBox.top+s.mediaBox.height});await r.flattenPageAnnotations(i,t);}if(e&&"none"!==e.saveAnnotation){const t=await this.annotationMapper.getOriginalAnnotations(o,{width:s.mediaBox.left+s.mediaBox.width,height:2*s.mediaBox.top+s.mediaBox.height});var g;if(await r.setPageAnnotations(i,t,n),"flatten"===e.saveAnnotation)(t.length>0||n&&null!==(g=s.pdfOptions)&&void 0!==g&&g.annotCount)&&await r.flattenPage(i);}else {var f;(null===(f=s.pdfOptions)||void 0===f?void 0:f.annotCount)>0&&await r.removePageAnnotations(i);}}}if(y.length){await r.ifFontsExist(y)||ku.warning(ku.WASM_FONT_LOSS);}const x=await r.getPdf(n);return i&&(i.details.current=i.details.total,i.status="Completed",ku.info(i)),x}catch(t){throw ku.EXTERNAL_ERR}finally{r.destroy();}}}function Vv(t){if(!t.isFull)return !0;if(t.filter&&"none"!==t.filter)return !0;if(t.getActions().some((t=>"rotate"!==t.type)))return !0;if(t.getPerspectiveActions().some((t=>"rotate"!==t.type)))return !0;const e=this.core.getAnnotationsByPageUid(t.uid);let i=!1;return e.forEach((t=>{t.flattened&&(i=!0);})),!!i||0!==t.rotation}function zv(t){if(1!==t.resource.bitDepth)return !1;if(t.filter&&t.filter!==tu.NONE&&t.filter!==tu.BLACK_AND_WHITE&&t.filter!==tu.SAVE_INK)return !1;const e=this.core.getAnnotationsByPageUid(t.uid);let i=!1;return e.forEach((t=>{t.flattened&&(i=!0);})),!i}const $v=t=>{const e=new Set(t);return Array.from(e.values())};class jv extends Qn{constructor(){super(),i(this,"observer",void 0),i(this,"onResizeObserver",to(this)),this.observer=new ResizeObserver((t=>{t.forEach((t=>{this.onResizeObserver.emit(t);}));}));}observe(t){this.observer.observe(t);}unobserve(t){this.observer.unobserve(t);}reset(){this.observer.disconnect();}dispose(){this.observer.disconnect(),this.observer=null,super.dispose();}}class Xv{constructor(){i(this,"canvas",void 0),i(this,"renderer",void 0),i(this,"root",void 0),this.renderer=new jl,this.canvas=new Al({renderer:this.renderer,width:10,height:10,canvas:document.createElement("canvas"),dpr:1,willReadFrequently:!0}),this.root=this.canvas.document.documentElement,(new wc).init(this.canvas);}render(t,e,i){this.root.children.slice().forEach((t=>{this.root.removeChild(t);})),this.root.appendChild(t),this.canvas.resize(e||t.width,i||t.height),this.canvas.render();}reset(){this.root.children.slice().forEach((t=>{this.root.removeChild(t);})),this.root.sortable.sorted=[];}getCanvas(){return this.canvas.contextService.getDomElement()}}let Gv;function Yv(t){let e=-1;Gv||(Gv=function(){const t=new Int32Array(256);for(let e=0;e<256;e++){let i=e;for(let t=0;t<8;t++)i=1&i?3988292384^i>>>1:i>>>1;t[e]=i;}return t}());for(let i=0;i<t.length;i++)e=Gv[255&(e^t[i])]^e>>>8;return -1^e}const qv="image/png",Jv="image/jpeg",Zv="p".charCodeAt(0),Qv="H".charCodeAt(0),Kv="Y".charCodeAt(0),tm="s".charCodeAt(0);function em(t,e){const i=t.slice(0,33);return new Promise(((s,n)=>{const o=new FileReader;o.onload=()=>{const i=new Uint8Array(o.result),n=t.slice(33),r=function(t,e,i,s){if(i===Jv)return t[13]=1,t[14]=e>>8,t[15]=255&e,t[16]=e>>8,t[17]=255&e,t;if(i===qv){const i=new Uint8Array(13);e*=39.3701,i[0]=Zv,i[1]=Qv,i[2]=Kv,i[3]=tm,i[4]=e>>>24,i[5]=e>>>16,i[6]=e>>>8,i[7]=255&e,[i[8],i[9],i[10],i[11]]=[i[4],i[5],i[6],i[7]],i[12]=1;const n=Yv(i),o=new Uint8Array(4);if(o[0]=n>>>24,o[1]=n>>>16,o[2]=n>>>8,o[3]=255&n,s){const e=function(t){for(let e=t.length-1;e>=4;e--)if(9===t[e-4]&&t[e-3]===Zv&&t[e-2]===Qv&&t[e-1]===Kv&&t[e]===tm)return e-3;return -1}(t);return t.set(i,e),t.set(o,e+13),t}const r=new Uint8Array(4);r[0]=0,r[1]=0,r[2]=0,r[3]=9;const a=new Uint8Array(54);return a.set(t,0),a.set(r,33),a.set(i,37),a.set(o,50),a}throw new Error(`The format ${i} is not supported.`)}(i,e,t.type),a=new Blob([r,n],{type:t.type});s(a);},o.onerror=t=>{n(t);},o.readAsArrayBuffer(i);}))}class im{constructor(t){i(this,"core",void 0),i(this,"taskMap",void 0),i(this,"viewerMap",void 0),i(this,"defaultPageMap",void 0),this.core=t,this.taskMap=new Map,this.viewerMap=new Map,this.defaultPageMap=new Map,this.core.pageService.onBeforeDeletePages.on((t=>{t.pageUids.forEach((t=>{const e=this.core.pageService.getPage(t);if(!e||e.isDestroyed)return;this.viewerMap.forEach((i=>{if(i.has(t)){const s=i.get(t);if(s){s.tasks.slice().forEach((t=>{this.taskMap.delete(t.taskUid),this.core.parserService.cancelRenderPage(e.fileUid,t);}));}i.delete(t);}}));const i=this.defaultPageMap.get(t);i&&i.viewerUids.forEach((e=>{this.cancelGetDefaultRenderPage(e,t);}));}));}));}reset(){this.taskMap.clear(),this.viewerMap.clear(),this.defaultPageMap.clear();}async getRenderPage(t,e,i,s,n){const o=this.core.pageService.getPage(e);if(!o||o.isDestroyed)return null;const{fileUid:r,fileIndex:a}=o;let l=this.viewerMap.get(t);l||(l=new Map,this.viewerMap.set(t,l));let h=l.get(e);h||(h={curTask:null,tasks:[]},l.set(e,h));const c=h.tasks;c.slice().forEach((t=>{t.canceled=!0;const e=c.indexOf(t);c.splice(e,1),this.taskMap.delete(t.taskUid),this.core.parserService.cancelRenderPage(r,t);}));const d=qs(),u={taskUid:d,canceled:!1,pageUid:e};h.curTask=u,h.tasks||(h.tasks=[]),h.tasks.push(u),this.taskMap.set(d,{taskUid:d,viewerUid:t,pageUid:e});const p=await this.core.sourceStore.get(r);let g;if(g=this.core.parserService.getCustomParserClasses(p.fileData.type)?p.fileData.type:await Fn(p.fileData),!g){const i=this.viewerMap.get(t);if(i){const t=i.get(e);if(t){t.tasks.slice().forEach((e=>{if(e.taskUid!==t.curTask.taskUid){this.taskMap.delete(e.taskUid);const i=t.tasks.indexOf(e);t.tasks.splice(i,1);}}));}}ku.throw(ku.FILE_NOT_SUPPORT);}let f=null;u.canceled||(i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1),f=await this.core.parserService.renderPage(p.fileData,g,r,a,{index:a,width:i,height:s,rect:n,outputType:po.IT_RGBA},u));const v=this.viewerMap.get(t);if(v){const t=v.get(e);if(t){t.tasks.slice().forEach((e=>{if(e.taskUid!==t.curTask.taskUid){this.taskMap.delete(e.taskUid);const i=t.tasks.indexOf(e);t.tasks.splice(i,1);}}));}}return this.taskMap.delete(d),u.canceled?null:f}async cancelGetRenderPage(t,e){const i=this.core.pageService.getPage(e);if(!i||i.isDestroyed)return;const s=this.viewerMap.get(t);if(!s)return;const n=s.get(e);if(!n)return;const{fileUid:o}=i;n.tasks.forEach((t=>{t.canceled=!0,this.taskMap.delete(t.taskUid),this.core.parserService.cancelRenderPage(o,t);})),n.tasks=[];}async getDefaultRenderPage(t,e){const i=this.core.pageService.getPage(e);if(!i)return;const s=this.defaultPageMap.get(e);if(s)return void s.viewerUids.push(t);i.isLoadingDefaultRenderPage=!0;const{fileUid:n,fileIndex:o}=i,r=await this.core.sourceStore.get(n);let a;a=this.core.parserService.getCustomParserClasses(r.fileData.type)?r.fileData.type:await Fn(r.fileData),a||(i.isLoadingDefaultRenderPage=!1,ku.throw(ku.FILE_NOT_SUPPORT));const l={taskUid:`${qs()}_defaultRenderPage`,canceled:!1},h={task:l,viewerUids:[t]};this.defaultPageMap.set(e,h);const{mediaBox:c}=i,d=Gn(i.mediaBox,Bo.displayResolution,Bo.dataResolution),{left:u}=d,p=d.top,g=d.left+d.width,f=d.top+d.height,{defaultRenderPageWidth:v,defaultRenderPageHeight:m}=Bo,y=c.width/c.height,x=v/m;let w=0,b=0;c.width<=v&&c.height<=m?(w=c.width,b=c.height):y>x?(w=v,b=v/y):(w=m*y,b=m);const S=await this.core.parserService.renderPage(r.fileData,a,n,o,{index:o,width:w,height:b,rect:[u,p,g,f],outputType:po.IT_RGBA},l);if(this.defaultPageMap.delete(e),!S)return void(i.isLoadingDefaultRenderPage=!1);const C=document.createElement("canvas");C.width=w,C.height=b;const P=C.getContext("2d").createImageData(S.imageInfo.imageWidth,S.imageInfo.imageHeight);P.data.set(S.imageData),C.getContext("2d").putImageData(P,0,0),i.defaultRenderPage=C;}cancelGetDefaultRenderPage(t,e){const i=this.core.pageService.getPage(e);if(!i)return;const s=this.defaultPageMap.get(e);if(!s)return;const n=s.viewerUids.indexOf(t);n>=0&&s.viewerUids.splice(n,1),0===s.viewerUids.length&&(this.defaultPageMap.delete(e),i.isLoadingDefaultRenderPage=!1,this.core.parserService.cancelRenderPage(i.fileUid,s.task));}async getRaw(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.raw.isAvailable)return i.raw.getImageDetail();const{fileUid:s,fileIndex:n}=i,o=await this.core.sourceStore.get(s);let r;return r=this.core.parserService.getCustomParserClasses(o.fileData.type)?o.fileData.type:await Fn(o.fileData),r||ku.throw(ku.FILE_NOT_SUPPORT),new Promise(((t,a)=>{let l=!1;const h=setTimeout((()=>{l=!0,t(null);}),Bo.loadRawPageTimeout);this.core.parserService.getPage(o.fileData,r,s,n).then((s=>{if(l)return;if(clearTimeout(h),!s)return void t(null);let{raw:n}=i;e||(n=new av(i)),n.updateImageDetail(s.resource),t(n.getImageDetail());})).catch((e=>{l||(clearTimeout(h),ku.error(e),t(null));}));}))}catch(t){return ku.error(t),null}}async getOriginal(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;const{original:s}=i;if(s.isAvailable)return s.getImageDetail();const n=await this.getRaw(t);if(!n)return null;const o=await this.handlePerspectiveQuad(t,n);return e&&o&&i.original.updateImageDetail(o),o}async handlePerspectiveQuad(t,e){const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;let s=e;const n=i.getProcessedQuad();if(n){const o=ku.buildInfo("perspective",{pageUid:t,perspectiveQuad:n});if(ku.info(o),s=await this.core.perspectiveService.perspective({data:e.data,type:uo.JPEG},n,{angle:i.initRotation}),!s)return o.status="Failed",ku.info(o),null;o.status="Completed",ku.info(o);}const o=new av(i);return o.updateImageDetail(s),o.getImageDetail()}async getDisplay(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.display.isAvailable)return i.display.getImageDetail();const s=await this.getOriginal(t);if(!s)return null;const{filter:n}=i,o=await this.handleFilter(t,s);return i.filter!==n?this.getDisplay(t):(e&&o&&i.display.updateImageDetail(o),o)}async handleFilter(t,e){const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;const s=e,{filter:n}=i;if(n&&"none"!==n){const i=ku.buildInfo("filter",{pageUid:t,filterType:n});ku.info(i);const o=await this.core.filterService.applyFilter({data:e.data,type:uo.JPEG,width:e.width,height:e.height},n);if(!Hs(o))return i.status="Failed",ku.info(i),null;i.status="Completed",ku.info(i),s.data=o;}const o=new av(i);return o.updateImageDetail(s),o.getImageDetail()}async getEditedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=this.core.pageService.getPage(t);if(!n||n.isDestroyed)return null;const o=await this.getDisplay(t,!1),r=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));if(n.getActions().length||0!==n.rotation||!n.isMediaBoxEqualCropBox()||e&&n.annotations.length||r){const o=await this.applyEditToDisplay(t,e,i,!0,s),r=new av(n);return r.updateImageDetail(o),r.getImageDetail()}return o}async getNotRotatedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;const n=this.core.pageService.getPage(t);if(!n||n.isDestroyed)return null;const o=await this.getOriginal(t);if(!o)return null;const r=await this.handleFilter(t,o);if(e&&n.annotations.length){const o=await this.applyEditToDisplay(t,e,!1,!1,i,s),r=new av(n);return r.updateImageDetail(o),r.getImageDetail()}return r}async getNotRotatedCroppedDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100;const n=this.core.pageService.getPage(t);if(!n||n.isDestroyed)return null;const o=await this.getOriginal(t);if(!o)return null;await this.handleFilter(t,o);const r=await this.applyCropToDisplay(t,e,!1,i,s),a=new av(n);return a.updateImageDetail(r),a.getImageDetail()}async getThumbnail(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.core.pageService.getPage(t);if(!i||i.isDestroyed)return null;if(i.thumbnail.isAvailable)return i.thumbnail.getImageDetail();const s=await this.getDisplay(t,!0);if(!s)return null;const n=await this.displayToThumbnail(s.data);return n?(e&&i.thumbnail.updateImageDetail(n),n):null}async displayToThumbnail(t){return t}async applyEditToDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:100;const r=await this.core.imageLoadService.loadDisplayImage(t),a=this.core.pageService.getPage(t),l=await this.getDisplay(t,!1);let h;if(s)h=a.getEditResultForPixel();else {const[t,e]=Gn([a.mediaBox.width,a.mediaBox.height],Bo.displayResolution,a.resource.resolutionX);h={rWidth:t,rHeight:e,cropLeft:0,cropTop:0,cropWidth:t,cropHeight:e,rotation:0};}const c={width:Math.round(h.rWidth)||1,height:Math.round(h.rHeight)||1,data:null},d=new Wa({style:{x:-h.cropLeft,y:-h.cropTop,img:r,width:l.width,height:l.height}}),u=new Ga({style:{x:-(h.cropWidth-h.rWidth)/2,y:-(h.cropHeight-h.rHeight)/2,width:h.cropWidth,height:h.cropHeight}});u.appendChild(d),u.setLocalAngle(h.rotation);let p=null;if(this.core.annotationService&&a.annotations.length){const s=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));(e||!e&&s)&&(p=new Ga({style:{x:-h.cropLeft,y:-h.cropTop,width:a.original.pageWidth,height:a.original.pageHeight}}),await this.applyAnnotationToPage(p,t,i,!e&&s),u.appendChild(p));}this.core.commonCanvas.render(u,Math.max(1/devicePixelRatio,h.rWidth),Math.max(1/devicePixelRatio,h.rHeight)),this.core.commonCanvas.reset();const g=this.core.commonCanvas.getCanvas();return new Promise(((t,e)=>{g.toBlob((async e=>{p&&p.children.forEach((t=>{t instanceof Vh&&t.destroy();})),null!=r&&r.src&&URL.revokeObjectURL(r.src),e=await em(e,a.resolutionX||Bo.displayResolution),c.data=e,t(c);}),n?"image/png":"image/jpeg",o/100);}))}async applyCropToDisplay(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:100;const o=await this.core.imageLoadService.loadDisplayImage(t),r=this.core.pageService.getPage(t),a=await this.getDisplay(t,!1),l=r.toPixelPPI(r.cropBox.width,!1),h=r.toPixelPPI(r.cropBox.height,!0),c={rWidth:Math.round(l),rHeight:Math.round(h),cropLeft:r.toPixelPPI(r.cropBox.left,!1),cropTop:r.toPixelPPI(r.cropBox.top,!0),cropWidth:l,cropHeight:h,rotation:0},d={width:Math.round(c.rWidth)||1,height:Math.round(c.rHeight)||1,data:null},u=new Wa({style:{x:-c.cropLeft,y:-c.cropTop,img:o,width:a.width,height:a.height}}),p=new Ga({style:{x:-(c.cropWidth-c.rWidth)/2,y:-(c.cropHeight-c.rHeight)/2,width:c.cropWidth,height:c.cropHeight}});p.appendChild(u),p.setLocalAngle(c.rotation);let g=null;if(this.core.annotationService&&r.annotations.length){const s=this.core.getAnnotationsByPageUid(t).some((t=>!0===t.flattened));(e||!e&&s)&&(g=new Ga({style:{x:-c.cropLeft,y:-c.cropTop,width:r.original.pageWidth,height:r.original.pageHeight}}),await this.applyAnnotationToPage(g,t,i,!e&&s),p.appendChild(g));}this.core.commonCanvas.render(p,Math.max(1/devicePixelRatio,c.rWidth),Math.max(1/devicePixelRatio,c.rHeight)),this.core.commonCanvas.reset();const f=this.core.commonCanvas.getCanvas();return new Promise(((t,e)=>{f.toBlob((async e=>{g&&g.children.forEach((t=>{t instanceof Vh&&t.destroy();})),null!=o&&o.src&&URL.revokeObjectURL(o.src),e=await em(e,r.resolutionX||Bo.displayResolution),d.data=e,t(d);}),s?"image/png":"image/jpeg",n/100);}))}async applyAnnotationToPage(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=this.core.pageService.getPage(e),o=[];n.annotations.forEach((t=>{const e=this.core.annotationService.getAnnotationByUid(t);o.push(e);})),o.sort(((t,e)=>t.layer-e.layer));for(let e=0;e<o.length;e++){if(i&&!o[e].flags.includes("print"))continue;if(s&&!o[e].flattened)return;if("stamp"===o[e].type&&o[e].style.imageData&&(!js(o[e].style.width)||!js(o[e].style.height))){const t=new bo,i=await t.readImageInfo({fileSource:o[e].style.imageData});let s=i.imageWidth,n=i.imageHeight;if(s>400||n>400){const t=Math.max(s/400,n/400);s/=t,n/=t;}o[e].style.width=s,o[e].style.height=n;}const r=this.core.annotationService.createAnnotationShape(o[e],n);r instanceof Vh&&r.style.imageData&&r.style.img instanceof HTMLImageElement&&await new Promise((t=>{r.style.img.onload=()=>{t();};})),r&&t.appendChild(r);}}}class sm{constructor(t){i(this,"name",void 0),this.name=t||"Guest";}getUser(){return this.name}setUser(t){this.name=t;}}class nm extends er{static create(t){return new nm(t)}constructor(t){super("setExternalHandler"),i(this,"handlerType",void 0),this.handlerType=t;}}class om{static makeSureSourcesTypeSupported(t,e,i,s,n){const o=[];if(Ls(e))e.forEach(((t,e)=>{if(!t||0===t.length){const t=Du("Source[]",i,`[${e}].fileData`,!0);o.push(`${t}: ${ku.FILE_NOT_SUPPORT.message}`);}}));else if(!e||0===e.length){const t=Du("Source",i,"fileData");o.push(`${t}: ${ku.FILE_NOT_SUPPORT.message}`);}if(o.length>0){if(!t){throw ku.buildError({...ku.FILE_NOT_SUPPORT,details:o},s,n)}ku.throw({...ku.FILE_NOT_SUPPORT,details:o},s,n);}}}class rm{constructor(t){i(this,"core",void 0),this.core=t;}async loadText(t){for(const s of t){var e,i;const t=this.core.pageService.getPage(s);if(!t||!t.isTextPage||t.parsedTexts)continue;if((null===(e=t.pdfOptions)||void 0===e?void 0:e.convertMode)!==Cd.CM_RENDERALL){t.setParsedTexts(null);continue}const{fileUid:n,fileIndex:o}=t,r=await this.core.sourceStore.get(n);let a;a=this.core.parserService.getCustomParserClasses(r.fileData.type)?r.fileData.type:await Fn(r.fileData),a||ku.throw(ku.FILE_NOT_SUPPORT);const l=await this.core.parserService.getPageTexts(r.fileData,a,n,[o]);null!=l&&null!==(i=l[0].charInfos)&&void 0!==i&&i.length?t.setParsedTexts(l[0]):t.setParsedTexts(null);}}}var am=new WeakMap,lm=new WeakMap,hm=new WeakMap,cm=new WeakMap,dm=new WeakMap,um=new WeakMap,pm=new WeakMap;class gm{constructor(t,e,i,o){f(this,am,{writable:!0,value:void 0}),f(this,lm,{writable:!0,value:qs()}),f(this,hm,{writable:!0,value:!1}),f(this,cm,{writable:!0,value:void 0}),f(this,dm,{writable:!0,value:void 0}),f(this,um,{writable:!0,value:void 0}),f(this,pm,{writable:!0,value:new Map}),n(this,am,t),n(this,cm,e),n(this,dm,i),n(this,um,o),t.searchers.set(s(this,lm),this);}get docUid(){return s(this,cm)}async getResults(t){const e="DocTextSearcher.getResults";s(this,hm)&&ku.error(ku.SEARCHER_DESTROYED),_s(t)&&ku.error(ku.PARAM_MISS,e,"pageIndex"),(!js(t)||js(t)&&t<0)&&ku.error(ku.PARAM_INVALID,e,"pageIndex");const i=s(this,am).core.getDocument(s(this,cm));i||ku.error(ku.DOC_NOT_EXIST,e);const n=i.pages[t];if(n||ku.error(ku.PAGE_NOT_EXIST,e),s(this,pm).has(n))return s(this,pm).get(n);const o=await s(this,am).core.getSearchedTextsByPageUid(n,s(this,dm),s(this,um)),r=Bo.displayResolution,a=Bo.dataResolution,l=o.map((t=>{let{text:e,lines:i,context:o}=t;return {pageUid:n,text:s(this,dm),rects:i.map((t=>({x:jn(Gn(t.box.left,r,a),2),y:jn(Gn(t.box.top,r,a),2),width:jn(Gn(t.box.width,r,a),2),height:jn(Gn(t.box.height,r,a),2)}))),context:o}}));return s(this,pm).set(n,l),l}clearCache(t){s(this,hm)||t.forEach((t=>{s(this,pm).has(t)&&s(this,pm).delete(t);}));}clearAllCache(){s(this,hm)||s(this,pm).clear();}destroy(){s(this,am).searchers.delete(s(this,lm)),n(this,am,null),s(this,pm).clear(),n(this,hm,!0);}}class fm extends Qn{constructor(t){super(),i(this,"searchers",new Map),i(this,"core",void 0),this.core=t,this.listenEvents();}getSearchersByDocUid(t){const e=[];return this.searchers.forEach((i=>{i.docUid===t&&e.push(i);})),e}listenEvents(){const{documentService:t}=this.core;t.onBeforeDeleteDocs.on((t=>{t.docUids.forEach((t=>{const e=this.getSearchersByDocUid(t);null!=e&&e.length&&e.forEach((t=>{t.destroy();}));}));}),this),t.onDeletePagesFromDoc.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),t.onDeleteAllPagesFromDoc.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((t=>{t.clearAllCache();}));}),this),this.core.pageService.onUpdatePage.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache([t.pageUid]);}));}),this),this.core.editService.onAfterCropPages.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),this.core.onFilterChanged.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache(t.pageUids);}));}),this),this.core.onAfterPerspective.on((t=>{const e=this.getSearchersByDocUid(t.docUid);null!=e&&e.length&&e.forEach((e=>{e.clearCache([t.pageUid]);}));}),this);}createDocTextSearcher(t,e,i){return new gm(this,t,e,i)}dispose(){this.searchers.forEach((t=>{t.destroy();})),this.searchers.clear(),super.dispose();}}function vm(t,e,i,s,n){const o={isOver:!1,pointerX:-1,pointerY:-1,page:t};if(t&&s){const s=(n%360+360)%360/90,{x:r,y:a}=t.getPosition(),l=t.getScale(),{width:h,height:c}=t;let d=-1,u=-1;0===s?(d=(e-r)/l.x,u=(i-a)/l.y,o.isOver=e>=r&&i>=a&&e<=r+h&&i<=a+c):1===s?(d=(i-a)/l.x,u=(r-e)/l.y,o.isOver=e>=r-c&&i>=a&&e<=r&&i<=a+h):2===s?(d=(r-e)/l.x,u=(a-i)/l.y,o.isOver=e>=r-h&&i>=a-c&&e<=r&&i<=a):3===s&&(d=(a-i)/l.y,u=(e-r)/l.x,o.isOver=e>=r&&i>=a-c&&e<=r+h&&i<=a),o.pointerX=d,o.pointerY=u;}return o}class mm extends Qn{constructor(t){super(),i(this,"core",void 0),this.core=t;}pageVisualToOriginal(t,e,i){const s=this.core.pageService.getPage(t);if(!s)return null;const{rotation:n,cropBox:o}=s,{left:r,top:a,width:l,height:h}=o;let c=0,d=0;switch(Math.abs(n%360)){case 90:c=i,d=h-e;break;case 180:c=l-e,d=h-i;break;case 270:c=l-i,d=e;break;default:c=e,d=i;}return {x:c+r,y:d+a}}pageOriginalToVisual(t,e,i){const s=this.core.pageService.getPage(t);if(!s)return null;const{rotation:n,cropBox:o}=s,{left:r,top:a,width:l,height:h}=o,c=e-r,d=i-a;switch(Math.abs(n%360)){case 90:return {x:h-d,y:c};case 180:return {x:l-c,y:h-d};case 270:return {x:d,y:l-c};default:return {x:c,y:d}}}viewerToPageVisual(t,e,i,s){if(!this.core.pageService.getPage(e))return null;if(!this.core.viewerService.getViewer(t))return null;const n=this.viewerToPageOriginal(t,e,i,s);return {...this.pageOriginalToVisual(e,n.x,n.y)}}viewerToPageOriginal(t,e,i,s){const n=this.core.pageService.getPage(e);if(!n)return null;const o=this.core.viewerService.getViewer(t);if(!o)return null;const r=o.getActiveTab(),a=null==r?void 0:r.getPageByUid(e);if(!a)return null;if(vm(a,i,s,a.isVisible,0).isOver){const t=vm(a.image,i,s,!0,n.rotation);return {x:t.pointerX,y:t.pointerY}}return null}}const ym=new Map,xm=[];let wm=class t extends Qn{constructor(t,e,s,n,o){super(),i(this,"parserService",void 0),i(this,"saverService",void 0),i(this,"perspectiveService",void 0),i(this,"filterService",void 0),i(this,"detectorService",void 0),i(this,"viewerService",void 0),i(this,"editService",void 0),i(this,"annotationService",void 0),i(this,"documentService",void 0),i(this,"trackerService",void 0),i(this,"imageLoadService",void 0),i(this,"optimizationService",void 0),i(this,"processService",void 0),i(this,"commandService",void 0),i(this,"fileSaveService",void 0),i(this,"fileService",void 0),i(this,"pageService",void 0),i(this,"resizeService",void 0),i(this,"imageDataService",void 0),i(this,"userService",void 0),i(this,"textLoadService",void 0),i(this,"pageDataService",void 0),i(this,"docTextSearchService",void 0),i(this,"coordinateService",void 0),i(this,"sourceStore",void 0),i(this,"commonCanvas",void 0),i(this,"onBeforeGetPageData",void 0),i(this,"onBeforeLoadSource",void 0),i(this,"onAfterLoadSource",void 0),i(this,"onSetExternalHandler",void 0),i(this,"onAfterPerspective",void 0),i(this,"onFilterChanged",void 0),i(this,"onBeforeUnload",void 0),i(this,"onAfterUnload",void 0),i(this,"removeAllDocUid",void 0),this.parserService=t,this.saverService=e,this.perspectiveService=s,this.filterService=n,this.detectorService=o,this.onBeforeGetPageData=to(this),this.onBeforeLoadSource=to(this),this.onAfterLoadSource=to(this),this.onSetExternalHandler=to(this),this.onBeforeUnload=to(this),this.onAfterUnload=to(this),this.onAfterPerspective=to(this),this.onFilterChanged=to(this),this.commonCanvas=new Xv,this.sourceStore=new hg,this.trackerService=new wv,this.documentService=new xv,this.fileService=new Nv,this.pageService=new _v(this),this.imageLoadService=new _g(this),this.optimizationService=new Vg,this.processService=new zg,this.commandService=new Ov,this.fileSaveService=new Hv(this),this.resizeService=new jv,this.imageDataService=new im(this),this.userService=new sm("Guest"),this.textLoadService=new rm(this),this.pageDataService=new Uv(this),this.coordinateService=new mm(this),xm.forEach((t=>{var e;null===(e=t.apply)||void 0===e||e.call(t,this);})),this.docTextSearchService=new fm(this),this.initServiceEvent(),Ba.bindHandler(["opacity"],void 0,Sc),Ba.bindHandler(["width","height","borderWidth"],void 0,Tc),Ba.bindHandler(["startPoint","endPoint","lineEnding"],void 0,Ac),Ba.bindHandler(["r","rx","ry","borderWidth"],void 0,bc),Ba.bindHandler(["points","segments"],void 0,Cc),Ba.bindHandler(["borderWidth"],void 0,Pc),Ba.bindHandler(["textContents","borderWidth","textAlign"],void 0,kc),Ba.bindHandler(["textAlign"],void 0,Dc);}initServiceEvent(){const{documentService:t,commandService:e,pageService:i,viewerService:s,fileService:n,parserService:o}=this;t.onDocumentCreated.on((t=>{e.createInvoker(t.docUid);}),e),t.onDocumentDeleted.on((t=>{e.deleteInvokers([t.docUid]);}),e),s.onPagePreloadChanged.on((t=>{i.handlePagePreloadChange(t);}),i),n.onDeleteFileData.on((t=>{this.sourceStore.remove(t);})),n.onDeleteFileData.on((t=>{o.freeParserByFileUid(t);}),o),this.editService.onAfterCropPages.on((t=>{t.pageUids.forEach((t=>{const e=i.getPage(t);e&&e.isTextPage&&!e.parsedTexts?this.textLoadService.loadText([e.uid]).then((()=>{e.handleCropBoxForText();})):e&&e.handleCropBoxForText();}));}));}static getClass(t){return ym.get(t)}static setClass(t,e){ym.set(t,e);}static registerPlugin(e){xm.includes(e)||xm.push(e),e.install&&e.install(t);}getClass(t){return ym.get(t)}createAsyncRepository(){return new hg}createViewer(e){const i=t.getClass("Viewer"),s={...e,core:this,groupUid:e.groupUid||qs()},n=this.viewerService.createViewer(i,s);return n.context.isInitialized=!0,n}removeViewer(t){this.viewerService.removeViewer(t.uid);}getViewer(t){return this.viewerService.getViewer(t)}getViewers(){return this.viewerService.getAllViewers()}getFileParserDefaultOptions(t){return this.parserService.getDefaultParserOptions(t)}setFileParserDefaultOptions(t,e){return this.parserService.setDefaultParserOptions(t,e)}setFileParser(t,e){this.parserService.registerCustomParser(t,e);}getSourceParseOptions(t,e){if("application/pdf"===e){var i;const e=t;return e.convertMode=null!==(i=e.convertMode)&&void 0!==i?i:Cd.CM_AUTO,Ns(e)}if("width"in t){return Ns(t)}}async loadSource(t,e,i,s){Ls(t)||(t=[t]),this.removeAllDocUid===e&&(this.removeAllDocUid=null);const n=this.documentService.getDocument(e);if(!n)return s&&(s.status="Failed",ku.info(s)),[];const o=js(i)?{insertBeforeIndex:i}:{...i},r="ignore"===o.exception,a=await this.getSourcesMimeTypes(t);if(this.removeAllDocUid===e)return this.removeAllDocUid=null,[];r||om.makeSureSourcesTypeSupported(!1,a,"sources");const l=[],h=async(t,i)=>{const s=a[i];r&&om.makeSureSourcesTypeSupported(!1,s,`sources[${i}]`);const h=[],c=qs(),d=this.getSourceParseOptions(t,s),{fileData:u}=t,{pageCount:p,batchSize:g}=await this.parserService.getParseInfo(u,s,c,d);if(this.removeAllDocUid===e)return [];this.sourceStore.set(c,{fileData:s===u.type?u:u.slice(0,u.size,s),loadOptions:d,pageCount:p}),this.fileService.addFile(c,s,p);const f=this.getBatchIndices(g,p);for(const i of f){var v;const r=await this.parserService.parse(u,s,c,i,d).catch((t=>{throw t}));if(this.removeAllDocUid===e)return [];null===(v=t.extraPageData)||void 0===v||v.forEach((t=>{const e=r.find((e=>e.fileIndex===t.index));if(e){const i={...t};delete i.index,js(e.rotation)&&js(i.rotation)&&(i.rotation+=e.rotation),_s(i.filter)||(e.filter=i.filter),_s(i.rotation)||(e.rotation=i.rotation),_s(i.perspectiveQuad)||(e.perspectiveQuad=i.perspectiveQuad),_s(i.index)||(e.index=i.index);}}));const a=r.map((t=>{var e;const i=qs();return t.pageUid=i,null!==(e=t.filter)&&void 0!==e||(t.filter=this.filterService.getDefaultFilterType()||"none"),i}));l.push({fileData:u,mimeType:s,fileUid:c,parsedPages:r,indices:i,parseOptions:d}),this.fileService.addUsersByParsedPages(c,r),r.forEach((t=>{this.annotationService.annotationApp.createAnnotationPage(t.pageUid);})),this.pageService.startCreatePagesByParsedPages(r,c,n),this.documentService.addPagesToDocument(e,a,o.insertBeforeIndex),_s(o.insertBeforeIndex)||(o.insertBeforeIndex+=r.length),h.push(...a);}return h};this.onBeforeLoadSource.emit({docUid:e});const c=[];for(const[i,n]of t.entries())try{const t=await h(n,i);if(this.removeAllDocUid===e)return this.removeAllDocUid=null,[];c.push(...t),s&&(s.status="InProgress",s.details.current=i+1,ku.info(s));}catch(t){if(!r)throw t;ku.warning(t);}for(let t=0;t<l.length;t++){const i=l[t];if(await this.parserService.parseAnnotation(i.fileData,i.mimeType,i.fileUid,i.parsedPages,i.indices,i.parseOptions),this.removeAllDocUid===e)return this.removeAllDocUid=null,[];this.annotationService.createAnnotationsByParsedPages(e,i.parsedPages),i.parsedPages.forEach((t=>{const e=this.pageService.getPage(t.pageUid);e&&t.annotations&&(e.annotations=t.annotations.map((t=>t.uid)));}));}const d=c.map((t=>n.pages.indexOf(t)));return this.onAfterLoadSource.emit(zf.create(e,d,c)),this.documentService.onPagesAddedOut.emit(zf.create(e,[...d],[...c])),s&&(s.details.current=s.details.total,s.status="Completed",ku.info(s)),c}async getSourcesMimeTypes(t){const e=[];for(const i of t){const t=this.parserService.getCustomParserClasses(i.fileData.type)?i.fileData.type:await Fn(i.fileData);e.push(t);}return e}getAnnotationsByPageUid(t){const e=this.pageService.getPage(t);return e?e.annotations.map((t=>this.annotationService.getAnnotationByUid(t))):[]}getBatchIndices(t,e){const i=[];for(let s=0;s<e;){const n=t>0?Math.min(t,e-s):e;i.push(Array.from({length:n},((t,e)=>s+e))),s+=n;}return i}getPageData(t){return this.pageDataService.requestPageData(t)}async setCustomData(t,e){const i=this.pageService.getPage(t);return i?(i.customData=Ns(e),!0):Promise.reject()}async getCustomData(t){const e=this.pageService.getPage(t);if(!e)return Promise.reject();return Ns(e.customData)}async updatePage(t,e){var i,s;const n=this.pageService.getPage(t);if(!n)return !1;const{fileData:o}=e,r=qs(),a=this.parserService.getCustomParserClasses(o.type)?o.type:await Fn(o);om.makeSureSourcesTypeSupported(!1,[a],"data");const l=this.getSourceParseOptions(e,a),{pageCount:h}=await this.parserService.getParseInfo(o,a,r,l).catch((t=>{throw t}));if(js(e.fileIndex)&&(e.fileIndex>=h||e.fileIndex<0)){const t=["UpdateSource.fileIndex is out of range"];throw {...ku.PARAM_INVALID,details:t}}this.sourceStore.set(r,{fileData:o,loadOptions:l,pageCount:h}),this.fileService.addFile(r,a,h);const[c]=await this.parserService.parse(o,a,r,[e.fileIndex||0],l).catch((t=>{throw t}));c.pageUid=t,null!==(i=c.filter)&&void 0!==i||(c.filter=this.filterService.getDefaultFilterType()||"none"),await this.parserService.parseAnnotation(o,a,r,[c],[e.fileIndex||0],l),this.commandService.removePageFromCommand(n.doc.uid,[t]),this.fileService.addUser(r,e.fileIndex||0,t),this.fileService.deleteUser(n.fileUid,n.fileIndex,t),null===(s=this.annotationService)||void 0===s||s.deleteAnnotations(n.annotations,!1),this.pageService.updatePage(t,o,{...c,...e,fileUid:r,annotations:[]}),this.annotationService.createAnnotationsByParsedPages(n.doc.uid,[c]);return this.pageService.getPage(t).isUpdated=!0,!0}async getPerspectivePreviewData(t,e,i){const s=this.pageService.getPage(t);if(!s)return null;const n=await this.imageDataService.getRaw(t);if(!n)return null;let{quad:o}=s;o=o?o.map((t=>Gn(t,Bo.displayResolution,s.resource.resolutionX))):[[0,0],[n.width,0],[n.width,n.height],[0,n.height]];const r=await this.processService.perspectivePreview(n.data,4,o,{width:n.width,height:n.height},{...e,...i});return Promise.resolve(r)}createDocument(t){return this.documentService.createDocument(t)}getDocument(t){return this.documentService.getDocument(t)}deleteDocuments(t){const{documentService:e,pageService:i}=this;if(t.map((t=>e.getDocument(t))).includes(void 0))return !1;const s=ef.create(t);e.onBeforeDeleteDocs.emit(s),t.forEach((t=>{const s=e.getDocument(t);var n;s&&(s.pages.forEach((t=>{const e=i.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(n=this.annotationService)||void 0===n||n.deleteAnnotationPages([...s.pages]),i.deletePages(s.pages));}));const n=e.deleteDocuments(t);return e.onAfterDeleteDocs.emit(s),n}renameDocument(t,e){this.documentService.renameDocument(t,e);}transferDocument(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{documentService:s}=this,n=s.getDocument(t),o=s.getDocument(e);if(!n||!o)return !1;if(t===e&&!i.copy)return !i.sourceIndices||this.movePages(t,i.sourceIndices,i.insertBeforeIndex);let r=[];if(null!=i&&i.sourceIndices){r=$v(i.sourceIndices).map((t=>n.pages[t]));}else r=[...n.pages];if(!r.length)return !0;i.copy?r.forEach(((t,e,s)=>{const n=this.pageService.getPage(t),r=qs();if(this.fileService.addUser(n.fileUid,n.fileIndex,r),this.pageService.copyPage(r,o,n),!1!==(null==i?void 0:i.includeAnnotations)&&this.annotationService){this.annotationService.annotationApp.createAnnotationPage(r);const t=n.annotations.map((t=>({...this.annotationService.getAnnotationByUid(t).getConfig(),docUid:o.uid,pageUid:r,uid:qs()})));t.length&&this.annotationService.annotationApp.createAnnotations(t);}s[e]=r;})):(s.removePagesFromDocument(n.uid,r),r.forEach((t=>{const e=this.pageService.getPage(t);var s;(e.doc=o,!1===(null==i?void 0:i.includeAnnotations))&&(null===(s=this.annotationService)||void 0===s||s.deleteAnnotations(e.annotations),e.annotations=[]);}))),s.addPagesToDocument(o.uid,r,i.insertBeforeIndex);const a=r.map((t=>o.pages.indexOf(t)));return s.onPagesAddedOut.emit(zf.create(o.uid,a,r)),!0}mergeDocuments(t,e){const{documentService:i}=this,s=i.createDocument(e);if(!t.length)return s;t=$v(t);const n=[];if(t.forEach((t=>{const e=i.getDocument(t);n.push(...e.pages);})),null!=e&&e.deleteOriginal?(i.deleteDocuments(t),n.forEach((t=>{const i=this.pageService.getPage(t);var n;(i.doc=s,!1===(null==e?void 0:e.includeAnnotations))&&(null===(n=this.annotationService)||void 0===n||n.deleteAnnotations(i.annotations),i.annotations=[]);}))):n.forEach(((t,i,n)=>{const o=this.pageService.getPage(t),r=qs();if(this.fileService.addUser(o.fileUid,o.fileIndex,r),this.pageService.copyPage(r,s,o),!1!==(null==e?void 0:e.includeAnnotations)&&this.annotationService){this.annotationService.annotationApp.createAnnotationPage(r);const t=o.annotations.map((t=>({...this.annotationService.getAnnotationByUid(t).getConfig(),docUid:s.uid,pageUid:r,uid:qs()})));t.length&&this.annotationService.annotationApp.createAnnotations(t);}n[i]=r;})),n.length){i.addPagesToDocument(s.uid,n);const t=n.map((t=>s.pages.indexOf(t)));i.onPagesAddedOut.emit(zf.create(s.uid,t,n));}return s}openDocument(t,e){return this.openOrCloseDocument(t,e)}closeDocument(t,e){return this.openOrCloseDocument(t,e,!0)}openOrCloseDocument(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=this.documentService.getDocument(t);if(!s||!this.viewerService.hasViewer(e))return !1;const n=this.viewerService.getViewer(e);return i?this.documentService.onCloseDocument.emit(Yg.create(s,e,n.groupUid)):this.documentService.onOpenDocument.emit(Gg.create(s,e,n.groupUid)),this.commandService.emitOperationsChanged(t),!0}deletePages(t,e){var i;return e=$v(e),this.commandService.removePageFromCommand(t,[...e]),e.forEach((t=>{const e=this.pageService.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(i=this.annotationService)||void 0===i||i.deleteAnnotationPages(e),this.documentService.removePagesFromDocument(t,[...e]),this.pageService.deletePages(e),!0}deleteAllPages(t){var e;this.removeAllDocUid=t;const i=this.documentService.getDocument(t),s=[...i.pages];return this.commandService.removePageFromCommand(t,s),i.pages.forEach((t=>{const e=this.pageService.getPage(t);this.fileService.deleteUser(e.fileUid,e.fileIndex,t);})),null===(e=this.annotationService)||void 0===e||e.deleteAnnotationPages(i.pages),this.documentService.removeAllPagesFromDocument(t),this.pageService.deletePages(s),!0}movePages(t,e,i){return e=$v(e),this.documentService.movePages(t,e,i)}swapPages(t,e,i){return this.documentService.swapPages(t,e,i)}reorderPages(t,e){return e=$v(e),this.documentService.reorderPages(t,e)}async printPages(t,e,i){const s=this.documentService.getDocument(t);if(!s)return Promise.reject(ku.DOC_NOT_EXIST);const n=e||Array.from(Array(s.pages.length).keys()),o=[];for(let t=0;t<n.length;t++){var r;const e=this.getPageData(s.pages[n[t]]),a=await e.display({renderAnnotation:null===(r=null==i?void 0:i.printAnnotation)||void 0===r||r,isGetPrintPageData:!0});e.destroy(),o.push(a);}if(0===o.length)return Promise.reject();const a=[];return o.forEach((t=>{a.push({data:t.data,width:t.width,height:t.height});})),function(t){let e="",i=0,s=0;const n=[];t.forEach(((t,o)=>{let r=1120,a=850;const l=a/t.width,h=r/t.height;l<h?r=Math.floor(t.height*l):l>h&&(a=Math.floor(t.width*h));const c=Js(t.data).data;n.push(c),e+=`<div class="imageContainer"><img id="DDV_Image${o}" src='${c}' referrerpolicy='strict-origin-when-cross-origin'"/></div>`,i+=a,s+=r;}));const o=`alwaysRaised=yes, z-look=yes, top=0, left=0, toolbar=no, menubar=no, location=no, status=no,width=${i}, height=${s}`,r=window.open("about:blank","_blank",o),a=`<html><head>\n                    <style>\n                        @media print {\n                            body, html {\n                                margin: 0;\n                                padding: 0;\n                                width: 100%;\n                                height: 100%;\n                            }\n\n                            .imageContainer {\n                                break-after: page;\n                                position: relative;\n                                width: 100%;\n                                height: 100%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center\n                            }\n\n                            img {\n                                object-fit: contain;\n                                max-width: 100%;\n                                max-height: 100%;\n                            }\n                        }\n                    </style>\n                </head><body id='DDV_body'>${e}</body></html>`;r&&(r.document.write(a),r.document.close(),r.addEventListener("load",(()=>{const t=r.document.querySelectorAll("img"),e=[];t.forEach((t=>{t.complete&&t.naturalWidth>0?e.push(Promise.resolve()):e.push(new Promise((e=>{t.onload=()=>e(),t.onerror=()=>e();})));})),Promise.all(e).then((()=>{setTimeout((()=>{r.print(),n.forEach((t=>{URL.revokeObjectURL(t);}));}),100);}));})));}(a),!0}setDetectHandler(t,e){this.onSetExternalHandler.emit(nm.create("detect")),this.detectorService.setDetector(e);}setImageFilterHandler(t){this.onSetExternalHandler.emit(nm.create("filter")),this.filterService.setImageFilter(t);}clearExternalHandler(t){if(Xs(t))switch(t){case"documentBoundariesDetect":this.setDetectHandler(t,null);break;case"imageFilter":this.setImageFilterHandler(null);}}unload(){var t;this.onBeforeUnload.emit(),this.viewerService.reset(),this.commonCanvas.reset(),this.sourceStore.reset(),this.documentService.reset(),this.fileService.reset(),this.pageService.reset(),this.commandService.reset(),this.resizeService.reset(),this.processService.reset(),this.detectorService.reset(),this.parserService.reset(),this.fileSaveService.reset(),null===(t=this.annotationService)||void 0===t||t.reset(),Ap.reset(),no.unload(),this.onAfterUnload.emit();}preloadModule(t){no.preloadModule(t);}async perspectivePage(t,e,i){let s,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const o=this.pageService.getPage(e);if(o.setQuad(i)){if(o.isTextPage=!1,this.annotationService.deleteAnnotations(o.annotations,!1),this.commandService.removePageFromCommand(t,[e]),o.quad){const{width:t,height:e}=lv(o.quad);o.original.updateImageDetail({width:t,height:e}),o.display.updateImageDetail({width:t,height:e});}this.imageLoadService.cancelLoadOriginalImage(e),o.original.reset(),n||(s=await this.imageDataService.getOriginal(e)),this.imageLoadService.cancelLoadDisplayImage(e),this.imageLoadService.cancelLoadThumbnailImage(e),o.display.reset(),o.thumbnail.reset();let{width:r,height:a}=o.original.getPageSize();o.isFull?(o.mediaBox={...o.initState.mediaBox},o.cropBox={...o.initState.cropBox}):(n&&({width:r,height:a}=lv(o.quad)),o.mediaBox={left:0,top:0,width:r,height:a},o.cropBox={...o.mediaBox}),this.onAfterPerspective.emit(tf.create(o.doc.uid,e,i,r,a));}return n?null:s||this.imageDataService.getOriginal(e)}async filterPages(t,e,i){e.forEach((t=>{const e=this.pageService.getPage(t);e.filter!==i&&(e.filter=i,e.display.reset(),e.thumbnail.reset());}));const s=Jg.create(t,e,i);return this.onFilterChanged.emit(s),!0}insertBlankPage(t,e,i,s,n,o){const r=this.documentService.getDocument(t);if(!r)return "";this.onBeforeLoadSource.emit({docUid:t});const a=qs(),l={fileData:new Blob([""],{type:"application/ddv-blank-image"}),width:null!=e?e:816,height:null!=i?i:1056,resolutionX:null!=s?s:96,resolutionY:null!=n?n:96},h=this.getSourceParseOptions(l,"application/ddv-blank-image");this.sourceStore.set(a,{fileData:l.fileData,loadOptions:h,pageCount:1}),this.fileService.addFile(a,"application/ddv-blank-image",1),this.parserService.parse(l.fileData,"application/ddv-blank-image",a,[0],h);const{displayResolution:c}=Bo,d=qs();this.fileService.addUser(a,0,d);const u={resource:{data:l.fileData,width:l.width,height:l.height,resolutionX:l.resolutionX,resolutionY:l.resolutionY},mediaBox:{left:0,top:0,width:l.width/l.resolutionX*c,height:l.height/l.resolutionY*c},cropBox:{left:0,top:0,width:l.width/l.resolutionX*c,height:l.height/l.resolutionY*c},annotations:[],fileIndex:0,pageUid:d,fileUid:a};return this.pageService.createPage(u,r),this.annotationService.createAnnotationsByParsedPages(t,[u]),this.documentService.addPagesToDocument(t,[d],o),this.onAfterLoadSource.emit(zf.create(t,[r.pages.indexOf(d)],[d])),this.documentService.onPagesAddedOut.emit(zf.create(t,[r.pages.indexOf(d)],[d])),d}async getPageSourceInfo(t){const e=this.pageService.getPage(t),i={};i.bitDepth=e.resource.bitDepth,i.resolutionX=e.resource.resolutionX,i.resolutionY=e.resource.resolutionY;const s=await this.sourceStore.get(e.fileUid);if("application/pdf"!==s.fileData.type)return i.pageContentType=s.fileData.type,i;if(e.pdfOptions&&e.pdfOptions.pageContentType)return i.pageContentType=e.pdfOptions.pageContentType,i;const n=new Co;try{const t=await n.getPdfPageContentType({fileSource:s.fileData,password:s.loadOptions.password},e.fileIndex);return e.pdfOptions&&(e.pdfOptions.pageContentType=t),i.pageContentType=t,i}finally{n.destroy();}}isPageModified(t){var e;const i=this.pageService.getPage(t);if(!i)return !1;if(!i.isFull)return !0;if(i.filter&&"none"!==i.filter)return !0;if(i.isUpdated)return !0;const{cropBox:s,initState:n}=i;if(s.left!==n.cropBox.left||s.top!==n.cropBox.top||s.width!==n.cropBox.width||s.height!==n.cropBox.height)return !0;const o=i.getActions(),r=i.getPerspectiveActions();let a=0;if(o.forEach((t=>{"rotate"===t.type&&(a+=t.angle);})),r.forEach((t=>{"rotate"===t.type&&(a+=t.angle);})),a%360!=0)return !0;if(this.fileSaveService.isPdfInfoChanged(i))return !0;const l=this.getAnnotationsByPageUid(t);if(l.length!==((null==i||null===(e=i.pdfOptions)||void 0===e?void 0:e.parsedAnnotCount)||0))return !0;const h=[...l];h.sort(((t,e)=>t.layer-e.layer));for(let t=0;t<h.length;t++)if(_s(h[t].oriIndex)||h[t].modified||t!==h[t].parsedOriIndex)return !0;return !1}async isPdfEncrypted(t){const e=await this.getSourcesMimeTypes([{fileData:t}]);if(!e.length||"application/pdf"!==e[0])return !1;const i=qs();let s=!1;return await this.parserService.getParseInfo(t,e[0],i).catch((t=>{-80202===t.code&&(s=!0);})),this.parserService.freeParserByFileUid(i),s}async getSearchedTextsByPageUid(t,e,i){if(0===e.length)return [];const s=this.pageService.getPage(t);if(null==s||!s.isTextPage)return [];if(await new Promise((t=>{setTimeout((()=>{t(1);}),0);})),await this.textLoadService.loadText([t]),null==s||!s.isTextPage)return [];let n=e;return e.trim().length>0&&(n=e.trim()),n=n.replace(/\s+/g,"<<WHITESPACE>>"),n=bm(n),n=n.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(n=`(^|\\W)(${n})($|\\W)`),s.getSearchedText(new RegExp(n,"gm"+(null!=i&&i.caseSensitive?"":"i")),null==i?void 0:i.wholeWord)}async getSearchedTexts(t,e,i){if(0===e.length)return null;const s=this.documentService.getDocument(t);if(!s)return null;await this.textLoadService.loadText(s.pages);const n=[];let o=e;e.trim().length>0&&(o=e.trim()),o=o.replace(/\s+/g,"<<WHITESPACE>>"),o=bm(o),o=o.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(o=`(^|\\W)(${o})($|\\W)`);const r=new RegExp(o,"gm"+(null!=i&&i.caseSensitive?"":"i"));return s.pages.forEach(((t,e)=>{const s=this.pageService.getPage(t);if(s.isTextPage){const t=s.getSearchedText(r,null==i?void 0:i.wholeWord);n.push(...t);}})),n}async getSearchedTextPage(t,e,i){if(0===e.length)return null;const s=this.documentService.getDocument(t);if(!s)return null;await this.textLoadService.loadText(s.pages);let n=e;e.trim().length>0&&(n=e.trim()),n=n.replace(/\s+/g,"<<WHITESPACE>>"),n=bm(n),n=n.replace(/<<WHITESPACE>>/g,"\\s+"),null!=i&&i.wholeWord&&(n=`(^|\\W)(${n})($|\\W)`);const o=[],r=new RegExp(n,"gm"+(null!=i&&i.caseSensitive?"":"i"));return s.pages.forEach(((t,e)=>{const s=this.pageService.getPage(t);if(s.isTextPage){const e=s.getSearchedText(r,null==i?void 0:i.wholeWord);e.length&&o.push({pageUid:t,texts:e});}})),o}createTextSearcher(t,e,i){return this.docTextSearchService.createDocTextSearcher(t,e,i)}};function bm(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Sm(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const{tag:i,style:s,id:n,className:o,children:r}=t,a=document.createElement(i);return n&&(a.id=n+e),o&&(a.className=o),s&&function(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(Xs(e))t.style.cssText=e;else if(i){let i="";Object.keys(e).forEach((t=>{i+=`${t}:${e[t]};`;})),t.style.cssText=i;}else Object.keys(e).forEach((i=>{t.style[i]=e[i];}));}(a,s),r&&r.forEach((t=>{const i=Sm(t,e);a.appendChild(i);})),a}function Cm(t){t&&(t.style.display="none");}function Pm(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t&&(t.style.display=e);}const Tm=t=>parseFloat(Number(t).toFixed(4));function Am(t){let e=1;return t.forEach((t=>{if(t.height>18){const i=t.height/18;e=Math.max(e,i);}})),Math.min(e,8)}function km(t){return !!t&&("mouse"===t.pointerType||!$s()&&"pen"===t.pointerType)}class Dm extends Qn{constructor(){super(),i(this,"uid",void 0),i(this,"type",void 0),i(this,"action",void 0),i(this,"isValid",void 0),this.isValid=!0,this.uid=qs();}execute(){return null}undo(){return null}}new class extends Qn{constructor(){super(...arguments),i(this,"docCreated",to(this)),i(this,"docDeleted",to(this)),i(this,"pageAdded",to(this)),i(this,"pageDeleted",to(this)),i(this,"annotationCreated",to(this)),i(this,"annotationDeleted",to(this)),i(this,"annotationUpdated",to(this)),i(this,"addReply",to(this)),i(this,"commentDeleted",to(this)),i(this,"commentUpdated",to(this));}};class Rm extends tr{static create(t){return new Rm(t,t.uid)}constructor(t,e){super(e),i(this,"type",void 0),i(this,"docUid",void 0),i(this,"pageUid",void 0),i(this,"style",void 0),i(this,"transform",void 0),i(this,"flags",void 0),i(this,"comment",void 0),i(this,"layer",void 0),i(this,"modified",!1),i(this,"flattened",!1),i(this,"oriIndex",void 0),i(this,"customData",{}),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"lines",void 0),i(this,"isBlankTextAssist",!1),i(this,"isMatchText",!1),i(this,"isPageTextLoaded",!1),i(this,"source",void 0),i(this,"parsedOriIndex",void 0),this.type=t.type,this.docUid=t.docUid,this.pageUid=t.pageUid,this.style=t.style,this.flags=t.flags||["print"],this.transform=t.transform,this.oriIndex=t.oriIndex,_s(null==t?void 0:t.modified)||(this.modified=t.modified),_s(null==t?void 0:t.flattened)||(this.flattened=t.flattened),this.customData=t.customData||{},this.source=t.source||"file",this.parsedOriIndex=t.parsedOriIndex,this.initTextAssistCtrl(t);}initTextAssistCtrl(t){var e;if(["highlight","underline","strikeout"].includes(this.type))if(null!=t&&t.startCharRect&&null!=t&&t.endCharRect)this.startCharRect=t.startCharRect,this.endCharRect=t.endCharRect;else if(null!==(e=this.style.lines)&&void 0!==e&&e.length)if("api"===this.source||"file"===this.source){const t=16,e=this.style.lines[0],i=this.style.lines[this.style.lines.length-1];this.startCharRect={left:e.left,top:e.top,width:t,height:t},this.endCharRect={left:i.left+i.width-t,top:i.top,width:t,height:i.height};}else "user"===this.source&&(this.isMatchText=!0,this.isBlankTextAssist=!1,this.isPageTextLoaded=!0);}getConfig(){return {uid:this.uid,docUid:this.docUid,pageUid:this.pageUid,type:this.type,style:Ns(this.style),transform:Ns(this.transform),flags:Ns(this.flags),comment:Ns(this.comment),layer:this.layer,creationDate:this.comment.creationDate,modificationDate:this.comment.modificationDate,oriIndex:this.oriIndex,modified:this.modified,flattened:this.flattened,customData:Ns(this.customData),source:this.source,parsedOriIndex:this.parsedOriIndex,startCharRect:Ns(this.startCharRect),endCharRect:Ns(this.endCharRect),startTextPosition:Ns(this.startTextPosition),endTextPosition:Ns(this.endTextPosition)}}clone(t,e){const i=Rm.create({docUid:this.docUid,pageUid:t,type:this.type,style:Ns(this.style),transform:Ns(this.transform),flags:this.flags.slice(),comment:this.comment,oriIndex:this.oriIndex,modified:this.modified,customData:Ns(this.customData),source:this.source,parsedOriIndex:this.parsedOriIndex}),s=this.comment.clone(i.uid,e);return i.comment=s,i.layer=this.layer,i}updateStyle(t){Object.assign(this.style,t);}updateComment(t){this.comment.updateComment(t);}addReplies(t){this.comment.replies.push(...t);}deleteReplies(t){const e=this.comment.replies;t.forEach((t=>{if(e.includes(t)){const i=e.findIndex((e=>e.uid===t.uid));e.splice(i,1);}}));}updateReply(t){const e=this.comment.replies.findIndex((e=>e.uid===t.uid));this.comment.replies[e]=t;}getAllReplies(){return [...this.comment.replies]}deleteReplyReviewSate(t){const e=this.comment.getReply(t);e&&e.deleteReviewState();}addReplyReviewState(t,e){const i=this.comment.getReply(t);i&&i.setReviewState(e);}getReplyReviewState(t){const e=this.comment.getReply(t);return null!=e&&e.reviewStates.length?e.reviewStates[e.reviewStates.length-1]:null}deleteReplyMarkedSate(t){const e=this.comment.getReply(t);e&&e.deleteMarkedState();}addReplyMarkedState(t,e){const i=this.comment.getReply(t);i&&i.setMarkedState(e);}getReplyMarkedState(t){const e=this.comment.getReply(t);return null!=e&&e.markedStates.length?e.markedStates[e.markedStates.length-1]:null}}class Em{static create(t){return new Em(t)}constructor(t){i(this,"uid",void 0),i(this,"author",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"state",void 0),this.uid=t.uid,this.author=t.author,this.contents=t.contents,this.creationDate=t.creationDate,this.state=t.state;}}class Mm{static create(t){return new Mm(t)}constructor(t){i(this,"uid",void 0),i(this,"author",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"state",void 0),this.uid=t.uid,this.author=t.author,this.contents=t.contents,this.creationDate=t.creationDate,this.state=t.state;}}class Im extends Ko{static create(t){return new Im(t,t.uid)}constructor(t,e){var s,n;super(e),i(this,"annotationUid",void 0),i(this,"author",void 0),i(this,"subject",void 0),i(this,"contents",void 0),i(this,"creationDate",void 0),i(this,"modificationDate",void 0),i(this,"markedStates",void 0),i(this,"reviewStates",void 0),this.annotationUid=t.annotationUid,this.author=t.author,this.subject=t.subject,this.contents=t.contents,this.creationDate=t.creationDate,this.modificationDate=t.modificationDate,this.markedStates=[],this.reviewStates=[],null!==(s=t.markedStates)&&void 0!==s&&s.length&&t.markedStates.forEach((t=>{const e=Mm.create(t);this.markedStates.push(e);})),null!==(n=t.reviewStates)&&void 0!==n&&n.length&&t.reviewStates.forEach((t=>{const e=Em.create(t);this.reviewStates.push(e);}));}updateReply(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,t);}setMarkedState(t){const e=this.markedStates.length,i=this.markedStates[e-1];if((null==i?void 0:i.state)!==t.state||!i&&"marked"===t.state){const e=Mm.create(t);return this.markedStates.push(e),!0}return !1}deleteMarkedState(){this.markedStates.pop();}setReviewState(t){const e=Em.create(t);this.reviewStates.push(e);}deleteReviewState(){this.reviewStates.pop();}clone(t,e){const i=Im.create({annotationUid:t,author:this.author,subject:this.subject,contents:this.contents,creationDate:e,modificationDate:e});return this.cloneStates(i),i}cloneStates(t){this.markedStates.forEach((e=>{const i=Mm.create({...e,uid:qs()});t.markedStates.push(i);})),this.reviewStates.forEach((e=>{const i=Em.create({...e,uid:qs()});t.reviewStates.push(i);}));}}class Bm extends Im{static create(t,e){return new Bm(t,e)}constructor(t,e){super(t,e),i(this,"replies",void 0),this.replies=[];}updateComment(t){Object.assign(this,t);}getReply(t){return this.replies.find((e=>e.uid===t.uid))}clone(t,e){const i=Bm.create({annotationUid:t,author:this.author,subject:this.subject,contents:this.contents,creationDate:e,modificationDate:e});return this.cloneStates(i),this.replies.forEach((s=>{i.replies.push(s.clone(t,e));})),i}}class Um extends Ko{static create(t){return new Um(t)}constructor(t){super(t),i(this,"bottom",void 0),i(this,"top",void 0),i(this,"annotations",void 0),i(this,"layers",void 0),this.annotations=[],this.bottom=-1,this.top=0,this.layers=[];}clone(t){const e=Um.create(t);return e.top=this.top,e.bottom=this.bottom,e.annotations=this.annotations.slice(),e.layers=Ns(this.layers),e}createTop(){const{top:t}=this;return this.top+=1,t}addAnnotation(t,e){if(!this.annotations.includes(t)){this.annotations.push(t);const i={annotationUid:t,layer:e};return this.layers.push(i),_s(e)?(i.layer=this.top,this.top+=1):(this.sortLayers(),this.top=Math.max(this.top,e+1)),i}return null}sortLayers(){this.layers.sort(((t,e)=>t.layer-e.layer));}deleteAnnotations(t){t.forEach((t=>{const e=this.annotations.indexOf(t);e>-1&&this.annotations.splice(e,1);const i=this.layers.findIndex((e=>e.annotationUid===t));i>-1&&this.layers.splice(i,1);}));}moveAnnotation(t){const e=this.annotations.indexOf(t);if(e<0)return null;const i=this.layers.findIndex((e=>e.annotationUid===t));if(i<0)return null;const s={annotationUid:t,index:e,layerIndex:i,layer:this.layers[i].layer};return this.deleteAnnotations([t]),s}undoMoveAnnotation(t){const{annotationUid:e}=t;this.annotations.includes(e)||this.layers.find((t=>t.annotationUid===e))||(this.annotations.splice(t.index,0,e),this.layers.splice(t.layerIndex,0,{annotationUid:e,layer:t.layer}));}bringForward(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e],s=this.layers[e+1];return s&&(this.switchLayer(i,s),this.sortLayers()),{curLayer:i,forward:s}}switchLayer(t,e){const i=t.layer;t.layer=e.layer,e.layer=i;}sendBackward(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e],s=this.layers[e-1];return s&&(this.switchLayer(i,s),this.sortLayers()),{curLayer:i,backward:s}}bringToFront(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e];return e<this.layers.length-1&&(i.layer=this.top,this.top+=1,this.sortLayers()),i}sendToBack(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return null;const i=this.layers[e];return e>0&&(i.layer=this.bottom,this.bottom-=1,this.sortLayers()),i}restoreLayer(t,e){const i=this.layers.findIndex((e=>e.annotationUid===t));if(i<0)return null;return this.layers[i].layer=e,this.sortLayers(),!0}getLayerState(t){const e=this.layers.findIndex((e=>e.annotationUid===t));if(e<0)return {back:!1,front:!1,forward:!1,backward:!1};const i={back:!0,front:!0,forward:!0,backward:!0};return 0===e&&(i.back=!1,i.backward=!1),e===this.layers.length-1&&(i.front=!1,i.forward=!1),1===this.layers.length&&(i.front=!1,i.forward=!1,i.back=!1,i.backward=!1),i}getAnnotationUidListByLayer(){return this.layers.slice().sort(((t,e)=>t.layer-e.layer)).map((t=>t.annotationUid))}}const Lm=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findAnnotationByUid(t){return this.db.get(t)}deleteAnnotation(t){return !!this.db.has(t.uid)&&(this.db.delete(t.uid),!0)}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}},Om=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findCommentByUid(t){return this.db.get(t)}deleteComment(t){this.db.has(t.uid)&&this.db.delete(t.uid);}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}},Nm=new class{constructor(){i(this,"db",void 0),this.db=new Map;}findPageByUid(t){return this.db.get(t)}deletePagesByUids(t){t.forEach((t=>{this.db.delete(t);}));}has(t){return this.db.has(t.uid)}save(t){this.db.set(t.uid,t);}clear(){this.db.clear();}};const _m=new class extends Qn{constructor(){super(...arguments),i(this,"annotationCreated",to(this)),i(this,"annotationDeleted",to(this)),i(this,"annotationUpdated",to(this)),i(this,"commentDeleted",to(this)),i(this,"commentUpdated",to(this)),i(this,"addReply",to(this)),i(this,"replyDeleted",to(this)),i(this,"replyUpdated",to(this)),i(this,"addReplyReviewState",to(this)),i(this,"deleteReplyReviewState",to(this)),i(this,"addReplyMarkedState",to(this)),i(this,"deleteReplyMarkedState",to(this)),i(this,"bringFroward",to(this)),i(this,"sendBackward",to(this)),i(this,"bringToFront",to(this)),i(this,"sendToBack",to(this)),i(this,"restoreLayer",to(this)),i(this,"annotationPageSwitched",to(this));}};class Wm extends er{static create(t){return new Wm(t)}constructor(t){super("annotationCreatedDomainEvent"),i(this,"annotations",void 0),this.annotations=t;}}const Fm=new class{constructor(t,e,s,n){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.annotationPageRepo=s,this.eventHooks=n;}execute(t){const e=t.map((t=>{const e=Rm.create({...t}),i=this.annotationPageRepo.findPageByUid(e.pageUid).addAnnotation(e.uid,t.layer);if(i&&(e.layer=i.layer),this.annotationRepo.save(e),t.comment){var s;const i=Bm.create(t.comment);e.comment=i,null!==(s=t.comment.replies)&&void 0!==s&&s.length&&t.comment.replies.forEach((t=>{const e=Im.create(t);i.replies.push(e),this.replyRepo.save(e);}));}return e})),i=Wm.create(e);return this.eventHooks.annotationCreated.emit(i),e}}(Lm,Om,Nm,_m);class Hm extends er{static create(t,e){return new Hm(t,e)}constructor(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];super("annotationDeletedDomainEvent"),i(this,"annotations",void 0),i(this,"emitEvent",void 0),this.annotations=t,this.emitEvent=e;}}const Vm=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHooks=s;}execute(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];for(const e of t){if(!this.annotationRepo.has(e))return !1}t.forEach((t=>{this.annotationRepo.deleteAnnotation(t);this.annotationPageRepo.findPageByUid(t.pageUid).deleteAnnotations([t.uid]);}));const i=Hm.create(t,e);return this.eventHooks.annotationDeleted.emit(i),!0}}(Lm,Nm,_m);const zm=new class{constructor(t){i(this,"annotationRepo",void 0),this.annotationRepo=t;}execute(t){return this.annotationRepo.findAnnotationByUid(t)}}(Lm);class $m extends er{static create(t){return new $m(t)}constructor(t){super("addReplyDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const jm=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid),i=Im.create({annotationUid:t.annotationUid,author:t.author,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modificationDate,subject:""});e.addReplies([i]),this.replyRepo.save(i);const s=$m.create(i);return this.eventHooks.addReply.emit(s),!0}}(Lm,Om,_m);class Xm extends er{static create(t,e,i){return new Xm(t,e,i)}constructor(t,e,s){super("annotationUpdatedDomainEvent"),i(this,"updateDetails",void 0),i(this,"updatedBy",void 0),i(this,"updateActions",void 0),this.updateDetails=t,this.updatedBy=e,this.updateActions=s;}}const Gm=new class{constructor(t,e){i(this,"annotationRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.eventHooks=e;}execute(t){const e=t.updateDetails.map((t=>{const e=t.to.changed,i=this.annotationRepo.findAnnotationByUid(t.annotationUid);return i?(e.style&&i.updateStyle(e.style),e.transform&&Nn(e.transform,i.transform),e.flags&&(i.flags=[...e.flags]),_s(e.flattened)||(i.flattened=e.flattened),_s(e.layer)||(i.layer=e.layer),_s(e.startCharRect)||(i.startCharRect=e.startCharRect),_s(e.endCharRect)||(i.endCharRect=e.endCharRect),_s(e.startTextPosition)||(i.startTextPosition=e.startTextPosition),_s(e.endTextPosition)||(i.endTextPosition=e.endTextPosition),i.modified=e.modified,e.comment&&Object.assign(i.comment,e.comment),this.annotationRepo.save(i),i):null})),i=Xm.create(t.updateDetails,t.updatedBy,t.updateActions);return this.eventHooks.annotationUpdated.emit(i),e}}(Lm,_m);class Ym extends er{static create(t){return new Ym(t)}constructor(t){super("replyUpdatedDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const qm=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;const i=this.replyRepo.findCommentByUid(t.uid);if(!i)return !1;i.updateReply({author:t.author,contents:t.contents,modifiedDate:t.modificationDate}),e.updateReply(i),this.annotationRepo.save(e),this.replyRepo.save(i);const s=Ym.create(i);return this.eventHooks.replyUpdated.emit(s),!0}}(Lm,Om,_m);class Jm extends er{static create(t){return new Jm(t)}constructor(t){super("replyDeletedDomainEvent"),i(this,"reply",void 0),this.reply=t;}}const Zm=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){if(!this.replyRepo.has(t))return !1;const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;e.deleteReplies([t]),this.replyRepo.deleteComment(t);const i=Jm.create(t);return this.eventHooks.replyDeleted.emit(i),!0}}(Lm,Om,_m);class Qm extends er{static create(t,e,i){return new Qm(t,e,i)}constructor(t,e,s){super("bringToFrontDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=s;}}const Km=new class{constructor(t,e,s){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=s;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),s=i.getAnnotationUidListByLayer(),n=i.bringToFront(t);if(!n)return !1;e.layer=n.layer;const o=i.getAnnotationUidListByLayer(),r=Qm.create(t,s,o);return this.eventHooks.bringToFront.emit(r),!0}}(Lm,Nm,_m);class ty extends er{static create(t,e,i){return new ty(t,e,i)}constructor(t,e,s){super("sendToBackDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=s;}}const ey=new class{constructor(t,e,s){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=s;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),s=i.getAnnotationUidListByLayer(),n=i.sendToBack(t);if(!n)return !1;e.layer=n.layer;const o=i.getAnnotationUidListByLayer(),r=ty.create(t,s,o);return this.eventHooks.sendToBack.emit(r),!0}}(Lm,Nm,_m);class iy extends er{static create(t,e,i,s){return new iy(t,e,i,s)}constructor(t,e,s,n){super("bringForwardDomainEvent"),i(this,"annotationUid",void 0),i(this,"forwardUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.forwardUid=e,this.from=s,this.to=n;}}const sy=new class{constructor(t,e,s){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=s;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),s=i.getAnnotationUidListByLayer(),n=i.bringForward(t);if(!n)return !1;const{curLayer:o,forward:r}=n;if(e.layer=o.layer,r){this.annotRepo.findAnnotationByUid(r.annotationUid).layer=r.layer;}const a=i.getAnnotationUidListByLayer(),l=iy.create(t,null==r?void 0:r.annotationUid,s,a);return this.eventHooks.bringFroward.emit(l),!0}}(Lm,Nm,_m);class ny extends er{static create(t,e,i,s){return new ny(t,e,i,s)}constructor(t,e,s,n){super("sendBackwardDomainEvent"),i(this,"annotationUid",void 0),i(this,"backwardUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.backwardUid=e,this.from=s,this.to=n;}}const oy=new class{constructor(t,e,s){i(this,"annotRepo",void 0),i(this,"annotPageRepo",void 0),i(this,"eventHooks",void 0),this.annotRepo=t,this.annotPageRepo=e,this.eventHooks=s;}execute(t){const e=this.annotRepo.findAnnotationByUid(t);if(!e)return !1;const i=this.annotPageRepo.findPageByUid(e.pageUid),s=i.getAnnotationUidListByLayer(),n=i.sendBackward(t);if(!n)return !1;const{curLayer:o,backward:r}=n;if(e.layer=o.layer,r){this.annotRepo.findAnnotationByUid(r.annotationUid).layer=r.layer;}const a=i.getAnnotationUidListByLayer(),l=ny.create(t,null==r?void 0:r.annotationUid,s,a);return this.eventHooks.sendBackward.emit(l),!0}}(Lm,Nm,_m);class ry extends er{static create(t){return new ry(t)}constructor(t){super("commentUpdatedDomainEvent"),i(this,"comment",void 0),this.comment=t;}}const ay=new class{constructor(t,e){i(this,"annotationRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.eventHooks=e;}execute(t){const e=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!e)return !1;e.updateComment(t);const i=ry.create(e.comment);return this.eventHooks.commentUpdated.emit(i),!0}}(Lm,_m);class ly extends er{static create(t){return new ly(t)}constructor(t){super("deleteReplyReviewStateDomainEvent"),i(this,"replyUid",void 0),this.replyUid=t;}}const hy=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.replyRepo.findCommentByUid(t);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.deleteReplyReviewSate(e),this.annotationRepo.save(i);const s=ly.create(t);return this.eventHooks.deleteReplyReviewState.emit(s),!0}}(Lm,Om,_m);class cy extends er{static create(t){return new cy(t)}constructor(t){super("addReplyReviewStateDomainEvent"),i(this,"author",void 0),i(this,"creationDate",void 0),i(this,"contents",void 0),i(this,"state",void 0),i(this,"replyUid",void 0),this.author=t.author,this.creationDate=t.creationDate,this.contents=t.contents,this.state=t.state,this.replyUid=t.replyUid;}}const dy=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.replyRepo.findCommentByUid(t.replyUid);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.addReplyReviewState(e,t),this.annotationRepo.save(i);const s=cy.create(t);return this.eventHooks.addReplyReviewState.emit(s),!0}}(Lm,Om,_m);const uy=new class{constructor(t){i(this,"annotationPageRepo",void 0),this.annotationPageRepo=t;}execute(t){let e=this.annotationPageRepo.findPageByUid(t);return e||(e=Um.create(t),this.annotationPageRepo.save(e)),e}}(Nm);const py=new class{constructor(t,e,s){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e,this.replyRepo=s;}execute(t){const e=this.annotationPageRepo.findPageByUid(t.pageUid);if(!e)return null;const i=e.clone(t.newPageUid),s=new Map;return e.annotations.forEach(((e,n)=>{const o=this.annotationRepo.findAnnotationByUid(e).clone(t.newPageUid,"");o.comment.replies.forEach((t=>{this.replyRepo.save(t);})),this.annotationRepo.save(o),i.annotations[n]=o.uid,s.set(e,o.uid);})),i.layers.forEach((t=>{t.annotationUid=s.get(t.annotationUid);})),this.annotationPageRepo.save(i),i}}(Nm,Lm,Om);const gy=new class{constructor(t){i(this,"annotationPageRepo",void 0),this.annotationPageRepo=t;}execute(t){this.annotationPageRepo.deletePagesByUids(t);}}(Nm);const fy=new class{constructor(t,e,s){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e,this.replyRepo=s;}execute(t){const e=this.annotationPageRepo.findPageByUid(t.pageUid);if(!e)return null;const i=this.annotationRepo.findAnnotationByUid(t.annotationUid);if(!i)return null;const s=i.clone(t.pageUid," ");return s.comment.replies.forEach((t=>{this.replyRepo.save(t);})),e.addAnnotation(s.uid),this.annotationRepo.save(s),s}}(Nm,Lm,Om);class vy extends er{static create(t,e,i){return new vy(t,Ns(e),Ns(i))}constructor(t,e,s){super("annotationPageSwitchedDomainEvent"),i(this,"annotationUid",void 0),i(this,"from",void 0),i(this,"to",void 0),this.annotationUid=t,this.from=e,this.to=s;}}const my=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHook",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHook=s;}execute(t){const{annotationUid:e,pageUid:i,x:s,y:n,layer:o}=t,r=this.annotationRepo.findAnnotationByUid(e);if(!r)return !1;const a=this.annotationPageRepo.findPageByUid(r.pageUid);if(!a)return !1;const l=this.annotationPageRepo.findPageByUid(i);if(!l)return !1;const h={pageUid:r.pageUid,x:r.style.x,y:r.style.y,layer:r.layer};a.deleteAnnotations([e]),l.addAnnotation(e,o),r.updateStyle({x:s,y:n}),r.layer=o,r.pageUid=i;const c=vy.create(r.uid,h,{pageUid:i,x:s,y:n,layer:o});return this.eventHook.annotationPageSwitched.emit(c),!0}}(Lm,Nm,_m);class yy extends er{static create(t,e){return new yy(t,e)}constructor(t,e){super("restoreLayerDomainEvent"),i(this,"annotationUid",void 0),i(this,"layer",void 0),this.annotationUid=t,this.layer=e;}}const xy=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"annotationPageRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.annotationPageRepo=e,this.eventHooks=s;}execute(t){let{annotationUid:e,layer:i}=t;const s=this.annotationRepo.findAnnotationByUid(e);if(!s)return !1;this.annotationPageRepo.findPageByUid(s.pageUid).restoreLayer(e,i),s.layer=i;const n=yy.create(e,i);return this.eventHooks.restoreLayer.emit(n),!0}}(Lm,Nm,_m);const wy=new class{constructor(t,e){i(this,"annotationPageRepo",void 0),i(this,"annotationRepo",void 0),this.annotationPageRepo=t,this.annotationRepo=e;}execute(t){let e={back:!1,front:!1,forward:!1,backward:!1};const i=this.annotationRepo.findAnnotationByUid(t);if(!i)return e;const s=this.annotationPageRepo.findPageByUid(i.pageUid);return s?(e=s.getLayerState(t),e):e}}(Nm,Lm);class by extends er{static create(t){return new by(t)}constructor(t){super("AddReplyMarkedStateDomainEvent"),i(this,"author",void 0),i(this,"creationDate",void 0),i(this,"contents",void 0),i(this,"state",void 0),i(this,"replyUid",void 0),this.author=t.author,this.creationDate=t.creationDate,this.contents=t.contents,this.state=t.state,this.replyUid=t.replyUid;}}const Sy=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.replyRepo.findCommentByUid(t.replyUid);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.addReplyMarkedState(e,t),this.annotationRepo.save(i);const s=by.create(t);return this.eventHooks.addReplyMarkedState.emit(s),!0}}(Lm,Om,_m);const Cy=new class{constructor(t,e,s){i(this,"annotationRepo",void 0),i(this,"replyRepo",void 0),i(this,"eventHooks",void 0),this.annotationRepo=t,this.replyRepo=e,this.eventHooks=s;}execute(t){const e=this.replyRepo.findCommentByUid(t);if(!e)return !1;const i=this.annotationRepo.findAnnotationByUid(e.annotationUid);if(!i)return !1;i.deleteReplyReviewSate(e),this.annotationRepo.save(i);const s=ly.create(t);return this.eventHooks.deleteReplyReviewState.emit(s),!0}}(Lm,Om,_m);const Py=new class{constructor(t){i(this,"annotationReplyRepo",void 0),this.annotationReplyRepo=t;}execute(t){return this.annotationReplyRepo.findCommentByUid(t)}}(Om);class Ty extends Qn{constructor(){super(),i(this,"annotationRepo",Lm),i(this,"annotationReplyRepo",Om),i(this,"annotationPageRepo",Nm),i(this,"hooks",_m),this.register(_m);}dispose(){this.reset(),this.hooks.dispose(),super.dispose();}reset(){this.annotationPageRepo.clear(),this.annotationReplyRepo.clear(),this.annotationRepo.clear();}createAnnotationPage(t){return uy.execute(t)}copyAnnotationPage(t,e){return py.execute({pageUid:t,newPageUid:e})}deleteAnnotationPage(t){return gy.execute(t)}createAnnotations(t){return Fm.execute(t)}copyAnnotation(t,e){return fy.execute({annotationUid:t,pageUid:e})}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=t.map((t=>(Xs(t)&&(t=Lm.findAnnotationByUid(t)),t)));return Vm.execute(i,e)}updateAnnotation(t){return Gm.execute(t)}switchAnnotationPage(t,e){return my.execute({annotationUid:Os(t)?t.uid:t,...e})}getAnnotationByUid(t){return zm.execute(t)}getAnnotationLayerState(t){return wy.execute(t)}addReply(t){return jm.execute(t)}deleteReply(t){return Xs(t)&&(t=Om.findCommentByUid(t)),Zm.execute(t)}updateReply(t){return qm.execute(t)}getReply(t){return Py.execute(t)}updateComment(t){return ay.execute(t)}deleteReplyReviewState(t){return hy.execute(t)}addReplyReviewState(t){return dy.execute(t)}getReplyReviewState(t){return Xs(t)&&(t=Om.findCommentByUid(t)),Py.execute(t.uid)}deleteReplyMarkedState(t){return Cy.execute(t)}addReplyMarkedState(t){return Sy.execute(t)}bringToFront(t){return Km.execute(t)}sendToBack(t){return ey.execute(t)}bringForward(t){return sy.execute(t)}sendBackward(t){return oy.execute(t)}restoreLayer(t,e){return xy.execute({annotationUid:t,layer:e})}}const Ay=["enableContinuousDrawing","controlsStyle","inkCreateDelay","showOnTopWhenSelected","defaultStyleConfig","eraserStyle","selectionStyle","enableMoveWithKeyboard","enableDeleteWithKeyboard","enableMultipleSelectWidthCtrl"];class ky extends Qn{constructor(t){super(),i(this,"context",void 0),this.context=t;}updateConfig(t){for(const[e,i]of Object.entries(t))Ay.includes(e)&&this[e](i);}defaultStyleConfig(t){if(!Os(t))return;const{annotationController:e}=this.context,{viewer:i}=this.context,s=i.getAnnotationConfig().defaultStyleConfig,n={...t,stamp:{imageData:null,stampConfig:null,...t.stamp}},{hasChanges:o,changes:r,oldValues:a}=function(t,e){if(t===e)return {hasChanges:!1,changes:{},oldValues:{}};const i={},s={};let n=!1;const o=Object.keys(e);for(let r=0;r<o.length;r++){const a=o[r],l=null==t?void 0:t[a],h=e[a],c=Dy(l,h);c.changed&&(i[a]=void 0!==c.newData?c.newData:h,s[a]=void 0!==c.oldData?c.oldData:l,n=!0);}return {hasChanges:n,changes:i,oldValues:s}}(s,n);if(!_s(null==r?void 0:r.stamp)){var l,h,c;!_s(null===(l=r.stamp)||void 0===l?void 0:l.imageData)||!_s(null===(h=r.stamp)||void 0===h?void 0:h.stampConfig)||!_s(null===(c=r.stamp)||void 0===c?void 0:c.stampIcon)?(a.stamp={...s.stamp},r.stamp={...s.stamp,...r.stamp},r.stamp.opacity===a.stamp.opacity&&(delete r.stamp.opacity,delete a.stamp.opacity)):a.stamp={opacity:s.stamp.opacity};}o&&(e.setAnnotationInteractiveConfig({defaultStyleConfig:r}),e.updateFreeTextDefaultConfig(),i.hooks.annotationDefaultStyleChanged.emit(new Df(a,r)));}enableContinuousDrawing(t){const{annotationController:e}=this.context;e.interactiveConfig.enableContinuousDrawing=t;}enableMoveWithKeyboard(t){const{annotationController:e}=this.context;e.interactiveConfig.enableMoveWithKeyboard=t;}enableDeleteWithKeyboard(t){const{annotationController:e}=this.context;e.interactiveConfig.enableDeleteWithKeyboard=t;}enableMultipleSelectWidthCtrl(t){const{annotationController:e}=this.context;e.interactiveConfig.enableMultipleSelectWidthCtrl=t;}controlsStyle(t){if(!Os(t))return;const{annotationController:e}=this.context;e.setAnnotationInteractiveConfig({controlsStyle:t});}inkCreateDelay(t){const{annotationController:e}=this.context;e.interactiveConfig.inkCreateDelay=t;}showOnTopWhenSelected(t){const{annotationController:e}=this.context;e.interactiveConfig.showOnTopWhenSelected=t;}}function Dy(t,e){if(t===e)return {changed:!1};if(Array.isArray(e)){if(!Array.isArray(t)||t.length!==e.length)return {changed:!0,newData:e,oldData:t};for(let i=0;i<e.length;i++)if(t[i]!==e[i])return {changed:!0,newData:e,oldData:t};return {changed:!1}}if(e&&"object"==typeof e&&!(e instanceof Blob)){const i={},s={};let n=!1;const o=Object.keys(e),r=t&&"object"==typeof t&&!Array.isArray(t);for(let a=0;a<o.length;a++){const l=o[a],h=r?t[l]:void 0,c=e[l],d=Dy(h,c);d.changed&&(i[l]=void 0!==d.newData?d.newData:c,s[l]=void 0!==d.oldData?d.oldData:h,n=!0);}return n?{changed:!0,newData:i,oldData:s}:{changed:!1}}return {changed:!0,newData:e,oldData:t}}class Ry{constructor(t,e){i(this,"shape",void 0),i(this,"ctx",void 0),i(this,"page",void 0),i(this,"isHitStartCtrl",!1),i(this,"isHitEndCtrl",!1),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"oldStartTextPosition",void 0),i(this,"oldEndTextPosition",void 0),i(this,"oldStartCharRect",void 0),i(this,"oldEndCharRect",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"lines",void 0),i(this,"startPoint",void 0),i(this,"isPointerdown",void 0),i(this,"isEdited",!1),i(this,"isMatchText",!1),this.ctx=t,this.page=e;}setShape(t){this.shape=t;}isHitPoint(t){const e=this.canvasToMediaBox(t);return this.isHitStartCtrl=this.shape.isPointOnStartCtrl(e),this.isHitEndCtrl=this.shape.isPointOnEndCtrl(e),!this.isHitStartCtrl&&!this.isHitEndCtrl||this.isCtrlPointOoutOfCropBox()?this.shape.isPointOnBody(e)?(this.isCtrlPointOoutOfCropBox(),9):-1:10}isCtrlPointOoutOfCropBox(){return !1}isCtrlPointOoutOfCropBox1(){const t=this.ctx.context.core.pageService.getPage(this.page.uid);if(null==t||!t.isTextPage)return !0;let e=!1;const{bounds:i}=this.shape,{cropBox:s}=t;if(i.left>=s.left&&i.top>=s.top&&i.left+i.width>s.left+s.width&&i.top+i.height>s.top+s.height)return !1;if(this.shape.startCharRect){if(!gv({x:this.shape.startCharRect.left,y:this.shape.startCharRect.top},t.cropBox)){pv(this.shape.startCharRect,t.cropBox)||(e=!0);}}else e=!0;if(this.shape.endCharRect){if(!gv({x:this.shape.endCharRect.left,y:this.shape.endCharRect.top},t.cropBox)){pv(this.shape.startCharRect,t.cropBox)||(e=!0);}}else e=!0;return this.shape.isOutOfCropBox=e,e}startHandler(t){const e=this.ctx.context.core.annotationService.getAnnotationByUid(this.shape.id);if(e.isBlankTextAssist)return;const i=this.ctx.context.core.pageService.getPage(this.page.uid);if(null==i||!i.isTextPage)return;if(this.isCtrlPointOoutOfCropBox())return;const s=this.canvasToMediaBox(t);if(this.isHitStartCtrl=this.shape.isPointOnStartCtrl(s),this.isHitEndCtrl=this.shape.isPointOnEndCtrl(s),!this.isHitStartCtrl&&!this.isHitEndCtrl)return;const{annotationEditService:n}=this.ctx.context;if(n.isPointerType&&(n.needRenderMagnifier=!0,n.renderMagnifier(t)),this.shape.startTextPosition)this.oldStartCharRect={...this.shape.startCharRect},this.oldEndCharRect={...this.shape.endCharRect},this.oldStartTextPosition={...this.shape.startTextPosition},this.oldEndTextPosition={...this.shape.endTextPosition},this.startTextPosition={...this.shape.startTextPosition},this.endTextPosition={...this.shape.endTextPosition};else if(e.isMatchText){const t=this.ctx.context.calcTextStartPosition({x:this.shape.startCharRect.left+8,y:this.shape.startCharRect.top+8},this.page,!0),e=this.ctx.context.calcTextStartPosition({x:this.shape.endCharRect.left+8,y:this.shape.endCharRect.top+8},this.page,!0);this.oldStartCharRect={...this.startCharRect},this.oldEndCharRect={...this.endCharRect},this.oldStartTextPosition={...t},this.oldEndTextPosition={...e},this.startTextPosition={...t},this.endTextPosition={...e},this.shape.startTextPosition={...t},this.shape.endTextPosition={...e};}else {const t=this.ctx.matchText(e);if(!t)return;this.isMatchText=!0;const{startTextPosition:i,endTextPosition:s,startCharRect:n,endCharRect:o}=t;this.oldStartCharRect=n,this.oldEndCharRect=o,this.oldStartTextPosition={...i},this.oldEndTextPosition={...s},this.startTextPosition={...i},this.endTextPosition={...s},this.shape.startTextPosition={...i},this.shape.endTextPosition={...s};const r=this.ctx.context.core.annotationService.getAnnotationByUid(e.uid);r.startTextPosition||(r.startTextPosition={...i}),r.endTextPosition||(r.endTextPosition={...s});}this.startPoint=t,this.isPointerdown=!0;}moveHandler(t){if(!this.isPointerdown)return;const e=this.ctx.context.getActiveTab();if(null==e||!e.total)return;const{page:i}=this,s=this.ctx.context.core.pageService.getPage(i.uid);if(null!=s&&s.isTextPage&&(this.isHitStartCtrl||this.isHitEndCtrl)){if(null==s||!s.visibleLines)return;let n=null;if(this.isHitStartCtrl?(n=this.ctx.context.calcTextEndPosition(t,i,e,this.endTextPosition.mediaBoxPoint),this.startTextPosition=n):this.isHitEndCtrl&&(n=this.ctx.context.calcTextEndPosition(t,i,e,this.startTextPosition.mediaBoxPoint),this.endTextPosition=n),n){const{textPages:t,startCharRect:e,endCharRect:i,startTextPosition:s,endTextPosition:n}=this.ctx.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);this.isEdited=!0,this.startCharRect=e,this.endCharRect=i,this.shape.startCharRect=e,this.shape.endCharRect=i,this.shape.startTextPosition=s,this.shape.endTextPosition=n;const o=t[0].lines.map((t=>t.selectedRect));this.lines=o,this.shape.updateStyle({lines:o});}const{annotationEditService:o}=this.ctx.context;o.isPointerType&&(o.isRenderMagnifier=!0,o.magnifierPoint=t);}}endHandler(){if(this.isEdited){const t=this.shape.getAnnotationConfig(),e=this.isSameTextSelectedPosition(this.startTextPosition,this.oldStartTextPosition),i=this.isSameTextSelectedPosition(this.endTextPosition,this.oldEndTextPosition),s=this.isSameTextCharRect(t.startCharRect,this.oldStartCharRect),n=this.isSameTextCharRect(t.endCharRect,this.oldEndCharRect);if(!s||!n||!e||!i||this.isMatchText){const e=Am(this.lines);this.shape.style.borderWidth=e;const i={startCharRect:t.startCharRect,endCharRect:t.endCharRect,startTextPosition:t.startTextPosition,endTextPosition:t.endTextPosition,style:{lines:t.style.lines}};this.ctx.annotationController.hooks.emitModifyAnnotation(["resized"],[{shape:this.shape,changedOptions:i}]);}}this.isEdited=!1,this.isPointerdown=!1,this.isHitStartCtrl=!1,this.isHitEndCtrl=!1,this.isMatchText=!1,this.ctx.context.render(73);}canvasToMediaBox(t){const{page:e}=this,i=this.ctx.context.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);return {x:i.pointerX,y:i.pointerY}}isSameTextSelectedPosition(t,e){return t.pageUid===e.pageUid&&t.lineUid===e.lineUid&&t.charUid===e.charUid}isSameTextCharRect(t,e){return t.left===e.left&&t.top===e.top}}const Ey={arc:"annotationArc",circle:"annotationCircle",ellipse:"annotationEllipse",image:"annotationImage",ink:"annotationInk",rectangle:"annotationRect",line:"annotationLine",polyline:"annotationPolyline",polygon:"annotationPolygon",textTypewriter:"annotationFreeText",textBox:"annotationTextBox",stamp:"annotationStamp",textAssist:"annotationTextAssist",highlight:"annotationHighlight",underline:"annotationUnderline",strikeout:"annotationStrikeout",incomplete:"annotationIncomplete"},My={annotationArc:"arc",annotationCircle:"circle",annotationEllipse:"ellipse",annotationImage:"image",annotationInk:"ink",annotationRect:"rectangle",annotationLine:"line",annotationPolyline:"polyline",annotationPolygon:"polygon",annotationFreeText:"textTypewriter",annotationTextBox:"textBox",annotationStamp:"stamp",annotationTextAssist:"textAssist",annotationHighlight:"highlight",annotationUnderline:"underline",annotationStrikeout:"strikeout"};class Iy extends Qn{constructor(t){super(),i(this,"viewer",void 0),i(this,"annotationConfigService",void 0),i(this,"annotationController",void 0),i(this,"context",void 0),this.viewer=t,this.context=t.context,this.annotationConfigService=new ky(this),this.initAnnotationController(),this.listenViewerEventsForAnnotation();}isTextAssistType(t){return ["highlight","underline","strikeout"].includes(t)}initAnnotationController(){(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&((new wc).init(this.context.rendererService.docRenderer.canvas),this.annotationController=new ic(this.context.rendererService.getCanvasDom()),this.listenViewerNativeEventsForAnnotation(),this.annotationController.hooks.deleteAnnotation.on((t=>{const e=new Set(t.shapes.map((t=>t.uid)));this.context.core.annotationService.deleteAnnotations([...e]);}),this),this.annotationController.hooks.selectAnnotation.on((t=>{const e=kf.create(t.oldAnnotationsUids,t.newAnnotationUids);this.syncAnnotationLayerState(),this.viewer.hooks.selectedAnnotationsChanged.emit(e),t.emitSelected&&this.viewer.emit("selectedAnnotationsChanged",{newAnnotationUids:[...t.newAnnotationUids],oldAnnotationUids:[...t.oldAnnotationsUids]});}),this),this.annotationController.hooks.modifyAnnotation.on((t=>{const e=t.shapes.map((t=>{let e;if("annotationFreeText"===t.shape.config.type){const i=t.shape.getAnnotationConfig(),s=this.context.core.annotationService.getAnnotationByUid(t.shape.id);if(!s)return;const n=0===s.style.textContents.length?{x:i.style.x,y:i.style.y,width:i.style.width,...t.changedOptions.style}:{...t.changedOptions.style};e={annotationUid:t.shape.id,options:{transform:Ns(i.transform),style:n}};}else e={annotationUid:t.shape.id,options:t.changedOptions};return e}));this.context.core.annotationService.updateAnnotations(e,this.context.uid,t.actions);}),this),this.annotationController.hooks.addAnnotation.on((t=>{const e=this.context.getActiveTab();if(!e)return;const{annotationService:i}=this.context.core;t.shapes.forEach((t=>{const s=t.shape.getAnnotationConfig(),n=Jf(),o=["print"];t.shape instanceof Ch&&"freeTextWriter"===t.shape.textType&&o.push("noRotate","noResize"),(t.shape instanceof Rh||t.shape instanceof kh||t.shape instanceof Dh)&&o.push("noRotate");const r=i.createAnnotation(e.uid,{uid:t.uid,docUid:e.uid,pageUid:t.shape.pageUid,type:My[s.type],transform:Ns(s.transform),style:Ns(s.style),flags:o,comment:{annotationUid:t.uid,author:"",subject:"",contents:"",creationDate:n,modificationDate:n,markedStates:[],reviewStates:[],replies:[]},source:"user"});this.annotationController.updateLayer(t.uid,r.layer);}));}),this),this.annotationController.hooks.annotationModeChanged.on((t=>{"none"===t&&this.exitAnnotationMode();}),this),this.annotationController.hooks.beforeAnnotationEdit.on((t=>{this.viewer.hooks.beforeAnnotationEdit.emit(t);}),this),this.annotationController.hooks.afterAnnotationEdit.on((t=>{this.viewer.hooks.afterAnnotationEdit.emit(t);}),this),this.annotationController.hooks.beforeAnnotationDraw.on((t=>{this.viewer.hooks.beforeAnnotationDraw.emit(t);}),this),this.annotationController.hooks.afterAnnotationDraw.on((t=>{this.viewer.hooks.afterAnnotationDraw.emit(t);}),this),this.annotationController.hooks.renderAnnotation.on((()=>{var t;null===(t=this.context)||void 0===t||t.render(71);}),this),this.annotationController.hooks.selectAnnotationTextChars.on((t=>{this.viewer.hooks.annotationTextCharsSelected.emit(t);}),this),this.annotationController.hooks.annotationTextContentUpdated.on((t=>{this.viewer.hooks.annotationTextContentUpdated.emit(t);}),this),this.annotationController.hooks.annotationTextPositionUpdated.on((t=>{const e=t.id,i=this.context.core.annotationService.getAnnotationByUid(e),{position:s}=t.context.getTransform();i.style.x=s.x,i.style.y=s.y,i.transform.position={...s};})));}exitAnnotationMode(){"annotation"===this.viewer.getViewerConfig().toolMode&&this.viewer.updateViewerConfig({toolMode:"pan"});}listenViewerNativeEventsForAnnotation(){const{eventDom:t}=this.context;eo(t,$s()?"click":"pointerup",this).on((t=>{t.preventDefault(),this.annotationController.clickHandler(t);})),eo(t,"dblclick",this).on((t=>{this.annotationController.dblClickHandler(t);}));}listenViewerEventsForAnnotation(){const{context:t,context:{hooks:e,tabService:i}}=this;(t.isDefaultViewer||t.isThumbnailViewer)&&(e.pageExistenceChanged.on((t=>{0===t.pageCount&&(this.annotationController.container=null,this.annotationController.containerId=null,this.context.annotationEditService.containerPage=null,this.annotationController.clearShapeArrMap());}),this),e.toolModeChanged.on((e=>{const{annotationMode:i}=t.viewerConfig;if("annotation"!==e.newToolMode)this.annotationController.setAnnotationMode("none"),"crop"!==e.newToolMode&&"textSelection"!==e.newToolMode||this.selectAnnotations([]);else {let t="draw";"select"===i?t="select":"erase"===i&&(t="erase"),this.annotationController.setAnnotationMode(t);}}),this),e.annotationModeChanged.on((e=>{const{toolMode:i}=t.viewerConfig;if("select"===e.newAnnotationMode||"erase"===e.newAnnotationMode){const t=e.newAnnotationMode;"annotation"===i&&this.annotationController.setAnnotationMode(t);}else {const t=Ey[e.newAnnotationMode];this.annotationController.drawType=t,"annotation"===i&&this.annotationController.setAnnotationMode("draw");}}),this),e.addPagesToDoc.on((t=>{i.getTab(t.docUid)&&this.addAnnotationByPageUids(t.pageUids);}),this),e.openDocument.on((t=>{i.getTab(t.uid)&&(this.selectAnnotations([]),this.addAnnotationByPageUids(t.pages));}),this),e.closeDocument.on((t=>{t.pages.forEach((t=>{const e=this.context.core.pageService.getPage(t);this.annotationController.deleteShape(e.annotations,!1,!1);})),this.annotationController.clearShapeArrMap();}),this),e.deletePages.on((t=>{t.pageUids.forEach((t=>{const e=this.context.core.pageService.getPage(t);this.annotationController.deleteShape(e.annotations,!1,!1),this.annotationController.deleteShapeArrMap(t);}));}),this),e.syncDocument.on((t=>{i.getTab(t.uid)&&(this.selectAnnotations([]),this.addAnnotationByPageUids(t.pages));}),this),e.afterRender.on((e=>{if(null==e||!e.total)return;const i=t.annotationEditService.containerPage;if(!i)return;if(!e.getPageByUid(i.uid))return;let{x:s,y:n}=i.cropBox.getPosition(),{width:o,height:r}=i.cropBox;const a=(i.rotation%360+360)%360/90;if(1===a?s-=r:2===a?(s-=o,n-=r):3===a&&(n-=o),1===a||3===a){const t=o;o=r,r=t;}this.annotationController.eventService.setEventArea({left:s,top:n,width:o,height:r});}),this));}disableTextEditMode(){const{eventService:t}=this.annotationController;null!=t&&t.activatedShape&&(null==t?void 0:t.activatedShape)instanceof Ch&&null!=t&&t.activatedShape.isEditMode&&(null==t||t.activatedShape.textEditEventHandler.disableEditMode(),this.context.render(72));}addAnnotationByPageUids(t){t.forEach((t=>{const e=this.context.core.pageService.getPage(t);if(e.annotations.forEach((t=>{const e=this.context.core.annotationService.annotationApp.getAnnotationByUid(t);this.addAnnotationByAnnotationData(e);})),0===e.annotations.length){const t=this.context.tabService.getTab(e.doc.uid);if(!t)return;const i=t.getPageByUid(e.uid);if(!i)return;this.annotationController.setAnnotationContainer(e.uid,i.mediaBox);}}));}addAnnotationByAnnotationData(t){if("unknown"===t.type)return !0;const e=this.context.core.pageService.getPage(t.pageUid);if(!e)return !1;const i=this.context.tabService.getTab(e.doc.uid);if(!i)return !1;const s=i.getPageByUid(t.pageUid);if(!s)return !1;let n=t.getConfig();this.annotationController.setAnnotationContainer(t.pageUid,s.mediaBox);const o=this.isTextAssistType(t.type),r=this.annotationController.addShape(Ey[t.type],{id:t.uid,style:{...n.style,zIndex:t.layer},transform:n.transform},!1,o?new Ry(this,s):void 0);o&&(r.startCharRect=t.startCharRect,r.endCharRect=t.endCharRect),n=t.getConfig();const a={enableControl:!n.flags.includes("readOnly")&&!n.flags.includes("flattened"),isVisible:!n.flags.includes("noView"),enableEdit:!n.flags.includes("noResize"),enableRotate:!n.flags.includes("noRotate"),enableMove:!n.flags.includes("noMove")};if(r instanceof Ch&&"freeTextWriter"===r.textType){a.enableEdit=!1,a.enableRotate=!1;const e=r.getAnnotationConfig();t.style.width=e.style.width;}if(r.context.isInGroup&&(a.enableRotate=!1),this.annotationController.setAnnotationFlags(t.uid,a,!1),r instanceof Vh&&"base"===r.stampType||r instanceof xh){const e=r.getAnnotationConfig();t.transform.position=e.transform.position,t.transform.scale=e.transform.scale,t.style=e.style;}return this.syncAnnotationLayerState(),!0}updateAnnotations(t,e,i,s){if(e===this.context.uid)return !0;const n=t.reduce(((t,e)=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(e);if(i){const s=this.context.core.pageService.getPage(i.pageUid);if(s){if(this.context.tabService.getTab(s.doc.uid)){const s=i.getConfig();t.push({annotationUid:e,config:s}),this.viewer.context.core.annotationService.annotationApp.restoreLayer(e,i.layer);}}}return t}),[]);return n.length===t.length&&(n.forEach(((t,e)=>{var n,o;let{annotationUid:r,config:a}=t;const l=this.annotationController.getShape(r),h={enableControl:!a.flags.includes("readOnly")&&!a.flags.includes("flattened"),isVisible:!a.flags.includes("noView"),enableEdit:!a.flags.includes("noResize"),enableRotate:!a.flags.includes("noRotate"),enableMove:!a.flags.includes("noMove")};if(l&&l.context.isGrouped&&(l.context.tempData.enableRotate=h.enableRotate,h.enableRotate=!1),this.annotationController.setAnnotationFlags(r,h,!1),i||this.annotationController.updateShape(r,{id:r,style:s[e].to.changed.style||{},transform:a.transform}),!l)return;const c=this.context.core.annotationService.annotationApp.getAnnotationByUid(r),d=l.getAnnotationConfig();if(this.isTextAssistType(c.type)){const t=s[e].to.changed;t.startCharRect&&(l.startCharRect=t.startCharRect),t.endCharRect&&(l.endCharRect=t.endCharRect),t.startTextPosition&&(l.startTextPosition=t.startTextPosition),t.endTextPosition&&(l.endTextPosition=t.endTextPosition);}null!=d&&null!==(n=d.transform)&&void 0!==n&&n.position&&(c.transform.position=d.transform.position),null!=d&&null!==(o=d.transform)&&void 0!==o&&o.scale&&(c.transform.scale=d.transform.scale),l instanceof Vh&&"stamp"===l.renderType&&(c.style.stampConfig=d.style.stampConfig);})),!0)}updateAnnotationPage(t,e){const i=this.context.core.annotationService.getAnnotationByUid(t);if(!i)return;const s=this.context.core.pageService.getPage(i.pageUid);if(!s)return;const n=this.context.tabService.getTab(s.doc.uid);if(!n)return;const o=n.getPageByUid(e);o&&(this.annotationController.moveShape([t],e,o.mediaBox),this.syncAnnotationLayerState());}updateLayer(t){const e=t.reduce(((t,e)=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(e);if(i){const e=this.context.core.pageService.getPage(i.pageUid);if(e){this.context.tabService.getTab(e.doc.uid)&&t.push(i);}}return t}),[]);return e.length===t.length&&(e.forEach((t=>{this.annotationController.updateLayer(t.uid,t.layer);})),this.syncAnnotationLayerState(),!0)}syncAnnotationLayerState(){let t={back:!1,front:!1,forward:!1,backward:!1};const e=this.annotationController.getSelectedShapeUids();return 1===e.length&&(t=this.context.core.annotationService.getAnnotationLayerState(e[0])),this.viewer.hooks.annotationLayerStateChanged.emit(Tf.create(t)),t}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.annotationController.deleteShape(t,!1,e),this.syncAnnotationLayerState();}selectAnnotations(t){return this.annotationController.selectShape(t)}getSelectedAnnotations(){const t=this.annotationController.getSelectedShapeUids();if(!t.length)return [];const e=[];return t.forEach((t=>{const i=this.context.core.annotationService.annotationApp.getAnnotationByUid(t);i&&e.push(i);})),e}matchText(t){var e;const i=this.context.core.pageService.getPage(t.pageUid);if(!i)return null;const{lines:s}=t.style;if(!i.isTextPage||null===(e=i.visibleLines)||void 0===e||!e.length||null==s||!s.length)return t.isMatchText=!0,t.isBlankTextAssist=!0,null;let n,o,r=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,l=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;if(s.forEach((t=>{i.visibleLines.forEach(((e,i)=>{if(By(e,t)){if(l>i){l=i,r=Number.MAX_SAFE_INTEGER;const s=e.chars.findIndex((e=>By(e.charBox,t)));r>s&&(r=s,n=e.chars[s].charBox);}if(h<i){h=i,a=Number.MIN_SAFE_INTEGER;let s=-1;for(let i=e.chars.length-1;i>=0;i--)if(By(e.chars[i].charBox,t)){s=i;break}s>a&&(a=s,o=e.chars[s].charBox);}}}));})),!n)return t.isMatchText=!0,t.isBlankTextAssist=!0,null;return {startTextPosition:{lineUid:i.visibleLines[l].uid,charUid:i.visibleLines[l].chars[r].uid,pageUid:i.uid,mediaBoxPoint:{x:n.left+n.width/2,y:n.top+n.height/2}},endTextPosition:{lineUid:i.visibleLines[h].uid,charUid:i.visibleLines[h].chars[a].uid,pageUid:i.uid,mediaBoxPoint:{x:o.left+o.width/2,y:o.top+o.height/2}},startCharRect:n,endCharRect:o}}}function By(t,e){return t.left<e.left+e.width-.1&&t.left+t.width-.1>e.left&&t.top<e.top+e.height-.1&&t.top+t.height-.1>e.top}const Uy={highlight:"highlight",underline:"underline",strikeout:"strikeout"};class Ly extends Qn{constructor(t){super(),i(this,"containerPage",void 0),i(this,"context",void 0),i(this,"isEditTextAssist",!1),i(this,"isStartDrawTextAssist",!1),i(this,"textAssistTimer",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionThreshold",1),i(this,"startPoint",void 0),i(this,"isMovedForTextSelection",void 0),i(this,"isPointerdown",!1),i(this,"opPageUid",null),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"isEditTextAssistStart",!1),i(this,"isEditTextAssistEnd",!1),i(this,"canvas",void 0),i(this,"isPointerType",!1),i(this,"isRenderMagnifier",!1),i(this,"magnifierPoint",null),i(this,"needRenderMagnifier",!1),i(this,"isMouseOverText",!1),this.context=t,this.canvas=this.context.context.rendererService.getCanvasDom(),this.context.context.hooks.afterRender.on((()=>{this.needRenderMagnifier&&this.renderMagnifier(this.magnifierPoint);}),this),(this.context.context.isDefaultViewer||this.context.context.isThumbnailViewer)&&this.context.context.core.editService.onAfterCropPages.on((t=>{this.deactivateAnnotation();}),this);}renderMagnifier(t){this.magnifierPoint=t,this.context.context.viewerConfig.enableTextMagnifier&&this.context.context.magnifierService.render("text",this.canvas,this.magnifierPoint);}isHitAnnotation(t){return this.context.annotationController.isHitShape(t)}isTextAssistMode(){return ["highlight","underline","strikeout"].includes(this.context.context.viewerConfig.annotationMode)}startHandler(t,e){if(this.isPointerdown)return;const{context:i}=this.context,[s]=i.toCanvas(t),{page:n}=i.getPointerOverPageInfo(s.pageX,s.pageY).pageInfo;if(!n)return;const o=!km(t);this.isPointerType=o,this.isPointerdown=!0,this.startPoint={x:s.pageX,y:s.pageY};const r=this.context.context.getActiveTab(),{isHit:a,shape:l,isHitSelected:h}=this.isHitAnnotation(t);if("annotation"===this.context.context.viewerConfig.toolMode&&this.isTextAssistMode()){if(!this.context.context.core.pageService.getPage(n.uid).isTextPage)return;const e=this.context.context.getPointerOverMediaBoxInfo(n.mediaBox,s.pageX,s.pageY,n.rotation),{start:i,end:a}=this.isHitTextAssistCtrlPoint(n,{x:e.pointerX,y:e.pointerY});if(i||a)this.isEditTextAssistStart=i,this.isEditTextAssistEnd=a,o&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY},this.context.context.render(58));else if(km(t)){if(!this.isStartDrawTextAssist){const t=this.context.context.calcTextStartPosition({x:s.pageX,y:s.pageY},this.containerPage);t&&(this.startTextPosition=t,this.isStartDrawTextAssist=!0,this.context.context.hooks.beforeTextSelected.emit());}}else o&&(this.textAssistTimer=setTimeout((()=>{clearTimeout(this.textAssistTimer),this.textAssistTimer=null;const[e]=this.context.context.toCanvas(t),{page:i}=this.context.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo,n=this.context.context.calcTextStartPosition({x:e.pageX,y:e.pageY},i);if(n){this.isStartDrawTextAssist=!0,this.startTextPosition=n;const{textPages:t,startCharRect:e,endCharRect:i,startTextPosition:o,endTextPosition:a}=this.context.context.textSelectionService.calcSelectedText(this.startTextPosition,n);r.setTextSelection(t,e,i,o,a),this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY},this.context.context.render(58),this.context.context.hooks.beforeTextSelected.emit();}}),this.context.context.viewerConfig.enterTextModeTimeMobile));}else {if(a&&this.context.isTextAssistType(l.textAssistType))return this.context.annotationController.startHandler(t,e),void this.loadTextForAnnotation(l);this.context.annotationController.startHandler(t,e);}}cursorHandler(t){const e=this.context.annotationController.eventService,{cursorService:i}=this.context.context;if(e.isStartDraw)return void i.lockCursor();if(e.isStartEdit)return void i.lockCursor();const s=this.context.annotationController.cursorHandler(t);this.context.context.applyCursorState(s);}moveHandler(t,e){const{context:i}=this.context,[s]=i.toCanvas(t),{page:n}=i.getPointerOverPageInfo(s.pageX,s.pageY).pageInfo;if("annotation"===this.context.context.viewerConfig.toolMode&&this.isTextAssistMode()){if(this.opPageUid=null==n?void 0:n.uid,this.isPointerdown){an(this.startPoint,{x:s.pageX,y:s.pageY})>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0);}if(n){const e=i.getActiveTab(),o=this.context.context.core.pageService.getPage(n.uid);if(this.isStartDrawTextAssist){if(null==o||!o.isTextPage)return;i.cursorService.lockCursor();const r=this.context.context.calcTextEndPosition({x:s.pageX,y:s.pageY},n,e,this.startTextPosition.mediaBoxPoint);if(r){this.endTextPosition=r;const{textPages:n,startCharRect:o,endCharRect:a,startTextPosition:l,endTextPosition:h}=i.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);this.startCharRect=o,this.endCharRect=a,e.setTextSelection(n,o,a,l,h);!km(t)&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY}),i.render(59);}}else if(o.visibleLines&&null!=o&&o.isTextPage){const t=this.context.context.getPointerOverMediaBoxInfo(n.mediaBox,s.pageX,s.pageY,n.rotation),e={x:t.pointerX,y:t.pointerY},i=o.getHoveredTextLineIndex(e);this.isMouseOverText=-1!==i;}}}else this.isRenderMagnifier&&i.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY}),this.context.annotationController.moveHandler(t,!n);}endHandler(t){const{context:e}=this.context;if(this.textAssistTimer&&(clearTimeout(this.textAssistTimer),this.textAssistTimer=null),this.needRenderMagnifier&&(this.context.context.magnifierService.hide(),this.needRenderMagnifier=!1),this.isStartDrawTextAssist){const t=this.applyTextSelectionToAnnotation(Uy[e.viewerConfig.annotationMode]);if(t&&t.length){const i=t[t.length-1];e.clearSelectedTexts(),this.context.context.hooks.afterTextSelected.emit(),this.context.annotationController.interactiveConfig.enableContinuousDrawing||(this.context.annotationController.setAnnotationMode("none",!0),this.activateAnnotation(i,!1),i.textAssistEventHandler.enableEditMode()),this.context.context.render(60);}}else this.isMovedForTextSelection||e.clearSelectedTexts();this.context.context.cursorService.unlockCursor(),this.context.annotationController.endHandler(t),this.isStartDrawTextAssist=!1,this.isPointerdown=!1,this.isMovedForTextSelection=!1,this.opPageUid=null,this.isPointerType=!1,this.isRenderMagnifier=!1,this.magnifierPoint=null,this.magnifierPoint=null,this.isMouseOverText=!1;}applyTextSelectionToAnnotation(t){const e=this.context.context.textSelectionService.getTextSelectionLines();if(e){return e.map(((i,s)=>{const n=this.context.context.getActiveTab();let{startCharRect:o,startTextPosition:r,endCharRect:a,endTextPosition:l}=n;if(s>0){const t=i.lines[0].chars[0];o=t.charBox,r={lineUid:t.oriLineUid,charUid:t.uid,pageUid:i.pageUid,mediaBoxPoint:{x:o.left,y:o.top}};}if(s<e.length-1){const t=i.lines[i.lines.length-1],e=t.chars[t.chars.length-1];a={...e.charBox},l={lineUid:e.oriLineUid,charUid:e.uid,pageUid:i.pageUid,mediaBoxPoint:{x:a.left,y:a.top}};}const h=this.createTextAssist(i,t,{startCharRect:o,endCharRect:a,startTextPosition:r,endTextPosition:l});h.startCharRect=o,h.endCharRect=a,h.startTextPosition=r,h.endTextPosition=l;const c=this.context.annotationController.getShape(h.uid);return c&&(c.startCharRect=o,c.endCharRect=a,c.startTextPosition=r,c.endTextPosition=l),c}))}return null}activateAnnotation(t,e){this.context.annotationController.eventService.activateShape(t,e),this.loadTextForAnnotation(t);}loadTextForAnnotation(t){if(t.context.isActive&&this.context.isTextAssistType(t.textAssistType)){const{core:e}=this.context.context,i=e.annotationService.getAnnotationByUid(t.id);i&&!i.isPageTextLoaded&&e.textLoadService.loadText([i.pageUid]).then((()=>{i.isPageTextLoaded=!0;}));}}deactivateAnnotation(){this.context.annotationController.eventService.inactivateShape(!0),this.context.annotationController.eventService.defaultGroup.clear();}hasActiveAnnotation(){return this.context.annotationController.getSelectedShapeUids().length>0}keydownHandler(t){const e=this.context.context.getActiveTab();this.context.annotationController.keyDownHandler(t,e.context.zoom);}keyupHandler(t){this.context.annotationController.keyUpHandler(t);}setAnnotationContainer(t){this.containerPage=t,this.context.annotationController.setAnnotationContainer(t.uid,t.mediaBox);}setAnnotationInteractionArea(t){this.context.annotationController.eventService.setEventArea({left:t.left,top:t.top,width:t.width,height:t.height});}copyAnnotations(){const t=this.context.annotationController.getSelectedShapeUids();0===t.length||this.context.annotationController.isInTextEditMode()?this.context.viewer.clearAnnotationClipboard():this.context.viewer.copyAnnotations(t);}cutAnnotations(){const t=this.context.annotationController.getSelectedShapeUids();0===t.length||this.context.annotationController.isInTextEditMode()?this.context.viewer.clearAnnotationClipboard():this.context.viewer.cutAnnotations(t);}pasteAnnotations(){this.context.annotationController.isInTextEditMode()||this.context.viewer.pasteAnnotations();}initTextAssist(){}createTextAssist(t,e,i){const{context:s}=this.context,n=s.getActiveTab(),o=qs(),r=Jf(),{defaultStyleConfig:a}=this.context.viewer.getAnnotationConfig(),{opacity:l}=a[e];let h=a.highlight.background,c=1;"underline"===e?h=a.underline.borderColor:"strikeout"===e&&(h=a.strikeout.borderColor);const d=t.lines.map((t=>{let{selectedRect:e}=t;return {...e}}));c=Am(d);const u=s.core.annotationService.createAnnotation(n.uid,{uid:o,docUid:n.uid,pageUid:t.pageUid,type:e,style:{opacity:l,borderColor:h,background:h,borderWidth:c,lines:d},flags:["print","noMove","noRotate"],comment:{annotationUid:o,author:"",subject:"",contents:"",creationDate:r,modificationDate:r,markedStates:[],reviewStates:[],replies:[]},transform:{},source:"user",...i});return Object.assign(u.customData,{isDDVTextAssist:!0}),this.context.annotationController.updateLayer(o,u.layer),u}updateTextAssist(t,e){}isHitTextAssistCtrlPoint(t,e){const{core:i}=this.context.context,s={start:!1,end:!1,annotationUid:""};return t.mediaBox.childNodes.some((t=>{if(this.context.isTextAssistType(t.textAssistType)){if(!t.context.isActive)return !1;const n=i.annotationService.getAnnotationByUid(t.id),o=t.getScale().x,r=this.context.context.viewerConfig.textSelectionStyle.ctrlBorderRadius/o,{startCharRect:a,endCharRect:l}=n;if(a){if(an({x:a.left+a.width/2,y:a.top-r},e)<=r)return s.start=!0,s.annotationUid=t.id,!0}if(l){if(an({x:l.left+l.width/2,y:l.top+l.height+r},e)<=r)return s.end=!0,s.annotationUid=t.id,!0}}return !1})),s}dispose(){super.dispose(),this.containerPage=null;}}class Oy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="createAnnotation",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{action:t}=this,{annotationApp:e}=this.core.annotationService,{annotationConfig:i}=this.action;return !!e.createAnnotations([{docUid:t.docUid,uid:i.uid,pageUid:t.pageUid,type:i.type,style:i.style,transform:i.transform,flags:i.flags,comment:i.comment,layer:i.layer,flattened:i.flattened,source:i.source,oriIndex:i.oriIndex,parsedOriIndex:i.parsedOriIndex,startCharRect:i.startCharRect,endCharRect:i.endCharRect}])}undo(){this.core.annotationService.annotationApp.deleteAnnotations([this.action.annotationConfig.uid]);}}class Ny extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="deleteAnnotation",e.commandService.onBeforeRefreshCommands.on((e=>{t.docUid===e.docUid&&(t.deleteConfigs.slice().forEach((i=>{if(e.pageUids.includes(i.pageUid)){const e=t.deleteConfigs.findIndex((t=>t.pageUid===i.pageUid));t.deleteConfigs.splice(e,1);}})),this.isValid=t.deleteConfigs.length>0);}),this);}execute(){const{action:t}=this,e=t.deleteConfigs.map((t=>t.uid));return this.core.annotationService.annotationApp.deleteAnnotations(e),!0}undo(){const{annotationApp:t}=this.core.annotationService,e=this.action.deleteConfigs.map((t=>({docUid:this.action.docUid,uid:t.uid,type:t.type,pageUid:t.pageUid,style:t.style,transform:t.transform,flags:t.flags,comment:t.comment,layer:t.layer,oriIndex:t.oriIndex,modified:t.modified,flattened:t.flattened,parsedOriIndex:t.parsedOriIndex,source:t.source,startCharRect:t.startCharRect,endCharRect:t.endCharRect})));t.createAnnotations(e);}}class _y extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="bringAnnotationToFront",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.bringToFront(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Wy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="bringAnnotationForward",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.bringForward(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Fy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="sendAnnotationBackward",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.sendBackward(this.action.annotationUid)}undo(){this.core.annotationService.annotationApp.bringForward(this.action.annotationUid);}}class Hy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"oldLayer",void 0),i(this,"newLayer",void 0),this.action=t,this.core=e,this.type="sendAnnotationToBack",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{annotationApp:t}=this.core.annotationService,{annotationUid:e}=this.action,i=t.getAnnotationByUid(e);return this.oldLayer||(this.oldLayer=i.layer),this.newLayer?t.restoreLayer(e,this.newLayer):(t.sendToBack(e),this.newLayer=i.layer),!0}undo(){this.core.annotationService.annotationApp.restoreLayer(this.action.annotationUid,this.oldLayer);}}class Vy extends Dm{constructor(t,e,s){super(),i(this,"action",void 0),i(this,"core",void 0),i(this,"updatedBy",void 0),this.action=t,this.core=e,this.updatedBy=s,this.type="updateAnnotation",e.commandService.onBeforeRefreshCommands.on((e=>{if(t.docUid!==e.docUid)return;const{pageUid:i}=t;e.pageUids.includes(i)&&(this.isValid=!1);}),this);}execute(){return this.update(!0),this.updatedBy=null,!0}undo(){this.update(!1);}update(t){const{annotationApp:e}=this.core.annotationService,i=this.action.updateDetails.map((e=>({annotationUid:e.annotationUid,from:Ns(t?e.from:e.to),to:Ns(t?e.to:e.from)})));e.updateAnnotation({updateDetails:i,updatedBy:this.updatedBy,updateActions:[...this.action.updateActions]});}}class zy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="switchAnnotationPage",e.commandService.onBeforeRefreshCommands.on((e=>{t.docUid===e.docUid&&t.moveConfigs.slice().every((t=>((e.pageUids.includes(t.from.pageUid)||e.pageUids.includes(t.to.pageUid))&&(this.isValid=!1),this.isValid)));}),this);}execute(){const{annotationApp:t}=this.core.annotationService;return this.action.moveConfigs.forEach((e=>{if(_s(e.to.layer)){const i=t.annotationPageRepo.findPageByUid(e.to.pageUid).createTop();e.to.layer=i;}t.switchAnnotationPage(e.annotationUid,{...e.to});})),!0}undo(){const{annotationApp:t}=this.core.annotationService;this.action.moveConfigs.forEach((e=>{t.switchAnnotationPage(e.annotationUid,{...e.from});}));}}class $y extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="deleteReplyMarkedState",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.deleteReplyMarkedState(this.action.replyUid)}undo(){this.core.annotationService.annotationApp.addReplyMarkedState({replyUid:this.action.replyUid,...this.action.config,state:this.action.config.state.state});}}class jy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="addReplyMarkedState",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.addReplyMarkedState({replyUid:this.action.replyUid,...this.action.config})}undo(){this.core.annotationService.annotationApp.deleteReplyMarkedState(this.action.replyUid);}}class Xy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="deleteReplyReviewState",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.deleteReplyReviewState(this.action.replyUid)}undo(){this.core.annotationService.annotationApp.addReplyReviewState({replyUid:this.action.replyUid,...this.action.config,state:this.action.config.state.state});}}class Gy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="addReplyReviewState",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.addReplyReviewState({replyUid:this.action.replyUid,...this.action.config})}undo(){this.core.annotationService.annotationApp.deleteReplyReviewState(this.action.replyUid);}}class Yy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="addReply",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){const{replyConfig:t}=this.action,{annotationApp:e}=this.core.annotationService;return !!e.addReply({annotationUid:t.annotationUid,author:t.author,subject:t.subject,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modificationDate})}undo(){this.core.annotationService.annotationApp.deleteReply(this.action.replyConfig.uid);}}class qy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="deleteReply",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.core.annotationService.annotationApp.deleteReply(this.action.replyConfig.uid)}undo(){const{replyConfig:t}=this.action,{annotationApp:e}=this.core.annotationService;e.addReply({annotationUid:t.annotationUid,author:t.author,subject:t.subject,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modificationDate});}}class Jy extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="updateReply",this.core.commandService.onBeforeRefreshCommands.on((t=>{t.pageUids.includes(this.action.pageUid)&&(this.isValid=!1);}),this);}execute(){return this.update("do")}undo(){this.update("undo");}update(t){const e="do"===t?this.action.updateDetail.to:this.action.updateDetail.from;return this.core.annotationService.annotationApp.updateReply({uid:e.uid,annotationUid:e.annotationUid,author:e.author,contents:e.contents,creationDate:e.creationDate,modificationDate:e.modificationDate})}}class Zy extends Qn{constructor(t){super(),i(this,"core",void 0),i(this,"annotationApp",void 0),i(this,"hooks",void 0),i(this,"enableEmitLayerChanged",!0),i(this,"pasteConfig",{pasteComment:!1,pasteReply:!0,updateDate:!0}),i(this,"clipboard",[]),i(this,"currentClipboard",[]),i(this,"currentPastePageUid",null),i(this,"flattenedAnnotationUidsMap",new Map),this.core=t,this.annotationApp=new Ty,this.hooks=this.annotationApp.hooks,this.bindAnnotationFlattenEvent();}bindAnnotationFlattenEvent(){this.hooks.annotationCreated.on((t=>{const{flattenedAnnotationUidsMap:e}=this;t.annotations.forEach((t=>{if(t.flattened){const{pageUid:i}=t;e.has(i)?e.get(i).push(t.uid):e.set(i,[t.uid]);}}));}),this),this.hooks.annotationDeleted.on((t=>{t.annotations.forEach((t=>{if(t.flattened){const e=this.flattenedAnnotationUidsMap.get(t.pageUid),i=e.indexOf(t.uid);-1!==i&&e.splice(i,1);}}));}),this),this.hooks.annotationUpdated.on((t=>{t.updateActions.includes("flattenedChanged")&&t.updateDetails.forEach((t=>{let{annotationUid:e}=t;const i=this.getAnnotationByUid(e),s=this.flattenedAnnotationUidsMap.get(i.pageUid);i.flattened?s?s.includes(e)||s.push(e):this.flattenedAnnotationUidsMap.set(i.pageUid,[e]):s&&s.includes(e)&&s.splice(s.indexOf(e),1);}));}),this);}reset(){this.annotationApp.reset();}getAnnotationByUid(t){return this.annotationApp.getAnnotationByUid(t)}deleteAnnotationPages(t){const e=t.reduce(((t,e)=>{const i=this.core.pageService.getPage(e);return i&&t.push(...i.annotations),t}),[]);this.deleteAnnotations(e,!1),this.annotationApp.annotationPageRepo.deletePagesByUids(t);}createAnnotationsByParsedPages(t,e){const i=Jf();return e.reduce(((e,s)=>{var n;this.annotationApp.createAnnotationPage(s.pageUid);const o=null===(n=s.annotations)||void 0===n?void 0:n.reduce(((e,n)=>{var o,r,a,l,h;tx(n);const c={uid:n.uid,docUid:t,pageUid:s.pageUid,type:n.type,style:n.style,transform:n.transform,flags:n.flags,comment:Qy(n.comment),creationDate:null!==(o=null===(r=n.comment)||void 0===r?void 0:r.creationDate)&&void 0!==o?o:i,modificationDate:null!==(a=null===(l=n.comment)||void 0===l?void 0:l.modifiedDate)&&void 0!==a?a:i,oriIndex:null===(h=n.raw)||void 0===h?void 0:h.oriIndex,parsedOriIndex:n.parsedOriIndex,customData:{...n.customData||{}},source:"file"};return e.push(c),e}),[]);return null!=o&&o.length?(this.annotationApp.createAnnotations(o),e.push(o.map((t=>t.uid)))):e.push([]),e}),[])}createAnnotation(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(tx(e),i){const i=new Oy({actionUid:qs(),type:"createAnnotation",docUid:t,pageUid:e.pageUid,annotationConfig:{uid:e.uid,type:e.type,style:e.style,transform:e.transform,flags:e.flags,comment:e.comment,layer:e.layer,modified:e.modified,oriIndex:e.oriIndex,flattened:e.flattened,source:e.source,parsedOriIndex:e.parsedOriIndex,startCharRect:e.startCharRect,endCharRect:e.endCharRect}},this.core);this.core.commandService.execute(i,t);}else this.annotationApp.createAnnotations([e]);return this.annotationApp.getAnnotationByUid(e.uid)}deleteAnnotations(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{pageService:i,commandService:s}=this.core,n=t.reduce(((t,e)=>{const s=this.annotationApp.getAnnotationByUid(e);if(s){const e=i.getPage(s.pageUid),n=t.get(e.doc.uid)||{uid:e.doc.uid,annotationConfigs:[]};t.set(n.uid,n);const o=s.getConfig();o.layer=s.layer,o.flattened=s.flattened,null!=o&&o.flattened&&!o.flags.includes("flattened")&&o.flags.push("flattened"),n.annotationConfigs.push(o);}return t}),new Map);if(e)for(const[t,e]of n){const i=e.annotationConfigs.map((t=>({uid:t.uid,type:t.type,pageUid:t.pageUid,style:t.style,transform:t.transform,flags:t.flags,comment:t.comment,layer:t.layer,oriIndex:t.oriIndex,parsedOriIndex:t.parsedOriIndex,modified:t.modified,flattened:t.flattened,source:t.source,startCharRect:t.startCharRect,endCharRect:t.endCharRect}))),n=new Ny({actionUid:qs(),type:"deleteAnnotation",docUid:t,deleteConfigs:i},this.core);s.execute(n,e.uid);}else this.annotationApp.deleteAnnotations(t,!1);}updateAnnotations(t,e,i,s){let n,o;const r=t.reduce(((t,e)=>{const{annotationUid:i}=e,s=this.annotationApp.getAnnotationByUid(i);var r,a,l;s&&(n=s.pageUid,o=s.docUid,null==s||!s.flattened||null==e||null===(r=e.options)||void 0===r||!r.flags||null!=e&&null!==(a=e.options)&&void 0!==a&&null!==(a=a.flags)&&void 0!==a&&a.includes("flattened")||!1===(null==e||null===(l=e.options)||void 0===l?void 0:l.flattened)||e.options.flags.push("flattened"),t.push({annotation:s,options:e.options}));return t}),[]);if(null==r||!r.length||r.length!==t.length)return;const a=Jf(),l=r.map((t=>{let{annotation:e,options:i}=t;i.comment||(i.comment={}),i.comment.modificationDate=a,i.modified=!s||e.modified;const n=e.getConfig(),o=Nn(i,e.getConfig()),{newChanged:r,oldChanged:l}=ex(i,n);return {annotationUid:e.uid,from:{all:n,changed:l},to:{all:o,changed:r}}})),h=new Vy({actionUid:qs(),type:"updateAnnotation",docUid:o,pageUid:n,updateDetails:l,updateActions:i||[]},this.core,e);this.core.commandService.execute(h,o);}switchAnnotationPage(t){const e=t.map((t=>({annotation:this.annotationApp.getAnnotationByUid(t.annotationUid),...t}))),i=this.core.pageService.getPage(e[0].annotation.pageUid);if(!i)return;const s=e.map((t=>{let{annotationUid:e,annotation:i,pageUid:s,x:n,y:o}=t;return {annotationUid:e,from:{pageUid:i.pageUid,x:i.style.x,y:i.style.y,layer:i.layer},to:{pageUid:s,x:_s(n)?i.style.x:n,y:_s(o)?i.style.y:o,layer:void 0}}})),n=new zy({actionUid:qs(),type:"switchAnnotationPage",docUid:i.doc.uid,moveConfigs:s},this.core);this.core.commandService.execute(n,i.doc.uid);}duplicateAnnotation(t,e){const i=this.annotationApp.getAnnotationByUid(t);if(!i)return null;const s=i.getConfig();s.uid=qs(),e&&(s.pageUid=e),s.comment.creationDate=Jf(),s.comment.modificationDate=s.comment.creationDate;return this.createAnnotation(s.docUid,s)}copyAnnotations(t){t.length&&(this.clipboard=[],this.currentClipboard=[],this.currentPastePageUid=null),t.forEach((t=>{const e=this.annotationApp.getAnnotationByUid(t);if(e&&!["highlight","strikeout","underline"].includes(e.type)){const t=e.getConfig();this.clipboard.push(t),this.currentClipboard.push(Ns(t));}}));}cutAnnotations(t){const e=[];t.forEach((t=>{const i=this.annotationApp.getAnnotationByUid(t);i&&!["highlight","strikeout","underline"].includes(i.type)&&e.push(t);})),this.copyAnnotations(t),this.deleteAnnotations(e);}pasteAnnotations(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;if(!this.clipboard.length)return;const s=this.core.pageService.getPage(e);this.currentPastePageUid&&this.currentPastePageUid!==e&&(this.currentClipboard=Ns(this.clipboard)),this.currentPastePageUid=e,this.currentClipboard.forEach((n=>{var o,r,a,l;const h=Jf();let{x:c,y:d}=n.style;const u=!_s(null==n||null===(o=n.style)||void 0===o?void 0:o.x)&&!_s(null==n||null===(r=n.style)||void 0===r?void 0:r.y);!u&&null!=n&&null!==(a=n.transform)&&void 0!==a&&a.position&&(c=n.transform.position.x,d=n.transform.position.y),c+=i,d+=i,(c>s.cropBox.left+s.cropBox.width-i||d>s.cropBox.top+s.cropBox.height-i||c<s.cropBox.left||d<s.cropBox.top)&&(c=s.cropBox.left,d=s.cropBox.top),u?(n.style.x=c,n.style.y=d,delete n.transform.position):!u&&null!=n&&null!==(l=n.transform)&&void 0!==l&&l.position&&(n.transform.position={x:c,y:d});const p=Ns(n);p.layer=void 0;const g=qs();Object.assign(p,{uid:g,docUid:t,pageUid:e,creationDate:h,modificationDate:h});const f={annotationUid:g,creationDate:h,modificationDate:h,markedStates:[],reviewStates:[],replies:[]};this.pasteConfig.pasteComment?this.pasteConfig.pasteReply||Object.assign(p.comment,f):Object.assign(p.comment,f,{contents:""}),this.createAnnotation(n.docUid,p);}));}clearAnnotationClipboard(){this.clipboard=[],this.currentClipboard=[],this.currentPastePageUid=null;}bringToFront(t){return this.handleLayer(t,"f")}bringForward(t){return this.handleLayer(t,"fw")}sendToBack(t){const e=this.getAnnotationByUid(t),i=this.flattenedAnnotationUidsMap.get(e.pageUid);if(null==i||!i.length)return this.handleLayer(t,"b");if(!this.getAnnotationLayerState(t).back)return !0;this.enableEmitLayerChanged=!1;const s=i.length,n=e.layer;this.annotationApp.sendToBack(t);for(let i=0;i<s;i++)i===s-1?(e.layer=n,this.enableEmitLayerChanged=!0,this.bringForward(t)):this.annotationApp.bringForward(t);return !0}sendBackward(t){return this.handleLayer(t,"bw")}handleLayer(t,e){const i=this.annotationApp.getAnnotationByUid(t);if(!i)return !1;const s=this.core.pageService.getPage(i.pageUid);if(!s)return !1;const n={actionUid:qs(),type:e,annotationUid:t,docUid:s.doc.uid,pageUid:s.uid},o=this.annotationApp.getAnnotationLayerState(t);let r;return "f"===e&&o.front?r=new _y(n,this.core):"fw"===e&&o.forward?r=new Wy(n,this.core):"bw"===e&&o.backward?r=new Fy(n,this.core):"b"===e&&o.back&&(r=new Hy(n,this.core)),r&&this.core.commandService.execute(r,s.doc.uid),!0}getAnnotationLayerState(t){const e=this.annotationApp.getAnnotationLayerState(t),i=this.getAnnotationByUid(t);if(!i)return e;const s=this.flattenedAnnotationUidsMap.get(i.pageUid);if(null==s||!s.length)return e;const n=[...this.core.getAnnotationsByPageUid(i.pageUid)];n.sort(((t,e)=>t.layer-e.layer));return n.indexOf(i)===s.length&&(e.back=!1,e.backward=!1),e}updateComment(){}addReply(t,e,i){const s=this.annotationApp.getAnnotationByUid(e);if(!s)return;const n=new Yy({actionUid:qs(),type:"addReply",docUid:t,pageUid:s.pageUid,annotationUid:e,replyConfig:i},this.core);this.core.commandService.execute(n,t);}deleteReply(t,e){const i=this.annotationApp.getReply(e);if(!i)return;const s=this.annotationApp.getAnnotationByUid(i.annotationUid);if(!s)return;const n=new qy({actionUid:qs(),type:"deleteReply",docUid:t,pageUid:s.pageUid,annotationUid:i.annotationUid,replyConfig:{uid:i.uid,author:i.author,contents:i.contents,creationDate:i.creationDate,modificationDate:i.modificationDate,markedStates:i.markedStates.slice(),reviewStates:i.reviewStates.slice()}},this.core);this.core.commandService.execute(n,t);}updateReply(t,e,i){const s=this.annotationApp.getReply(e);if(!s)return;const n=this.annotationApp.getAnnotationByUid(s.annotationUid);if(!n)return;const o=new Jy({actionUid:qs(),type:"updateReply",docUid:t,pageUid:n.pageUid,annotationUid:n.uid,updateDetail:{from:null,to:null}},this.core);this.core.commandService.execute(o,t);}addReviewState(t,e){const i=this.annotationApp.getReply(e);if(!i)return;if(!i.markedStates.length)return;const s=this.annotationApp.getAnnotationByUid(i.annotationUid);if(!s)return;const n=Jf(),o=new Gy({actionUid:qs(),type:"addReplyMarkedState",replyUid:qs(),pageUid:s.pageUid,config:{uid:qs(),author:"",contents:"",creationDate:n,state:"none"}},this.core);this.core.commandService.execute(o,t);}deleteReviewState(t,e){const i=this.annotationApp.getReply(e);if(!i)return;if(!i.markedStates.length)return;const s=this.annotationApp.getAnnotationByUid(i.annotationUid);if(!s)return;const n=new Xy({actionUid:qs(),type:"deleteReplyMarkedState",pageUid:s.pageUid,replyUid:e,config:{uid:i.uid,author:i.author,contents:i.contents,creationDate:i.creationDate,state:i.reviewStates[i.reviewStates.length-1]}},this.core);this.core.commandService.execute(n,t);}addCheckMarkState(t,e){const i=this.annotationApp.getReply(e);if(!i)return;if(!i.markedStates.length)return;const s=this.annotationApp.getAnnotationByUid(i.annotationUid);if(!s)return;const n=Jf(),o=new jy({actionUid:qs(),type:"addReplyMarkedState",replyUid:qs(),pageUid:s.pageUid,config:{uid:qs(),author:"",contents:"",creationDate:n,state:"marked"}},this.core);this.core.commandService.execute(o,t);}deleteCheckMarkState(t,e){const i=this.annotationApp.getReply(e);if(!i)return;if(!i.markedStates.length)return;const s=this.annotationApp.getAnnotationByUid(i.annotationUid);if(!s)return;const n=new $y({actionUid:qs(),type:"deleteReplyMarkedState",pageUid:s.pageUid,replyUid:e,config:{uid:i.uid,author:i.author,contents:i.contents,creationDate:i.creationDate,state:i.markedStates[i.markedStates.length-1]}},this.core);this.core.commandService.execute(n,t);}createAnnotationShape(t,e){const{type:i,transform:s,style:n}=t.getConfig(),o=n,r=s;e&&!["highlight","underline","strikeout","incomplete"].includes(t.type)&&function(t,e){const i=["rx","x","width","borderWidth","fontSize"],s=["ry","y","height"],n=["startPoint","endPoint"];Object.keys(t).forEach((o=>{const r=t[o];if(i.includes(o)||s.includes(o)){const i=Cr(r);t[o]=e.toPixelPPI(i.value,s.includes(o));}else n.includes(o)?t[o]={x:e.toPixelPPI(r.x,!1),y:e.toPixelPPI(r.y,!0)}:"lineDash"===o?t[o]=r.map((t=>e.toPixelPPI(t,!1))):"points"===o?t[o]=r.map((t=>({x:e.toPixelPPI(t.x,!1),y:e.toPixelPPI(t.y,!0)}))):"segments"===o?t[o]=r.map((t=>t.map((t=>({x:e.toPixelPPI(t.x,!1),y:e.toPixelPPI(t.y,!0)}))))):"textContents"===o&&(t[o]=r.map((t=>({...t,fontSize:e.toPixelPPI(Cr(t.fontSize).value,!1)}))));}));}(o,e),"ellipse"===i&&(o.x+=o.width/2||0,o.y+=o.height/2||0,o.rx=o.width/2||o.rx,o.ry=o.height/2||o.ry),r&&null!=r&&r.position&&(r.position={x:e.toPixelPPI(r.position.x,!1),y:e.toPixelPPI(r.position.y,!0)});const a={id:t.uid,style:o,transform:r};let l;switch(i){case"rectangle":l=new wh(a);break;case"ellipse":l=new mh(a);break;case"line":l=new Rh(a);break;case"ink":l=new xh(a);break;case"polygon":l=new kh(a);break;case"polyline":l=new Dh(a);break;case"textTypewriter":l=new Ch(a,"freeTextWriter",{});break;case"textBox":l=new Ch(a,"textBox");break;case"stamp":l=new Vh(a);break;case"highlight":l=new Yh(a);break;case"underline":l=new Jh(a);break;case"strikeout":l=new qh(a);break;case"incomplete":l=new $h(a);}if(l instanceof Vh&&!l.style.imageData&&l.updateStampStyle({x:o.x,y:o.y,width:o.width,height:o.height}),["highlight","underline","strikeout","incomplete"].includes(i)){const{resolutionX:t,resolutionY:i}=e,{displayResolution:s}=Bo,n=t/s,o=i/s;l.setOrigin(0,0),l.scaleLocal(n,o);}return l}getAnnotationUidsByLayer(t){const e=this.annotationApp.annotationPageRepo.findPageByUid(t);return null==e?void 0:e.getAnnotationUidListByLayer()}flattenAnnotations(t){const e=t.map((t=>this.getAnnotationByUid(t))),i=[],s=[];this.enableEmitLayerChanged=!1,e.forEach((t=>{const e=t.layer;this.core.annotationService.annotationApp.sendToBack(t.uid);const n=this.flattenedAnnotationUidsMap.get(t.pageUid);n?(n.forEach((e=>{this.core.annotationService.annotationApp.bringForward(t.uid);})),n.push(t.uid)):this.flattenedAnnotationUidsMap.set(t.pageUid,[t.uid]),s.push(e),i.push({annotationUid:t.uid,options:{flags:[...t.flags,"flattened"],flattened:!0}});})),this.enableEmitLayerChanged=!0,e.forEach(((t,e)=>{i[e].options.layer=t.layer,t.layer=s[e];})),this.updateAnnotations(i,void 0,["flattenedChanged"],!0);}unFlattenAnnotation(t){const e=this.getAnnotationByUid(t),i=this.flattenedAnnotationUidsMap.get(e.pageUid);if(!i||0===i.length)return !1;const s=i.indexOf(e.uid);if(-1===s)return !1;this.enableEmitLayerChanged=!1;const n=i.length-(s+1),o=e.layer;for(let t=0;t<n;t++)this.core.annotationService.annotationApp.bringForward(e.uid);const r=e.layer,a=e.flags.filter((t=>"flattened"!==t));return e.layer=o,this.updateAnnotations([{annotationUid:e.uid,options:{flags:a,flattened:!1,layer:r}}],void 0,["flattenedChanged"],!0),i.includes(e.uid)&&i.splice(s,1),this.enableEmitLayerChanged=!0,!0}}function Qy(t){var e;return {annotationUid:t.uid,author:t.author,subject:t.subject,contents:t.contents,creationDate:t.creationDate,modificationDate:t.modifiedDate,markedStates:Ky(t.markedStates||[]),reviewStates:Ky(t.reviewStates||[]),replies:(null===(e=t.replies)||void 0===e?void 0:e.map((t=>Qy(t))))||[]}}function Ky(t){return t.map((t=>({uid:t.uid,author:t.author,contents:t.contents,creationDate:t.creationDate,state:t.state})))}function tx(t){if("stamp"===t.type){const e=new Vh({style:t.style,transform:t.transform}),i=e.getAnnotationConfig();t.style=i.style,t.transform={...t.transform,position:i.transform.position,scale:i.transform.scale},e.destroy();}}function ex(t,e){const i=Object.keys(t),s={},n={};return i.forEach((i=>{if(Os(t[i])&&Os(e[i])){const o=ex(t[i],e[i]);s[i]=o.newChanged,n[i]=o.oldChanged;}else s[i]=t[i],n[i]=e[i];})),{newChanged:s,oldChanged:n}}var ix=new WeakMap,sx=new WeakMap,nx=new WeakMap,ox=new WeakMap,rx=new WeakSet,ax=new WeakSet;class lx{constructor(t,e){v(this,ax),v(this,rx),f(this,ix,{writable:!0,value:void 0}),f(this,sx,{writable:!0,value:void 0}),f(this,nx,{writable:!0,value:void 0}),f(this,ox,{writable:!0,value:void 0}),p(this,rx,hx).call(this,t,e);}getCanvas(){return s(this,ix).contextService.getDomElement()}getInkOptions(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!s(this,ox))return null;const{x:e,y:i}=s(this,ox).getLocalPosition();s(this,ox).setLocalPosition(0,0);const n=s(this,ox).getAnnotationConfig(),o={borderWidth:n.style.borderWidth,borderColor:n.style.borderColor,opacity:n.style.opacity};if(t){const{displayResolution:t,dataResolution:r}=Bo,a=n.style.segments.map((e=>e.map((e=>({x:Gn(e.x,t,r),y:Gn(e.y,t,r)})))));return o.borderWidth=Gn(o.borderWidth,t,r),s(this,ox).setLocalPosition(e,i),s(this,ox).getAnnotationConfig(),{points:a,...o}}return {segments:n.style.segments,...o}}getSignatureImage(){if(!s(this,ox))return Promise.resolve(null);const t=s(this,ox).getBoundingRect(),e=document.createElement("canvas");e.width=t.width,e.height=t.height;return e.getContext("2d").drawImage(this.getCanvas(),t.left*devicePixelRatio,t.top*devicePixelRatio,t.width*devicePixelRatio,t.height*devicePixelRatio,0,0,t.width,t.height),new Promise((t=>{e.toBlob(t,"image/png");}))}updateSignatureStyle(t){n(this,nx,{...s(this,nx),...t}),s(this,ox)&&(s(this,ox).updateStyle({...t}),s(this,ix).render());}clearSignature(){s(this,sx).children.slice().forEach((t=>{s(this,sx).removeChild(t);})),n(this,ox,null),s(this,ix).render();}resizeCanvas(t,e){s(this,ix).resize(t,e);}}function hx(t,e){const i=document.createElement("canvas");i.style.touchAction="none",n(this,ix,new Al({renderer:new jl,width:t,height:e,canvas:i,dpr:window.devicePixelRatio,willReadFrequently:!0})),n(this,sx,s(this,ix).document.documentElement),(new wc).init(s(this,ix)),p(this,ax,cx).call(this);}function cx(){let t=!1;const e=this.getCanvas();e.addEventListener("pointerdown",(e=>{const i={x:e.offsetX,y:e.offsetY};t=!0,s(this,ox)?(s(this,ox).addSegment(),s(this,ox).addPoint(i)):(n(this,ox,new xh({style:{segments:[[i]],...s(this,nx),lineCap:"round",lineJoin:"round"}})),s(this,sx).appendChild(s(this,ox))),s(this,ix).render();})),e.addEventListener("pointermove",(e=>{if(!t)return;const i={x:e.offsetX,y:e.offsetY};s(this,ox).addPoint(i),s(this,ix).render();})),document.addEventListener("pointerup",(()=>{t&&(t=!1,s(this,ox).pathDirty=!0,s(this,ox).boundsDirty=!0,s(this,ix).render());}));}const dx={stampText:"Draft",fontSize:32,fontFamily:"Arial",fontWeight:"bold",fontStyle:"normal",underline:!1,strikeout:!1,color:"#182564",borderColor:"#182564",background:"#c7d2e4",timeStampFontSize:16,userName:"Guest",hasUserName:!0,hasDate:!0,hasTime:!0};var ux=new WeakMap,px=new WeakMap,gx=new WeakMap,fx=new WeakMap,vx=new WeakMap,mx=new WeakMap,yx=new WeakSet,xx=new WeakSet;class wx{constructor(t,e){v(this,xx),v(this,yx),f(this,ux,{writable:!0,value:void 0}),f(this,px,{writable:!0,value:void 0}),f(this,gx,{writable:!0,value:void 0}),f(this,fx,{writable:!0,value:void 0}),f(this,vx,{writable:!0,value:void 0}),f(this,mx,{writable:!0,value:{...dx}}),n(this,gx,t),n(this,fx,e),p(this,yx,bx).call(this,t,e);}get signatureStyle(){return {...s(this,mx)}}getStampConfig(){const{background:t,borderColor:e,stampText:i}=s(this,mx),n=[],o=function(t,e){const i=t-1,s=e-1;return [{x:i,y:s-10.6,step:2},{x:i,y:s-4.8,step:1},{x:i-6,y:s,step:1},{x:i-13.4,y:s,step:1},{x:14.4,y:s,step:0},{x:7,y:s,step:1},{x:1,y:s-4.8,step:1},{x:1,y:s-10.6,step:1},{x:1,y:11.6,step:0},{x:1,y:5.8,step:1},{x:7,y:1,step:1},{x:14.4,y:1,step:1},{x:i-13.4,y:1,step:0},{x:i-6,y:1,step:1},{x:i,y:5.8,step:1},{x:i,y:11.6,step:1},{x:i,y:s-10.6,step:0}]}(s(this,gx),s(this,fx));n.push({type:"path",stampPoints:o,borderWidth:1.3333333333333333,lineDash:[0,0],lineCap:"butt",lineJoin:"miter",miterLimit:4,background:t,borderColor:e});const{color:r,fontFamily:a,fontSize:l,fontStyle:h,fontWeight:c}=s(this,mx),d=null!=a&&a.includes(" ")?`'${a}'`:a,u=document.createElement("canvas").getContext("2d"),{hasUserName:p,hasDate:g,hasTime:f,timeStampFontSize:v,userName:m}=s(this,mx),y=p||g||f;if(y){let t="";t+=p?`${m} `:"",t+=g?`${function(){const t=new Date,e=t.getFullYear(),i=(t.getMonth()+1).toString().padStart(2,"0");return `${t.getDate().toString().padStart(2,"0")}/${i}/${e}`}()} `:"",t+=f?`${function(){const t=new Date;let e=t.getHours();const i=t.getMinutes().toString().padStart(2,"0"),s=e>=12?"PM":"AM";return e%=12,e=e||12,`${e}:${i} ${s}`}()}`:"";const e=`${h} ${c} ${v}px ${d}`;u.font=e;const{width:i,actualBoundingBoxAscent:o,actualBoundingBoxDescent:l}=u.measureText(t.trim()),y=o+l;n.push({type:"text",text:t,x:(s(this,gx)-i)/2,y:s(this,fx)/2+s(this,fx)/4+y/2,color:r,fontFamily:a,fontSize:v,fontStyle:h,fontWeight:c});}if(i){const t=`${h} ${c} ${l}px ${d}`;u.font=t;const{underline:e,strikeout:o}=this.signatureStyle,{width:p,actualBoundingBoxAscent:g,actualBoundingBoxDescent:f}=u.measureText(i),v=g+f;if(n.push({type:"text",text:i,x:(s(this,gx)-p)/2,y:y?s(this,fx)/2:s(this,fx)/2+v/2,color:r,fontFamily:a,fontSize:l,fontStyle:h,fontWeight:c}),o){const t=y?s(this,fx)/2-v/3:s(this,fx)/2+v/2-v/3,e=(s(this,gx)-p)/2;n.push({type:"path",stampPoints:[{x:e,y:t,step:2},{x:e+p,y:t,step:0}],borderWidth:2,borderColor:r,clipped:!0});}if(e){const t=y?s(this,fx)/2+v/10:s(this,fx)/2+v/2+v/10,e=(s(this,gx)-p)/2;n.push({type:"path",stampPoints:[{x:e,y:t,step:2},{x:e+p,y:t,step:0}],borderWidth:2,borderColor:r,clipped:!0});}}return n}getCanvas(){return s(this,px).contextService.getDomElement()}updateSignatureStyle(t){n(this,mx,{...s(this,mx),...t});const e=this.getStampConfig();s(this,vx).stampConfig=e,s(this,vx).initStamp(),s(this,px).render();}getSignatureImage(){if(!s(this,vx))return Promise.resolve(null);const t=document.createElement("canvas");t.width=s(this,gx),t.height=s(this,fx);return t.getContext("2d").drawImage(this.getCanvas(),-.65*devicePixelRatio,-.65*devicePixelRatio,(s(this,gx)+1.3)*devicePixelRatio,(s(this,fx)+1.3)*devicePixelRatio,0,0,s(this,gx),s(this,fx)),new Promise((e=>{t.toBlob(e,"image/png");}))}}function bx(t,e){const i=document.createElement("canvas");n(this,px,new Al({renderer:new jl,width:t,height:e,canvas:i,dpr:window.devicePixelRatio,willReadFrequently:!0})),i.style.width=`${t}px`,i.style.height=`${e}px`,n(this,ux,s(this,px).document.documentElement),n(this,vx,new Vh({style:{stampConfig:this.getStampConfig()}})),s(this,ux).appendChild(s(this,vx)),(new wc).init(s(this,px)),s(this,px).render();}const Sx={install(t){const e=t.getClass("Viewer"),s=(n=e,class extends n{constructor(t){super(t),i(this,"annotationViewerContext",void 0),this.annotationViewerContext=this.register(new Iy(this)),this.listenGlobalEventForAnnotation(),this.listenHooksForAnnotation(),this.listenNativeEventsForAnnotation(),this.context.hasAnnotationModule=!0,this.context.annotationEditService=this.register(new Ly(this.annotationViewerContext));const e=this.getViewerConfig();this.context.isDefaultViewer&&this.updateAnnotationConfig({enableDeleteWithKeyboard:e.enableDeleteWithKeyboard,enableMoveWithKeyboard:e.enableMoveAnnotationWithKeyboard,enableMultipleSelectWidthCtrl:e.enableMultipleSelectAnnotationWithKeyboard});}listenHooksForAnnotation(){const t=()=>{const t=this.getSelectedAnnotations();if(1!==t.length)return;if(!t[0])return;const e=this.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.updateCursor();};this.hooks.scroll.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.resize.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.zoomChanged.on((e=>{this.context.isDefaultViewer&&t();}),this),this.hooks.pageChanged.on((t=>{if(this.context.isDefaultViewer||this.context.isThumbnailViewer){const t=this.getActiveTab();if(null!=t&&t.total){const e=t.getCurrentPage();this.context.annotationEditService.setAnnotationContainer(e);}t&&"single"===t.context.displayMode&&this.annotationViewerContext.disableTextEditMode();}}),this),this.hooks.currentPageChanged.on((t=>{if(this.context.isDefaultViewer||this.context.isThumbnailViewer){const t=this.getActiveTab();if(null!=t&&t.total){const e=t.getCurrentPage();this.context.annotationEditService.setAnnotationContainer(e);}}}),this);}listenGlobalEventForAnnotation(){if(!this.context.isDefaultViewer&&!this.context.isThumbnailViewer)return;const{core:t}=this.context,e=t.annotationService.annotationApp.hooks;t.onBeforeGetPageData.on((t=>{const{activatedShape:e}=this.annotationViewerContext.annotationController.eventService;(null==e?void 0:e.pageUid)===t.pageUid&&e instanceof Ch&&e.isEditMode&&e.textEditEventHandler.emitTextContentUpdated();}),this),e.annotationCreated.on((t=>{let e=!1;var i;t.annotations.forEach((t=>{this.annotationViewerContext.addAnnotationByAnnotationData(t),e||this.annotationIsVisible(t.uid)&&(e=!0);})),e&&(null===(i=this.context)||void 0===i||i.render(61));}),this),e.annotationDeleted.on((t=>{var e;this.annotationViewerContext.deleteAnnotations(t.annotations.map((t=>t.uid)),t.emitEvent),null===(e=this.context)||void 0===e||e.render(62);}),this),e.annotationUpdated.on((t=>{var e;const i=t.updateDetails.map((t=>t.annotationUid)),s=function(t){if(!t.length)return !1;for(const e of t)if("flagsChanged"!==e&&"flattenedChanged"!==e)return !1;return !0}(t.updateActions);this.annotationViewerContext.updateAnnotations(i,t.updatedBy,s,t.updateDetails),this.hooks.annotationsUpdated.emit(new Af(i,t.updateActions)),null===(e=this.context)||void 0===e||e.render(63);}),this),e.bringFroward.on((t=>{var e;this.annotationViewerContext.updateLayer([t.annotationUid,t.forwardUid]),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(64));}),this),e.bringToFront.on((t=>{var e;this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(64));}),this),e.sendBackward.on((t=>{var e;this.annotationViewerContext.updateLayer([t.annotationUid,t.backwardUid]),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(66));}),this),e.sendToBack.on((t=>{var e;this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(67));}),this),e.restoreLayer.on((t=>{var e;this.annotationViewerContext.updateLayer([t.annotationUid]),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(68));}),this),e.annotationPageSwitched.on((t=>{var e;this.annotationViewerContext.updateAnnotationPage(t.annotationUid,t.to.pageUid),this.annotationIsVisible(t.annotationUid)&&(null===(e=this.context)||void 0===e||e.render(69));}),this);}listenNativeEventsForAnnotation(){(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&eo(document,"click",this).on((t=>{const e=this.getActiveTab(),i="visible"===this.context.viewerConfig.visibility;e&&i&&(this.context.viewService.mainContainer.contains(null==t?void 0:t.target)||this.annotationViewerContext.disableTextEditMode());}));}getAnnotationConfig(){return Ns(this.annotationViewerContext.annotationController.interactiveConfig)}updateAnnotationConfig(t){this.annotationViewerContext.annotationConfigService.updateConfig(t);}selectAnnotations(t){return this.annotationViewerContext.selectAnnotations(t)}deleteAnnotations(t){this.context.core.annotationService.deleteAnnotations(t),this.context.render(70);}updateAnnotation(t,e,i){const s=this.getAnnotationObject(t);s instanceof Ch&&s.isEditMode&&s.textEditEventHandler.emitTextContentUpdated(),this.context.core.annotationService.updateAnnotations([{annotationUid:t,options:e}],void 0,i);}getSelectedAnnotations(){return this.annotationViewerContext.getSelectedAnnotations()}bringForward(t){return this.context.core.annotationService.bringForward(t)}bringToFront(t){return this.context.core.annotationService.bringToFront(t)}sendBackward(t){return this.context.core.annotationService.sendBackward(t)}sendToBack(t){return this.context.core.annotationService.sendToBack(t)}getAnnotationObject(t){return this.annotationViewerContext.annotationController.getShape(t)}copyAnnotations(t){t||(t=this.getSelectedAnnotations().map((t=>t.uid))),t.length&&this.context.core.annotationService.copyAnnotations(t);}cutAnnotations(t){t||(t=this.getSelectedAnnotations().map((t=>t.uid))),t.length&&this.context.core.annotationService.cutAnnotations(t);}pasteAnnotations(t,e){const i=this.context.getActiveTab();if(null==i||!i.total)return;const s=i.getCurrentPage();if(!s)return;const n=this.context.viewerConfig.copyAnnotationOffset;this.context.core.annotationService.pasteAnnotations(t||i.uid,e||s.uid,n);}clearAnnotationClipboard(){this.context.core.annotationService.clearAnnotationClipboard();}undo(){const{activatedShape:t}=this.annotationViewerContext.annotationController.eventService;if(!this.context.getActiveTab())return !1;const e=t instanceof Ch&&t.isEditMode;e&&t.textEditEventHandler.emitTextContentUpdated();const i=super.undo();return e&&t.textEditEventHandler.resetStartTextContent(),i}redo(){const{activatedShape:t}=this.annotationViewerContext.annotationController.eventService;if(!this.context.getActiveTab())return !1;const e=t instanceof Ch&&t.isEditMode;e&&t.textEditEventHandler.emitTextContentUpdated();const i=super.redo();return e&&t.textEditEventHandler.resetStartTextContent(),i}annotationIsVisible(t){const e=this.context.core.annotationService.annotationApp.getAnnotationByUid(t),i=this.context.core.pageService.getPage(e.pageUid);if(i){const t=this.context.tabService.getTab(i.doc.uid);if(null!=t&&t.isActive&&t.getPageByUid(e.pageUid).isVisible)return !0}return !1}});var n;t.setClass("Viewer",s);},apply(t){const e=new Zy(t);t.annotationService=e;const{pageService:i}=t;e.hooks.annotationCreated.on((t=>{t.annotations.forEach((t=>{const e=i.getPage(t.pageUid);e&&e.annotations.push(t.uid);}));}),i),e.hooks.annotationDeleted.on((t=>{t.annotations.forEach((t=>{const e=i.getPage(t.pageUid);if(e){const i=e.annotations.indexOf(t.uid);e.annotations.splice(i,1);}}));}),i),e.hooks.annotationPageSwitched.on((t=>{const e=i.getPage(t.from.pageUid),s=i.getPage(t.to.pageUid);if(e){const i=e.annotations.indexOf(t.annotationUid);e.annotations.splice(i,1);}s&&s.annotations.push(t.annotationUid);}),i);}},Cx={canvasStyle:{cursor:"default"},currentPageStyle:{border:""},pageStyle:{border:"2px solid #707070",background:"#e2e2e2"},selectedPageStyle:{background:"#6f76ff",border:"2px solid #e98b1f"},hoveredPageStyle:{background:"#a5a9fb",border:"2px solid #e98b1f"},placeholderStyle:{background:"#b5b5b5",border:"0px solid #f00"},pageNumberStyle:{width:24,height:24,left:"50%",top:"",right:"",bottom:"0px",translateX:"-50%",translateY:0,border:"0px solid #000",borderRadius:0,background:"#fff",opacity:1,visibility:"visible",onPage:!1,color:"#000",fontSize:12,fontFamily:"sans-serif",textAlign:"center",textBaseline:"middle"},checkboxStyle:{width:24,height:24,left:0,top:0,right:"",bottom:"",translateX:0,translateY:0,border:"1px solid #000",borderRadius:0,background:"#fff",opacity:1,visibility:"visible",visibleByHover:!0,checkMarkColor:"#000",checkMarkLineWidth:2},removeBtnStyle:{visibility:"visible",width:24,height:24,background:"#fff",border:"1px solid #515151",borderRadius:"50%",opacity:1,left:"",top:-8,right:-8,bottom:"",checkMarkColor:"#ea2e2e"},quadSelectionStyle:{border:"1px dashed #fe8e14",ctrlBorderRadius:0,ctrlBorder:"1px dashed #fe8e14",ctrlWidth:10,ctrlHeight:10,invalidCtrlBorderColor:"#fe8e14",invalidBorderColor:"#fe8e14"},textSelectionStyle:{background:"rgba(51,103,209,0.5)",ctrlBackground:"rgba(51,103,209,0.8)",ctrlBorderRadius:8,ctrlBorderWidth:1,ctrlBorderColor:"rgba(51,103,209,0.8)"},textSearchStyle:{background:"rgba(248, 245, 33, 0.8)",currentBackground:"rgba(255, 174, 0, 0.8)"},croppingMagnifierStyle:{type:"circle",size:100,borderColor:"#323232",borderWidth:3,crosshairWidth:1,crosshairColor:"#323232",magnification:3},textMagnifierStyle:{type:"circle",size:100,borderColor:"#323232",borderWidth:3,magnification:3},magnifierStyle:{type:"circle",size:100,borderColor:"#323232",borderWidth:3,crosshairWidth:1,crosshairColor:"#323232",magnification:3},cursorStyle:{default:"default",annotationSelect:"crosshair",annotationDraw:"crosshair",annotationMove:"move",annotationNSResize:"ns-resize",annotationEWResize:"ew-resize",annotationNWResize:"nw-resize",annotationNEResize:"ne-resize",annotationSWResize:"sw-resize",annotationSEResize:"se-resize",annotationRotate:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAsUlEQVR4nOXSwXHCMBQG4VVHdBC5g5TgVJASonTgVJCUkBJEBVACJUAHrHh4gAFmEFd25rNP/qWDE6cWysCkh5sH3vWrHxU6agOfmtSqhPO2Wmqtq5JG4vTWUpXLFsrASh/acFZSayRGvlW4XSFuO2itQ0lzmTht0r0K8KZBh5J62ypzvMUzAxX416SnBgpRwV5s4EutTFSBXc/ASPxsczvlnoHWyGlkUE0+evvDD4k3ex4wI7FMVvTgAAAAAElFTkSuQmCC) -15 15, auto",annotationErase:"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAATtJREFUOE+Vk8ErRFEUxs93/gXZUUrNhiRFWUkWVpaWSomlpaVkaUlZ2CiWllZKjbJQVqQokaYspPwL5+e9aeb15s17z7i7273nd77v3O/KBliSrs1sycxugMV8if6ql3RpZiPAvaR5M/vJQ2oBki7MbBR47DYqQioB7n4OjAHPRZV5SCnA3U+AceCtyqKkZTP76AO4+yHQAFoDzGerB+DuB8DUgMXpQL8zgLvvA3P/KG4BK13AnqQFMxsC7uqkS5o1s3dgNb0ndz9ON8BwAmnWQSRNS3qNiLXcswogs1IFSTIxIeklIjZ7kij1AtqyCkokNSQ9RcR2Xybc/QyYASYL5LYdM/uS9BARO2WzaUvvdLS+jyI1Jd1GxG5loHLDSDtmEEmfSWSvImKj9lXyh+5+Cqx3VB2VeS7CfgHdAKKUgZXPMQAAAABJRU5ErkJggg==) 10 10,auto",annotationActivable:"pointer",pan:"grab",panning:"grabbing",text:"text",textHover:"default",cropDraw:"crosshair",cropMove:"move",cropNSResize:"ns-resize",cropEWResize:"ew-resize",cropNWResize:"nw-resize",cropNEResize:"ne-resize",cropSWResize:"sw-resize",cropSEResize:"se-resize",zoomIn:"zoom-in",zoomOut:"zoom-out"},enableDragPage:!0,dragThreshold:3,dragStartTimeThreshold:500,enablePanX:!0,enablePanY:!0,panThreshold:3,enableZoom:!0,enableZoomWithCtrl:!0,enableZoomWithTouch:!0,zoom:1,minZoom:.02,maxZoom:8,wheelZoomFactor:1.2,tapZoomFactor:1.2,zoomOrigin:{x:"center",y:"center"},enableZoomInCropMode:!0,enableZoomInPanMode:!0,enableZoomInAnnotationMode:!0,enableZoomInTextSelectionMode:!0,enableSlide:!0,startSlideThreshold:20,slideThreshold:.2,startSlideThresholdForPerspective:30,slideThresholdForPerspective:.2,multiselectMode:!1,enableSelectWithShift:!0,enableSelectWithCtrl:!0,enableTextSelection:!0,enableTextMagnifier:!0,enableEditCropBoxVertices:!0,enableEditCropBoxMidpoints:!0,enableHideEditingCropBoxVertex:!0,enableHideEditingCropBoxMidpoint:!0,enableMagnifier:!0,scrollDirection:"vertical",displayMode:"single",fitMode:"window",margin:10,rows:4,columns:1,maxRows:20,maxColumns:20,renderingMode:"image",hasThb:!1,visibility:"visible",viewerMode:lg.DEFAULT,toolMode:"pan",annotationMode:"select",enableMultiTab:!1,scrollToLatest:!1,autoScroll:!0,autoChangeIndex:!0,enableLoadSourceByDrag:!0,enterTextModeTime:150,enterTextModeTimeMobile:500,multipleClickTimeout:500,textSearchDelay:500,enableCursorService:!0,maxUndoRedoTimes:1e3,autoScrollBoundarySize:20,autoScrollStepSize:10,enableAutoScrollForTextSelection:!0,enableAutoScrollForDragPages:!0,enableFillColor:!0,blankFillColor:"#fff",maxOptimizationSize:7e3,enableOptimizePage:!1,enableAnnotationInteraction:!0,enableSelectAnnotation:!0,enableRotateAnnotation:!0,enableMoveAnnotation:!0,enableResizeAnnotation:!0,copyAnnotationOffset:10,enableKeyboardInteraction:!0,enableZoomInWithKeyboard:!0,enableZoomOutWithKeyboard:!0,enableUndoWithKeyboard:!0,enableRedoWithKeyboard:!0,enableDeleteWithKeyboard:!0,enableSelectAllWithKeyboard:!0,enableMoveAnnotationWithKeyboard:!0,enableSaveWithKeyboard:!0,enableLoadSourceWithKeyboard:!0,enablePrintWithKeyboard:!0,enableSelectPageWithKeyboard:!0,enableCopyCutPasteWithKeyboard:!0,enableMultipleSelectAnnotationWithKeyboard:!0,moveAnnotationStepSize:2,moveAnnotationAcceleration:1};class Px extends Ua{constructor(){super({name:"Checkbox"}),i(this,"shapeType","checkbox"),i(this,"checkboxStyle",void 0),i(this,"parsedCheckboxStyle",void 0),i(this,"isChecked",!1);}get checked(){return this.isChecked}set checked(t){this.isChecked=t;}updateStyle(t){Object.assign(this.style,t);}}class Tx extends Ua{constructor(){super({name:"PageNumber"}),i(this,"shapeType","pageNumber"),i(this,"text",void 0),i(this,"parsedPageNumberStyle",void 0),this.text="0";}updateText(t){this.text=t;}updateStyle(t){Object.assign(this.style,t);}}class Ax extends Ua{constructor(){super({name:"TextSelection"}),i(this,"shapeType","textSelection"),i(this,"lines",void 0),i(this,"parsedTextSelectionStyle",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0);}updateLines(t){this.lines=t;}updateStyle(t){Object.assign(this.style,t);}isPointOnTextSelection(t){var e;return !(null===(e=this.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}hasSelectedText(){var t;return !(null===(t=this.lines)||void 0===t||!t.length)}}class kx extends Ua{constructor(){super({name:"SearchedText"}),i(this,"shapeType","textSearch"),i(this,"lines",void 0),i(this,"selectedTextUid",void 0);}update(t){this.lines=t;}updateStyle(t){Object.assign(this.style,t);}setCurrent(t){this.selectedTextUid=t;}clear(){this.selectedTextUid=null,this.lines=null,this.style.lines=null;}}class Dx extends Ga{constructor(t){super({...t,name:"TabPage"}),i(this,"uid",void 0),i(this,"tab",void 0),i(this,"isSelected",!1),i(this,"isHovered",!1),i(this,"isDragging",!1),i(this,"hasCache",void 0),i(this,"isLoading",!1),i(this,"isPreload",!1),i(this,"isLoaded",!1),i(this,"rWidth",void 0),i(this,"rHeight",void 0),i(this,"rotation",0),i(this,"cropLeft",void 0),i(this,"cropTop",void 0),i(this,"cropWidth",void 0),i(this,"cropHeight",void 0),i(this,"mediaBoxRect",void 0),i(this,"cropBoxRect",void 0),i(this,"isOptimized",!1),i(this,"optimizedUid","1"),i(this,"optimizationUid","2"),i(this,"editUid",void 0),i(this,"editedUid",void 0),i(this,"zoom",1),i(this,"image",void 0),i(this,"borderBox",void 0),i(this,"checkbox",void 0),i(this,"pageNumber",void 0),i(this,"curBox",void 0),i(this,"mediaBox",void 0),i(this,"cropBox",void 0),i(this,"realTimeBox",void 0),i(this,"textSelection",void 0),i(this,"textSearch",void 0),i(this,"visibleSortIndex",void 0),i(this,"needLayout",void 0),i(this,"pageIndex",void 0),i(this,"visiblePart",void 0),i(this,"visiblePartData",void 0),this.tab=t.tab,this.uid=t.uid,this.rWidth=t.style.width,this.rHeight=t.style.height,this.initSubShapes(t);}initSubShapes(t){this.updateStyle({visibility:"hidden"});const e=new Wa({name:"pageImage",id:this.uid,style:{x:0,y:0,zIndex:-99999}}),i=new Ga({name:"pageOptimizedBox",style:{x:0,y:0}}),s=new Ga({name:"pageCropBox"});s.clippable=!0;const n=new Ga({name:"pageMediaBox"}),o=new Ga({name:"pageBorderBox",style:{...t.style,...t.formattedPageStyle}}),r=new Ga({name:"currentStyleBox",style:{visibility:"hidden"}}),a=new Px,l=new Tx,h=new Ax,{textSelectionStyle:c,textSearchStyle:d}=this.tab.viewerContext.viewerConfig;h.updateStyle({x:0,y:0,visibility:"visible",zIndex:9999,...c});const u=new kx;u.updateStyle({x:0,y:0,visibility:"visible",zIndex:9999,...d}),n.appendChild(e),n.appendChild(h),n.appendChild(u),s.appendChild(n),o.appendChild(i),o.appendChild(s),o.appendChild(r),o.appendChild(a),this.appendChild(l),this.appendChild(o),this.image=e,this.borderBox=o,this.realTimeBox=i,this.pageNumber=l,this.checkbox=a,this.curBox=r,this.cropBox=s,this.mediaBox=n,this.textSelection=h,this.textSearch=u;}getRotation(){let t=this.rotation%360;return t<0&&(t+=360),90*Math.round(t/90)}getRect(){const t=this.realTimeBox.getPosition();return {left:t.x,top:t.y,width:this.rWidth,height:this.rHeight}}setImgDom(t){this.image.style.img=t;}getImgDom(){return this.image.style.img}clearOptimization(){this.visiblePartData=null,this.visiblePart=null,this.isOptimized=!1,this.realTimeBox.imageData=null,this.image.updateStyle({visibility:"visible"}),this.optimizationUid=qs();}destroy(){this.image.style.img=null,this.image=null,this.realTimeBox=null;}setPage(t,e,i,s){this.updateStyle({x:t,y:e,width:i,height:s});}setBorderBox(t,e,i,s,n){_s(n)?this.borderBox.updateStyle({x:t,y:e,width:i,height:s}):this.borderBox.updateStyle({x:t,y:e,width:i,height:s,borderWidth:n});}setCropBox(t,e,i,s,n){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this.cropBox.setLocalScale(1),this.cropBox.updateStyle({x:t,y:e,width:i,height:s}),this.cropBox.setLocalScale(n),this.cropBox.setLocalAngle(o),180===this.cropBox.getAngle()&&this.cropBox.setLocalAngle(179.9);}setRealTimeBox(t,e,i,s,n){this.realTimeBox.setLocalScale(1),this.realTimeBox.updateStyle({x:t,y:e,width:i,height:s}),this.realTimeBox.setLocalScale(n,n);}setMediaBox(t,e,i,s){this.mediaBox.updateStyle({x:t,y:e,width:i,height:s});}setCurBox(t,e,i,s){this.curBox.updateStyle({x:t,y:e,width:i,height:s});}setImage(t,e,i,s){this.image.updateStyle({x:t,y:e,width:i,height:s});}setTextSelection(t){this.textSelection&&this.textSelection.updateLines(t);}setTextSelectionStyle(t){this.textSelection&&this.textSelection.updateStyle(t);}setStartCharRect(t){this.textSelection&&(this.textSelection.startCharRect=t);}setEndCharRect(t){this.textSelection&&(this.textSelection.endCharRect=t);}isPointOnTextSelection(t){var e;return !(null===(e=this.textSelection.lines)||void 0===e||!e.some((e=>e.left<=t.x&&e.left+e.width>=t.x&&e.top<=t.y&&e.top+e.height>=t.y)))}isPointOnTextStart(t){var e,i;if(null===(e=this.textSelection)||void 0===e||null===(e=e.lines)||void 0===e||!e.length)return !1;const s=null===(i=this.textSelection)||void 0===i?void 0:i.startCharRect;if(!s)return !1;if(gv(t,this.textSelection.startCharRect))return !0;const n=this.textSelection.getScale().x,o=this.textSelection.style.ctrlBorderRadius/n;return an({x:s.left+s.width/2,y:s.top-o},t)<=o}isPointOnTextEnd(t){var e,i;if(null===(e=this.textSelection)||void 0===e||null===(e=e.lines)||void 0===e||!e.length)return !1;const s=null===(i=this.textSelection)||void 0===i?void 0:i.endCharRect;if(!s)return !1;if(gv(t,this.textSelection.endCharRect))return !0;const n=this.textSelection.getScale().x,o=this.textSelection.style.ctrlBorderRadius/n;return an({x:s.left+s.width/2,y:s.top+s.height+o},t)<=o}setSearchedText(t){const e=t.texts.map((t=>({textUid:t.textUid,boxes:t.lines.map((t=>t.box))})));this.textSearch.update(e);}selectSearchedText(t){this.textSearch.setCurrent(t);}clearSearchedText(){this.textSearch.clear();}getTextSelectionBoundingForCanvas(){var t;if(null===(t=this.textSelection)||void 0===t||null===(t=t.lines)||void 0===t||!t.length)return null;const{lines:e}=this.textSelection;let i=e[0].left,s=e[0].top,n=e[0].left+e[0].width,o=e[0].top+e[0].height;e.forEach((t=>{const e=t.left+t.width,r=t.top+t.height;i=Math.min(i,t.left),s=Math.min(s,t.top),n=Math.max(n,e),o=Math.max(o,r);}));const{x:r,y:a}=this.textSelection.getScale(),{x:l,y:h}=this.textSelection.getPosition();return {left:i*r+l,top:s*a+h,width:(n-i)*r,height:(o-s)*a}}getTextSelectionControlPointsRect(){const{startCharRect:t,endCharRect:e}=this.textSelection,i=[],{ctrlBorderRadius:s}=this.textSelection.style,{x:n,y:o}=this.textSelection.getScale(),{x:r,y:a}=this.textSelection.getPosition(),{width:l,height:h}=this,c=this.getRotation(),d=90===c||180===c?r-l:r,u=180===c||270===c?a-h:a;if(t){const{left:e,top:r,width:a}=t;let p=e+a/2,g=r,f=p*n+d-s,v=g*o+u-2*s;90===c?(p=l/n-r,g=e+a/2,f=p*n+d,v=g*o+u-s):180===c?(p=l/n-e-a/2,g=h/o-r,f=p*n+d-s,v=g*o+u):270===c&&(p=r,g=h/o-e-a/2,f=p*n+d-2*s,v=g*o+u-s);const m={left:f,top:v,width:2*s,height:2*s};i.push(m);}if(e){const{left:t,top:r,width:a,height:p}=e;let g=t+a/2,f=r+p,v=g*n+d-s,m=f*o+u;90===c?(g=l/n-r-p,f=t+a/2,v=g*n+d-2*s,m=f*o+u-s):180===c?(g=l/n-t-a/2,f=h/o-r-p,v=g*n+d-s,m=f*o+u-2*s):270===c&&(g=r+p,f=h/o-t-a/2,v=g*n+d,m=f*o+u-s/2);const y={left:v,top:m,width:2*s,height:2*s};i.push(y);}return i}}function Rx(t){const{borderWidth:e,borderColor:i,borderStyle:s}=wn(t),n=parseInt(e||"0px",10);let o=[0,0];return "dashed"===s&&(o=[2*n,n]),{borderWidth:n,borderStyle:o,borderColor:i||"",lineDash:o}}const Ex=t=>{const{border:e}=t;if(!e)return 0;const i=e.match(/[0-9]+/g)[0];return parseInt(i||"0",10)};function Mx(t,e){if(_s(t)||""===t)return null;const i=Pr(t);return "%"===i.unit?e*i.value/100:i.value}function Ix(t,e,i){t.style.width=`${e}px`,t.style.height=`${i}px`;}function Bx(t){const e=devicePixelRatio;return js(t)&&t>0?(t=Math.floor(t*e)/e)||(t=1/e):t=0,t}function Ux(t){const e=devicePixelRatio;return js(t)&&t>0?(t=Math.round(t*e)/e)||(t=1/e):t=0,t}function Lx(t){return Ux(t)}const Ox=()=>{const t=document.createElement("div");t.style.width="100px",t.style.height="100px",t.style.overflow="scroll",t.style.position="absolute",t.style.top="-9999px",document.body.appendChild(t);const e=t.offsetWidth-t.clientWidth;return document.body.removeChild(t),e};function Nx(t,e,i,s){const n={isOver:!1,pointerX:-1,pointerY:-1,page:t};if(t){const{x:o,y:r}=t.getPosition(),{width:a,height:l}=t,h=(s%360+360)%360/90,c=t.getScale();let d=-1,u=-1;0===h?(d=(e-o)/c.x,u=(i-r)/c.y,n.isOver=e>=o&&i>=r&&e<=o+a&&i<=r+l):1===h?(d=(i-r)/c.x,u=(o-e)/c.y,n.isOver=e>=o-l&&i>=r&&e<=o&&i<=r+a):2===h?(d=(o-e)/c.x,u=(r-i)/c.y,n.isOver=e>=o-a&&i>=r-l&&e<=o&&i<=r):3===h&&(d=(r-i)/c.y,u=(e-o)/c.x,n.isOver=e>=o&&i>=r-l&&e<=o+a&&i<=r),n.pointerX=d,n.pointerY=u;}return n}class _x{constructor(t,e){i(this,"tab",void 0),i(this,"viewerContext",void 0),i(this,"viewportWidth",600),i(this,"viewportHeight",800),i(this,"currentViewportWidth",0),i(this,"currentViewportHeight",0),i(this,"currentLayoutWidth",0),i(this,"currentLayoutHeight",0),i(this,"placeholderPages",[]),i(this,"scrollLeft",0),i(this,"scrollTop",0),i(this,"maxScrollLeft",0),i(this,"maxScrollTop",0),i(this,"startRow",0),i(this,"endRow",0),i(this,"startColumn",0),i(this,"endColumn",0),i(this,"preloadCount",1),i(this,"pagePreloadChanges",[]),i(this,"direction","vertical"),i(this,"displayMode",void 0),i(this,"fitMode",void 0),i(this,"rows",void 0),i(this,"columns",void 0),i(this,"zoom",void 0),i(this,"defaultReference",void 0),i(this,"zoomReference",void 0),i(this,"resizeReference",void 0),i(this,"oldZoom",void 0),i(this,"isZoomChanged",void 0),i(this,"isOutOfBounds",void 0),i(this,"isScrollbarResized",!0),i(this,"scrollbarWidthCache",void 0),i(this,"defaultWidth",void 0),i(this,"defaultHeight",void 0),this.tab=t,this.viewerContext=e;const{viewerConfig:s}=e;this.rows=s.rows,this.columns=s.columns,this.zoom=s.zoom,this.oldZoom=s.zoom,this.displayMode=s.displayMode,this.fitMode=s.fitMode,this.direction=s.scrollDirection,this.isZoomChanged=!1,this.isOutOfBounds=!1;}get isVertical(){return "vertical"===this.direction}get isContinuousDisplay(){return "continuous"===this.displayMode}get isSingleDisplay(){return "single"===this.displayMode}get scrollbarWidth(){if(!this.isScrollbarResized&&this.scrollbarWidthCache)return this.scrollbarWidthCache;const t=Ox();return this.scrollbarWidthCache=t,this.isScrollbarResized=!1,t}getRealRowAndColumnContinuous(){const{rows:t,columns:e,isVertical:i}=this,{total:s}=this.tab;let n=t,o=e;return i?(n=Math.ceil(s/e),s<=e&&(o=Math.max(1,s),n=1)):(o=Math.ceil(s/t),s<=t&&(n=Math.max(1,s),o=1)),{realRow:n,realColumn:o}}getRealRowAndColumnThumbnail(){const{total:t}=this.tab,{rows:e,columns:i,isVertical:s}=this,n=s?i:Math.ceil(t/e);return {realRow:s?Math.ceil(t/i):e,realColumn:n}}getZoomOriginCord(){const{zoomOrigin:t}=this.viewerContext.viewerConfig,e={start:0,center:.5,end:1};return {originX:this.currentViewportWidth*e[t.x],originY:this.currentViewportHeight*e[t.y]}}getMargin(){return this.formatMarginAndGap(this.viewerContext.viewerConfig.margin)}getPageBorderWidth(){const{styleService:t}=this.viewerContext,{borderWidth:e}=t.getParsedPageStyle();return {borderWidth:e,selectedBorderWidth:t.getParsedSelectedPageStyle().borderWidth,hoveredBorderWidth:t.getParsedHoveredPageStyle().borderWidth}}getPages(){return this.tab.allPages}getParsedPageNumberStyle(t,e){return this.viewerContext.styleService.getParsedPageNumberStyle({width:t,height:e})}getPageNumberStyle(){return this.viewerContext.viewerConfig.pageNumberStyle}getParsedCheckboxStyle(t,e){return this.viewerContext.styleService.getParsedCheckboxStyle({width:t,height:e})}getParsedPageStyle(){return this.viewerContext.styleService.getParsedPageStyle()}getParsedCurrentPageStyle(){return this.viewerContext.styleService.getParsedCurrentPageStyle()}getParsedSelectedPageStyle(){return this.viewerContext.styleService.getParsedSelectedPageStyle()}getParsedHoveredPageStyle(){return this.viewerContext.styleService.getParsedHoveredPageStyle()}getParsedPlaceholderStyle(){return this.viewerContext.styleService.getParsedPlaceholderStyle()}getParsedCanvasStyle(){return this.viewerContext.styleService.getParsedCanvasStyle()}formatMarginAndGap(t){if(Xs(t)){if(/px/.test(t)){const[e]=t.match(/(\d+)/);return parseInt(e,10)}const e=this.viewerContext.rendererService.getCanvasDom();if(/%/.test(t)){const i=e.width/xn(),[s]=t.match(/(\d+)/);return i*parseInt(s,10)/100}if(/em/.test(t)){const i=getComputedStyle(e).fontSize,[s]=i.match(/(\d+)/),[n]=t.match(/(\d+)/);return parseInt(s,10)*parseInt(n,10)}}return js(t)?t:parseInt(t,10)}setZoom(t){this.oldZoom=this.zoom,this.zoom=t,this.tab.allPages.forEach((e=>{e.zoom=t;}));}getTabOffset(){const{maxScrollLeft:t,maxScrollTop:e,currentLayoutWidth:i,currentLayoutHeight:s,currentViewportWidth:n,currentViewportHeight:o,scrollLeft:r,scrollTop:a}=this;let l=0,h=0;const c=this.getParsedCanvasStyle().borderWidth||0;return l=t>0?-r:(n-(i-2*c))/2,h=e>0?-a:(o-(s-2*c))/2,{offsetX:l,offsetY:h}}parseReferenceDefault(){const{tab:t,maxScrollLeft:e,maxScrollTop:i}=this,s=t.current,n=this.placeholderPages[s];if(!n)return {scrollLeft:0,scrollTop:0};const o=this.getMargin();let r=n.x-o,a=n.y-o;return this.isContinuousDisplay&&(r=n.pageX-o,a=n.pageY-o),r=Gs(r,0,e),a=Gs(a,0,i),{scrollLeft:r,scrollTop:a}}parseReferenceZoom(t,e,i){if(_s(t)&&(t=this.zoomReference),_s(e)||_s(i)){const{originX:t,originY:s}=this.getZoomOriginCord();e=t,i=s;}let{scrollLeft:s,scrollTop:n}=this.parseReference(t,e,i);const{maxScrollLeft:o,maxScrollTop:r}=this;return s=Gs(s,0,o),n=Gs(n,0,r),{scrollLeft:s,scrollTop:n}}parseReferenceResize(){const{resizeReference:t}=this;let{scrollLeft:e,scrollTop:i}=this.parseReference(t,0,0);const{maxScrollLeft:s,maxScrollTop:n}=this;return e=Gs(e,0,s),i=Gs(i,0,n),{scrollLeft:e,scrollTop:i}}updateReference(){const{currentViewportWidth:t,currentViewportHeight:e}=this,i=this.generateReference(0,0),s=this.generateReference(t/2,e/2),{originX:n,originY:o}=this.getZoomOriginCord(),r=this.generateReference(n,o);this.defaultReference=s,this.resizeReference=i,this.zoomReference=r;}generateReference(t,e){let i,s,n,o,r=null,a=Number.MAX_VALUE;const{offsetX:l,offsetY:h}=this.getTabOffset(),{zoom:c}=this;this.placeholderPages.forEach((d=>{if(d&&("single"===this.displayMode&&d.uid===this.tab.currentUid||"continuous"===this.displayMode)){const u=d.x+l,p=d.y+h,g=new on(u+d.width/2,p+d.height/2).distanceTo({x:t,y:e});g<a&&(a=g,r=d.uid,t<u?(i="start",n=u-t):t>u+d.width?(i="end",n=t-(u+d.width)):(i="center",n=(t-u)/c),e<p?(s="start",o=p-e):e>p+d.height?(s="end",o=e-(p+d.height)):(s="center",o=(e-p)/c));}}));return {pageX:n,pageY:o,positionX:i,positionY:s,pageUid:r}}parseReference(t,e,i){const{pageX:s,pageY:n,positionX:o,positionY:r,pageUid:a}=t,l=this.placeholderPages.find((t=>t.uid===a)),{zoom:h}=this;let c,d,u=0,p=0;return l&&("start"===o?c=l.x-s:"center"===o?c=l.x+s*h:"end"===o&&(c=l.x+l.width+s),"start"===r?d=l.y-n:"center"===r?d=l.y+n*h:"end"===r&&(d=l.y+l.height+n)),u=c-e,p=d-i,{scrollLeft:u,scrollTop:p}}getScrollValuesByCurrentChanged(){const{placeholderPages:t,currentViewportWidth:e,currentViewportHeight:i,startRow:s,endRow:n,startColumn:o,endColumn:r,isVertical:a}=this,{current:l}=this.tab,h=this.getMargin(),{realRow:c,realColumn:d}=this.getRealRowAndColumnThumbnail();let u=l,p=l;a?(u=s*d+o,p=n*d+r):(u=o*c+s,p=r*c+n);let g=Gs(this.scrollLeft,0,this.maxScrollLeft),f=Gs(this.scrollTop,0,this.maxScrollTop);if(l>=u&&l<=p)return {scrollLeft:g,scrollTop:f};const v=t[l];return v&&(a?(g=0,l<u?f=v.y-h:l>p&&(f=v.y+v.height+h-i)):(f=0,l<u?g=v.x-h:l>p&&(g=v.x+v.width+h-e))),g=Gs(g,0,this.maxScrollLeft),f=Gs(f,0,this.maxScrollTop),{scrollLeft:g,scrollTop:f}}getCurrentByScroll(){let t=this.tab.current;const{placeholderPages:e,currentViewportWidth:i,currentViewportHeight:s,startRow:n,endRow:o,startColumn:r,endColumn:a,isVertical:l}=this,{realRow:h,realColumn:c}=this.getRealRowAndColumnContinuous(),d=i/2,u=s/2,{offsetX:p,offsetY:g}=this.getTabOffset(),{current:f}=this.tab;let v=Number.MAX_VALUE,m=Number.MAX_VALUE,y=l?Math.floor(f/c):f%h,x=l?f%c:Math.floor(f/h);for(let t=n;t<=o;t++){const i=e[t*c];if(!i)continue;const{y:s,height:n}=i,o=s+g,r=o-u,a=u-o-n;if(r<=0&&a<=0){y=t;break}r>0&&r<m?(m=r,y=t):a>0&&a<m&&(m=a,y=t);}for(let t=r;t<=a;t++){const i=e[r];if(!i)continue;const{x:s,width:n}=i,o=s+p,a=o-d,l=d-o-n;if(a<=0&&l<=0){x=t;break}a>0&&a<v?(v=a,x=t):l>0&&l<v&&(v=l,x=t);}return t=y*c+x,t===this.tab.current?null:t}setTabScrollValue(t,e){this.scrollLeft=t,this.scrollTop=e;const{offsetX:i,offsetY:s}=this.getTabOffset();this.tab.setPosition({x:i,y:s});}}class Wx extends Ua{constructor(t,e){super({name:"DocTab"}),i(this,"uid",void 0),i(this,"docType",void 0),i(this,"docName",void 0),i(this,"doc",void 0),i(this,"isActive",!1),i(this,"currentUid",void 0),i(this,"total",void 0),i(this,"selected",void 0),i(this,"context",void 0),i(this,"viewerContext",void 0),i(this,"shiftReference",void 0),i(this,"oldCurrentUid",void 0),i(this,"oldCurrent",void 0),i(this,"oldTotal",void 0),i(this,"pageMap",new Map),i(this,"textPages",void 0),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"startCharRect",void 0),i(this,"endCharRect",void 0),i(this,"selectedTextsCache",void 0),i(this,"visibleChildren",[]),i(this,"preloadChildren",[]),i(this,"isTab",!0),i(this,"allPages",[]),i(this,"hoveredPage",void 0),this.doc=t,this.uid=t.uid,this.docName=t.name,this.docType=t.type,this.total=0,this.selected=[],this.viewerContext=e,this.context=new _x(this,e),this.oldCurrent=-1,this.oldCurrentUid=void 0,t.pages.forEach(((t,e)=>{const i=this.createPage(t);i.pageIndex=e,this.pageMap.set(t,i),this.allPages.push(i);})),this.total=t.pages.length,this.total>0&&(this.updateOldInfo(),this.currentUid=this.allPages[this.scrollToLatest?this.total-1:0].uid),this.oldTotal=0;}get scrollToLatest(){let{scrollToLatest:t}=this.viewerContext.viewer.group.config;return _s(t)&&(t=this.viewerContext.viewerConfig.scrollToLatest),t}get pages(){return this.childNodes}get current(){return this.currentUid?this.uidToIndex(this.currentUid):-1}get isDocType(){return "document"===this.docType}createPage(t){const{pageStyle:e,pageNumberStyle:i,checkboxStyle:s,removeBtnStyle:n,blankFillColor:o}=this.viewerContext.viewerConfig,r=function(t){const{border:e,background:i}=t;let s={};e&&(s=Rx(e));return {background:i,...s}}(e),{width:a,height:l}=this.viewerContext.getPageRenderSize(t);return new Dx({tab:this,uid:t,formattedPageStyle:r,pageNumberStyle:i,checkboxStyle:s,removeBtnStyle:n,blankFillColor:o,style:{pointerEvents:"auto",width:a,height:l}})}updateOldInfo(){this.oldCurrentUid=this.currentUid,this.oldCurrent=this.current,this.oldTotal=this.total;}updateViewportSize(t,e){this.context.viewportWidth=t,this.context.viewportHeight=e;}rename(t){this.docName=t;}getCurrentPage(){return this.getPageByUid(this.currentUid)}getAllPageUids(){return this.allPages.map((t=>t.uid))}freshPageIndex(){this.allPages.forEach(((t,e)=>{t.pageIndex=e;}));}appendPages(t,e,i){const s=t.length;if(!s)return;const n=js(i);if(t.forEach(((t,e)=>{const s=this.createPage(t);this.pageMap.set(t,s),js(i)?this.allPages.splice(i+e,0,s):this.allPages.push(s);})),this.freshPageIndex(),this.total=this.allPages.length,e)this.currentUid=this.indexToUid(n?i+s-1:this.total-1),this.updateDefaultReference();else if(!this.currentUid){var o;this.currentUid=null===(o=this.allPages[0])||void 0===o?void 0:o.uid,this.updateDefaultReference();}}deletePages(t){this.updateOldInfo();const e=[...t],i=t.includes(this.currentUid);if(i){const i=t.indexOf(this.currentUid);e.splice(i,1),e.push(this.currentUid);}e.forEach((t=>{const e=this.getPageByUid(t);if(i&&e.uid===this.currentUid){if(1===this.total)this.currentUid=null;else {const{current:t}=this,e=t===this.total-1?-1:1;this.currentUid=this.indexToUid(t+e);}this.updateDefaultReference();}if(En(this.selected,t),this.removeChild(e),En(this.allPages,e),this.pageMap.delete(e.uid),this.total-=1,this.textPages){const t=this.textPages.findIndex((t=>t.pageUid===e.uid));t>-1&&this.textPages.splice(t,1);}})),this.freshPageIndex(),0===this.total&&(this.oldTotal=0,this.currentUid=null,this.selected=[],this.visibleChildren=[],this.preloadChildren=[],this.context.placeholderPages=[]);}deleteAllPages(){this.updateOldInfo(),this.childNodes.slice().forEach((t=>{this.removeChild(t);})),this.allPages=[],this.pageMap.clear(),this.visibleChildren=[],this.preloadChildren=[],this.currentUid=null,this.selected=[],this.context.placeholderPages=[],this.total=0,this.oldTotal=0;}movePages(t,e){this.updateOldInfo();const i=Mn(this.allPages,t,e);return this.freshPageIndex(),i}switchPage(t,e){this.updateOldInfo();const i=In(this.allPages,t,e);return i&&this.freshPageIndex(),i}reorderPages(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.updateOldInfo();const e=Bn(this.allPages,t);return e&&this.freshPageIndex(),e}gotoPage(t){return 0===this.total?-1:(this.updateOldInfo(),t!==this.current&&(t=Gs(t,0,this.total-1),this.currentUid=this.indexToUid(t),this.updateDefaultReference()),this.updateShiftReference(),t)}selectPages(t){this.allPages.forEach((e=>{e.isSelected=t.includes(e.uid);})),this.selected=t;}selectPagesByIndices(t){const e=this.indicesToUids(t);this.selectPages(e);}getSelected(){return this.selected.slice()}getSelectedIndices(){return this.selected.map((t=>this.uidToIndex(t)))}getPageByIndex(t){return this.allPages[t]}getPageByUid(t){return this.pageMap.get(t)}getPageIndex(t){return this.pageMap.get(t.uid)?t.pageIndex:-1}uidToIndex(t){return this.pageMap.get(t)?this.pageMap.get(t).pageIndex:-1}uidsToIndices(t){return t.map((t=>this.uidToIndex(t)))}indexToUid(t){var e;return null===(e=this.allPages[t])||void 0===e?void 0:e.uid}indicesToUids(t){return t.map((t=>this.indexToUid(t)))}updateShiftReference(){this.shiftReference=this.currentUid;}updateDefaultReference(){this.context.defaultReference={pageUid:this.currentUid};}setTextSelection(t,e,i,s,n){const o=new Map;if(this.textPages)for(let e=0;e<this.textPages.length;e++){const i=this.textPages[e],s=this.getPageByUid(i.pageUid);s&&(0!==e&&e!==this.textPages.length-1&&t.find((t=>t.pageUid===i.pageUid))&&i.pageUid!==t[t.length-1].pageUid&&i.pageUid!==t[0].pageUid?o.set(i.pageUid,i):s.setTextSelection(null));}this.selectedTextsCache=null,this.textPages=t,this.startTextPosition=s,this.endTextPosition=n,this.startCharRect=e,this.endCharRect=i,t.forEach(((s,n)=>{const r=this.getPageByUid(s.pageUid);o.has(s.pageUid)||r.setTextSelection(s.lines.map((t=>t.selectedRect))),r.setStartCharRect(0===n?e:null),r.setEndCharRect(n===t.length-1?i:null);}));}clearTextSelection(){var t;return !(null===(t=this.textPages)||void 0===t||!t.length)&&(this.textPages.forEach((t=>{const e=this.getPageByUid(t.pageUid);e&&(e.setTextSelection([]),e.setStartCharRect(null),e.setEndCharRect(null));})),this.textPages=null,this.startTextPosition=null,this.endTextPosition=null,this.selectedTextsCache=null,!0)}hasSelectedTexts(){return !!this.textPages}getTextSelectionLines(){return this.textPages?this.textPages:null}getTextSelectionControlPointsRect(){if(!this.textPages)return [];const t=[];return this.textPages.forEach((e=>{const i=this.getPageByUid(e.pageUid),s=i.getTextSelectionControlPointsRect();i.isVisible&&s.length&&t.push(...s);})),t}destroy(){super.destroy(),this.deleteAllPages(),this.isActive=!1,this.doc=null,this.context=null,this.viewerContext=null,this.isDestroyed=!0;}}class Fx extends Qn{constructor(t){super(),i(this,"tabActivationStack",void 0),i(this,"tabs",void 0),i(this,"activeTabUid",void 0),i(this,"context",void 0),this.tabActivationStack=[],this.tabs=new Map,this.context=t;}dispose(){this.clearTabs(),this.tabActivationStack.length=0,super.dispose();}updateViewportSize(t,e){const i=this.getActiveTab();null!=i&&i.isDocType&&i.updateViewportSize(t,e);}createTab(t){if(this.tabs.has(t.uid))return this.tabs.get(t.uid);let e=null;return "document"===t.type&&(e=new Wx(t,this.context)),this.context.viewerConfig.enableMultiTab||this.clearTabs(),this.tabs.set(e.uid,e),e}closeTab(t){if(!this.tabs.has(t))return !1;const{tabActivationStack:e}=this;if(e.includes(t)){const i=e.indexOf(t);e.splice(i,1);}return this.getTab(t).isActive=!1,this.tabs.delete(t),this.activeTabUid===t&&(this.activeTabUid=e[e.length-1]),!0}getTab(t){return this.tabs.get(t)}getDocTab(t){const e=this.getTab(t);return null!=e&&e.isDocType?e:null}hasTab(t){return this.tabs.has(t)}getActiveTab(){return this.tabs.get(this.activeTabUid)}getActiveTabUid(){return this.activeTabUid}getAllTabs(){return Array.from(this.tabs.values())}activateTab(t){if(!this.tabs.has(t))return !1;const{tabActivationStack:e}=this;if(this.context.viewerConfig.enableMultiTab){if(e.includes(t)){const i=e.indexOf(t);e.splice(i,1);}}else e.length=0;return e.push(t),this.activeTabUid=t,this.tabs.forEach((e=>{e.isActive=e.uid===t;})),!0}clearTabs(){this.getAllTabs().forEach((t=>{t.destroy();})),this.tabs.clear();}resizeScrollbar(){this.tabs.forEach((t=>{t.context.isScrollbarResized=!0;}));}}class Hx{constructor(t){i(this,"parsedPageStyleCache",void 0),i(this,"parsedCurrentPageStyleCache",void 0),i(this,"parsedSelectedPageStyleCache",void 0),i(this,"parsedHoveredPageStyleCache",void 0),i(this,"parsedPlaceholderStyleCache",void 0),i(this,"parsedCheckboxStyleCache",void 0),i(this,"parsedPageNumberStyleCache",void 0),i(this,"parsedQuadSelectionStyleCache",void 0),i(this,"parsedCanvasStyleCache",void 0),i(this,"context",void 0),i(this,"isPageStyleChanged",void 0),i(this,"isCurrentPageStyleChanged",void 0),i(this,"isSelectedPageStyleChanged",void 0),i(this,"isHoveredPageStyleChanged",void 0),i(this,"isPlaceholderStyleChanged",void 0),i(this,"isCheckboxStyleChanged",void 0),i(this,"isPageNumberStyleChanged",void 0),i(this,"isQuadSelectionStyleChanged",void 0),i(this,"isCanvasStyleChanged",void 0),this.context=t;}getParsedCanvasStyle(){return !this.isCanvasStyleChanged&&this.parsedCanvasStyleCache||(this.parsedCanvasStyleCache=Vx(this.context.viewerConfig.canvasStyle),this.isCanvasStyleChanged=!1),this.parsedCanvasStyleCache}getParsedCheckboxStyle(t){return !this.isCheckboxStyleChanged&&this.parsedCheckboxStyleCache||(this.parsedCheckboxStyleCache=Vx(this.context.viewerConfig.checkboxStyle,t),this.isCheckboxStyleChanged=!1),this.parsedCheckboxStyleCache}getParsedPageNumberStyle(t){return !this.isPageNumberStyleChanged&&this.parsedPageNumberStyleCache||(this.parsedPageNumberStyleCache=Vx(this.context.viewerConfig.pageNumberStyle,t),this.isPageStyleChanged=!1),this.parsedPageNumberStyleCache}getParsedPageStyle(){return !this.isPageStyleChanged&&this.parsedPageStyleCache||(this.parsedPageStyleCache=Vx(this.context.viewerConfig.pageStyle),this.isPageStyleChanged=!1),this.parsedPageStyleCache}getParsedCurrentPageStyle(){return !this.isCurrentPageStyleChanged&&this.parsedCurrentPageStyleCache||(this.parsedCurrentPageStyleCache=Vx(this.context.viewerConfig.currentPageStyle),this.isCurrentPageStyleChanged=!1),this.parsedCurrentPageStyleCache}getParsedSelectedPageStyle(){return !this.isSelectedPageStyleChanged&&this.parsedSelectedPageStyleCache||(this.parsedSelectedPageStyleCache=Vx(this.context.viewerConfig.selectedPageStyle),this.isSelectedPageStyleChanged=!1),this.parsedSelectedPageStyleCache}getParsedHoveredPageStyle(){return !this.isHoveredPageStyleChanged&&this.parsedHoveredPageStyleCache||(this.parsedHoveredPageStyleCache=Vx(this.context.viewerConfig.hoveredPageStyle),this.isHoveredPageStyleChanged=!1),this.parsedHoveredPageStyleCache}getParsedPlaceholderStyle(){return !this.isPlaceholderStyleChanged&&this.parsedPlaceholderStyleCache||(this.parsedPlaceholderStyleCache=Vx(this.context.viewerConfig.placeholderStyle),this.isPlaceholderStyleChanged=!1),this.parsedPlaceholderStyleCache}getParsedQuadSelectionStyle(){return !this.isQuadSelectionStyleChanged&&this.parsedQuadSelectionStyleCache||(this.parsedQuadSelectionStyleCache=Vx(this.context.viewerConfig.quadSelectionStyle),this.isQuadSelectionStyleChanged=!1),this.parsedQuadSelectionStyleCache}isBorderWidthEqualHovered(){const{viewerConfig:t}=this.context;return Ex(t.pageStyle)===Ex(t.hoveredPageStyle)}isSelectedBorderWidthEqualHovered(){const{viewerConfig:t}=this.context;return Ex(t.selectedPageStyle)===Ex(t.hoveredPageStyle)}isSelectedBorderWidthEqualNormal(){const{viewerConfig:t}=this.context;return Ex(t.pageStyle)===Ex(t.selectedPageStyle)}}function Vx(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{width:0,height:0};const i={};if(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{border:i,ctrlBorder:s}=t;if(!_s(i)){const t=Rx(i);Object.assign(e,t);}if(!_s(s)){const t=Rx(s);Object.assign(e,{ctrlBorderWidth:t.borderWidth,ctrlBorderColor:t.borderColor,ctrlBorderStyle:t.borderStyle});}}(t,i),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};zx.forEach((i=>{_s(t[i])||(e[i]=Cr(t[i]).value||0);}));}(t,i),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};$x.forEach((i=>{_s(t[i])||(e[i]=t[i]);}));}(t,i),function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!_s(t.width)&&(i.width=Mx(t.width,e.width),_s(t.translateX)||(i.translateX=Mx(t.translateX,i.width)),!_s(t.borderRadius))){const e=Mx(t.borderRadius,i.width);i.borderRadiusX=Math.max(0,Math.min(e,i.width/2));}if(!_s(t.height)&&(i.height=Mx(t.height,e.height),_s(t.translateY)||(i.translateY=Mx(t.translateY,i.height)),!_s(t.borderRadius))){const e=Mx(t.borderRadius,i.height);i.borderRadiusY=Math.max(0,Math.min(e,i.height/2));}if(!_s(t.borderRadius)){const s=Mx(t.borderRadius,e.width);i.borderRadius=Math.max(0,Math.min(s,e.height/2,e.width/2));}if(!_s(t.ctrlBorderRadius)){const e=Mx(t.ctrlBorderRadius,i.ctrlWidth);i.ctrlBorderRadius=Math.max(0,Math.min(e,i.ctrlWidth/2,i.ctrlHeight/2));}jx.forEach((s=>{const n=["left","right"].includes(s)?e.width:e.height,o=Pr(t[s]);let r=o.value;"%"===o.unit&&(r=n*o.value/100),i[s]=r;}));}(t,e,i),t.left||t.right||t.bottom||t.top){const{left:s,top:n,right:o,bottom:r,width:a,height:l,translateX:h,translateY:c}=i;""!==t.left?i.x=s+h||0:""!==t.right&&js(a)?i.x=e.width-a-o+h||0:i.x=0,""!==t.top?i.y=n+c||0:""!==t.bottom&&js(l)?i.y=e.height-l-r+c||0:i.y=0;}return i}const zx=["borderWidth","ctrlBorderWidth","checkMarkLineWidth","fontSize","ctrlWidth","ctrlHeight"],$x=["background","maskColor","color","borderColor","borderStyle","invalidBorderColor","ctrlBorderColor","ctrlBackground","ctrlBorderStyle","invalidCtrlBorderColor","checkMarkColor","onPage","opacity","visibility","visibleByHover","fontFamily","textAlign","textBaseline","lineJoin","lineCap"],jx=["left","top","right","bottom"];const Xx="visible",Gx="hidden";class Yx{constructor(t){i(this,"context",void 0),this.context=t;}handleVisibility(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.context.isDestroyed||t.isDestroyed||!t.total||!t.isActive)return;const{context:i}=this;if(i.isDefaultViewer?t.context.isContinuousDisplay?this.continuousVisibility(t,e):t.context.isSingleDisplay&&this.singleVisibility(t):i.isThumbnailViewer?this.thumbnailVisibility(t,e):i.isPerspectiveViewer&&t.context.isSingleDisplay&&this.singleVisibility(t),t.context.pagePreloadChanges.length){t.context.pagePreloadChanges.forEach((e=>{if(e.from&&!e.to){const i=t.getPageByUid(e.pageUid);i&&(i.isLoaded=!1);}}));const e=Mf.create(t.uid,i.uid,i.viewerConfig.viewerMode,t.context.pagePreloadChanges);i.core.viewerService.onPagePreloadChanged.emit(e);}}thumbnailVisibility(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{total:i}=t;if(!i)return;const s=t.context;if(s.isOutOfBounds)return void t.allPages.forEach((t=>{t.updateStyle({visibility:"hidden"});}));const{rows:n,columns:o,placeholderPages:r,preloadCount:a,isVertical:l}=s,{width:h,height:c}=r[0],d=s.getParsedPageStyle(),u=s.getParsedCurrentPageStyle(),p=s.getParsedSelectedPageStyle(),g=s.getParsedHoveredPageStyle(),f=s.getParsedPlaceholderStyle(),v=s.getParsedPageNumberStyle(h,c),m=s.getParsedCheckboxStyle(h,c),{visibility:y,top:x,bottom:w,onPage:b,height:S}=v;let C=0;const P="visible"===y,T=s.getPageNumberStyle();if(P){const t=""!==T.top?x:w||0;b||(C=""!==T.top?S+t:0);}const{realColumn:A,realRow:k}=s.getRealRowAndColumnThumbnail(),{startRow:D,endRow:R}=this.getVisibleRow(t,k,A),{startColumn:E,endColumn:M}=this.getVisibleColumn(t,k,A);t.context.startRow=D,t.context.endRow=R,t.context.startColumn=E,t.context.endColumn=M;const I=Bx(u.borderWidth),B=[];t.visibleChildren=[],t.preloadChildren=[],t.allPages.forEach(((e,i)=>{e.visibleSortIndex=i;const s=l?Math.floor(i/o):i%n,r=l?i%o:Math.floor(i/n),h=s>=D&&s<=R&&r>=E&&r<=M,c=s>=D-a&&s<=R+a&&r>=E-a&&r<=M+a,y=h?Xx:Gx;e.isPreload!==c&&(B.push({from:e.isPreload,to:c,pageUid:e.uid,index:i}),e.isPreload&&!c&&(this.context.cancelLoadVisiblePartData(e.uid),this.context.cancelGetDefaultRenderPage(e.uid))),e.isPreload=c,c&&t.preloadChildren.push(e);let x=!1;if(e.isVisible&&!h?t.childNodes.includes(e)&&t.removeChild(e):!e.isVisible&&h&&(x=!0),e.needLayout=x,e.isVisible!==h&&e.updateStyle({visibility:y}),h){t.visibleChildren.push(e),t.childNodes.includes(e)||t.appendChild(e);let s={borderWidth:0,background:"#ffffff00"};e.isDragging&&(s=f);let n=d;e.isHovered&&(n=g),e.isSelected&&(n=p);const o=Bx(n.borderWidth);if(e.updateStyle({visibility:y,...s}),e.borderBox.updateStyle({...n,visibility:y,borderWidth:o}),P){let t=v.y;b||(t=""!==T.top?-C:v.y+v.bottom),e.pageNumber.parsedPageNumberStyle={...v,y:t},e.pageNumber.updateText((i+1).toString());}e.pageNumber.updateStyle({visibility:v.visibility,zIndex:v.onPage?1:0});let r=m.visibility;m.visibleByHover&&(r=e.isHovered||e.isSelected?m.visibility:"hidden"),e.checkbox.parsedCheckboxStyle={...m},e.checkbox.updateStyle({visibility:r}),e.checkbox.checked=e.isSelected,e.curBox.updateStyle({...u,visibility:e.uid===t.currentUid?Xx:Gx,borderWidth:I});}})),t.context.pagePreloadChanges=B,t.childNodes.sort(((t,e)=>t.visibleSortIndex-e.visibleSortIndex)),t.visibleChildren.forEach((i=>{if(!e&&!i.needLayout)return;const n=t.getPageIndex(i),o=s.placeholderPages[n];if(!o)return;const{pageWidth:r,pageHeight:a,borderBoxWidth:l,borderBoxHeight:h,x:c,y:u}=o;let f=d.borderWidth;i.isHovered&&(f=g.borderWidth),i.isSelected&&(f=p.borderWidth),f=Bx(f);let v=l-2*f,m=h-2*f;v=Math.max(v,0),m=Math.max(m,0);const y=i.rWidth,x=i.rHeight;let w=y,b=x,S=1;(y>v||x>m)&&(y/x>v/m?(S=v/y,w=v,b=x*S):(S=m/x,b=m,w=y*S)),i.zoom=S;const P=Ux(c),T=Ux(u+C);let A=f+(v-w)/2,k=f+(m-b)/2;A=Ux(A),k=Ux(k);const D=Lx(y),R=Lx(x),E=y*(1-S)/2,M=x*(1-S)/2,I=i.cropWidth,B=i.cropHeight,U=A-E-(I-D)/2,L=k-M-(B-R)/2,O=A-E,N=k-M,_=D,W=R,F=A,H=k,V=Lx(w),z=Lx(b);i.setPage(P,T,r,a),i.setBorderBox(0,0,l,h,f),i.setCropBox(U,L,I,B,S,i.rotation),i.setRealTimeBox(O,N,_,W,S);const{width:$,height:j}=s.viewerContext.getPageRenderSize(i.uid);i.setMediaBox(-i.cropLeft,-i.cropTop,$,j),i.setImage(i.mediaBoxRect.left,i.mediaBoxRect.top,$,j),i.setCurBox(F,H,V,z);}));}continuousVisibility(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{preloadCount:i,isVertical:s}=t.context,n=t.context.getParsedPageStyle(),o=t.context.getParsedCurrentPageStyle(),{realRow:r,realColumn:a}=t.context.getRealRowAndColumnContinuous(),{startRow:l,endRow:h}=this.getVisibleRow(t,r,a),{startColumn:c,endColumn:d}=this.getVisibleColumn(t,r,a);t.context.startRow=l,t.context.endRow=h,t.context.startColumn=c,t.context.endColumn=d;const u=Bx(n.borderWidth),p=Bx(o.borderWidth),g=[];t.visibleChildren=[],t.preloadChildren=[],t.allPages.forEach(((e,f)=>{e.visibleSortIndex=f;const v=s?Math.floor(f/a):f%r,m=s?f%a:Math.floor(f/r),y=v>=l&&v<=h&&m>=c&&m<=d,x=v>=l-i&&v<=h+i&&m>=c-i&&m<=d+i;e.isPreload!==x&&(g.push({from:e.isPreload,to:x,pageUid:e.uid,index:f}),e.isPreload&&!x&&(this.context.cancelLoadVisiblePartData(e.uid),this.context.cancelGetDefaultRenderPage(e.uid))),e.isPreload=x,x&&t.preloadChildren.push(e);let w=!1;e.isVisible&&!y?t.childNodes.includes(e)&&(e.visiblePartData=null,e.visiblePart=null,t.removeChild(e)):!e.isVisible&&y&&(w=!0),e.needLayout=w,e.isVisible!==y&&e.updateStyle({visibility:y?Xx:Gx}),y&&(t.visibleChildren.push(e),t.childNodes.includes(e)||t.appendChild(e),e.checkbox.updateStyle({visibility:Gx}),e.pageNumber.updateStyle({visibility:Gx}),e.curBox.updateStyle({...o,visibility:e.uid===t.currentUid?Xx:Gx,borderWidth:p}),e.borderBox.updateStyle({...n,borderWidth:u}));})),t.context.pagePreloadChanges=g,t.childNodes.sort(((t,e)=>t.visibleSortIndex-e.visibleSortIndex));const f=t.context,v=2*n.borderWidth;t.visibleChildren.forEach((i=>{if(!e&&!i.needLayout)return;const s=t.getPageIndex(i),{zoom:n}=i,o=i.rWidth,r=i.rHeight,a=o*n,l=r*n,h=f.placeholderPages[s];if(!h)return;const{pageX:c,pageY:d}=h;let p=a+v,g=l+v;p=Lx(p),g=Lx(g);const m=Ux(u),y=m,x=Lx(o),w=Lx(r),b=o*(1-n)/2,S=r*(1-n)/2,C=m,P=m,T=Lx(a),A=Lx(l),k=i.cropWidth,D=i.cropHeight,R=m-b-(k-x)/2,E=y-S-(D-w)/2,M=m-b,I=y-S;i.setPage(c,d,p,g),i.setBorderBox(0,0,p,g),i.setCropBox(R,E,k,D,n,i.rotation),i.setRealTimeBox(M,I,o,r,n);const{width:B,height:U}=f.viewerContext.getPageRenderSize(i.uid);i.setMediaBox(-i.cropLeft,-i.cropTop,B,U),i.setImage(i.mediaBoxRect.left,i.mediaBoxRect.top,B,U),i.setCurBox(C,P,T,A);}));}singleVisibility(t){const{preloadCount:e}=t.context,{current:i,total:s}=t,n=t.getCurrentPage();if(!n)return;const o=t.context.getParsedPageStyle(),r=Math.max(i-e,0),a=Math.min(i+e,s-1);n.checkbox.updateStyle({visibility:Gx}),n.pageNumber.updateStyle({visibility:Gx});const l=Bx(o.borderWidth),h=[];t.visibleChildren=[],t.preloadChildren=[],t.allPages.forEach(((e,i)=>{const s=i>=r&&i<=a,c=e.uid===n.uid;e.isPreload!==s&&(h.push({from:e.isPreload,to:s,pageUid:e.uid,index:i}),e.isPreload&&!s&&(this.context.cancelLoadVisiblePartData(e.uid),this.context.cancelGetDefaultRenderPage(e.uid))),e.isPreload=s,s&&t.preloadChildren.push(e);let d=!1;e.isVisible&&!c?t.childNodes.includes(e)&&t.removeChild(e):!e.isVisible&&c&&(d=!0),e.needLayout=d,e.updateStyle({visibility:c?Xx:Gx}),c&&(t.visibleChildren.push(e),t.childNodes.includes(e)||t.appendChild(e),e.borderBox.updateStyle({...o,borderWidth:l}),e.curBox.updateStyle({visibility:Gx}));})),t.context.pagePreloadChanges=h;}getVisibleColumn(t,e,i){const{scrollLeft:s,placeholderPages:n,currentViewportWidth:o,isVertical:r}=t.context;let a=0,l=i-1;if(r&&this.context.isThumbnailViewer)return {startColumn:a,endColumn:l};let h=Number.MAX_VALUE,c=Number.MAX_VALUE,d=!1,u=!1;for(let t=0;t<i;t++){const i=n[r?t:t*e];if(!i)continue;const{x:p,width:g}=i;if(!d){const e=p-s;e<=0&&p+g-s>1?(d=!0,a=t):e>0&&e<h&&(h=e,a=t);}if(!u){const e=s+o,i=e-(p+g);p-e<-1&&i<=0?(u=!0,l=t):i>0&&i<c&&(c=i,l=t);}if(d&&u)break}return {startColumn:a,endColumn:l}}getVisibleRow(t,e,i){const{scrollTop:s,placeholderPages:n,currentViewportHeight:o,isVertical:r}=t.context;let a=0,l=e-1;if(!r&&this.context.isThumbnailViewer)return {startRow:a,endRow:l};let h=Number.MAX_VALUE,c=Number.MAX_VALUE,d=!1,u=!1;for(let t=0;t<e;t++){const e=n[r?t*i:t];if(!e)continue;const{y:p,height:g}=e;if(!d){const e=p-s;e<=0&&p+g-s>1?(d=!0,a=t):e>0&&e<h&&(h=e,a=t);}if(!u){const e=s+o,i=e-(p+g);p-e<-1&&i<=0?(u=!0,l=t):i>0&&i<c&&(c=i,l=t);}if(d&&u)break}return {startRow:a,endRow:l}}}const qx={tag:"div",id:"ddv-thumbnail-container",className:"ddv-thumbnail-container"},Jx={tag:"div",id:"ddv-main-container",className:"ddv-main-container",children:[{tag:"div",id:"ddv-scroller-and-canvas",className:"ddv-scroller-and-canvas",children:[{tag:"div",id:"ddv-canvas-container",className:"ddv-canvas-container",children:[]},{tag:"div",id:"ddv-scroll-container",className:"ddv-scroll-container",children:[{tag:"div",id:"ddv-scroll-content",className:"ddv-scroll-content"}]}]}]},Zx={tag:"div",id:"ddv-video-container",className:"ddv-video-container"},Qx={tag:"div",id:"ddv-audio-container",className:"ddv-audio-container"},Kx={tag:"div",id:"ddv-main-and-thumbnail",className:"ddv-main-and-thumbnail"},tw={tag:"div",id:"ddv-core",className:"ddv-core"};class ew extends Qn{constructor(t,e){super(),i(this,"container",void 0),i(this,"defaultDom",void 0),i(this,"mainAndThbContainer",void 0),i(this,"thumbnailContainer",void 0),i(this,"mainContainer",void 0),i(this,"scrollerAndCanvasContainer",void 0),i(this,"scrollContainer",void 0),i(this,"scrollContent",void 0),i(this,"canvasContainer",void 0),i(this,"annotationCanvasContainer",void 0),i(this,"videoContainer",void 0),i(this,"audioContainer",void 0),i(this,"rootDom",void 0),i(this,"hooks",void 0),i(this,"isBindContainer",!1),i(this,"viewportWidth",void 0),i(this,"viewportHeight",void 0),i(this,"context",void 0),i(this,"dpr",xn()),i(this,"hasScrollbarX",!1),i(this,"hasScrollbarY",!1),i(this,"winResizeTimer",void 0),this.context=t,this.hooks=e;const s=Sm(tw,t.postfix);this.defaultDom=s;}dispose(){var t,e;null===(t=this.rootDom)||void 0===t||t.remove(),null===(e=this.thumbnailContainer)||void 0===e||e.remove(),this.defaultDom=null,this.rootDom=null,this.thumbnailContainer=null,this.context=null,this.dpr=null,super.dispose();}createMainAndThbContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.mainAndThbContainer){const e=Sm(Kx,t);this.mainAndThbContainer=e,this.defaultDom.appendChild(e);}}createMainContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.mainContainer){const e=Sm(Jx,t);this.mainContainer=e,this.mainAndThbContainer.appendChild(e);const i=e.querySelector(`#ddv-scroller-and-canvas${t}`),s=e.querySelector(`#ddv-canvas-container${t}`),n=e.querySelector(`#ddv-scroll-container${t}`),o=e.querySelector(`#ddv-scroll-content${t}`);this.scrollerAndCanvasContainer=i,this.canvasContainer=s,this.scrollContainer=n,this.scrollContent=o;const r=t=>{t.target===e&&this.isBindContainer&&this.context.isInitialized&&this.context.resize();},{resizeService:a}=this.context.core;a.observe(e),a.onResizeObserver.on(r,this),this.context.hooks.destroy.on((()=>{a.unobserve(e);}),this);}}createThumbnailContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.thumbnailContainer){const e=Sm(qx,t);this.thumbnailContainer=e,this.mainAndThbContainer.insertBefore(e,this.mainContainer);}}createVideoContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.videoContainer){const e=Sm(Zx,t);this.mainContainer.appendChild(e);}}createAudioContainer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!this.audioContainer){const e=Sm(Qx,t);this.mainContainer.appendChild(e);}}getViewportSize(){if(!this.mainContainer)return {width:0,height:0};const{offsetWidth:t,offsetHeight:e}=this.getElSize(this.mainContainer),i=this.getCanvasBorderSize();return {width:t-2*i,height:e-2*i}}resetViewport(){const{scrollContent:t,canvasContainer:e,annotationCanvasContainer:i}=this;Ix(e,0,0),Ix(t,0,0);const{width:s,height:n}=this.getViewportSize();this.viewportWidth=s,this.viewportHeight=n,this.updateCanvasContainerSize();}resizeViewport(){const{canvasContainer:t,scrollContainer:e,annotationCanvasContainer:i}=this;Ix(t,0,0);const{offsetWidth:s,offsetHeight:n}=this.getElSize(e);this.viewportWidth=s,this.viewportHeight=n,this.updateCanvasContainerSize();}checkIsRound(t){const e=getComputedStyle(t);return {roundWidth:parseFloat(e.width)%1>=.5,roundHeight:parseFloat(e.height)%1>=.5}}getElSize(t){const{roundWidth:e,roundHeight:i}=this.checkIsRound(t);let{clientWidth:s,clientHeight:n,offsetWidth:o,offsetHeight:r}=t;return e&&(s-=1,o-=1),i&&(n-=1,r-=1),{clientWidth:s,clientHeight:n,offsetWidth:o,offsetHeight:r}}getMaxScrollValue(){const{scrollContainer:t}=this;let e=t.scrollWidth-t.clientWidth,i=t.scrollHeight-t.clientHeight;return this.hasScrollbarX||(e=0),this.hasScrollbarY||(i=0),{scrollLeft:e,scrollTop:i}}isViewerResized(){return this.scrollContainer.offsetWidth!==this.viewportWidth||this.scrollContainer.offsetHeight!==this.viewportHeight}isDPRChanged(){const t=xn();return this.dpr!==t&&(this.dpr=t,!0)}bindContainer(t){let e=t;return t&&Xs(t)&&(e=document.querySelector(`#${t}`)),e instanceof HTMLElement&&(e.appendChild(this.defaultDom),this.container=e,this.rootDom=this.defaultDom,this.isBindContainer=!0,this.context.resize(),!0)}unbindContainer(){if(!this.container||0===this.container.children.length)return !1;for(let t=0;t<this.container.children.length;t++)if(this.container.children[t]===this.rootDom){this.container.removeChild(this.rootDom);break}return this.isBindContainer=!1,!0}scrollTo(t,e){const{scrollContainer:i}=this;i.scrollTo?i.scrollTo(t,e):(i.scrollLeft=t,i.scrollTop=e);}scrollBy(t,e){const{scrollContainer:i}=this;i.scrollBy?i.scrollBy(t,e):(i.scrollLeft+=t,i.scrollTop+=e);}updateScrollerContentSize(t){const{currentLayoutWidth:e,currentLayoutHeight:i}=t.context,{scrollContent:s,canvasContainer:n,annotationCanvasContainer:o,scrollContainer:r}=this;Ix(n,10,10),Ix(s,e,i);let a=r.scrollWidth-r.clientWidth,l=r.scrollHeight-r.clientHeight;const h=getComputedStyle(r),c=getComputedStyle(s),d=parseFloat(h.width),u=parseFloat(h.height);d>=parseFloat(c.width)&&(a=0),u>=parseFloat(c.height)&&(l=0),t.context.maxScrollLeft=a,t.context.maxScrollTop=l;const p=a>0,g=l>0;let f=!1;p!==this.hasScrollbarX&&(this.hasScrollbarX=p,f=!0),p&&g||Ix(s,p?e:e-20,g?i:i-20),g!==this.hasScrollbarY&&(this.hasScrollbarY=g,f=!0),f&&this.context.clearCurrentTabOptimization(),this.updateCanvasContainerSize();}updateCanvasContainerSize(){const{scrollContainer:t,canvasContainer:e,annotationCanvasContainer:i}=this,{width:s,height:n}=getComputedStyle(this.scrollContainer);let o,r=parseFloat(s),a=parseFloat(n);t.offsetWidth!==t.clientWidth&&(js(o)||(o=Ox()),r-=o),t.offsetHeight!==t.clientHeight&&(js(o)||(o=Ox()),a-=o),Ix(e,r,a);}getCanvasBorderSize(){const{canvasContainer:t}=this;return (t.offsetWidth-t.clientWidth)/2}}class iw{constructor(){i(this,"canvasDom",void 0),i(this,"canvas",void 0),i(this,"renderer",void 0),i(this,"isInitialized",!1),i(this,"canvasWidth",0),i(this,"canvasHeight",0);}clear(){var t;const e=null===(t=this.canvas)||void 0===t?void 0:t.document.documentElement;if(!e)return;e.children.slice().forEach((t=>{e.removeChild(t);})),e.sortable.sorted=[];}appendDocToRoot(t){var e;const i=null===(e=this.canvas)||void 0===e?void 0:e.document.documentElement;if(i)if(t)if(0===i.children.length)i.appendChild(t);else {i.children.indexOf(t)<0&&i.replaceChild(t,i.children[0]);}else {const t=[...i.children];for(let e=t.length;e>=0;e--)i.removeChild(t[e]);}}render(t){var e;(null===(e=this.canvas)||void 0===e?void 0:e.document.documentElement)&&this.canvas.render();}initCanvas(t){let{container:e,width:i,height:s,limit1px:n}=t;const o=new jl({}),r=new Al({renderer:o,container:e,width:i,height:s});r.limit1px=n,this.canvasWidth=i,this.canvasHeight=s,this.renderer=o,this.canvas=r,this.canvasDom=r.contextService.getDomElement(),this.canvasDom.style.width="100%",this.canvasDom.style.height="100%",this.canvasDom.style.touchAction="none",this.isInitialized=!0;}registerShapeRenderer(t,e){this.canvas.contextService.registerShapeRenderer(t,e);}getCanvasPosition(){const t=this.canvasDom.getBoundingClientRect(),{scrollX:e,scrollY:i}={scrollX:void 0===window.scrollX?window.pageXOffset:window.scrollX,scrollY:void 0===window.scrollY?window.pageYOffset:window.scrollY};return {x:t.left+e,y:t.top+i}}resize(t,e){const i=xn();this.canvas.setDPR(i),this.canvasWidth=t,this.canvasHeight=e,this.canvas.resize(t,e);}}class sw{render(t,e){const{opacity:i,visibility:s}=t.parsedCheckboxStyle;0!==i&&"hidden"!==s&&(e.save(),e.globalAlpha=i,this.renderBox(t,e,"out"),e.clip(),this.renderBox(t,e,"in"),this.fill(t,e),this.renderBox(t,e,"center"),this.stroke(t,e),this.renderCheckMark(t,e),e.restore());}renderBox(t,e,i){const{x:s,y:n,width:o,height:r,borderWidth:a,borderRadiusX:l,borderRadiusY:h}=t.parsedCheckboxStyle;let c=0;"center"===i?c=a/2:"in"===i&&(c=a);const d=[{x:s+l,y:n+h,start:Math.PI,end:3*Math.PI/2},{x:s+o-l,y:n+h,start:3*Math.PI/2,end:2*Math.PI},{x:s+o-l,y:n+r-h,start:0,end:Math.PI/2},{x:s+l,y:n+r-h,start:Math.PI/2,end:Math.PI}],u=Math.max(l-c,0),p=Math.max(h-c,0);if(e.beginPath(),e.ellipse&&u&&p)for(let t=0;t<4;t++){const{x:i,y:s,start:n,end:o}=d[t];e.ellipse(i,s,u,p,0,n,o);}else e.rect(s,n,o,r);e.closePath();}fill(t,e){const{background:i}=t.parsedCheckboxStyle;i&&""!==i&&(e.fillStyle=i,e.fill());}stroke(t,e){const{borderColor:i,borderWidth:s,borderStyle:n}=t.parsedCheckboxStyle;e.setLineDash(n),e.strokeStyle=i,e.lineWidth=s,s>0&&i&&""!==i&&e.stroke();}renderCheckMark(t,e){if(!t.checked)return;const{x:i,y:s,width:n,height:o,borderWidth:r,checkMarkLineWidth:a,checkMarkColor:l}=t.parsedCheckboxStyle,h=Math.max(Math.min(n-2*r,o-2*r),0);let c=i,d=s;0!==h&&(n<o?(c+=r,d=d+r+(o-n)/2):(c=c+r+(n-o)/2,d+=r),e.setLineDash([0,0]),e.lineWidth=a,e.strokeStyle=l,e.beginPath(),e.moveTo(c+.15*h,d+.5*h),e.lineTo(c+.4*h,d+.8*h),e.lineTo(c+.85*h,d+.2*h),e.stroke());}}class nw{render(t,e){const{opacity:i,visibility:s}=t.parsedPageNumberStyle;0!==i&&"hidden"!==s&&(e.save(),e.globalAlpha=i,this.renderBox(t,e,"out"),e.clip(),this.renderBox(t,e,"in"),this.fill(t,e),this.renderBox(t,e,"center"),this.stroke(t,e),this.renderFont(t,e),e.restore());}renderBox(t,e,i){const{x:s,y:n,width:o,height:r,borderWidth:a,borderRadiusX:l,borderRadiusY:h}=t.parsedPageNumberStyle;let c=0;"center"===i?c=a/2:"in"===i&&(c=a);const d=[{x:s+l,y:n+h,start:Math.PI,end:3*Math.PI/2},{x:s+o-l,y:n+h,start:3*Math.PI/2,end:2*Math.PI},{x:s+o-l,y:n+r-h,start:0,end:Math.PI/2},{x:s+l,y:n+r-h,start:Math.PI/2,end:Math.PI}],u=Math.max(l-c,0),p=Math.max(h-c,0);if(e.beginPath(),e.ellipse&&u&&p)for(let t=0;t<4;t++){const{x:i,y:s,start:n,end:o}=d[t];e.ellipse(i,s,u,p,0,n,o);}else e.rect(s,n,o,r);e.closePath();}renderFont(t,e){const{x:i,y:s,width:n,height:o,fontSize:r,color:a,fontFamily:l}=t.parsedPageNumberStyle;e.fillStyle=a,e.textAlign="center",e.textBaseline="middle",l.includes(" ")?e.font=`${r}px '${l}'`:e.font=`${r}px ${l}`,e.fillText(t.text,i+n/2,s+o/2+r/8,n);}fill(t,e){const{background:i}=t.parsedPageNumberStyle;i&&""!==i&&(e.fillStyle=i,e.fill());}stroke(t,e){const{borderColor:i,borderWidth:s,borderStyle:n}=t.parsedPageNumberStyle;e.setLineDash(n),e.strokeStyle=i,e.lineWidth=s,s>0&&i&&""!==i&&e.stroke();}}class ow{render(t,e){var i;if(null===(i=t.lines)||void 0===i||!i.length)return;const s=t.style;e.save(),e.fillStyle=t.style.background,e.globalCompositeOperation="multiply",e.beginPath(),t.lines.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath();const n=t.getScale().x,o=s.ctrlBorderRadius/n,r=[];if(t.startCharRect){const{startCharRect:e}=t;r.push({x:e.left+e.width/2,y:e.top-o});}if(t.endCharRect){const{endCharRect:e}=t;r.push({x:e.left+e.width/2,y:e.top+e.height+o});}e.lineWidth=s.ctrlBorderWidth/n,e.strokeStyle=s.ctrlBorderColor,e.fillStyle=s.ctrlBackground,r.forEach((t=>{e.beginPath(),e.ellipse(t.x,t.y,o,o,0,0,2*Math.PI),e.closePath(),s.ctrlBackground&&e.fill(),e.stroke();})),e.restore();}}class rw{render(t,e){var i;if(null===(i=t.lines)||void 0===i||!i.length)return;const{selectedTextUid:s}=t;e.save(),e.globalCompositeOperation="multiply",t.lines.forEach((i=>{i.textUid===s?e.fillStyle=t.style.currentBackground:e.fillStyle=t.style.background,e.beginPath(),i.boxes.forEach((t=>{e.rect(t.left,t.top,t.width,t.height);})),e.fill(),e.closePath();})),e.restore();}}class aw extends Qn{constructor(t,e){super(),i(this,"context",void 0),i(this,"docRenderer",void 0),i(this,"aRenderer",void 0),i(this,"hooks",void 0),i(this,"reasons",[]),i(this,"tab",void 0),this.context=t,this.hooks=e,this.docRenderer=new iw;const s=()=>{null!=this&&this.context&&(this.reasons.length&&this.tab&&this.tab.isActive&&(this.internalRender(this.tab),this.hooks.renderReason.emit(this.reasons),this.tab=null,this.reasons=[]),requestAnimationFrame(s));};s();}getScrollContainer(){throw new Error("Method not implemented.")}dispose(){super.dispose(),this.context=null,this.docRenderer=null,this.hooks=null;}initRenderer(t,e,i){if(!this.docRenderer.isInitialized){Object.assign(t.style,this.context.viewerConfig.canvasStyle);const s=this.context.isDefaultViewer;this.docRenderer.initCanvas({container:t,width:e,height:i,limit1px:s}),this.docRenderer.registerShapeRenderer("checkbox",new sw),this.docRenderer.registerShapeRenderer("pageNumber",new nw),this.docRenderer.registerShapeRenderer("textSelection",new ow),this.docRenderer.registerShapeRenderer("textSearch",new rw);}}getCanvasDom(){return this.docRenderer.canvasDom}clearCanvas(){const t=this.getCanvasDom();if(!t)return;t.getContext("2d").clearRect(0,0,t.width,t.height);}resize(t,e){this.docRenderer&&this.docRenderer.resize(t,e);}updateCanvasSize(){if(this.docRenderer){const t=this.getCanvasDom();if(!t)return;const{clientWidth:e,clientHeight:i}=t;this.docRenderer.resize(e,i);}}render(t,e){t.isDestroyed||(this.tab=t,this.docRenderer.appendDocToRoot(t),this.reasons.push(e),3===e&&this.docRenderer.render(t));}internalRender(t){t.isDestroyed||(this.hooks.beforeRender.emit(t),this.docRenderer.render(t),this.hooks.afterRender.emit(t),t.preloadChildren.forEach(((t,e)=>{if(t.isVisible&&t.isLoaded){const e=Wf.create(t.pageIndex,t.uid);this.hooks.pageRendered.emit(e);}})));}getCanvasPageRect(){const t=this.docRenderer.canvasDom.getBoundingClientRect(),{scrollX:e,scrollY:i}=window;return {left:t.left+e,top:t.top+i,width:t.width,height:t.height}}}function lw(t){const e=t.getPages(),i=e.length;if(!i)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);let{viewportWidth:s,viewportHeight:n}=t;const{rows:o,columns:r,scrollbarWidth:a,tab:l,isVertical:h}=t,c=t.getMargin();r*o<i&&(h?s-=a:n-=a);let d=0,u=0;h?(d=(s-(r+1)*c)/r,u=(n-(o+1)*c)/o):(u=(n-(o+1)*c)/o,d=(s-(r+1)*c)/r);let p=!1;(d<0||u<0)&&(p=!0,d=Math.max(0,d),u=Math.max(0,u));const g=h?Math.max(o,Math.ceil(i/r)):o,f=h?r:Math.max(r,Math.ceil(i/o)),v=d*f+(f+1)*c,m=u*g+(g+1)*c,y=e.map((t=>({uid:t.uid,x:0,y:0,width:d,height:u,borderBoxWidth:0,borderBoxHeight:0,pageWidth:0,pageHeight:0}))),x=t.getParsedPageStyle(),w=t.getParsedPageNumberStyle(d,u),{visibility:b,top:S,bottom:C,onPage:P,height:T}=w;let A=d,k=u;const D=d;let R=u;const E="visible"===b,M=t.getPageNumberStyle();if(E){const t=""!==M.top?S:C||0;P||(k=u-T-t,R=u-T-t,M.top);}k<0&&(p=!0,k=Math.max(0,k)),(A-2*x.borderWidth<0||k-2*x.borderWidth<0)&&(p=!0);const I=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=p?0:v+2*I,t.currentLayoutHeight=p?0:m+2*I,t.currentViewportWidth=p?t.viewportWidth:s,t.currentViewportHeight=p?t.viewportHeight:n,t.isOutOfBounds=p,p||(A=Lx(A),k=Lx(k),e.forEach(((t,e)=>{const i=h?e%r:Math.floor(e/o),s=h?Math.floor(e/r):e%o,n=c+i*(c+d),a=c+s*(c+u);y[e].x=n,y[e].y=a,y[e].borderBoxWidth=A,y[e].borderBoxHeight=k,y[e].pageWidth=D,y[e].pageHeight=R;})),t.placeholderPages=y,l.context.viewerContext.visibilityService.handleVisibility(l,!0));}function hw(t){const{tab:e}=t,i=e.getCurrentPage();if(!i)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);const{viewportWidth:s,viewportHeight:n,scrollbarWidth:o,fitMode:r}=t,a=t.getMargin(),l=t.getParsedPageStyle(),{borderWidth:h=0}=l,c=2*h,d=i.rWidth,u=i.rHeight,p=2*a,g=c+p,f=c+p,v=s-g,m=n-f;let{zoom:y}=t;const x=dw(r,{zoom:y,validLayoutWidth:d,validLayoutHeight:u,scrollbarWidth:o,fitViewportWidth:v,fitViewportHeight:m,isZoomChanged:t.isZoomChanged},cw);t.isZoomChanged=!1;const{zoomedLayoutWidth:w,zoomedLayoutHeight:b,zoomedViewportWidth:S,zoomedViewportHeight:C,newFitMode:P}=x;if(y=x.zoom,P&&r!==P){t.fitMode=P,t.viewerContext.viewerConfig.fitMode=P;const e=df.create(r,P);t.viewerContext.hooks.fitModeChanged.emit(e);}t.setZoom(y);const T=w+g,A=b+f,k=S+g,D=C+f,R=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=T+2*R,t.currentLayoutHeight=A+2*R,t.currentViewportWidth=k,t.currentViewportHeight=D,i.zoom=y,t.tab.setPosition({x:-0,y:-0});const E=e.allPages.map((t=>{let{uid:e}=t;return {uid:e,x:a,y:a,width:w+c,height:b+c}}));t.placeholderPages=E;const M=Lx(w+c),I=Lx(b+c),B=Ux(a),U=B,L=Bx(h),O=L,N=Lx(d),_=Lx(u),W=d*(1-y)/2,F=u*(1-y)/2,H=i.cropWidth,V=i.cropHeight,z=L-W-(H-N)/2,$=O-F-(V-_)/2,j=L-W,X=O-F;i.setPage(B,U,M,I),i.setBorderBox(0,0,M,I),i.setCropBox(z,$,H,V,y,i.rotation),i.setRealTimeBox(j,X,d,u,y);const{width:G,height:Y}=t.viewerContext.getPageRenderSize(i.uid);i.setMediaBox(-i.cropLeft,-i.cropTop,G,Y),i.setImage(0,0,G,Y);}function cw(t,e){let{zoom:i,validLayoutWidth:s,validLayoutHeight:n,scrollbarWidth:o,fitViewportWidth:r,fitViewportHeight:a}=e;return "none"===t||"actualSize"===t?("actualSize"===t&&(i=1),Math.floor(s*i)>r&&(a-=o),Math.floor(n*i)>a&&(r-=o)):"width"===t||"window"===t&&s/r>=n/a?(i=r/s,n*i>a&&(r-=o,i=r/s)):(i=a/n,s*i>r&&(a-=o,i=a/n)),{zoom:i,zoomedLayoutWidth:s*i,zoomedLayoutHeight:n*i,zoomedViewportWidth:r,zoomedViewportHeight:a}}function dw(t,e,i){const{zoom:s,isZoomChanged:n}=e;let o={};if(n){let n;const r=Tm(s);if(1===s)n="actualSize",o=i("actualSize",e);else {o=i("width",e);if(Tm(o.zoom)===r)n="width","window"===t&&(n="window");else {o=i("height",e);r===Tm(o.zoom)&&(n="height","window"===t&&(n="window"));}}n?o.newFitMode=n:(o=i("none",e),o.newFitMode="none");}else o=i(t,e);return o}function uw(t,e){let{zoom:i,fitWidth:s,fitHeight:n,validLayoutWidth:o,validLayoutHeight:r,scrollbarWidth:a,isVertical:l,fitViewportWidth:h,fitViewportHeight:c}=e;return "none"===t||"actualSize"===t?("actualSize"===t&&(i=1),Math.floor(o*i)>h&&(c-=a),Math.floor(r*i)>c&&(h-=a)):"width"===t||"window"===t&&s/h>=n/c?(i=h/s,l?r*i>c&&(h-=a,i=h/s):(o*i>h&&(c-=a),n*i>c&&(h-=a,i=h/s))):(i=c/n,l?(r*i>c&&(h-=a),s*i>h&&(c-=a,i=c/n)):o*i>h&&(c-=a,i=c/n)),{zoom:i,zoomedLayoutWidth:o*i,zoomedLayoutHeight:r*i,zoomedViewportWidth:h,zoomedViewportHeight:c}}const pw=t=>{const e=t.getPages();if(!e.length)return;const{tab:i}=t,s=i.current,n=e[s-1],o=e[s+1];n&&gw(t,n,-1),o&&gw(t,o,1);};function gw(t,e,i){const{viewportWidth:s,viewportHeight:n}=t,o=t.getParsedPageStyle(),{borderWidth:r=0}=o,a=t.getMargin(),{rWidth:l,rHeight:h}=e,c=s-2*a-2*r,d=n-2*a-2*r;let u=0,p=0,g=1;l/h>c/d?(u=c,g=c/l,p=h*g):(p=d,g=d/h,u=l*g);let f=(c-u)/2+a,v=(d-p)/2+a;f=Math.max(a,f),v=Math.max(a,v);const{x:m,y:y}=t.tab.getPosition();-1===i?(f=-s+f-m,v-=y):1===i&&(f=s+f-m,v-=y);const x=l*(1-g)/2,w=h*(1-g)/2,b=r,S=r,C=l,P=h,T=e.cropWidth,A=e.cropHeight,k=b-x-(T-C)/2,D=S-w-(A-P)/2,R="visible",E="hidden";e.updateStyle({visibility:R,x:f,y:v,width:u+2*r,height:p+2*r}),e.borderBox.updateStyle({x:0,y:0,width:u+2*r,height:p+2*r,...o,background:"#ffffff00",visibility:R}),e.cropBox.setLocalScale(1),e.cropBox.updateStyle({x:k,y:D,width:T,height:A}),e.cropBox.setLocalScale(g,g),e.cropBox.setLocalAngle(e.rotation);const{width:M,height:I}=t.viewerContext.getPageRenderSize(e.uid);e.mediaBox.updateStyle({x:-e.cropLeft,y:-e.cropTop,width:M,height:I}),e.zoom=g,e.checkbox.updateStyle({visibility:E}),e.pageNumber.updateStyle({visibility:E}),e.setImage(0,0,M,I);}function fw(t){const{displayMode:e}=t;"single"===e?hw(t):"continuous"===e?function(t){const e=t.getPages();if(!e.length)return t.currentLayoutWidth=0,void(t.currentLayoutHeight=0);let{zoom:i}=t;const{viewportWidth:s,viewportHeight:n,tab:o,fitMode:r,scrollbarWidth:a,isVertical:l}=t,h=t.getParsedPageStyle(),{borderWidth:c}=h,d=2*c,u=t.getMargin(),{realRow:p,realColumn:g}=t.getRealRowAndColumnContinuous(),f=new Array(g).fill(0),v=new Array(p).fill(0);let m=0,y=0;e.forEach(((t,e)=>{const i=l?Math.floor(e/g):e%p,s=l?e%g:Math.floor(e/p),n=t.rWidth+d,o=t.rHeight+d;f[s]=Math.max(f[s],n),v[i]=Math.max(v[i],o),m=Math.max(f[s],m),y=Math.max(v[i],y);}));let x=f.reduce(((t,e)=>t+e),0),w=v.reduce(((t,e)=>t+e),0);const b=(g+1)*u,S=(p+1)*u,C=g*d+b,P=p*d+S;x+=b,w+=S;const T=x-C,A=w-P;let k=0,D=0,R=0,E=0;l?(k=s-C,D=n-2*u-d,R=f.reduce(((t,e)=>t+e-d),0),E=y-d):(k=s-2*u-d,D=n-P,R=m-d,E=v.reduce(((t,e)=>t+e-d),0));const M=dw(r,{zoom:i,fitWidth:R,fitHeight:E,validLayoutWidth:T,validLayoutHeight:A,scrollbarWidth:a,isVertical:l,fitViewportWidth:k,fitViewportHeight:D,isZoomChanged:t.isZoomChanged},uw);t.isZoomChanged=!1;const{zoomedLayoutWidth:I,zoomedLayoutHeight:B,zoomedViewportWidth:U,zoomedViewportHeight:L,newFitMode:O}=M;if(i=M.zoom,O&&r!==O){t.fitMode=O,t.viewerContext.viewerConfig.fitMode=O;const e=df.create(r,O);t.viewerContext.hooks.fitModeChanged.emit(e);}t.setZoom(i);const N=I+C,_=B+P;let W=0,F=0;l?(W=U+(g+1)*u+g*d,F=L+2*u+d):(W=U+2*u+d,F=L+(p+1)*u+p*d);const H=t.viewerContext.viewService.getCanvasBorderSize();t.currentLayoutWidth=N+2*H,t.currentLayoutHeight=_+2*H,t.currentViewportWidth=W,t.currentViewportHeight=F,t.tab.setPosition({x:-0,y:-0});const V=o.allPages.map((t=>({uid:t.uid,x:0,y:0,width:0,height:0,pageX:0,pageY:0})));e.forEach(((t,e)=>{const s=l?Math.floor(e/g):e%p,n=l?e%g:Math.floor(e/p),o=(f[n]-d)*i+d,r=(v[s]-d)*i+d,a=t.rWidth,h=t.rHeight;let m=0,y=0;if(0===n)m=u;else {const t=V[l?e-1:(n-1)*p+s];m=t.x+t.width+u;}if(0===s)y=u;else {const t=V[l?(s-1)*g+n:e-1];y=t.y+t.height+u;}const x=V[e];x.width=o,x.height=r,x.x=m,x.y=y,t.zoom=i;const w=y+(r-h*i)/2-c,b=Ux(m+(o-a*i)/2-c),S=Ux(w);x.pageX=b,x.pageY=S;})),t.placeholderPages=V,t.viewerContext.visibilityService.handleVisibility(o,!0);}(t):"slide"===e&&pw(t);}class vw{constructor(t,e){i(this,"context",void 0),i(this,"hooks",void 0),this.context=t,this.hooks=e;}layout(t,e){if(t.isDestroyed||!t.isActive)return;let i;if(this.context.isDefaultViewer)i=fw;else if(this.context.isThumbnailViewer)i=lw;else if(this.context.isPerspectiveViewer){const{displayMode:e}=t.context;"single"===e?i=hw:"slide"===e&&(i=pw);}i&&(this.hooks.layoutReason.emit(e),this.hooks.beforeLayout.emit(t),i(t.context),this.hooks.afterLayout.emit(t));}}const mw=["viewerMode","displayMode","toolMode","annotationMode","fitMode","visibility","zoom","zoomOrigin","minZoom","maxZoom","multiselectMode","canvasStyle","pageStyle","selectedPageStyle","hoveredPageStyle","placeholderStyle","pageNumberStyle","checkboxStyle","currentPageStyle","quadSelectionStyle","textSelectionStyle","cursorStyle","rows","columns","maxColumns","maxRows","margin"];class yw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"handlers",{}),this.context=t;}dispose(){this.context=null,this.handlers={},super.dispose();}updateConfig(t){for(const[e,i]of Object.entries(t))mw.includes(e)&&this[e](i);}registerHandler(t,e){return !this[t]&&(this[t]=e,!0)}viewerMode(t){const{context:e}=this;e.viewerConfig.viewerMode=t,lg.CAPTURE;}toolMode(t){const{context:e}=this,i=e.viewerConfig.toolMode;t!==i&&(e.viewerConfig.toolMode=t,e.hooks.toolModeChanged.emit(uf.create(i,t)));}annotationMode(t){const{context:e}=this,i=e.viewerConfig.annotationMode;t!==i&&(e.viewerConfig.annotationMode=t),e.hooks.annotationModeChanged.emit(Pf.create(i,t));}fitMode(t){const{context:e}=this,i=e.getActiveTab();if(!i){const i=e.viewerConfig.fitMode;if(i===t)return;return e.viewerConfig.fitMode=t,void e.hooks.fitModeChanged.emit(df.create(i,t))}const s=i.context.fitMode;s!==t&&(i.context.fitMode=t,"none"!==t&&(e.showTab(i,{isClearOptimization:!0,renderReason:20}),e.hooks.fitModeChanged.emit(df.create(s,t))));}displayMode(t){const{context:e}=this,i=e.getActiveTab();let s;if(i){if(s=i.context.displayMode,t===s)return;i.context.displayMode=t,e.showTab(i,{isClearOptimization:!0,renderReason:21});}else {if(s=e.viewerConfig.displayMode,t===s)return;e.viewerConfig.displayMode=t;}if("slide"!==s&&"slide"!==t){const i=cf.create(s,t);e.viewer.hooks.displayModeChanged.emit(i);}}margin(t){const{context:e}=this;e.viewerConfig.margin!==t&&(e.viewerConfig.margin=t,e.showCurrentTab({isClearOptimization:!0,renderReason:7}));}rows(t){const{context:e}=this,i=e.getActiveTab();i?t!==i.context.rows&&(e.styleService.isCheckboxStyleChanged=!0,e.styleService.isPageNumberStyleChanged=!0,i.context.rows=t,this.context.showTab(i,{isClearOptimization:!0,renderReason:22})):e.viewerConfig.rows=t;}columns(t){const{context:e}=this,i=e.getActiveTab();i?t!==i.context.columns&&(e.styleService.isCheckboxStyleChanged=!0,e.styleService.isPageNumberStyleChanged=!0,i.context.columns=t,this.context.showTab(i,{isClearOptimization:!0,renderReason:22})):e.viewerConfig.columns=t;}maxColumns(t){t=Math.max(1,t);const{context:e}=this;e.viewerConfig.maxColumns=t;const i=e.getActiveTab();i&&i.context.columns>t&&this.columns(t);}maxRows(t){t=Math.max(1,t);const{context:e}=this;e.viewerConfig.maxRows=t;const i=e.getActiveTab();i&&i.context.rows>t&&this.rows(t);}zoom(t){const{context:e}=this;e.getActiveTab()&&e.zoomTo(t);}visibility(t){const{context:e}=this;if(t===e.viewerConfig.visibility)return;const{rootDom:i,defaultDom:s,thumbnailContainer:n}=e.viewService;if(!i)return;const{ui:o}=e.viewer,r=!n&&o.container.classList.contains("ddv-thumbnail-container"),a=e.viewerConfig.visibility;e.viewerConfig.visibility=t,"visible"===t?(i.style.display="flex",s.style.display="flex",r?(o.container.style.display="flex",e.core.viewerService.onResize.emit()):e.core.viewerService.onResize.emit()):(i.style.display="none",r&&(o.container.style.display="none",e.core.viewerService.onResize.emit()));const l=Xg.create(t,a);e.hooks.visibleChanged.emit(l);}zoomOrigin(t){const{context:e}=this;e.viewerConfig.zoomOrigin=t;}minZoom(t){const{context:e}=this;e.viewerConfig.minZoom=t;}maxZoom(t){const{context:e}=this;e.viewerConfig.maxZoom=t;}multiselectMode(t){const{context:e}=this;e.viewerConfig.multiselectMode=t;}canvasStyle(t){const{context:e}=this;if(Os(t))if(Object.assign(e.viewerConfig.canvasStyle,t),e.isCaptureViewer){var i;const s=null===(i=e.viewer)||void 0===i||null===(i=i.cameraContext)||void 0===i?void 0:i.cameraContainer;s&&Object.assign(s.style,t);}else {const{canvasContainer:i,annotationCanvasContainer:s}=e.viewService;if(i){const{eventDom:s}=e;Object.assign(i.style,t),t.cursor&&s&&Object.assign(s.style,{cursor:t.cursor}),e.styleService.isCanvasStyleChanged=!0,t.border&&e.resize();}}}pageStyle(t){const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.pageStyle,t),e.styleService.isPageStyleChanged=!0,e.showCurrentTab({isClearOptimization:!0,renderReason:8}));}selectedPageStyle(t){const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.selectedPageStyle,t),e.styleService.isSelectedPageStyleChanged=!0,e.showCurrentTab({isClearOptimization:!0,renderReason:9}));}hoveredPageStyle(t){const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.hoveredPageStyle,t),e.styleService.isHoveredPageStyleChanged=!0,e.showCurrentTab({isClearOptimization:!0,renderReason:10}));}placeholderStyle(t){const{context:e}=this;Os&&(Object.assign(e.viewerConfig.placeholderStyle,t),e.styleService.isPlaceholderStyleChanged=!0,e.showCurrentTab({renderReason:11}));}currentPageStyle(t){const{context:e}=this;Os&&(Object.assign(e.viewerConfig.currentPageStyle,t),e.styleService.isCurrentPageStyleChanged=!0,e.showCurrentTab({renderReason:12}));}pageNumberStyle(t){const{context:e}=this;if(Os(t)){const{pageNumberStyle:i}=e.viewerConfig;let s=!1;void 0!==t.onPage?(t.onPage!==i.onPage||!1===t.onPage)&&(s=!0):!1===i.onPage&&(s=!0),Object.assign(i,t),e.styleService.isPageNumberStyleChanged=!0,e.showCurrentTab({isClearOptimization:s,renderReason:13});}}checkboxStyle(t){const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.checkboxStyle,t),e.styleService.isCheckboxStyleChanged=!0,e.showCurrentTab({renderReason:14}));}quadSelectionStyle(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.quadSelectionStyle,t),e.styleService.isQuadSelectionStyleChanged=!0,e.hooks.quadSelectionStyleChanged.emit(),e.showCurrentTab({renderReason:15}));}textSelectionStyle(t){const{context:e}=this;Os(t)&&(Object.assign(e.viewerConfig.textSelectionStyle,t),e.tabService.getAllTabs().forEach((e=>{e.allPages.forEach((e=>{e.setTextSelectionStyle(t);}));})),e.render(40));}cursorStyle(t){const{context:e}=this;Os(t)&&Object.assign(e.viewerConfig.cursorStyle,t);}scrollDirection(t){const{context:e}=this;e.viewerConfig.scrollDirection=t;const i=e.getActiveTab();i&&(i.context.direction=t,e.resize());}}class xw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"hoveredPageUid",null),i(this,"undo",0),i(this,"redo",0),this.context=t;}dispose(){super.dispose(),this.context=null;}handleExternalEvents(){const{context:t}=this,{hooks:e}=this.context;this.bindFileDropEvents(),this.bindNativeEvents(),this.convertInternalHooks();let i=0,s=0;e.pageChanged.on((e=>{const n=e.current+1,{total:o}=e;i===n&&s===o||(i=n,s=o,t.emit("paginationChanged",{currentPageNumber:n,pageCount:o}));}),this),e.layoutReason.on((e=>{t.emit("layoutReason",e);}),this),e.renderReason.on((e=>{t.emit("renderReason",e);}),this),e.operationsChanged.on((e=>{this.undo===e.undo&&this.redo===e.redo||t.emit("undoRedoStateChanged",{undoCount:e.undo,redoCount:e.redo}),this.undo=e.undo,this.redo=e.redo;}),this),e.scroll.on((e=>{t.emit("scroll",e);})),e.currentIndexChanged.on((e=>{t.emit("currentIndexChanged",{oldIndex:e.oldIndex,newIndex:e.newIndex});}),this),e.currentPageChanged.on((()=>{const e=this.context.getActiveTab();if(!e)return;const{currentUid:i,oldCurrentUid:s}=e;t.emit("currentPageChanged",{oldPageUid:s||"",newPageUid:i||""});}),this),e.displayModeChanged.on((e=>{t.emit("displayModeChanged",{oldDisplayMode:e.oldDisplayMode,newDisplayMode:e.newDisplayMode});}),this),e.fitModeChanged.on((e=>{t.emit("fitModeChanged",{oldFitMode:e.oldFitMode,newFitMode:e.newFitMode});}),this),e.toolModeChanged.on((e=>{t.emit("toolModeChanged",{oldToolMode:e.oldToolMode,newToolMode:e.newToolMode});}),this),e.annotationModeChanged.on((e=>{t.emit("annotationModeChanged",{oldAnnotationMode:e.oldAnnotationMode,newAnnotationMode:e.newAnnotationMode});})),e.zoomChanged.on((e=>{e.oldZoomRatio!==e.newZoomRatio&&t.viewer.emit("zoomChanged",{oldZoomRatio:e.oldZoomRatio,newZoomRatio:e.newZoomRatio});}),this),e.textSelected.on((e=>{if(e.detail.length){if(!this.context.hasCallback("textSelected"))return;const t=[],i=Bo.displayResolution,s=Bo.dataResolution;e.detail.forEach((e=>{const n=[];e.lines.forEach((t=>{n.push({x:jn(Gn(t.selectedRect.left,i,s),2),y:jn(Gn(t.selectedRect.top,i,s),2),width:jn(Gn(t.selectedRect.width,i,s),2),height:jn(Gn(t.selectedRect.height,i,s),2)});})),t.push({pageUid:e.pageUid,text:e.text,rects:n});})),this.context.viewer.emit("textSelected",t);}else t.viewer.emit("textUnselected",null);}),this),this.context.hooks.searchTextChanged.on((t=>{if(!this.context.hasCallback("textSearchTriggered"))return;if(!t.isLastPage)return;const e=[],{text:i}=t,s=Bo.displayResolution,n=Bo.dataResolution;t.searchResults.forEach((t=>{const{pageUid:o}=t;t.texts.forEach((t=>{const r=[];t.lines.forEach((t=>{r.push({x:jn(Gn(t.box.left,s,n),2),y:jn(Gn(t.box.top,s,n),2),width:jn(Gn(t.box.width,s,n),2),height:jn(Gn(t.box.height,s,n),2)});})),e.push({pageUid:o,text:i,rects:r,context:t.context});}));})),this.context.emit("textSearchTriggered",e);}),this),e.selectedPageChanged.on((t=>{this.context.viewer.emit("selectedPagesChanged",{oldIndices:t.oldIndices,newIndices:t.newIndices,oldPageUids:t.oldPageUids,newPageUids:t.newPageUids});}),this),e.resize.on((t=>{this.context.viewer.emit("resized",{oldWidth:t.oldWidth,oldHeight:t.oldHeight,newWidth:t.newWidth,newHeight:t.newHeight});}),this),e.pageRendered.on((t=>{this.context.emit("pageRendered",{index:t.index,pageUid:t.pageUid});}),this),e.pagesDragged.on((e=>{t.viewer.emit("pagesDragged",{indices:e.indices,pageUids:e.pageUids});})),e.pagesDropped.on((e=>{t.viewer.emit("pagesDropped",{indicesBefore:e.indicesBefore,indicesAfter:e.indicesAfter,pageUids:e.pageUids});}),this),e.visibleChanged.on((e=>{t.viewer.emit("visibilityChanged",{isVisible:"visible"===e.newVisibility});}),this);}convertInternalHooks(){const{hooks:t}=this.context;t.pageChanged.on((e=>{const i=this.context.getActiveTab();let s;i&&0!==i.total?0===i.oldTotal&&i.total>0&&(s=e.total):s=0,_s(s)||t.pageExistenceChanged.emit(If.create(s));}),this),t.pageChangedAfterRender.on((e=>{const i=this.context.getActiveTab();if(!i)return;const{current:s,oldCurrent:n,currentUid:o,oldCurrentUid:r}=i;if(n!==s){const e=hf.create(n,s);t.currentIndexChanged.emit(e);}r!==o&&t.currentPageChanged.emit(e);}),this);}bindNativeEvents(){const{context:t}=this,{eventDom:e}=this.context;this.context.isCaptureViewer||(eo(e,"click",this).on((e=>{if(!t.hasCallback("click"))return;const i=this.formatEvent(e);t.emit("click",i);})),eo(e,"contextmenu",this).on((e=>{if(e.preventDefault(),!t.hasCallback("rightclick"))return;const i=this.formatEvent(e);t.emit("rightclick",i);})),eo(e,"pointerdown",this).on((e=>{if(!t.hasCallback("pointerdown"))return;const i=this.formatEvent(e);t.emit("pointerdown",i);})),eo(e,"pointermove",this).on((e=>{const i=this.formatEvent(e),{pageUid:s}=i;let n=-1;if(this.hoveredPageUid){const t=this.context.getActiveTab();t?n=t.uidToIndex(this.hoveredPageUid):this.hoveredPageUid="";}s&&this.hoveredPageUid&&s!==this.hoveredPageUid?(t.emit("pageout",{...i,pageUid:this.hoveredPageUid,index:n}),t.emit("pageover",i)):s&&s!==this.hoveredPageUid?t.emit("pageover",i):!s&&this.hoveredPageUid&&t.emit("pageout",{...i,pageUid:this.hoveredPageUid,index:n}),this.hoveredPageUid=s,t.emit("pointermove",i);})),eo(e,"pointerup",this).on((e=>{if(!t.hasCallback("pointerup"))return;const i=this.formatEvent(e);t.emit("pointerup",i);})),eo(e,"dblclick",this).on((e=>{if(!t.hasCallback("dblclick"))return;const i=this.formatEvent(e);t.emit("dblclick",i);})),eo(document.body,"dblclick",this).on((t=>{})));}bindFileDropEvents(){const{context:t}=this,{eventDom:e}=t;t.viewerConfig.enableLoadSourceByDrag&&!this.context.isCaptureViewer&&(eo(e,"dragenter",this).on((t=>{t.preventDefault();})),eo(e,"dragleave",this).on((t=>{t.preventDefault();})),eo(e,"drop",this).on((async t=>{var e,i;t.preventDefault();const s=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;if(!s)return;let{viewer:n}=this.context;"thumbnail"===n.getViewerConfig().viewerMode&&this.context.mainViewerUid&&(n=this.context.core.viewerService.getViewer(this.context.mainViewerUid));const o=!0===(null===(i=n.popupConfig)||void 0===i||null===(i=i.passwordLoaderConfig)||void 0===i?void 0:i.enabled),r=s.length,a={renderAnnotations:Ap.annotationLicenseModuleIsExist()?Pd.LOAD_ANNOTATIONS:Pd.NO_ANNOTATIONS},l="image"===this.context.viewerConfig.renderingMode?Cd.CM_AUTO:Cd.CM_RENDERALL;if(o)for(let t=0;t<r;t++){const e=new Blob([s[t]],{type:s[t].type});await n.context.core.isPdfEncrypted(e)?await new Promise((i=>{n.emit("ui_showPasswordLoader",{blob:e,fileName:s[t].name,resolve:i});})):n.context.loadSource({fileData:e,convertMode:l,renderOptions:a});}else {const t=[];for(let e=0;e<r;e++){const i=new Blob([s[e]],{type:s[e].type});"application/pdf"===s[e].type?t.push({fileData:i,convertMode:l,renderOptions:a}):t.push({fileData:i});}this.context.loadSource(t);}})),eo(e,"dragover",this).on((t=>{t.preventDefault();})));}formatEvent(t){var e,i;const[s]=this.context.toCanvas(t),n=this.context.getPointerOverPageInfo(s.pageX,s.pageY),o=Bo.displayResolution,r=Bo.dataResolution,{pointerX:a,pointerY:l}=n.imageInfo;return {index:n.index,pageUid:null!==(e=null===(i=n.pageInfo.page)||void 0===i?void 0:i.uid)&&void 0!==e?e:"",imageX:a<0?-1:qn(Gn(a,o,r),2),imageY:l<0?-1:qn(Gn(l,o,r),2),canvasX:Math.floor(s.pageX),canvasY:Math.floor(s.pageY),nativeEvent:t}}}class ww extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"offsetX",0),i(this,"offsetY",0),i(this,"startX",0),i(this,"startY",0),i(this,"isDragging",!1),i(this,"startPage",void 0),i(this,"newIndexes",void 0),i(this,"cacheChildren",void 0),i(this,"cacheSelectedIndexes",void 0),i(this,"isMousedown",!1),i(this,"starDragIndices",[]),i(this,"autoScrollTimer",void 0),i(this,"isAutoScroll",!1),i(this,"lastAutoScrollEvent",void 0),this.context=t;}dispose(){super.dispose(),this.context=null;}startHandler(t){const{context:e}=this,{viewerConfig:i,styleService:s}=e;if("pan"!==i.toolMode)return;this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);const n=e.getActiveTab();if(null==n||!n.total)return;this.isAutoScroll=!1,this.isMousedown=!0;const[o]=e.toCanvas(t),{page:r}=e.getPointerOverPageInfo(o.pageX,o.pageY).pageInfo;if(r&&r){this.startX=o.pageX,this.startY=o.pageY;const t=r.getPosition();this.offsetX=o.pageX-t.x,this.offsetY=o.pageY-t.y,this.startPage=r,this.cacheChildren=n.allPages.slice();}}moveHandler(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const{context:i}=this,s=i.getActiveTab();if(!s||!i.isThumbnailViewer)return;const[n]=i.toCanvas(t),o=i.getPointerOverPageInfo(n.pageX,n.pageY),{page:r}=o.pageInfo,a=this.context.rendererService.getCanvasDom().getBoundingClientRect();if(!e&&a.top<t.clientY&&a.bottom>t.clientY&&a.left<t.clientX&&a.right>t.clientX&&(this.lastAutoScrollEvent=t,this.autoScrollTimer&&!e&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null)),this.isDragging){var l,h,c;if(r&&!r.isSelected){const t=s.selected.map((t=>s.uidToIndex(t))).sort(((t,e)=>t-e)),e=t[0],n=s.getPageIndex(r),o=s.allPages.slice();t.slice().reverse().forEach((t=>{o.splice(t,1);}));let a=o.indexOf(r);n>e&&(a+=1),this.cacheSelectedIndexes.forEach(((t,e)=>{const i=s.getPageByUid(t.uid);o.splice(a+e,0,i);})),this.newIndexes=o.map((t=>s.getPageIndex(t))),s.reorderPages(this.newIndexes,!1),i.layoutService.layout(s,53),i.visibilityService.handleVisibility(s);}const t=i.styleService.getParsedPlaceholderStyle(),e=devicePixelRatio;let o=n.pageX-this.offsetX,a=n.pageY-this.offsetY;o=Math.round(o*e)/e,a=Math.round(a*e)/e,s.selected.forEach((e=>{const i=s.getPageByUid(e);i.isDragging=!0,i.updateStyle({...t}),i.borderBox.updateStyle({visibility:"hidden"});})),null===(l=this.startPage)||void 0===l||l.updateStyle({zIndex:1}),null===(h=this.startPage)||void 0===h||h.borderBox.updateStyle({visibility:"visible"}),null===(c=this.startPage)||void 0===c||c.borderBox.setPosition({x:o,y:a});const{maxScrollTop:d,maxScrollLeft:u}=s.context;(d||u)&&i.viewerConfig.enableAutoScrollForDragPages&&(this.isAutoScroll=!0),i.loadVisiblePages(s),i.rendererService.render(s,53);}else if(r&&r===this.startPage&&r.isSelected){if(((n.pageX-this.startX)**2+(n.pageY-this.startY)**2)**.5>=i.viewerConfig.dragThreshold&&this.startPage&&i.viewerConfig.enableDragPage){this.isDragging=!0,this.cacheSelectedIndexes=s.selected.map((t=>({uid:t,index:s.uidToIndex(t)}))).sort(((t,e)=>t.index-e.index));const t=s.uidsToIndices(s.selected);this.starDragIndices=[...t],i.viewer.hooks.pagesDragged.emit(Ff.create(t,[...s.selected]));}}}pointermoveForAutoScroll(t,e){this.isAutoScroll&&this.autoScroll(e);}autoScroll(t){const{context:e}=this,i=e.getActiveTab(),s=e.viewerConfig.autoScrollStepSize/devicePixelRatio*2,{maxScrollTop:n,scrollTop:o,maxScrollLeft:r,scrollLeft:a}=i.context;let l=!1;n&&t.top&&0!==o&&(l=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:n}=i.context;t&&(0!==n?(e.viewService.scrollBy(0,-s),this.moveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),e.viewService.scrollBy(0,-s)),n&&t.bottom&&o!==n&&(l=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:n}=i.context;t&&(n!==t?(e.viewService.scrollBy(0,s),this.moveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),e.viewService.scrollBy(0,s)),r&&t.left&&0!==a&&(l=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:n}=i.context;t&&(0!==n?(e.viewService.scrollBy(-s,0),this.moveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),e.viewService.scrollBy(-s,0)),r&&t.right&&a!==r&&(l=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:n}=i.context;t&&(n!==t?(e.viewService.scrollBy(s,0),this.moveHandler(this.lastAutoScrollEvent,!0)):(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),e.viewService.scrollBy(s,0)),this.autoScrollTimer&&!l&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);}endHandler(){var t;if(!this.isMousedown)return;const{context:e}=this,i=e.getActiveTab();if(i){if(this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null),this.isAutoScroll=!1,this.isDragging){if(this.newIndexes){const t=i.allPages.map((t=>this.cacheChildren.indexOf(t)));i.allPages=this.cacheChildren,i.freshPageIndex(),e.viewer.reorderPages(t),this.newIndexes=null;}i.selected.forEach((t=>{const e=i.getPageByUid(t);e.borderBox.setLocalPosition({x:0,y:0}),e.isDragging=!1,e.borderBox.updateStyle({visibility:"visible"});}));const t=i.uidsToIndices(i.selected);e.viewer.hooks.pagesDropped.emit(Hf.create(this.starDragIndices,t,[...i.selected]));}null===(t=this.startPage)||void 0===t||t.updateStyle({zIndex:0}),this.isDragging&&(e.scrollByCurrentChanged=!0,e.layoutService.layout(i,54),e.visibilityService.handleVisibility(i),e.rendererService.render(i,54)),this.isMousedown=!1,this.startPage=null,this.isDragging=!1;}}}class bw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"lastX",void 0),i(this,"lastY",void 0),i(this,"startTime",void 0),i(this,"startScrollLeft",void 0),i(this,"startScrollTop",void 0),i(this,"isScrolling",void 0),i(this,"scrollTimer",void 0),i(this,"scrollDirectionX","left"),i(this,"scrollDirectionY","top"),i(this,"canvasElX",void 0),i(this,"canvasElY",void 0),this.context=t,this.isScrolling=!1;}startHandler(t){const{context:e}=this;if(e.isPanning||e.isZooming)return;const i=e.getActiveTab();if(null==i||!i.total)return;const s=e.toCanvas(t);if(s.length>1)return;this.canvasElX=t.screenX,this.canvasElY=t.screenY;const{pageX:n,pageY:o}=s[0];this.isStart=!0,this.startX=n,this.startY=o,this.lastX=n,this.lastY=o,this.startTime=(new Date).getTime();const{scrollLeft:r,scrollTop:a}=i.context;this.startScrollLeft=r,this.startScrollTop=a,this.isScrolling=!1,this.scrollTimer&&(hn.clearTimer(this.scrollTimer),this.scrollTimer=null);}moveHandler(t){if(!this.isStart)return;t instanceof PointerEvent&&t.cancelable&&t.preventDefault();const{context:e}=this;if(e.isZooming)return;const i=e.toCanvas(t);if(i.length>1)return;const s=e.getActiveTab(),{maxScrollLeft:n,maxScrollTop:o}=s.context;let{scrollLeft:r,scrollTop:a}=s.context;if(!n&&!o)return;const{viewerConfig:l}=e,{panThreshold:h,enablePanX:c,enablePanY:d}=l,{pageX:u,pageY:p}=i[0],g=u-this.startX,f=p-this.startY,v=u-this.lastX,m=p-this.lastY;if(e.isPanning){if(!r&&!a&&v>=0&&m>=0)return;if(r===n&&a===o&&v<=0&&m<=0)return;c&&(r=this.startScrollLeft-g),d&&(a=this.startScrollTop-f),r=Gs(r,0,n),a=Gs(a,0,o),e.viewService.scrollTo(r,a);}else e.isPanning=c&&Math.abs(g)>=h||d&&Math.abs(f)>=h;this.lastX=u,this.lastY=p;}endHandler(t){if(!this.isStart)return;this.isStart=!1,this.context.isPanning=!1;const{context:e}=this,i=e.toCanvas(t,!0);if(i.length>1)return;if(e.isZooming)return;if(km(t))return;if(this.canvasElX===t.screenX&&this.canvasElY===t.screenY)return;const{scrollLeft:s,scrollTop:n}=this.context.viewService.getMaxScrollValue(),{scrollLeft:o,scrollTop:r}=this.context.viewService.scrollContainer;if(!this.isScrolling&&(s>0||n>0)){const t=(new Date).getTime(),e=i[0].pageX,a=i[0].pageY,l=e-this.startX,h=a-this.startY;let c=!1,d=!1;l>0?(c=0!==o,this.scrollDirectionX="right"):(c=o!==s,this.scrollDirectionX="left"),h>0?(d=0!==r,this.scrollDirectionY="bottom"):(d=r!==n,this.scrollDirectionY="top");const u=t-this.startTime;if((Math.abs(l)>10||Math.abs(h)>10)&&u>0&&u<300&&(c||d)){let t=Math.abs(l)/u,e=Math.abs(h)/u;(t>.4||e>.4)&&(t=Math.min(t,2.8),e=Math.min(e,2.8),this.scroll(t,e,-.05));}}}scroll(t,e,i){this.isScrolling=!0;const{scrollLeft:s,scrollTop:n}=this.context.viewService.scrollContainer;let o=0,r=0;this.scrollTimer=hn.createTimer((()=>{const{scrollLeft:a,scrollTop:l}=this.context.viewService.getMaxScrollValue();if(t<=0&&e<=0||!1===this.isScrolling)return hn.clearTimer(this.scrollTimer),this.scrollTimer=null,void(this.isScrolling=!1);t>=0&&("right"===this.scrollDirectionX?o-=40*t:o+=40*t,t+=i),e>=0&&("bottom"===this.scrollDirectionY?r-=40*e:r+=40*e,e+=i);const h=Gs(s+o,0,a),c=Gs(n+r,0,l);this.context.viewService.scrollTo(h,c);}),25);}}class Sw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"scrollTimer",void 0),i(this,"wheelPosition",void 0),i(this,"isMouseInCanvas",void 0),i(this,"scrollLoadTimer",void 0),this.context=t;}scrollHandler(t){const{context:e}=this;if(e.scrollByCurrentChanged)return e.scrollByCurrentChanged=!1,void e.hooks.scroll.emit(t);const i=e.getActiveTab();if(null==i||!i.total)return;const{scrollLeft:s,scrollTop:n}=t.target;i.context.setTabScrollValue(s,n),e.visibilityService.handleVisibility(i),this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout((()=>{if(!e.isDestroyed&&i.isActive){if(e.isDefaultViewer){if(i.context.updateReference(),i.context.isContinuousDisplay&&e.viewerConfig.autoChangeIndex){const t=i.context.getCurrentByScroll();null!==t&&(i.gotoPage(t),e.visibilityService.handleVisibility(i),e.emitPageChangedEvent(i),e.emitPageChangedAfterRenderEvent(i),e.core.viewerService.onCurrentChangedByScroll.emit(Zg.create(i.uid,e.groupUid,e.uid,t)));}e.loadVisiblePages(i);}else e.isThumbnailViewer&&e.loadVisiblePages(i);this.scrollTimer=null;}}),25),this.scrollLoadTimer||(this.scrollLoadTimer=setTimeout((()=>{this.scrollLoadTimer=null,e.loadVisiblePages(i);}),20)),e.rendererService.render(i,55),e.hooks.scroll.emit(t);}handleHover(){if(!this.context.isThumbnailViewer||!this.wheelPosition)return;const[t]=this.context.toCanvas(this.wheelPosition),e=this.context.getPointerOverPageInfo(t.pageX,t.pageY),{page:i}=e.pageInfo;this.context.getActiveTab().preloadChildren.forEach((t=>{i&&i.uid===t.uid&&this.isMouseInCanvas?t.isHovered=!0:t.isHovered=!1;})),this.isMouseInCanvas=!1,this.wheelPosition=null;}wheelHandler(t){}wheelHandler1(t){if(!An(t)&&!kn(t))return;this.wheelPosition=t;const e=this.context.isPointerOverCanvas(t);this.isMouseInCanvas=e;const{context:i}=this,s=i.getActiveTab(),{maxScrollLeft:n,maxScrollTop:o,scrollLeft:r,scrollTop:a}=s.context;let{wheelDelta:l}=t;t.deltaY&&(l=-t.deltaY),1===t.deltaMode?l*=16:2===t.deltaMode&&(l=l<0?-100:100),t.shiftKey&&n?(l>0&&0!==r||l<0&&r!==n)&&(t.cancelable&&t.preventDefault(),i.scrollByCurrentChanged=!1,i.viewService.scrollBy(-l,0)):o&&(l<0&&a!==o||l>0&&0!==a)&&(t.cancelable&&t.preventDefault(),i.scrollByCurrentChanged=!1,i.viewService.scrollBy(0,-l));}}class Cw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"wheelTimer",void 0),i(this,"isStart",void 0),i(this,"isZooming",void 0),i(this,"startDistance",void 0),i(this,"touchZoomTimer",void 0),i(this,"startZoom",void 0),this.context=t,this.isZooming=!1,this.isStart=!1,this.startZoom=1;}zoomTo(t,e,i){var s;t=Tm(t);const{context:n}=this;if(!n.isDefaultViewer)return;const o=n.getActiveTab();if(null==o||!o.total)return;const{viewerConfig:r}=n;t=Gs(t,r.minZoom,r.maxZoom),js(e)&&js(i)||({originX:e,originY:i}=o.context.getZoomOriginCord());const a=null===(s=o.context.placeholderPages)||void 0===s?void 0:s.length;let l;a&&(l=o.context.generateReference(e,i));const h=o.context.zoom;if(o.context.setZoom(t),r.zoom=t,o.context.isZoomChanged=!0,a){n.layoutService.layout(o,57),n.viewService.updateScrollerContentSize(o),n.rendererService.updateCanvasSize();const{scrollLeft:t,scrollTop:s}=o.context.parseReferenceZoom(l,e,i);o.context.setTabScrollValue(t,s),n.viewService.scrollTo(t,s),n.visibilityService.handleVisibility(o),n.loadVisiblePages(o),n.clearCurrentTabOptimization(),n.loadVisiblePartData(),n.rendererService.render(o,57);}o.context.oldZoom=h,n.emitZoomChangedEvent(o);}wheelHandler(t){const{viewerConfig:e}=this.context;if(e.enableZoom&&e.enableZoomWithCtrl&&Tn(t)){let{wheelDelta:i}=t;t.deltaY&&(i=-t.deltaY),t.cancelable&&t.preventDefault(),this.wheelTimer||(this.wheelTimer=setTimeout((()=>{clearTimeout(this.wheelTimer),this.wheelTimer=null;const s=e.wheelZoomFactor||1,n=i>0?s:1/s,{left:o,top:r}=this.context.rendererService.getCanvasPageRect();this.zoomTo(e.zoom*n,t.pageX-o,t.pageY-r);}),40));}}touchstartHandler(t){const{context:e}=this,i=e.getActiveTab(),{displayMode:s}=i.context,n="continuous"===s||"single"===s;if(!e.viewerConfig.enableZoom||!n)return;const o=e.toCanvas(t);o.length<2||(e.isZooming=!0,this.startZoom=i.context.zoom,this.startDistance=Pw(o),this.isStart=!0);}touchmoveHandler(t){if(!this.isStart)return;t.cancelable&&t.preventDefault();const{context:e}=this,i=e.toCanvas(t);if(i.length<2)return;const s=(i[0].pageX+i[1].pageX)/2,n=(i[0].pageY+i[1].pageY)/2;let o=Pw(i)/this.startDistance;t.scale&&(o=t.scale);const r=e.getActiveTab();let{zoom:a}=r.context;const l=a;a=this.startZoom*o,a!==l&&(this.touchZoomTimer||(this.touchZoomTimer=setTimeout((()=>{this.zoomTo(a,s,n),clearTimeout(this.touchZoomTimer),this.touchZoomTimer=null;}),25))),e.isZooming=!0;}touchendHandler(t){this.isStart&&(this.isStart=!1,this.startZoom=1,this.context.isZooming=!1);}tapZoomHandler(t){const{toolMode:e,enableZoom:i,tapZoomFactor:s}=this.context.viewerConfig;if(!i)return;const n="zoomIn"===e,o="zoomOut"===e;if(!n&&!o)return;const r=this.context.toCanvas(t);if(r.length>1)return;const a=this.context.getActiveTab();let{zoom:l}=a.context;n?l*=s||1:o&&(l/=s||1),this.zoomTo(l,r[0].pageX,r[0].pageY);}}function Pw(t){return ((t[0].pageX-t[1].pageX)**2+(t[0].pageY-t[1].pageY)**2)**.5}class Tw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"isSliding",void 0),i(this,"slideDistance",void 0),i(this,"slideDirection",void 0),i(this,"slideRAF",void 0),i(this,"tabX",void 0),i(this,"tabY",void 0),this.context=t,this.isSliding=!1;}startHandler(t){if(!this.context.viewerConfig.enableSlide)return;if(this.isSliding)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;const{scrollLeft:i,scrollTop:s}=this.context.viewService.getMaxScrollValue();if(i>0||s>0)return;const n=this.context.toCanvas(t);if(n.length>1)return;const o=e.getPosition();this.tabX=o.x,this.tabY=o.y,this.startX=n[0].pageX,this.isStart=!0;}moveHandler(t){if(!this.isStart)return;const{context:e}=this,i=e.getActiveTab(),s=e.toCanvas(t)[0].pageX-this.startX;if(s>0?this.slideDirection="right":s<0&&(this.slideDirection="left"),this.slideDistance=Math.min(i.context.viewportWidth,Math.abs(s)),this.isSliding)"right"===this.slideDirection?i.setPosition({x:this.slideDistance+this.tabX,y:this.tabY,z:0}):"left"===this.slideDirection&&i.setPosition({x:-this.slideDistance+this.tabX,y:this.tabY,z:0}),e.render(42);else if("single"===i.context.displayMode&&"pan"===e.viewerConfig.toolMode&&e.viewerConfig.enableSlide){const{scrollLeft:t,scrollTop:i}=this.context.viewService.getMaxScrollValue();Math.abs(s)>e.viewerConfig.startSlideThreshold&&t<=0&&i<=0&&(this.isSliding=!0,this.context.isSliding=!0,e.configService.updateConfig({displayMode:"slide"}));}}endHandler(t){if(!this.isStart)return;const{context:e}=this;this.context.toCanvas(t,!0);const i=e.getActiveTab(),{displayMode:s}=i.context;"slide"===s&&this.slide(i),this.isStart=!1;}slide(t){let e,i=0,s=0,n=0,o=!1;const{viewerConfig:r}=this.context,a=t.context.viewportWidth*r.slideThresholdForPerspective;this.slideDistance>=Math.max(a,r.startSlideThreshold)?(s=t.context.viewportWidth,e=s-this.slideDistance,"left"===this.slideDirection?t.current!==t.total-1?(n=-this.slideDistance,i=-e/6):(s=0,e=this.slideDistance,o=!0,n=-this.slideDistance,i=e/6):0!==t.current?(n=this.slideDistance,i=e/6):(s=0,e=this.slideDistance,o=!0,n=this.slideDistance,i=-e/6)):(o=!0,s=0,e=this.slideDistance,"left"===this.slideDirection?(n=-this.slideDistance,i=e/6):(n=this.slideDistance,i=-e/6));const l=()=>{n+=i;const e=n>=0;if(Math.abs(n)>=s&&(n=s,e||(n*=-1)),t.setPosition({x:n+this.tabX,y:this.tabY,z:0}),Math.abs(n)===s)return o||("right"===this.slideDirection?this.context.viewer.gotoPage(t.current-1):this.context.viewer.gotoPage(t.current+1),this.context.configService.updateConfig({fitMode:"window"})),this.isSliding=!1,this.context.isSliding=!1,this.context.configService.updateConfig({displayMode:"single"}),void cancelAnimationFrame(this.slideRAF);this.slideRAF=requestAnimationFrame(l),this.context.render(43);};this.slideRAF=requestAnimationFrame(l);}}class Aw extends Qn{constructor(t){super(),i(this,"context",void 0),this.context=t;}handleOptimizationEvents(){let t;this.context.hooks.afterRender.on((e=>{"image"===this.context.viewerConfig.renderingMode&&this.context.viewerConfig.enableOptimizePage&&($s()||(t&&(clearTimeout(t),t=null),t=setTimeout((()=>{this.optimizeTab(e),t=null;}),500)));}));}dispose(){super.dispose(),this.context=null;}optimizeTab(t){t.visibleChildren.forEach((t=>{!t.isOptimized&&t.isVisible&&t.isLoaded&&setTimeout((()=>{!t.isOptimized&&t.isVisible&&t.isLoaded&&this.optimizePage(t.uid);}),500);}));}cancelOptimization(t){this.context.core.optimizationService.cancel(t);}optimizePage(t){if(!this.context)return;const{context:e}=this,{viewerConfig:i}=e;if(!i.enableOptimizePage)return;const s=e.getActiveTab();if(null==s||!s.total)return;const n=s.getPageByUid(t);if(!n)return;if(n.isOptimized||!n.isVisible||!n.isLoaded||n.optimizationUid===n.optimizedUid||e.isSliding||e.isDestroyed)return;const o=e.core.pageService.getPage(t);if(null==o||!o.display.img)return;const{img:r}=n.image.style;if(!r)return;const{naturalWidth:a,naturalHeight:l}=r;let h=a,c=l;const{maxOptimizationSize:d}=i;if(h>d||c>d||n.rWidth>d||n.rHeight>d)return;let u=0,p=0,g=0,f=0,v=0;({rWidth:h,rHeight:c,cropLeft:u,cropTop:p,cropWidth:g,cropHeight:f,rotation:v}=o.getEditResultForPixel());const m=devicePixelRatio,y=Math.floor(n.realTimeBox.width*m+.5)||1,x=Math.floor(n.realTimeBox.height*m+.5)||1;if(y>h||x>c)return;e.core.optimizationService.optimize(n.optimizationUid,(()=>{const t=Gn(o.mediaBox.left,Bo.displayResolution,o.resource.resolutionX),s=Gn(o.mediaBox.top,Bo.displayResolution,o.resource.resolutionX),d=new Wa({style:{x:-u+t,y:-p+s,img:r,width:a,height:l}});let m="rgba(0,0,0,0)";if(i.enableFillColor)m=i.blankFillColor;else if(i.viewerMode===lg.THUMBNAIL){let t=i.pageStyle;n.isSelected?t=i.selectedPageStyle:n.isHovered&&(t=i.hoveredPageStyle),m=t.background;}const w=new Ga({style:{x:-(g-h)/2,y:-(f-c)/2,width:g,height:f,background:m}});w.appendChild(d),w.setLocalAngle(v);const{commonCanvas:b}=e.core;b.render(w,h,c),b.reset();const S=b.getCanvas();n.isOptimized=!0;const C=S.getContext("2d"),P=Math.floor(h)||1,T=Math.floor(c)||1,A=C.getImageData(0,0,P,T);return {sourceWidth:P,sourceHeight:T,width:Math.ceil(y)||1,height:Math.ceil(x)||1,source:A,taskUid:n.optimizationUid}})).then((t=>{if(!e.isDestroyed&&n.isVisible&&t.taskUid===n.optimizationUid){n.isOptimized=!0,n.optimizedUid=n.optimizationUid;const i=e.core.commonCanvas.getCanvas().getContext("2d",{willReadFrequently:!0}).createImageData(y,x);i.data.set(t.target),n.realTimeBox.imageData=i,n.image.updateStyle({visibility:"hidden"}),n.isVisible&&e.render(41);}})).catch((t=>{n.isOptimized=!1;}));}}class kw extends Qn{constructor(t,e,s,n,o,r,a){super(),i(this,"context",void 0),i(this,"panModeInteraction",void 0),i(this,"cropModeInteraction",void 0),i(this,"annotationModeInteraction",void 0),i(this,"zoomInModeInteraction",void 0),i(this,"zoomOutModeInteraction",void 0),i(this,"textSelectionModeInteraction",void 0),this.context=t,this.panModeInteraction=e,this.cropModeInteraction=s,this.annotationModeInteraction=n,this.zoomInModeInteraction=o,this.zoomOutModeInteraction=r,this.textSelectionModeInteraction=a;}handleEvents(){if(this.context.isCaptureViewer)return;const{eventDom:t}=this.context;eo(t,"pointerdown",this).on((t=>{if(this.context.isPointerWorking=!0,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointerdownHandler(t),this.cropModeInteraction.pointerdownHandler(t),this.annotationModeInteraction.pointerdownHandler(t),this.zoomInModeInteraction.startHandler(t),this.zoomOutModeInteraction.startHandler(t),this.textSelectionModeInteraction.pointerdownHandler(t));})),eo(t,"pointermove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointermoveHandler(t,!1),this.cropModeInteraction.pointermoveHandler(t),this.panModeInteraction.cursorHandler(t),this.zoomInModeInteraction.moveHandler(t),this.zoomOutModeInteraction.moveHandler(t),this.textSelectionModeInteraction.pointermoveHandler(t));}),{passive:!1}),eo(t,"pointerup",this).on((t=>{if(this.context.isPointerWorking=!1,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&this.panModeInteraction.pointerupHandler(t);})),eo(document,"pointerdown",this).on((t=>{this.context.isPointerWorking=!0;})),eo(document,"pointermove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointermoveHandler(t,!0),this.panModeInteraction.pointerMoveForAutoScroll(t),this.annotationModeInteraction.pointermoveHandler(t),this.annotationModeInteraction.cursorHandler(t),this.textSelectionModeInteraction.pointerMoveForAutoScroll(t));}),{passive:!1}),eo(document,"pointerup",this).on((t=>{if(this.context.isPointerWorking=!1,0!==t.button)return;const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.pointerupHandler(t),this.cropModeInteraction.pointerupHandler(t),this.annotationModeInteraction.pointerupHandler(t),this.zoomInModeInteraction.endHandler(t),this.zoomOutModeInteraction.endHandler(t),this.textSelectionModeInteraction.pointerupHandler(t));})),eo(document,"visibilitychange",this).on((t=>{this.annotationModeInteraction.visibilityChangedHandler(),this.cropModeInteraction.visibilityChangedHandler(),this.panModeInteraction.visibilityChangedHandler(),this.textSelectionModeInteraction.visibilityChangedHandler();})),eo(t,"touchstart",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.touchstartHandler(t),this.cropModeInteraction.touchstartHandler(t),this.textSelectionModeInteraction.touchstartHandler(t));}),{passive:!1}),eo(t,"touchmove",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(t.cancelable&&t.preventDefault(),this.panModeInteraction.touchmoveHandler(t),this.cropModeInteraction.touchmoveHandler(t),this.textSelectionModeInteraction.touchmoveHandler(t));}),{passive:!1}),eo(t,"touchend",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.touchendHandler(t),this.cropModeInteraction.touchendHandler(t),this.textSelectionModeInteraction.touchendHandler(t));})),eo(t,"wheel",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.wheelHandler(t),this.cropModeInteraction.wheelHandler(t),this.annotationModeInteraction.wheelHandler(t),this.textSelectionModeInteraction.wheelHandler(t));}),{passive:!1}),eo(this.context.viewService.scrollContainer,"scroll",this).on((t=>{const e=this.context.getActiveTab();null!=e&&e.total&&(this.panModeInteraction.scrollHandler(t),this.cropModeInteraction.scrollHandler(t),this.annotationModeInteraction.scrollHandler(t),this.textSelectionModeInteraction.scrollHandler(t));})),eo(document,"keydown",this).on((t=>{if(!this.context.isFocusCanvas||!this.context.viewerConfig.enableKeyboardInteraction)return;const e=this.context.getActiveTab();null!=e&&e.total&&((t.ctrlKey||t.metaKey)&&"a"===t.key.toLowerCase()&&t.preventDefault(),this.panModeInteraction.keydownHandler(t),this.cropModeInteraction.keydownHandler(t),this.annotationModeInteraction.keydownHandler(t),this.zoomInModeInteraction.keydownHandler(t),this.zoomOutModeInteraction.keydownHandler(t),this.textSelectionModeInteraction.keydownHandler(t));})),eo(document,"keyup",this).on((t=>{if(!this.context.isFocusCanvas||!this.context.viewerConfig.enableKeyboardInteraction)return;this.context.getActiveTab()&&(this.panModeInteraction.keyupHandler(t),this.annotationModeInteraction.keyupHandler(t));})),eo(document,"pointerdown",this).on((t=>{var e;if(this.context.isDestroyed)return;if("hidden"===this.context.viewerConfig.visibility)return;if(t.target instanceof HTMLInputElement)return void(this.context.isFocusCanvas=!1);if(this.context.viewerConfig.hasThb&&this.context.viewService.thumbnailContainer.contains(t.target))return void(this.context.isFocusCanvas=!1);let i=!(null===(e=this.context.viewService.rootDom)||void 0===e||!e.contains(t.target));i||document.body.contains(t.target)||!this.context.isDefaultViewer||(i=!0),this.context.isFocusCanvas=i;}));}}class Dw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"startPage",void 0),i(this,"mouseOverPage",void 0),i(this,"lastMoveEvent",void 0),this.context=t,this.context.hooks.scroll.on((t=>{if(this.context.isThumbnailViewer){const t=this.context.getActiveTab();if(null==t||!t.total)return;this.lastMoveEvent&&this.moveHandler(this.lastMoveEvent);}}),this);}startHandler(t){const{context:e}=this,{viewerConfig:i,styleService:s}=e,n=this.context.getActiveTab();if(null==n||!n.total)return;this.isPointerdown=!0;const[o]=e.toCanvas(t),{page:r}=e.getPointerOverPageInfo(o.pageX,o.pageY).pageInfo;if(!r)return;if(this.startPage=r,!kn(t)&&!An(t))return;const a=n.getPageIndex(r),l=n.getCurrentPage(),h=t.shiftKey&&i.enableSelectWithShift;if(h&&n.selected.length){if(h&&l!==r&&n.shiftReference){const t=n.uidToIndex(n.shiftReference),i=Math.min(a,t),s=Math.max(a,t),o=[];for(let t=i;t<=s;t++)o.push(t);a<t&&o.reverse();const{shiftReference:r}=n;e.viewer.gotoPage(a),n.shiftReference=r,e.viewer.selectPagesByIndices(o);}}else i.multiselectMode||(r.uid!==n.currentUid?e.viewer.gotoPage(a):n.shiftReference=r.uid,r.isSelected||e.viewer.selectPagesByIndices([a]));}moveHandler(t){var e;const{context:i}=this,{styleService:s}=i;if(!km(t))return;const n=i.getActiveTab();if(null==n||!n.total)return;if(this.context.isPointerOverCanvas(t)?this.lastMoveEvent=t:this.lastMoveEvent=null,t.target!==this.context.eventDom&&!n.hoveredPage)return;const[o]=i.toCanvas(t),r=i.getPointerOverPageInfo(o.pageX,o.pageY),{page:a}=r.pageInfo,{mouseOverPage:l}=this;i.viewerConfig.enableOptimizePage&&!s.isBorderWidthEqualHovered()&&(l&&!l.isSelected&&(a&&l===a||i.clearOptimization([l.uid])),a&&!a.isSelected&&(l&&l===a||i.clearOptimization([a.uid]))),this.mouseOverPage=a;let h=!1;km(t)?n.hoveredPage?a?n.hoveredPage.uid!==a.uid&&(n.hoveredPage.isHovered=!1,n.hoveredPage=a,a.isHovered=!0,h=!0):(n.hoveredPage.isHovered=!1,n.hoveredPage=null,h=!0):a&&(n.hoveredPage=a,n.hoveredPage.isHovered=!0,h=!0):null!==(e=n.hoveredPage)&&void 0!==e&&e.isHovered&&(n.hoveredPage.isHovered=!1),h&&(i.layoutService.layout(n,56),i.visibilityService.handleVisibility(n),i.loadVisiblePartData(),i.rendererService.render(n,56));}endHandler(t){if(!this.isPointerdown)return;const{context:e}=this,[i]=e.toCanvas(t,!0),s=e.getActiveTab();if(null==s||!s.total)return;const n=e.getPointerOverPageInfo(i.pageX,i.pageY).pageInfo.page;if(n&&n===this.startPage)if(Pn(t)&&e.viewerConfig.enableSelectWithCtrl||e.viewerConfig.multiselectMode){const t=s.selected.slice(),i=t.indexOf(n.uid);n.isSelected?t.splice(i,1):t.push(n.uid);const o=s.uidsToIndices(t);if(n.uid!==s.currentUid){const t=s.uidToIndex(n.uid);e.viewer.gotoPage(t);}e.viewer.selectPagesByIndices(o);}else if(!Dn(t)){const t=s.getPageIndex(n);n.uid!==s.currentUid&&e.viewer.gotoPage(t),e.viewer.selectPagesByIndices([t]);}this.isPointerdown=!1,this.startPage=null;}keydownHandler(t){}}class Rw extends Qn{constructor(t){super(),i(this,"context",void 0),this.context=t;}selectAllHandler(t){this.context.viewerConfig.enableSelectAllWithKeyboard&&Pn(t)&&this.context.isThumbnailViewer&&(t.preventDefault(),this.context.viewer.selectAllPages());}undoHandler(t){this.context.viewerConfig.enableUndoWithKeyboard&&Pn(t)&&(t.preventDefault(),this.context.viewer.undo());}redoHandler(t){this.context.viewerConfig.enableRedoWithKeyboard&&Pn(t)&&(t.preventDefault(),this.context.viewer.redo());}zoomInHandler(t){this.context.viewerConfig.enableZoomInWithKeyboard&&Pn(t)&&(t.preventDefault(),this.context.viewer.zoomIn());}zoomOutHandler(t){this.context.viewerConfig.enableZoomOutWithKeyboard&&Pn(t)&&(t.preventDefault(),this.context.viewer.zoomOut());}arrowLeftHandler(t){const{context:e}=this;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollLeft:s,currentViewportWidth:n,scrollLeft:o}=i.context;t.preventDefault();const r=n/30;if(e.isDefaultViewer)kn(t)?0!==i.current&&e.viewer.gotoPage(i.current-1):An(t)&&(s?0===o?0!==i.current&&e.viewer.gotoPage(i.current-1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(-r,0)):0!==i.current&&e.viewer.gotoPage(i.current-1));else if(e.isThumbnailViewer){if(Dn(t))return;0!==i.current&&e.viewer.gotoPage(i.current-1);}}arrowRightHandler(t){const{context:e}=this;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollLeft:s,currentViewportWidth:n,scrollLeft:o}=i.context;t.preventDefault();const r=n/30;if(e.isDefaultViewer)kn(t)?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):An(t)&&(s?o===s?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r,0)):i.current!==i.total-1&&e.viewer.gotoPage(i.current+1));else if(e.isThumbnailViewer){if(Dn(t))return;i.current!==i.total-1&&e.viewer.gotoPage(i.current+1);}}arrowUpHandler(t){const{context:e}=this;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollTop:s,currentViewportHeight:n,scrollTop:o}=i.context;t.preventDefault();const r=n/30;if(e.isDefaultViewer)kn(t)&&(s?0===o?0!==i.current&&e.viewer.gotoPage(i.current-1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-r)):0!==i.current&&e.viewer.gotoPage(i.current-1));else if(e.isThumbnailViewer){if(Dn(t))return;const{rows:s,columns:n}=i.context,{current:o}=i,r=Math.floor(o/n),a=o%n;0===r?0!==i.current&&e.viewer.gotoPage(i.current-1):e.viewer.gotoPage(n*(r-1)+a);}}arrowDownHandler(t){const{context:e}=this;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const i=e.getActiveTab(),{maxScrollTop:s,currentViewportHeight:n,scrollTop:o}=i.context;t.preventDefault();const r=n/30;if(e.isDefaultViewer)kn(t)&&(s?o===s?i.current!==i.total-1&&e.viewer.gotoPage(i.current+1):(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,r)):i.current!==i.total-1&&e.viewer.gotoPage(i.current+1));else if(e.isThumbnailViewer){if(Dn(t))return;const{rows:s,columns:n}=i.context,{current:o}=i,r=Math.floor(o/n),a=o%n;if(r===Math.floor((i.total-1)/n))0!==i.current&&e.viewer.gotoPage(i.current+1);else {const t=Math.min(i.total-1,n*(r+1)+a);e.viewer.gotoPage(t);}}}escapeHandler(t){Dn(t)||(t.preventDefault(),this.context.viewer.updateViewerConfig({toolMode:"pan"}));}enterHandler(t){Dn(t)||t.preventDefault();}pageUpHandler(t){if(Dn(t))return;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:s,currentViewportHeight:n,scrollTop:o,scrollLeft:r}=i.context;t.preventDefault(),e.isDefaultViewer&&("single"===i.context.displayMode?s&&0!==o?(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-n)):0!==i.current&&(e.viewer.gotoPage(i.current-1),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r-i.context.scrollLeft,s)):"continuous"===i.context.displayMode&&s&&0!==o&&(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,-n)));}pageDownHandler(t){if(Dn(t))return;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab(),{maxScrollTop:s,currentViewportHeight:n,scrollTop:o,scrollLeft:r}=i.context;t.preventDefault(),e.isDefaultViewer&&("single"===i.context.displayMode?s&&o!==s?(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,n)):i.current!==i.total-1&&(e.viewer.gotoPage(i.current+1),e.scrollByCurrentChanged=!1,e.viewService.scrollBy(r-i.context.scrollLeft,0)):"continuous"===i.context.displayMode&&s&&o!==s&&(e.scrollByCurrentChanged=!1,e.viewService.scrollBy(0,n)));}homeHandler(t){if(Dn(t))return;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab();i.context,t.preventDefault(),e.isDefaultViewer?0!==i.current&&e.viewer.gotoPage(0):e.isThumbnailViewer&&0!==i.current&&e.viewer.gotoPage(0);}endHandler(t){if(Dn(t))return;if(t.preventDefault(),!this.context.viewerConfig.enableSelectPageWithKeyboard)return;const{context:e}=this,i=e.getActiveTab();i.context,t.preventDefault(),e.isDefaultViewer?i.current!==i.total-1&&e.viewer.gotoPage(i.total-1):e.isThumbnailViewer&&i.current!==i.total-1&&e.viewer.gotoPage(i.total-1);}}class Ew{constructor(t){i(this,"context",void 0),i(this,"isEditAnnotation",!1),i(this,"isMove",!1),i(this,"isSlide",!1),i(this,"isActivateAnnotation",!1),i(this,"isTouchstart",!1),i(this,"isPointerdown",!1),i(this,"isFirstMove",!0),i(this,"isPointerOnAnnotation",!1),i(this,"isAnnotationActive",!1),i(this,"activeShape",void 0),i(this,"pointerNum",0),i(this,"startPoint",void 0),i(this,"dragTimer",void 0),i(this,"isDragPages",!1),i(this,"isMoveForThumbnail",!1),i(this,"isMoved",!1),i(this,"canScroll",!0),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"isTextSelectionMode",!1),i(this,"isStartTextSelection",!1),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionTimer",void 0),i(this,"textSelectionTimerMobile",void 0),i(this,"isEditTextStart",!1),i(this,"isEditTextEnd",!1),i(this,"isMovedForTextSelection",!1),i(this,"isZoomedForTextSelection",!1),i(this,"textSelectionThreshold",1),i(this,"activeAnnotationThreshold",1),i(this,"moveThreshold",2),i(this,"slideThreshold",10),i(this,"clearSelectionTimerThreshold",3),i(this,"hasSelectedText",!1),i(this,"textPages",[]),i(this,"canPan",!1),i(this,"canvas",void 0),i(this,"clickTimer",void 0),i(this,"clickCount",0),i(this,"lastClickPoint",void 0),i(this,"isOverTextCtrlPoint",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),i(this,"isMovedForMultiClick",!1),i(this,"isHitTextCtrlPoint",!1),i(this,"autoScrollTimer",void 0),i(this,"hitPage",void 0),i(this,"isAutoScroll",!1),i(this,"lastAutoScrollEvent",void 0),i(this,"lastMoveEvent",void 0),this.context=t,this.canvas=this.context.rendererService.getCanvasDom(),this.context.hooks.afterRender.on((()=>{this.needRenderMagnifier&&this.context.magnifierService.render("text",this.canvas,this.magnifierPoint);}),this.context);}get isPanMode(){return "pan"===this.context.viewerConfig.toolMode}pointerdownHandler(t){if(this.isPointerdown||!this.isPanMode)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;if("slide"===e.context.displayMode)return;if(!this.context.isPointerOverCanvas(t))return;this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);const{isDefaultViewer:i,isThumbnailViewer:s,viewService:n,hasAnnotationModule:o,annotationEditService:r,selectPagesService:a,moveService:l,dragService:h,slideService:c,viewerConfig:{dragStartTimeThreshold:d,enableSlide:u,enableDragPage:p}}=this.context,{displayMode:g}=e.context;if(this.isPointerdown=!0,this.isFirstMove=!0,i){this.isAutoScroll=!1,this.isMovedForMultiClick=!1;const[i]=this.context.toCanvas(t);this.startPoint={x:i.pageX,y:i.pageY};const{page:s}=this.context.getPointerOverPageInfo(i.pageX,i.pageY).pageInfo;if(s){const n=this.context.core.pageService.getPage(s.uid),a=Nx(s.mediaBox,i.pageX,i.pageY,s.rotation),l={x:a.pointerX,y:a.pointerY};if(this.context.viewerConfig.enableTextSelection&&null!=n&&n.isTextPage&&n.visibleLines&&e.hasSelectedTexts()){const e=s.isPointOnTextStart(l),n=s.isPointOnTextEnd(l),o=!km(t);if((e||n)&&this.clickCount<1)return this.isHitTextCtrlPoint=!0,this.isEditTextStart=e,this.isEditTextEnd=n,this.context.hooks.beforeTextSelected.emit(),void(o&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY},this.context.render(29)))}else if(o){if(s){let{x:t,y:e}=s.cropBox.getPosition(),{width:i,height:n}=s.cropBox;const o=(s.rotation%360+360)%360/90;if(1===o?t-=n:2===o?(t-=i,e-=n):3===o&&(e-=i),1===o||3===o){const t=i;i=n,n=t;}r.setAnnotationContainer(s),r.setAnnotationInteractionArea({left:t,top:e,width:i,height:n});}const{isHit:e,shape:i,isHitSelected:n}=this.context.annotationEditService.isHitAnnotation(t);e&&s?(this.activeShape=i,this.isPointerOnAnnotation=!0,km(t)?km(t)&&(this.isAnnotationActive=!0,this.isEditAnnotation=!0,r.startHandler(t,!0)):n?(this.isAnnotationActive=!0,this.isEditAnnotation=!0,r.startHandler(t,!1)):(this.isActivateAnnotation=!0,r.deactivateAnnotation()),r.hasActiveAnnotation()&&(this.canScroll=!1)):r.deactivateAnnotation();}if(!this.isPointerOnAnnotation&&this.context.viewerConfig.enableTextSelection&&null!=n&&n.isTextPage&&n.visibleLines&&!this.isHitTextCtrlPoint){if(!km(t))!this.isStartTextSelection&&this.pointerNum<2&&(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=setTimeout((()=>{if(this.pointerNum>1)return;clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null;const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},s);if(t){this.isTextSelectionMode=!0,this.isStartTextSelection=!0,this.context.textSelectionService.clearSelectedTexts(),this.startTextPosition=t,this.endTextPosition=t;const{textPages:s,startCharRect:n,endCharRect:o,startTextPosition:r,endTextPosition:a}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);e.setTextSelection(s,n,o,r,a),this.hasSelectedText=!0,this.textPages=s,this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY}),this.context.render(30),this.context.hooks.beforeTextSelected.emit();}}),this.context.viewerConfig.enterTextModeTimeMobile));else if(km(t)&&this.isTextSelectionMode){const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},s);if(t&&(this.isStartTextSelection=!0,this.startTextPosition=t,this.context.textSelectionService.clearSelectedTexts(),this.context.hooks.beforeTextSelected.emit()),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.clickTimer=setTimeout((()=>{this.clickCount=0,this.clickTimer=null;}),this.context.viewerConfig.multipleClickTimeout),this.clickCount>0)if(this.lastClickPoint.x===i.pageX&&this.lastClickPoint.y===i.pageY){const i=e.uidToIndex(s.uid);1===this.clickCount?t&&this.selectClickedText(t.lineUid,l,s.uid,i,!0):this.clickCount>1&&t&&this.selectClickedText(t.lineUid,l,s.uid,i,!1),this.clickCount+=1;}else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};}}}else r.deactivateAnnotation();if(this.canPan&&(this.context.cursorService.applyCursorState(15),this.context.cursorService.lockCursor()),!this.isStartTextSelection){const{scrollLeft:e,scrollTop:i}=n.getMaxScrollValue();e>0||i>0?(this.isMove=!0,this.isSlide=!1,l.startHandler(t)):"single"===g&&u&&(this.isMove=!1,this.isSlide=!0,c.startHandler(t));}}else if(s){a.startHandler(t);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&!Pn(t)?(this.startX=t.pageX,this.startY=t.pageY,km(t)?km(t)&&(p?(this.isDragPages=!0,h.startHandler(t)):(this.isMoveForThumbnail=!0,l.startHandler(t))):p?this.dragTimer=setTimeout((()=>{this.isMoveForThumbnail||(this.isDragPages=!0,h.startHandler(t));}),d):(this.isMoveForThumbnail=!0,l.startHandler(t))):(this.isMoveForThumbnail=!0,l.startHandler(t));}}selectClickedText(t,e,i,s,n){if(!t)return;const o=this.context.getActiveTab();this.context.clearSelectedTexts();const r=this.context.core.pageService.getPage(i);if(!r.isTextPage)return;const a=r.lineMap.get(t).visibleIndex;let l;if(n){if(l=r.getSelectedTextWord(a,e),!l)return}else l=r.getSelectedTextSegment(a,e);if(!l)return;const{start:h,end:c}=l,d={...h,pageUid:r.uid,pageIndex:s,mediaBoxPoint:{...e}},u={...c,pageUid:r.uid,pageIndex:s,mediaBoxPoint:{...e}};this.startTextPosition=d,this.endTextPosition=u;const{textPages:p,startCharRect:g,endCharRect:f,startTextPosition:v,endTextPosition:m}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);o.setTextSelection(p,g,f,v,m),this.hasSelectedText=!0,this.textPages=p,this.context.render(31);}pointerMoveForAutoScroll(t){const e=this.context.getActiveTab();if(null!=e&&e.total&&!(this.pointerNum>1)&&this.isPanMode)if(this.context.isDefaultViewer&&this.isAutoScroll){if((e.context.maxScrollTop||e.context.maxScrollLeft)&&this.context.viewerConfig.enableAutoScrollForTextSelection){const e=this.checkPointermoveDirection(t);this.autoScroll(e);}}else if(this.context.isThumbnailViewer&&(e.context.maxScrollTop||e.context.maxScrollLeft)&&this.isDragPages&&this.context.viewerConfig.enableAutoScrollForDragPages){const e=this.checkPointermoveDirection(t);this.context.dragService.pointermoveForAutoScroll(t,e);}}autoScroll(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;const{maxScrollTop:i,scrollTop:s,maxScrollLeft:n,scrollLeft:o}=e.context,r=this.context.viewerConfig.autoScrollStepSize/xn();let a=!1;i&&t.top&&0!==s&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:i}=e.context;var s;t&&(0!==i?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(0,-r),this.pointermoveHandler(this.lastAutoScrollEvent,!1,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(0,-r)),i&&t.bottom&&s!==i&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:i}=e.context;var s;t&&(i!==t?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(0,r),this.pointermoveHandler(this.lastAutoScrollEvent,!1,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(0,r)),n&&t.left&&0!==o&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:i}=e.context;var s;t&&(0!==i?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(-r,0),this.pointermoveHandler(this.lastAutoScrollEvent,!1,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(-r,0)),n&&t.right&&o!==n&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:i}=e.context;var s;t&&(i!==t?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(r,0),this.pointermoveHandler(this.lastAutoScrollEvent,!1,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(r,0)),this.autoScrollTimer&&!a&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);}checkPointermoveDirection(t){const e={left:!1,top:!1,right:!1,bottom:!1};if(!this.context.getActiveTab())return e;const i=this.context.rendererService.getCanvasDom(),{top:s,bottom:n,left:o,right:r}=i.getBoundingClientRect();return t.clientY<s&&(e.top=!0),t.clientY>n&&(e.bottom=!0),t.clientX<o&&(e.left=!0),t.clientX>r&&(e.right=!0),e}pointermoveHandler(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.pointerNum>1)return;const s=this.context.getActiveTab();if(null==s||!s.total)return;if(!this.isPanMode)return;const{isDefaultViewer:n,isThumbnailViewer:o,viewService:r,moveService:a,slideService:l,annotationEditService:h,dragService:c,selectPagesService:d,textSelectionService:u}=this.context,{displayMode:p}=s.context;if(n&&!e){const[e]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;if(n){this.hitPage=n;const e=this.context.rendererService.getCanvasDom().getBoundingClientRect();!i&&e.top<=t.clientY&&e.bottom>=t.clientY&&e.left<=t.clientX&&e.right>=t.clientX&&(this.lastAutoScrollEvent=t);}if(this.autoScrollTimer&&!i&&(clearTimeout(this.autoScrollTimer),this.autoScrollTimer=null),this.isMovedForMultiClick=!0,this.isPointerdown){const i=an(this.startPoint,{x:e.pageX,y:e.pageY});if(i>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0),this.isPointerOnAnnotation&&!this.isAnnotationActive&&this.isFirstMove){i>this.activeAnnotationThreshold&&(this.isActivateAnnotation=!1);const{scrollLeft:e,scrollTop:s}=r.getMaxScrollValue();e>0||s>0?(this.isMove=!0,this.isSlide=!1,a.startHandler(t)):"single"===p&&(this.isMove=!1,this.isSlide=!0,l.startHandler(t));}if(i>=this.clearSelectionTimerThreshold&&!this.isStartTextSelection&&this.textSelectionTimerMobile&&(clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null),this.isEditAnnotation)h.moveHandler(t,!n);else if(this.isEditTextStart)this.isStartTextSelection=!0,this.isEditTextStart=!1,this.startTextPosition={...s.endTextPosition};else if(this.isEditTextEnd)this.isStartTextSelection=!0,this.isEditTextEnd=!1,this.startTextPosition={...s.startTextPosition};else if(this.context.viewerConfig.enableTextSelection&&this.isStartTextSelection){const{maxScrollTop:i,maxScrollLeft:o}=s.context;(i||o)&&this.context.viewerConfig.enableAutoScrollForTextSelection&&(this.isAutoScroll=!0);const r=this.context.core.pageService.getPage(null==n?void 0:n.uid);if(null!=r&&r.isTextPage&&r.visibleLines){this.context.cursorService.lockCursor();const i=this.context.calcTextEndPosition({x:e.pageX,y:e.pageY},n,s,this.startTextPosition.mediaBoxPoint);if(i){this.endTextPosition=i;const{textPages:n,startCharRect:o,endCharRect:r,startTextPosition:a,endTextPosition:l}=u.calcSelectedText(this.startTextPosition,this.endTextPosition);s.setTextSelection(n,o,r,a,l),this.hasSelectedText=!0,this.textPages=n,this.context.render(32);!km(t)&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY});}}}else this.isMove&&i>this.moveThreshold?(this.isActivateAnnotation=!1,a.moveHandler(t)):this.isSlide&&i>this.slideThreshold&&(this.isActivateAnnotation=!1,l.moveHandler(t));this.isFirstMove=!1;}else if(km(t)){this.textSelectionTimer&&(clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null,this.isTextSelectionMode=!1);const i=this.context.core.pageService.getPage(null==n?void 0:n.uid);if(null!=i&&i.isTextPage&&null!=i&&i.visibleLines){if(this.context.viewerConfig.enableTextSelection&&!this.isStartTextSelection){const s=Nx(n.mediaBox,e.pageX,e.pageY,n.rotation),o={x:s.pointerX,y:s.pointerY},r=n.isPointOnTextStart(o),a=n.isPointOnTextEnd(o);r||a?(this.isOverTextCtrlPoint=!0,this.context.cursorService.applyCursorState(16),this.canPan=!1):this.isOverTextCtrlPoint=!1;let l=!1;if(i.annotations.length){l=this.context.annotationEditService.isHitAnnotation(t).isHit;}if(l||this.isOverTextCtrlPoint)this.isTextSelectionMode=!1,this.canPan=!1,this.context.cursorService.applyCursorState(14);else {if(-1!==i.getHoveredTextLineIndex(o)){n.isPointOnTextSelection(o)||this.isTextSelectionMode||(this.textSelectionTimer&&clearTimeout(this.textSelectionTimer),this.textSelectionTimer=setTimeout((()=>{this.isTextSelectionMode=!0,this.context.cursorService.applyCursorState(16),clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null,this.canPan=!1;}),this.context.viewerConfig.enterTextModeTime));}else this.isTextSelectionMode=!1,this.textSelectionTimer&&(clearTimeout(this.textSelectionTimer),this.textSelectionTimer=null),this.context.cursorService.applyCursorState(14),this.canPan=!0;}}}else this.isTextSelectionMode=!1,this.context.cursorService.applyCursorState(14),this.canPan=!0;}}else if(o&&e)if(d.moveHandler(t),"touch"===t.pointerType){const e=an({x:this.startX,y:this.startY},{x:t.pageX,y:t.pageY});this.isPointerdown&&this.dragTimer&&(this.isDragPages||a.startHandler(t),e>5&&(clearTimeout(this.dragTimer),this.dragTimer=null)),this.isDragPages?(this.isMoved=!0,c.moveHandler(t)):!this.isDragPages&&this.isPointerdown&&(e>5&&(this.isMoveForThumbnail=!0,a.moveHandler(t)),this.isMoved=!0);}else this.isPointerdown&&this.dragTimer&&(this.isDragPages||a.startHandler(t),clearTimeout(this.dragTimer),this.dragTimer=null),this.isDragPages?(this.isMoved=!0,c.moveHandler(t)):!this.isDragPages&&this.isPointerdown&&(this.isMoveForThumbnail=!0,a.moveHandler(t),this.isMoved=!0);this.lastMoveEvent=t;}cursorHandler(t){if(!km(t))return;if(!this.context.isDefaultViewer)return;if("pan"!==this.context.viewerConfig.toolMode)return;if(this.isTextSelectionMode||this.isOverTextCtrlPoint)return void this.context.cursorService.applyCursorState(16);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&this.context.annotationEditService.cursorHandler(t);}pointerupHandler(t){if(!this.isPointerdown)return;this.context.cursorService.unlockCursor();const{isDefaultViewer:e,isThumbnailViewer:i,annotationEditService:s,moveService:n,slideService:o,dragService:r,selectPagesService:a,textSelectionService:l}=this.context;if(e){if(this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null),this.isAutoScroll=!1,this.hitPage&&(this.hitPage=null),this.isEditAnnotation?s.endHandler(t):this.isActivateAnnotation?(s.activateAnnotation(this.activeShape,Pn(t)),this.context.render(33)):this.isMove?n.endHandler(t):this.isSlide&&o.endHandler(t),this.isStartTextSelection||this.isMovedForTextSelection||this.isZoomedForTextSelection||l.clearSelectedTexts(),this.isTextSelectionMode&&km(t)&&this.lastClickPoint){const[e]=this.context.toCanvas(t);e.pageX===this.lastClickPoint.x&&e.pageY===this.lastClickPoint.y||(this.clickCount=0,this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null));}if(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimer&&clearTimeout(this.textSelectionTimer),this.needRenderMagnifier&&this.context.magnifierService.hide(),this.magnifierPoint=null,this.needRenderMagnifier=!1,this.hasSelectedText){this.hasSelectedText=!1;const t=nf.create(this.context.textSelectionService.getSelectedTexts(),this.textPages);this.textPages=[],this.context.hooks.textSelected.emit(t),this.context.hooks.afterTextSelected.emit(),this.context.render(34);}}else if(i){this.dragTimer&&(clearTimeout(this.dragTimer),this.dragTimer=null);const e=an({x:this.startX,y:this.startY},{x:t.pageX,y:t.pageY});(!this.isMoved||e<this.context.viewerConfig.dragThreshold)&&a.endHandler(t),this.isDragPages?r.endHandler():n.endHandler(t);}this.isHitTextCtrlPoint=!1,this.isPointerdown=!1,this.isFirstMove=!0,this.isEditAnnotation=!1,this.isMove=!1,this.isSlide=!1,this.isActivateAnnotation=!1,this.isPointerOnAnnotation=!1,this.isAnnotationActive=!1,this.activeShape=null,this.isMoveForThumbnail=!1,this.isDragPages=!1,this.isMoved=!1,this.canScroll=!0,this.startPoint=null,this.isStartTextSelection=!1,0===this.clickCount&&this.isMovedForMultiClick&&(this.isTextSelectionMode=!1),this.isMovedForTextSelection=!1,this.isEditTextStart=!1,this.isEditTextEnd=!1,this.isZoomedForTextSelection=!1,this.isOverTextCtrlPoint=!1,this.canPan&&this.context.applyCursorState(14);}visibilityChangedHandler(){this.lastMoveEvent&&(this.pointerupHandler(this.lastMoveEvent),this.lastMoveEvent=null);}touchstartHandler(t){if(this.pointerNum=t.targetTouches.length,this.context.isDefaultViewer){const{enableZoom:e,enableZoomInPanMode:i,enableZoomWithTouch:s}=this.context.viewerConfig;if(!this.isPanMode||2!==t.targetTouches.length||this.isTouchstart||!e||!s||!i)return;this.isTouchstart=!0,this.context.zoomService.touchstartHandler(t);}}touchmoveHandler(t){this.pointerNum=t.targetTouches.length,2===t.targetTouches.length&&this.isTouchstart&&this.context.isDefaultViewer&&(this.context.zoomService.touchmoveHandler(t),this.isZoomedForTextSelection=!0);}touchendHandler(t){this.pointerNum=t.targetTouches.length,this.isTouchstart&&(this.isTouchstart=!1,this.context.isDefaultViewer&&this.context.zoomService.touchendHandler(t));}wheelHandler(t){if(this.pointerNum=0,!this.isPanMode)return;if(!this.canScroll)return void t.preventDefault();const{isDefaultViewer:e,isThumbnailViewer:i,viewerConfig:{enableZoom:s,enableZoomInPanMode:n,enableZoomWithCtrl:o},zoomService:r,scrollService:a}=this.context;if(e)if(Tn(t)){if(!s||!n||!o)return;r.wheelHandler(t);}else a.wheelHandler(t);else i&&a.wheelHandler(t);}scrollHandler(t){this.isPanMode&&this.canScroll&&(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isPanMode)return;const{context:e,context:{keyboardService:i,annotationEditService:s,viewerConfig:{enableKeyboardInteraction:n,enableZoom:o,enableZoomInPanMode:r,enableCopyCutPasteWithKeyboard:a},isPointerWorking:l}}=this;if(!n||l)return;const h=Pn(t);if(e.isDefaultViewer){if(this.context.annotationEditService.hasActiveAnnotation()){if(h)switch(t.key){case"c":case"C":a&&s.copyAnnotations();break;case"x":case"X":a&&s.cutAnnotations();break;case"v":case"V":a&&s.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}else if(An(t)||kn(t)){const e=this.context.annotationEditService.containerPage;if(e){let{x:t,y:i}=e.cropBox.getPosition(),{width:n,height:o}=e.cropBox;const r=(e.rotation%360+360)%360/90;if(1===r?t-=o:2===r?(t-=n,i-=o):3===r&&(i-=n),1===r||3===r){const t=n;n=o,o=t;}s.setAnnotationContainer(e),s.setAnnotationInteractionArea({left:t,top:i,width:n,height:o});}s.keydownHandler(t);}return}if(h)switch(t.key){case"c":case"C":{const e=this.context.getActiveTab();e&&e.hasSelectedTexts()&&(t.preventDefault(),this.context.copySelectedTexts());break}case"v":case"V":a&&s.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}switch(t.key){case"Escape":i.escapeHandler(t);break;case"Enter":i.enterHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}else if(e.isThumbnailViewer)switch(t.key){case"a":case"A":i.selectAllHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}keyupHandler(t){if(!this.isPanMode)return;const{context:e,context:{annotationEditService:i,viewerConfig:{enableKeyboardInteraction:s}}}=this;s&&e.isDefaultViewer&&i.keyupHandler(t);}}class Mw{constructor(t){i(this,"context",void 0),i(this,"isEditCropBox",!1),i(this,"isTouchstart",!1),i(this,"isPointerdown",!1),i(this,"pointerNum",0),i(this,"lastMoveEvent",void 0),this.context=t;}get isCropMode(){return "crop"===this.context.viewerConfig.toolMode}pointerdownHandler(t){if(this.isPointerdown||!this.isCropMode)return;if(!this.context.isPointerOverCanvas(t))return;const e=km(t);this.isPointerdown=!0;const{context:i}=this;i.hasBoxRendererModule?(i.isDefaultViewer?(this.isEditCropBox=i.cropBoxEditService.isEditCropBox(t),this.isEditCropBox?i.cropBoxEditService.startHandler(t):(i.moveService.startHandler(t),e&&i.applyCursorState(15))):i.isPerspectiveViewer&&(i.perspectiveQuadEditService.startHandler(t),e&&i.perspectiveQuadEditService.isNotOverQuadCtrl(t)&&i.applyCursorState(15)),i.cursorService.lockCursor()):i.isDefaultViewer&&i.moveService.startHandler(t);}pointermoveHandler(t){if(this.pointerNum>1||!this.isCropMode)return;const e=km(t),{context:i}=this;if(i.isDefaultViewer){i.cropBoxEditService.moveHandler(t);const s=this.context.getActiveTab(),[n]=this.context.toCanvas(t),{page:o}=this.context.getPointerOverPageInfo(n.pageX,n.pageY).pageInfo;(!o||o.uid!==s.currentUid||e&&i.cropBoxEditService.isNotOverCropBox(t))&&i.cursorService.applyCursorState(14),!this.isEditCropBox&&this.isPointerdown&&i.moveService.moveHandler(t);}else if(i.isPerspectiveViewer){const s=i.perspectiveQuadEditService.isNotOverQuadCtrl(t);i.perspectiveQuadEditService.moveHandler(t),e&&s&&i.cursorService.applyCursorState(14);}this.lastMoveEvent=t;}pointerupHandler(t){if(!this.isPointerdown||!this.isCropMode)return;const{context:e}=this;e.cursorService.unlockCursor(),e.isDefaultViewer?this.isEditCropBox?e.cropBoxEditService.endHandler(t):e.moveService.endHandler(t):e.isPerspectiveViewer&&e.perspectiveQuadEditService.endHandler(t),this.isPointerdown=!1,this.isEditCropBox=!1;}visibilityChangedHandler(){this.lastMoveEvent&&(this.pointerupHandler(this.lastMoveEvent),this.lastMoveEvent=null);}touchstartHandler(t){this.pointerNum=t.targetTouches.length;const{context:e,context:{viewerConfig:i}}=this;if(e.isDefaultViewer){if(!this.isCropMode||2!==t.targetTouches.length||this.isTouchstart||!i.enableZoom||!i.enableZoomWithTouch||!i.enableZoomInCropMode)return;this.isTouchstart=!0,e.zoomService.touchstartHandler(t);}}touchmoveHandler(t){this.pointerNum=t.targetTouches.length,2===t.targetTouches.length&&this.isTouchstart&&this.context.isDefaultViewer&&this.context.zoomService.touchmoveHandler(t);}touchendHandler(t){this.pointerNum=t.targetTouches.length,this.isTouchstart&&(this.isTouchstart=!1,this.context.isDefaultViewer&&this.context.zoomService.touchendHandler(t));}wheelHandler(t){if(this.pointerNum=0,!this.isCropMode)return;const{context:e,context:{viewerConfig:i}}=this;if(e.isDefaultViewer)if(Pn(t)){if(!i.enableZoom||!i.enableZoomInCropMode||!i.enableZoomWithCtrl)return;e.zoomService.wheelHandler(t);}else e.isPointerWorking||e.scrollService.wheelHandler(t);}scrollHandler(t){if(!this.isCropMode)return;const{context:e}=this;(e.isDefaultViewer||e.isThumbnailViewer)&&e.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isCropMode)return;const{keyboardService:e,isDefaultViewer:i,viewerConfig:{enableKeyboardInteraction:s,enableZoom:n,enableZoomInCropMode:o},isPointerWorking:r}=this.context;if(i&&s&&!r)switch(t.key){case"y":case"Y":e.redoHandler(t);break;case"z":case"Z":e.undoHandler(t);break;case"-":n&&o&&e.zoomOutHandler(t);break;case"=":n&&o&&e.zoomInHandler(t);break;case"Escape":e.escapeHandler(t);break;case"Enter":e.enterHandler(t);break;case"PageUp":e.pageUpHandler(t);break;case"PageDown":e.pageDownHandler(t);break;case"Home":e.homeHandler(t);break;case"End":e.endHandler(t);break;case"ArrowLeft":e.arrowLeftHandler(t);break;case"ArrowRight":e.arrowRightHandler(t);break;case"ArrowUp":e.arrowUpHandler(t);break;case"ArrowDown":e.arrowDownHandler(t);}}}class Iw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"pointerId",null),i(this,"canScroll",!0),i(this,"lastMoveEvent",void 0),this.context=t;}get isAnnotationMode(){return "annotation"===this.context.viewerConfig.toolMode}get isTextAssistMode(){return ["highlight","underline","strikeout"].includes(this.context.viewerConfig.annotationMode)}pointerdownHandler(t){if(this.isPointerdown||!this.isAnnotationMode)return;if(this.pointerId)return;if(!this.context.hasBoxRendererModule||!this.context.isDefaultViewer)return;if(!this.context.isPointerOverCanvas(t))return;const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;if(!i)return;this.isPointerdown=!0,this.pointerId=t.pointerId;let{x:s,y:n}=i.cropBox.getPosition(),{width:o,height:r}=i.cropBox;const a=(i.rotation%360+360)%360/90;if(1===a?s-=r:2===a?(s-=o,n-=r):3===a&&(n-=o),1===a||3===a){const t=o;o=r,r=t;}this.context.annotationEditService.setAnnotationContainer(i),this.context.annotationEditService.setAnnotationInteractionArea({left:s,top:n,width:o,height:r}),this.context.annotationEditService.startHandler(t,!0),this.context.annotationEditService.hasActiveAnnotation()&&(this.canScroll=!1);}pointermoveHandler(t){if((this.pointerId===t.pointerId||"touch"!==t.pointerType)&&this.isAnnotationMode){if(this.context.isDefaultViewer){const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;this.context.annotationEditService.moveHandler(t,!i);}this.lastMoveEvent=t;}}cursorHandler(t){if(!km(t))return;if(!this.context.isDefaultViewer)return;if(!this.isAnnotationMode)return;if(this.isTextAssistMode&&!this.context.annotationEditService.isMouseOverText)return void this.context.cursorService.applyCursorState(1);const[e]=this.context.toCanvas(t),{page:i}=this.context.getPointerOverPageInfo(e.pageX,e.pageY).pageInfo;i&&this.context.annotationEditService.cursorHandler(t);}pointerupHandler(t){this.isPointerdown&&(this.context.isDefaultViewer&&this.context.annotationEditService.endHandler(t),this.isPointerdown=!1,this.canScroll=!0,this.pointerId=null);}visibilityChangedHandler(){this.lastMoveEvent&&(this.pointerupHandler(this.lastMoveEvent),this.lastMoveEvent=null);}wheelHandler(t){if(this.isAnnotationMode)if(this.canScroll){if(this.context.isDefaultViewer)if(Pn(t)){const{enableZoom:e,enableZoomInAnnotationMode:i,enableZoomWithCtrl:s}=this.context.viewerConfig;if(!e||!i||!s)return;this.context.zoomService.wheelHandler(t);}else this.context.scrollService.wheelHandler(t);}else t.preventDefault();}scrollHandler(t){this.isAnnotationMode&&this.canScroll&&(this.context.isDefaultViewer||this.context.isThumbnailViewer)&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isAnnotationMode)return;const{context:e,context:{keyboardService:i,annotationEditService:s,viewerConfig:{enableKeyboardInteraction:n,enableZoom:o,enableZoomInAnnotationMode:r,enableCopyCutPasteWithKeyboard:a},hasAnnotationModule:l,isPointerWorking:h}}=this;if(n&&!h&&e.isDefaultViewer)if(this.context.annotationEditService.hasActiveAnnotation()){if(Pn(t))switch(t.key){case"c":case"C":a&&s.copyAnnotations();break;case"x":case"X":a&&s.cutAnnotations();break;case"v":case"V":a&&s.pasteAnnotations();break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}else if(An(t)||kn(t)){const e=this.context.annotationEditService.containerPage;if(e){let{x:t,y:i}=e.cropBox.getPosition(),{width:n,height:o}=e.cropBox;const r=(e.rotation%360+360)%360/90;if(1===r?t-=o:2===r?(t-=n,i-=o):3===r&&(i-=n),1===r||3===r){const t=n;n=o,o=t;}s.setAnnotationContainer(e),s.setAnnotationInteractionArea({left:t,top:i,width:n,height:o});}s.keydownHandler(t);}}else {if(Pn(t))switch(t.key){case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"v":case"V":a&&s.pasteAnnotations();break;case"-":o&&r&&i.zoomOutHandler(t);break;case"=":o&&r&&i.zoomInHandler(t);}switch(t.key){case"Escape":i.escapeHandler(t);break;case"Enter":i.enterHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}keyupHandler(t){if(!this.isAnnotationMode)return;const{context:e,context:{annotationEditService:i,viewerConfig:{enableKeyboardInteraction:s}}}=this;s&&e.isDefaultViewer&&i.keyupHandler(t);}}class Bw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),this.context=t;}get isZoomInMode(){return "zoomIn"===this.context.viewerConfig.toolMode}startHandler(t){!this.isPointerdown&&this.context.isDefaultViewer&&(this.context.zoomService.tapZoomHandler(t),this.isPointerdown=!0);}moveHandler(t){km(t)&&this.context.isDefaultViewer&&"zoomIn"===this.context.viewerConfig.toolMode&&this.context.cursorService.applyCursorState(26);}endHandler(t){this.isPointerdown&&(this.isPointerdown=!1);}keydownHandler(t){if(!this.isZoomInMode||!this.context.isDefaultViewer)return;const{context:{viewerConfig:e}}=this;if(!e.enableKeyboardInteraction||!e.enableZoom||!e.enableZoomInWithKeyboard||this.context.isPointerWorking)return;const{keyboardService:i}=this.context;switch(t.key){case"-":i.zoomInHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}class Uw{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),this.context=t;}get isZoomOutMode(){return "zoomOut"===this.context.viewerConfig.toolMode}startHandler(t){!this.isPointerdown&&this.context.isDefaultViewer&&(this.context.zoomService.tapZoomHandler(t),this.isPointerdown=!0);}moveHandler(t){km(t)&&this.context.isDefaultViewer&&"zoomOut"===this.context.viewerConfig.toolMode&&this.context.cursorService.applyCursorState(27);}endHandler(t){this.isPointerdown&&(this.isPointerdown=!1);}keydownHandler(t){if(!this.isZoomOutMode||!this.context.isDefaultViewer)return;const{context:{viewerConfig:e}}=this;if(!e.enableKeyboardInteraction||!e.enableZoom||!e.enableZoomOutWithKeyboard||this.context.isPointerWorking)return;const{keyboardService:i}=this.context;switch(t.key){case"=":i.zoomOutHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}class Lw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"lastSelectResult",void 0),i(this,"selectedTextPages",new Map),this.context=t,t.hooks.toolModeChanged.on((()=>{this.clearSelectedTexts();}),this),this.context.hooks.annotationModeChanged.on((()=>{"annotation"===this.context.viewerConfig.toolMode&&this.clearSelectedTexts();}),this);}calcSelectedText(t,e){const i=this.context.getActiveTab(),s=[];let n,o;const r=this.context.core.pageService.getPage(t.pageUid),a=this.context.core.pageService.getPage(e.pageUid),l=r.lineMap.get(t.lineUid),h=a.lineMap.get(e.lineUid);let c={...t,lineIndex:l.visibleIndex,charIndex:r.charMap.get(t.charUid).indexInMergeLine,pageIndex:i.uidToIndex(t.pageUid)},d={...e,lineIndex:h.visibleIndex,charIndex:a.charMap.get(e.charUid).indexInMergeLine,pageIndex:i.uidToIndex(e.pageUid),mediaBoxPoint:e.mediaBoxPoint};if(c.pageIndex===d.pageIndex&&(c.lineIndex>d.lineIndex||c.lineIndex===d.lineIndex&&c.charIndex>d.charIndex)||c.pageIndex>d.pageIndex){const t=c;c=d,d=t;}const u={...c},p={...d},g=this.context.core.pageService.getPage(c.pageUid);let f=g.visibleLines.find((t=>t.uid===c.lineUid));f||([f]=g.visibleLines,c.lineIndex=0,c.charIndex=0,c.lineUid=f.uid,c.charUid=f.chars[f.startIndex].uid);const v=this.context.core.pageService.getPage(d.pageUid);let m=v.visibleLines.find((t=>t.uid===d.lineUid));m||(m=v.visibleLines[v.visibleLines.length-1],d.lineIndex=m.visibleIndex,d.charIndex=m.endIndex,d.lineUid=m.uid,d.charUid=m.chars[m.endIndex].uid);for(let t=c.pageIndex;t<=d.pageIndex;t++){var y;const e=i.getPageByIndex(t),r=this.context.core.pageService.getPage(e.uid);if(!r.isTextPage)continue;if(null===(y=r.visibleLines)||void 0===y||!y.length)continue;const a=this.selectedTextPages.get(e.uid);if(a&&t>c.pageIndex&&t<d.pageIndex){s.push(a);continue}const l={pageUid:e.uid,lines:[],text:""};let h=0,u=r.visibleLines.length-1;t===c.pageIndex&&(h=c.lineIndex),t===d.pageIndex&&(u=d.lineIndex);let p="";for(let e=h;e<=u;e++){const i=r.visibleLines[e];let s=i.startIndex,a=i.endIndex;t===c.pageIndex&&e===c.lineIndex&&(s=c.charIndex,n=r.getEndCharRect(e,s)),t===d.pageIndex&&e===d.lineIndex&&(a=d.charIndex,o=r.getEndCharRect(e,a)),a=Math.min(a,i.endIndex),s=Math.max(s,i.startIndex);const h=r.getSelectedTextLine(e,Math.min(s,a),Math.max(s,a));l.lines.push(h),p+=h.text;}l.lines=r.doMergeAdjacentLines(l.lines),t===c.pageIndex&&(n.top=l.lines[0].selectedRect.top,n.height=l.lines[0].selectedRect.height),t===d.pageIndex&&(o.top=l.lines[l.lines.length-1].selectedRect.top,o.height=l.lines[l.lines.length-1].selectedRect.height),l.text=p,s.push(l),t>c.pageIndex&&t<d.pageIndex&&!a&&this.selectedTextPages.set(e.uid,l);}return {textPages:s,startCharRect:n,endCharRect:o,startTextPosition:u,endTextPosition:p}}getSelectedTexts(){let t="";const e=this.context.getActiveTab();if(!e)return "";if(e.selectedTextsCache)return e.selectedTextsCache;const i=e.startTextPosition,s=e.endTextPosition;if(!i||!s)return "";const n=this.context.core.pageService.getPage(i.pageUid),o=this.context.core.pageService.getPage(s.pageUid),r=n.lineMap.get(i.lineUid),a=o.lineMap.get(s.lineUid);let l={...i,lineIndex:r.visibleIndex,charIndex:n.charMap.get(i.charUid).indexInMergeLine,pageIndex:e.uidToIndex(i.pageUid)},h={...s,lineIndex:a.visibleIndex,charIndex:o.charMap.get(s.charUid).indexInMergeLine,pageIndex:e.uidToIndex(s.pageUid),mediaBoxPoint:s.mediaBoxPoint};if(l.pageIndex===h.pageIndex&&l.lineIndex>h.lineIndex||l.pageIndex>h.pageIndex){const t=l;l=h,h=t;}for(let i=l.pageIndex;i<=h.pageIndex;i++){var c;const s=e.getPageByIndex(i),n=this.context.core.pageService.getPage(s.uid);if(!n.isTextPage)continue;if(null===(c=n.visibleLines)||void 0===c||!c.length)continue;let o="",r=0,a=n.visibleLines.length-1;i===l.pageIndex&&(r=l.lineIndex),i===h.pageIndex&&(a=h.lineIndex);for(let t=r;t<=a;t++){let e=n.visibleLines[t].startIndex,s=n.visibleLines[t].endIndex;i===l.pageIndex&&t===l.lineIndex&&(e=l.charIndex),i===h.pageIndex&&t===h.lineIndex&&(s=h.charIndex);o+=n.getSelectedTextsStr(t,Math.min(e,s),Math.max(e,s),t!==a||i!==h.pageIndex);}t+=o;}return e.selectedTextsCache=t,t}clearSelectedTexts(){this.lastSelectResult=null,this.selectedTextPages.clear();const t=this.context.getActiveTab();if(t){if(t.clearTextSelection()){const t=nf.create("",[]);this.context.hooks.textSelected.emit(t),this.context.render(44);}}}getTextSelectionLines(){const t=this.context.getActiveTab();if(!t)return null;return t.getTextSelectionLines()}getTextSelectionControlPointsRect(){const t=this.context.getActiveTab();return t?t.getTextSelectionControlPointsRect():null}getTextSelection(){if(!this.context.getActiveTab())return [];const t=this.getTextSelectionLines();if(!t)return [];const e=[],i=Bo.displayResolution,s=Bo.dataResolution;return t.forEach((t=>{const n=[];t.lines.forEach((t=>{n.push({x:Gn(t.selectedRect.left,i,s),y:Gn(t.selectedRect.top,i,s),width:Gn(t.selectedRect.width,i,s),height:Gn(t.selectedRect.height,i,s)});})),e.push({pageUid:t.pageUid,text:t.text,rects:n});})),e}}class Ow extends Qn{constructor(t){super(),i(this,"currentCursor","default"),i(this,"lastCursor","default"),i(this,"lastCursorState",void 0),i(this,"context",void 0),i(this,"isLocked",!1),this.context=t;}applyCursorState(t){if(!t||this.isLocked)return;const{cursorStyle:e}=this.context.viewerConfig;let i=null;switch(t){case 1:i=e.default;break;case 2:i=e.annotationSelect;break;case 3:i=e.annotationDraw;break;case 4:i=e.annotationMove;break;case 5:i=e.annotationNSResize;break;case 6:i=e.annotationEWResize;break;case 7:i=e.annotationNWResize;break;case 8:i=e.annotationNEResize;break;case 10:i=e.annotationSEResize;break;case 9:i=e.annotationSWResize;break;case 11:i=e.annotationRotate;break;case 12:i=e.annotationErase;break;case 13:i=e.annotationActivable;break;case 14:i=e.pan;break;case 15:i=e.panning;break;case 16:i=e.text;break;case 18:i=e.cropDraw;break;case 19:i=e.cropMove;break;case 20:i=e.cropNSResize;break;case 21:i=e.cropEWResize;break;case 22:i=e.cropNWResize;break;case 23:i=e.cropNEResize;break;case 25:i=e.cropSEResize;break;case 24:i=e.cropSWResize;break;case 26:i=e.zoomIn;break;case 27:i=e.zoomOut;}i&&(this.lastCursorState=t,this.setCursor(i));}setCursor(t){this.lastCursor=this.currentCursor,this.currentCursor=t,this.applyCursor();}resetCursor(){this.currentCursor=this.lastCursor,this.applyCursor();}applyCursor(){if(!this.context.viewerConfig.enableCursorService)return;const{eventDom:t}=this.context;(null==t?void 0:t.style.cursor)!==this.currentCursor&&(t.style.cursor=this.currentCursor);}lockCursor(){this.isLocked=!0;}unlockCursor(){this.isLocked=!1;}}class Nw{constructor(t,e,s){i(this,"service",void 0),i(this,"text",void 0),i(this,"options",void 0),i(this,"cacheMap",new Map),i(this,"uid",qs()),i(this,"isStopped",!1),i(this,"searchType",void 0),i(this,"pageUids",[]),i(this,"curSearch",void 0),i(this,"isComplete",!1),i(this,"isNotFound",!1),i(this,"tasks",new Map),i(this,"curTask",null),i(this,"deletePageTimer",void 0),this.service=t,this.text=e,this.options=s;const n=this.service.context.getActiveTab();this.pageUids=(null==n?void 0:n.getAllPageUids())||[];}hasResult(){return this.cacheMap.size>0}async searchNextText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.breakTask(),this.isStopped)return null;if(this.isNotFound)return null;this.isNotFound=!1;let i=!1;if(this.curSearch){const t=this.cacheMap.get(this.curSearch.pageUid);this.curSearch.index===t.texts.length-1?(this.curSearch.pageIndex!==this.pageUids.length-1?this.curSearch.pageIndex+=1:this.curSearch.pageIndex=0,this.curSearch.pageUid=this.pageUids[this.curSearch.pageIndex],i=!0):this.curSearch.index+=1;}else this.curSearch={pageUid:this.pageUids[0],pageIndex:0,index:0};const s=this.pageUids.slice(this.curSearch.pageIndex).concat(this.pageUids.slice(0,this.curSearch.pageIndex));for(let t=0;t<s.length;t++){const e=s[t];if(this.cacheMap.has(e)){this.curSearch.pageUid=e,this.curSearch.pageIndex=this.pageUids.indexOf(e),i&&(this.curSearch.index=0);break}const n=await this.service.context.core.getSearchedTextsByPageUid(e,this.text,this.options);if(this.isStopped)return null;if(null!=n&&n.length){this.cacheMap.set(e,{pageUid:e,texts:n}),this.curSearch={pageUid:e,pageIndex:this.pageUids.indexOf(e),index:0};break}}return this.handleSearchResults(t,e)}async searchPrevText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this.breakTask(),this.isStopped)return null;if(this.isNotFound)return null;this.isNotFound=!1;let e=!1,i=!1;this.curSearch?0===this.curSearch.index?(0!==this.curSearch.pageIndex?this.curSearch.pageIndex-=1:this.curSearch.pageIndex=this.pageUids.length-1,this.curSearch.pageUid=this.pageUids[this.curSearch.pageIndex],e=!0):this.curSearch.index-=1:(this.curSearch={pageUid:this.pageUids[0],pageIndex:0,index:0},i=!0);const s=this.curSearch.pageIndex+1,n=this.pageUids.slice(s).concat(this.pageUids.slice(0,s)).reverse();for(let t=0;t<n.length;t++){const s=n[t];if(this.cacheMap.has(s)){this.curSearch.pageUid=s,this.curSearch.pageIndex=this.pageUids.indexOf(s),i?this.curSearch.index=0:e&&(this.curSearch.index=this.cacheMap.get(s).texts.length-1);break}const o=await this.service.context.core.getSearchedTextsByPageUid(s,this.text,this.options);if(this.isStopped)return null;if(null!=o&&o.length){this.cacheMap.set(s,{pageUid:s,texts:o}),this.curSearch.pageUid=s,this.curSearch.pageIndex=this.pageUids.indexOf(s),i?this.curSearch.index=0:e&&(this.curSearch.index=o.length-1);break}}return this.handleSearchResults(t)}handleSearchResults(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=[];this.cacheMap.has(this.curSearch.pageUid)&&(i=[{pageUid:this.curSearch.pageUid,texts:[this.cacheMap.get(this.curSearch.pageUid).texts[this.curSearch.index]]}]),this.setSearchTextToPage(i),i.length&&this.select(t);const s=new of(this.text,{...this.options},i,this.uid,this.searchType,[],!0,e);return this.service.context.hooks.searchTextChanged.emit(s),i.length&&this.emitSearchTextSelected(),i.length?i:(this.curSearch=null,this.isNotFound=!0,null)}createTask(){const t={taskUid:qs(),isBreak:!1};return this.tasks.set(t.taskUid,t),t}async searchFullText(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.breakTask(),this.service.context.hooks.searchTextCleared.emit(!0),this.isStopped)return null;const i=this.createTask();this.curTask=i,this.isComplete=!1;let s=!0,n=0,o=2;const r=[];for(let a=0;a<this.pageUids.length;a++){n+=1;const l=this.pageUids[a];if(this.cacheMap.has(l)){this.curSearch||(this.curSearch={pageUid:l,pageIndex:this.pageUids.indexOf(l),index:0});const t=this.cacheMap.get(l);r.push(t);}else {const t=await this.service.context.core.getSearchedTextsByPageUid(l,this.text,this.options);if(this.isStopped||i.isBreak)return null;if(null!=t&&t.length){this.curSearch||(this.curSearch={pageUid:l,pageIndex:this.pageUids.indexOf(l),index:0});const e={pageUid:l,texts:t};this.cacheMap.set(l,e),r.push(e);}}if(r.length&&(s||n%o==0||a===this.pageUids.length-1)){const l=!!s&&e;n=0,o<20&&(o+=1),this.curSearch||(this.curSearch={pageUid:r[0].pageUid,pageIndex:this.pageUids.indexOf(r[0].pageUid),index:0}),this.setSearchTextToPage(r),this.select(t);const h=new of(this.text,{...this.options},r,this.uid,this.searchType,[],a===this.pageUids.length-1,l);if(this.service.context.hooks.searchTextChanged.emit(h),this.emitSearchTextSelected(),s=!1,i.isBreak||this.isStopped)return null}if(0===a&&!r.length){const t=new of(this.text,{...this.options},r,this.uid,this.searchType,[],!1,!1);this.service.context.hooks.searchTextChanged.emit(t);}}if(this.isComplete=!0,!this.pageUids.length)return this.service.clearSearchText(),null;if(!r.length){this.setSearchTextToPage(r);const t=new of(this.text,{...this.options},r,this.uid,this.searchType,[],!0,e);return this.service.context.hooks.searchTextChanged.emit(t),this.curSearch=null,null}return r}setSearchTextToPage(t){const e=this.service.context.getActiveTab();if(!e)return;const i=new Map;t.forEach((t=>{i.set(t.pageUid,t);})),e.allPages.forEach((t=>{i.has(t.uid)?t.setSearchedText(i.get(t.uid)):t.clearSearchedText();}));}selectText(t,e){var i,s;const n=`${null===(i=this.curSearch)||void 0===i?void 0:i.pageUid}_${null===(s=this.curSearch)||void 0===s?void 0:s.index}`;if(e===n){const e=this.service.context.getActiveTab();if(!e)return;const i=e.uidToIndex(t);return void(e.current!==i&&this.service.context.viewer.gotoPage(i))}if(!this.cacheMap)return;const o=this.cacheMap.get(t);this.curSearch={pageUid:t,index:o.texts.findIndex((t=>t.textUid===e)),pageIndex:this.pageUids.indexOf(t)},this.select(),this.emitSearchTextSelected();}select(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=this.service.context.getActiveTab();if(!i)return;const s=this.cacheMap.get(this.curSearch.pageUid),n=s.texts[this.curSearch.index];if(i.allPages.forEach((t=>{t.uid!==s.pageUid?t.selectSearchedText(null):t.selectSearchedText(n.textUid);})),t){const t=i.uidToIndex(this.curSearch.pageUid);this.service.context.viewer.gotoPage(t);}e&&this.service.context.render(50);}emitSearchTextSelected(){const t=this.cacheMap.get(this.curSearch.pageUid).texts[this.curSearch.index];this.service.context.hooks.searchTextSelected.emit(t.textUid);}next(){if("single"===this.searchType)return;if(this.isStopped)return;if(!this.curSearch)return;if(!this.isComplete)return;const t=this.cacheMap.get(this.curSearch.pageUid);this.curSearch.index===t.texts.length-1?this.pageUids.slice(this.curSearch.pageIndex+1).concat(this.pageUids.slice(0,this.curSearch.pageIndex+1)).some((t=>{const e=this.cacheMap.get(t);return !!(e&&e.texts.length>0)&&(this.curSearch={pageUid:t,pageIndex:this.pageUids.indexOf(t),index:0},!0)})):this.curSearch.index+=1,this.select(),this.emitSearchTextSelected();}previous(){"single"!==this.searchType&&(this.isStopped||this.curSearch&&this.isComplete&&(0===this.curSearch.index?this.pageUids.slice(this.curSearch.pageIndex).concat(this.pageUids.slice(0,this.curSearch.pageIndex)).reverse().some((t=>{const e=this.cacheMap.get(t);return !!(e&&e.texts.length>0)&&(this.curSearch={pageUid:t,pageIndex:this.pageUids.indexOf(t),index:e.texts.length-1},!0)})):this.curSearch.index-=1,this.select(),this.emitSearchTextSelected()));}reset(){this.cacheMap.clear(),this.curSearch=null,this.isStopped=!1,this.searchType=null,this.tasks.forEach((t=>{t.isBreak=!0;})),this.tasks.clear(),this.curTask=null;}updateSearchType(t){this.searchType=t;}stop(){this.isStopped=!0,this.curTask&&(this.curTask.isBreak=!0);}breakTask(){this.curTask&&(this.curTask.isBreak=!0,this.tasks.delete(this.curTask.taskUid));}refreshPageUids(){const t=this.service.context.getActiveTab();t&&(this.pageUids=t.allPages.map((t=>t.uid)));}async addPages(t){this.refreshPageUids(),this.curSearch&&(this.curSearch.pageIndex=this.pageUids.indexOf(this.curSearch.pageUid)),this.isNotFound=!1,"full"===this.searchType?await this.searchFullText(!1):"single"===this.searchType&&(this.curSearch=null,await this.searchNextText(!1));}async deletePages(t){this.refreshPageUids(),this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),this.deletePageTimer&&(clearTimeout(this.deletePageTimer),this.deletePageTimer=null),this.deletePageTimer=setTimeout((()=>{this.deletePageTimer=null,this.reSearch(!1);}),40);}async updatePage(t){this.deleteCacheByPageUids([t]),this.isNotFound=!1,this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async filterPages(t){this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async perspectivePage(t){this.deleteCacheByPageUids([t]),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async cropPages(t){this.deleteCacheByPageUids(t),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async reorderPages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async swapPages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async movePages(){this.refreshPageUids(),this.curSearch=null,this.service.context.hooks.searchTextCleared.emit(),await this.reSearch(!1);}async reSearch(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"single"===this.searchType?await this.searchNextText(t,!0):"full"===this.searchType&&await this.searchFullText(t,!0);}deleteCacheByPageUids(t){t.forEach((t=>{this.cacheMap.delete(t);}));}}class _w extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"searchers",new Map),i(this,"curSearcher",void 0),i(this,"lastOptions",{caseSensitive:!1,wholeWord:!1}),i(this,"curText",void 0),i(this,"lastSearchType",void 0),i(this,"isCleared",!1),i(this,"taskUid",void 0),i(this,"cancelQueue",[]),i(this,"searchTimer",null),i(this,"defaultOptions",{caseSensitive:!1,wholeWord:!1}),i(this,"lastSearchRes",void 0),i(this,"reorderTimer",void 0),this.context=t,this.listenEvents();}listenEvents(){const{documentService:t}=this.context.core,{hooks:e}=this.context;e.closeDocument.on((t=>{this.clearSearchText();}),this),t.onBeforeDeleteDocs.on((async t=>{const e=this.context.getActiveTab();e&&t.docUids.forEach((t=>{e.uid===t&&this.curSearcher&&this.clearSearchText();}));}),this),e.deletePages.on((async t=>{var e;const{docUid:i,pageUids:s}=t;if(!this.isMeetEventConditions(i))return;if(!this.context.getActiveTab().total)return this.clearSearchText(),void(this.lastSearchRes=null);await this.curSearcher.deletePages(s),this.lastSearchRes=null===(e=this.lastSearchRes)||void 0===e?void 0:e.filter((t=>!s.includes(t.pageUid)));}),this),e.addPagesToDoc.on((async t=>{const{docUid:e,pageUids:i}=t;this.isMeetEventConditions(e)&&await this.curSearcher.addPages(i);}),this),e.updatePage.on((async t=>{const{docUid:e,pageUid:i}=t;this.isMeetEventConditions(e)&&await this.curSearcher.updatePage(i);}),this),e.reorderPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&(this.reorderTimer&&(clearTimeout(this.reorderTimer),this.reorderTimer=null),this.reorderTimer=setTimeout((()=>{this.reorderTimer=null,this.curSearcher.reorderPages();}),40));}),this),e.movePages.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.movePages();}),this),e.swapPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.swapPages();}),this),this.context.core.onFilterChanged.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.filterPages(t.pageUids);}),this),this.context.core.onAfterPerspective.on((async t=>{this.isMeetEventConditions(t.docUid)&&await this.curSearcher.perspectivePage(t.pageUid);}),this),this.context.core.editService.onAfterCropPages.on((async t=>{this.isMeetEventConditions(t.docUid)&&(await this.curSearcher.cropPages(t.pageUids),this.context.render(45));}),this);}isMeetEventConditions(t){const e=this.context.getActiveTab();return !(!(e&&(null==e?void 0:e.uid)===t&&this.curSearcher&&this.curText)||this.curSearcher.isStopped)}createTextSearcher(t,e,i){let s=this.searchers.get(t);return s||(this.context.getActiveTab(),s=new Nw(this,e,i),this.searchers.set(s.uid,s)),s}async searchNextText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),Object.assign(this.lastOptions,i||{}),this.curText=e;const s=this.createTextSearcher(t,e,i);this.curSearcher=s;}else this.isSearchTypeChanged("single")&&this.curSearcher.reset();this.lastSearchType="single",this.curSearcher.updateSearchType("single");const s=await this.curSearcher.searchNextText();return !this.curSearcher.isStopped&&(this.context.render(46),!!s)}async searchPrevText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),Object.assign(this.lastOptions,i||{}),this.curText=e;const s=this.createTextSearcher(t,e,i);this.curSearcher=s;}else this.isSearchTypeChanged("single")&&this.curSearcher.reset();this.lastSearchType="single",this.curSearcher.updateSearchType("single");const s=await this.curSearcher.searchPrevText();return !this.curSearcher.isStopped&&(this.context.render(47),!!s)}async searchFullText(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i={...this.defaultOptions,...i},this.isCleared=!1,this.isTextChanged(e)||this.isOptionsChanged(i)){this.curSearcher&&this.stopSearch(this.curSearcher.uid),this.cancelQueue.forEach((t=>{t();})),this.cancelQueue=[],this.curText=e;const s=qs();this.taskUid=s;if(!await new Promise((t=>{this.searchTimer=setTimeout((()=>{t(!0);}),this.context.viewerConfig.textSearchDelay),this.cancelQueue.push((()=>{t(!1);}));}))||this.taskUid!==s||this.isCleared||this.curText&&this.curText!==e)return null;Object.assign(this.lastOptions,i||{});const n=this.createTextSearcher(t,e,i);this.curSearcher=n;}else {if(!this.isSearchTypeChanged("full"))return !!this.lastSearchRes;if(!this.curSearcher)return !1;this.curSearcher.reset();}this.lastSearchType="full",this.curSearcher.updateSearchType("full");const s=this.curSearcher,n=await s.searchFullText(!1);return !s.isStopped&&(this.isCleared&&this.clearSearchTextFromPage(),this.context.render(48),this.lastSearchRes=n,!!n)}isTextChanged(t){return this.curText!==t}isSearchTypeChanged(t){return this.lastSearchType!==t}isOptionsChanged(t){if(!t||0===Object.keys(t).length)return !1;const e={...this.lastOptions,...t};return this.lastOptions.caseSensitive!==e.caseSensitive||this.lastOptions.wholeWord!==e.wholeWord}stopSearch(t){const e=this.searchers.get(t);e&&(e.stop(),this.searchers.delete(t));}nextText(){const t=this.curSearcher;t&&!t.isStopped&&t.next();}previousText(){const t=this.curSearcher;t&&!t.isStopped&&t.previous();}selectText(t,e){const i=this.curSearcher;i&&!i.isStopped&&i.selectText(t,e);}clearSearchText(){this.searchers.forEach((t=>{t.stop();})),this.searchers.clear(),this.isCleared=!0,this.clearSearchTextFromPage(),this.context.render(49),this.curSearcher=null,this.curText=null,this.lastSearchType=null,this.context.hooks.searchTextCleared.emit();}clearSearchTextFromPage(){const t=this.context.getActiveTab();t&&t.allPages.forEach((t=>{t.clearSearchedText();}));}dispose(){this.context=null,this.searchers.forEach((t=>{t.stop();})),super.dispose();}}class Ww{constructor(t){i(this,"context",void 0),i(this,"isPointerdown",!1),i(this,"isStartTextSelection",!1),i(this,"startTextPosition",void 0),i(this,"endTextPosition",void 0),i(this,"textSelectionTimerMobile",void 0),i(this,"isEditTextStart",!1),i(this,"isEditTextEnd",!1),i(this,"isMovedForTextSelection",!1),i(this,"isZoomedForTextSelection",!1),i(this,"textSelectionThreshold",1),i(this,"clearSelectionTimerThreshold",3),i(this,"startPoint",void 0),i(this,"hasSelectedText",!1),i(this,"textPages",[]),i(this,"clickTimer",void 0),i(this,"clickCount",0),i(this,"lastClickPoint",void 0),i(this,"canvas",void 0),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),i(this,"canPan",!1),i(this,"isMove",!1),i(this,"moveThreshold",2),i(this,"autoScrollTimer",void 0),i(this,"hitPage",void 0),i(this,"autoScrollStepSize",6/xn()),i(this,"isAutoScroll",!1),i(this,"lastAutoScrollEvent",void 0),i(this,"lastMoveEvent",void 0),i(this,"pointerNum",0),i(this,"isTouchstart",!1),this.context=t,this.canvas=this.context.rendererService.getCanvasDom(),this.context.hooks.afterRender.on((()=>{this.needRenderMagnifier&&this.context.magnifierService.render("text",this.canvas,this.magnifierPoint);}),this.context);}get isTextSelectionMode(){return "textSelection"===this.context.viewerConfig.toolMode}pointerdownHandler(t){if(this.isPointerdown||!this.isTextSelectionMode)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;if(!this.context.isDefaultViewer)return;this.isAutoScroll=!1,this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);const[i]=this.context.toCanvas(t),{page:s}=this.context.getPointerOverPageInfo(i.pageX,i.pageY).pageInfo;if(!s)return;const n=this.context.core.pageService.getPage(s.uid);if(this.context.annotationEditService.hasActiveAnnotation()&&this.context.annotationEditService.deactivateAnnotation(),n.isTextPage&&n.visibleLines){const n=!km(t),o=Nx(s.mediaBox,i.pageX,i.pageY,s.rotation),r={x:o.pointerX,y:o.pointerY},a=s.isPointOnTextStart(r),l=s.isPointOnTextEnd(r);if((a||l)&&this.clickCount<1)this.isEditTextStart=a,this.isEditTextEnd=l,this.context.hooks.beforeTextSelected.emit(),n&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY},this.context.render(35));else if(n)!this.isStartTextSelection&&this.pointerNum<2&&(this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=setTimeout((()=>{if(this.pointerNum>1)return;clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null;const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},s);if(t){this.context.textSelectionService.clearSelectedTexts(),this.startTextPosition=t,this.endTextPosition=t,this.isStartTextSelection=!0;const{textPages:s,startCharRect:n,endCharRect:o,startTextPosition:r,endTextPosition:a}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);e.setTextSelection(s,n,o,r,a),this.hasSelectedText=!0,this.textPages=s,this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:i.pageX,y:i.pageY}),this.context.render(36),this.context.hooks.beforeTextSelected.emit();}}),this.context.viewerConfig.enterTextModeTimeMobile));else if(km(t)){const t=this.context.calcTextStartPosition({x:i.pageX,y:i.pageY},s);if(t&&(this.startTextPosition=t,this.context.textSelectionService.clearSelectedTexts(),this.isStartTextSelection=!0,this.context.hooks.beforeTextSelected.emit()),this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null),this.clickTimer=setTimeout((()=>{this.clickCount=0,this.clickTimer=null;}),this.context.viewerConfig.multipleClickTimeout),this.clickCount>0)if(this.lastClickPoint.x===i.pageX&&this.lastClickPoint.y===i.pageY){const i=e.uidToIndex(s.uid);1===this.clickCount?t&&t.lineUid&&this.selectClickedText(t.lineUid,r,s.uid,i,!0):this.clickCount>1&&t&&t.lineUid&&this.selectClickedText(t.lineUid,r,s.uid,i,!1),this.clickCount+=1;}else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};else this.clickCount=1,this.lastClickPoint={x:i.pageX,y:i.pageY};}}if(this.canPan?(this.context.cursorService.applyCursorState(15),this.context.cursorService.lockCursor()):(this.context.cursorService.applyCursorState(16),this.context.cursorService.lockCursor()),!this.isStartTextSelection){const{scrollLeft:e,scrollTop:i}=this.context.viewService.getMaxScrollValue();(e>0||i>0)&&(this.isMove=!0,this.context.moveService.startHandler(t));}this.startPoint={x:i.pageX,y:i.pageY},this.isPointerdown=!0;}selectClickedText(t,e,i,s,n){if(!t)return;this.context.clearSelectedTexts();const o=this.context.core.pageService.getPage(i);if(!o.isTextPage)return;const r=o.lineMap.get(t).visibleIndex;if(-1===r)return;let a;if(n){if(a=o.getSelectedTextWord(r,e),!a)return}else a=o.getSelectedTextSegment(r,e);if(!a)return;const{start:l,end:h}=a,c={...l,pageUid:o.uid,pageIndex:s,mediaBoxPoint:{...e}},d={...h,pageUid:o.uid,pageIndex:s,mediaBoxPoint:{...e}};this.startTextPosition=c,this.endTextPosition=d;const{textPages:u,startCharRect:p,endCharRect:g,startTextPosition:f,endTextPosition:v}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);this.context.getActiveTab().setTextSelection(u,p,g,f,v),this.hasSelectedText=!0,this.textPages=u,this.context.render(37);}pointerMoveForAutoScroll(t){if(!this.isTextSelectionMode||!this.context.viewerConfig.enableTextSelection)return;const e=this.context.getActiveTab();if(null!=e&&e.total&&!(this.pointerNum>1)&&this.context.isDefaultViewer&&this.context.isDefaultViewer&&this.isAutoScroll&&(e.context.maxScrollTop||e.context.maxScrollLeft)&&this.context.viewerConfig.enableAutoScrollForTextSelection){const e=this.checkPointermoveDirection(t);this.autoScroll(e);}}autoScroll(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;const{maxScrollTop:i,scrollTop:s,maxScrollLeft:n,scrollLeft:o}=e.context,r=this.context.viewerConfig.autoScrollStepSize/xn();let a=!1;i&&t.top&&0!==s&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:i}=e.context;var s;t&&(0!==i?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(0,-r),this.pointermoveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(0,-r)),i&&t.bottom&&s!==i&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollTop:t,scrollTop:i}=e.context;var s;t&&(i!==t?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(0,r),this.pointermoveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(0,r)),n&&t.left&&0!==o&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:i}=e.context;var s;t&&(0!==i?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(-r,0),this.pointermoveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(-r,0)),n&&t.right&&o!==n&&(a=!0,this.autoScrollTimer||(this.autoScrollTimer=setInterval((()=>{const{maxScrollLeft:t,scrollLeft:i}=e.context;var s;t&&(i!==t?null!==(s=this.hitPage)&&void 0!==s&&s.isLoaded&&(this.context.viewService.scrollBy(r,0),this.pointermoveHandler(this.lastAutoScrollEvent,!0)):this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null));}),40)),this.context.viewService.scrollBy(r,0)),this.autoScrollTimer&&!a&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null);}checkPointermoveDirection(t){const e={left:!1,top:!1,right:!1,bottom:!1};if(!this.context.getActiveTab())return e;const i=this.context.rendererService.getCanvasDom(),{top:s,bottom:n,left:o,right:r}=i.getBoundingClientRect();return t.clientY<s&&(e.top=!0),t.clientY>n&&(e.bottom=!0),t.clientX<o&&(e.left=!0),t.clientX>r&&(e.right=!0),e}pointermoveHandler(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.isTextSelectionMode||!this.context.viewerConfig.enableTextSelection||this.pointerNum>1)return;const i=this.context.getActiveTab();if(null==i||!i.total)return;if(!this.context.isDefaultViewer)return;const[s]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(s.pageX,s.pageY).pageInfo;if(!n)return;const o=this.context.rendererService.getCanvasDom().getBoundingClientRect();!e&&o.top<=t.clientY&&o.bottom>=t.clientY&&o.left<=t.clientX&&o.right>=t.clientX&&(this.lastAutoScrollEvent=t),this.hitPage=n,this.autoScrollTimer&&!e&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null),this.autoScrollStepSize=this.context.viewerConfig.autoScrollStepSize/xn();const r=this.context.core.pageService.getPage(n.uid);if(this.isPointerdown){const e=(null==r?void 0:r.visibleLines)&&(null==r?void 0:r.isTextPage),o=an(this.startPoint,{x:s.pageX,y:s.pageY});if(o>this.textSelectionThreshold&&(this.isMovedForTextSelection=!0),o>=this.clearSelectionTimerThreshold&&!this.isStartTextSelection&&this.textSelectionTimerMobile&&(clearTimeout(this.textSelectionTimerMobile),this.textSelectionTimerMobile=null),this.isEditTextStart&&e)this.isStartTextSelection=!0,this.isEditTextStart=!1,this.startTextPosition={...i.endTextPosition};else if(this.isEditTextEnd&&e)this.isStartTextSelection=!0,this.isEditTextEnd=!1,this.startTextPosition={...i.startTextPosition};else if(this.context.viewerConfig.enableTextSelection&&this.isStartTextSelection&&e){const{maxScrollTop:e,maxScrollLeft:o}=i.context;(e||o)&&this.context.viewerConfig.enableAutoScrollForTextSelection&&(this.isAutoScroll=!0),this.context.cursorService.lockCursor();const r=this.context.calcTextEndPosition({x:s.pageX,y:s.pageY},n,i,this.startTextPosition.mediaBoxPoint);if(r){this.endTextPosition=r;const{textPages:e,startCharRect:n,endCharRect:o,startTextPosition:a,endTextPosition:l}=this.context.textSelectionService.calcSelectedText(this.startTextPosition,this.endTextPosition);i.setTextSelection(e,n,o,a,l),this.hasSelectedText=!0,this.textPages=e;!km(t)&&this.context.viewerConfig.enableTextMagnifier&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY}),this.context.render(38);}}else !this.isEditTextEnd&&!this.isStartTextSelection&&this.isMove&&o>this.moveThreshold&&(this.context.moveService.moveHandler(t),this.context.cursorService.applyCursorState(14));}else {let t=1;if(!this.isStartTextSelection&&r.visibleLines&&null!=r&&r.isTextPage){const e=Nx(n.mediaBox,s.pageX,s.pageY,n.rotation),i={x:e.pointerX,y:e.pointerY},o=n.isPointOnTextStart(i),a=n.isPointOnTextEnd(i);if(o||a)this.canPan=!1,t=16;else {const e=r.getHoveredTextLineIndex(i);n.isPointOnTextSelection(i)||-1!==e?(this.canPan=!1,t=16):(this.canPan=!0,t=14);}}this.context.cursorService.applyCursorState(t);}this.lastMoveEvent=t;}pointerupHandler(t){if(this.isPointerdown){if(this.context.cursorService.unlockCursor(),this.autoScrollTimer&&(clearInterval(this.autoScrollTimer),this.autoScrollTimer=null),this.isAutoScroll=!1,this.hitPage&&(this.hitPage=null),this.isStartTextSelection||this.isMovedForTextSelection||this.isZoomedForTextSelection||this.context.textSelectionService.clearSelectedTexts(),this.textSelectionTimerMobile&&clearTimeout(this.textSelectionTimerMobile),this.hasSelectedText){const t=nf.create(this.context.textSelectionService.getSelectedTexts(),this.textPages);this.textPages=[],this.context.hooks.textSelected.emit(t),this.context.hooks.afterTextSelected.emit();}if(km(t)&&this.lastClickPoint){const[e]=this.context.toCanvas(t);e.pageX===this.lastClickPoint.x&&e.pageY===this.lastClickPoint.y||(this.clickCount=0,this.clickTimer&&(clearTimeout(this.clickTimer),this.clickTimer=null));}this.isMove&&this.context.moveService.endHandler(t),this.isMove=!1,this.hasSelectedText=!1,this.isStartTextSelection=!1,this.isPointerdown=!1,this.isMovedForTextSelection=!1,this.isEditTextStart=!1,this.isEditTextEnd=!1,this.isZoomedForTextSelection=!1,this.needRenderMagnifier&&this.context.magnifierService.hide(),this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render(39),this.canPan&&this.context.cursorService.applyCursorState(14);}}visibilityChangedHandler(){this.lastMoveEvent&&(this.pointerupHandler(this.lastMoveEvent),this.lastMoveEvent=null);}touchstartHandler(t){if(this.pointerNum=t.targetTouches.length,this.context.isDefaultViewer){const{enableZoom:e,enableZoomInPanMode:i,enableZoomWithTouch:s}=this.context.viewerConfig;if(!this.isTextSelectionMode||2!==t.targetTouches.length||this.isTouchstart||!e||!s||!i)return;this.isTouchstart=!0,this.context.zoomService.touchstartHandler(t);}}touchmoveHandler(t){this.pointerNum=t.targetTouches.length,2===t.targetTouches.length&&this.isTouchstart&&this.context.isDefaultViewer&&(this.context.zoomService.touchmoveHandler(t),this.isZoomedForTextSelection=!0);}touchendHandler(t){this.pointerNum=t.targetTouches.length,this.isTouchstart&&(this.isTouchstart=!1,this.context.isDefaultViewer&&this.context.zoomService.touchendHandler(t));}wheelHandler(t){if(this.pointerNum=0,this.isTextSelectionMode&&this.context.isDefaultViewer)if(Pn(t)){const{enableZoom:e,enableZoomInTextSelectionMode:i,enableZoomWithCtrl:s}=this.context.viewerConfig;if(!e||!i||!s)return;this.context.zoomService.wheelHandler(t);}else this.context.scrollService.wheelHandler(t);}scrollHandler(t){this.isTextSelectionMode&&this.context.isDefaultViewer&&this.context.scrollService.scrollHandler(t);}keydownHandler(t){if(!this.isTextSelectionMode)return;const{context:e,context:{keyboardService:i,annotationEditService:s,isDefaultViewer:n,viewerConfig:{enableKeyboardInteraction:o,enableCopyCutPasteWithKeyboard:r,enableZoom:a,enableZoomInTextSelectionMode:l},isPointerWorking:h}}=this;if(!o||h||!n)return;const c=this.context.getActiveTab();if(null==c||!c.total)return;if(Pn(t))switch(t.key){case"c":case"C":c.hasSelectedTexts&&r&&(t.preventDefault(),this.context.copySelectedTexts());break;case"y":case"Y":i.redoHandler(t);break;case"z":case"Z":i.undoHandler(t);break;case"-":a&&l&&i.zoomOutHandler(t);break;case"=":a&&l&&i.zoomInHandler(t);}switch(t.key){case"Escape":i.escapeHandler(t);break;case"Enter":i.enterHandler(t);break;case"PageUp":i.pageUpHandler(t);break;case"PageDown":i.pageDownHandler(t);break;case"Home":i.homeHandler(t);break;case"End":i.endHandler(t);break;case"ArrowLeft":i.arrowLeftHandler(t);break;case"ArrowRight":i.arrowRightHandler(t);break;case"ArrowUp":i.arrowUpHandler(t);break;case"ArrowDown":i.arrowDownHandler(t);}}}class Fw{constructor(t){i(this,"type",void 0),i(this,"magnifierCanvas",void 0),i(this,"tempCanvas",void 0),i(this,"ctx",void 0),i(this,"style",{type:"rect",size:100,borderColor:"#323232",borderWidth:3,magnification:3,crosshairWidth:1,crosshairColor:"#323232",background:"#fff"}),i(this,"isVisible",!1),Object.assign(this.style,t||{}),this.magnifierCanvas=document.createElement("canvas"),this.tempCanvas=document.createElement("canvas"),this.ctx=this.magnifierCanvas.getContext("2d"),this.magnifierCanvas.style.position="absolute";const e={position:"absolute",left:0,top:0,borderColor:this.style.borderColor,borderWidth:this.style.borderWidth,width:`${this.style.size}px`,height:`${this.style.size}px`,background:this.style.background,zIndex:6,display:"none"};"circle"===this.style.type&&(e.borderRadius="50%"),Object.assign(this.magnifierCanvas.style,e);}updatePosition(t){Object.assign(this.magnifierCanvas.style,{left:`${t.x}px`,top:`${t.y}px`});}show(){this.isVisible||(this.magnifierCanvas.style.display="block",this.isVisible=!0);}hide(){this.isVisible&&(this.magnifierCanvas.style.display="none",this.isVisible=!1);}render(t,e,i){if(!this.isVisible)return;const{type:s,size:n,borderColor:o,borderWidth:r,magnification:a,crosshairColor:l,crosshairWidth:h}=this.style,c=n/2*devicePixelRatio,d=n*devicePixelRatio,u=2*Math.PI;if(this.magnifierCanvas.width=d,this.magnifierCanvas.height=d,i.x*devicePixelRatio<d&&i.y*devicePixelRatio<d){const{width:t}=e.getBoundingClientRect();this.updatePosition({x:t-n,y:0});}else this.updatePosition({x:0,y:0});const p=e.getContext("2d",{willReadFrequently:!0});p.save();const g=p.getImageData(i.x*devicePixelRatio-c,i.y*devicePixelRatio-c,d,d);p.restore(),this.tempCanvas.width=d,this.tempCanvas.height=d;this.tempCanvas.getContext("2d").putImageData(g,0,0);const f=this.ctx;if(f.save(),f.setTransform(1,0,0,1,0,0),f.clearRect(-c,-c,2*c,2*c),f.translate(c,c),f.beginPath(),"circle"===s?f.arc(0,0,c,0,u):f.rect(-c,-c,d,d),f.clip(),f.scale(a,a),f.drawImage(this.tempCanvas,-c,-c,d,d),f.closePath(),f.strokeStyle=o,f.lineWidth=r,f.stroke(),"crop"===t){f.beginPath();const t=.5*c/a;f.moveTo(0,-t),f.lineTo(0,t),f.moveTo(-t,0),f.lineTo(t,0),f.closePath(),f.strokeStyle=l,f.lineWidth=h/a,f.stroke();}f.restore();}}class Hw extends Qn{constructor(t){super(),i(this,"context",void 0),i(this,"canvas",void 0),i(this,"ctx",void 0),i(this,"magnifier",void 0),this.context=t;}initMagnifier(t){this.magnifier||(this.magnifier=new Fw(t)),this.context.viewService.scrollerAndCanvasContainer.appendChild(this.magnifier.magnifierCanvas);}render(t,e,i){"crop"===t&&!this.context.viewerConfig.enableMagnifier||"text"===t&&!this.context.viewerConfig.enableTextMagnifier||(this.show(),this.magnifier.render(t,e,i));}show(){this.magnifier.show();}hide(){this.magnifier.hide();}dispose(){super.dispose(),this.context=null;}}const Vw={isClearOptimization:!1,isThumbnail:!1,isResize:!1,renderReason:null};class zw extends Qn{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),i(this,"core",void 0),i(this,"viewer",void 0),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"hooks",void 0),i(this,"mainViewerUid",null),i(this,"viewService",void 0),i(this,"rendererService",void 0),i(this,"tabService",void 0),i(this,"layoutService",void 0),i(this,"styleService",void 0),i(this,"configService",void 0),i(this,"visibilityService",void 0),i(this,"annotationEditService",void 0),i(this,"cropBoxEditService",void 0),i(this,"perspectiveQuadEditService",void 0),i(this,"eventsService",void 0),i(this,"dragService",void 0),i(this,"moveService",void 0),i(this,"scrollService",void 0),i(this,"zoomService",void 0),i(this,"slideService",void 0),i(this,"textSelectionService",void 0),i(this,"textSearchService",void 0),i(this,"optimizationService",void 0),i(this,"interactionService",void 0),i(this,"selectPagesService",void 0),i(this,"keyboardService",void 0),i(this,"cursorService",void 0),i(this,"magnifierService",void 0),i(this,"viewerConfig",Ns(Cx)),i(this,"postfix",void 0),i(this,"isDestroyed",!1),i(this,"viewportWidth",0),i(this,"viewportHeight",0),i(this,"scrollByCurrentChanged",!1),i(this,"isInitialized",!1),i(this,"addPagesTimer",null),i(this,"isPanning",void 0),i(this,"isZooming",void 0),i(this,"isSliding",void 0),i(this,"isFocusCanvas",!1),i(this,"isFocusViewer",!1),i(this,"isPointerWorking",!1),i(this,"isPointerOverScrollbar",!1),i(this,"hasBoxRendererModule",!1),i(this,"hasAnnotationModule",!1),i(this,"renderingMode","image"),this.core=t,this.viewer=e,this.postfix=e.postfix,this.hooks=e.hooks,this.uid=e.uid,this.groupUid=e.groupUid,Nn(s,this.viewerConfig),this.styleService=new Hx(this),this.viewService=this.register(new ew(this,this.hooks)),this.rendererService=this.register(new aw(this,this.hooks)),this.layoutService=new vw(this,this.hooks),this.configService=this.register(new yw(this)),this.tabService=this.register(new Fx(this)),this.visibilityService=new Yx(this),this.optimizationService=this.register(new Aw(this)),this.handleViewerModeChanged(),this.eventsService=this.register(new xw(this)),this.dragService=this.register(new ww(this)),this.moveService=this.register(new bw(this)),this.scrollService=this.register(new Sw(this)),this.zoomService=this.register(new Cw(this)),this.slideService=this.register(new Tw(this)),this.textSelectionService=this.register(new Lw(this)),this.textSearchService=this.register(new _w(this)),this.interactionService=this.register(new kw(this,new Ew(this),new Mw(this),new Iw(this),new Bw(this),new Uw(this),new Ww(this))),this.selectPagesService=this.register(new Dw(this)),this.keyboardService=this.register(new Rw(this)),this.cursorService=this.register(new Ow(this)),(this.isDefaultViewer||this.isPerspectiveViewer)&&(this.magnifierService=this.register(new Hw(this)),this.hooks.uiInitCompleted.on((()=>{this.magnifierService.initMagnifier(this.viewerConfig.magnifierStyle);}),this)),this.eventsService.handleExternalEvents(),this.optimizationService.handleOptimizationEvents(),this.interactionService.handleEvents(),this.isThumbnailViewer&&this.viewer.on("thumbnailBind",(t=>{this.mainViewerUid=t;}));}get eventDom(){return this.viewService.scrollContainer}get isCropToolMode(){return "crop"===this.viewerConfig.toolMode}get isVisible(){var t;return "visible"===(null===(t=this.viewerConfig)||void 0===t?void 0:t.visibility)}syncViewer(t){const e=t.getActiveTab();if(!e)return;const i=this.tabService.createTab(e.doc);if(i.isDocType){const{width:t,height:e}=this.viewService.getViewportSize();i.updateViewportSize(t,e);}i.currentUid=e.currentUid,i.selectPages([...e.selected]),this.tabService.activateTab(i.uid),this.hooks.syncDocument.emit(i.doc),this.emitPageChangedEvent(i),this.showTab(i,{renderReason:2}),this.emitPageChangedAfterRenderEvent(i);}toCanvas(t){const e=[];let i=null;i=t instanceof MouseEvent||t instanceof PointerEvent?[t]:arguments.length>1&&void 0!==arguments[1]&&arguments[1]?t.changedTouches:t.touches;const{left:s,top:n}=this.rendererService.getCanvasPageRect();for(let t=0;t<i.length;t++){const o=i[t];e.push({pageX:o.pageX-s,pageY:o.pageY-n});}return e}isPointerOverCanvas(t){const e=this.rendererService.getCanvasDom().getBoundingClientRect();return e.top<=t.clientY&&e.bottom>=t.clientY&&e.left<=t.pageX&&e.right>=t.pageX}getPointerOverPageInfo(t,e){const i=function(t,e,i){const s={pageInfo:{isOver:!1,pointerX:-1,pointerY:-1,page:null},imageInfo:{isOver:!1,pointerX:-1,pointerY:-1,page:null},index:-1};if(t)for(let n=0;n<t.visibleChildren.length;n++){const o=t.visibleChildren[n],r=vm(o,e,i,o.isVisible,0);if(r.isOver){s.index=t.getPageIndex(o),Object.assign(s.pageInfo,r);const n=vm(o.image,e,i,!0,o.rotation);return n.isOver&&Object.assign(s.imageInfo,n),s}}return s}(this.getActiveTab(),t,e);return i}getPointerOverMediaBoxInfo(t,e,i,s){return Nx(t,e,i,s)}getPointerOverAutoScrollBoundaryInfo(t,e){const i={left:!1,top:!1,right:!1,bottom:!1};if(!this.getActiveTab())return i;const{width:s,height:n}=this.rendererService.getCanvasPageRect(),o=this.viewerConfig.autoScrollBoundarySize;return e<=o&&(i.top=!0),e>=n-o&&(i.bottom=!0),t<=o&&(i.left=!0),t>=s-o&&(i.right=!0),i}resize(){if(this.tabService.resizeScrollbar(),this.isCaptureViewer)return;this.viewService.resizeViewport(),this.updateViewportSize(),this.rendererService.updateCanvasSize(),this.styleService.isCheckboxStyleChanged=!0,this.styleService.isPageNumberStyleChanged=!0;const t=this.getActiveTab();t&&(this.clearCurrentTabOptimization(),this.showTab(t,{renderReason:3,isClearOptimization:!0,isThumbnail:!1,isResize:!0}));}updateViewportSize(){const{width:t,height:e}=this.viewService.getViewportSize();this.viewportWidth=t,this.viewportHeight=e,this.tabService.updateViewportSize(t,e);}handleViewerModeChanged(){const{postfix:t,viewService:e,isDefaultViewer:i,isPerspectiveViewer:s,isThumbnailViewer:n}=this;if(i||s||n){e.createMainAndThbContainer(t),e.createMainContainer(t),n||e.createThumbnailContainer(t),i&&(e.createVideoContainer(t),e.createAudioContainer(t)),Pm(e.mainAndThbContainer,"flex");const{width:s,height:o}=e.getViewportSize();this.rendererService.initRenderer(e.canvasContainer,s,o),this.rendererService.updateCanvasSize();}}loadSource(t,e){const i=this.getActiveTab();let s=null==i?void 0:i.uid;if(!i){const t=this.core.createDocument({name:qf(),type:"document"});this.viewer.openDocument(t),s=t.uid;}const n=ku.buildInfo("loadSource",{docUid:s,current:0,total:Ls(t)?t.length:1});return ku.info(n),this.core.loadSource(t,s,{exception:e?"fail":"ignore"},n).catch((t=>{throw n.status="Failed",ku.info(n),t}))}openDocument(t){const{tabService:e}=this;let i=e.getTab(t.uid);if(!i){const s=e.getActiveTab();if(s&&(clearTimeout(this.addPagesTimer),this.addPagesTimer=null,this.hooks.closeDocument.emit(s.doc)),i=e.createTab(t),i.isDocType){const{width:t,height:e}=this.viewService.getViewportSize();i.updateViewportSize(t,e);}}i.isActive||(this.tabService.activateTab(i.uid),this.emitPageChangedEvent(i),this.showTab(i,{renderReason:4}),this.hooks.openDocument.emit(t),this.emitPageChangedAfterRenderEvent(i));}closeTabs(t){const e=t.filter((t=>this.tabService.hasTab(t)));if(!e.length)return;const i=e.reduce(((t,e,i)=>{const s=this.tabService.getTab(e);return s&&t.push(s),t}),[]);i.forEach((t=>{t.isActive&&(clearTimeout(this.addPagesTimer),this.addPagesTimer=null,this.clearCurrentTabOptimization()),this.tabService.closeTab(t.uid),this.hooks.closeDocument.emit(t.doc);}));const s=this.tabService.getActiveTab();s?this.showTab(s,{renderReason:5}):(this.rendererService.docRenderer.clear(),this.resetCanvas(),this.hooks.pageChanged.emit(jg.create(-1,0)));}resetCanvas(){this.isCaptureViewer||(this.viewService.resetViewport(),this.rendererService.updateCanvasSize(),this.rendererService.clearCanvas());}render(t){if("hidden"===this.viewerConfig.visibility)return;if(this.isDestroyed)return;const e=this.getActiveTab();e&&this.rendererService.render(e,t);}showCurrentTab(t){const e=this.getActiveTab();null!=e&&e.total&&this.showTab(e,t);}showTab(t,e){this.isDestroyed||t.isDestroyed||(e={...Vw,...e||{}},this.tabService.activateTab(t.uid),"hidden"!==this.viewerConfig.visibility&&(this.isDefaultViewer?this.showTabDefault(t,e):this.isThumbnailViewer?this.showTabThumbnail(t,e):this.isPerspectiveViewer&&this.showTabPerspective(t,e)));}showTabDefault(t,e){const i=t;if(!i.isDocType)return;if(e.isResize){if(!t.context.placeholderPages.length)return;t.context.updateReference();}i.style.visibility="visible";const s=i.context.zoom;this.layoutService.layout(i,e.renderReason),this.viewerConfig.zoom=i.context.zoom;const n=i.context.zoom!==s;if(this.viewService.updateScrollerContentSize(i),this.rendererService.updateCanvasSize(),!i.total)return this.loadVisiblePartData(),void this.rendererService.render(i,e.renderReason);let{scrollLeft:o,scrollTop:r}=i.context.parseReferenceDefault();if(e.isResize){const t=i.context.parseReferenceResize();o=t.scrollLeft,r=t.scrollTop;}i.context.setTabScrollValue(o,r),this.viewService.scrollTo(o,r),this.visibilityService.handleVisibility(i),this.loadVisiblePages(i),(e.isZoomChanged||n)&&this.clearCurrentTabOptimization(),this.loadVisiblePartData(),this.rendererService.render(i,e.renderReason),this.emitZoomChangedEvent(i);}showTabPerspective(t,e){const i=t;if(!i.isDocType)return;if(i.style.visibility="visible",this.layoutService.layout(i,e.renderReason),this.viewService.updateScrollerContentSize(i),this.rendererService.updateCanvasSize(),!i.total)return this.loadVisiblePartData(),void this.rendererService.render(i,e.renderReason);const{scrollLeft:s,scrollTop:n}=i.context.parseReferenceDefault();i.context.setTabScrollValue(s,n),this.viewService.scrollTo(s,n),this.visibilityService.handleVisibility(i),this.loadVisiblePages(i),this.loadVisiblePartData(),this.rendererService.render(i,e.renderReason);}showTabThumbnail(t,e){if(!t.isDocType)return;if(t.style.visibility="visible",this.layoutService.layout(t,e.renderReason),this.viewService.updateScrollerContentSize(t),this.rendererService.updateCanvasSize(),!t.total)return this.loadVisiblePartData(),void this.rendererService.render(t,e.renderReason);if(t.isActive&&this.isVisible&&this.viewerConfig.autoScroll&&!e.isThumbnail){const{scrollLeft:e,scrollTop:i}=t.context.getScrollValuesByCurrentChanged();t.context.setTabScrollValue(e,i);}const{scrollLeft:i,scrollTop:s}=t.context;this.viewService.scrollTo(i,s),this.visibilityService.handleVisibility(t),this.loadVisiblePages(t),e.isClearOptimization&&this.clearCurrentTabOptimization(),this.loadVisiblePartData(),this.rendererService.render(t,e.renderReason);}loadPageImage(t){return this.isDefaultViewer||this.isThumbnailViewer?this.core.imageLoadService.loadDisplayImage(t):this.isPerspectiveViewer?this.core.imageLoadService.loadRawImage(t):null}loadVisiblePages(t){if(t.isDestroyed||null==t||!t.total)return;const e=[],i=[],s=t.getCurrentPage();let n=!1;t.preloadChildren.forEach((t=>{!t.isPreload||t.isLoaded||t.isLoading||(t.uid===(null==s?void 0:s.uid)?n=!0:t.isVisible?i.push(t):t.isPreload&&e.push(t));}));const o=[];n&&o.push(s),o.push(...e.reverse(),...i.reverse()),"image"===this.viewerConfig.renderingMode?o.forEach((e=>{!e.isPreload||e.isLoaded||e.isLoading||(e.isLoading=!0,this.loadPageImage(e.uid).then((i=>{e.isLoading=!1,i&&this.renderPage(t,e,i,!0);const s=this.core.pageService.getPage(e.uid);s&&s.isTextPage&&!s.parsedTexts&&this.core.textLoadService.loadText([s.uid]);})).catch((t=>{e.isLoading=!1;})));})):"rgba"===this.viewerConfig.renderingMode&&(o.forEach((e=>{if(e.isPreload&&!e.isLoaded&&!e.isLoading){this.renderPage(t,e,null,!1);const i=this.core.pageService.getPage(e.uid);i&&i.isTextPage&&!i.parsedTexts&&this.core.textLoadService.loadText([i.uid]);}})),this.loadVisiblePartData());}loadVisiblePartData(){if("rgba"!==this.viewerConfig.renderingMode)return;const t=this.tabService.getActiveTab();null!=t&&t.total&&!t.isDestroyed&&(t.preloadChildren.forEach((t=>{const e=this.core.pageService.getPage(t.uid);e.defaultRenderPage?t.image.defaultRenderPage=e.defaultRenderPage:e.isLoadingDefaultRenderPage||this.core.imageDataService.getDefaultRenderPage(this.uid,t.uid);})),t.visibleChildren.forEach((e=>{const i=this.core.pageService.getPage(e.uid);i.defaultRenderPage&&(e.image.defaultRenderPage=i.defaultRenderPage);const s=this.calcVisiblePartPage(e.uid);s&&e.isVisible&&(s.rect.forEach((t=>{})),s.x<0||s.y<0||s.width<=0||s.height,this.core.imageDataService.getRenderPage(this.uid,e.uid,e.visiblePart.width,e.visiblePart.height,e.visiblePart.rect).then((i=>{var n;if(!i)return;if(!e.isVisible||!e.visiblePart||e.visiblePart.uid!==s.uid)return;let o;o=null!==(n=e.image)&&void 0!==n&&null!==(n=n.visiblePartData)&&void 0!==n&&n.data?e.image.visiblePartData.data:document.createElement("canvas"),o.width=Math.max(e.visiblePart.width,1),o.height=Math.max(e.visiblePart.height,1);const r=o.getContext("2d").createImageData(i.imageInfo.imageWidth,i.imageInfo.imageHeight);r.data.set(i.imageData),o.getContext("2d").putImageData(r,0,0),e.visiblePartData={data:o,visiblePart:e.visiblePart},e.image.visiblePartData={data:o,visiblePart:e.visiblePart},this.rendererService.render(t,51);})).catch((t=>{})));})));}cancelLoadVisiblePartData(t){"rgba"===this.viewerConfig.renderingMode&&this.core.imageDataService.cancelGetRenderPage(this.uid,t);}cancelGetDefaultRenderPage(t){"rgba"===this.viewerConfig.renderingMode&&this.core.imageDataService.cancelGetDefaultRenderPage(this.uid,t);}calcVisiblePartPage(t){const e=this.core.pageService.getPage(t);if(!e)return null;const i=this.getActiveTab().getPageByUid(t),s=this.rendererService.getCanvasDom();let{width:n,height:o}=s;n/=devicePixelRatio,o/=devicePixelRatio;const{image:r}=i,a=r.getPosition(),{x:l,y:h}=a,{width:c,height:d}=r,{rotation:u}=e,p=(u%360+360)%360/90;let g=0,f=0,v=0,m=0;if(0===p?(g=Math.max(0,-l),f=Math.max(0,-h),v=Math.min(c,n,c+l,n-l),m=Math.min(d,o,d+h,o-h)):1===p?(g=Math.max(0,-h),f=Math.max(0,l-n),v=Math.min(c,o,c+h,o-h),m=Math.min(d,n,d-f,l)):2===p?(g=Math.max(0,l-n),f=Math.max(0,h-o),v=Math.min(c,n,c-g,l),m=Math.min(d,o,d-f,h)):3===p&&(g=Math.max(0,h-o),f=Math.max(0,l),v=Math.min(c,o,h,c-g),m=Math.min(d,n,n-l,d-f)),v<=0||m<=0)return null;const y=r.getScale();y.x,y.y;const x=Gn(g/y.x,Bo.displayResolution,Bo.dataResolution);let w=Gn(f/y.y,Bo.displayResolution,Bo.dataResolution);const b=Gn(v/y.x,Bo.displayResolution,Bo.dataResolution),S=Gn(m/y.y,Bo.displayResolution,Bo.dataResolution),C=Gn(e.mediaBox,Bo.displayResolution,Bo.dataResolution);w=2*C.top+C.height-(w+S),w=Math.max(0,w);const P={uid:qs(),x:g,y:f,width:v*devicePixelRatio,height:m*devicePixelRatio,rect:[x,w,x+b,w+S],imageScale:y};let T=!1;return i.visiblePart&&function(t,e){return t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height&&t.rect.join(",")===e.rect.join(",")&&t.imageScale.x===e.imageScale.x&&t.imageScale.y===e.imageScale.y}(i.visiblePart,P)||(T=!0),T?(i.visiblePart=P,P):null}renderPage(t,e,i,s){if(!this.isDestroyed&&this.isVisible&&t.isActive&&t.allPages.includes(e)&&!t.isDestroyed&&e.isPreload&&(e.isLoaded=!0,s&&e.setImgDom(i),e.isVisible)){if(this.isDefaultViewer&&t.context.isSingleDisplay){const e=t.getCurrentPage();if(e&&!e.isLoaded)return}this.rendererService.render(t,51);}}emitPageChangedEvent(t){this.hooks.pageChanged.emit(jg.create(t.current,t.total));}emitPageChangedAfterRenderEvent(t){this.hooks.pageChangedAfterRender.emit(jg.create(t.current,t.total));}emitZoomChangedEvent(t){const{oldZoom:e,zoom:i}=t.context;this.hooks.zoomChanged.emit(pf.create(Tm(e),Tm(i)));}afterPerspective(t,e){const i=this.getActiveTab();if(i&&i.uid===t){const t=i.getTextSelectionLines();null!=t&&t.find((t=>t.pageUid===e))&&this.clearSelectedTexts();}}beforeLoadSource(t){const{tabService:e}=this,i=e.getDocTab(t);i&&i.updateOldInfo();}afterLoadSource(t){const{tabService:e}=this,i=e.getDocTab(t);i&&(this.emitPageChangedAfterRenderEvent(i),i.updateOldInfo());}addPages(t,e,i,s){const{tabService:n}=this,o=n.getDocTab(t);o&&(o.appendPages(e,i,s),this.emitPageChangedEvent(o),o.isActive&&!this.addPagesTimer&&(this.addPagesTimer=setTimeout((()=>{o.isActive&&(this.scrollByCurrentChanged=!0,this.showTab(o,{renderReason:16})),clearTimeout(this.addPagesTimer),this.addPagesTimer=null;}),200)));}deletePages(t,e){const{tabService:i}=this,s=i.getDocTab(t);s&&(this.clearOptimization(e),s.deletePages(e),this.textSelectionService.clearSelectedTexts(),this.hooks.deletePages.emit(Bf.create(e,s.uid)),this.emitEventsForTab(s,{renderReason:23}));}deleteAllPages(t){const{tabService:e}=this,i=e.getDocTab(t);if(!i)return;const s=i.getAllPageUids();this.clearOptimization(s),i.deleteAllPages(),this.textSelectionService.clearSelectedTexts(),this.hooks.deletePages.emit(Bf.create(s,i.uid)),this.emitEventsForTab(i,{renderReason:24});}setCurrentPage(t,e){const{tabService:i}=this,s=i.getDocTab(t);s&&s.current!==e&&(this.clearOptimizePageForSelectedPages([e]),s.gotoPage(e),this.emitEventsForTab(s,{renderReason:25}));}selectPages(t,e){const{tabService:i}=this,s=i.getDocTab(t);if(!s)return;const n=s.getSelected(),o=s.getSelectedIndices();let r=!1;if(o.length!==e.length)r=!0;else for(let t=0;t<e.length;t++)if(o[t]!==e[t]){r=!0;break}if(!r)return;this.clearOptimizePageForSelectedPages(e);const a=s.indicesToUids(e);if(s.selectPages(a),s.isActive){this.showTab(s,{isClearOptimization:!1,isThumbnail:!0,renderReason:17});const t=Vf.create(o,[...e],[...n],a);this.hooks.selectedPageChanged.emit(t);}}movePages(t,e,i){const s=this.tabService.getDocTab(t);s&&(s.movePages(e,i),this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(s,{isClearOptimization:this.isDefaultViewer,renderReason:26},!0));}switchPage(t,e,i){const s=this.tabService.getDocTab(t);s&&(s.switchPage(e,i),this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(s,{isClearOptimization:this.isDefaultViewer,renderReason:27},!0));}reorderPages(t,e){const i=this.tabService.getDocTab(t);i&&i.reorderPages(e);}afterReorderPages(t,e){const i=this.tabService.getDocTab(t);i&&(this.textSelectionService.clearSelectedTexts(),this.emitEventsForTab(i,{isClearOptimization:this.isDefaultViewer,renderReason:28},!0));}emitEventsForTab(t,e){t.isActive&&(this.emitPageChangedEvent(t),this.scrollByCurrentChanged=!0,this.showTab(t,e),this.emitPageChangedAfterRenderEvent(t));}updatePage(t,e,i){const s=this.tabService.getTab(t);if(s&&s.isActive){var n;const t=s.getPageByUid(e);t.isLoaded=!1,t.isLoading=!1,(t=>{const e=window.URL||window.webkitURL;/^blob:/.test(t)&&e.revokeObjectURL(t);})((null===(n=t.image.style)||void 0===n?void 0:n.img).src),this.clearOptimization([e]),this.clearSelectedTexts(),this.showTab(s,{renderReason:18});}}renameDoc(t,e){const{tabService:i}=this,s=i.getTab(t);s&&(s.rename(e),this.hooks.tabChanged.emit());}filter(t,e,i){if(this.isPerspectiveViewer||this.isCaptureViewer)return;const s=this.getActiveTab();s&&s.uid===t&&(e.forEach((t=>{const e=s.getPageByUid(t);e&&(e.isLoaded=!1);})),this.hooks.filterChanged.emit(Jg.create(t,e,i)),this.loadVisiblePages(s),this.clearOptimization(e),this.loadVisiblePartData(),this.rendererService.render(s,52));}activateTab(t){const e=this.tabService.getTab(t);return !!e&&(this.showTab(e,{renderReason:19}),!0)}getActiveTab(){return this.tabService.getActiveTab()}getSelectedTexts(){const t=this.getActiveTab();if(null==t||!t.total)return "";return this.textSelectionService.getSelectedTexts()}async copySelectedTexts(){const t=this.getActiveTab();if(null==t||!t.total)return Promise.reject(new Error("no text selected"));const e=this.textSelectionService.getSelectedTexts();return await navigator.clipboard.writeText(e),Promise.resolve(void 0)}clearSelectedTexts(){this.textSelectionService.clearSelectedTexts();}dispose(){this.tabService.getAllTabs().forEach((t=>{const e=[];if(t.allPages.forEach(((t,i)=>{[...t.mediaBox.childNodes].forEach((t=>{null==t||t.destroy();})),t.isPreload&&e.push({from:!0,to:!1,pageUid:t.uid,index:i});})),e.length){const i=Mf.create(t.uid,this.uid,this.viewerConfig.viewerMode,e);this.core.viewerService.onPagePreloadChanged.emit(i);}})),this.isDestroyed=!0,this.hooks.destroy.emit(),super.dispose();}get isDefaultViewer(){return this.viewerConfig.viewerMode===lg.DEFAULT}get isThumbnailViewer(){return this.viewerConfig.viewerMode===lg.THUMBNAIL}get isPerspectiveViewer(){return this.viewerConfig.viewerMode===lg.PERSPECTIVE}get isCaptureViewer(){return this.viewerConfig.viewerMode===lg.CAPTURE}zoomTo(t,e,i){this.zoomService.zoomTo(t,e,i);}getPageRenderSize(t){const e=this.core.pageService.getPage(t);return this.isPerspectiveViewer?e.raw.getPageSize():e.mediaBox}emit(t,e){this.viewer.emit(t,e);}hasCallback(t){return this.viewer.emitter.hasCallback(t)}clearCurrentTabOptimization(){if(!this.viewerConfig.enableOptimizePage)return;const t=this.getActiveTab();if(t){const e=t.allPages.map((t=>t.uid));this.clearOptimization(e);}}clearOptimization(t){const e=[],i=this.getActiveTab();i&&t.forEach((t=>{const s=i.getPageByUid(t);s&&(e.push(s.optimizationUid),s.clearOptimization());})),this.optimizationService.cancelOptimization(e);}clearOptimizePageForSelectedPages(t){if(!this.isThumbnailViewer)return;if(!this.viewerConfig.enableOptimizePage)return;const e=this.getActiveTab();if(!e)return;const i=this.styleService.isSelectedBorderWidthEqualNormal(),s=this.styleService.isSelectedBorderWidthEqualHovered();if(i&&s)return;t.forEach((t=>{const n=e.getPageByIndex(t);(!s&&n.isHovered||!i&&!e.selected.includes(n.uid))&&this.clearOptimization([n.uid]);}));const n=e.indicesToUids(t);e.selected.forEach((t=>{const o=e.getPageByUid(t);(!s&&o.isHovered||!i&&!n.includes(t))&&this.clearOptimization([t]);}));}applyCursorState(t){this.cursorService.applyCursorState(t);}async searchNextText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchNextText(i.uid,t,e)}async searchPrevText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchPrevText(i.uid,t,e)}async searchFullText(t,e){const i=this.getActiveTab();return !!i&&this.textSearchService.searchFullText(i.uid,t,e)}selectSearchText(t,e){this.textSearchService.selectText(t,e);}nextSearchText(){this.textSearchService.nextText();}prevSearchText(){this.textSearchService.previousText();}clearSearchText(){this.textSearchService.clearSearchText();}getVisiblePagesInfo(){const t=this.getActiveTab();if(!t)return [];if(this.isCaptureViewer)return [];if("hidden"===this.viewerConfig.visibility)return [];const{visibleChildren:e}=t,i=[];if(e.length>0){var s;const{canvas:n}=this.rendererService.docRenderer;let o=null===(s=this.viewer)||void 0===s||null===(s=s.ui)||void 0===s?void 0:s.container;if(this.isThumbnailViewer&&this.mainViewerUid){o=this.core.viewerService.getViewer(this.mainViewerUid).ui.container;}const{left:r,top:a}=o.getBoundingClientRect(),{left:l,top:h}=n.getBoundingClientRect();for(let s=0;s<e.length;s++){const n=e[s],o=t.getPageIndex(n),{x:c,y:d}=n.getPosition();i.push({pageUid:n.uid,pageIndex:o,width:n.bounds.width,height:n.bounds.height,isHovered:n.isHovered,isSelected:n.isSelected,canvasOffsetX:c,canvasOffsetY:d,containerOffsetX:l-r+c,containerOffsetY:h-a+d});}}return i}calcTextStartPosition(t,e){let i=t;if(!(arguments.length>2&&void 0!==arguments[2]&&arguments[2])){const s=this.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);i={x:s.pointerX,y:s.pointerY};}const s=this.core.pageService.getPage(e.uid),n=s.getHoveredTextLineIndex(i);if(-1!==n){const t=s.visibleLines[n],o=s.getSelectedTextCharIndex(n,i);return {lineUid:t.uid,charUid:t.chars[o].uid,pageUid:e.uid,mediaBoxPoint:i}}return null}calcTextEndPosition(t,e,i,s){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=this.core.pageService.getPage(e.uid);if(!o.parsedTexts)return null;let r=t;if(!n){const i=this.getPointerOverMediaBoxInfo(e.mediaBox,t.x,t.y,e.rotation);r={x:i.pointerX,y:i.pointerY};}const a=o.getSelectedTextLineIndex(s,r);if(-1!==a){const t=o.visibleLines[a],s=o.getSelectedTextCharIndex(a,r);return {lineIndex:a,charIndex:s,lineUid:t.uid,charUid:t.chars[s].uid,pageUid:e.uid,pageIndex:i.uidToIndex(e.uid),mediaBoxPoint:r}}return null}getTextSelection(){return this.textSelectionService.getTextSelection()}}class $w extends Qn{constructor(t){super(),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"group",void 0),i(this,"postfix",void 0),i(this,"context",void 0),i(this,"emitter",void 0),i(this,"hooks",void 0),i(this,"core",void 0),i(this,"isDisposed",!1),this.emitter=new Qs,t.core&&(this.core=t.core),this.uid=qs(),this.groupUid=t.groupUid,this.postfix=`-${this.uid}`,this.hooks=this.register(new cg),this.context=new zw(this.core,this,t.viewerConfig),t.container&&!t.uiConfig&&this.context.viewService.bindContainer(t.container),this.listenGlobalEvents();}listenGlobalEvents(){const{documentService:t,viewerService:e}=this.core,{context:i}=this;this.core.onAfterPerspective.on((t=>{i.afterPerspective(t.docUid,t.pageUid);}),this),this.core.onBeforeLoadSource.on((t=>{let{docUid:e}=t;i.beforeLoadSource(e);}),this),this.core.onAfterLoadSource.on((t=>{i.afterLoadSource(t.docUid);}),this),this.core.pageService.onUpdatePage.on((t=>{i.updatePage(t.docUid,t.pageUid,t.data),i.hooks.updatePage.emit(t);}),this),t.onAddPagesToDoc.on((t=>{const{group:e}=this;let{scrollToLatest:s}=e.config;_s(s)&&({scrollToLatest:s}=i.viewerConfig),i.addPages(t.docUid,t.pageUids,s,t.index),i.hooks.addPagesToDoc.emit(t);}),this),t.onDeletePagesFromDoc.on((t=>{i.deletePages(t.docUid,t.pageUids);}),this),t.onDeleteAllPagesFromDoc.on((t=>{i.deleteAllPages(t.docUid);}),this),t.onMovePages.on((t=>{i.movePages(t.docUid,t.indices,t.insertBeforeIndex),this.hooks.movePages.emit(t);}),this),t.onSwitchPage.on((t=>{i.switchPage(t.docUid,t.one,t.another),this.hooks.swapPages.emit(t);}),this),t.onReorderPages.on((t=>{i.reorderPages(t.docUid,t.indices);}),this),t.onAfterReorderPages.on((t=>{i.afterReorderPages(t.docUid,t.indices),this.hooks.reorderPages.emit(t);}),this),t.onBeforeDeleteDocs.on((t=>{i.closeTabs(t.docUids);}),this),t.onDocumentRenamed.on((t=>{i.renameDoc(t.docUid,t.newName);}),this),t.onDocumentDeleted.on((t=>{i.closeTabs([t.docUid]);}),this),t.onOpenDocument.on((t=>{i.groupUid===t.groupUid&&i.openDocument(t.doc);}),this),t.onCloseDocument.on((t=>{i.groupUid===t.groupUid&&i.closeTabs([t.doc.uid]);}),this),e.onGotoPage.on((t=>{i.groupUid===t.groupUid&&i.setCurrentPage(t.docUid,t.index);}),this),e.onSelectPages.on((t=>{i.groupUid===t.groupUid&&i.selectPages(t.docUid,t.indices);}),this),e.onResize.on((()=>{i.resize();}),this),e.onCurrentChangedByScroll.on((t=>{i.groupUid===t.groupUid&&i.uid!==t.viewerUid&&i.setCurrentPage(t.docUid,t.current);}),this),this.core.onFilterChanged.on((t=>{const e=i.getActiveTab();(null==e?void 0:e.uid)===t.docUid&&i.filter(t.docUid,t.pageUids,t.filterType);}),this),this.core.commandService.onOperationsChanged.on((t=>{const e=i.getActiveTab();e?e.uid===t.docUid&&i.hooks.operationsChanged.emit(t):this.hooks.operationsChanged.emit({docUid:t.docUid,undo:0,redo:0});}),this);}dispose(){this.isDisposed||(this.unbindContainer(),this.context.dispose(),this.context=null,this.isDisposed=!0,this.core.removeViewer(this),super.dispose());}undo(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.undo(t.uid)}redo(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.redo(t.uid)}getOperationState(){const t=this.context.getActiveTab();return t?this.core.commandService.getOperationState(t.uid):{undo:0,redo:0}}saveOperations(){const t=this.context.getActiveTab();return !!t&&this.core.commandService.saveOperations(t.uid)}setRowAndColumn(t,e){return this.context.configService.updateConfig({rows:t,columns:e}),!0}getRowAndColumn(){const t=this.context.getActiveTab();if(t)return {rows:t.context.rows,columns:t.context.columns};const{viewerConfig:e}=this.context;return {rows:e.rows||1,columns:e.columns||1}}on(t,e){this.emitter.on(t,e);}emit(t,e){this.emitter.emit(t,e);}off(t,e){this.emitter.off(t,e);}getViewerConfig(){return this.context.viewerConfig}updateViewerConfig(t){this.context.configService.updateConfig(t);}bindContainer(t){return this.context.viewService.bindContainer(t)}unbindContainer(){this.context.viewService.unbindContainer();}show(){"visible"!==this.getViewerConfig().visibility&&(this.updateViewerConfig({visibility:"visible"}),this.context.showCurrentTab({renderReason:6}));}hide(){"hidden"!==this.getViewerConfig().visibility&&this.updateViewerConfig({visibility:"hidden"});}render(t){this.context.render(t);}resize(){this.context.resize();}indexToUid(t){const e=this.context.getActiveTab();return null==e?void 0:e.indexToUid(t)}uidToIndex(t){const e=this.context.getActiveTab();return e?e.uidToIndex(t):-1}getCurrentPageIndex(){const t=this.context.getActiveTab();return t?t.current:-1}getPageCounts(){const t=this.context.getActiveTab();return t?t.total:0}getCurrentPageUid(){var t;const e=this.context.getActiveTab();return null==e||null===(t=e.getCurrentPage())||void 0===t?void 0:t.uid}selectAllPages(){const t=this.getPageCounts();return this.selectPagesByIndices(Array.from(Array(t).keys()))}selectPagesByIndices(t){const e=this.context.getActiveTab();if(!e)return [];const i=e.indicesToUids(t);return this.core.viewerService.onSelectPages.emit(Lf.create(e.uid,this.groupUid,this.uid,t,i)),[...i]}getSelectedPageIndices(){const t=this.context.getActiveTab();if(!t)return [];return t.getSelectedIndices()}gotoPage(t){const e=this.context.getActiveTab();return e?(t=Gs(t,0,e.total-1),e.current===t||this.core.viewerService.onGotoPage.emit(qg.create(e.uid,this.groupUid,this.uid,t)),t):-1}movePages(t,e){const i=this.context.getActiveTab();return !!i&&this.core.movePages(i.uid,t,e)}swapPages(t,e){const i=this.context.getActiveTab();return !!i&&this.core.swapPages(i.uid,t,e)}reorderPages(t){const e=this.context.getActiveTab();return !!e&&this.core.reorderPages(e.uid,t)}deletePages(t){const e=this.context.getActiveTab();if(!e)return !1;if(!t.every((t=>t>=0&&t<e.total)))return !1;const i=e.indicesToUids(t);return this.core.deletePages(e.uid,i)}deleteAllPages(){const t=this.context.getActiveTab();return !!t&&this.core.deleteAllPages(t.uid)}openDocument(t){this.core.openDocument(t.uid,this.uid);}closeDocument(t){if(!t){const e=this.context.getActiveTab();if(!e)return;t=e.uid;}this.core.closeDocument(t,this.uid);}activateTab(t){var e;return (null===(e=this.context)||void 0===e?void 0:e.activateTab(t))||!1}getActiveTab(){var t;return (null===(t=this.context)||void 0===t?void 0:t.getActiveTab())||null}getAllTabs(){var t;return (null===(t=this.context)||void 0===t?void 0:t.tabService.getAllTabs())||[]}getRealPageSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_s(t)&&(t=e.current);const i=e.getPageByIndex(t);return {width:i.rWidth,height:i.rHeight}}getRealPtPageSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_s(t)&&(t=e.current);const i=e.getPageByIndex(t);let s=Gn(i.rWidth,Bo.displayResolution,72),n=Gn(i.rHeight,Bo.displayResolution,72);const o=Math.round(s),r=Math.round(n);return Math.abs(s-o)<1e-6&&(s=o),Math.abs(n-r)<1e-6&&(n=r),{width:s,height:n}}getRealPixelSize(t){const e=this.context.getActiveTab();if(!e)return {width:0,height:0};_s(t)&&(t=e.current);const i=e.getPageByIndex(t),s=this.core.pageService.getPage(i.uid),{rWidth:n,rHeight:o}=s.getEditResultForPerspective();return {width:Gn(n,Bo.displayResolution,s.resource.resolutionX),height:Gn(o,Bo.displayResolution,s.resource.resolutionY)}}zoomIn(){const t=this.getActiveTab();if(!t||!t.isDocType)return;const{maxZoom:e}=this.getViewerConfig(),{zoom:i}=t.context;let s=jw(i,"in");(null===s||s>e)&&(s=e),this.updateViewerConfig({zoom:s});}zoomOut(){const t=this.getActiveTab();if(!t||!t.isDocType)return;const{minZoom:e}=this.getViewerConfig(),{zoom:i}=t.context;let s=jw(i,"out");(null===s||s<e)&&(s=e),this.updateViewerConfig({zoom:s});}filter(t,e){const i=this.context.getActiveTab();if(!i)return !1;const s=i.indicesToUids(t);return s.forEach((t=>{const e=this.core.pageService.getPage(t);e&&(e.isTextPage=!1),this.context.textSelectionService.clearSelectedTexts();})),this.core.filterPages(i.uid,s,e),!0}async perspectivePage(t,e){const i=this.context.getActiveTab();if(!i)return null;let s=i.currentUid;_s(e)||(s=i.indexToUid(e));const n=this.context.core.pageService.getPage(s);t=Gn(t,n.resource.resolutionX,Bo.displayResolution);const o=await this.core.perspectivePage(i.uid,s,t);return this.context.textSelectionService.clearSelectedTexts(),n.isTextPage=!1,o.data}perspectiveAllPage(){const t=this.context.getActiveTab();if(!t)return;this.context.textSelectionService.clearSelectedTexts();const e=[],i=[],s=[];t.allPages.forEach(((t,n)=>{t.isVisible?e.push(n):t.isPreload?i.push(n):s.push(n);}));const n=[...e,...i,...s],{displayResolution:o}=Bo;for(let e=0;e<n.length;e++){const i=this.indexToUid(n[e]),s=this.context.core.pageService.getPage(i);if(s.isFull){let{width:e,height:n}=s.raw.getImageDetail();const r=Math.abs((s.rotation%360+360)%360);if(90===r||270===r){const t=e;e=n,n=t;}const a=[[0,0],[e,0],[e,n],[0,n]];this.context.core.perspectivePage(t.uid,i,Gn(a,s.resolutionX,o),!0);}else if(s.activeQuad&&s.activeQuad!==s.quad){s.isTextPage=!1;const{width:e,height:n}=s.raw.getPageSize(),o=iv(s.activeQuad.flat(),s.rotation,e,n),r=ov(o);this.context.core.perspectivePage(t.uid,i,r,!0);}}}getPerspectivePreviewImage(t,e,i,s){const n=this.context.getActiveTab();if(!n)return null;const o=n.getPageByIndex(t);if(!o)return null;const r=o.uid,{quadSelectionStyle:a}=this.getViewerConfig(),{borderColor:l}=wn(a.border),h=function(t){const e=t=>{const e=t.toString(16);return 1===e.length?`0${e}`:e};if(t.startsWith("rgb")){const i=t.match(/(\d+)/g);if(3===i.length){const t=parseInt(i[0],10),s=parseInt(i[1],10),n=parseInt(i[2],10);return `#${e(t)}${e(s)}${e(n)}`}}if(t.startsWith("#")&&(7===t.length||4===t.length))return t;return "#FE8E14"}(l);return this.context.core.getPerspectivePreviewData(r,{width:e||200,height:i||200},{strokeColor:h.substring(1),lineWidth:s})}async copySelectedTexts(){return this.context.copySelectedTexts()}getSelectedTexts(){return this.context.getSelectedTexts()}searchNextText(t,e){return this.context.searchNextText(t,e)}searchPrevText(t,e){return this.context.searchPrevText(t,e)}searchFullText(t,e){return this.context.searchFullText(t,e)}selectSearchText(t,e){this.context.selectSearchText(t,e);}nextSearchText(){this.context.nextSearchText();}prevSearchText(){this.context.prevSearchText();}clearSearchText(){this.context.clearSearchText();}getVisiblePagesInfo(){return this.context.getVisiblePagesInfo()}}function jw(t,e){const i=[.01,.0625,.125,.25,.333,.5,.667,.75,1,1.25,1.5,2,3,4,6,8,12,16,24,32,64];if("in"===e){for(let e=0;e<i.length;e++)if(i[e]>t)return i[e]}else for(let e=i.length-1;e>=0;e--)if(i[e]<t)return i[e];return null}class Xw extends Qn{constructor(t){super(),i(this,"isDestroyed",!1),i(this,"viewers",new Map),i(this,"groups",new Map),i(this,"onGotoPage",void 0),i(this,"onSelectPages",void 0),i(this,"onCurrentChangedByScroll",void 0),i(this,"onResize",void 0),i(this,"onPagePreloadChanged",void 0),i(this,"onViewerCreated",void 0),i(this,"core",void 0),this.core=t,this.initEventEmitter();}initEventEmitter(){this.onGotoPage=to(this),this.onSelectPages=to(this),this.onCurrentChangedByScroll=to(this),this.onResize=to(this),this.onPagePreloadChanged=to(this),this.onViewerCreated=to(this);}reset(){for(const t of this.viewers.values())t.dispose();this.viewers.clear(),this.groups.clear();}destroy(){if(!this.isDestroyed){for(const t of this.viewers.values())t.dispose();this.viewers=null,this.groups=null,this.isDestroyed=!0;}}createViewer(t,e){var i;const{groupUid:s}=e,n=this.groups.get(s)||new rg(s);var o;_s(null===(i=e.viewerConfig)||void 0===i?void 0:i.scrollToLatest)||n.isSetScrollToLatest||(n.updateConfig({scrollToLatest:null===(o=e.viewerConfig)||void 0===o?void 0:o.scrollToLatest}),n.isSetScrollToLatest=!0);e.groupConfig&&n.updateConfig(e.groupConfig);const r=new t(e);r.group=n,n.viewerUids.add(r.uid),this.groups.set(s,n),this.viewers.set(r.uid,r);const a=this.getViewersByGroupUid(s);if(a.length>0){r.context.syncViewer(a[0]);const t=a[0].getActiveTab();t&&this.core.commandService.emitOperationsChanged(t.uid);}return this.onViewerCreated.emit(sf.create(r)),r}removeViewer(t){let e;if(e=Xs(t)?this.getViewer(t):t,!e)return !1;const{uid:i,groupUid:s}=e,n=this.groups.get(s);return n&&(n.viewerUids.delete(i),n.viewerUids.size||this.groups.delete(s)),this.viewers.delete(e.uid),e.dispose(),!0}hasViewer(t){return this.viewers.has(t)}getViewer(t){return this.viewers.get(t)}getAllViewers(){return Array.from(this.viewers.values())}getViewersByViewerUid(t){const e=this.viewers.get(t);return this.getViewersByGroupUid(e.groupUid)}getViewersByGroupUid(t){return this.groups.has(t)?this.groups.get(t).getViewerUids().map((t=>this.viewers.get(t))):[]}hasGroup(t){return this.groups.has(t)}}const Gw={apply(t){t.viewerService=new Xw(t);},install(t){t.setClass("Viewer",$w);}},Yw=/^<\/([^>]*)>/,qw=/^<([^\s>]+)[^>]*>/,Jw=/^<slot>.*<\/slot>/,Zw=/(:?[@\w-]+)\s*=\s*"(.*?)"/;function Qw(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const{template:i,data:s,components:n,injection:o}=t,r=Kw(i,s,n,o,e),a=r.length;return a&&(r[0].cpInstance=t,r[a-1].cpInstance=t),r}function Kw(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=t.trim();const r=[];function a(t){o=o.substring(t);}function l(t){let[n,o]=t;if(o){const t=function(t){const e={},i=On(t,Zw);return i?(i.forEach((t=>{let[,i,s]=t;e[i]=s;})),e):e}(n),a=e[":for"];a&&(delete e[":for"],t[":for"]=a);const l={type:"start",name:o,data:e,attrs:t};if(r.push(l),(i[o]||s.components&&s.components[o])&&(l.cpOption={Component:i[o]||s.components[o],injection:s}),"input"===o||/\/>/.test(n)){const t={type:"end",name:o,data:e,attrs:{}};r.push(t);}}}function h(t){let[,e]=t;if(e){const t={type:"end",name:e,attrs:{}};r.push(t);}}function c(t){if(t.length){const i={type:"text",name:t,attrs:{},data:e};r.push(i);}}for(;o;){const t=o.indexOf("<");let e;if(0===t){const t=o.match(Yw);if(t){a(t[0].length),h(t);continue}const i=o.match(Jw);if(i){a(i[0].length),r.push(...n);continue}const s=o.match(qw);if(s&&s[0]!==s.input){a(s[0].length),l(s);continue}e=o;}else e=t>0?o.substring(0,t):o;e&&(a(e.length),c(e));}return r}function tb(t){const{cpInstance:e,children:i}=t;e&&!e.isInserted&&(e.isInserted=!0,e.hooks.inserted.emit()),i.forEach((t=>{tb(t);}));}function eb(t){const{cpInstance:e,children:i}=t;e&&e.hooks.destroyed.emit(t),i.forEach((t=>{eb(t);}));}function ib(t){if(t){const{el:e,children:i,cpInstance:s}=t;if(null!=s&&s.emitDestroyByRender&&function(t){const{cpInstance:e}=t;e&&(e.dispose(),e.hooks.beforeDestroyed.emit(t));}(t),e){const i=e.parentElement;i&&i.removeChild(e),e.vNode=null,t.el=null;}return null!=s&&s.emitDestroyByRender&&eb(t),t.text=null,t.parent=null,i.length&&i.forEach((t=>{ib(t);})),!0}return !1}class sb{constructor(t){i(this,"el",void 0),i(this,"tagName",void 0),i(this,"sel",""),i(this,"data",void 0),i(this,"children",void 0),i(this,"text",void 0),i(this,"key",void 0),i(this,"cpInstance",void 0),i(this,"cpOptions",void 0),i(this,"parent",void 0),this.createVNode(t);}renderDom(){if(this.el)return this.el;let t;if("FRAGMENT"===this.tagName)t=document.createDocumentFragment();else if("TEXT"===this.tagName){const e=function(t){return 0===t.length?"":t.replace(function(){if(fn)return fn;let t="";return vn(gn,(e=>{t+=`${e}|`;})),t+="&#(\\d{1,5});",fn=new RegExp(t,"g"),fn}(),((t,e)=>pn[t]||String.fromCharCode(+e)))}(this.text);t=document.createTextNode(e);}else {t=document.createElement("IMAGE"===this.tagName?"IMG":this.tagName);for(const[e,i]of Object.entries(this.data))t.setAttribute(e,i);}return this.children.forEach((e=>{const i=e.renderDom();t.appendChild(i);})),t.vNode=this,this.el=t,function(t){const{cpInstance:e,el:i}=t;e&&(e.vNode=t,e.hooks.created.emit(i));}(this),t}patch(t){return function(t,e){const i=t.el,s=i.parentNode;null!==s&&(e.el=e.renderDom(),yn(e.el,i,s),ib(t));let n=-1;const o=t.parent;return null==o||o.children.forEach(((e,i)=>{e===t&&(n=i);})),n>-1&&(o.children[n]=e,e.parent=o,t.el=null),e}(this,t)}destroy(){return ib(this)}createVNode(t){const{tagName:e,data:i={},children:s=[],el:n=null,key:o,text:r="",cpOptions:a,cpInstance:l}=t;let h=e;i.id&&(h+=`#${i.id}`),i.class&&(h+=`.${i.class}`),this.sel=h,this.data=i,this.tagName=e,this.children=s,this.el=n,this.key=o,this.text=r,this.cpInstance=l,this.cpOptions=a;}}function nb(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const i=[],s=[];let n=[];return t.forEach((t=>{if("start"===t.type)i.push(t),s.push(n),n=[];else if("text"===t.type)n.push({type:"text",value:t.name,data:t.data});else if(t instanceof sb)n.push(t);else {let e=i.pop();for(;e.name!==t.name;)e=i.pop();if(e){const{name:t,cpInstance:i,attrs:o,cpOption:r,data:a}=e,l={type:"token",tagName:t,cpInstance:i,cpOption:r,attrs:o,data:a,children:n};n.forEach((t=>{t.parent=l;})),n=s.pop(),n.push(l);}}})),e?n[0]:n}const ob=/'.+'|\\".+\\"|[\w$.]+/g,rb=/{{([^\s@}]+)}}/;function ab(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Ls(t)){const e=[];return t.forEach((t=>{e.push(...hb(ab(t)));})),e}if(t instanceof sb)return t;if("token"===t.type){var i;const{tagName:s,attrs:n,cpInstance:o,children:r,data:a,cpOption:l}=t;if(n[":for"])return function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{attrs:i,data:s}=t,n=JSON.parse(JSON.stringify(i)),o={":for":i[":for"]};delete i[":for"],lb(o,{...s,...e});const r=[];return o[":for"].forEach((e=>{const i=ab(t,e);r.push(...hb(i));})),t.attrs=n,r}(t,e);const h={...a,...e},c={...n};let d;if(lb(n,h),Object.prototype.hasOwnProperty.call(n,"if")&&!n.if)d=null;else if(delete n.if,l)d=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{children:i,attrs:s,cpOption:n}=t,o=cb(i,e),{Component:r,injection:a}=n,l=new r({data:s,injection:a}),h=nb(Qw(l,o));if(!h)return null;return hb(ab(h))[0]}(t,e);else {const{key:t}=n;void 0!==t&&delete n.key;const i=cb(r,e);d=new sb({tagName:s.toUpperCase(),data:n,cpInstance:o,key:t,children:i});}return t.attrs=c,null===(i=d)||void 0===i||i.children.forEach((t=>{t.parent=d;})),d}return function(t){var e;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{value:s}=t;const n=null===(e=t.parent)||void 0===e||null===(e=e.attrs)||void 0===e?void 0:e.html;if(s=function(t,e){const i=On(t,rb);i.length&&i.forEach((i=>{const s=i[1].split(".").reduce(((t,e)=>t[e]),e),n=i[0];t=t.replace(n,s);}));return t}(s,{...t.data,...i}),n){return ab(nb(Kw(s),!1))}return new sb({tagName:"TEXT",text:s})}(t,e)}function lb(t,e){for(const n of Object.keys(t)){const[,o,r]=n.match(/^(:|@)(.+)/)||[];if(!r)continue;let a=t[n];if(delete t[n],"for"===r){var i,s;let[n,o]=a.split(" in "),[r,l]=n.split(",");r=r.trim(),l=null===(i=l)||void 0===i?void 0:i.trim(),o=null===(s=o)||void 0===s?void 0:s.trim();const h=[],c=o.split(".").reduce(((t,e)=>t[e]),e);if(Ls(c))c.forEach(((t,e)=>{const i={};i[r]=t,l&&(i[l]=e),h.push(i);}));else if(Os(c))for(const[t,e]of Object.entries(c)){const i={};i[r]=e,l&&(i[l]=t),h.push(i);}t[":for"]=h;}else {const i="this"===a?e:a.split(".").reduce(((t,e)=>null==t?void 0:t[e]),e);if(void 0!==i)"class"===r&&t[r]?t[r]=`${t[r]} ${i}`:t[r]=i;else {a=a.replace(ob,(t=>t.includes('"')||t.includes("'")||/^(true|false|\d+|undefined|null)$/.test(t)?t:t.split(".")));try{const i=db(a,e);Un(i)&&(t[r]=void 0),"class"===r&&t[r]?t[r]=`${t[r]} ${i}`:t[r]=i;}catch(e){t[r]=void 0;}}"@"===o&&(t.events||(t.events={}),t.events[r]=t[r],delete t[`@${r}`]);}}}function hb(t){return t?(Ls(t)||(t=[t]),t):[]}function cb(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=[];return t.forEach((t=>{const s=ab(t,e)||[];i.push(...hb(s));})),i}function db(t,e){let i=null;try{const s=t.split(",");for(let t=0;t<s.length;t++){const i=s[t],n=/(\w+)(\[(\d+)\])?/,o=i.match(n);if(!o){e=null;break}{const t=o[1],i=o[3];if(!Object.prototype.hasOwnProperty.call(e,t)){e=null;break}e=e[t],void 0!==i&&Array.isArray(e)&&(e=e[i]);}}i=e;}catch(t){i=null;}return i}class ub extends Qn{constructor(t){let{data:e={},template:s="",components:n={},injection:o={}}=t;super(),i(this,"el",void 0),i(this,"vNode",null),i(this,"template",""),i(this,"data",{}),i(this,"injection",{}),i(this,"components",{}),i(this,"emitter",void 0),i(this,"uiEmitter",void 0),i(this,"isInserted",!1),i(this,"emitDestroyByRender",!0),i(this,"hooks",{created:tn.create(),inserted:tn.create(),updated:tn.create(),beforeDestroyed:tn.create(),destroyed:tn.create()}),i(this,"selfEvents",[]),i(this,"globalEvents",[]),i(this,"nativeEvents",[]),this.template=s,this.emitter=Qs.create(),this.setData(e),this.setComponents(n),this.setInjects(o),this.uiEmitter=this.injection.emitter,this.hooks.created.on((t=>{this.el=t;})),this.hooks.destroyed.on((()=>{this.dispose();})),this.initEvents();}setInjects(t){Object.assign(this.injection,t);}initEvents(){var t=this;const e=(e,i)=>{this.on(e,(function(){for(var e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];Xs(i)?t.$emit(i,...s):zs(i)&&i(...s);}));};for(const[t,s]of Object.entries((null===(i=this.data)||void 0===i?void 0:i.events)||{})){var i;e(t,s);}for(const[t,i]of Object.entries((null===(s=this.data)||void 0===s||null===(s=s.options)||void 0===s?void 0:s.events)||{})){var s;e(t,i);}}setData(t){Object.assign(this.data,t);}setComponents(t){Object.assign(this.components,t);}on(t,e){this.emitter.on(t,e),this.selfEvents.push([t,e]);}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.emitter.emit(t,...i);}unbindSelfEvents(){this.selfEvents.forEach((t=>{let[e,i]=t;this.emitter.off(e,i);})),this.selfEvents=[];}$on(t,e){var i;this.uiEmitter&&(null===(i=this.uiEmitter)||void 0===i||i.on(t,e),this.globalEvents.push([t,e]));}$emit(t){for(var e,i=arguments.length,s=new Array(i>1?i-1:0),n=1;n<i;n++)s[n-1]=arguments[n];null===(e=this.uiEmitter)||void 0===e||e.emit(t,...s);}unbindGlobalEvents(){this.globalEvents.forEach((t=>{let[e,i]=t;this.uiEmitter.off(e,i);})),this.globalEvents=[];}nativeOn(t,e,i){if(Ls(t))t.forEach((t=>{this.nativeOn(t,e,i);}));else {const s=((t,e,i,s)=>t?(t.addEventListener(e,i,s),()=>{t.removeEventListener(e,i);}):null)(t,e,i);s&&this.nativeEvents.push(s);}}unbindNativeEvents(){this.nativeEvents.forEach((t=>{t();})),this.nativeEvents=[];}query(t){var e;return null===(e=this.el)||void 0===e?void 0:e.querySelector(t)}queryAll(t){var e;return null===(e=this.el)||void 0===e?void 0:e.querySelectorAll(t)}parseHTML(){return ab(nb(Qw(this,[])))}reRenderVNode(){const t=function(t){const e=Qw(t);return ab(nb(e))}(this);this.vNode.patch(t);}bindEventsEmitter(){var t=this;const{options:e}=this.data;if(null!=e&&e.events)for(const[i,s]of Object.entries(e.events))this.nativeOn(this.el,i,(function(){for(var e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];t.emit(i,...s);}));}dispose(){this.unbindSelfEvents(),this.unbindGlobalEvents(),this.unbindNativeEvents(),super.dispose();}}const pb=(t,e,i,s)=>{const{id:n,tooltip:o,dataId:r,style:a,className:l}=t||{},h=(t=>{let e="";if(t)for(const[i,s]of Object.entries(t))e+=`${Bs(i)}:${s};`;return e})(a);return (_s(n)?"":` id="${n}"`)+` class="${e}${null!=i?i:""} ${l||""}"`+(_s(s)?"":` :class="${s}"`)+(h?` style="${h}"`:"")+(_s(o)?"":` title="${o}"`)+(_s(r)?"":` data-id="${r}"`)};function gb(t){if(0===Object.keys(t).length||!t)return '<MainView :options="this"></MainView>';const e=-1!==["Root","DDVRoot","Layout","DDVLayout"].indexOf(null==t?void 0:t.type);return Xs(t.type)&&!e?`<${t.type} :options="this"></${t.type}>`:'<Root :options="this"></Root>'}function fb(){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const e=Ns(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return null!=e&&e.children&&(e.children=e.children.map((t=>Xs(t)?{type:t}:Os(t)?fb(t):t))),t.length&&(e.children||Ls(e.children)||(e.children=[]),e.children.push(...t)),e}class vb{constructor(t){i(this,"options",void 0),i(this,"postfix",void 0),i(this,"uiEvents",[]),i(this,"parsedUiConfig",void 0),i(this,"injection",void 0),i(this,"rootComponent",void 0),i(this,"emitter",null),i(this,"rootDom",null),i(this,"rootVNode",void 0),i(this,"container",void 0),i(this,"uiConfig",{}),i(this,"popupUiConfig",[]);const{container:e,injection:s,postfix:n,uiConfig:o,emitter:r,popupUiConfig:a}=t;this.options=t,this.injection=s,this.uiConfig=o,this.popupUiConfig=a,this.parsedUiConfig=fb(o,a),this.emitter=r||Qs.create(),this.postfix=n||`-${qs()}`,Xs(e)?this.container=document.getElementById(e):e instanceof HTMLElement&&(this.container=e),this.init();}static registerComponent(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(const[e,i]of Object.entries(t))vb.isAlreadyRegistered(e)||(this.components[`DDV${e}`]=i,this.components[e]=i);}static isAlreadyRegistered(t){return !!this.components[t]}static getComponents(){return this.components}init(){const t=new ub({data:this.parsedUiConfig,template:gb(this.parsedUiConfig),components:vb.getComponents(),injection:{...this.injection,components:vb.getComponents(),postfix:this.postfix,emitter:this.emitter}}),e=t.parseHTML();if(!e)return;const i=e.renderDom();this.rootComponent=t,this.rootVNode=e,this.rootDom=i,this.container&&(this.container.appendChild(i),tb(this.rootVNode));}updateUiConfig(t){const e=fb(t,this.popupUiConfig),i=new ub({data:e,template:gb(this.parsedUiConfig),components:vb.getComponents(),injection:{...this.injection,components:vb.getComponents(),postfix:this.postfix,emitter:this.emitter}}).parseHTML(),s=this.rootVNode.patch(i);return this.rootDom=s.el,this.rootVNode=s,this.uiConfig=t,tb(this.rootVNode),!0}bindContainer(t){let e;if(Zs(t)&&(e=t),Xs(t)){const i=document.getElementById(t);Zs(i)&&(e=i);}return !!e&&(this.container=e,e.appendChild(this.rootDom),tb(this.rootVNode),!0)}unbindContainer(){if(this.container&&0!==this.container.children.length){for(let t=0;t<this.container.children.length;t++)if(this.container.children[t]===this.rootDom)return void this.container.removeChild(this.rootDom);this.container=null;}}queryByDataId(t){var e;return null===(e=this.rootDom)||void 0===e?void 0:e.querySelector(`[data-id=${t}]`)}queryAllByDataId(t){var e;return null===(e=this.rootDom)||void 0===e?void 0:e.querySelectorAll(`[data-id=${t}]`)}getElementsByType(t,e){var i;const s=[];return (null===(i=t.cpInstance)||void 0===i||null===(i=i.constructor)||void 0===i?void 0:i.cpName)===e&&t.el&&s.push(t.el),t.children.length>0&&t.children.forEach((t=>{s.push(...this.getElementsByType(t,e));})),s}on(t,e){const i=this.emitter.on(t,e);this.uiEvents.push(i);}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),s=1;s<e;s++)i[s-1]=arguments[s];this.emitter.emit(t,...i);}off(t,e){this.emitter.off(t,e);}offAllEvents(){this.uiEvents.forEach((t=>{let{name:e,fn:i,context:s,once:n}=t;this.emitter.off(e,i,s,n);}));}dispose(){this.unbindContainer(),this.offAllEvents(),this.emitter=null,this.rootDom=null,this.uiConfig={},this.parsedUiConfig={},eb(this.rootVNode);}}i(vb,"components",{});class mb extends ub{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";super(t),i(this,"defaultClass","ddv-button"),this.initTemplate(e),this.bindBaseHooks();}bindBaseHooks(){this.hooks.inserted.on((t=>{this.bindEventsEmitter();}));}initTemplate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const{options:e}=this.data,i=""===t?this.defaultClass:`${this.defaultClass} ${t}`,s=`<button ${pb(e,i)} >`+(_s(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+"<slot></slot></button>";this.template=s;}}class yb extends ub{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"row";super(t),i(this,"defaultClass","ddv-layout"),i(this,"enableScroll",!1),i(this,"showScrollArrow",!0),i(this,"scrollLeftOrTopBtn",void 0),i(this,"scrollRightOrBottomBtn",void 0);const{options:s}=this.data;this.enableScroll=(null==s?void 0:s.enableScroll)||!1,this.showScrollArrow=(null==s?void 0:s.showScrollArrow)||!0,this.initTemplate((null==s?void 0:s.flexDirection)||e),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{xb(this),this.bindCustomScroll();})),this.hooks.updated.on((()=>{xb(this);}));}bindCustomScroll(){if(!this.enableScroll)return;this.showScrollArrow&&this.initCustomScrollButton();const t=new ResizeObserver((()=>{this.showScrollArrow&&this.updateCustomScrollButton();}));t.observe(this.el),this.hooks.destroyed.on((()=>{t.disconnect();}));}initCustomScrollButton(){const t=document.createElement("button"),e=document.createElement("button"),i=150;this.nativeOn(t,"click",(()=>{const{scrollLeft:e,scrollTop:s}=this.el;t.classList.contains("ddv-scroll-top")?this.el.scroll(0,s-i):this.el.scroll(e-i,0);})),this.nativeOn(e,"click",(()=>{const{scrollLeft:t,scrollTop:s}=this.el;e.classList.contains("ddv-scroll-bottom")?this.el.scroll(0,s+i):this.el.scroll(t+i,0);})),this.nativeOn(this.el,"scroll",(t=>{this.showScrollArrow&&this.updateCustomScrollButton(),this.$emit("ui_layoutScroll",this.el);})),this.el.appendChild(t),this.el.appendChild(e),this.scrollLeftOrTopBtn=t,this.scrollRightOrBottomBtn=e,this.updateCustomScrollButton();}updateCustomScrollButton(){const{vertical:t,horizontal:e}=wb(this.el),{scrollLeft:i,scrollTop:s}=this.el,{scrollRightOrBottomBtn:n,scrollLeftOrTopBtn:o}=this;if(!o||!n)return;if(!t&&!e)return o.style.display="none",void(n.style.display="none");o.className="ddv-scroll-button "+(e?"ddv-scroll-left":"ddv-scroll-top"),n.className="ddv-scroll-button "+(e?"ddv-scroll-right":"ddv-scroll-bottom");const r=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const{vertical:i,horizontal:s}=wb(t);if(!i&&!s)return [!1,!1];const{scrollLeft:n,scrollTop:o,scrollHeight:r,scrollWidth:a,clientWidth:l,clientHeight:h}=t;if(s)return [n<=e,n+l+e>=a];return [o<=e,o+h+e>=r]}(this.el,3);e?(o.style.left=`${i}px`,n.style.right=-i+"px"):(o.style.top=`${s}px`,n.style.bottom=-s+"px"),o.style.display=r[0]?"none":"",n.style.display=r[1]?"none":"";}initTemplate(t){const{options:e}=this.data,i=(null==e?void 0:e.children)||[],s="row"===t?"":"-col";let n=`${this.defaultClass}${s}`;this.enableScroll&&(n+=" ddv-custom-scroll-hidden");let o=`<div ${pb(e,n)}>`;i&&i.length&&i.forEach(((t,e)=>{if(Os(t)){const{type:i}=t;i.trim(),i.length>0&&(o+=`<${i} :options="options.children[${e}]"></${i}>`);}})),o+="</div>",this.template=o;}}function xb(t){const{options:e}=t.data,i=t.el.children;((null==e?void 0:e.children)||[]).forEach(((e,s)=>{if(Zs(e)){const n=e;0===s?(t.el.append(n),t.el.insertBefore(n,i[0])):((t,e)=>{const i=e.parentNode;i.lastChild===e?i.appendChild(t):yn(t,e.nextSibling,i);})(n,i[s-1]);}}));}function wb(t){let e=t.scrollHeight>t.clientHeight,i=t.scrollWidth>t.clientWidth;if(e&&i){t.scrollHeight-t.clientHeight>t.scrollWidth-t.clientWidth?i=!1:e=!1;}return {vertical:e,horizontal:i}}class bb extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-root"),this.initTemplate(),this.bindHooks();}initTemplate(){const{options:t}=this.data,{children:e}=t,i="column"===t.flexDirection?`ddv-column ${this.defaultClass}`:this.defaultClass;let s=`<div ${pb(t,i,"")} >`;e&&e.length&&e.forEach(((t,e)=>{if(Os(t)){const{type:i}=t;i.trim(),i.length>0&&(s+=`<${i} :options="options.children[${e}]"></${i}>`);}})),s+="</div>",this.template=s;}bindHooks(){this.hooks.inserted.on((()=>{xb(this);}));}}class Sb extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-split-row"),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{this.updateClassName();})),this.hooks.updated.on((()=>{this.isInserted&&this.updateClassName();}));}updateClassName(){const t=this.el.parentNode,e=window.getComputedStyle(t),{flexDirection:i}=e;"column"===i&&(this.el.classList.remove(this.defaultClass),this.el.classList.add("ddv-split-column"));}initTemplate(){const{options:t}=this.data,e=pb(t,this.defaultClass);this.template=`<div ${e}></div>`;}}class Cb extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-swipe-indicator"),i(this,"touchStartY",0),i(this,"touchEndY",0),i(this,"isSwiping",!1),i(this,"swipeLever",1),i(this,"handleTouchStart",(t=>{1===t.touches.length&&(t.preventDefault(),this.touchStartY=t.touches[0].clientY,this.touchEndY=t.touches[0].clientY,this.isSwiping=!0);})),i(this,"handleTouchMove",(t=>{this.isSwiping&&(t.preventDefault(),this.touchEndY=t.touches[0].clientY);})),i(this,"handleTouchEnd",(()=>{if(!this.isSwiping)return;const t=this.touchEndY-this.touchStartY;Math.abs(t)<30||(t>0?this.updateContainer(!1):this.updateContainer(!0)),this.isSwiping=!1;})),this.initTemplate(),this.hooks.inserted.on((()=>{this.bindNativeEvents();})),this.$on("ui_swipeReset",(t=>{t===this.el.parentNode&&(this.swipeLever=1);}));}bindNativeEvents(){const{el:t}=this;t&&(t.parentNode&&(t.parentNode.style.transition="top 0.25s ease-in-out, height 0.25s ease-in-out"),t.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),t.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),t.addEventListener("touchend",this.handleTouchEnd,{passive:!1}));}updateContainer(t){const e=this.el.parentNode;if(e)if(t){if(0===this.swipeLever)return this.swipeLever=1,e.style.height="",e.style.top="",void this.$emit("ui_swipeChanged",e);1===this.swipeLever&&(this.swipeLever=2,e.style.height="100%",e.style.top="0px",this.$emit("ui_swipeChanged",e));}else {if(2===this.swipeLever)return this.swipeLever=1,e.style.height="",void(e.style.top="");if(1===this.swipeLever)return this.swipeLever=0,e.style.height="25%",void(e.style.top="75%");0===this.swipeLever&&(e.style.height="0px",e.style.top="100%",setTimeout((()=>{this.$emit("ui_swipeHide",e);}),300));}}initTemplate(){const{options:t}=this.data,e=`<div ${pb(t,this.defaultClass)}><div class="${this.defaultClass}-line"></div></div>`;this.template=e;}}const Pb={CameraResolution:"ddvCameraResolution",Capture:"ddvCapture",Flashlight:"ddvFlashlight",CameraConvert:"ddvCameraConvert",AutoDetect:"ddvAutoDetect",AutoCapture:"ddvAutoCapture",Rotate:"ddvRotate",RotateLeft:"ddvRotateLeft",RotateRight:"ddvRotateRight",Load:"ddvLoad",Delete:"ddvDelete",DeleteCurrent:"ddvDeleteCurrent",DeleteAll:"ddvDeleteAll",Zoom:"ddvZoom",ZoomIn:"ddvZoomIn",ZoomOut:"ddvZoomOut",ZoomByPercentage:"ddvZoomByPercentage",Crop:"ddvCrop",CropAll:"ddvCropAll",CropCurrent:"ddvCropCurrent",CropMode:"ddvCropMode",PerspectiveAll:"ddvPerspectiveAll",FullQuad:"ddvFullQuad",Undo:"ddvUndo",Redo:"ddvRedo",Restore:"ddvRestore",Pan:"ddvPan",Filter:"ddvFilter",Print:"ddvPrint",ThumbnailSwitch:"ddvThumbnailSwitch",DisplayMode:"ddvDisplayMode",ContinuousPage:"ddvContinuousPage",SinglePage:"ddvSinglePage",FitMode:"ddvFitMode",FitWidth:"ddvFitWidth",FitHeight:"ddvFitHeight",FitWindow:"ddvFitWindow",ActualSize:"ddvActualSize",Back:"ddvBack",Close:"ddvClose",Done:"ddvDone",Download:"ddvDownload",ImagePreview:"ddvImagePreview",FirstPage:"ddvFirstPage",LastPage:"ddvLastPage",NextPage:"ddvNextPage",PrevPage:"ddvPrevPage",FitMode_FitWidth:"ddvFitModeFitWidth",FitMode_FitHeight:"ddvFitModeFitHeight",FitMode_FitWindow:"ddvFitModeFitWindow",FitMode_ActualSize:"ddvFitModeActualSize",DisplayMode_SinglePage:"ddvDisplayModeSinglePage",DisplayMode_ContinuousPage:"ddvDisplayModeContinuousPage",Crop_CropAll:"ddvCropCropAll",Crop_CropCurrent:"ddvCropCropCurrent",Crop_CropCancel:"ddvCropCropCancel",Crop_CropApply:"ddvCropCropApply",Filter_FilterAll:"ddvFilterFilterAll",Delete_DeleteCurrent:"ddvDeleteDeleteCurrent",Delete_DeleteAll:"ddvDeleteDeleteAll",RectAnnotation:"ddvRect",EllipseAnnotation:"ddvEllipse",InkAnnotation:"ddvInk",PolygonAnnotation:"ddvPolygon",PolylineAnnotation:"ddvPolyline",LineAnnotation:"ddvLine",StampImageAnnotation:"ddvStampImage",StampIconAnnotation:"ddvStampIcon",TextTypewriterAnnotation:"ddvTypewriter",TextBoxAnnotation:"ddvTextBox",HighlightAnnotation:"ddvHighlight",StrikeoutAnnotation:"ddvStrikeout",UnderlineAnnotation:"ddvUnderline",EraseAnnotation:"ddvAnnotationEraser",SelectAnnotation:"ddvAnnotationSelect",SendBackward:"ddvSendBackward",SendToBack:"ddvSendToBack",BringToFront:"ddvBringToFront",BringForward:"ddvBringForward",AnnotationSet:"ddvAnnotationSet",TextSearchPanelSwitch:"ddvTextSearchPanelSwitch",TextSelectionMode:"ddvTextSelectionMode"},Tb=["Arial","Courier","Helvetica","Times New Roman"],Ab=function(){let t=0,e=0;return function(i){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(t&&clearTimeout(t),n){const n=!t;t=setTimeout((()=>{e!==t&&(t=0,e=0,i());}),s),n&&(e=t,i());}else t=setTimeout((()=>{i(),t=0;}),s);}}();function kb(t,e,i){const s=s=>{const n=(parseFloat(s.value)-e)/(i-e)*100;t.style.backgroundSize=`${n}% 100%`;};s(t),t.oninput=e=>{s(t);},t.onchange=e=>{s(t);};}function Db(t,e){const{bottom:i,height:s}=t.parentNode.getBoundingClientRect(),{height:n}=t.getBoundingClientRect(),{bottom:o}=e.getBoundingClientRect();let r=s;return o-i<n&&(r=-n),r}function Rb(t){t.$on("ui_hidePopup",(e=>{e!==t&&zs(null==t?void 0:t.togglePopup)&&(null==t||t.togglePopup(!1));}));}function Eb(t){t.isRefactorCrop=!0,t.$on("ui_cropClick",(e=>{const{viewer:i}=t.injection,s=i.getPageCounts()||0;(e||s)&&Ib(t.el,e);}));}function Mb(t){t.isRefactorCrop=!0,t.isRefactorAnnotation=!0,t.$on("ui_toolModeRefactor",(()=>{const{viewer:e}=t.injection,i=e.getPageCounts()||0,{toolMode:s}=e.context.viewerConfig;i&&Ib(t.el,"annotation"===s||"crop"===s);}));}function Ib(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!t)return;const{classList:i}=t,s=i.contains("ddv-button-disabled");e?s||t.classList.add("ddv-button-disabled"):s&&!e&&t.classList.remove("ddv-button-disabled");}function Bb(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"base";if(!t)return;const{classList:s}=t;let n="ddv-button-activated";"deep"===i?n="ddv-button-activated-deep":"light"===i&&(n="ddv-button-activated-light");const o=s.contains(n);e?o||t.classList.add(n):t.classList.remove(n);}function Ub(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const{left:o,right:r,bottom:a}=function(t,e){const i=(e||t.parentElement).getBoundingClientRect(),s=t.getBoundingClientRect(),n=s.top-i.top,o=i.right-s.right;return {top:n,bottom:i.bottom-s.bottom,left:s.left-i.left,right:o}}(e,t),{x:l,y:h,width:c}=t.getBoundingClientRect(),{height:d,width:u}=i.getBoundingClientRect(),{x:p,y:g,width:f,height:v}=e.getBoundingClientRect(),m=Cr(getComputedStyle(t).borderWidth);let y=Math.floor(p)-Math.floor(l)-m.value;y<5&&(y=0);const x=c-u,w=y-(Math.floor(u)-Math.floor(f))/2,b=w<5?"0px":`${w}px`;let S=Math.floor(g)-Math.floor(h)-m.value;i.style.left=n&&r>u/2&&o>u/2?b:c<u+5?"0px":r>u?`${y}px`:o>u?y-(Math.floor(u)-Math.floor(f))+"px":r>u/2&&o>u/2?b:x<5?"0px":`${x}px`,a>d?(s&&(S+=2),i.style.top=S+Math.floor(v)-1+"px"):(s&&(S-=4),i.style.top=S-Math.floor(d)+"px");}function Lb(t,e,i){const s=eP.getTooltip(),n=eP.getDisplayTextConfig(),o=Pb;null!=i&&i.id||!(t in o)||(i.id=o[t]+e.postfix),null!=i&&i.tooltip||!(t in s)||(i.tooltip=s[t]),null!=i&&i.displayText&&(i.label=null==i?void 0:i.displayText),null!=i&&i.label||!(t in n)||(i.label=n[t]);}function Ob(t){return (null==t?void 0:t.constructor.cpName)||""}function Nb(t){const{value:e}=t,{fontSize:i,fontFamily:s,paddingLeft:n,paddingRight:o}=getComputedStyle(t),r=document.createElement("div");r.style.position="absolute",r.style.left="-9999px",r.style.top="-9999px",r.style.visibility="hidden",r.style.fontSize=i,r.style.fontFamily=s||"Arial, Helvetica, sans-serif",document.body.appendChild(r),r.textContent=e;const a=r.clientWidth+parseInt(n,10)+parseInt(o,10);return r.remove(),a}function _b(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];t.el&&(Ib(t.el,"disabled"===e),function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!t)return;const{classList:i}=t,s=i.contains("ddv-button-focused");e?s||t.classList.add("ddv-button-focused"):t.classList.remove("ddv-button-focused");}(t.el,"focused"===e),i&&Bb(t.el,"focused"===e,s?"deep":"base"),t.uiState=e);}function Wb(t,e){let i=document.getElementById(`ddvMask${t.postfix}`);if(!i&&!e)return;if(i&&!e)return void i.remove();i||(i=document.createElement("div"),i.id=`ddvMask${t.postfix}`,i.className="ddv-mask");t.context.viewService.rootDom.appendChild(i);}function Fb(t,e){if(!e.context.isDefaultViewer)return !1;const i=e.getViewerConfig().toolMode,s="crop"===i&&t.isRefactorCrop,n="annotation"===i&&t.isRefactorAnnotation;return !(!s&&!n)}class Hb extends mb{constructor(t,e){super(t,e.class),i(this,"callback",void 0),i(this,"isRefactorCrop",!1),i(this,"isRefactorAnnotation",!1),i(this,"uiState","normal"),i(this,"isFocused",!1),i(this,"isMenuButton",!1),this.callback=e.callback,this.bindHooks(),this.isMenuButton=t.data.menu||!1,"false"!==t.data.default&&this.bindDefaultUi();}bindEvent(){this.nativeOn(this.el,"click",(()=>{this.callback();}));}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup");}));}setUiState(t){_b(this,t,!(arguments.length>1&&void 0!==arguments[1])||arguments[1],this.isMenuButton);}bindDefaultUi(){const{viewer:t}=this.injection,e=t=>{let e=this.isFocused?"focused":"normal";(_s(null==t?void 0:t.pageCount)?this.injection.viewer.getPageCounts():t.pageCount)?Fb(this,this.injection.viewer)&&(e="disabled"):e="disabled",this.setUiState(e,!$s());};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindHooks(){this.hooks.created.on((()=>{this.bindEvent(),this.bindHidePopup();})),this.hooks.updated.on((()=>{this.uiState="normal";}));}initTemplate(t){const e=this.data;e.options||(e.options={});const{options:i,id:s}=this.data;s&&(i.id=s),Lb(Ob(this),this.injection.viewer,i),"false"===e.default&&(i.label=void 0),super.initTemplate(t);}}class Vb extends ub{constructor(t){super(t),i(this,"uiState","normal"),i(this,"defaultClass",void 0),i(this,"pullDownBox",void 0),i(this,"isFirstClick",!0),i(this,"isRefactorCrop",!1),i(this,"isRefactorAnnotation",!1),i(this,"currentFocusedIndex",-1),this.bindViewerResized(),this.bindPopupSwitchEvent(),this.bindDefaultUi(),this.bindViewerHooks(),this.bindBaseHooks();}bindBaseHooks(){this.hooks.inserted.on((t=>{this.bindEventsEmitter();}));}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{pullDownBox:t}=this;if(!t)return;const e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:Ub(i,this.el,this.pullDownBox);}),this);}bindPullDownBoxEvents(){this.nativeOn(this.el,"click",(()=>{if(this.togglePopup(),this.isFirstClick){Ub(this.injection.viewer.rootDom,this.el,this.pullDownBox),this.isFirstClick=!1;}})),this.nativeOn(this.el,"keydown",(t=>{if(-1===["ArrowUp","ArrowDown"].indexOf(t.key))return;t.stopPropagation(),t.preventDefault();const{children:e}=this.pullDownBox,{length:i}=e;switch(t.key){case"ArrowDown":e[0].focus(),this.currentFocusedIndex=0;break;case"ArrowUp":e[i-1].focus(),this.currentFocusedIndex=i-1;}})),this.nativeOn(this.pullDownBox,"keydown",(t=>{var e,i;if(-1===["ArrowUp","ArrowDown"].indexOf(t.key))return;const{children:s}=this.pullDownBox,{length:n}=s;switch(t.stopPropagation(),t.preventDefault(),t.key){case"ArrowUp":this.currentFocusedIndex-=1,"BUTTON"!==(null===(e=s[this.currentFocusedIndex])||void 0===e?void 0:e.tagName)&&(this.currentFocusedIndex-=1);break;case"ArrowDown":this.currentFocusedIndex+=1,"BUTTON"!==(null===(i=s[this.currentFocusedIndex])||void 0===i?void 0:i.tagName)&&(this.currentFocusedIndex+=1);}this.currentFocusedIndex<0?this.currentFocusedIndex=n-1:this.currentFocusedIndex>n-1&&(this.currentFocusedIndex=0),s[this.currentFocusedIndex].focus();}));}bindPopupSwitchEvent(){Rb(this);}bindDefaultUi(){const t=this.injection.viewer,e=e=>{let i=(_s(null==e?void 0:e.pageCount)?this.injection.viewer.getPageCounts():e.pageCount)?"normal":"disabled";Fb(this,t)&&(i="disabled"),this.isFirstClick=!0,this.setUiState(i);};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}initPullDownBox(){this.hooks.created.on((()=>{this.pullDownBox=this.query(`.${this.defaultClass}-box`),this.pullDownBox.style.display="none",this.pullDownBox.remove(),this.bindPullDownBoxEvents();})),this.hooks.updated.on((()=>{this.uiState="normal",this.pullDownBox.style.display="none",this.isFirstClick=!0;}));}bindViewerHooks(){this.injection.viewer.hooks.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}setUiState(t){_b(this,t);}togglePopup(t){const{pullDownBox:e}=this,{viewer:i}=this.injection;let s="none"===e.style.display;s=_s(t)?!s:!t,s?e.remove():(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e)),Bb(this.el,!s),e.style.display=s?"none":"";}}class zb extends Vb{constructor(t){super(t),i(this,"lastSelectedIndex",0),i(this,"defaultClass","ddv-pdl"),i(this,"pullDownBoxClass","ddv-pull-down"),i(this,"children",[]),i(this,"hasCheckIcon",!1);const{defaultClassName:e,children:s,showCheckIcon:n}=t.data.options;e&&(this.defaultClass=e),this.pullDownBoxClass=`${this.defaultClass}-box ddv-pull-down`,this.children=s,this.hasCheckIcon=n,this.initPullDownBox(),this.initTemplate(),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}getChildrenTemplate(){let t="";return this.children.forEach(((e,i)=>{const{id:s,label:n}=e;e.id=void 0,e.label=void 0,t+=`<${e.type} :options="options.children[${i}]" default="false"id="${s?s+this.injection.viewer.postfix:""}" ><span>${n}</span>`+(this.hasCheckIcon?'<i class="ddv-button-ok" style="visibility: hidden"></i>':"")+`</${e.type}>`;})),t}selectChildren(t){if(!this.hasCheckIcon)return;const{pullDownBox:e}=this;if(-1!==t&&!e.childNodes[t])return;if(-1!==this.lastSelectedIndex){const t=e.children[this.lastSelectedIndex],i=t.getElementsByTagName("i")[0];t.classList.remove("ddv-pull-down-selected"),i.style.visibility="hidden";}if(-1===t)return void(this.lastSelectedIndex=-1);const i=e.children[t],s=i.getElementsByTagName("i")[0];i.classList.add("ddv-pull-down-selected"),s.style.visibility="visible",this.lastSelectedIndex=t;}initTemplate(){const t=this.data;t.options||(t.options={});const{options:e}=this.data,{pullDownBox:i,showDropDownArrow:s}=e;Lb(Ob(this),this.injection.viewer,e);const n=`<button ${pb(e,`ddv-button ${this.defaultClass}`)}>`+(_s(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${pb(i,this.pullDownBoxClass)}>`+`${this.getChildrenTemplate()}</div>`+`<i style="display: ${s?"":"none"}" class="ddv-down-arrow"></i></button>`;this.template=n;}}class $b extends Vb{constructor(t){super(t),i(this,"defaultClass","ddv-pdm"),i(this,"pullDownBoxClass","ddv-pull-down"),i(this,"children",[]);const{defaultClassName:e,children:s,enableScroll:n}=t.data.options;e&&(this.defaultClass=e),this.pullDownBoxClass=`${this.defaultClass}-box ddv-pull-down`,n&&(this.pullDownBoxClass+=$s()?" ddv-custom-scroll-hidden":" ddv-custom-scroll"),this.children=s,this.initPullDownBox(),this.initTemplate();}getChildrenTemplate(){let t="";return this.children.forEach(((e,i)=>{t+=`<${e.type} :options="options.children[${i}]" menu="true"></${e.type}>`;})),t}initTemplate(){const t=this.data;t.options||(t.options={});const{options:e}=this.data,{pullDownBox:i,showDropDownArrow:s}=e;Lb(Ob(this),this.injection.viewer,e);const n=`<button ${pb(e,`ddv-button ${this.defaultClass}`)}>`+(_s(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${pb(i,this.pullDownBoxClass)}>`+`${this.getChildrenTemplate()}</div>`+`<i style="display: ${s?"":"none"}" class="ddv-down-arrow"></i></button>`;this.template=n;}}class jb extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;$s()&&this.el.classList.contains("ddv-button-focused")?t.updateViewerConfig({toolMode:"pan"}):(t.updateViewerConfig({toolMode:"annotation",annotationMode:e.annotationMode}),"stamp"===e.annotationMode&&t.updateAnnotationConfig({defaultStyleConfig:{stamp:{imageData:null,stampConfig:null}}}));}}),i(this,"annotationMode",void 0),this.annotationMode=e.annotationMode;}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ap.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig();t.getPageCounts()?"annotation"!==e?this.setUiState("normal"):i===this.annotationMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class Xb extends jb{constructor(t){super(t,{class:"ddv-ellipse",annotationMode:"ellipse"});}}i(Xb,"cpName","EllipseAnnotation");class Gb extends jb{constructor(t){super(t,{class:"ddv-annot-eraser",annotationMode:"erase"});}}i(Gb,"cpName","EraseAnnotation");class Yb extends jb{constructor(t){super(t,{class:"ddv-ink",annotationMode:"ink"});}}i(Yb,"cpName","InkAnnotation");class qb extends jb{constructor(t){super(t,{class:"ddv-line",annotationMode:"line"});}}i(qb,"cpName","LineAnnotation");class Jb extends jb{constructor(t){super(t,{class:"ddv-polygon",annotationMode:"polygon"});}}i(Jb,"cpName","PolygonAnnotation");class Zb extends jb{constructor(t){super(t,{class:"ddv-polyline",annotationMode:"polyline"});}}i(Zb,"cpName","PolylineAnnotation");class Qb extends jb{constructor(t){super(t,{class:"ddv-rect",annotationMode:"rectangle"});}}i(Qb,"cpName","RectAnnotation");class Kb extends jb{constructor(t){super(t,{class:"ddv-annot-select",annotationMode:"select"});}}i(Kb,"cpName","SelectAnnotation");class tS extends jb{constructor(t){super(t,{class:"ddv-stamp-icon",annotationMode:"stamp"});}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ap.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig(),s=t.getPageCounts(),{defaultStyleConfig:n}=t.getAnnotationConfig(),{stamp:o}=n,r=null==o?void 0:o.imageData;s?"annotation"!==e||"stamp"!==i||r?this.setUiState("normal"):this.setUiState("focused"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),t.hooks.annotationDefaultStyleChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(tS,"cpName","StampIconAnnotation");class eS extends Hb{constructor(t){super(t,{class:"ddv-stamp-image",callback:()=>{this.annotationImageLoader.value=null,delete this.annotationImageLoader.files,$s()&&this.el.classList.contains("ddv-button-focused")?this.injection.viewer.updateViewerConfig({toolMode:"pan"}):(this.injection.viewer.updateViewerConfig({toolMode:"pan"}),this.injection.viewer.selectAnnotations([]),this.annotationImageLoader.click());}}),i(this,"annotationImageLoader",void 0);}createAnnotationImageLoaderInput(){const t=document.createElement("input");return t.accept="image/png,image/jpeg,image/bmp",t.type="file",this.nativeOn(t,"change",(()=>{const{files:e}=t,i=new Blob([e[0]],{type:e[0].type});["image/png","image/jpeg","image/bmp"].includes(e[0].type)&&(this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{imageData:i}}}),t.value=null,t.files=null,this.injection.viewer.updateViewerConfig({toolMode:"annotation",annotationMode:"stamp"}));})),t}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindHooks(){super.bindHooks(),this.hooks.inserted.on((()=>{const t=this.createAnnotationImageLoaderInput();t.style.display="none",this.el.appendChild(t),this.annotationImageLoader=t,this.nativeOn(t,"click",(t=>{t.stopPropagation();}));}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{if(!Ap.annotationLicenseModuleIsExist())return void this.setUiState("disabled");const{toolMode:e,annotationMode:i}=t.getViewerConfig(),s=t.getPageCounts(),{defaultStyleConfig:n}=t.getAnnotationConfig(),{stamp:o}=n,r=null==o?void 0:o.imageData;s?"annotation"!==e?this.setUiState("normal"):"stamp"===i&&r?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this),t.hooks.annotationDefaultStyleChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(eS,"cpName","StampImageAnnotation");class iS extends jb{constructor(t){super(t,{class:"ddv-text-box",annotationMode:"textBox"});}}i(iS,"cpName","TextBoxAnnotation");class sS extends jb{constructor(t){super(t,{class:"ddv-typewriter",annotationMode:"textTypewriter"});}}i(sS,"cpName","TextTypewriterAnnotation");class nS extends jb{constructor(t){super(t,{class:"ddv-highlight-mode",annotationMode:"highlight"});}}i(nS,"cpName","HighlightAnnotation");class oS extends jb{constructor(t){super(t,{class:"ddv-underline-mode",annotationMode:"underline"});}}i(oS,"cpName","UnderlineAnnotation");class rS extends jb{constructor(t){super(t,{class:"ddv-strikeout-mode",annotationMode:"strikeout"});}}i(rS,"cpName","StrikeoutAnnotation");class aS extends $b{constructor(t){const{AnnotationSet:e}=eP.getDisplayTextConfig(),i=t.data;i.options={children:[{type:"SelectAnnotation"},{type:"EraseAnnotation"},{type:"SeparatorLine"},{type:"HighlightAnnotation"},{type:"UnderlineAnnotation"},{type:"StrikeoutAnnotation"},{type:"TextTypewriterAnnotation"},{type:"TextBoxAnnotation"},{type:"SeparatorLine"},{type:"StampIconAnnotation"},{type:"StampImageAnnotation"},{type:"SeparatorLine"},{type:"InkAnnotation"},{type:"RectAnnotation"},{type:"EllipseAnnotation"},{type:"PolygonAnnotation"},{type:"PolylineAnnotation"},{type:"LineAnnotation"},{type:"SeparatorLine"},{type:"BringForward"},{type:"BringToFront"},{type:"SendBackward"},{type:"SendToBack"}],defaultClassName:"ddv-annotation-mode",label:e,enableScroll:!0,showDropDownArrow:!0,...i.options},super(t),this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts()||0;(t||i)&&Ap.annotationLicenseModuleIsExist()&&Ib(this.el,t);}));}bindDefaultUi(){Ap.annotationLicenseModuleIsExist()?(super.bindDefaultUi(),this.hooks.inserted.on((t=>{const{toolMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getPageCounts();"annotation"===e&&i>0&&this.setUiState("focused");}))):this.hooks.inserted.on((t=>{this.setUiState("disabled");}));}togglePopup(t){if((!0!==t||""!==this.pullDownBox.style.display)&&(!1!==t||"none"!==this.pullDownBox.style.display)&&(super.togglePopup(t),""===this.pullDownBox.style.display&&lS(this.pullDownBox).horizontal)){this.pullDownBox.style.justifyContent="start";let t=0;for(let e=0;e<this.pullDownBox.children.length;e++){const i=this.pullDownBox.children[e];i.classList.contains("ddv-button-focused")&&(t=i.offsetLeft+i.clientWidth/2-this.pullDownBox.clientWidth/2);}this.pullDownBox.scroll(t,0);}}bindPopupSwitchEvent(){this.$on("ui_hidePopup",(t=>{if(t===this||"viewer"===t||t===aS.cpName)return;const{toolMode:e}=this.injection.viewer.getViewerConfig();"annotation"!==e&&this.togglePopup(!1);}));}bindViewerHooks(){if(!Ap.annotationLicenseModuleIsExist())return;const t=this.injection.viewer;t.hooks.resize.on((()=>{lS(this.pullDownBox).horizontal?this.pullDownBox.style.justifyContent="start":this.pullDownBox.style.justifyContent="";}),this),t.hooks.pageExistenceChanged.on((()=>{const{toolMode:e}=t.getViewerConfig();let i="disabled";t.getPageCounts()>0?(i="crop"===t.getViewerConfig().toolMode?"disabled":"normal","annotation"===e&&(this.isFirstClick?(this.togglePopup(!1),this.el.click()):this.togglePopup(!0),i="focused")):this.togglePopup(!1),this.setUiState(i);}),this),t.hooks.toolModeChanged.on((e=>{const i="crop"===e.newToolMode,s="annotation"===e.newToolMode;if(i)return this.togglePopup(!1),void this.setUiState("disabled");t.getPageCounts()>0&&(this.setUiState(s?"focused":"normal"),Bb(this.el,"none"!==this.pullDownBox.style.display),this.$emit("ui_annotationModeClick",s),s&&(this.isFirstClick?(this.togglePopup(!1),this.el.click()):this.togglePopup(!0)));}),this);}setUiState(t){super.setUiState(t);}}function lS(t){return {vertical:t.scrollHeight>t.clientHeight,horizontal:t.scrollWidth>t.clientWidth}}i(aS,"cpName","AnnotationSet");class hS extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection,e=t.getSelectedAnnotations();if(1!==e.length)return;const i=e[0].uid;switch(this.layerType){case"bringForward":t.bringForward(i);break;case"bringToFront":t.bringToFront(i);break;case"sendBackward":t.sendBackward(i);break;case"sendToBack":t.sendToBack(i);}}}),i(this,"layerType",void 0),this.layerType=e.layerType;}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindDefaultUi(){const t=this.injection.viewer,e=Ap.annotationLicenseModuleIsExist(),i=()=>{if(!e)return void this.setUiState("disabled");const{viewer:i}=this.injection,s=i.getSelectedAnnotations();t.getPageCounts()&&1===s.length?this.setUiState("normal"):this.setUiState("disabled");};t.hooks.annotationLayerStateChanged.on((i=>{let{state:s}=i;if(!e)return void this.setUiState("disabled");const n=t.getSelectedAnnotations();if(!n.length||n.length>1)return void this.setUiState("disabled");const o=t.getAnnotationObject(n[0].uid);if(o&&!o.context.isActive)return void this.setUiState("disabled");let r=!1;switch(this.layerType){case"bringForward":r=s.forward;break;case"bringToFront":r=s.front;break;case"sendBackward":r=s.backward;break;case"sendToBack":r=s.back;}this.setUiState(r?"normal":"disabled");}),this),t.hooks.pageExistenceChanged.on(i,this),this.hooks.inserted.on(i),this.hooks.updated.on(i);}}class cS extends hS{constructor(t){super(t,{class:"ddv-bring-forward",layerType:"bringForward"});}}i(cS,"cpName","BringForward");class dS extends hS{constructor(t){super(t,{class:"ddv-bring-to-front",layerType:"bringToFront"});}}i(dS,"cpName","BringToFront");class uS extends hS{constructor(t){super(t,{class:"ddv-send-backward",layerType:"sendBackward"});}}i(uS,"cpName","SendBackward");class pS extends hS{constructor(t){super(t,{class:"ddv-send-to-back",layerType:"sendToBack"});}}i(pS,"cpName","SendToBack");class gS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-annotation-toolbar"),i(this,"lastAnnotation",void 0),i(this,"toolbarOffset",20),i(this,"toolbarType",void 0),i(this,"lastScrollTop",0),i(this,"lastScrollLeft",0),i(this,"updateToolBarPosition",(()=>{if("text"===this.toolbarType)return void this.togglePopup(!1);if(!this.lastAnnotation)return;const{viewer:t}=this.injection,e=t.getActiveTab();if(e&&"single"===e.context.displayMode&&this.lastAnnotation.pageUid!==e.getCurrentPage().uid)return;const i=e.childNodes.find((t=>t.uid===this.lastAnnotation.pageUid));if(!i)return void this.togglePopup(!1);this.setToolbarType("annotation");const{show:s,x:n,y:o}=fS(t.context.viewService.mainContainer,this.lastAnnotation,this.el,this.toolbarOffset);this.togglePopup(s,n,o);})),this.bindHooks(),this.initTemplate(),this.bindViewerHooks(),this.$on("ui_toolbarToggle",(()=>{this.togglePopup();}));}bindHooks(){const t=t=>{this.el.style.display="none",this.setToolbarType("annotation");};this.hooks.inserted.on(t),this.hooks.updated.on(t),this.hooks.destroyed.on((()=>{this.el.remove();}));}bindViewerHooks(){const{viewer:t}=this.injection;t.hooks.visibleChanged.on((()=>{this.togglePopup(!1);}),this),t.hooks.pageExistenceChanged.on((t=>{0===t.pageCount&&(this.togglePopup(!1),this.lastAnnotation=null);}),this),t.hooks.pageChanged.on((()=>{const e=t.getActiveTab();if(!e||"single"!==e.context.displayMode)return;const i=t.getSelectedAnnotations();if(1!==i.length)return;const s=i[0].pageUid===e.getCurrentPage().uid;this.togglePopup(s);}),this),t.hooks.resize.on(this.updateToolBarPosition,this),t.hooks.scroll.on((t=>{if("text"===this.toolbarType&&"none"!==this.el.style.display){const{scrollTop:e,scrollLeft:i}=t.target;if(Math.abs(this.lastScrollTop-e)<=10&&Math.abs(this.lastScrollLeft-i)<=10)return;this.lastScrollTop=e,this.lastScrollLeft=i;}this.updateToolBarPosition();}),this),t.hooks.fitModeChanged.on(this.updateToolBarPosition,this),t.hooks.displayModeChanged.on(this.updateToolBarPosition,this),t.hooks.zoomChanged.on(this.updateToolBarPosition,this),this.bindViewerAnnotationHooks(),this.bindViewerTextSelectedHooks();}bindViewerAnnotationHooks(){const{viewer:t}=this.injection;if(t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return this.togglePopup(!1),void(this.lastAnnotation=null);const i=e.newAnnotationUids[0],s=t.getAnnotationObject(i);if(!s)return;this.setToolbarType("annotation");const{show:n,x:o,y:r}=fS(t.context.viewService.mainContainer,s,this.el,this.toolbarOffset);this.togglePopup(n,o,r),this.lastAnnotation=s;}),this),t.hooks.beforeAnnotationEdit.on((()=>{this.togglePopup(!1);}),this),t.hooks.afterAnnotationEdit.on((e=>{if(e instanceof Ph)return;this.setToolbarType("annotation");const{show:i,x:s,y:n}=fS(t.context.viewService.mainContainer,e,this.el,this.toolbarOffset);this.lastAnnotation=e,this.togglePopup(i,s,n);}),this),t.hooks.annotationsUpdated.on((t=>{this.lastAnnotation instanceof Ch&&"freeTextWriter"===this.lastAnnotation.textType?setTimeout((()=>{this.updateToolBarPosition();}),16):this.updateToolBarPosition();}),this),t.hooks.annotationTextContentUpdated.on(this.updateToolBarPosition,this),null!=t&&t.annotationViewerContext){const{annotationViewerContext:e}=t,{hooks:i}=e.annotationController;i.enableAnnotationTextEditMode.on(this.updateToolBarPosition,this),i.disableAnnotationTextEditMode.on(this.updateToolBarPosition,this);}}bindViewerTextSelectedHooks(){const{viewer:t}=this.injection;t.hooks.textSelected.on((e=>{const i=t.context.textSelectionService.getTextSelectionControlPointsRect();if(i.length){const s=t.getActiveTab();let n=[i[1],i[0]];if(1===e.detail.length){180===s.getPageByUid(e.detail[0].pageUid).getRotation()&&(n=[i[0],i[1]]);}this.setToolbarType("text");const{show:o,x:r,y:a}=function(t,e,i,s){i.style.display="flex";const{width:n,height:o}=t.getBoundingClientRect(),r=getComputedStyle(i),a=Cr(r.width).value,l=Cr(r.height).value;i.style.display="none";const h=(t,e)=>{if(t<0){if(t<-a/2)return null;t=0;}else if(t+a>n){if(t+a>n+a/2)return null;t=n-a;}if(e<0){if(e<-l/2)return null;e=0;}else if(e+l>o){if(e+l>o+l/2)return null;e=o-l;}return {x:t,y:e}},c=t=>({left:t.left+t.width/2-a/2,topInTop:t.top-s-l,topInBottom:t.top+t.height+s});if(e[0]){const{left:t,topInBottom:i,topInTop:s}=c(e[0]),n=h(t,i);if(n)return {show:!0,x:n.x,y:n.y};const o=h(t,s);if(o)return {show:!0,x:o.x,y:o.y}}if(e[1]){const{left:t,topInBottom:i,topInTop:s}=c(e[1]),n=h(t,i);if(n)return {show:!0,x:n.x,y:n.y};const o=h(t,s);if(o)return {show:!0,x:o.x,y:o.y}}return {show:!1}}(t.context.viewService.mainContainer,n,this.el,this.toolbarOffset);o&&(this.lastScrollTop=t.context.viewService.scrollContainer.scrollTop,this.lastScrollLeft=t.context.viewService.scrollContainer.scrollLeft),this.togglePopup(o,r,a);}else "text"===this.toolbarType&&this.togglePopup(!1);}),this),t.hooks.beforeTextSelected.on((()=>{this.togglePopup(!1);}),this);}togglePopup(t,e,i){const{viewer:s}=this.injection;if(!t)return void(this.el.style.display="none");s.context.viewService.mainContainer.appendChild(this.el),this.el.style.display="",this.el.style.left=`${e||0}px`,this.el.style.top=`${i||0}px`;}setToolbarType(t){var e,i,s,n,o,r;const{options:a}=this.data;this.toolbarType=t;const l={highlight:this.el.querySelector(".ddv-highlight-mode"),strikeout:this.el.querySelector(".ddv-strikeout-mode"),underline:this.el.querySelector(".ddv-underline-mode"),copyText:this.el.querySelector(".ddv-copy-text"),palette:this.el.querySelector(".ddv-palette"),delete:this.el.querySelector(".ddv-delete-annot")},h={highlight:"none"===(null===(e=a.highlightButton)||void 0===e||null===(e=e.style)||void 0===e?void 0:e.display),strikeout:"none"===(null===(i=a.strikeoutButton)||void 0===i||null===(i=i.style)||void 0===i?void 0:i.display),underline:"none"===(null===(s=a.underlineButton)||void 0===s||null===(s=s.style)||void 0===s?void 0:s.display),copyText:"none"===(null===(n=a.copyButton)||void 0===n||null===(n=n.style)||void 0===n?void 0:n.display),palette:"none"===(null===(o=a.paletteButton)||void 0===o||null===(o=o.style)||void 0===o?void 0:o.display),delete:"none"===(null===(r=a.deleteButton)||void 0===r||null===(r=r.style)||void 0===r?void 0:r.display)};["copyText","highlight","strikeout","underline"].forEach((e=>{!h[e]&&l[e]&&(l[e].style.display="text"===t?"":"none");})),["palette","delete"].forEach((e=>{!h[e]&&l[e]&&(l[e].style.display="annotation"===t?"":"none");})),this.toolbarOffset="text"===t?10:20;}initTemplate(){const{options:t}=this.data;Lb(Ob(this),this.injection.viewer,t);let e=`<div ${pb(t,this.defaultClass,"")}>`;null!=t&&t.isPaletteEnabled&&(e+='<AnnotationPaletteButton :options="options.paletteButton"></AnnotationPaletteButton>'),e+='<TextCopyButton :options="options.copyButton"></TextCopyButton>',e+='<HighlightCreateButton :options="options.highlightButton"></HighlightCreateButton>',e+='<UnderlineCreateButton :options="options.underlineButton"></UnderlineCreateButton>',e+='<StrikeoutCreateButton :options="options.strikeoutButton"></StrikeoutCreateButton>',e+='<AnnotationDeleteButton :options="options.deleteButton"></AnnotationDeleteButton></div>',this.template=e;}}function fS(t,e,i,s){i.style.display="flex";const{width:n,height:o}=t.getBoundingClientRect(),r=e.context.getRealTimeBoundingBox(),a=getComputedStyle(i),l=Cr(a.width).value,h=Cr(a.height).value;if(i.style.display="none",r.right<0||r.left>n||r.top>o||r.bottom<0)return {show:!1,x:0,y:0};const c=r.left+r.width/2-l/2;let d=r.bottom+s;return d+h>o&&(d=r.top-h-s),d<0&&(d=0),{show:!0,x:c,y:d}}i(gS,"cpName","AnnotationToolBar");class vS extends Hb{constructor(t){super(t,{class:"ddv-palette",callback:()=>{this.$emit("ui_changePalette_visible","AnnotationPalette");}}),Eb(this);}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet"),this.focusTexture();}));}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.focusTexture();}}}i(vS,"cpName","AnnotationPaletteButton");class mS extends Hb{constructor(t){super(t,{class:"ddv-delete-annot",callback:()=>{const{viewer:t}=this.injection,e=t.getSelectedAnnotations(),i=[];e.forEach((t=>{i.push(t.uid);})),t.deleteAnnotations(i);}}),Eb(this);}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{viewer:e}=this.injection,i=e.getSelectedAnnotations();t.getPageCounts()&&i.length?this.setUiState("normal"):this.setUiState("disabled");};t.hooks.selectedAnnotationsChanged.on(e,this),t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(mS,"cpName","AnnotationDeleteButton");class yS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-color-panel"),i(this,"colorList",void 0),i(this,"enableChangeColor",void 0),i(this,"paletteType",void 0),i(this,"colorInput",void 0),i(this,"selectedColorButton",void 0),i(this,"lastUpdatedAnnotation",void 0),i(this,"lastInputColor",void 0),i(this,"lastTextContents",void 0),i(this,"lastPaletteType",void 0),i(this,"dblClickButtons",[]),this.colorList=t.data.colorList,this.enableChangeColor=t.data.enableChangeColor,this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stamp"===t?"none":"",this.paletteType=t,this.showNoFill("fill"===t),this.updateButtonSelected();}));}bindHooks(){this.hooks.inserted.on((()=>{const t=document.createElement("input");t.type="color",this.colorInput=t,this.el.appendChild(this.colorInput),this.bindEvents(),this.bindColorInputEvents();}));}bindEvents(){const t=this.el.querySelector(".ddv-palette-color-grid");this.nativeOn(t,"click",(t=>{const e=t.target;if(!(e instanceof HTMLButtonElement))return;this.dblClickButtons.push(e),this.dblClickButtons.length>2&&this.dblClickButtons.shift();if(e.classList.contains("ddv-color-selected"))return;const i=e.value,{viewer:s}=this.injection;if(""===i)this.colorInput.focus(),this.colorInput.click(),this.selectedColorButton=e;else {const t=s.getSelectedAnnotations();1===t.length&&this.updateColorByData(t[0],i),this.updateDefaultColor(i);}})),this.nativeOn(t,"dblclick",(t=>{if(!this.enableChangeColor)return;const e=t.target;if(!(e instanceof HTMLButtonElement))return;if(2===this.dblClickButtons.length&&this.dblClickButtons[0]!==this.dblClickButtons[1])return;const i=e.value;"transparent"!==i&&""!==i&&(this.colorInput.value=i,$s()&&this.colorInput.focus(),this.colorInput.click(),this.selectedColorButton=e);}));}bindColorInputEvents(){this.nativeOn(this.colorInput,"input",(t=>{Ab((()=>{const{viewer:t}=this.injection,e=this.colorInput.value;this.selectedColorButton.classList.contains("ddv-add-color")&&this.addColor();this.selectedColorButton.children[0].style.background=e,this.selectedColorButton.value=e;1===t.getSelectedAnnotations().length&&this.updateColorByShape(e),this.updateDefaultColor(e),this.selectedColor(e);}),60);})),this.nativeOn(this.colorInput,"change",(t=>{this.lastUpdatedAnnotation&&(this.updateColorByData(this.lastUpdatedAnnotation,this.lastInputColor,this.lastPaletteType),this.lastUpdatedAnnotation=null,this.lastInputColor=null,this.lastPaletteType=null);}));}bindViewerHooks(){const t=this.injection.viewer;t.hooks.selectedAnnotationsChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationsUpdated.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationModeChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{this.updateButtonSelected();}),this),t.hooks.annotationTextCharsSelected.on((t=>{const e=t.freeTextContentStyle,{color:i}=e;"text"===this.paletteType?this.selectedColor(i):this.updateButtonSelected();}),this);}updateColorByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid),s=i instanceof Yh,n=i instanceof Ch;if("fill"===this.paletteType||"textAssist"===this.paletteType&&s)i.style.background=t;else if(["stroke","textAssist"].includes(this.paletteType))i.style.borderColor=t;else if("text"===this.paletteType&&n){if(i.hasSelectedChars){const e=nh(i,{color:t});i.style.textContents=e,i.textEditEventHandler.updateTextSelection();}else {if(i.isEditMode)return void this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[e[0].type]:{textContent:{color:t}}}});{const e=sh(i,{color:t});e.length&&(i.style.textContents=e);}}this.lastTextContents=i.style.textContents;}this.lastUpdatedAnnotation=e[0],this.lastInputColor=t,this.lastPaletteType=this.paletteType,this.injection.viewer.context.render(93);}updateColorByData(t,e,i){const{viewer:s}=this.injection,{uid:n}=t,o={},r=this.injection.viewer.getAnnotationObject(n),a=i||this.paletteType;if("text"===a&&r instanceof Ch){const{hasSelectedChars:i}=r;if(i){const t=nh(r,{color:e});o.textContents=t;}else {if(r.isEditMode)return void this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[t.type]:{textContent:{color:e}}}});{const t=sh(r,{color:e});t.length&&(o.textContents=t);}}return this.lastTextContents&&(o.textContents=this.lastTextContents,this.lastTextContents=null),s.updateAnnotation(n,{style:o},["appearanceChanged"]),void(r.hasSelectedChars&&r.textEditEventHandler.updateTextSelection())}"fill"===a?o.background="transparent"===e?"":e:"stroke"===a?o.borderColor=e:"textAssist"===a&&(r instanceof Yh?o.background=e:o.borderColor=e),s.updateAnnotation(n,{style:o},["appearanceChanged"]);}updateDefaultColor(t,e){const{annotationMode:i}=this.injection.viewer.getViewerConfig(),s=this.injection.viewer.getSelectedAnnotations();let n=i;s.length&&s[0]&&(n=s[0].type);const o={};switch(e||this.paletteType){case"fill":o.background=t;break;case"textAssist":"highlight"===n?o.background=t:o.borderColor=t;break;case"stroke":o.borderColor=t;break;case"text":o.textContent={},o.textContent.color=t;}this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:o}});}selectedColor(t){const e=this.el.querySelector(".ddv-palette-color-grid").getElementsByTagName("button");for(let i=0;i<e.length;i++){const s=e[i];if(!s.value)continue;const n=Br(s.value),o=Br(t);n.formatted===o.formatted?s.classList.add("ddv-color-selected"):s.classList.contains("ddv-color-selected")&&s.classList.remove("ddv-color-selected");}}updateButtonSelected(){const{viewer:t}=this.injection,e=t.getSelectedAnnotations();if(1===e.length){let s=null;const n="highlight"===e[0].type;if("fill"===this.paletteType||"textAssist"===this.paletteType&&n)s=e[0].style.background||"transparent";else if(["stroke","textAssist"].includes(this.paletteType))s=e[0].style.borderColor||"transparent";else if("text"===this.paletteType){const n=t.getAnnotationObject(e[0].uid);var i;if(n instanceof Ch)s=(null===(i=e[0].style)||void 0===i||null===(i=i.textContents[0])||void 0===i?void 0:i.color)||"transparent";n instanceof Ch&&(n.isEditMode||!n.style.textContents.length)&&(s=n.freeTextContentStyle.color);}return void(s&&this.selectedColor(s))}const{toolMode:s,annotationMode:n}=t.getViewerConfig();if("annotation"===s&&"select"!==n&&"erase"!==n){const{defaultStyleConfig:e}=t.getAnnotationConfig(),{background:i,borderColor:s,textContent:l}=hh,h="highlight"===n;let c=null;var o;if("fill"===this.paletteType||"textAssist"===this.paletteType&&h)c=(null===(o=e[n])||void 0===o?void 0:o.background)||i||"transparent";else if("stroke"===this.paletteType||"textAssist"===this.paletteType){var r;c=(null===(r=e[n])||void 0===r?void 0:r.borderColor)||s||"transparent";}else if("text"===this.paletteType){var a;c=(null===(a=e[n])||void 0===a||null===(a=a.textContent)||void 0===a?void 0:a.color)||(null==l?void 0:l.color)||"transparent";}c&&this.selectedColor(c);}}getColorTemplate(){const t=document.createElement("div");let e="<div>",i=0;for(let s=0;s<this.colorList.length;s++){const n=this.colorList[s];if(t.style.background=n,""!==t.style.background){if(i>26)break;i+=1,e+=`<button value="${n}"><div style="background:${n}"></div></button>`,0!==i&&i%7==0&&(e+="</div><div>"),t.style.background="";}}const s=i>26?0:27-i;for(let t=0;t<s;t++)e+=0===t?'<button value="" class="ddv-add-color"><div></div></button>':'<button value="" class="ddv-color-placeholder"><div></div></button>',(i+t+1)%7==0&&(e+="</div><div>");return e+='<button value="transparent" class="ddv-color-transparent"><div></div></button>',e+="</div>",t.remove(),e}showNoFill(t){this.el.querySelectorAll(".ddv-color-transparent").forEach((e=>{e.style.visibility=t?"":"hidden",e.style.pointerEvents=t?"":"none";}));}addColor(){const t=this.el.querySelector(".ddv-palette-color-grid"),e=t.querySelector(".ddv-add-color"),i=t.querySelector(".ddv-color-placeholder");e&&e.classList.remove("ddv-add-color"),i&&(i.classList.remove("ddv-color-placeholder"),i.classList.add("ddv-add-color"));}initTemplate(){const t=`<div class="${this.defaultClass}"><div class="ddv-palette-color-grid">${this.getColorTemplate()}</div></div>`;this.template=t;}}const xS=Bo.displayResolution/Bo.dataResolution;class wS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-font-panel"),i(this,"fontFamilyEl",void 0),i(this,"fontSizeEl",void 0),i(this,"fontList",[...Tb]),i(this,"inputIsBlur",!0),i(this,"currentFontSizeValue",void 0),i(this,"isArrowKeyPressed",!1),i(this,"maxFontSize",72),this.maxFontSize=t.data.maxFontSize,this.maxFontSize<72&&(this.maxFontSize=72),this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_shrinkSelectionBox",(t=>{"fontFamily"!==t&&this.toggleSelect("fontFamily",!1),"fontSize"!==t&&this.toggleSelect("fontSize",!1);})),this.$on("ui_changePalette_type",(t=>{this.el.style.display="text"===t?"":"none";})),this.$on("ui_addFont",(t=>{this.addFont(t);}));}updateTextStyle(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const{toolMode:i,annotationMode:s}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations();if(1!==n.length||"textTypewriter"!==n[0].type&&"textBox"!==n[0].type)"annotation"!==i||"textBox"!==s&&"textTypewriter"!==s||this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[s]:{textContent:t}}});else {const{uid:e,type:i}=n[0],s=this.injection.viewer.getAnnotationObject(e);if(s.isEditMode)s.hasSelectedChars&&(this.injection.viewer.updateAnnotation(e,{style:{textContents:nh(s,t)}},["appearanceChanged"]),s.textEditEventHandler.updateTextSelection());else {const i=sh(s,t);i.length&&this.injection.viewer.updateAnnotation(e,{style:{textContents:i}},["appearanceChanged"]);}this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[i]:{textContent:t}}});}e&&this.focusTexture();}bindHooks(){this.hooks.created.on((()=>{this.fontFamilyEl=this.el.querySelector(".ddv-palette-font-family"),this.fontSizeEl=this.el.querySelector(".ddv-palette-font-size");})),this.hooks.inserted.on((()=>{this.bindToggleEvent(),this.bindSelectEvent(),this.bindFontSizeInputEvent(),this.bindTextAlignEvents(),this.bineFontStyleEvents();}));}bindToggleEvent(){const t=this.fontSizeEl.querySelector(".ddv-down-arrow");eo(this.fontFamilyEl,"click",this).on((t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","fontFamily"),this.toggleSelect("fontFamily");}),this),eo(t,"click",this).on((t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","fontSize"),this.toggleSelect("fontSize");}),this);}bindSelectEvent(){const t=this.fontFamilyEl.querySelector(".ddv-palette-font-family-select"),e=this.fontSizeEl.querySelector(".ddv-palette-font-size-select"),i=this.fontSizeEl.getElementsByTagName("input")[0],s=this.fontFamilyEl.getElementsByTagName("span")[0];this.nativeOn(t,"click",(t=>{t.stopPropagation(),this.toggleSelect("fontFamily",!1);const e=t.target.value;e&&s.innerText!==e&&this.updateTextStyle({fontFamily:e});})),this.nativeOn(e,"click",(t=>{t.stopPropagation(),this.toggleSelect("fontSize",!1);const e=t.target.value,s=`${e}pt`===i.value;e&&!s&&this.updateTextStyle({fontSize:Cr(e).value*xS});}));}bindFontSizeInputEvent(){const t=this.fontSizeEl.getElementsByTagName("input")[0];this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){let e=Math.round(Cr(t.value).value);e>this.maxFontSize&&(e=this.maxFontSize,t.value=`${this.maxFontSize}`),e<1&&(e=1,t.value="1"),this.updateTextStyle({fontSize:e*xS},!1),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(()=>{const e=t.value,i=Cr(e).value;t.value=i,t.type="number",this.inputIsBlur=!1,this.currentFontSizeValue=i,this.$emit("ui_shrinkSelectionBox");})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,"text"!==t.type&&(this.currentFontSizeValue=t.value,t.type="text",t.value+="pt",e.relatedTarget instanceof HTMLInputElement||this.focusTexture());}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="pt",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);let i=Math.round(Cr(t.value).value);i>this.maxFontSize&&(i=this.maxFontSize),i<1&&(i=1),this.updateTextStyle({fontSize:i*xS});};this.nativeOn(t,"change",e);}bindTextAlignEvents(){const t=this.el.querySelector(".ddv-align-left"),e=this.el.querySelector(".ddv-align-center"),i=this.el.querySelector(".ddv-align-right"),s=this.el.querySelector(".ddv-justify-center"),n=t=>{const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig(),s=this.injection.viewer.getSelectedAnnotations();if(1!==s.length||"textTypewriter"!==s[0].type&&"textBox"!==s[0].type)"annotation"!==e||"textBox"!==i&&"textTypewriter"!==i||this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[i]:{textAlign:t}}});else {if(t===s[0].style.textAlign)return;this.injection.viewer.updateAnnotation(s[0].uid,{style:{textAlign:t}},["appearanceChanged"]);}};this.nativeOn(t,"click",(()=>{n("left");})),this.nativeOn(e,"click",(()=>{n("center");})),this.nativeOn(i,"click",(()=>{n("right");})),this.nativeOn(s,"click",(()=>{n("justify");}));}bineFontStyleEvents(){const t=this.el.querySelector(".ddv-bold"),e=this.el.querySelector(".ddv-italic"),i=this.el.querySelector(".ddv-underline"),s=this.el.querySelector(".ddv-line-through");this.nativeOn(t,"click",(e=>{this.updateTextStyle({fontWeight:t.classList.contains("ddv-button-activated-light")?"normal":"bold"});})),this.nativeOn(e,"click",(t=>{this.updateTextStyle({fontStyle:e.classList.contains("ddv-button-activated-light")?"normal":"italic"});})),this.nativeOn(i,"click",(t=>{this.updateTextStyle({underline:!i.classList.contains("ddv-button-activated-light")});})),this.nativeOn(s,"click",(t=>{this.updateTextStyle({lineThrough:!s.classList.contains("ddv-button-activated-light")});}));}bindViewerHooks(){const{viewer:t}=this.injection;t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];if("textTypewriter"!==i.type&&"textBox"!==i.type)return;this.showTextAlignList("textBox"===i.type),this.selectTextAlign(i.style.textAlign||"left");const{defaultStyleConfig:s}=this.injection.viewer.getAnnotationConfig(),{textContent:n}=s[i.type],o=i.style.textContents.length?i.style.textContents[0]:n,{fontFamily:r,fontSize:a,fontWeight:l,fontStyle:h,underline:c,lineThrough:d}=o;this.selectFontStyle(r,Math.round(Cr(a).value/xS),"bold"===l,"italic"===h,c,d);}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{const{toolMode:t,annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let s,n,o=!1;if("annotation"!==t||"textBox"!==e&&"textTypewriter"!==e||(o=!0,s=e),1===i.length){const t=this.injection.viewer.getAnnotationObject(i[0].uid);t instanceof Ch&&(s=i[0].type,n=i[0].style.textAlign,t.isEditMode&&!t.hasSelectedChars?o=!0:t.isEditMode||t.style.textContents.length?(this.selectTextAlign(n),o=!1):o=!0);}if(!o)return;const{defaultStyleConfig:r}=this.injection.viewer.getAnnotationConfig(),{textAlign:a}=r[s],{fontFamily:l,fontSize:h,fontWeight:c,fontStyle:d,underline:u,lineThrough:p}=r[s].textContent||{},{textContent:g}=hh;this.selectTextAlign(n||a||hh.textAlign),this.selectFontStyle(l||g.fontFamily,Math.round(Cr(h||g.fontSize).value/xS),"bold"===(c||g.fontWeight),"italic"===(d||g.fontStyle),u||g.underline,p||g.lineThrough);}),this),t.hooks.annotationTextCharsSelected.on((t=>{const e=t.freeTextContentStyle,{fontFamily:i,fontSize:s,fontStyle:n,fontWeight:o,underline:r,lineThrough:a}=e;this.selectFontStyle(i,Math.round(Cr(s).value/xS),"bold"===o,"italic"===n,r,a);}),this),t.hooks.annotationsUpdated.on((t=>{const{actions:e,uids:i}=t,s=this.injection.viewer.getSelectedAnnotations();if(1!==s.length||!i.includes(s[0].uid))return;if("textTypewriter"!==s[0].type&&"textBox"!==s[0].type)return;if(!e.includes("appearanceChanged")&&!e.includes("contentChanged"))return;this.selectTextAlign(s[0].style.textAlign||"left");if(this.injection.viewer.getAnnotationObject(s[0].uid).isEditMode)return;let n=null;if(s[0].style.textContents.length)n=s[0].style.textContents[0];else {const{defaultStyleConfig:t}=this.injection.viewer.getAnnotationConfig();n=t[s[0].type].textContent;}const{fontFamily:o,fontSize:r,fontWeight:a,fontStyle:l,underline:h,lineThrough:c}=n;this.selectFontStyle(o,Math.round(Cr(r).value/xS),"bold"===a,"italic"===l,h,c);}),this);const e=t=>{if(["textBox","textTypewriter"].includes(t)){this.showTextAlignList("textBox"===t);const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),{textContent:i,textAlign:s}=e[t],{fontFamily:n,fontSize:o,fontWeight:r,fontStyle:a,underline:l,lineThrough:h}=i;this.selectTextAlign(s),this.selectFontStyle(n,Math.round(Cr(o).value/xS),"bold"===r,"italic"===a,l,h);}};t.hooks.annotationModeChanged.on((i=>{t.getSelectedAnnotations().length||e(i.newAnnotationMode);}),this),t.hooks.toolModeChanged.on((i=>{if("annotation"!==i.newToolMode)return;const{annotationMode:s}=t.getViewerConfig();e(s);}),this);}toggleSelect(t,e){const i="fontFamily"===t?"ddv-palette-font-family-select":"ddv-palette-font-size-select",s="fontFamily"===t?this.fontFamilyEl:this.fontSizeEl,n=s.querySelector(`.${i}`),o=s.querySelector(".ddv-down-arrow"),r="none"!==n.style.display,a=_s(e)?!r:e,l=this.injection.viewer.context.viewService.mainContainer;r!==a&&(a?(n.style.display="block",n.style.top=`${Db(n,l)}px`,o.style.transform="rotate(180deg)","fontSize"===t&&this.scrollFontSizeSelect()):(n.style.display="none",o.style.transform=""));}getFontFamilySelectTemplate(){let t="";for(let e=0;e<Tb.length;e++){const i=Tb[e];t+=`<button title="${i}" style="font-family:${i}" value="${i}">${i}</button>`;}return `<div class="ddv-palette-font-family"><span>Helvetica</span><i class="ddv-down-arrow"></i><div class="ddv-palette-font-family-select" style="display: none;">${t}</div></div>`}getFontSizeTemplate(){let t="";for(let e=1;e<=12;e++)t+=`<button value="${e}">${e}pt</button>`;for(let e=14;e<=36;e+=2)t+=`<button value="${e}">${e}pt</button>`;for(let e=40;e<=72;e+=4)t+=`<button value="${e}">${e}pt</button>`;if(this.maxFontSize>72){let e=72;for(;e+8<this.maxFontSize;)e+=8,t+=`<button value="${e}">${e}pt</button>`;t+=`<button value="${this.maxFontSize}">${this.maxFontSize}pt</button>`;}return `<div class="ddv-palette-font-size"><input type="string"/><i class="ddv-down-arrow"></i><div class="ddv-palette-font-size-select" style="display: none;">${t}</div></div>`}selectTextAlign(t){const e=this.el.querySelector(".ddv-align-left"),i=this.el.querySelector(".ddv-align-center"),s=this.el.querySelector(".ddv-align-right"),n=this.el.querySelector(".ddv-justify-center");Bb(e,"left"===t,"light"),Bb(i,"center"===t,"light"),Bb(s,"right"===t,"light"),Bb(n,"justify"===t,"light");}selectFontStyle(t,e,i,s,n,o){const r=this.fontFamilyEl.getElementsByTagName("span")[0],a=this.fontSizeEl.getElementsByTagName("input")[0],l=this.el.querySelector(".ddv-bold"),h=this.el.querySelector(".ddv-italic"),c=this.el.querySelector(".ddv-underline"),d=this.el.querySelector(".ddv-line-through");r.innerText=t,this.isArrowKeyPressed||("number"===a.type&&(a.type="text"),this.currentFontSizeValue=e,a.value=`${e}pt`),Bb(l,i,"light"),Bb(h,s,"light"),Bb(c,n,"light"),Bb(d,o,"light");}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.focusTexture();}}addFont(t){if(this.fontList.includes(t))return;this.fontList.push(t);const e=this.fontFamilyEl.querySelector(".ddv-palette-font-family-select"),i=document.createElement("button");i.style.fontFamily=t,""===i.style.fontFamily&&(i.style.fontFamily=`"${t}"`),i.value=t,i.innerText=t,i.title=t,e.appendChild(i);}showTextAlignList(t){const e=this.el.querySelector(".ddv-text-align-list");e&&(e.style.display=t?"":"none");}scrollFontSizeSelect(){if(!this.fontSizeEl)return;const t=this.fontSizeEl.querySelector(".ddv-palette-font-size-select"),{currentFontSizeValue:e}=this;let i=0;for(let s=0;s<t.children.length;s++){const n=t.children[s];if(!(e>=n.value))break;i=n.offsetTop;}t.scrollTo(0,i);}initTemplate(){const t=`<div class="${this.defaultClass}"><div style="display:flex; justify-content: space-between; position:relative; z-index:2">${this.getFontFamilySelectTemplate()}${this.getFontSizeTemplate()}</div><div><div class="ddv-button ddv-bold"></div><div class="ddv-button ddv-italic"></div><div class="ddv-button ddv-underline"></div><div class="ddv-button ddv-line-through"></div></div><div class="ddv-text-align-list"><div class="ddv-button ddv-align-left"></div><div class="ddv-button ddv-align-center"></div><div class="ddv-button ddv-align-right"></div><div class="ddv-button ddv-justify-center"></div></div></div>`;this.template=t;}}const bS=["None","ClosedArrow","OpenArrow","ROpenArrow","RClosedArrow","Butt","Circle","Diamond","Square","Slash"],SS=[[0,0],[3,3],[5,5],[7,7],[7,6,3,6],[5,4,21,4],[11,5,5,5]],CS={None:"ddv-solid",OpenArrow:"ddv-line-open",ROpenArrow:"ddv-line-r-open",ClosedArrow:"ddv-line-closed",RClosedArrow:"ddv-line-r-closed",Butt:"ddv-line-butt",Square:"ddv-line-square",Diamond:"ddv-line-diamond",Circle:"ddv-line-circle",Slash:"ddv-line-slash"},PS={33:"ddv-dashed-33",55:"ddv-dashed-55",77:"ddv-dashed-77",7636:"ddv-dashed-7636",54214:"ddv-dashed-54214",11555:"ddv-dashed-11555"};class TS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-line-panel"),i(this,"commonClass","ddv-palette-line-panel-common"),i(this,"LineStyleClass","ddv-palette-border-style"),i(this,"lineStyleClassSmall","ddv-palette-border-style-small"),i(this,"startLineEndingClass","ddv-palette-line-start"),i(this,"endLineEndingClass","ddv-palette-line-end"),i(this,"selectionClass","ddv-palette-line-panel-selection"),i(this,"startLineEndingSelect",void 0),i(this,"borderStyleSelect",void 0),i(this,"endLineEndingSelect",void 0),i(this,"isStrokePalette",void 0),this.bindHooks(),this.initTemplate(),this.$on("ui_shrinkSelectionBox",(t=>{"lineEndingStart"!==t&&this.toggleSelect(0,!1),"borderStyle"!==t&&this.toggleSelect(1,!1),"lineEndingEnd"!==t&&this.toggleSelect(2,!1);})),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stroke"===t?"":"none",this.isStrokePalette="stroke"===t;const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig(),s=this.injection.viewer.getSelectedAnnotations();("annotation"===e&&"ink"===i||1===s.length&&"ink"===s[0].type)&&(this.el.style.display="none");}));}bindHooks(){this.hooks.inserted.on((()=>{const t=this.el.querySelectorAll(`.${this.commonClass}`);this.startLineEndingSelect=t[0],this.borderStyleSelect=t[1],this.endLineEndingSelect=t[2],this.bindViewerHooks(),this.bindToggleEvent(),this.bindSelectEvent();}));}bindSelectEvent(){const t=this.startLineEndingSelect.querySelector(`.${this.selectionClass}`),e=this.borderStyleSelect.querySelector(`.${this.selectionClass}`),i=this.endLineEndingSelect.querySelector(`.${this.selectionClass}`),s=(t,e)=>{const i=e.target,s="BUTTON"===i.tagName?i:i.parentNode;return Array.from(t.childNodes).indexOf(s)||0};this.nativeOn(t,"click",(e=>{const i=s(t,e),n=bS[i]||"None";this.updateLineEndingByData(!0,n),this.updateDefaultLineEnding(!0,n);})),this.nativeOn(e,"click",(t=>{const i=s(e,t),n=SS[i]||[0,0];this.updateLineDashByData(n),this.updateDefaultLineDash(n);})),this.nativeOn(i,"click",(t=>{const e=s(i,t),n=bS[e]||"None";this.updateLineEndingByData(!1,n),this.updateDefaultLineEnding(!1,n);}));}bindToggleEvent(){this.nativeOn(this.startLineEndingSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","lineEndingStart"),this.toggleSelect(0);})),this.nativeOn(this.borderStyleSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","borderStyle"),this.toggleSelect(1);})),this.nativeOn(this.endLineEndingSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","lineEndingEnd"),this.toggleSelect(2);}));}bindViewerHooks(){const t=this.injection.viewer,e=(t,e,i,s)=>{if(this.startLineEndingSelect.style.display=t?"":"none",this.endLineEndingSelect.style.display=t?"":"none",this.borderStyleSelect.classList.remove(t?this.LineStyleClass:this.lineStyleClassSmall),this.borderStyleSelect.classList.add(t?this.lineStyleClassSmall:this.LineStyleClass),t){const[t,e]=i;this.updateLineEndingSelect(!0,CS[t]||"ddv-solid"),this.updateLineEndingSelect(!1,CS[e]||"ddv-solid");}this.el.style.display=s||!this.isStrokePalette?"none":"",this.updateBorderStyleSelect(e||[0,0]);};t.hooks.selectedAnnotationsChanged.on((i=>{var s,n;if(1!==i.newAnnotationUids.length)return;const o=t.getSelectedAnnotations()[0];if(!o)return;const r="line"===o.type||"polyline"===o.type;e(r,null===(s=o.style)||void 0===s?void 0:s.lineDash,null===(n=o.style)||void 0===n?void 0:n.lineEnding,"ink"===o.type||"stamp"===o.type);}),this),t.hooks.annotationModeChanged.on((t=>{const i=t.newAnnotationMode,s="polyline"===i||"line"===i,n="ink"===i;if("select"!==i&&"erase"!==i&&"stamp"!==i){var o,r;const{defaultStyleConfig:t}=this.injection.viewer.getAnnotationConfig(),a=(null===(o=t[i])||void 0===o?void 0:o.lineEnding)||(null==hh?void 0:hh.lineEnding),l=(null===(r=t[i])||void 0===r?void 0:r.lineDash)||(null==hh?void 0:hh.lineDash);e(s,l,a,n);}}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{var i;const{toolMode:s,annotationMode:n}=this.injection.viewer.getViewerConfig();if("annotation"!==s)return;if("select"===n||"erase"===n||"stamp"===n)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:o}=this.injection.viewer.getAnnotationConfig(),r="line"===n||"polyline"===n,a="ink"===n,l=(null===(i=o[n])||void 0===i?void 0:i.lineEnding)||hh.lineEnding,h=o[n].lineDash||hh.lineDash;e(r,h,l,a);}),this),t.hooks.annotationsUpdated.on((i=>{const{actions:s,uids:n}=i,o=t.getSelectedAnnotations();if(!s.includes("appearanceChanged")||1!==o.length||!n.includes(o[0].uid))return;if("ink"===o[0].type||"stamp"===o[0].type)return;const r="line"===o[0].type||"polyline"===o[0].type,a=o[0].style.lineEnding||["None","None"],l=o[0].style.lineDash||[0,0];e(r,l,a,!1);}),this);}toggleSelect(t,e){let i=this.borderStyleSelect;0===t?i=this.startLineEndingSelect:2===t&&(i=this.endLineEndingSelect);const s=i.querySelector(`.${this.selectionClass}`),n=i.querySelector(".ddv-down-arrow"),o="none"!==s.style.display,r=_s(e)?!o:e,a=this.injection.viewer.context.viewService.mainContainer;o!==r&&(r?(s.style.display="block",s.style.top=`${Db(s,a)}px`,n.style.transform="rotate(180deg)"):(s.style.display="none",n.style.transform=""));}updateLineEndingSelect(t,e){(t?this.startLineEndingSelect:this.endLineEndingSelect).querySelector("div").className=`ddv-button ${e}`;}updateBorderStyleSelect(t){const e=this.borderStyleSelect,i=t.join("")||"0",s=e.querySelector("div");let n="ddv-solid";Jn(t)||(n=PS[i]||"ddv-dashed-33"),s.className=`ddv-button ${n}`;}updateLineDashByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;(e[0].style.lineDash||[0,0]).toString()!==t.toString()&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{lineDash:t}},["appearanceChanged"]);}updateLineEndingByData(t,e){const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const s=i[0].style.lineEnding||["None","None"];t&&e===s[0]||!t&&e===s[1]||this.injection.viewer.updateAnnotation(i[0].uid,{style:{lineEnding:t?[e,s[1]]:[s[0],e]}},["appearanceChanged"]);}updateDefaultLineEnding(t,e){var i;const{annotationMode:s}=this.injection.viewer.getViewerConfig(),n=this.injection.viewer.getSelectedAnnotations(),{defaultStyleConfig:o}=this.injection.viewer.getAnnotationConfig();let r=(null===(i=o[s])||void 0===i?void 0:i.lineEnding)||hh.lineEnding,a=s;n.length&&n[0]&&(r=n[0].style.lineEnding,a=n[0].type);const l=[...r];t?l[0]=e:l[1]=e,this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[a]:{lineEnding:l}}});}updateDefaultLineDash(t){const{annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let s=e;i.length&&i[0]&&(s=i[0].type),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[s]:{lineDash:t}}});}getBaseLineDashTemplate(){const t=["ddv-solid","ddv-dashed-33","ddv-dashed-55","ddv-dashed-77","ddv-dashed-7636","ddv-dashed-54214","ddv-dashed-11555"];let e="";for(let i=0;i<t.length;i++){e+=`<button><i class="ddv-button ${t[i]}"></i></button>`;}return `<div class="${this.commonClass} ${this.lineStyleClassSmall}"><div class="ddv-button ddv-solid"></div><i class="ddv-down-arrow"></i><div style="display:none;" class="${this.selectionClass}" >${e}</div></div>`}getLineEndingTemplate(t){const e=["ddv-solid","ddv-line-closed","ddv-line-open","ddv-line-r-open","ddv-line-r-closed","ddv-line-butt","ddv-line-circle","ddv-line-diamond","ddv-line-square","ddv-line-slash"];let i="";for(let t=0;t<e.length;t++){i+=`<button><i class="ddv-button ${e[t]}"></i></button>`;}const s=t?this.startLineEndingClass:this.endLineEndingClass;return `<div class="${this.commonClass} ${s}"><div class="ddv-button ddv-solid"></div><i class="ddv-down-arrow"></i><div style="display:none;" class="${this.selectionClass}" >${i}</div></div>`}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div style="margin-top:10px">${this.getLineEndingTemplate(!0)}${this.getBaseLineDashTemplate()}${this.getLineEndingTemplate(!1)}</div></div>`;this.template=e;}}class AS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-opacity-panel"),i(this,"isPointerDown",!1),i(this,"lastPointerValue",void 0),i(this,"range",void 0),i(this,"input",void 0),i(this,"inputIsBlur",!0),i(this,"isArrowKeyPressed",!1),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.inserted.on((()=>{this.range=this.el.querySelector(".ddv-palette-opacity-range"),this.input=this.el.querySelector(".ddv-palette-opacity-input"),kb(this.range,0,100),this.bindViewerHooks(),this.bindRangeEvent(),this.bineInputEvent();}));}bineInputEvent(){const{input:t}=this;this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){const e=Pr(t.value).value;e>100&&(t.value=100),e<0&&(t.value=0);let i=parseInt(t.value,10);js(i)||(i=100,this.updateInput(100)),this.updateDefaultOpacity(i),this.updateOpacityByData(i),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(e=>{const i=t.value,s=Pr(i).value;t.value=s,t.type="number",this.inputIsBlur=!1;})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,e.relatedTarget instanceof HTMLInputElement||this.focusTexture(),"text"!==t.type&&(t.type="text",t.value+="%");}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="%",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);const i=Pr(t.value).value;i>100&&(t.value=100),i<0&&(t.value=0);let s=parseInt(t.value,10);js(s)||(s=100,this.updateInput(100)),this.updateDefaultOpacity(s),this.updateOpacityByData(s);};this.nativeOn(t,"change",e);}bindRangeEvent(){const{range:t}=this,e=()=>{const e=parseInt(t.value,10);this.updateOpacityByShape(e),this.input.value=`${e}%`;const{toolMode:i,annotationMode:s}=this.injection.viewer.getViewerConfig();"annotation"===i&&"select"!==s&&"erase"!==s&&this.updateInput(e);};this.nativeOn(t,"click",(()=>{const e=parseInt(t.value,10);this.injection.viewer.context.isFocusCanvas=!1,e!==this.lastPointerValue&&(this.updateOpacityByData(e),this.updateDefaultOpacity(e));})),this.nativeOn(t,"pointerdown",(t=>{t.stopPropagation(),this.isPointerDown=!0,this.injection.viewer.context.isFocusCanvas=!1,this.$emit("ui_shrinkSelectionBox");const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const s=this.injection.viewer.getAnnotationObject(i[0].uid);s instanceof Ch&&s.isEditMode&&(s.textEditEventHandler.disableEditMode(),this.injection.viewer.context.render(95)),e();})),this.nativeOn(t,"pointermove",(()=>{this.isPointerDown&&e();})),this.nativeOn(t,"pointerup",(()=>{if(this.isPointerDown){const e=parseInt(t.value,10);this.lastPointerValue=e,this.updateOpacityByData(e),this.updateDefaultOpacity(e);}this.isPointerDown=!1;})),this.nativeOn(t,"keydown",(t=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&e();})),this.nativeOn(t,"keyup",(e=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){const e=parseInt(t.value,10);this.updateOpacityByData(e),this.updateDefaultOpacity(e);}}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{annotationMode:t}=this.injection.viewer.getViewerConfig();if("select"===t||"erase"===t)return;const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),i=js(e[t].opacity)?e[t].opacity:hh.opacity;this.updateInput(Math.round(100*i));};t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];i&&this.updateInput(Math.round(100*i.style.opacity));}),this),t.hooks.annotationsUpdated.on((e=>{const{actions:i,uids:s}=e,n=t.getSelectedAnnotations();i.includes("appearanceChanged")&&1===n.length&&s.includes(n[0].uid)&&this.updateInput(Math.round(100*n[0].style.opacity));}),this),t.hooks.annotationModeChanged.on((t=>{e();}),this),t.hooks.toolModeChanged.on((t=>{"annotation"===t.newToolMode&&e();}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig();if("annotation"!==e)return;if("select"===i||"erase"===i)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:s}=this.injection.viewer.getAnnotationConfig(),n=js(s[i].opacity)?s[i].opacity:hh.opacity;this.updateInput(100*n);}),this);}updateInput(t){let e=t;t>100&&(e=100),t<0&&(e=0),e=Math.round(e),this.range.value=`${e}`,this.range.dispatchEvent(new Event("change")),this.input.value="number"===this.input.type?e:`${e}%`;}updateOpacityByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid);if(!i)return;const s=100*i.style.opacity;(t=Math.round(t))!==s&&(i.style.opacity=t/100,this.injection.viewer.context.render(94));}updateOpacityByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=100*e[0].style.opacity;(t=Math.round(t))!==i&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{opacity:t/100}},["appearanceChanged"]);}updateDefaultOpacity(t){const{viewer:e}=this.injection,{annotationMode:i}=e.getViewerConfig(),s=e.getSelectedAnnotations();let n=i;s.length&&s[0]&&(n=s[0].type),t=Math.round(t),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[n]:{opacity:t/100}}});}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div class="ddv-palette-opacity-range-container"><input class="ddv-palette-opacity-range" type="range" min="0" max="100" value="100"/><input class="ddv-palette-opacity-input" type="string" value="100%"/></div></div>`;this.template=e;}}const kS=[rh.DRAFT,rh.FINAL,rh.VOID,rh.REJECTED,rh.ACCEPTED,rh.APPROVED,rh.NOT_APPROVED,rh.COMPLETED,rh.CONFIDENTIAL,rh.INITIAL_HERE,rh.SIGN_HERE,rh.WITNESS];class DS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-stamp-panel"),i(this,"select",void 0),i(this,"selectBox",void 0),i(this,"iconName",rh.DRAFT),i(this,"enableCustomStamp",!1),i(this,"customStampSelect",void 0),i(this,"customStampSelectBox",void 0),i(this,"customStampList",[]),this.enableCustomStamp=t.data.enableCustomStamp,this.initTemplate(),this.bindHooks(),this.bindViewerHooks(),this.$on("ui_shrinkSelectionBox",(t=>{"stampIcon"!==t&&this.toggleSelect(!1,!1),this.enableCustomStamp&&"customStamp"!==t&&this.toggleSelect(!0,!1);}));}bindHooks(){this.hooks.inserted.on((()=>{this.select=this.el.querySelector(".ddv-palette-stamp-icon"),this.selectBox=this.el.querySelector(".ddv-palette-stamp-icon-select"),this.enableCustomStamp&&(this.customStampSelect=this.el.querySelector(".ddv-palette-custom-stamp"),this.customStampSelectBox=this.el.querySelector(".ddv-palette-custom-stamp-select")),this.bindToggleEvent(),this.bindSelectEvent(),this.bindCreateCustomStampEvent();}));}bindToggleEvent(){this.nativeOn(this.select,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","stampIcon"),this.toggleSelect(!1);})),this.enableCustomStamp&&this.nativeOn(this.customStampSelect,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox","customStamp"),this.toggleSelect(!0);}));}bindSelectEvent(){this.nativeOn(this.selectBox,"click",(t=>{const e=t.target.value;this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampIcon:e,stampConfig:null}}});})),this.nativeOn(this.selectBox,"pointermove",(t=>{t.stopPropagation();}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{var e;const{toolMode:i,annotationMode:s}=t.getViewerConfig(),n=t.getAnnotationConfig();"annotation"!==i||"stamp"!==s||null!==(e=n.defaultStyleConfig)&&void 0!==e&&null!==(e=e.stamp)&&void 0!==e&&e.imageData?this.el.style.display="none":this.el.style.display="";};this.hooks.inserted.on((()=>{e();const{defaultStyleConfig:i}=t.getAnnotationConfig(),{stamp:s}=i,n=(null==s?void 0:s.stampIcon)||(null==hh?void 0:hh.stampIcon);this.updateStampSpan(n);})),t.hooks.annotationDefaultStyleChanged.on((t=>{var i;if(e(),null===(i=t.newStyle)||void 0===i||!i.stamp)return;const{stamp:s}=t.newStyle,n=(null==s?void 0:s.stampIcon)||(null==hh?void 0:hh.stampIcon);(null==s?void 0:s.stampConfig)?this.updateStampSpan("SBCustom Stamp"):n!==this.iconName&&this.updateStampSpan(n);}),this),t.hooks.toolModeChanged.on(e,this),t.hooks.annotationModeChanged.on(e,this);}toggleSelect(t,e){const i=t?this.customStampSelect:this.select,s=t?this.customStampSelectBox:this.selectBox,n=i.querySelector(".ddv-down-arrow"),o="none"!==s.style.display,r=_s(e)?!o:e,a=this.injection.viewer.context.viewService.mainContainer;o!==r&&(r?(s.style.display="block",s.style.top=`${Db(s,a)}px`,n.style.transform="rotate(180deg)"):(s.style.display="none",n.style.transform=""));}updateStampSpan(t){this.el.getElementsByTagName("span")[1].innerText=t.slice(2),this.iconName=t;}getStampIconSelectTemplate(){let t="";for(let e=0;e<kS.length;e++){const i=kS[e];t+=`<button value="${i}">${i.slice(2)}</button>`;}return `<div class="ddv-palette-stamp-icon"><span>${rh.DRAFT.slice(2)}</span><i class="ddv-down-arrow"></i><div class="ddv-palette-stamp-icon-select" style="display: none;">${t}</div></div>${this.getCustomStampTemplate()}`}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span>${this.getStampIconSelectTemplate()}</div>`;this.template=e;}bindCreateCustomStampEvent(){if(!this.enableCustomStamp)return;const t=this.customStampSelectBox.querySelector(".ddv-palette-custom-stamp-button");this.nativeOn(t,"click",(()=>{Wb(this.injection.viewer,!0),this.$emit("ui_changePalette_visible","AnnotationCustomStampPanel",!0);})),this.$on("ui_customStampCreated",(t=>{const{stampConfig:e,stampImage:i}=t,s=URL.createObjectURL(i),n={stampConfig:Ns(e),imgUrl:s};this.customStampList.push(n),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampConfig:n.stampConfig}}}),this.addCustomStamp(n);})),this.nativeOn(this.customStampSelectBox,"click",(t=>{const e=t.target;if(e instanceof HTMLImageElement){const t=mn(e.parentElement),{stampConfig:i}=this.customStampList[t-1];this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{stamp:{stampConfig:i}}});}if("i"===e.tagName.toLocaleLowerCase()){t.stopPropagation();const i=mn(e.parentElement),{imgUrl:s}=this.customStampList[i-1];URL.revokeObjectURL(s),e.parentElement.remove(),this.customStampList.splice(i-1,1);}}));}getCustomStampTemplate(){if(!this.enableCustomStamp)return "";return '<div class="ddv-palette-custom-stamp"><span>Custom Stamp</span><i class="ddv-down-arrow"></i><div class="ddv-palette-custom-stamp-select" style="display: none;"><div><button class="ddv-palette-custom-stamp-button">Create New Stamp</button></div></div></div>'}addCustomStamp(t){const e=document.createElement("div");e.className="ddv-palette-custom-stamp-item";const i=document.createElement("img");i.src=t.imgUrl,i.draggable=!1,e.appendChild(i);const s=document.createElement("i");s.className="ddv-button ddv-delete-annot",e.appendChild(s),this.customStampSelectBox.appendChild(e);}}const RS=Bo.displayResolution/Bo.dataResolution;class ES extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-stroke-panel"),i(this,"isPointerDown",!1),i(this,"lastPointerValue",void 0),i(this,"range",void 0),i(this,"input",void 0),i(this,"inputIsBlur",!0),i(this,"isArrowKeyPressed",!1),i(this,"maxBorderWidth",20),this.maxBorderWidth=t.data.maxBorderWidth,this.maxBorderWidth<20&&(this.maxBorderWidth=20),this.initTemplate(),this.bindHooks(),this.$on("ui_changePalette_type",(t=>{this.el.style.display="stroke"===t?"":"none";}));}bindHooks(){this.hooks.inserted.on((()=>{this.range=this.el.querySelector(".ddv-palette-stroke-range"),this.input=this.el.querySelector(".ddv-palette-stroke-input"),kb(this.range,0,this.maxBorderWidth),this.bindViewerHooks(),this.bindRangeEvent(),this.bineInputEvent();}));}bineInputEvent(){const{input:t}=this;this.nativeOn(t,"keydown",(t=>{t.stopPropagation(),"ArrowUp"!==t.key&&"ArrowDown"!==t.key||(this.isArrowKeyPressed=!0);})),this.nativeOn(t,"keyup",(e=>{if(e.stopPropagation(),this.isArrowKeyPressed){const e=Cr(t.value).value;e>this.maxBorderWidth&&(t.value=this.maxBorderWidth),e<0&&(t.value=0);let i=parseInt(t.value,10);js(i)||(i=1,this.updateInput(1*RS)),this.updateDefaultBorderWidth(i),this.updateBorderWidthByData(i),this.isArrowKeyPressed=!1;}})),this.nativeOn(t,"focus",(e=>{const i=t.value,s=parseFloat(i);t.value=s,t.type="number",this.inputIsBlur=!1;})),this.nativeOn(t,"blur",(e=>{this.inputIsBlur=!0,e.relatedTarget instanceof HTMLInputElement||this.focusTexture(),"text"!==t.type&&(t.type="text",t.value+="pt");}));const e=()=>{if(this.inputIsBlur||this.isArrowKeyPressed)return;t.type="text",t.value+="pt",t.removeEventListener("change",e),t.blur(),t.addEventListener("change",e);const i=Cr(t.value).value;i>this.maxBorderWidth&&(t.value=this.maxBorderWidth),i<0&&(t.value=0);let s=parseInt(t.value,10);js(s)||(s=1,this.updateInput(1*RS)),this.updateDefaultBorderWidth(s),this.updateBorderWidthByData(s);};this.nativeOn(t,"change",e);}bindRangeEvent(){const{range:t}=this,e=()=>{const e=Cr(t.value).value;this.updateBorderWidthByShape(e),this.input.value=`${e}pt`;const{toolMode:i,annotationMode:s}=this.injection.viewer.getViewerConfig();"annotation"===i&&"select"!==s&&"erase"!==s&&this.updateInput(e*RS);};this.nativeOn(t,"click",(()=>{const e=Cr(t.value).value;this.injection.viewer.context.isFocusCanvas=!1,e!==this.lastPointerValue&&(this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e));})),this.nativeOn(t,"pointerdown",(t=>{t.stopPropagation(),this.isPointerDown=!0,this.injection.viewer.context.isFocusCanvas=!1,this.$emit("ui_shrinkSelectionBox");const i=this.injection.viewer.getSelectedAnnotations();if(1!==i.length)return;const s=this.injection.viewer.getAnnotationObject(i[0].uid);s instanceof Ch&&s.isEditMode&&(s.textEditEventHandler.disableEditMode(),this.injection.viewer.context.render(96)),e();})),this.nativeOn(t,"pointermove",(()=>{this.isPointerDown&&e();})),this.nativeOn(t,"pointerup",(()=>{if(this.isPointerDown){const e=Cr(t.value).value;this.lastPointerValue=e,this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e);}this.isPointerDown=!1;})),this.nativeOn(t,"keydown",(t=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t.key)&&e();})),this.nativeOn(t,"keyup",(e=>{if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){const e=Cr(t.value).value;this.updateBorderWidthByData(e),this.updateDefaultBorderWidth(e);}}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{annotationMode:t}=this.injection.viewer.getViewerConfig();if("select"===t||"erase"===t)return;const{defaultStyleConfig:e}=this.injection.viewer.getAnnotationConfig(),i=js(e[t].borderWidth)?e[t].borderWidth:hh.borderWidth;this.updateInput(i);};t.hooks.selectedAnnotationsChanged.on((e=>{if(1!==e.newAnnotationUids.length)return;const i=t.getSelectedAnnotations()[0];i&&this.updateInput(Cr(i.style.borderWidth).value,!0);}),this),t.hooks.annotationsUpdated.on((e=>{const{actions:i,uids:s}=e,n=t.getSelectedAnnotations();i.includes("appearanceChanged")&&1===n.length&&s.includes(n[0].uid)&&this.updateInput(Cr(n[0].style.borderWidth).value);}),this),t.hooks.annotationModeChanged.on((t=>{e();}),this),t.hooks.toolModeChanged.on((t=>{"annotation"===t.newToolMode&&e();}),this),t.hooks.annotationDefaultStyleChanged.on((()=>{const{toolMode:e,annotationMode:i}=this.injection.viewer.getViewerConfig();if("annotation"!==e)return;if("select"===i||"erase"===i||"stamp"===i)return;if(t.getSelectedAnnotations().length)return;const{defaultStyleConfig:s}=this.injection.viewer.getAnnotationConfig(),n=js(s[i].borderWidth)?s[i].borderWidth:hh.borderWidth;this.updateInput(n);}),this);}updateInput(t,e){let i=t/RS;this.isPointerDown||e?i=Math.round(i):(i=i.toFixed(1),i.endsWith(".0")&&(i=parseInt(i,10))),this.range.value=i,this.range.dispatchEvent(new Event("change")),this.input.value="number"===this.input.type?parseFloat(i):`${i}pt`;}updateBorderWidthByShape(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=this.injection.viewer.getAnnotationObject(e[0].uid);if(!i)return;const s=t*RS,{borderWidth:n}=i.style;n!==s&&(i.style.borderWidth=s,this.injection.viewer.context.render(97));}updateBorderWidthByData(t){const e=this.injection.viewer.getSelectedAnnotations();if(1!==e.length)return;const i=t*RS,{borderWidth:s}=e[0].style;s!==i&&this.injection.viewer.updateAnnotation(e[0].uid,{style:{borderWidth:i}},["appearanceChanged"]);}updateDefaultBorderWidth(t){const{annotationMode:e}=this.injection.viewer.getViewerConfig(),i=this.injection.viewer.getSelectedAnnotations();let s=e;i.length&&i[0]&&(s=i[0].type),this.injection.viewer.updateAnnotationConfig({defaultStyleConfig:{[s]:{borderWidth:t*RS}}});}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{label:t}=this.data,e=`<div class="${this.defaultClass}"><span>${t}</span><div><input class="ddv-palette-stroke-range" type="range" min="0" max="${this.maxBorderWidth}" value="0"/><input class="ddv-palette-stroke-input" type="string" value="0pt"/></div></div>`;this.template=e;}}class MS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-palette-box"),i(this,"header",void 0),i(this,"fillSpan",void 0),i(this,"textSpan",void 0),i(this,"strokeSpan",void 0),i(this,"thumbnail",void 0),vb.registerComponent({ColorPanel:yS,FontPanel:wS,LinePanel:TS,StampPanel:DS,OpacityPanel:AS,StrokePanel:ES}),this.bindHooks(),this.initTemplate(),this.bindViewerHooks(),this.$on("ui_changePalette_visible",((t,e)=>{t===MS.cpName&&this.togglePopup(e);})),this.injection.viewer.on("thumbnailBind",(t=>{if(this.thumbnail)return;const e=this.injection.viewer.context.core.getViewer(t);e&&(this.thumbnail=e,this.bindThumbnailHooks());}));}bindHooks(){const t=t=>{this.header=this.el.querySelector(`.${this.defaultClass}-header`);const e=this.header.getElementsByTagName("span");this.textSpan=e[0],this.strokeSpan=e[1],this.fillSpan=e[2],this.bindEvents();this.injection.viewer.context.viewService.mainContainer.appendChild(this.el);const{enableDrag:i}=this.data.options;this.el.dataset.enableDrag=`${i}`,function(t){let e,i,s,n,o=!1;function r(r){if(!o)return;r.preventDefault();const a=r.clientX-e,l=r.clientY-i,h=s+a,c=n+l;t.style.left=`${h}px`,t.style.top=`${c}px`;}function a(){o=!1,document.removeEventListener("pointermove",r),document.removeEventListener("pointerup",a);}t.addEventListener("pointerdown",(function(l){const h=l.target;h.classList.contains("ddv-button")||"false"===t.dataset.enableDrag||h instanceof HTMLInputElement||h instanceof HTMLButtonElement||(o=!0,e=l.clientX,i=l.clientY,s=t.offsetLeft,n=t.offsetTop,document.addEventListener("pointermove",r),document.addEventListener("pointerup",a));}));}(this.el);};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindEvents(){this.nativeOn(this.el,"click",(t=>{t.stopPropagation(),this.$emit("ui_shrinkSelectionBox",t);})),this.nativeOn(this.el,"pointerup",(t=>{t.target instanceof HTMLInputElement&&!(t.target instanceof HTMLInputElement&&"range"===t.target.type)||this.focusTexture();})),this.nativeOn(this.textSpan,"click",(()=>{this.setPaletteType("text");})),this.nativeOn(this.fillSpan,"click",(()=>{this.setPaletteType("fill");})),this.nativeOn(this.strokeSpan,"click",(()=>{this.setPaletteType("stroke");}));}bindViewerHooks(){const t=this.injection.viewer,e=()=>{const{toolMode:e,annotationMode:i}=t.getViewerConfig(),s=t.getSelectedAnnotations();return !t.getPageCounts()||("annotation"!==e&&!s.length||"annotation"===e&&("select"===i||"erase"===i))},i=t=>{"stamp"===t?this.setPaletteType("stamp"):"textAssist"===t?this.setPaletteType("textAssist"):"text"===t?(this.textSpan.style.display="",this.setPaletteType("text")):(this.textSpan.style.display="none",this.setPaletteType("stroke"));};this.hooks.inserted.on((()=>{e()&&this.togglePopup(!1);})),t.hooks.resize.on((()=>{if("none"===this.el.style.display)return;const{isOutOf:t}=IS(this.el,!1);if(t){var e;const t=this.el.getBoundingClientRect(),i=null===(e=this.el.parentElement)||void 0===e?void 0:e.getBoundingClientRect();this.el.style.right=i.width-t.width+"px";}}),this),t.hooks.beforeAnnotationEdit.on((()=>{this.togglePopup(!1);}),this),t.hooks.beforeAnnotationDraw.on((()=>{this.togglePopup(!1);}),this),t.hooks.beforeTextSelected.on((()=>{this.togglePopup(!1);})),t.hooks.pageChanged.on((e=>{e.total||this.togglePopup(!1);const i=t.getActiveTab();if(!i||"single"!==i.context.displayMode)return;1===t.getSelectedAnnotations().length&&this.togglePopup(!1);}),this),t.hooks.toolModeChanged.on((s=>{if(e())return void this.togglePopup(!1);const{annotationMode:n}=t.getViewerConfig(),o=["erase","select"].includes(n);if("annotation"===s.newToolMode&&!o&&!$s()){const t=["textBox","textTypewriter"].includes(n),e=["highlight","underline","strikeout"].includes(n),s="textTypewriter"===n,o="ink"===n,r="stamp"===n?"stamp":t?"text":e?"textAssist":"common";i(r),("text"===r&&s||o)&&(this.header.style.display="none"),this.togglePopup(!0);}}),this),t.hooks.selectedAnnotationsChanged.on((s=>{e()&&this.togglePopup(!1);const n=t.getSelectedAnnotations();if(1!==n.length)return;const o=n[0],r=["textBox","textTypewriter"].includes(o.type),a="textTypewriter"===o.type,l="ink"===o.type,h=["highlight","underline","strikeout"].includes(o.type),c="stamp"===o.type?"stamp":r?"text":h?"textAssist":"common";i(c),("text"===c&&a||l)&&(this.header.style.display="none");}),this),t.hooks.annotationModeChanged.on((e=>{if(t.getSelectedAnnotations().length)return;const s=e.newAnnotationMode;if(["erase","select"].includes(s))return void this.togglePopup(!1);const n=["textBox","textTypewriter"].includes(s),o=["highlight","underline","strikeout"].includes(s),r="textTypewriter"===s,a="ink"===s,l="stamp"===s?"stamp":n?"text":o?"textAssist":"common";i(l),("text"===l&&r||a)&&(this.header.style.display="none");const{toolMode:h}=this.injection.viewer.getViewerConfig(),c=this.injection.viewer.getPageCounts();if($s()&&"stamp"!==l)this.togglePopup(!1);else {const{options:t}=this.data;this.togglePopup(c>0&&"annotation"===h&&t.autoDisplay);}}),this);}bindThumbnailHooks(){this.thumbnail.hooks.visibleChanged.on((()=>{this.updatePosition();}),this),this.$on("ui_searchVisibilityChanged",(()=>{this.updatePosition();}));}updatePosition(){if("none"===this.el.style.display)return;const{isOutOf:t,outOfLeft:e,outOfRight:i}=IS(this.el,!1);if(t){var s;const t=this.el.getBoundingClientRect(),n=null===(s=this.el.parentElement)||void 0===s?void 0:s.getBoundingClientRect();e&&(this.el.style.left="0px"),i&&(this.el.style.left=n.width-t.width+"px");}}setPaletteType(t){const{header:e,textSpan:i,strokeSpan:s,fillSpan:n}=this;if(this.$emit("ui_changePalette_type",t),"stamp"===t||"textAssist"===t)return void(e.style.display="none");const{backgroundColor:o}=getComputedStyle(this.el);e.style.display="";const r=(e,i,s)=>{e.style.background=t===i?s:"",e.style.borderBottom=t===i?"none":"";};r(i,"text",o),r(s,"stroke",o),r(n,"fill",o);}togglePopup(t,e,i){const s="none"!==this.el.style.display,n=_s(t)?!s:t;if(s===n)return;const{options:o}=this.data;n?(this.el.style.display="",null!=o&&o.positionRocked&&(this.el.style.left="",this.el.style.top="")):(this.el.style.display="none",this.$emit("ui_shrinkSelectionBox")),_s(e)||(this.el.style.right=`${e||0}px`),_s(i)||(this.el.style.top=`${i||0}px`),this.injection.viewer.emit("annotationPaletteToggle",n),IS(this.el).isOutOf&&(this.el.style.left="",this.el.style.top="");}focusTexture(){const t=this.injection.viewer.getSelectedAnnotations();if(1===t.length){const e=this.injection.viewer.getAnnotationObject(t[0].uid);e instanceof Ch&&e.isEditMode&&e.focusTexture();}}initTemplate(){const{options:t}=this.data;Lb(Ob(this),this.injection.viewer,t),null!=t&&t.labels||(t.labels={}),t.labels={text:"Text",stroke:"Stroke",fill:"Fill",opacity:"Opacity",style:"Style",standardBusiness:"Standard Business",...t.labels},t.style={...t.style,display:"none"};const e=`<div ${pb(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>${t.labels.text}</span><span>${t.labels.stroke}</span><span>${t.labels.fill}</span></div><FontPanel :maxFontSize="options.maxFontSize"></FontPanel><ColorPanel :enableChangeColor="options.enableChangeColor" :colorList="options.colorList"></ColorPanel><StampPanel :enableCustomStamp="options.enableCustomStamp" label="${t.labels.standardBusiness}"></StampPanel><OpacityPanel label="${t.labels.opacity}"></OpacityPanel><StrokePanel :maxBorderWidth="options.maxBorderWidth" label="${t.labels.stroke}"></StrokePanel><LinePanel label="${t.labels.style}"></LinePanel></div>`;this.template=e;}}function IS(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:25;if("none"===t.style.display||!t.parentElement)return {isOutOf:!1};const s=t.getBoundingClientRect(),n=t.parentElement.getBoundingClientRect();if(!e){const t=s.left<n.left,e=s.left+s.width>n.right;return {isOutOf:t||e,outOfLeft:t,outOfRight:e}}const o=s.right-i<n.left,r=s.left+i>n.right,a=s.bottom-i<n.top,l=s.top+i>n.bottom;return {isOutOf:o||r||a||l,outOfLeft:o,outOfRight:r,outOfTop:a,outOfBottom:l}}i(MS,"cpName","AnnotationPalette");class BS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-custom-stamp-panel"),i(this,"stampBoard",void 0),i(this,"fontList",[...Tb]),i(this,"colorType",void 0),this.stampBoard=new wx(260,100),this.bindHooks(),this.initTemplate(),this.$on("ui_addFont",(t=>{this.addFont(t);})),this.$on("ui_changePalette_visible",((t,e)=>{t===BS.cpName&&this.togglePopup(e);}));}getFontFamilySelectTemplate(){let t="";for(let e=0;e<Tb.length;e++){const i=Tb[e];t+=`<button style="font-family:${i}" value="${i}">${i}</button>`;}return `<div class="ddv-stamp-font-family"><p>${this.stampBoard.signatureStyle.fontFamily}</p><i class="ddv-down-arrow"></i><div class="ddv-stamp-font-family-select" style="display: none;">${t}</div></div>`}bindHooks(){this.hooks.inserted.on((t=>{this.injection.viewer.context.viewService.rootDom.appendChild(this.el);const e=this.stampBoard.getCanvas();this.el.querySelector(`.${this.defaultClass}-canvas-container`).appendChild(e),this.bindEvents(),this.updateFontStyleButton(),this.selectColorType("background"),this.updateColorSelected();}));}bindEvents(){const t=this.el.querySelector(".ddv-bold"),e=this.el.querySelector(".ddv-italic"),i=this.el.querySelector(".ddv-underline"),s=this.el.querySelector(".ddv-line-through");this.nativeOn(t,"click",(()=>{const{fontWeight:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({fontWeight:"bold"===t?"normal":"bold"}),this.updateFontStyleButton();})),this.nativeOn(e,"click",(()=>{const{fontStyle:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({fontStyle:"italic"===t?"normal":"italic"}),this.updateFontStyleButton();})),this.nativeOn(i,"click",(()=>{const{underline:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({underline:!t}),this.updateFontStyleButton();})),this.nativeOn(s,"click",(()=>{const{strikeout:t}=this.stampBoard.signatureStyle;this.stampBoard.updateSignatureStyle({strikeout:!t}),this.updateFontStyleButton();}));const n=this.el.querySelectorAll(`.${this.defaultClass}-color-type span`),[o,r,a]=Array.from(n);this.nativeOn(o,"click",(()=>{this.selectColorType("background");})),this.nativeOn(r,"click",(()=>{this.selectColorType("border");})),this.nativeOn(a,"click",(()=>{this.selectColorType("text");}));const l=this.el.querySelector(`.${this.defaultClass}-color-container`);this.nativeOn(l,"click",(t=>{const e=t.target;if(!(e.dataset.color||e instanceof HTMLButtonElement))return;const i=(e instanceof HTMLButtonElement?e.parentNode:e).dataset.color;"background"===this.colorType?this.stampBoard.updateSignatureStyle({background:i}):"border"===this.colorType?this.stampBoard.updateSignatureStyle({borderColor:i}):this.stampBoard.updateSignatureStyle({color:i}),this.updateColorSelected();}));const h=this.el.querySelector(`.${this.defaultClass}-ok`);this.nativeOn(h,"click",(async t=>{const e=this.stampBoard.getStampConfig(),i=await this.stampBoard.getSignatureImage(),{options:s}=this.data,{autoDisplay:n}=s;this.$emit("ui_customStampCreated",{stampConfig:e,stampImage:i}),n&&this.togglePopup(!1);}));const c=this.el.querySelector(".ddv-button-close");this.nativeOn(c,"click",(t=>{this.togglePopup(!1);})),this.bindInputEvent(),this.bindToggleEvent(),this.bindSelectEvent();}bindInputEvent(){const t=this.el.querySelector(`.${this.defaultClass}-stamp-text input`);this.nativeOn(t,"input",(()=>{const e=t.value;this.stampBoard.updateSignatureStyle({stampText:e});}));const e=this.el.querySelectorAll(`.${this.defaultClass}-time-stamp input`),[i,s,n,o]=Array.from(e);this.nativeOn(i,"input",(()=>{const t=i.value;this.stampBoard.updateSignatureStyle({userName:t});})),this.nativeOn(s,"change",(()=>{this.stampBoard.updateSignatureStyle({hasUserName:s.checked});})),this.nativeOn(n,"change",(()=>{this.stampBoard.updateSignatureStyle({hasDate:n.checked});})),this.nativeOn(o,"change",(()=>{this.stampBoard.updateSignatureStyle({hasTime:o.checked});}));}bindSelectEvent(){const t=this.el.querySelector(".ddv-stamp-font-family"),e=t.querySelector(".ddv-stamp-font-family-select"),i=t.querySelector("p");this.nativeOn(e,"click",(t=>{t.stopPropagation(),this.toggleSelect(!1);const e=t.target.value;e&&(this.stampBoard.updateSignatureStyle({fontFamily:e}),i.innerText=e);}));}bindToggleEvent(){const t=this.el.querySelector(".ddv-stamp-font-family");this.nativeOn(t,"click",(t=>{t.stopPropagation(),this.toggleSelect();}));}toggleSelect(t){const e=this.el.querySelector(".ddv-stamp-font-family"),i=e.querySelector(".ddv-stamp-font-family-select"),s=e.querySelector(".ddv-down-arrow"),n="none"!==i.style.display,o=_s(t)?!n:t,r=this.injection.viewer.context.viewService.rootDom;n!==o&&(o?(i.style.display="block",i.style.top=`${Db(i,r)}px`,s.style.transform="rotate(180deg)"):(i.style.display="none",s.style.transform=""));}addFont(t){const e=this.el.querySelector(".ddv-stamp-font-family");if(this.fontList.includes(t))return;this.fontList.push(t);const i=e.querySelector(".ddv-stamp-font-family-select"),s=document.createElement("button");s.style.fontFamily=t,s.value=t,s.innerText=t,i.appendChild(s);}updateFontStyleButton(){const{fontStyle:t,fontWeight:e,underline:i,strikeout:s}=this.stampBoard.signatureStyle,n=this.el.querySelector(".ddv-bold"),o=this.el.querySelector(".ddv-italic"),r=this.el.querySelector(".ddv-underline"),a=this.el.querySelector(".ddv-line-through");Bb(n,"bold"===e,"light"),Bb(o,"italic"===t,"light"),Bb(r,i,"light"),Bb(a,s,"light");}getColorSelector(t){const{options:e}=this.data,{colorList:i}=e,s=document.createElement("div");let n=`<div class="${t}">`,o=0,r=!1;for(let e=0;e<i.length;e++){const a=i[e];if(s.style.background=a,""!==s.style.background){if(o>20)break;o+=1,n+=`<div data-color="${a}"><button style="background:${a}"></button></div>`,0!==o&&o%10==0&&(r=!1,n+="</div>",e!==i.length-1&&(r=!0,n+=`<div class="${t}">`)),s.style.background="";}}return r&&(n+="</div>"),s.remove(),n}selectColorType(t){if(t===this.colorType)return;const e=this.el.querySelectorAll(`.${this.defaultClass}-color-type span`),[i,s,n]=Array.from(e);this.colorType=t;[{element:i,type:"background"},{element:s,type:"border"},{element:n,type:"text"}].forEach((e=>{let{element:i,type:s}=e;s===t?(i.style.color="#3183c8",i.style.borderBottom="2px solid #3183c8"):(i.style.color="",i.style.borderBottom="");})),this.updateColorSelected();}updateColorSelected(){const{colorType:t}=this,{background:e,borderColor:i,color:s}=this.stampBoard.signatureStyle,n="background"===t?e:"border"===t?i:s,o=this.el.querySelectorAll(".ddv-custom-stamp-panel-color-container div");Array.from(o).forEach((t=>{t.style.border=t.dataset.color===n?"1px solid #aaa":"";}));}togglePopup(t){const e="none"!==this.el.style.display,i=_s(t)?!e:t;e!==i&&(this.el.style.display=i?"":"none",i||Wb(this.injection.viewer,!1));}initTemplate(){const{options:t}=this.data;Lb(Ob(this),this.injection.viewer,t),t.style={...t.style,display:"none"};const{hasUserName:e,hasDate:i,hasTime:s}=this.stampBoard.signatureStyle,n=`<div ${pb(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>${(null==t?void 0:t.title)||"Create New Stamp"}</span><div class="ddv-button ddv-button-close"></div></div><div class="${this.defaultClass}-content"><div class="${this.defaultClass}-canvas-container"></div><div class="${this.defaultClass}-stamp-text"><span>${t.labels.stampText}</span><input type="text" value="${this.stampBoard.signatureStyle.stampText}"/></div><div class="${this.defaultClass}-font-style"><span>${t.labels.fontStyle}</span><div style="margin-top: 10px; display: flex; justify-content: space-between">${this.getFontFamilySelectTemplate()}<div class="ddv-button ddv-bold"></div><div class="ddv-button ddv-italic"></div><div class="ddv-button ddv-underline"></div><div class="ddv-button ddv-line-through"></div></div></div><div class="${this.defaultClass}-time-stamp"><span>${t.labels.timeStampText}</span><div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;"><input type="text" value="${this.stampBoard.signatureStyle.userName}"/><label><input checked="${e?"checked":""}" type="checkbox"/>${t.labels.userName}</label><label><input checked="${i?"checked":""}" type="checkbox" />${t.labels.date}</label><label><input checked="${s?"checked":""}" type="checkbox" />${t.labels.time}</label></div></div><div class="${this.defaultClass}-color-picker"><div class="${this.defaultClass}-color-type"><span>${t.labels.backgroundColor}</span><span>${t.labels.borderColor}</span><span>${t.labels.textColor}</span></div><div class="${this.defaultClass}-color-container">${this.getColorSelector(`${this.defaultClass}-color-list`)}</div></div><div class="${this.defaultClass}-footer"><div class="${this.defaultClass}-ok">${t.labels.create}</div></div></div></div>`;this.template=n;}}i(BS,"cpName","AnnotationCustomStampPanel");class US extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;t.context.annotationEditService.applyTextSelectionToAnnotation(this.textAssistType),t.context.textSelectionService.clearSelectedTexts();}}),i(this,"textAssistType",void 0),this.textAssistType=e.textAssistType;}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}}class LS extends US{constructor(t){super(t,{class:"ddv-highlight-mode",textAssistType:"highlight"});}}class OS extends US{constructor(t){super(t,{class:"ddv-strikeout-mode",textAssistType:"strikeout"});}}class NS extends US{constructor(t){super(t,{class:"ddv-underline-mode",textAssistType:"underline"});}}class _S extends Hb{constructor(t){super(t,{class:"ddv-copy-text",callback:()=>{this.injection.viewer.copySelectedTexts(),this.$emit("ui_toolbarToggle");}});}bindHidePopup(){this.nativeOn(this.el,"click",(()=>{this.$emit("ui_hidePopup","AnnotationSet");}));}}class WS extends Hb{constructor(t){super(t,{class:"ddv-auto-capture",callback:()=>{const{viewer:t}=this.injection,{viewerMode:e}=t.getViewerConfig(),{enableAutoCapture:i}=t.getCameraConfig();e===lg.CAPTURE&&t.updateCameraConfig({enableAutoCapture:!i});}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()?t.getCameraConfig().enableAutoCapture?this.setUiState("focused",!$s()):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.autoCaptureChanged.on((t=>{const e=t.enableAutoCapture?"focused":"normal";this.setUiState(e,!$s());}),this),t.cameraPlayed.on((()=>{const{enableAutoCapture:t}=this.injection.viewer.getCameraConfig();this.setUiState(t?"focused":"normal",!$s());}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(WS,"cpName","AutoCapture");class FS extends Hb{constructor(t){super(t,{class:"ddv-auto-detect",callback:()=>{const{viewer:t}=this.injection,{viewerMode:e}=t.getViewerConfig(),{enableAutoDetect:i}=t.getCameraConfig();e===lg.CAPTURE&&t.updateCameraConfig({enableAutoDetect:!i});}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()&&t.context.core.detectorService.enableDetect?t.getCameraConfig().enableAutoDetect?this.setUiState("focused",!$s()):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.autoDetectChanged.on((t=>{const e=t.enableAutoDetect?"focused":"normal";this.setUiState(e,!$s());}),this),t.cameraPlayed.on((()=>{const{core:t}=this.injection.viewer.context;if(!t.detectorService.enableDetect)return;const{enableAutoDetect:e}=this.injection.viewer.getCameraConfig();this.setUiState(e?"focused":"normal",!$s());}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(FS,"cpName","AutoDetect");class HS extends Hb{constructor(t){super(t,{class:"ddv-capture-image",callback:()=>{if(this.isCapturing)return;const t=this.injection.viewer;this.isCapturing=!0,this.setUiState("disabled"),t.capture().finally((()=>{this.isCapturing=!1,this.setUiState("normal");}));}}),i(this,"isCapturing",!1),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{this.setUiState(this.injection.viewer.isVideoPlaying()?"normal":"disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.cameraPlayed.on((()=>{this.setUiState("normal");}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(HS,"cpName","Capture");class VS extends Hb{constructor(t){super(t,{class:"ddv-camera-flashlight",callback:()=>{const{viewer:t}=this.injection;t.cameraContext.turnOnTheTorch?t.turnOffTorch():t.turnOnTorch();}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const{viewer:t}=this.injection;t.isVideoPlaying()&&t.cameraContext.torchSupported?t.cameraContext.turnOnTheTorch?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){this.injection.viewer.hooks.torchChanged.on((t=>{switch(t.torchState){case"supported":case"off":this.setUiState("normal");break;case"on":this.setUiState("focused",!$s());break;default:this.setUiState("disabled");}}),this);}}i(VS,"cpName","Flashlight");class zS extends Hb{constructor(t){super(t,{class:"ddv-camera-convert",callback:()=>{const{viewer:t}=this.injection;t.cameraContext.convertCamera();}}),this.bindViewerHooks();}bindDefaultUi(){const t=()=>{const t=this.injection.viewer;t.isVideoPlaying()?this.setUiState(t.cameraContext.canFrontCamera?"normal":"disabled"):this.setUiState("disabled");};this.hooks.inserted.on(t),this.hooks.updated.on(t);}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.cameraPlayed.on((()=>{const t=this.injection.viewer.cameraContext.canFrontCamera;this.setUiState(t?"normal":"disabled");}),this),t.cameraClosed.on((()=>{this.setUiState("disabled");}),this);}}i(zS,"cpName","CameraConvert");const $S=[{label:" 720P",value:{width:1280,height:720}},{label:" 1080P",value:{width:1920,height:1080}},{label:" 1440P",value:{width:2560,height:1440}},{label:" 2160P",value:{width:3840,height:2160}}];class jS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-resolution"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"checkedClassName",`${this.cssPrefix}checkbox-checked`),i(this,"resolutionOptions",[]),i(this,"isFirstClick",!0),i(this,"fakeResolution",!1),i(this,"lastCheckIndex",0),i(this,"box",void 0),this.bindHooks(),this.initTemplate(),Rb(this);}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}box`),this.box.style.display="none",this.box.remove(),this.updateResolution(),this.bindEvents(),this.bindViewerHooks(),this.bindEventsEmitter(),Ib(this.el,!0);})),this.hooks.updated.on((()=>{this.box.style.display="none",this.isFirstClick=!0,this.injection.viewer.isVideoPlaying()||Ib(this.el,!0);}));}bindEvents(){const t=this.box.getElementsByTagName("ul")[0];this.nativeOn(this.el,"click",(()=>{const t=this.injection.viewer.rootDom;this.togglePopup(),this.isFirstClick&&(Ub(t,this.el,this.box),this.isFirstClick=!1);})),this.ulEvent(t);}ulEvent(t){t&&this.nativeOn(t,"click",(t=>{const e=this.injection.viewer,i=t.target,s=i.parentNode;if("LI"===i.tagName||"LI"===s.tagName){const t="LI"===i.tagName?i.value:s.value;if(t===this.lastCheckIndex)return;const{width:n,height:o}=this.resolutionOptions[t].value;this.fakeResolution=!0,e.setResolution(n,o).catch((t=>{ku.error(t);})),this.updateChecked(n,o);}this.togglePopup(!1);}));}bindViewerHooks(){const{viewer:t}=this.injection,{hooks:e}=t;e.cameraPlayed.on((t=>{if(Ib(this.el,!1),this.fakeResolution)return;const{width:e,height:i}=t.resolution;this.updateChecked(e,i),this.fakeResolution=!1;}),this),e.cameraClosed.on((()=>{Ib(this.el,!0);}),this),e.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}updateChecked(t,e){const i=function(t,e){let i=-1;const s=e.width*e.height;for(let e=0;e<t.length;e++){const{value:n}=t[e],o=n.width*n.height;if(0===e&&s<=o)return 0;if(e===t.length&&s>=o)return t.length-1;s>o&&(i=e+1);}return i}(this.resolutionOptions,{width:t,height:e}),{box:s,checkedClassName:n}=this,o=s.getElementsByClassName(`${this.cssPrefix}checkbox`)[i],r=s.getElementsByClassName(n)[0];o!==r&&(this.lastCheckIndex=i,null==o||o.classList.add(n),null==r||r.classList.remove(n));}initTemplate(){const{options:t}=this.data,{popupBox:e}=t;Lb(Ob(this),this.injection.viewer,t);const i=`<div ${pb(t,`${this.defaultClass} ddv-button`)}>`+(_s(null==t?void 0:t.label)?"":`<span>${t.label}</span>`)+'<i class="ddv-down-arrow"></i>'+`<div ${pb(e,this.cssPrefix,"box")}><ul></ul></div></div>`;this.template=i;}getOptionTemplate(){const{options:t}=this.data;let e=$S;if(Ls(null==t?void 0:t.valueList))e=t.valueList;else {const{CameraResolution_720P:t,CameraResolution_1080P:i,CameraResolution_1440P:s,CameraResolution_2160P:n}=eP.getDisplayTextConfig(),o=[t,i,s,n];e.forEach(((t,e)=>{o[e]&&(t.label=o[e]);}));}let i="";return e.forEach(((t,e)=>{const{width:s,height:n}=t.value;js(s)&&js(n)&&(i+=[`<li value="${e}">`,`<i class="${this.cssPrefix}checkbox"></i>`,`<span>${(null==t?void 0:t.label)||""}</span>`,"</li>"].join(""));})),this.resolutionOptions=e,i}updateResolution(){const t=this.getOptionTemplate();this.box.getElementsByTagName("ul")[0].innerHTML=t;}togglePopup(t){const{box:e}=this,{viewer:i}=this.injection;let s="none"!==e.style.display;s=_s(t)?!s:t,s?(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e)):e.remove(),Bb(this.el,s),e.style.display=s?"":"none";}}i(jS,"cpName","CameraResolution");class XS extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-image-preview"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"uiState",void 0),i(this,"image",void 0),i(this,"counter",void 0),i(this,"imagePageUid",void 0),i(this,"hasTask",!1),i(this,"isUpdateTask",!1),i(this,"lastPageUid",void 0),i(this,"pageTaskUids",[]),i(this,"currentTimer",void 0),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.created.on((t=>{this.setState("disabled"),this.bindViewerHooks(),this.bindEventsEmitter();})),this.hooks.inserted.on((t=>{this.image=this.el.getElementsByTagName("img")[0],this.counter=this.query(`.${this.cssPrefix}counter`);})),this.hooks.destroyed.on((()=>{var t;clearTimeout(this.currentTimer),null!=this&&this.image&&null!=this&&null!==(t=this.image)&&void 0!==t&&t.src&&URL.revokeObjectURL(this.image.src);}));}bindViewerHooks(){const t=this.injection.viewer,e=$s()?10:4;t.hooks.updatePage.on((async i=>{if(i.pageUid!==this.lastPageUid)return;if(this.hasTask)return this.pageTaskUids.push(i.pageUid),void(this.isUpdateTask=!0);this.hasTask=!0;const s=t.getPageCounts(),n=await t.getPerspectivePreviewImage(s-1,400,400,e);n&&(this.image.src&&URL.revokeObjectURL(this.image.src),this.image.src=Js(n.data).data),this.hasTask=!1,this.pageTaskUids.length>0&&this.createTask();}),this),t.hooks.pageChanged.on((async e=>{var i;if(0===e.total)return null!=this&&this.image&&null!=this&&null!==(i=this.image)&&void 0!==i&&i.src&&URL.revokeObjectURL(this.image.src),this.image.src="",this.setState("disabled"),this.imagePageUid=void 0,this.lastPageUid=void 0,void(this.pageTaskUids.length=0);if(null==this||!this.counter)return;this.counter.innerText=`${e.total}`;const s=t.getActiveTab();if(!s)return;const n=s.allPages[e.total-1].uid;this.pageTaskUids.push(n),this.hasTask||n!==this.lastPageUid&&this.createTask();}),this);}async createTask(){this.hasTask||(this.hasTask=!0,await this.updateImage(),this.currentTimer=setTimeout((()=>{this.hasTask=!1,0!==this.pageTaskUids.length&&this.createTask();}),300));}async updateImage(){var t;const e=this.injection.viewer;if(!e||!e.context)return;const i=e.getActiveTab(),s=$s()?10:4;if(!i)return;const n=i.allPages.length;if(!n)return;const o=this.pageTaskUids[this.pageTaskUids.length-1],r=i.allPages[n-1].uid;if(this.pageTaskUids.length=0,this.lastPageUid=i.allPages[n-1].uid,this.lastPageUid===o&&this.imagePageUid===o&&!this.isUpdateTask)return;let a;this.isUpdateTask&&(this.isUpdateTask=!1);try{a=await e.getPerspectivePreviewImage(n-1,400,400,s);}catch(t){}const l=e.getActiveTab(),h=(null==l||null===(t=l.allPages)||void 0===t?void 0:t.length)||0;this.image.src&&URL.revokeObjectURL(this.image.src),a&&!e.isDestroy&&l&&h&&(this.image.src=Js(a.data).data,this.imagePageUid=r,this.setState(h>0?"normal":"disabled"));}setState(t){this.uiState!==t&&this.el&&("normal"===t?(this.el.style.visibility="",this.el.style.pointerEvents=""):(this.el.style.visibility="hidden",this.el.style.pointerEvents="none"),this.uiState=t);}initTemplate(){const{options:t}=this.data,{imageCounter:e}=t,i=this.injection.viewer.getPageCounts();Lb(Ob(this),this.injection.viewer,t);const s=`<div ${pb(t,this.defaultClass)}> <img src=""></img><div ${pb(e,this.cssPrefix,"counter")}>${i}</div></div>`;this.template=s;}}i(XS,"cpName","ImagePreview");class GS extends Hb{constructor(t){super(t,{class:"ddv-load-image",callback:()=>{this.fileLoader.value=null,delete this.fileLoader.files,this.fileLoader.click();}}),i(this,"fileLoader",void 0),this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection;0!==(e.getPageCounts()||0)&&this.setUiState(t?"disabled":"normal");}));}createFileInput(){var t;const e=document.createElement("input");e.accept="image/png,image/jpeg,image/bmp,image/tiff,application/pdf",e.type="file",e.multiple=!0;const i={renderAnnotations:Ap.annotationLicenseModuleIsExist()?Pd.LOAD_ANNOTATIONS:Pd.NO_ANNOTATIONS},s="image"===this.injection.viewer.context.viewerConfig.renderingMode?Cd.CM_AUTO:Cd.CM_RENDERALL;return !0===(null===(t=this.injection.viewer)||void 0===t||null===(t=t.popupConfig)||void 0===t||null===(t=t.passwordLoaderConfig)||void 0===t?void 0:t.enabled)?this.nativeOn(e,"change",(async()=>{const{files:t}=e,n=t.length;for(let e=0;e<n;e++){const n=new Blob([t[e]],{type:t[e].type});await this.injection.viewer.context.core.isPdfEncrypted(n)?await new Promise((i=>{this.$emit("ui_showPasswordLoader",{blob:n,fileName:t[e].name,resolve:i});})):await this.injection.viewer.context.loadSource({fileData:n,convertMode:s,renderOptions:i});}e.value=null,e.files=null;})):this.nativeOn(e,"change",(()=>{const{files:t}=e,n=t.length,o=[];for(let e=0;e<n;e++){const n=new Blob([t[e]],{type:t[e].type});"application/pdf"===t[e].type?o.push({fileData:n,convertMode:s,renderOptions:i}):o.push({fileData:n});}this.injection.viewer.context.loadSource(o),e.value=null,e.files=null;})),e}bindHooks(){super.bindHooks(),this.hooks.inserted.on((()=>{const t=this.createFileInput();t.style.display="none",this.el.appendChild(t),this.fileLoader=t,this.nativeOn(t,"click",(t=>{t.stopPropagation();}));}));}bindDefaultUi(){this.injection.viewer.hooks.pageExistenceChanged.on((t=>{null!=t&&t.pageCount||this.setUiState("normal");}),this);}}i(GS,"cpName","Load");class YS extends Hb{constructor(t){super(t,{class:"ddv-delete-all",callback:()=>{this.injection.viewer.deleteAllPages();}}),Mb(this);}}i(YS,"cpName","DeleteAll");class qS extends Hb{constructor(t){super(t,{class:"ddv-delete-current",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.deletePages([e]);}}),Mb(this);}}function JS(t){try{t.dispatchEvent(new MouseEvent("click"));}catch(e){const i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(i);}}function ZS(t,e,i){if("download"in HTMLAnchorElement.prototype){const i=document.createElementNS("http://www.w3.org/1999/xhtml","a");e=e||t.name||"download",i.download=e,i.rel="noopener","string"==typeof t?(i.href=t,i.origin!==window.location.origin?function(t){const e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send();}catch(t){}return e.status>=200&&e.status<=299}(i.href)?function(t,e,i){const s=new XMLHttpRequest;s.open("GET",t),s.responseType="blob",s.onload=()=>{ZS(s.response,e);},s.onerror=()=>{},s.send();}(t,e):(i.target="_blank",JS(i)):JS(i)):(i.href=URL.createObjectURL(t),setTimeout((()=>{URL.revokeObjectURL(i.href),i.href="",i.remove();}),3e3),setTimeout((()=>{JS(i);}),0));}}i(qS,"cpName","DeleteCurrent");class QS extends Hb{constructor(t){super(t,{class:"ddv-button-download",callback:()=>{const t=this.injection.viewer,e=t.getActiveTab(),i=ku.buildInfo("save",{docUid:e.doc.uid,pageUids:e.doc.pages,current:0,total:e.doc.pages.length});ku.info(i),t.context.core.fileSaveService.saveToPdf(e.doc.pages,{mimeType:"application/octet-stream",saveAnnotation:Ap.annotationLicenseModuleIsExist()?"annotation":"none"},i).then((t=>{ZS(t,`${e.docName}.pdf`);})).catch((t=>{ku.error(t);}));}}),Eb(this);}}i(QS,"cpName","Download");class KS extends zb{constructor(t){const{Delete_DeleteCurrent:e,Delete_DeleteAll:i}=eP.getDisplayTextConfig(),{Delete_DeleteCurrent:s,Delete_DeleteAll:n}=Pb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"DeleteCurrent",label:e,id:s},{type:"DeleteAll",label:i,id:n}],defaultClassName:"ddv-delete-btn"},super(t),Mb(this);}}i(KS,"cpName","Delete");class tC extends Hb{constructor(t){super(t,{class:"ddv-print-page",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex(),i=t.getActiveTab(),{displayMode:s}=i.context;"single"===s?t.context.core.printPages(i.uid,[e]):t.context.core.printPages(i.uid);}}),Eb(this);}}i(tC,"cpName","Print");class eC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-password-loader"),i(this,"errorTimes",0),i(this,"fileData",null),i(this,"fileName",null),i(this,"loaderResolve",null),this.initTemplate(),this.bindHooks(),this.$on("ui_showPasswordLoader",(t=>{this.show(t.blob,t.fileName,t.resolve);}));}bindHooks(){this.hooks.inserted.on((t=>{this.bindEvents();}));}bindEvents(){const t=this.el.querySelector(".ddv-button-close"),e=this.el.querySelector(`.${this.defaultClass}-button`),i=this.el.querySelector(`.${this.defaultClass}-input`);i.addEventListener("input",(()=>{this.setErrorTimesVisible(!1);})),i.addEventListener("keydown",(t=>{"Enter"===t.key&&(t.preventDefault(),this.reloadFile());})),t.addEventListener("click",(()=>{this.loaderResolve&&(this.loaderResolve(),this.hide());})),e.addEventListener("click",(()=>{this.reloadFile();}));}show(t,e,i){const s=this.el.querySelector(`.${this.defaultClass}-input`);this.el.style.display="block",this.fileData=t,this.fileName=e,this.loaderResolve=i,this.updateFileInfo(),Wb(this.injection.viewer,!0),s.focus();}hide(){this.el.querySelector(`.${this.defaultClass}-input`).value="",this.el.style.display="none",this.fileData=null,this.fileName=null,this.loaderResolve=null,this.errorTimes=0,this.setErrorTimesVisible(!1),this.setErrorVisible(!1),Wb(this.injection.viewer,!1);}reloadFile(){if(!this.fileData)return;if(this.errorTimes>3)return void this.hide();const t=this.el.querySelector(`.${this.defaultClass}-input`),e={renderAnnotations:Ap.annotationLicenseModuleIsExist()?Pd.LOAD_ANNOTATIONS:Pd.NO_ANNOTATIONS},i="image"===this.injection.viewer.context.viewerConfig.renderingMode?Cd.CM_AUTO:Cd.CM_RENDERALL;this.injection.viewer.context.loadSource({fileData:this.fileData,convertMode:i,password:t.value,renderOptions:e},!0).then((()=>{this.loaderResolve(),this.hide();})).catch((()=>{3===this.errorTimes&&this.setErrorVisible(!0),this.setErrorTimesVisible(!0,3-this.errorTimes),this.errorTimes+=1;}));}updateFileInfo(){const t=this.el.querySelector(`.${this.defaultClass}-name`);t&&(t.innerText=` ${this.fileName} `);}setErrorTimesVisible(t,e){const i=this.el.querySelector(`.${this.defaultClass}-times`);i.style.display=t?"block":"none",t&&(i.innerText=`The password is incorrect. Remaining input times: ${e}`);}setErrorVisible(t){const e=this.el.querySelector(`.${this.defaultClass}-error`),i=this.el.querySelector(`.${this.defaultClass}-container`),s=this.el.querySelector(`.${this.defaultClass}-button`);e.style.display=t?"block":"none",i.style.display=t?"none":"block",s.innerText=t?"Ok":"Submit";}initTemplate(){const{options:t}=this.data;Lb(Ob(this),this.injection.viewer,t);const e=`<div ${pb(t,this.defaultClass,"")}><div class="${this.defaultClass}-header"><span>Password required</span><div class="ddv-button ddv-button-close"></div></div><div class="${this.defaultClass}-container"><span class="${this.defaultClass}-info">The<span class="${this.defaultClass}-name">file</span>has been encrypted. Please enter your password.</span><form style="width: 100%"><input autocomplete="off" type="password" class="${this.defaultClass}-input" /></form><span style="display:none" class="${this.defaultClass}-times">The password is incorrect. Remaining input times:3</span></div><div style="display:none" class="${this.defaultClass}-error"><span>Unable to load the document, too many attempts.</span></div><div class="${this.defaultClass}-button">OK</div></div>`;this.template=e;}}i(eC,"cpName","PasswordLoader");class iC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-search-result"),i(this,"searchedResult",[]),i(this,"bufferSize",3),i(this,"lastSearchUid",""),i(this,"lastSearchType",""),i(this,"lastSelectedTextUid",""),i(this,"isDirty",!1),i(this,"isFocusResultItem",!1),i(this,"startIndex",0),i(this,"endIndex",0),i(this,"titleIndex",[]),i(this,"renderDataArr",[]),i(this,"pageIndices",[]),i(this,"totalHeight",0),i(this,"domHightList",[]),i(this,"tempDiv",null),i(this,"container",null),i(this,"scrollTimer",null),i(this,"canScroll",!0),i(this,"getResultItemDom",(t=>{const e=this.renderDataArr[t],{length:i}=e.text,{startIndex:s,context:n}=e,o=n.substring(0,s),r=sC(n.substring(s,s+i)),a=sC(n.substring(s+i)),l=document.createElement("div");return l.dataset.textUid=e.textUid,l.className=`${this.defaultClass}-item`,l.innerHTML=`${o}<span>${r}</span>${a}`,l.addEventListener("click",(t=>{this.injection.viewer.selectSearchText(e.pageUid,e.textUid);})),l})),this.initTemplate(),this.bindHooks(),this.$on("ui_clearTextSearch",(()=>{this.resetSelf(),this.updateSearchResultCount();})),this.$on("ui_searchVisibilityChanged",(t=>{this.isDirty&&t&&(this.calculatePhantomHeight(),this.updateSearchResultCount(),this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid));})),this.$on("ui_swipeChanged",(t=>{t===this.el.parentNode&&setTimeout((()=>{this.isDirty&&(this.calculatePhantomHeight(),this.updateSearchResultCount()),this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid);}),250);})),this.tempDiv=document.createElement("div"),this.tempDiv.className=`${this.defaultClass}-item`;}bindHooks(){this.hooks.inserted.on((()=>{this.container=this.el.querySelector(`.${this.defaultClass}-container-body`),this.bindViewerHooks(),this.bindEvents();})),this.hooks.destroyed.on((()=>{this.tempDiv=null;}));}bindEvents(){const t=this.el.querySelector(`.${this.defaultClass}-prev`),e=this.el.querySelector(`.${this.defaultClass}-next`);this.nativeOn(t,"click",(()=>{this.injection.viewer.prevSearchText(),this.autoScrollToItem();})),this.nativeOn(e,"click",(()=>{this.injection.viewer.nextSearchText(),this.autoScrollToItem();})),this.nativeOn(this.container,"scroll",(()=>{this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid);})),$s()||(this.container.tabIndex=0,this.nativeOn(this.container,"focus",(()=>{this.injection.viewer.context.isFocusCanvas=!1;})),this.nativeOn(this.container,"blur",(()=>{this.isFocusResultItem=!1;})),this.nativeOn(this.container,"click",(t=>{this.container.focus(),this.injection.viewer.context.isFocusCanvas=!1,this.renderDataArr.length&&(t.target.classList.contains(`${this.defaultClass}-item`)||t.target.parentNode.classList.contains(`${this.defaultClass}-item`)?this.isFocusResultItem=!0:this.isFocusResultItem=!1);})),this.nativeOn(this.container,"keydown",(t=>{this.isFocusResultItem&&(t.preventDefault(),t.stopPropagation(),"ArrowDown"===t.key&&this.injection.viewer.nextSearchText(),"ArrowUp"===t.key&&this.injection.viewer.prevSearchText(),this.autoScrollToItem());})));}bindViewerHooks(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-content`);t.hooks.searchTextChanged.on((i=>{const s=t.getActiveTab(),n=this.container.offsetHeight,o=e.offsetHeight;this.pageIndices=[],this.searchedResult=i.searchResults,this.searchedResult.forEach((t=>{const e=s.uidToIndex(t.pageUid);this.pageIndices.push(e);}));const r=this.lastSearchUid!==i.searchUid||this.lastSearchType!==i.searchType||"single"===i.searchType||i.isEditPages;r&&(this.container.scrollTo({top:0}),this.domHightList=[],this.renderDataArr=[],this.titleIndex=[],this.lastSearchType=i.searchType,this.lastSearchUid=i.searchUid,this.totalHeight=0),0!==this.container.clientHeight?(this.calculatePhantomHeight(),this.updateSearchResultCount(),(r||o<n)&&(this.updateVisibleItems(),this.renderItem())):this.isDirty=!0;}),this),t.hooks.searchTextSelected.on((t=>{this.lastSelectedTextUid=t,this.selectResultItem(t);}),this),t.hooks.visibleChanged.on((t=>{this.isDirty&&"visible"===t.newVisibility&&(this.calculatePhantomHeight(),this.updateSearchResultCount(),this.updateVisibleItems(),this.renderItem(),this.selectResultItem(this.lastSelectedTextUid));}));}resetSelf(){this.searchedResult=[],this.renderDataArr=[],this.titleIndex=[],this.domHightList=[],this.totalHeight=0,this.calculatePhantomHeight();const t=this.el.querySelector(`.${this.defaultClass}-content`);t.style.transform="",t.innerHTML="";}autoScrollToItem(){if(!this.canScroll)return this.scrollTimer&&clearTimeout(this.scrollTimer),void(this.scrollTimer=setTimeout((()=>{this.performScroll(),this.scrollTimer=null;}),100));this.canScroll=!1,this.performScroll(),setTimeout((()=>{this.canScroll=!0;}),100);}performScroll(){const t=this.el.querySelector(`.${this.defaultClass}-container-body`);if(!t||!this.lastSelectedTextUid)return;let e=-1;for(let t=0;t<this.renderDataArr.length;t++){const i=this.renderDataArr[t];if(i&&i.textUid===this.lastSelectedTextUid){e=t;break}}if(-1===e)return;if(1===e)return void t.scrollTo({top:0,behavior:"smooth"});let i=0;for(let t=0;t<e;t++)i+=this.domHightList[t];const s=i+this.domHightList[e],n=t.scrollTop,o=n+t.clientHeight;i<n?t.scrollTo({top:i,behavior:"smooth"}):s>o&&t.scrollTo({top:s-t.clientHeight,behavior:"smooth"});}calculatePhantomHeight(){const t=this.el.querySelector(`.${this.defaultClass}-phantom`);for(let t=this.titleIndex.length;t<this.searchedResult.length;t++){const e=this.renderDataArr.length;this.titleIndex.push(e),this.renderDataArr.push(t),this.renderDataArr.push(...this.searchedResult[t].texts);for(let t=e;t<this.renderDataArr.length;t++)this.domHightList[t]=this.titleIndex.includes(t)?27:81,this.totalHeight+=this.domHightList[t];}t.style.height=`${this.totalHeight}px`;}updateVisibleItems(){const t=this.el.querySelector(`.${this.defaultClass}-container-body`);if(!t)return;const{scrollTop:e,clientHeight:i}=t;let s=0;const n=this.domHightList.map((t=>(s+=t)-t));let o=0;const r=this.findIndex(e,n),a=this.findIndex(e+i,n);this.isDirty=!1,this.startIndex=Math.max(0,r-this.bufferSize),this.endIndex=Math.min(this.renderDataArr.length,a+this.bufferSize);for(let t=0;t<this.startIndex;t++)o+=this.domHightList[t];this.el.querySelector(`.${this.defaultClass}-content`).style.transform=`translateY(${o}px)`;}renderItem(){const t=this.el.querySelector(`.${this.defaultClass}-content`),e=this.el.querySelector(`.${this.defaultClass}-phantom`);if(!t)return;t.innerHTML="";let i=0;for(let e=this.startIndex;e<this.endIndex;e++)if(this.titleIndex.includes(e)){const i=document.createElement("span");i.className=`${this.defaultClass}-split`,i.textContent=`Page ${this.pageIndices[this.titleIndex.indexOf(e)]+1}`,t.appendChild(i);}else {const s=this.getResultItemDom(e);t.appendChild(s);const n=this.domHightList[e],o=s.offsetHeight+5;this.domHightList[e]=o,i+=o-n;}i&&(this.totalHeight+=i,e.style.height=`${this.totalHeight}px`);}updateSearchResultCount(){const t=this.el.querySelector(`.${this.defaultClass}-count`);if(!t)return;const e=this.renderDataArr.length-this.titleIndex.length;t.textContent=1===e?`${e} result found`:`${e} results found`;}selectResultItem(t){const e=this.el.querySelector(`.${this.defaultClass}-content`);if(!e)return;const i=e.querySelectorAll(`.${this.defaultClass}-item`),s=`${this.defaultClass}-item-selected`;i.forEach((e=>{e.dataset.textUid===t?e.classList.add(s):e.classList.remove(s);}));}findIndex(t,e){let i=0,s=e.length-1;for(;i<=s;){const n=Math.floor((i+s)/2);e[n]<=t?i=n+1:s=n-1;}return i}async initTemplate(){const t=`<div class="${this.defaultClass}-container"><div class="${this.defaultClass}-container-header"><span class="${this.defaultClass}-count">0 results found</span><div style="display:flex; align-items: center;"><button class="${this.defaultClass}-prev"></button><button class="${this.defaultClass}-next"></button></div></div><div class="${this.defaultClass}-container-body"><div class="${this.defaultClass}-phantom"></div><div class="${this.defaultClass}-content"></div></div></div>`;this.template=t;}}function sC(t){return t.replace(/[&<>"']/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]||t)))}i(iC,"cpName","TextSearchResult");class nC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-search"),i(this,"clearBySelf",!1),this.initTemplate(),vb.registerComponent({TextSearchResult:iC}),this.bindHooks(),this.bindUiEvents();}bindUiEvents(){this.$on("ui_searchToggle",(()=>{var t;null!=this&&null!==(t=this.injection)&&void 0!==t&&t.viewer.getPageCounts()&&this.toggle();})),this.$on("ui_swipeHide",(t=>{t===this.el&&(this.toggle(),this.el.style.height="",this.el.style.top="");}));}toggle(){const t="none"!==getComputedStyle(this.el).display;if(this.el.style.display=t?"none":"flex",this.$emit("ui_searchVisibilityChanged",!t),t)$s()&&(this.el.style.height="",this.el.style.top="",this.$emit("ui_swipeReset",this.el));else {const t=this.el.querySelector(`.${this.defaultClass}-input`);this.injection.viewer.context.isFocusCanvas=!1,t.focus();}}bindHooks(){this.hooks.inserted.on((t=>{var e,i;this.bindEvents(),this.bindViewerHooks();const{options:s}=this.data,{postfix:n}=this.injection.viewer,o=null!==(e=s.defaultCaseSensitive)&&void 0!==e&&e,r=null!==(i=s.defaultWholeWord)&&void 0!==i&&i;o&&(this.el.querySelector(`#ddvCaseSensitive${n}`).checked=o),r&&(this.el.querySelector(`#ddvWholeWord${n}`).checked=r);if(this.injection.viewer.getPageCounts()>0){this.el.querySelector(`.${this.defaultClass}-header`).classList.remove("ddv-button-disabled");}}));}bindViewerHooks(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-header`),i=this.el.querySelector(`.${this.defaultClass}-input`),s=this.el.querySelector(`#ddvCaseSensitive${t.postfix}`),n=this.el.querySelector(`#ddvWholeWord${t.postfix}`);t.hooks.pageExistenceChanged.on((t=>{if(t.pageCount){e.classList.remove("ddv-button-disabled");const t="none"!==getComputedStyle(this.el).display;t&&this.$emit("ui_searchVisibilityChanged",t);}else e.classList.add("ddv-button-disabled"),this.$emit("ui_clearTextSearch"),i.value="";}),this),t.hooks.searchTextCleared.on((t=>{this.clearBySelf||!0!==t&&(this.$emit("ui_clearTextSearch"),i.value="");}),this),t.hooks.searchTextChanged.on((t=>{var e,o;i.value=t.text,s.checked=null===(e=t.searchConfig)||void 0===e?void 0:e.caseSensitive,n.checked=null===(o=t.searchConfig)||void 0===o?void 0:o.wholeWord;}),this);}bindEvents(){const{viewer:t}=this.injection,e=this.el.querySelector(`.${this.defaultClass}-input`),i=this.el.querySelector(`#ddvCaseSensitive${t.postfix}`),s=this.el.querySelector(`#ddvWholeWord${t.postfix}`),n=()=>{const n=e.value;n.length?t.searchFullText(n,{caseSensitive:i.checked,wholeWord:s.checked}):(this.clearBySelf=!0,this.injection.viewer.clearSearchText(),this.$emit("ui_clearTextSearch"),this.clearBySelf=!1);},o=()=>{e.value.length&&(this.clearBySelf=!0,this.injection.viewer.clearSearchText(),this.$emit("ui_clearTextSearch"),this.clearBySelf=!1,n());},r=t=>{var e;!0===(null==this||null===(e=this.injection)||void 0===e||null===(e=e.viewer)||void 0===e||null===(e=e.context)||void 0===e?void 0:e.isFocusCanvas)&&(t.ctrlKey||t.metaKey)&&"f"===t.key&&(t.preventDefault(),this.$emit("ui_searchToggle"));};e.addEventListener("input",n),i.addEventListener("change",o),s.addEventListener("change",o),document.addEventListener("keydown",r),this.hooks.destroyed.on((()=>{document.removeEventListener("keydown",r);}));}initTemplate(){var t,e,i;const{options:s}=this.data,{postfix:n}=this.injection.viewer;Lb(Ob(this),this.injection.viewer,s),delete s.label,delete s.tooltip;const o=null===(t=s.showCaseSensitive)||void 0===t||t,r=null===(e=s.showWholeWord)||void 0===e||e,a=null===(i=s.enableSwipeForMobile)||void 0===i||i,l=`<div ${pb(s,this.defaultClass,"")}>`+($s()&&a?"<SwipeIndicator></SwipeIndicator>":"")+`<div class="${this.defaultClass}-header ddv-button-disabled">`+`<div class="${this.defaultClass}-input-container"><i class="ddv-icon-search"></i>`+`<input type="search" class="${this.defaultClass}-input" /></div>`+`<label ${o?"":'style="display:none"'} for="ddvCaseSensitive${n}" >`+`<input id="ddvCaseSensitive${n}" type="checkbox"/>Case sensitive</label>`+`<label ${r?"":'style="display:"none""'} for="ddvWholeWord${n}" >`+`<input id="ddvWholeWord${n}" type="checkbox"/>Whole word</label></div>`+`<div class="${this.defaultClass}-split-line"></div><TextSearchResult></TextSearchResult></div>`;this.template=l;}}i(nC,"cpName","TextSearchPanel");class oC extends Hb{constructor(t){super(t,{class:"ddv-search-switch",callback:()=>{this.$emit("ui_searchToggle");}}),this.bindUiEvents();}bindUiEvents(){const t=$s();this.$on("ui_searchVisibilityChanged",(e=>{this.setUiState(e?"focused":"normal",!t);})),$s()&&this.$on("ui_cropClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts()||0;(t||i)&&(this.el.classList.contains("ddv-button-focused")&&this.$emit("ui_searchToggle"),Ib(this.el,t));})),Eb(this);}}i(oC,"cpName","TextSearchPanelSwitch");class rC extends Hb{constructor(t){super(t,{class:"ddv-crop-current",callback:()=>{this.cropEvent();}});}bindDefaultUi(){aC(this);}cropEvent(){const t=this.injection.viewer,e=t.getRectBox(),i=t.getCurrentPageIndex();e&&t.cropPages(e,[i]);}}function aC(t){const e=t.injection.viewer,i=i=>{const s=_s(null==i?void 0:i.pageCount)?e.getPageCounts():i.pageCount,n=e.getRectBox();s&&n?t.setUiState("normal"):t.setUiState("disabled");};t.hooks.inserted.on(i),t.hooks.updated.on(i),e.hooks.pageExistenceChanged.on(i,t),e.hooks.cropRectDrawn.on((e=>{t.setUiState("normal");}),t),e.hooks.cropRectDeleted.on((e=>{t.setUiState("disabled");}),t);}i(rC,"cpName","CropCurrent");class lC extends Hb{constructor(t){super(t,{class:"ddv-crop-all",callback:()=>{this.cropEvent();}});}bindDefaultUi(){aC(this);}cropEvent(){const{viewer:t}=this.injection,e=t.getRectBox(),i=t.getCropIndices();e&&t.cropPages(e,i);}}i(lC,"cpName","CropAll");class hC extends Hb{constructor(t){super(t,{class:"ddv-perspective",callback:()=>{this.perspectiveEvent();}});}perspectiveEvent(){const{viewer:t}=this.injection;t.perspectiveAllPage();}}i(hC,"cpName","PerspectiveAll");class cC extends Hb{constructor(t){super(t,{class:"ddv-full-quad",callback:()=>{this.toggleFull();}}),this.bindViewerHooks();}toggleFull(){const{viewer:t}=this.injection;t.toggleFullPerspective();}bindViewerHooks(){const{hooks:t}=this.injection.viewer;t.perspectiveQuadChanged.on((t=>{this.isFocused=t.isFull||!1,this.setUiState(t.isFull?"focused":"normal",!$s());}),this);}}i(cC,"cpName","FullQuad");class dC extends Hb{constructor(t){super(t,{class:"ddv-redo-page",callback:()=>{this.injection.viewer.redo();}}),this.$on("ui_cropClick",(()=>{const t=this.injection.viewer.getOperationState().redo>0?"normal":"disabled";this.setUiState(t);}));}bindDefaultUi(){uC("redo",this);}}function uC(t,e){const{viewer:i}=e.injection,s=()=>{const s=i.getOperationState(),n=("redo"===t?s.redo:s.undo)>0?"normal":"disabled";e.setUiState(n);};e.hooks.inserted.on(s),e.hooks.updated.on(s);i.hooks.operationsChanged.on((i=>{let s="disabled";s="redo"===t?i.redo>0?"normal":"disabled":i.undo>0?"normal":"disabled",e.setUiState(s);}),e),i.hooks.pageExistenceChanged.on((t=>{0===t.pageCount&&e.setUiState("disabled");}),e);}i(dC,"cpName","Redo");class pC extends Hb{constructor(t){super(t,{class:"ddv-restore-page",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.reset(e);}}),Mb(this);}}i(pC,"cpName","Restore");class gC extends Hb{constructor(t){super(t,{class:"ddv-rotate-left",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.rotatePages(-90,[e]);}}),Mb(this);}}i(gC,"cpName","RotateLeft");class fC extends Hb{constructor(t){super(t,{class:"ddv-rotate-right",callback:()=>{const{viewer:t}=this.injection,e=t.getCurrentPageIndex();t.rotatePages(90,[e]);}}),Mb(this);}}i(fC,"cpName","RotateRight");class vC extends Hb{constructor(t){super(t,{class:"ddv-undo-page",callback:()=>{this.injection.viewer.undo();}}),this.$on("ui_cropClick",(()=>{const t=this.injection.viewer.getOperationState().undo>0?"normal":"disabled";this.setUiState(t);}));}bindDefaultUi(){uC("undo",this);}}i(vC,"cpName","Undo");class mC extends Vb{constructor(t){super(t),this.defaultClass="ddv-crop",this.initPullDownBox(),this.initTemplate(),this.initHooks(),this.$on("ui_layoutScroll",(t=>{if(t===this.el.parentElement){Ub(this.injection.viewer.rootDom,this.el,this.pullDownBox);}}));}initHooks(){const t=this.injection.viewer;t.hooks.toolModeChanged.on((t=>{const e="crop"===t.newToolMode;this.injection.viewer.getPageCounts()>0&&(this.setUiState(e?"focused":"normal"),this.togglePopup(e),this.isFirstClick&&e&&this.el.click()),this.$emit("ui_cropClick",e);}),this),t.hooks.cropRectDrawn.on((()=>{Ib(this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1],!1);}),this),t.hooks.pageChanged.on((()=>{Ib(this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1],!this.injection.viewer.getRenderedRectBoxCount());}),this);}bindPullDownBoxEvents(){const{viewer:t}=this.injection,e=this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`),i=this.pullDownBox.getElementsByTagName("input")[1],s=this.pullDownBox.getElementsByTagName("input")[0],n=e.children[0],o=e.children[1],r=()=>{this.togglePopup(!1),t.updateViewerConfig({toolMode:"pan",canvasStyle:{cursor:"default"}});};this.nativeOn(o,"click",(()=>{const e=t.getRectBox(),i=t.getCropIndices();e&&(t.cropPages(e,i),r());})),this.nativeOn(n,"click",r),this.nativeOn(this.el,"click",(()=>{const e=t.rootDom,i=this.pullDownBox.querySelector(`.${this.defaultClass}-buttonGroup`).children[1];t.updateViewerConfig({toolMode:"crop"}),this.togglePopup(!0),this.setUiState("focused"),this.$emit("ui_cropClick",!0);Ib(i,!t.getRectBox()),this.isFirstClick&&(Ub(e,this.el,this.pullDownBox),this.isFirstClick=!1);})),this.nativeOn(i,"change",(()=>{t.cropMode="all";})),this.nativeOn(s,"change",(()=>{t.cropMode="current";}));}bindPopupSwitchEvent(){}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{toolMode:e}=t.getViewerConfig();let i="disabled";t.getPageCounts()>0?("crop"===e&&this.el.click(),i=""===this.pullDownBox.style.display?"focused":"normal"):this.togglePopup(!1),this.setUiState(i);};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){this.injection.viewer.hooks.cropModeChanged.on((t=>{const{newCropMode:e}=t,i=this.pullDownBox.getElementsByTagName("input")[1],s=this.pullDownBox.getElementsByTagName("input")[0];i.checked="all"===e,s.checked="current"===e;}),this);}initTemplate(){const{defaultClass:t}=this,{options:e}=this.data,{popupBox:i}=e,{postfix:s,cropMode:n}=this.injection.viewer,{Crop_CropCurrent:o,Crop_CropAll:r,Crop_CropApply:a,Crop_CropCancel:l}=eP.getDisplayTextConfig(),{Crop_CropCurrent:h,Crop_CropAll:c,Crop_CropApply:d,Crop_CropCancel:u}=Pb,p="current"===n?'checked="checked"':"",g="all"===n?'checked="checked"':"";Lb(Ob(this),this.injection.viewer,e);const f=`<button ${pb(e,`ddv-button ${t}`)}>`+(_s(null==e?void 0:e.label)?"":`<span>${e.label}</span>`)+`<div ${pb(i,`${t}-box`)}><div>`+`<input ${p} type="radio" id="${h+s}" name="cropType" value="cropCurrent" />`+`<label for="${h+s}">${o}</label>`+`<input ${g} type="radio" id="${c+s}" name="cropType" value="cropAll" />`+`<label for="${c+s}">${r}</label></div>`+`<div class= "${t}-buttonGroup">`+`<div id="${u+s}"><span>${l}</span></div>`+`<div id="${d+s}"><span>${a}</span></div></div></div></button>`;this.template=f;}}i(mC,"cpName","Crop");class yC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-filter-item"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"checkedClass",`${this.cssPrefix}checked`),this.initTemplate(),this.bindHooks();}bindHooks(){this.hooks.created.on((t=>{this.bindEvents();})),this.hooks.inserted.on((()=>{this.bindFilterEvents();})),this.hooks.destroyed.on((()=>{const t=this.el.getElementsByTagName("img")[0];t.src&&URL.revokeObjectURL(t.src);}));}bindEvents(){const{el:t}=this;this.nativeOn(t,"click",(()=>{if(""===this.el.getElementsByTagName("img")[0].getAttribute("src"))return;const{itemValue:t}=this.data;this.$emit("ui_filterClick",t.type);}));}bindFilterEvents(){this.$on("ui_filterReset",(t=>{this.resetSelect(t.currentFilter);const{filterList:e}=t,{itemValue:i}=this.data,s=this.el.getElementsByTagName("img")[0];s.src&&URL.revokeObjectURL(s.src),e.forEach((t=>{if(t.type===i.type){let e="";t.imageData&&(e=Js(t.imageData).data),s.src=e;}}));})),this.$on("ui_filterLoading",(t=>{const e=this.el.getElementsByTagName("img")[0],i=this.el.getElementsByTagName("div")[0];e.style.display=t?"none":"",i.style.display=t?"":"none",this.el.style.pointerEvents=t?"none":"";})),this.injection.viewer.hooks.filterChanged.on((t=>{this.resetSelect(t.filterType);}),this);}resetSelect(t){const{itemValue:e}=this.data;t===e.type?this.el.classList.add(this.checkedClass):this.el.classList.remove(this.checkedClass);}initTemplate(){const{options:t,itemValue:e}=this.data,i=`<div ${pb(t,this.defaultClass)}><img src=""></img><div class="ddv-filter-loading" style="display:none"></div><span>${e.label}</span></div>`;this.template=i;}}const xC=[{type:"none",label:"Original"}];class wC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-filter"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"isFirstClick",!0),i(this,"box",void 0),i(this,"applyAll",!1),i(this,"filterList",void 0),i(this,"filterUpdateStatus",!1),i(this,"enableFilter",!1),i(this,"uiState","normal"),this.bindHooks(),this.initTemplate(),this.bindDefaultUi(),Rb(this);const{filterService:e}=this.injection.viewer.context.core;e.enableFilter&&(this.enableFilter=!0,Mb(this),this.bindViewerHooks(),this.bindFilterEvents(),this.bindViewerResized()),vb.registerComponent({FilterItem:yC}),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}list`),this.box.style.display="none",this.box.remove(),this.filterUpdateStatus=!0,this.bindNativeEvents();})),this.hooks.updated.on((()=>{this.uiState="normal";}));}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{box:t}=this,e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:Ub(i,this.el,this.box);}),this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.pageChanged.on((async e=>{if(0===e.total)return this.filterUpdateStatus=!0,void this.togglePopup(!1);const i=t.context.getActiveTab();if(!i||!this.box)return;const{currentUid:s,oldCurrentUid:n}=i;n!==s&&(this.filterUpdateStatus=!0,this.togglePopup(!1));}),this),t.hooks.updatePage.on((e=>{var i;const s=t.context.getActiveTab();s&&this.box&&(null===(i=s.getCurrentPage())||void 0===i?void 0:i.uid)===e.pageUid&&(this.filterUpdateStatus=!0,this.togglePopup(!1));}),this),t.hooks.visibleChanged.on((t=>{"hidden"===t.newVisibility&&this.togglePopup(!1);}),this);}bindNativeEvents(){const{el:t,box:e}=this,i=e.querySelector(`.${this.cssPrefix}list-header`),s=i.getElementsByTagName("span")[0],n=i.getElementsByTagName("div")[0];this.nativeOn(t,"click",(async t=>{if(this.togglePopup(),this.isFirstClick){Ub(this.injection.viewer.rootDom,this.el,this.box),this.isFirstClick=!1;}})),this.nativeOn(e,"click",(t=>{t.stopPropagation();})),this.nativeOn([s,n],"click",(()=>{if(this.clickApplyToAll(),this.applyAll){const{viewer:t}=this.injection,e=t.getPageCounts(),i=t.getCurrentPageUid(),s=t.context.core.pageService.getPage(i);t.filter(Array.from(Array(e).keys()),s.filter);}}));}bindFilterEvents(){this.$on("ui_filterClick",(t=>{const{viewer:e}=this.injection,i=e.getPageCounts();if(i<1)return;let s=Array.from(Array(i).keys());if(!this.applyAll){const i=e.getCurrentPageUid();if(e.context.core.pageService.getPage(i).filter===t)return;s=[e.getCurrentPageIndex()];}e.filter(s,t);}));}clickApplyToAll(t){const e=this.injection.viewer,i=Pb.Filter_FilterAll+e.postfix,s=document.getElementById(i);if(_s(t))return this.applyAll?s.classList.remove(`${this.cssPrefix}checked`):s.classList.add(`${this.cssPrefix}checked`),void(this.applyAll=!this.applyAll);t?s.classList.add(`${this.cssPrefix}checked`):s.classList.remove(`${this.cssPrefix}checked`),this.applyAll=t;}async updateFilterPreview(){const t=this.injection.viewer,e=t.getCurrentPageUid(),i=await t.context.core.imageDataService.getOriginal(e);if(!i)return;this.$emit("ui_filterLoading",!0);const s=[],n=t.context.core.pageService.getPage(e);let o;try{o=await t.context.core.processService.resize(i.data,3,i.width,i.height,200);}catch(t){}for(let e=0;e<this.filterList.length;e++){const n=this.filterList[e];if("none"===n.type)s.push({type:"none",imageData:i.data});else {let e;try{var r;o&&null!==(r=o)&&void 0!==r&&r.data&&(e=await t.context.core.filterService.applyFilter({data:o.data,type:uo.JPEG,width:o.width,height:o.height},n.type));}catch(t){e=null;}s.push({type:n.type,imageData:e});}}this.$emit("ui_filterLoading",!1),this.$emit("ui_filterReset",{currentFilter:n.filter||"none",filterList:s}),this.filterUpdateStatus=!1;}initTemplate(){var t;const e=this.data,{options:i}=e,{popupBox:s,filterHeader:n,filterContent:o,valueList:r}=i,{filterService:a}=this.injection.viewer.context.core,l=Pb.Filter_FilterAll+this.injection.viewer.postfix;Lb(Ob(this),this.injection.viewer,i);const h=(null===(t=eP.getDisplayTextConfig())||void 0===t?void 0:t.Filter_FilterAll)||"Apply to All";e.valueList=r||xC,a.enableFilter&&(e.valueList=a.getSupportedFilters()),this.filterList=e.valueList;const c=`<button ${pb(i,`ddv-button ${this.defaultClass}`)}>`+(_s(null==i?void 0:i.label)?"":`<span>${i.label}</span>`)+'<i class="ddv-down-arrow"></i>'+`<div ${pb(s,this.cssPrefix,"list")}>`+`<div id="${l}"`+`${pb(n,this.cssPrefix,"list-header")}><div></div>`+`<span>${h}</span></div>`+`<div ${pb(o,this.cssPrefix,"list-content")}><FilterItem :for="item in valueList":options="options.filterItem" :itemValue="item"></FilterItem></div></div></button>`;this.template=c;}async togglePopup(t){const{box:e}=this,{viewer:i}=this.injection;let s="none"===e.style.display;s=_s(t)?!s:!t,s?e.remove():(this.$emit("ui_hidePopup",this),i.rootDom.appendChild(e),this.filterUpdateStatus&&this.updateFilterPreview()),Bb(this.el,!s),e.style.display=s?"none":"";}bindDefaultUi(){const t=this.injection.viewer,e=()=>{let e="normal";0!==t.getPageCounts()&&this.enableFilter||(e="disabled"),Fb(this,t)&&(e="disabled"),_b(this,e);};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(wC,"cpName","Filter");class bC extends Hb{constructor(t){super(t,{class:"ddv-button-blank",callback:()=>{}});}bindDefaultUi(){}}class SC extends Hb{constructor(t){super(t,{class:"ddv-button-close",callback:()=>{}});}bindDefaultUi(){}}i(SC,"cpName","Close");class CC extends Hb{constructor(t){super(t,{class:"ddv-button-back",callback:()=>{}});}bindDefaultUi(){}}i(CC,"cpName","Back");class PC extends Hb{constructor(t){super(t,{class:"ddv-button-done",callback:()=>{}});}bindDefaultUi(){}}i(PC,"cpName","Done");const TC=[{displayName:"continuous",className:"ddv-continuous-mode"},{displayName:"single",className:"ddv-single-mode"}];class AC extends zb{constructor(t){const{DisplayMode_ContinuousPage:e,DisplayMode_SinglePage:i}=eP.getDisplayTextConfig(),{DisplayMode_ContinuousPage:s,DisplayMode_SinglePage:n}=Pb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"ContinuousPage",label:e,id:s},{type:"SinglePage",label:i,id:n}],defaultClassName:"ddv-display-mode"},super(t),Mb(this);}updateUiState(t){const{el:e}=this;TC.forEach(((i,s)=>{t===i.displayName?(e.classList.add(i.className),this.selectChildren(s)):e.classList.remove(i.className);}));}bindDefaultUi(){super.bindDefaultUi();const t=this.injection.viewer,e=()=>{const{displayMode:e}=t.getViewerConfig(),i=t.context.getActiveTab();i?this.updateUiState(i.context.displayMode):this.updateUiState(e);};t.hooks.displayModeChanged.on((t=>{this.updateUiState(t.newDisplayMode);}),this),t.hooks.openDocument.on((()=>{const e=t.context.getActiveTab();e&&this.updateUiState(e.context.displayMode);}),this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(AC,"cpName","DisplayMode");class kC extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{this.injection.viewer.updateViewerConfig({displayMode:e.displayMode});}}),i(this,"displayMode",void 0),this.displayMode=e.displayMode,Mb(this);}bindDefaultUi(){const t=this.injection.viewer,e=e=>{var i;const s=t.getActiveTab(),n=(null==e?void 0:e.pageCount)||t.getPageCounts(),o=(null==s||null===(i=s.context)||void 0===i?void 0:i.displayMode)||t.getViewerConfig().displayMode;n?o===this.displayMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.displayModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class DC extends kC{constructor(t){super(t,{class:"ddv-continuous-mode",displayMode:"continuous"});}}i(DC,"cpName","ContinuousPage");class RC extends kC{constructor(t){super(t,{class:"ddv-multiple-mode",displayMode:"multiple"});}}i(RC,"cpName","MultiPage");class EC extends kC{constructor(t){super(t,{class:"ddv-single-mode",displayMode:"single"});}}i(EC,"cpName","SinglePage");const MC=[{displayName:"window",className:"ddv-fit-window"},{displayName:"width",className:"ddv-fit-width"},{displayName:"height",className:"ddv-fit-height"},{displayName:"actualSize",className:"ddv-fit-actual"}];class IC extends zb{constructor(t){const{FitMode_FitWindow:e,FitMode_FitWidth:i,FitMode_FitHeight:s,FitMode_ActualSize:n}=eP.getDisplayTextConfig(),{FitMode_FitWindow:o,FitMode_FitWidth:r,FitMode_FitHeight:a,FitMode_ActualSize:l}=Pb;t.data.options={showCheckIcon:!0,showDropDownArrow:!0,...t.data.options,children:[{type:"FitWindow",label:e,id:o},{type:"FitWidth",label:i,id:r},{type:"FitHeight",label:s,id:a},{type:"ActualSize",label:n,id:l}],defaultClassName:"ddv-fit-type"},super(t),Mb(this);}updateUiState(t){const{el:e}=this;if("none"===t)return this.selectChildren(-1),MC.forEach((t=>{e.classList.remove(t.className);})),void e.classList.add(MC[0].className);MC.forEach(((i,s)=>{t===i.displayName?(e.classList.add(i.className),this.selectChildren(s)):e.classList.remove(i.className);}));}bindDefaultUi(){super.bindDefaultUi();const t=this.injection.viewer,e=()=>{const{fitMode:e}=t.getViewerConfig();this.updateUiState(e);};t.hooks.fitModeChanged.on((t=>{this.updateUiState(t.newFitMode);}),this),t.hooks.openDocument.on((()=>{const e=t.context.getActiveTab();e&&this.updateUiState(e.context.fitMode);}),this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}i(IC,"cpName","FitMode");class BC extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{const{viewer:t}=this.injection;t.updateViewerConfig({fitMode:e.fitMode});}}),i(this,"fitMode",void 0),this.fitMode=e.fitMode,Mb(this);}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const e=t.getPageCounts(),i=t.getActiveTab();let{fitMode:s}=t.getViewerConfig();i&&(s=i.context.fitMode);const n=e>0&&s===this.fitMode;e>0?n?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),t.hooks.fitModeChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}}class UC extends BC{constructor(t){super(t,{class:"ddv-fit-height",fitMode:"height"});}}i(UC,"cpName","FitHeight");class LC extends BC{constructor(t){super(t,{class:"ddv-fit-width",fitMode:"width"});}}i(LC,"cpName","FitWidth");class OC extends BC{constructor(t){super(t,{class:"ddv-fit-window",fitMode:"window"});}}i(OC,"cpName","FitWindow");class NC extends BC{constructor(t){super(t,{class:"ddv-fit-actual",fitMode:"actualSize"});}}i(NC,"cpName","ActualSize");class _C extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-main-canvas"),this.initTemplate(),this.bindHooks(),this.bindViewerHooks();}bindHooks(){const{inserted:t}=this.hooks;t.on((()=>{var t;null===(t=this.injection.viewer)||void 0===t||t.context.viewService.bindContainer(this.el);}));}bindViewerHooks(){this.injection.viewer.hooks.toolModeChanged.on((()=>{this.$emit("ui_toolModeRefactor");}),this);}initTemplate(){const{options:t}=this.data;t.id=t.id||`ddvMainView${this.injection.viewer.postfix}`;const e=`<div ${pb(t,this.defaultClass,"")} ><slot></slot></div>`;this.template=e;}}i(_C,"cpName","MainView");class WC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-pagination"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"uiState","normal"),i(this,"input",void 0),i(this,"totalSpan",void 0),this.initTemplate(),this.bindHooks(),this.bindDefaultUi();}bindHooks(){this.hooks.created.on((t=>{this.bindEvents(),this.input=this.query(`.${this.cssPrefix}goto`),this.totalSpan=this.query(`.${this.cssPrefix}total`);}));}bindEvents(){const t=this.injection.viewer,e=this.query(`.${this.cssPrefix}goto`);this.nativeOn(e,"input",(t=>{const i=Nb(e),s=Math.min(i,this.totalSpan.clientWidth);e.style.width=`${s}px`;})),this.nativeOn(e,"blur",(()=>{const i=t.getPageCounts(),s=t.getCurrentPageIndex();let n=parseInt(e.value,10);js(n)?n<1?n=1:n>i&&(n=i):n=s+1,e.value=`${n}`,e.style.width=`${Nb(e)}px`,t.gotoPage(n-1);})),this.nativeOn(e,"keydown",(t=>{t.stopPropagation(),"Enter"===t.key&&e.blur();}));}setState(t){this.uiState!==t&&this.el&&("normal"===t?this.el.classList.remove(`${this.cssPrefix}disabled`):this.el.classList.add(`${this.cssPrefix}disabled`),this.uiState=t);}bindDefaultUi(){const t=this.injection.viewer,e=e=>{const i=_s(null==e?void 0:e.total)?t.getPageCounts():null==e?void 0:e.total,s=_s(null==e?void 0:e.current)?t.getCurrentPageIndex():null==e?void 0:e.current;this.setState(i>0?"normal":"disabled"),this.input.value=`${s+1}`,this.totalSpan.innerText=`${i}`,this.input.style.width=`${Nb(this.input)}px`;};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on((()=>{this.uiState="normal",e(null);}));}initTemplate(){const{options:t}=this.data,{gotoPage:e,total:i,separator:s}=t,{cssPrefix:n,injection:o,defaultClass:r}=this,{viewer:a}=o,l=a.getCurrentPageIndex()+1,h=a.getPageCounts(),c=`<div ${pb(t,r,"")}><FirstPage :options="options.firstPage"></FirstPage><PrevPage :options="options.prevPage"></PrevPage><input ${pb(e,n,"goto")} value="${l}" type="number" ><div ${pb(s,n,"separator")}></div><span ${pb(i,n,"total")} >${h}</span><NextPage :options="options.nextPage"></NextPage><LastPage :options="options.lastPage"></LastPage></div>`;this.template=c;}}i(WC,"cpName","Pagination");class FC extends Hb{constructor(t,e){super(t,{class:e.class,callback:e.callback}),i(this,"type",void 0),this.type=e.type;}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const e=t.getPageCounts(),i=t.getCurrentPageIndex();let s=!1;switch(this.type){case"previous":case"first":s=e>0&&0!==i;break;case"last":case"next":s=i<e-1;}0===e&&(s=!1),this.setUiState(s?"normal":"disabled");};this.hooks.inserted.on(e),this.hooks.updated.on(e),t.hooks.pageChanged.on(e,this);}}class HC extends FC{constructor(t){super(t,{class:"ddv-first-page",type:"first",callback:()=>{this.injection.viewer.gotoPage(0);}});}}i(HC,"cpName","FirstPage");class VC extends FC{constructor(t){super(t,{class:"ddv-last-page",type:"last",callback:()=>{const t=this.injection.viewer,e=t.getPageCounts();t.gotoPage(e-1);}});}}i(VC,"cpName","LastPage");class zC extends FC{constructor(t){super(t,{class:"ddv-next-page",type:"next",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.gotoPage(e+1);}});}}i(zC,"cpName","NextPage");class $C extends FC{constructor(t){super(t,{class:"ddv-prev-page",type:"previous",callback:()=>{const t=this.injection.viewer,e=t.getCurrentPageIndex();t.gotoPage(e-1);}});}}i($C,"cpName","PrevPage");class jC extends Hb{constructor(t){super(t,{class:"ddv-thumbnail-switch",callback:()=>{const{thumbnail:t}=this;if(!t)return;const{visibility:e}=t.getViewerConfig();t.updateViewerConfig({visibility:"visible"===e?"hidden":"visible"});}}),i(this,"thumbnail",void 0),this.injection.viewer.on("thumbnailBind",(t=>{if(this.thumbnail)return;const e=this.injection.viewer.context.core.getViewer(t);e&&(this.thumbnail=e,this.bindThumbnailHooks(e));const{visibility:i}=e.getViewerConfig();this.setUiState("visible"===i?"focused":"normal",!$s());})),this.injection.viewer.hooks.destroy.on((()=>{this.thumbnail=null;}),this);}bindThumbnailHooks(t){t.hooks.visibleChanged.on((t=>{this.setUiState("visible"===t.newVisibility?"focused":"normal",!$s());}),this);}bindDefaultUi(){const t=()=>{if(!this.thumbnail)return;const{visibility:t}=this.thumbnail.getViewerConfig();this.setUiState("visible"===t?"focused":"normal",!$s());};this.injection.viewer.hooks.pageExistenceChanged.on(t,this),this.hooks.updated.on(t);}}i(jC,"cpName","ThumbnailSwitch");class XC extends Hb{constructor(t,e){super(t,{class:e.class,callback:()=>{const t=this.injection.viewer;$s()&&this.el.classList.contains("ddv-button-focused")&&"textSelection"===this.toolMode?t.updateViewerConfig({toolMode:"pan"}):t.updateViewerConfig({toolMode:e.toolMode});}}),i(this,"toolMode",void 0),this.toolMode=e.toolMode,this.bindViewerHooks();}bindDefaultUi(){const t=this.injection.viewer,e=()=>{const{toolMode:e}=t.getViewerConfig();t.getPageCounts()>0?e===this.toolMode?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");};t.hooks.pageExistenceChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.toolModeChanged.on((e=>{const i=e.newToolMode===this.toolMode;t.getPageCounts()>0?i?this.setUiState("focused"):this.setUiState("normal"):this.setUiState("disabled");}),this);}}class GC extends XC{constructor(t){super(t,{class:"ddv-pan-mode",toolMode:"pan"});}}i(GC,"cpName","Pan");i(class extends XC{constructor(t){super(t,{class:"ddv-zoom-mode",toolMode:"zoomIn"});}},"cpName","ZoomMode");class YC extends XC{constructor(t){super(t,{class:"ddv-crop-mode",toolMode:"crop"});}}i(YC,"cpName","CropMode");class qC extends XC{constructor(t){super(t,{class:"ddv-text-selection-mode",toolMode:"textSelection"});}}i(qC,"cpName","TextSelectionMode");class JC extends Hb{constructor(t){super(t,{class:"ddv-zoom-in",callback:()=>{this.injection.viewer.zoomIn();}}),this.bindViewerHooks(),Mb(this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.zoomChanged.on((e=>{const{maxZoom:i}=t.getViewerConfig();t.getPageCounts()<1||e.newZoomRatio>=i?this.setUiState("disabled"):this.setUiState("normal"),Fb(this,t)&&this.setUiState("disabled");}),this);}}i(JC,"cpName","ZoomIn");class ZC extends Hb{constructor(t){super(t,{class:"ddv-zoom-out",callback:()=>{this.injection.viewer.zoomOut();}}),this.bindViewerHooks(),Mb(this);}bindViewerHooks(){const t=this.injection.viewer;t.hooks.zoomChanged.on((e=>{const{minZoom:i}=t.getViewerConfig();t.getPageCounts()<1||e.newZoomRatio<=i?this.setUiState("disabled"):this.setUiState("normal"),Fb(this,t)&&this.setUiState("disabled");}),this);}}i(ZC,"cpName","ZoomOut");class QC extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-zoom-controller"),vb.registerComponent({ZoomIn:JC,ZoomOut:ZC}),this.initTemplate();}initTemplate(){const{options:t}=this.data;Lb(Ob(this),this.injection.viewer,t);const e=`<div ${pb(t,this.defaultClass)}><ZoomOut :options:"options.ZoomOut"></ZoomOut><ZoomByPercentage :options:"options.ZoomByPercentage"></ZoomByPercentage><ZoomIn :options:"options.ZoomIn"></ZoomIn></div>`;this.template=e;}}i(QC,"cpName","Zoom");const KC=[10,25,50,75,100,125,150,200,400,800,1600,2400,3200,6400];class tP extends ub{constructor(t){super(t),i(this,"defaultClass","ddv-zoom-percentage"),i(this,"cssPrefix",`${this.defaultClass}-`),i(this,"isFirstClick",!0),i(this,"box",void 0),i(this,"uiState","normal"),i(this,"isRefactorCrop",!1),i(this,"isRefactorAnnotation",!1),this.initTemplate(),this.bindHooks(),this.bindDefaultUi(),this.bindViewerHooks(),this.bindViewerResized(),Mb(this),Rb(this),this.hooks.destroyed.on((()=>{this.dispose();})),this.$on("ui_layoutScroll",(t=>{this.togglePopup(!1),this.isFirstClick=!0;}));}bindHooks(){this.hooks.created.on((t=>{this.box=this.query(`.${this.cssPrefix}box`),this.box.style.display="none",this.box.remove(),this.bindEvents();})),this.hooks.inserted.on((()=>{const t=this.injection.viewer,{zoom:e}=t.getViewerConfig();this.updateZoom(e),this.updateZoomOption();})),this.hooks.updated.on((()=>{this.uiState="normal",this.box.style.display="none",this.isFirstClick=!0;}));}bindDefaultUi(){const t=this.injection.viewer,e=()=>{let e=0===t.getPageCounts()?"disabled":"normal";Fb(this,t)&&(e="disabled"),_b(this,e),this.updateZoom(t.getViewerConfig().zoom);};t.hooks.pageChanged.on(e,this),this.hooks.inserted.on(e),this.hooks.updated.on(e);}bindViewerHooks(){const{viewer:t}=this.injection,{hooks:e}=t;e.zoomChanged.on((t=>{this.updateZoom(t.newZoomRatio);}),this),e.visibleChanged.on((e=>{if("hidden"===e.newVisibility)return void this.togglePopup(!1);const{zoom:i}=t.getViewerConfig();this.updateZoom(i);}),this);}bindEvents(){const{el:t,box:e}=this,i=t.querySelector(`.${this.cssPrefix}selector`),s=t.getElementsByTagName("input")[0],n=e.getElementsByTagName("ul")[0];this.nativeOn(i,"click",(()=>{const t=this.injection.viewer.rootDom;this.togglePopup(),this.isFirstClick&&(Ub(t,this.el,this.box,!0,!0),this.isFirstClick=!1);})),this.inputEvent(s),this.ulEvent(n);}bindViewerResized(){const{viewer:t}=this.injection;t.hooks.resize.on((()=>{const{box:t}=this,e="none"===t.style.display,i=this.injection.viewer.rootDom;e?this.isFirstClick=!0:Ub(i,this.el,this.box,!0,!0);}),this);}inputEvent(t){const e=this.injection.viewer,{maxZoom:i,minZoom:s}=e.getViewerConfig();t.value=`${i}`;const n=Nb(t);function o(){const n=t.value/100,o=Gs(n,s,i);e.updateViewerConfig({zoom:o});}this.nativeOn(t,"input",(()=>{this.adaptInputWidth(n);})),this.nativeOn(t,"blur",o),this.nativeOn(t,"keydown",(t=>{t.stopPropagation();"Enter"===t.key&&o();}));}ulEvent(t){this.nativeOn(t,"click",(t=>{t.stopPropagation();const{viewer:e}=this.injection,{maxZoom:i,minZoom:s}=e.getViewerConfig(),n=t.target;if("LI"===n.tagName){const t=Gs(n.value,100*s,100*i);e.updateViewerConfig({zoom:t/100});}this.togglePopup(!1);}));}getZoomOptionTemplate(){var t;const e=(null===(t=this.data.options)||void 0===t?void 0:t.valueList)||null,i=this.injection.viewer,{maxZoom:s,minZoom:n}=i.getViewerConfig(),o=Ls(e)?e:KC,r=n<1e-4?.01:parseFloat((100*n).toFixed(2)),a=Math.floor(100*s);o.push(r,a);const l=Array.from(new Set(o)).sort(((t,e)=>t-e));let h="";return l.forEach((t=>{js(t)&&t<=100*s&&t>=100*n&&(h+=`<li value="${t}">${t}%</li>`);})),h}updateZoomOption(){const t=this.getZoomOptionTemplate();this.box.getElementsByTagName("ul")[0].innerHTML=t;}updateZoom(t){const e=this.el.getElementsByTagName("input")[0],i=100*t;if(Number.isInteger(i))e.value=`${i}`;else {let t=i;t=t>=1e3?+t.toFixed(0).toString():t>=100?+t.toFixed(1).toString():t>=10?+t.toFixed(2).toString():+t.toFixed(3).toString(),e.value=`${t}`;}this.adaptInputWidth();}initTemplate(){const{options:t={}}=this.data,{input:e,selector:i,popupBox:s}=t,{cssPrefix:n}=this,{viewer:o}=this.injection;Lb(Ob(this),o,t);const r=`<div ${pb(t,this.defaultClass)}><div style="display: flex"><div ${pb(e,n,"input")}><input type="number"><span>%</span></div><button ${pb(i,n,"selector")}></button></div><div ${pb({id:`ddvZoomByPercentageSelectBox${o.postfix}`,...s},n,"box")}><ul></ul></div></div>`;this.template=r;}adaptInputWidth(t){const e=this.el.getElementsByTagName("input")[0];let i=Nb(e);t&&i>t&&(i=t),e.style.width=`${i}px`;}togglePopup(t){const{viewer:e}=this.injection,{box:i}=this;let s="none"!==i.style.display;s=_s(t)?!s:t,s?(this.$emit("ui_hidePopup",this),e.rootDom.appendChild(i)):i.remove(),i.style.display=s?"":"none";}}i(tP,"cpName","ZoomByPercentage");class eP{static getTooltip(){return this.tooltip}static setTooltip(t){this.tooltip={...this.tooltip,...t};}static getDisplayTextConfig(){return this.displayTextConfig}static setDisplayTextConfig(t){this.displayTextConfig={...this.displayTextConfig,...t};}static registerAll(){vb.registerComponent({Capture:HS,Flashlight:VS,CameraConvert:zS,CameraResolution:jS,AutoDetect:FS,AutoCapture:WS,ImagePreview:XS,RotateLeft:gC,RotateRight:fC,Delete:KS,DeleteAll:YS,DeleteCurrent:qS,Zoom:QC,ZoomIn:JC,ZoomOut:ZC,ZoomByPercentage:tP,PerspectiveAll:hC,FullQuad:cC,Restore:pC,Undo:vC,Redo:dC,FitMode:IC,FitWidth:LC,FitHeight:UC,FitWindow:OC,ActualSize:NC,DisplayMode:AC,SinglePage:EC,MultiPage:RC,ContinuousPage:DC,Pan:GC,Print:tC,Filter:wC,ThumbnailSwitch:jC,Back:CC,Done:PC,Pagination:WC,FirstPage:HC,LastPage:VC,NextPage:zC,PrevPage:$C,Root:bb,Layout:yb,Button:mb,SwipeIndicator:Cb,MainView:_C,Load:GS,Download:QS,Close:SC,Blank:bC,SeparatorLine:Sb,PasswordLoader:eC,TextSearchPanel:nC,TextSearchPanelSwitch:oC,CropCurrent:rC,CropAll:lC,CropMode:YC,Crop:mC,AnnotationSet:aS,EllipseAnnotation:Xb,EraseAnnotation:Gb,InkAnnotation:Yb,LineAnnotation:qb,PolygonAnnotation:Jb,PolylineAnnotation:Zb,RectAnnotation:Qb,SelectAnnotation:Kb,StampIconAnnotation:tS,StampImageAnnotation:eS,TextBoxAnnotation:iS,TextTypewriterAnnotation:sS,HighlightAnnotation:nS,UnderlineAnnotation:oS,StrikeoutAnnotation:rS,BasePullDownButton:Vb,PullDownListButton:zb,PullDownMenuButton:$b,BringForward:cS,BringToFront:dS,SendBackward:uS,SendToBack:pS,TextSelectionMode:qC,AnnotationToolBar:gS,AnnotationDeleteButton:mS,AnnotationPaletteButton:vS,AnnotationPalette:MS,AnnotationCustomStampPanel:BS,HighlightCreateButton:LS,StrikeoutCreateButton:OS,UnderlineCreateButton:NS,TextCopyButton:_S});}}i(eP,"tooltip",{}),i(eP,"displayTextConfig",{FitMode_FitWidth:"Fit Width",FitMode_FitHeight:"Fit Height",FitMode_FitWindow:"Fit Window",FitMode_ActualSize:"Actual Size",DisplayMode_SinglePage:"Single Page",DisplayMode_ContinuousPage:"Continuous Page",Crop_CropAll:"Crop All",Crop_CropCurrent:"Crop Current",Crop_CropCancel:"Cancel",Crop_CropApply:"Apply",Filter_FilterAll:"Apply to All",Delete_DeleteCurrent:"Delete current",Delete_DeleteAll:"Delete all",CameraResolution_720P:"720P",CameraResolution_1080P:"1080P",CameraResolution_1440P:"1440P",CameraResolution_2160P:"2160P"});const iP={install(t){const e=function(t){var e,o,r,a;return e=new WeakMap,o=new WeakMap,r=new WeakMap,a=new WeakSet,class extends t{constructor(t){super(t),v(this,a),i(this,"ui",void 0),i(this,"rootDom",void 0),i(this,"popupConfig",null),f(this,e,{writable:!0,value:!1}),f(this,o,{writable:!0,value:0}),f(this,r,{writable:!0,value:0}),eP.registerAll();const{popupConfig:s}=t,n=t.viewerConfig.enablePopup?this.getPopupUiConfig({annotationToolBarConfig:(null==s?void 0:s.annotationToolBarConfig)||{},annotationPaletteConfig:(null==s?void 0:s.annotationPaletteConfig)||{},annotationCustomStampPanelConfig:(null==s?void 0:s.annotationCustomStampPanelConfig)||{},passwordLoaderConfig:(null==s?void 0:s.passwordLoaderConfig)||{}}):[];this.popupConfig=null==t?void 0:t.popupConfig,this.ui=new vb({container:t.container,emitter:this.emitter,postfix:this.uid,uiConfig:t.uiConfig,popupUiConfig:n,injection:{viewer:this}}),t.container&&(t.uiConfig?(this.bindContainer(t.container),this.rootDom=this.ui.rootDom):this.rootDom=this.context.viewService.rootDom),this.hooks.uiInitCompleted.emit(),this.listenNativeEventsForUi();}listenNativeEventsForUi(){this.on("click",(()=>{this.emit("ui_hidePopup","viewer");}));}getPopupUiConfig(t){const e={enabled:!0,isPaletteEnabled:!0,...t.annotationToolBarConfig,type:"AnnotationToolBar"},i={enabled:!0,colorList:["#F01314","#FD7C10","#FFEE5F","#07C37F","#0E68F5","#9D3BFE","#000000","#FF9494","#87440C","#B7A514","#046743","#50C9FF","#EBA3ED","#FFFFFF","#CECECE"],enableChangeColor:!0,enableDrag:!0,autoDisplay:!0,enableCustomStamp:!1,...t.annotationPaletteConfig,type:"AnnotationPalette"},s={labels:{stampText:"Stamp Text",fontStyle:"Font Style",textColor:"TextColor",backgroundColor:"Background",borderColor:"BorderColor",timeStampText:"Timestamp Text",userName:"Username",date:"Date",time:"Time",create:"Create"},colorList:["#fdcccc","#f7fc7b","#c7d2e4","#d6e4cd","#910f05","#d5b142","#182564","#416a1c","#ffffff","#000000"],enabled:!1,autoDisplay:!0,...t.annotationCustomStampPanelConfig,type:"AnnotationCustomStampPanel"},n={enabled:!0,...t.passwordLoaderConfig,type:"PasswordLoader"},o=[],r="default"===this.getViewerConfig().viewerMode;return e.enabled&&r&&o.push(e),i.enabled&&r?o.push(i):e.isPaletteEnabled=!1,s.enabled&&r&&o.push(s),n.enabled&&o.push(n),o}addFontToUi(t){this.emit("ui_addFont",t);}toggleUiPopup(t,e){this.ui.emit("ui_changePalette_visible",t,e);}getUiConfig(){return Ns(this.ui.uiConfig)}updateUiConfig(t){const{resizeService:i}=this.context.core;i&&(i.unobserve(this.ui.rootDom),n(this,e,!1));const s=this.ui.updateUiConfig(t);return this.rootDom=this.ui.rootDom,this.context.viewService.rootDom=this.rootDom,p(this,a,l).call(this,this.ui.rootDom),s}getElementsByType(t){return Xs(t)?this.ui.getElementsByType(this.ui.rootVNode,t):""}bindContainer(t){let e=t;return Xs(t)&&(e=document.querySelector(`#${t}`)),e instanceof HTMLElement&&(p(this,a,l).call(this,this.ui.rootDom),this.ui.bindContainer(e),this.context.viewService.container=e,this.context.viewService.rootDom=this.ui.rootDom,this.rootDom=this.ui.rootDom,"hidden"===this.context.viewerConfig.visibility&&(this.context.viewService.rootDom.style.display="none"),this.context.viewService.isBindContainer=!0,!0)}unbindContainer(){this.rootDom&&this.ui.container&&(this.ui.unbindContainer(),this.context.viewService.container=null,this.context.viewService.isBindContainer=!1);}dispose(){var t;super.dispose(),null===(t=this.ui)||void 0===t||t.dispose();}};function l(t){if(s(this,e))return;const{resizeService:i}=this.context.core;i.observe(t),this.register(i.onResizeObserver.on((e=>{if(e.target===t){var i;let a=0,l=0;if((null===(i=e.borderBoxSize)||void 0===i?void 0:i.length)>0){const t=e.borderBoxSize[0];a=t.inlineSize,l=t.blockSize;}else a=t.offsetWidth,l=t.offsetHeight;const h=gf.create(s(this,o),s(this,r),a,l);n(this,o,a),n(this,r,l),this.hooks.resize.emit(h);}}))),this.hooks.destroy.on((()=>{i.unobserve(t);}),this),n(this,e,!0);}}(t.getClass("Viewer"));t.setClass("Viewer",e);}};function sP(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)}function nP(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;const oP="undefined"==typeof self;let rP,aP,lP,hP,cP;function dP(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return "m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)}function uP(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return "a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i}"undefined"!=typeof navigator&&(rP=navigator,aP=rP.userAgent,lP=rP.platform,hP=rP.mediaDevices),function(){if(!oP){const t={Edge:{search:"Edg",verSearch:"Edg"},OPR:null,Chrome:null,Safari:{str:rP.vendor,search:"Apple",verSearch:["Version","iPhone OS","CPU OS"]},Firefox:null,Explorer:{search:"MSIE",verSearch:"MSIE"}},e={HarmonyOS:null,Android:null,iPhone:null,iPad:null,Windows:{str:lP,search:"Win"},Mac:{str:lP},Linux:{str:lP}};let i="unknownBrowser",s=0,n="unknownOS";for(let e in t){const n=t[e]||{};let o=n.str||aP,r=n.search||e,a=n.verStr||aP,l=n.verSearch||e;if(l instanceof Array||(l=[l]),-1!=o.indexOf(r)){i=e;for(let t of l){let e=a.indexOf(t);if(-1!=e){s=parseFloat(a.substring(e+t.length+1));break}}break}}for(let t in e){const i=e[t]||{};let s=i.str||aP,o=i.search||t;if(-1!=s.indexOf(o)){n=t;break}}"Linux"==n&&-1!=aP.indexOf("Windows NT")&&(n="HarmonyOS"),cP={browser:i,version:s,OS:n};}oP&&(cP={browser:"ssr",version:0,OS:"ssr"});}(),hP&&hP.getUserMedia,"Chrome"===cP.browser&&cP.version>66||"Safari"===cP.browser&&cP.version>13||"OPR"===cP.browser&&cP.version>43||"Edge"===cP.browser&&cP.version,"function"==typeof SuppressedError&&SuppressedError;class pP{static multiply(t,e){const i=[];for(let s=0;s<3;s++){const n=e.slice(3*s,3*s+3);for(let e=0;e<3;e++){const s=[t[e],t[e+3],t[e+6]].reduce(((t,e,i)=>t+e*n[i]),0);i.push(s);}}return i}static identity(){return [1,0,0,0,1,0,0,0,1]}static translate(t,e,i){return pP.multiply(t,[1,0,0,0,1,0,e,i,1])}static rotate(t,e){var i=Math.cos(e),s=Math.sin(e);return pP.multiply(t,[i,-s,0,s,i,0,0,0,1])}static scale(t,e,i){return pP.multiply(t,[e,0,0,0,i,0,0,0,1])}}var gP,fP,vP,mP,yP,xP,wP,bP,SP;!function(t){t.GREY="grey",t.GREY32="grey32",t.RGBA="rgba",t.RBGA="rbga",t.GRBA="grba",t.GBRA="gbra",t.BRGA="brga",t.BGRA="bgra";}(gP||(gP={}));class CP{static get version(){return "1.1.0"}static checkWebGLSupport(){return null===document.createElement("canvas").getContext("webgl")?(uP(CP,fP,!1,"f",vP),!1):(uP(CP,fP,!0,"f",vP),!0)}get disposed(){return dP(this,SP,"f")}constructor(){mP.set(this,gP.RGBA),yP.set(this,null),xP.set(this,null),wP.set(this,null),this.useWebGLByDefault=!0,this._reusedCvs=null,this._reusedWebGLCvs=null,bP.set(this,null),SP.set(this,!1);}drawImage(t,e,i,s,n,o){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!i||!s)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==dP(CP,fP,"f",vP)&&CP.checkWebGLSupport(),(null==o?void 0:o.bUseWebGL)&&!dP(CP,fP,"f",vP))throw new Error("Your browser or machine may not support WebGL.");if(e instanceof HTMLVideoElement&&4!==e.readyState||e instanceof HTMLImageElement&&!e.complete)throw new Error("The source is not loaded.");let r;CP._onLog&&(r=Date.now(),CP._onLog("drawImage(), START: "+r));let a=0,l=0,h=i,c=s,d=0,u=0,p=i,g=s;n&&(n.sx&&(a=Math.round(n.sx)),n.sy&&(l=Math.round(n.sy)),n.sWidth&&(h=Math.round(n.sWidth)),n.sHeight&&(c=Math.round(n.sHeight)),n.dx&&(d=Math.round(n.dx)),n.dy&&(u=Math.round(n.dy)),n.dWidth&&(p=Math.round(n.dWidth)),n.dHeight&&(g=Math.round(n.dHeight)));let f,v=gP.RGBA;if((null==o?void 0:o.pixelFormat)&&(v=o.pixelFormat),(null==o?void 0:o.bufferContainer)&&(f=o.bufferContainer,f.length<4*p*g))throw new Error("Unexpected size of the 'bufferContainer'.");const m=t;if(!dP(CP,fP,"f",vP)||!(this.useWebGLByDefault&&null==(null==o?void 0:o.bUseWebGL)||(null==o?void 0:o.bUseWebGL))){CP._onLog&&CP._onLog("drawImage() in context2d."),m.ctx2d||(m.ctx2d=m.getContext("2d",{willReadFrequently:!0}));const t=m.ctx2d;if(!t)throw new Error("Unable to get 'CanvasRenderingContext2D' from canvas.");return (m.width<d+p||m.height<u+g)&&(m.width=d+p,m.height=u+g),t.drawImage(e,a,l,h,c,d,u,p,g),CP._onLog&&CP._onLog("drawImage() in context2d end. Costs: "+(Date.now()-r)),{context:t,pixelFormat:gP.RGBA,bUseWebGL:!1}}CP._onLog&&CP._onLog("drawImage() in WebGL.");try{(m.width<d+p||m.height<u+g)&&(m.width=d+p,m.height=u+g,m.ctxWebGL&&m.ctxWebGL.viewport(0,0,d+p,u+g));const t=m.ctxWebGL||m.getContext("webgl",{antialias:!1})||m.getContext("experimental-webgl",{antialias:!1});if(!t){CP._onLog&&CP._onLog("Browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");const t=new Error("Unable to get 'WebGLRenderingContext'. Your browser or machine may not support WebGL, or the canvas has already been set to a different context mode.");throw t.name="WebGLError",t}if(!m.ctxWebGL||v!==dP(this,mP,"f")){m.ctxWebGL=t;const e=t=>{const e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW);const i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,0,0,1,1,1]),t.STATIC_DRAW),{positions:e,texCoords:i}},i=t=>{const e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e},s=(t,e)=>{const i=t.createProgram();if(e.forEach((e=>t.attachShader(i,e))),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=new Error(`An error occured linking the program: ${t.getProgramInfoLog(i)}.`);throw e.name="WebGLError",e}return t.useProgram(i),i},n=(t,e,i)=>{const s=t.createShader(e);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){const e=new Error(`An error occured compiling the shader: ${t.getShaderInfoLog(s)}.`);throw e.name="WebGLError",e}return s},o="\n                  attribute vec2 a_position;\n                  attribute vec2 a_texCoord;\n  \n                  uniform mat3 u_matrix;\n                  uniform mat3 u_textureMatrix;\n  \n                  varying vec2 v_texCoord;\n                  void main(void) {\n                  gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1.0);\n                  v_texCoord = vec4((u_textureMatrix * vec3(a_texCoord, 1)).xy, 0, 1.0).xy;\n                  }\n              ";let r="rgb";["rgba","rbga","grba","gbra","brga","bgra"].includes(v)&&(r=v.slice(0,3));const a=`\n                  precision mediump float;\n                  varying vec2 v_texCoord;\n                  uniform sampler2D u_image;\n                  uniform float uColorFactor;\n  \n                  void main() {\n                      vec4 sample = texture2D(u_image, v_texCoord);\n                      float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                      gl_FragColor = vec4(sample.${r} * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                  }\n              `,l=s(t,[n(t,t.VERTEX_SHADER,o),n(t,t.FRAGMENT_SHADER,a)]);uP(this,xP,{program:l,attribLocations:{vertexPosition:t.getAttribLocation(l,"a_position"),texPosition:t.getAttribLocation(l,"a_texCoord")},uniformLocations:{uSampler:t.getUniformLocation(l,"u_image"),uColorFactor:t.getUniformLocation(l,"uColorFactor"),uMatrix:t.getUniformLocation(l,"u_matrix"),uTextureMatrix:t.getUniformLocation(l,"u_textureMatrix")}},"f"),uP(this,wP,e(t),"f"),uP(this,yP,i(t),"f"),uP(this,mP,v,"f");}const n=(t,e,i)=>{t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0);},o=(t,e,i)=>{const s=t.RGBA,n=t.RGBA,o=t.UNSIGNED_BYTE;t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,s,n,o,i);},y=(t,e,o,r)=>{t.clearColor(0,0,0,1),t.clearDepth(1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),n(t,o.positions,e.attribLocations.vertexPosition),n(t,o.texCoords,e.attribLocations.texPosition),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,r),t.uniform1i(e.uniformLocations.uSampler,0),t.uniform1f(e.uniformLocations.uColorFactor,[gP.GREY,gP.GREY32].includes(v)?1:0);let f,m,y=pP.translate(pP.identity(),-1,-1);y=pP.scale(y,2,2),y=pP.scale(y,1/t.canvas.width,1/t.canvas.height),f=pP.translate(y,d,u),f=pP.scale(f,p,g),t.uniformMatrix3fv(e.uniformLocations.uMatrix,!1,f),m=pP.translate(pP.identity(),a/i,l/s),m=pP.scale(m,h/i,c/s),t.uniformMatrix3fv(e.uniformLocations.uTextureMatrix,!1,m),t.drawArrays(t.TRIANGLES,0,6);};o(t,dP(this,yP,"f"),e),y(t,dP(this,xP,"f"),dP(this,wP,"f"),dP(this,yP,"f"));const x=f||new Uint8Array(4*p*g);if(t.readPixels(d,u,p,g,t.RGBA,t.UNSIGNED_BYTE,x),255!==x[3]){CP._onLog&&CP._onLog("Incorrect WebGL drawing .");const t=new Error("WebGL error: incorrect drawing.");throw t.name="WebGLError",t}return CP._onLog&&CP._onLog("drawImage() in WebGL end. Costs: "+(Date.now()-r)),{context:t,pixelFormat:v===gP.GREY?gP.GREY32:v,bUseWebGL:!0}}catch(r){if(this.forceLoseContext(),null==(null==o?void 0:o.bUseWebGL))return CP._onLog&&CP._onLog("'drawImage()' in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.drawImage(t,e,i,s,n,Object.assign({},o,{bUseWebGL:!1}));throw r.name="WebGLError",r}}readCvsData(t,e,i){if(!(t instanceof CanvasRenderingContext2D||t instanceof WebGLRenderingContext))throw new Error("Invalid 'context'.");let s,n=0,o=0,r=t.canvas.width,a=t.canvas.height;if(e&&(e.x&&(n=e.x),e.y&&(o=e.y),e.width&&(r=e.width),e.height&&(a=e.height)),(null==i?void 0:i.length)<4*r*a)throw new Error("Unexpected size of the 'bufferContainer'.");if(t instanceof WebGLRenderingContext){const e=t;i?(e.readPixels(n,o,r,a,e.RGBA,e.UNSIGNED_BYTE,i),s=new Uint8Array(i.buffer,0,4*r*a)):(s=new Uint8Array(4*r*a),e.readPixels(n,o,r,a,e.RGBA,e.UNSIGNED_BYTE,s));}else if(t instanceof CanvasRenderingContext2D){let e;e=t.getImageData(n,o,r,a),s=new Uint8Array(e.data.buffer),null==i||i.set(s);}return s}transformPixelFormat(t,e,i,s){let n,o;if(CP._onLog&&(n=Date.now(),CP._onLog("transformPixelFormat(), START: "+n)),e===i)return CP._onLog&&CP._onLog("transformPixelFormat() end. Costs: "+(Date.now()-n)),s?new Uint8Array(t):t;const r=[gP.RGBA,gP.RBGA,gP.GRBA,gP.GBRA,gP.BRGA,gP.BGRA];if(r.includes(e))if(i===gP.GREY){o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e/4]=i;}}else if(i===gP.GREY32){o=s?new Uint8Array(t):t;for(let e=0;e<t.length;e+=4){const i=.21*t[e]+.71*t[e+1]+.07*t[e+2];o[e]=i,o[e+1]=i,o[e+2]=i;}}else {if(!r.includes(i))throw new Error("Unable to transform.");if(s){o=new Uint8Array(t);const s=e.indexOf("r"),n=e.indexOf("g"),r=e.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let e=0;e<t.length;e+=4)o[e+a]=t[e+s],o[e+l]=t[e+n],o[e+h]=t[e+r];}else {o=t;const s=e.indexOf("r"),n=e.indexOf("g"),r=e.indexOf("b"),a=i.indexOf("r"),l=i.indexOf("g"),h=i.indexOf("b");for(let e=0;e<t.length;e+=4){let i=[t[e],t[e+1],t[e+2]];o[e+a]=i[s],o[e+l]=i[n],o[e+h]=i[r];}}}else if(e===gP.GREY){if(i!==gP.GREY32)throw new Error("Unable to transform.");o=new Uint8Array(4*t.length);for(let e=0;e<t.length;e++)o[4*e]=t[e],o[4*e+1]=t[e],o[4*e+2]=t[e],o[4*e+3]=255;}else {if(e!==gP.GREY32)throw new Error("Unable to transform.");if(i!==gP.GREY)throw new Error("Unable to transform.");o=new Uint8Array(t.length/4);for(let e=0;e<t.length;e+=4)o[e/4]=t[e];}return CP._onLog&&CP._onLog("transformPixelFormat() end. Costs: "+(Date.now()-n)),o}getImageData(t,e,i,s,n){if(this.disposed)throw Error("The 'ImageDataGetter' instance has been disposed.");if(!e||!i)throw new Error("Invalid 'sourceWidth' or 'sourceHeight'.");if(null==dP(CP,fP,"f",vP)&&CP.checkWebGLSupport(),(null==n?void 0:n.bUseWebGL)&&!dP(CP,fP,"f",vP))throw new Error("Your browser or machine may not support WebGL.");if(s.sx>e||s.sy>i||s.sx+s.sWidth>e||s.sy+s.sHeight>i)throw new Error("Invalid position.");if(t instanceof HTMLVideoElement&&4!==t.readyState||t instanceof HTMLImageElement&&!t.complete)throw new Error("The source is not loaded.");let o;CP._onLog&&(o=Date.now(),CP._onLog("getImageData(), START: "+o));const r=Math.round(s.sx),a=Math.round(s.sy),l=Math.round(s.sWidth),h=Math.round(s.sHeight),c=Math.round(s.dWidth),d=Math.round(s.dHeight);let u=gP.RGBA;(null==n?void 0:n.pixelFormat)&&(u=n.pixelFormat);let p,g,f,v=null;if((null==n?void 0:n.bufferContainer)&&(v=n.bufferContainer),dP(CP,fP,"f",vP)&&(this.useWebGLByDefault&&null==(null==n?void 0:n.bUseWebGL)||(null==n?void 0:n.bUseWebGL))){CP._onLog&&CP._onLog("getImageData() in WebGL."),this._reusedWebGLCvs||(this._reusedWebGLCvs=document.createElement("canvas")),p=this._reusedWebGLCvs;try{if(v)if(u===gP.GREY){if(f=new Uint8Array(4*c*d),g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:f}),f=this.transformPixelFormat(f,g.pixelFormat,u),v){if(v.length<f.length)throw new Error("Unexpected size of the 'bufferContainer'.");v.set(f);}}else g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:v}),f=new Uint8Array(v.buffer,0,4*c*d),f=this.transformPixelFormat(f,g.pixelFormat,u);else u===gP.GREY?((!dP(this,bP,"f")||dP(this,bP,"f").length<4*c*d)&&uP(this,bP,new Uint8Array(4*c*d),"f"),f=new Uint8Array(dP(this,bP,"f").buffer,0,4*c*d)):f=new Uint8Array(4*c*d),g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:u,bUseWebGL:!0,bufferContainer:f}),f=this.transformPixelFormat(f,g.pixelFormat,u);}catch(s){if("WebGLError"===s.name&&(this.forceLoseContext(),null==(null==n?void 0:n.bUseWebGL)))return CP._onLog&&CP._onLog("getImageData() in WebGL failed, try again in context2d."),this.useWebGLByDefault=!1,this.getImageData(t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},Object.assign({},n,{bUseWebGL:!1}));throw s}}else if(CP._onLog&&CP._onLog("getImageData() in context2d."),this._reusedCvs||(this._reusedCvs=document.createElement("canvas")),p=this._reusedCvs,g=this.drawImage(p,t,e,i,{sx:r,sy:a,sWidth:l,sHeight:h,dWidth:c,dHeight:d},{pixelFormat:gP.RGBA,bUseWebGL:!1}),f=this.readCvsData(g.context,{width:c,height:d},null),f=this.transformPixelFormat(f,g.pixelFormat,u),v){if(v.length<f.length)throw new Error("Unexpected size of the 'bufferContainer'.");v.set(f);}return CP._onLog&&CP._onLog("getImageData() end. Costs: "+(Date.now()-o)),{data:f,pixelFormat:u,width:c,height:d,bUseWebGL:g.bUseWebGL}}convertDataToCvs(t,e,i,s){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new TypeError("Invalid 'data'.");if("number"!=typeof e||e<=0)throw new Error("Invalid 'width'.");if("number"!=typeof i||i<=0)throw new Error("Invalid 'height'.");const n=document.createElement("canvas");let o;if(n.width=e,n.height=i,s===gP.GREY){o=new Uint8ClampedArray(4*e*i);for(let e=0;e<o.length;e+=4)o[e]=t[e/4],o[e+1]=t[e/4],o[e+2]=t[e/4],o[e+3]=255;}else o=new Uint8ClampedArray(t.buffer);const r=new ImageData(o,e,i);return n.getContext("2d").putImageData(r,0,0),n}forceLoseContext(){if(!this._reusedWebGLCvs)return;const t=this._reusedWebGLCvs.ctxWebGL;t&&!t.isContextLost()&&t.getExtension("WEBGL_lose_context")&&t.getExtension("WEBGL_lose_context").loseContext(),uP(this,yP,null,"f"),uP(this,xP,null,"f"),uP(this,wP,null,"f"),this._reusedWebGLCvs=null;}dispose(){this.forceLoseContext(),uP(this,SP,!0,"f");}}fP=CP,mP=new WeakMap,yP=new WeakMap,xP=new WeakMap,wP=new WeakMap,bP=new WeakMap,SP=new WeakMap,vP={value:void 0};var PP,TP,AP,kP,DP,RP,EP,MP,IP,BP,UP,LP,OP,NP,_P,WP,FP,HP,VP,zP,$P,jP,XP,GP,YP,qP,JP,ZP,QP,KP,tT,eT,iT,sT,nT,oT,rT,aT,lT,hT,cT,dT,uT;class pT{constructor(){PP.set(this,new Map),TP.set(this,!1);}get disposed(){return sP(this,TP,"f")}on(t,e){t=t.toLowerCase();const i=sP(this,PP,"f").get(t);if(i){if(i.includes(e))return;i.push(e);}else sP(this,PP,"f").set(t,[e]);}off(t,e){t=t.toLowerCase();const i=sP(this,PP,"f").get(t);if(!i)return;const s=i.indexOf(e);-1!==s&&i.splice(s,1);}offAll(t){t=t.toLowerCase();const e=sP(this,PP,"f").get(t);e&&(e.length=0);}fire(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{async:!1,copy:!0};e||(e=[]),t=t.toLowerCase();const s=sP(this,PP,"f").get(t);if(s&&s.length){i=Object.assign({async:!1,copy:!0},i);for(let t of s){if(!t)continue;let n=[];if(i.copy)for(let t of e){try{t=JSON.parse(JSON.stringify(t));}catch(t){}n.push(t);}else n=e;let o=!1;if(i.async)setTimeout((()=>{this.disposed||s.includes(t)&&t.apply(i.target,n);}),0);else try{o=t.apply(i.target,n);}catch(t){}if(!0===o)break}}}dispose(){nP(this,TP,!0,"f");}}PP=new WeakMap,TP=new WeakMap;const gT=(t,e,i,s)=>{if(!i)return t;let n=e+Math.round((t-e)/i)*i;return s&&(n=Math.min(n,s)),n};class fT{static get version(){return "2.0.12"}static isStorageAvailable(t){let e;try{e=window[t];const i="__storage_test__";return e.setItem(i,i),e.removeItem(i),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&e&&0!==e.length}}static findBestRearCameraInIOS(t,e){if(!t||!t.length)return null;let i=!1;if((null==e?void 0:e.getMainCamera)&&(i=!0),i){const e=[" ","","","",""," "," "," ","   "," "," "," "," ","zadn fotoapart","zadn kamera","tylny aparat","takakamera","stranja kamera","rckkamera","kamera p baksidan","kamera belakang","kamera bak","hts kamera","fotocamera (posteriore)","cmera traseira","cmara traseira","cmara trasera","cmera posterior","camra arrire","camer spate","camera mt sau","camera aan achterzijde","bagsidekamera","back camera","arka kamera"],i=t.find((t=>e.includes(t.label.toLowerCase())));return null==i?void 0:i.deviceId}{const e=["","","","","","","","","","","","","zadn","zadn","tylny","trasera","traseira","taka","stranja","spate","sau","rck","posteriore","posterior","hts","belakang","baksidan","bakre","bak","bagside","back","a","arrire","arka","achterzijde"],i=["","","","","","","","","","","","","","l","trjobiektywowy","trostruka","trojn","trojit","trippelt","trippel","tripl","triple","tripla","tiga","kolmois","ba camera"],s=[" ","","","",""," "," "," ","  "," "," "," "," ","ift geni","laajakulmainen kaksois","kp rng mt sau","ketts, szles ltszg","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka iroka","duln irokohl","dulna irokouhl","dupla grande-angular","dubl","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],n=t.filter((t=>{const i=t.label.toLowerCase();return e.some((t=>i.includes(t)))}));if(!n.length)return null;const o=n.find((t=>{const e=t.label.toLowerCase();return i.some((t=>e.includes(t)))}));if(o)return o.deviceId;const r=n.find((t=>{const e=t.label.toLowerCase();return s.some((t=>e.includes(t)))}));return r?r.deviceId:n[0].deviceId}}static findBestRearCamera(t,e){if(!t||!t.length)return null;if(["iPhone","iPad","Mac"].includes(cP.OS))return fT.findBestRearCameraInIOS(t,{getMainCamera:null==e?void 0:e.getMainCameraInIOS});const i=["","","","","","","","","","","","","","","","","","zadn","zadn","tylny","trs","trasera","traseira","taka","stranja","spate","sau","rck","rear","posteriore","posterior","hts","darrere","belakang","baksidan","bakre","bak","bagside","back","a","arrire","arka","achterzijde"];for(let e of t){const t=e.label.toLowerCase();if(t&&i.some((e=>t.includes(e)))&&/\b0(\b)?/.test(t))return e.deviceId}return ["Android","HarmonyOS"].includes(cP.OS)?t[t.length-1].deviceId:null}static findBestCamera(t,e,i){return t&&t.length?"environment"===e?this.findBestRearCamera(t,i):"user"===e?null:e?void 0:null:null}static async playVideo(t,e,i){if(!t)throw new Error("Invalid 'videoEl'.");if(!e)throw new Error("Invalid 'source'.");return new Promise((async(s,n)=>{let o;const r=()=>{t.removeEventListener("loadstart",c),t.removeEventListener("abort",d),t.removeEventListener("play",u),t.removeEventListener("error",p),t.removeEventListener("loadedmetadata",v);};let a=!1;const l=()=>{a=!0,o&&clearTimeout(o),r(),s(t);},h=t=>{o&&clearTimeout(o),r(),n(t);},c=()=>{t.addEventListener("abort",d,{once:!0});},d=()=>{const t=new Error("Video playing was interrupted.");t.name="AbortError",h(t);},u=()=>{l();},p=()=>{h(new Error(`Video error ${t.error.code}: ${t.error.message}.`));};let g;const f=new Promise((t=>{g=t;})),v=()=>{g();};if(t.addEventListener("loadstart",c,{once:!0}),t.addEventListener("play",u,{once:!0}),t.addEventListener("error",p,{once:!0}),t.addEventListener("loadedmetadata",v,{once:!0}),"string"==typeof e||e instanceof String?t.src=e:t.srcObject=e,t.autoplay&&await new Promise((t=>{setTimeout(t,1e3);})),!a){i&&(o=setTimeout((()=>{r(),n(new Error("Failed to play video. Timeout."));}),i));try{t.src&&await t.load(),await t.play(),l();}catch(t){}if(!a){await f;try{await t.play(),l();}catch(t){h(t);}}}}))}static async testCameraAccess(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))return {ok:!1,errorName:"InsecureContext",errorMessage:"Insecure context."};let s;try{s=t?await navigator.mediaDevices.getUserMedia(t):await navigator.mediaDevices.getUserMedia({video:!0});}catch(t){return {ok:!1,errorName:t.name,errorMessage:t.message}}finally{null==s||s.getTracks().forEach((t=>{t.stop();}));}return {ok:!0}}get state(){if(!sP(this,WP,"f"))return "closed";if("pending"===sP(this,WP,"f"))return "opening";if("fulfilled"===sP(this,WP,"f"))return "opened";throw new Error("Unknown state.")}set ifSaveLastUsedCamera(t){t&&fT.isStorageAvailable("localStorage")?nP(this,LP,!0,"f"):nP(this,LP,!1,"f");}get ifSaveLastUsedCamera(){return sP(this,LP,"f")}get isVideoPlaying(){return !(!sP(this,DP,"f")||sP(this,DP,"f").paused)&&"opened"===this.state}set tapFocusEventBoundEl(t){var e,i,s;if(!(t instanceof HTMLElement)&&null!=t)throw new TypeError("Invalid 'element'.");null===(e=sP(this,jP,"f"))||void 0===e||e.removeEventListener("click",sP(this,$P,"f")),null===(i=sP(this,jP,"f"))||void 0===i||i.removeEventListener("touchend",sP(this,$P,"f")),null===(s=sP(this,jP,"f"))||void 0===s||s.removeEventListener("touchmove",sP(this,zP,"f")),nP(this,jP,t,"f"),t&&(window.TouchEvent&&["Android","HarmonyOS","iPhone","iPad"].includes(cP.OS)?(t.addEventListener("touchend",sP(this,$P,"f")),t.addEventListener("touchmove",sP(this,zP,"f"))):t.addEventListener("click",sP(this,$P,"f")));}get tapFocusEventBoundEl(){return sP(this,jP,"f")}get disposed(){return sP(this,tT,"f")}constructor(t){var e,i;kP.add(this),DP.set(this,null),RP.set(this,void 0),EP.set(this,(()=>{"opened"===this.state&&sP(this,qP,"f").fire("resumed",null,{target:this,async:!1});})),MP.set(this,(()=>{sP(this,qP,"f").fire("paused",null,{target:this,async:!1});})),IP.set(this,void 0),BP.set(this,void 0),this.cameraOpenTimeout=15e3,this._arrCameras=[],UP.set(this,void 0),LP.set(this,!1),this.ifSkipCameraInspection=!1,this.selectIOSRearMainCameraAsDefault=!1,OP.set(this,void 0),NP.set(this,!0),_P.set(this,void 0),WP.set(this,void 0),FP.set(this,!1),this._focusParameters={maxTimeout:400,minTimeout:300,kTimeout:void 0,oldDistance:null,fds:null,isDoingFocus:0,taskBackToContinous:null,curFocusTaskId:0,focusCancelableTime:1500,defaultFocusAreaSizeRatio:6,focusBackToContinousTime:5e3,tapFocusMinDistance:null,tapFocusMaxDistance:null,focusArea:null,tempBufferContainer:null,defaultTempBufferContainerLenRatio:1/4},HP.set(this,!1),this._focusSupported=!0,this.calculateCoordInVideo=(t,e)=>{let i,s;const n=window.getComputedStyle(sP(this,DP,"f")).objectFit,o=this.getResolution(),r=sP(this,DP,"f").getBoundingClientRect(),a=r.left,l=r.top,{width:h,height:c}=sP(this,DP,"f").getBoundingClientRect();if(h<=0||c<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const d=h/c,u=o.width/o.height;let p=1;if("contain"===n)u>d?(p=h/o.width,i=(t-a)/p,s=(e-l-(c-h/u)/2)/p):(p=c/o.height,s=(e-l)/p,i=(t-a-(h-c*u)/2)/p);else {if("cover"!==n)throw new Error("Unsupported object-fit.");u>d?(p=c/o.height,s=(e-l)/p,i=(t-a+(c*u-h)/2)/p):(p=h/o.width,i=(t-a)/p,s=(e-l+(h/u-c)/2)/p);}return {x:i,y:s}},VP.set(this,!1),zP.set(this,(()=>{nP(this,VP,!0,"f");})),$P.set(this,(async t=>{var e;if(sP(this,VP,"f"))return void nP(this,VP,!1,"f");if(!sP(this,HP,"f"))return;if(!this.isVideoPlaying)return;if(!sP(this,RP,"f"))return;if(!this._focusSupported)return;if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(e=this.getCameraCapabilities())||void 0===e?void 0:e.focusDistance,!this._focusParameters.fds))return void(this._focusSupported=!1);if(null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),1==this._focusParameters.isDoingFocus)return;let i,s;if(this._focusParameters.taskBackToContinous&&(clearTimeout(this._focusParameters.taskBackToContinous),this._focusParameters.taskBackToContinous=null),t instanceof MouseEvent)i=t.clientX,s=t.clientY;else {if(!(t instanceof TouchEvent))throw new Error("Unknown event type.");if(!t.changedTouches.length)return;i=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY;}const n=this.getResolution(),o=2*Math.round(Math.min(n.width,n.height)/this._focusParameters.defaultFocusAreaSizeRatio/2);let r;try{r=this.calculateCoordInVideo(i,s);}catch(t){}if(r.x<0||r.x>n.width||r.y<0||r.y>n.height)return;const a={x:r.x+"px",y:r.y+"px"},l=o+"px",h=l;let c;fT._onLog&&(c=Date.now());try{await sP(this,kP,"m",cT).call(this,a,l,h,this._focusParameters.tapFocusMinDistance,this._focusParameters.tapFocusMaxDistance);}catch(t){if(fT._onLog)throw fT._onLog(t),t}fT._onLog&&fT._onLog(`Tap focus costs: ${Date.now()-c} ms`),this._focusParameters.taskBackToContinous=setTimeout((()=>{var t;fT._onLog&&fT._onLog("Back to continuous focus."),null===(t=sP(this,RP,"f"))||void 0===t||t.applyConstraints({advanced:[{focusMode:"continuous"}]}).catch((()=>{}));}),this._focusParameters.focusBackToContinousTime),sP(this,qP,"f").fire("tapfocus",null,{target:this,async:!1});})),jP.set(this,null),XP.set(this,1),GP.set(this,{x:0,y:0}),this.updateVideoElWhenSoftwareScaled=()=>{if(!sP(this,DP,"f"))return;const t=sP(this,XP,"f");if(t<1)throw new RangeError("Invalid scale value.");if(1===t)sP(this,DP,"f").style.transform="";else {const e=window.getComputedStyle(sP(this,DP,"f")).objectFit,i=sP(this,DP,"f").videoWidth,s=sP(this,DP,"f").videoHeight,{width:n,height:o}=sP(this,DP,"f").getBoundingClientRect();if(n<=0||o<=0)throw new Error("Unable to get video dimensions. Video may not be rendered on the page.");const r=n/o,a=i/s;let l=1;"contain"===e?l=r<a?n/(i/t):o/(s/t):"cover"===e&&(l=a>r?o/(i/t):n/(s/t));const h=l*(1-1/t)*(i/2-sP(this,GP,"f").x),c=l*(1-1/t)*(s/2-sP(this,GP,"f").y);sP(this,DP,"f").style.transform=`translate(${h}px, ${c}px) scale(${t})`;}},YP.set(this,(function(){if(!(this.data instanceof Uint8Array||this.data instanceof Uint8ClampedArray))throw new TypeError("Invalid data.");if("number"!=typeof this.width||this.width<=0)throw new Error("Invalid width.");if("number"!=typeof this.height||this.height<=0)throw new Error("Invalid height.");const t=document.createElement("canvas");let e;if(t.width=this.width,t.height=this.height,this.pixelFormat===gP.GREY){e=new Uint8ClampedArray(this.width*this.height*4);for(let t=0;t<e.length;t+=4)e[t]=this.data[t/4],e[t+1]=this.data[t/4],e[t+2]=this.data[t/4],e[t+3]=255;}else e=new Uint8ClampedArray(this.data.buffer);const i=new ImageData(e,this.width,this.height);return t.getContext("2d").putImageData(i,0,0),t})),qP.set(this,void 0),JP.set(this,["before:open","opened","before:close","closed","before:camera:change","camera:changed","before:resolution:change","resolution:changed","played","paused","resumed","tapfocus"]),this.detectedResolutions=[{width:160,height:120},{width:320,height:240},{width:480,height:360},{width:640,height:480},{width:800,height:600},{width:960,height:720},{width:1280,height:720},{width:1920,height:1080},{width:2560,height:1440},{width:3840,height:2160}],ZP.set(this,new Map),QP.set(this,!1),KP.set(this,(async()=>{var t,e;if("visible"===document.visibilityState){if(fT._onLog&&fT._onLog("document visible. video paused: "+(null===(t=sP(this,DP,"f"))||void 0===t?void 0:t.paused)),"opening"==this.state||"opened"==this.state){let t=!1;if(!this.isVideoPlaying){fT._onLog&&fT._onLog("document visible. Not auto resume. 1st resume start.");try{await this.resume(),t=!0;}catch(t){fT._onLog&&fT._onLog("document visible. 1st resume video failed, try open instead.");}t||await sP(this,kP,"m",oT).call(this);}if(await new Promise((t=>setTimeout(t,300))),!this.isVideoPlaying){fT._onLog&&fT._onLog("document visible. 1st open failed. 2rd resume start."),t=!1;try{await this.resume(),t=!0;}catch(t){fT._onLog&&fT._onLog("document visible. 2rd resume video failed, try open instead.");}t||await sP(this,kP,"m",oT).call(this);}}}else "hidden"===document.visibilityState&&(fT._onLog&&fT._onLog("document hidden. video paused: "+(null===(e=sP(this,DP,"f"))||void 0===e?void 0:e.paused)),"opening"==this.state||"opened"==this.state&&this.isVideoPlaying&&this.pause());})),tT.set(this,!1),(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia)||setTimeout((()=>{fT.onWarning&&fT.onWarning("The browser is too old or the page is loaded from an insecure origin.");}),0),this.defaultConstraints={video:{facingMode:{ideal:"environment"}}},this.resetMediaStreamConstraints(),t instanceof HTMLVideoElement&&this.setVideoEl(t),nP(this,qP,new pT,"f"),this.imageDataGetter=new CP,document.addEventListener("visibilitychange",sP(this,KP,"f"));}setVideoEl(t){if(!(t&&t instanceof HTMLVideoElement))throw new Error("Invalid 'videoEl'.");t.addEventListener("play",sP(this,EP,"f")),t.addEventListener("pause",sP(this,MP,"f")),nP(this,DP,t,"f");}getVideoEl(){return sP(this,DP,"f")}releaseVideoEl(){var t,e;null===(t=sP(this,DP,"f"))||void 0===t||t.removeEventListener("play",sP(this,EP,"f")),null===(e=sP(this,DP,"f"))||void 0===e||e.removeEventListener("pause",sP(this,MP,"f")),nP(this,DP,null,"f");}isVideoLoaded(){return !!sP(this,DP,"f")&&4==sP(this,DP,"f").readyState}async open(){if(sP(this,_P,"f")&&!sP(this,NP,"f")){if("pending"===sP(this,WP,"f"))return sP(this,_P,"f");if("fulfilled"===sP(this,WP,"f"))return}sP(this,qP,"f").fire("before:open",null,{target:this}),await sP(this,kP,"m",oT).call(this),sP(this,qP,"f").fire("played",null,{target:this,async:!1}),sP(this,qP,"f").fire("opened",null,{target:this,async:!1});}async close(){if("closed"===this.state)return;sP(this,qP,"f").fire("before:close",null,{target:this});const t=sP(this,_P,"f");if(sP(this,kP,"m",aT).call(this),t&&"pending"===sP(this,WP,"f")){try{await t;}catch(t){}if(!1===sP(this,NP,"f")){const t=new Error("'close()' was interrupted.");throw t.name="AbortError",t}}nP(this,_P,null,"f"),nP(this,WP,null,"f"),sP(this,qP,"f").fire("closed",null,{target:this,async:!1});}pause(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");sP(this,DP,"f").pause();}async resume(){if(!this.isVideoLoaded())throw new Error("Video is not loaded.");if("opened"!==this.state)throw new Error("Camera or video is not open.");await sP(this,DP,"f").play();}async setCamera(t){if("string"!=typeof t)throw new TypeError("Invalid 'deviceId'.");if("object"!=typeof sP(this,IP,"f").video&&(sP(this,IP,"f").video={}),delete sP(this,IP,"f").video.facingMode,sP(this,IP,"f").video.deviceId={exact:t},!("closed"===this.state||this.videoSrc||"opening"===this.state&&sP(this,NP,"f"))){sP(this,qP,"f").fire("before:camera:change",[],{target:this,async:!1}),await sP(this,kP,"m",rT).call(this);try{this.resetSoftwareScale();}catch(t){}return sP(this,BP,"f")}}async switchToFrontCamera(t){if("object"!=typeof sP(this,IP,"f").video&&(sP(this,IP,"f").video={}),(null==t?void 0:t.resolution)&&(sP(this,IP,"f").video.width={ideal:t.resolution.width},sP(this,IP,"f").video.height={ideal:t.resolution.height}),delete sP(this,IP,"f").video.deviceId,sP(this,IP,"f").video.facingMode={exact:"user"},nP(this,UP,null,"f"),!("closed"===this.state||this.videoSrc||"opening"===this.state&&sP(this,NP,"f"))){sP(this,qP,"f").fire("before:camera:change",[],{target:this,async:!1}),sP(this,kP,"m",rT).call(this);try{this.resetSoftwareScale();}catch(t){}return sP(this,BP,"f")}}getCamera(){var t;if(sP(this,BP,"f"))return sP(this,BP,"f");{let e=(null===(t=sP(this,IP,"f").video)||void 0===t?void 0:t.deviceId)||"";if(e){e=e.exact||e.ideal||e;for(let t of this._arrCameras)if(t.deviceId===e)return JSON.parse(JSON.stringify(t))}return {deviceId:"",label:"",_checked:!1}}}async _getCameras(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let s;if(t){let t=await navigator.mediaDevices.getUserMedia({video:!0});s=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind)),t.getTracks().forEach((t=>{t.stop();}));}else s=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind));const n=[],o=[];if(this._arrCameras)for(let t of this._arrCameras)t._checked&&o.push(t);for(let t=0;t<s.length;t++){let e,i=s[t];for(let t of o)if(i.deviceId==t.deviceId){e=t;break}e||(e={deviceId:i.deviceId,label:i.label?i.label:"camera "+t,_checked:!1}),e.deviceId&&n.push(e);}return this._arrCameras=n,fT._onLog&&fT._onLog(JSON.stringify(this._arrCameras)),n}async getCameras(){var t,e;if(!(null===(e=null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.mediaDevices)||void 0===e?void 0:e.enumerateDevices))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");const i=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"===t.kind));return i&&i.length&&!i[0].deviceId?this._getCameras(!0):this._getCameras(!1)}async getAllCameras(){return this.getCameras()}async setResolution(t,e,i){if("number"!=typeof t||t<=0)throw new TypeError("Invalid 'width'.");if("number"!=typeof e||e<=0)throw new TypeError("Invalid 'height'.");if("object"!=typeof sP(this,IP,"f").video&&(sP(this,IP,"f").video={}),i?(sP(this,IP,"f").video.width={exact:t},sP(this,IP,"f").video.height={exact:e}):(sP(this,IP,"f").video.width={ideal:t},sP(this,IP,"f").video.height={ideal:e}),"closed"===this.state||this.videoSrc||"opening"===this.state&&sP(this,NP,"f"))return null;sP(this,qP,"f").fire("before:resolution:change",[],{target:this,async:!1}),await sP(this,kP,"m",rT).call(this);try{this.resetSoftwareScale();}catch(t){}const s=this.getResolution();return {width:s.width,height:s.height}}getResolution(){if("opened"===this.state&&this.videoSrc&&sP(this,DP,"f"))return {width:sP(this,DP,"f").videoWidth,height:sP(this,DP,"f").videoHeight};if(sP(this,RP,"f")){const t=sP(this,RP,"f").getSettings();return {width:t.width,height:t.height}}if(this.isVideoLoaded())return {width:sP(this,DP,"f").videoWidth,height:sP(this,DP,"f").videoHeight};{const t={width:0,height:0};let e=sP(this,IP,"f").video.width||0,i=sP(this,IP,"f").video.height||0;return e&&(t.width=e.exact||e.ideal||e),i&&(t.height=i.exact||i.ideal||i),t}}async getResolutions(t){var e,i,s,n,o,r,a,l,h,c,d;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let u="";const p=(t,e)=>{const i=sP(this,ZP,"f").get(t);if(!i||!i.length)return !1;for(let t of i)if(t.width===e.width&&t.height===e.height)return !0;return !1};if(this._mediaStream){u=null===(d=sP(this,BP,"f"))||void 0===d?void 0:d.deviceId;let e=sP(this,ZP,"f").get(u);if(e&&!t)return JSON.parse(JSON.stringify(e));e=[],sP(this,ZP,"f").set(u,e),nP(this,FP,!0,"f");try{for(let t of this.detectedResolutions){await sP(this,RP,"f").applyConstraints({width:{ideal:t.width},height:{ideal:t.height}}),sP(this,kP,"m",iT).call(this);const i=sP(this,RP,"f").getSettings(),s={width:i.width,height:i.height};p(u,s)||e.push({width:s.width,height:s.height});}}catch(t){throw sP(this,kP,"m",aT).call(this),nP(this,FP,!1,"f"),t}try{await sP(this,kP,"m",oT).call(this);}catch(t){if("AbortError"===t.name)return e;throw t}finally{nP(this,FP,!1,"f");}return e}{const e=async(t,e,i)=>{const s={video:{deviceId:{exact:t},width:{ideal:e},height:{ideal:i}}};let n=null;try{n=await navigator.mediaDevices.getUserMedia(s);}catch(t){return null}if(!n)return null;const o=n.getVideoTracks();let r=null;try{const t=o[0].getSettings();r={width:t.width,height:t.height};}catch(t){const e=document.createElement("video");e.srcObject=n,r={width:e.videoWidth,height:e.videoHeight},e.srcObject=null;}return o.forEach((t=>{t.stop();})),r};let i=(null===(o=null===(n=null===(s=sP(this,IP,"f"))||void 0===s?void 0:s.video)||void 0===n?void 0:n.deviceId)||void 0===o?void 0:o.exact)||(null===(l=null===(a=null===(r=sP(this,IP,"f"))||void 0===r?void 0:r.video)||void 0===a?void 0:a.deviceId)||void 0===l?void 0:l.ideal)||(null===(c=null===(h=sP(this,IP,"f"))||void 0===h?void 0:h.video)||void 0===c?void 0:c.deviceId);if(!i)return [];let d=sP(this,ZP,"f").get(i);if(d&&!t)return JSON.parse(JSON.stringify(d));d=[],sP(this,ZP,"f").set(i,d);for(let t of this.detectedResolutions){const s=await e(i,t.width,t.height);s&&!p(i,s)&&d.push({width:s.width,height:s.height});}return d}}async setMediaStreamConstraints(t,e){if(!(t=>{return null!==t&&"[object Object]"===(e=t,Object.prototype.toString.call(e));var e;})(t))throw new TypeError("Invalid 'mediaStreamConstraints'.");nP(this,IP,JSON.parse(JSON.stringify(t)),"f"),nP(this,UP,null,"f"),e&&sP(this,kP,"m",rT).call(this);}getMediaStreamConstraints(){return JSON.parse(JSON.stringify(sP(this,IP,"f")))}resetMediaStreamConstraints(){nP(this,IP,this.defaultConstraints?JSON.parse(JSON.stringify(this.defaultConstraints)):null,"f");}getCameraCapabilities(){if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return sP(this,RP,"f").getCapabilities?sP(this,RP,"f").getCapabilities():{}}getCameraSettings(){if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");return sP(this,RP,"f").getSettings()}async turnOnTorch(){if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const t=this.getCameraCapabilities();if(!(null==t?void 0:t.torch))throw Error("Not supported.");await sP(this,RP,"f").applyConstraints({advanced:[{torch:!0}]});}async turnOffTorch(){if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const t=this.getCameraCapabilities();if(!(null==t?void 0:t.torch))throw Error("Not supported.");await sP(this,RP,"f").applyConstraints({advanced:[{torch:!1}]});}async setColorTemperature(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.colorTemperature;if(!s)throw Error("Not supported.");return e&&(t<s.min?t=s.min:t>s.max&&(t=s.max),t=gT(t,s.min,s.step,s.max)),await sP(this,RP,"f").applyConstraints({advanced:[{colorTemperature:t,whiteBalanceMode:"manual"}]}),t}getColorTemperature(){return this.getCameraSettings().colorTemperature||0}async setExposureCompensation(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.exposureCompensation;if(!s)throw Error("Not supported.");return e&&(t<s.min?t=s.min:t>s.max&&(t=s.max),t=gT(t,s.min,s.step,s.max)),await sP(this,RP,"f").applyConstraints({advanced:[{exposureCompensation:t}]}),t}getExposureCompensation(){return this.getCameraSettings().exposureCompensation||0}async setFrameRate(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");let s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.frameRate;if(!s)throw Error("Not supported.");e&&(t<s.min?t=s.min:t>s.max&&(t=s.max));const n=this.getResolution();return await sP(this,RP,"f").applyConstraints({width:{ideal:Math.max(n.width,n.height)},frameRate:t}),t}getFrameRate(){return this.getCameraSettings().frameRate}async setFocus(t,e){if("object"!=typeof t||Array.isArray(t)||null==t)throw new TypeError("Invalid 'settings'.");if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const i=this.getCameraCapabilities(),s=null==i?void 0:i.focusMode,n=null==i?void 0:i.focusDistance;if(!s)throw Error("Not supported.");if("string"!=typeof t.mode)throw TypeError("Invalid 'mode'.");const o=t.mode.toLowerCase();if(!s.includes(o))throw Error("Unsupported focus mode.");if("manual"===o){if(!n)throw Error("Manual focus unsupported.");if(t.hasOwnProperty("distance")){let i=t.distance;e&&(i<n.min?i=n.min:i>n.max&&(i=n.max),i=gT(i,n.min,n.step,n.max)),this._focusParameters.focusArea=null,await sP(this,RP,"f").applyConstraints({advanced:[{focusMode:o,focusDistance:i}]});}else {if(!t.area)throw new Error("'distance' or 'area' should be specified in 'manual' mode.");{const e=t.area.centerPoint;let i=t.area.width,s=t.area.height;if(!i||!s){const t=this.getResolution();i||(i=2*Math.round(Math.min(t.width,t.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px"),s||(s=2*Math.round(Math.min(t.width,t.height)/this._focusParameters.defaultFocusAreaSizeRatio/2)+"px");}this._focusParameters.focusArea={centerPoint:{x:e.x,y:e.y},width:i,height:s},await sP(this,kP,"m",cT).call(this,e,i,s);}}}else this._focusParameters.focusArea=null,await sP(this,RP,"f").applyConstraints({advanced:[{focusMode:o}]});}getFocus(){const t=this.getCameraSettings(),e=t.focusMode;return e?"manual"===e?this._focusParameters.focusArea?{mode:"manual",area:JSON.parse(JSON.stringify(this._focusParameters.focusArea))}:{mode:"manual",distance:t.focusDistance}:{mode:e}:null}async enableTapToFocus(){nP(this,HP,!0,"f");}disableTapToFocus(){nP(this,HP,!1,"f");}isTapToFocusEnabled(){return sP(this,HP,"f")}async setZoom(t){if("object"!=typeof t||Array.isArray(t)||null==t)throw new TypeError("Invalid 'settings'.");if("number"!=typeof t.factor)throw new TypeError("Illegal type of 'factor'.");if(t.factor<1)throw new RangeError("Invalid 'factor'.");if("opened"!==this.state)throw new Error("Video is not playing.");t.centerPoint?sP(this,kP,"m",dT).call(this,t.centerPoint):this.resetScaleCenter();try{if(sP(this,kP,"m",uT).call(this,sP(this,GP,"f"))){const e=await this.setHardwareScale(t.factor,!0);let i=this.getHardwareScale();1==i&&1!=e&&(i=e),t.factor>i?this.setSoftwareScale(t.factor/i):this.setSoftwareScale(1);}else await this.setHardwareScale(1),this.setSoftwareScale(t.factor);}catch(e){const i=e.message||e;if("Not supported."!==i&&"Camera is not open."!==i)throw e;this.setSoftwareScale(t.factor);}}getZoom(){if("opened"!==this.state)throw new Error("Video is not playing.");let t=1;try{t=this.getHardwareScale();}catch(t){if("Camera is not open."!==(t.message||t))throw t}return {factor:t*sP(this,XP,"f")}}async resetZoom(){await this.setZoom({factor:1});}async setHardwareScale(t,e){var i;if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(t<1)throw new RangeError("Invalid 'value'.");if(!sP(this,RP,"f")||"opened"!==this.state)throw new Error("Camera is not open.");const s=null===(i=this.getCameraCapabilities())||void 0===i?void 0:i.zoom;if(!s)throw Error("Not supported.");return e&&(t<s.min?t=s.min:t>s.max&&(t=s.max),t=gT(t,s.min,s.step,s.max)),await sP(this,RP,"f").applyConstraints({advanced:[{zoom:t}]}),t}getHardwareScale(){return this.getCameraSettings().zoom||1}setSoftwareScale(t,e){if("number"!=typeof t)throw new TypeError("Invalid 'value'.");if(t<1)throw new RangeError("Invalid 'value'.");if("opened"!==this.state)throw new Error("Video is not playing.");e&&sP(this,kP,"m",dT).call(this,e),nP(this,XP,t,"f"),this.updateVideoElWhenSoftwareScaled();}getSoftwareScale(){return sP(this,XP,"f")}resetScaleCenter(){if("opened"!==this.state)throw new Error("Video is not playing.");const t=this.getResolution();nP(this,GP,{x:t.width/2,y:t.height/2},"f");}resetSoftwareScale(){this.setSoftwareScale(1),this.resetScaleCenter();}getFrameData(t){if(this.disposed)throw Error("The 'Camera' instance has been disposed.");if(!this.isVideoLoaded())return null;if(sP(this,FP,"f"))return null;const e=Date.now();fT._onLog&&fT._onLog("getFrameData() START: "+e);const i=sP(this,DP,"f").videoWidth,s=sP(this,DP,"f").videoHeight;let n={sx:0,sy:0,sWidth:i,sHeight:s,dWidth:i,dHeight:s};(null==t?void 0:t.position)&&(n=JSON.parse(JSON.stringify(t.position)));let o=gP.RGBA;(null==t?void 0:t.pixelFormat)&&(o=t.pixelFormat);let r=sP(this,XP,"f");(null==t?void 0:t.scale)&&(r=t.scale);let a=sP(this,GP,"f");if(null==t?void 0:t.scaleCenter){if("string"!=typeof t.scaleCenter.x||"string"!=typeof t.scaleCenter.y)throw new Error("Invalid scale center.");let e=0,n=0;if(t.scaleCenter.x.endsWith("px"))e=parseFloat(t.scaleCenter.x);else {if(!t.scaleCenter.x.endsWith("%"))throw new Error("Invalid scale center.");e=parseFloat(t.scaleCenter.x)/100*i;}if(t.scaleCenter.y.endsWith("px"))n=parseFloat(t.scaleCenter.y);else {if(!t.scaleCenter.y.endsWith("%"))throw new Error("Invalid scale center.");n=parseFloat(t.scaleCenter.y)/100*s;}if(isNaN(e)||isNaN(n))throw new Error("Invalid scale center.");a.x=Math.round(e),a.y=Math.round(n);}let l=null;if((null==t?void 0:t.bufferContainer)&&(l=t.bufferContainer),0==i||0==s)return null;1!==r&&(n.sWidth=Math.round(n.sWidth/r),n.sHeight=Math.round(n.sHeight/r),n.sx=Math.round((1-1/r)*a.x+n.sx/r),n.sy=Math.round((1-1/r)*a.y+n.sy/r));const h=this.imageDataGetter.getImageData(sP(this,DP,"f"),i,s,n,{pixelFormat:o,bufferContainer:l});if(!h)return null;const c=Date.now();return fT._onLog&&fT._onLog("getFrameData() END: "+c),{data:h.data,width:h.width,height:h.height,pixelFormat:h.pixelFormat,timeSpent:c-e,timeStamp:c,toCanvas:sP(this,YP,"f")}}on(t,e){if(!sP(this,JP,"f").includes(t.toLowerCase()))throw new Error(`Event '${t}' does not exist.`);sP(this,qP,"f").on(t,e);}off(t,e){sP(this,qP,"f").off(t,e);}async dispose(){this.tapFocusEventBoundEl=null,await this.close(),this.releaseVideoEl(),sP(this,qP,"f").dispose(),this.imageDataGetter.dispose(),document.removeEventListener("visibilitychange",sP(this,KP,"f")),nP(this,tT,!0,"f");}}function vT(t,e){js(e)&&(t.config.maxFrameNumber=e);}function mT(t,e){js(e)&&(t.config.autoCaptureDelay=e);}function yT(t,e){if(!Vs(e))return;const{context:i}=t.viewer;i.core.detectorService.enableDetect&&(t.config.enableAutoDetect=e,t.isVideoPlaying&&(t.viewer.hooks.autoDetectChanged.emit(xf.create(e)),e?t.loop.startLoop():t.config.enableAutoCapture?t.loop.cancelAnimation():t.loop.closeLoop()));}function xT(t,e){Vs(e)&&(t.config.enableAutoCapture=e,t.isVideoPlaying&&(t.viewer.hooks.autoCaptureChanged.emit(wf.create(e)),e?t.loop.startLoop():t.config.enableAutoDetect||t.loop.closeLoop()));}function wT(t,e){js(e)&&(t.config.acceptedPolygonConfidence=e);}function bT(t,e){return !!t.videoEl&&(t.config.fullscreen=e,t.videoEl.style.objectFit=e?"cover":"contain",t.loop.updateVideoLayout(),!0)}DP=new WeakMap,RP=new WeakMap,EP=new WeakMap,MP=new WeakMap,IP=new WeakMap,BP=new WeakMap,UP=new WeakMap,LP=new WeakMap,OP=new WeakMap,NP=new WeakMap,_P=new WeakMap,WP=new WeakMap,FP=new WeakMap,HP=new WeakMap,VP=new WeakMap,zP=new WeakMap,$P=new WeakMap,jP=new WeakMap,XP=new WeakMap,GP=new WeakMap,YP=new WeakMap,qP=new WeakMap,JP=new WeakMap,ZP=new WeakMap,QP=new WeakMap,KP=new WeakMap,tT=new WeakMap,kP=new WeakSet,eT=async function(){const t=this.getMediaStreamConstraints();if("boolean"==typeof t.video&&(t.video={}),t.video.deviceId);else if(sP(this,UP,"f"))delete t.video.facingMode,t.video.deviceId={exact:sP(this,UP,"f")};else if(this.ifSaveLastUsedCamera&&fT.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete t.video.facingMode,t.video.deviceId={ideal:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),i=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&i&&(t.video.width=e,t.video.height=i);}else if(this.ifSkipCameraInspection);else {const e=async t=>{let e=null;return "environment"===t&&["Android","HarmonyOS","iPhone","iPad"].includes(cP.OS)?(await this._getCameras(!1),sP(this,kP,"m",iT).call(this),e=fT.findBestCamera(this._arrCameras,"environment",{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})):t||["Android","HarmonyOS","iPhone","iPad"].includes(cP.OS)||(await this._getCameras(!1),sP(this,kP,"m",iT).call(this),e=fT.findBestCamera(this._arrCameras,null,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault})),e};let i=t.video.facingMode;i instanceof Array&&i.length&&(i=i[0]),"object"==typeof i&&(i=i.exact||i.ideal);const s=await e(i);s&&(delete t.video.facingMode,t.video.deviceId={exact:s});}return t},iT=function(){if(sP(this,NP,"f")){const t=new Error("The operation was interrupted.");throw t.name="AbortError",t}},sT=async function(t){var e,i;if(!(null===(i=null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.mediaDevices)||void 0===i?void 0:i.getUserMedia))throw new Error("Failed to access the camera because the browser is too old or the page is loaded from an insecure origin.");let s;try{fT._onLog&&fT._onLog("======try getUserMedia========");let e=[0,500,1e3,2e3],i=null;const n=async t=>{for(let n of e){n&&(await new Promise((t=>setTimeout(t,n))),sP(this,kP,"m",iT).call(this));try{fT._onLog&&fT._onLog("ask "+JSON.stringify(t)),s=await navigator.mediaDevices.getUserMedia(t),sP(this,kP,"m",iT).call(this);break}catch(t){if("NotFoundError"===t.name||"NotAllowedError"===t.name||"AbortError"===t.name||"OverconstrainedError"===t.name)throw t;i=t,fT._onLog&&fT._onLog(t.message||t);}}};if(await n(t),s||"object"!=typeof t.video||(t.video.deviceId&&(delete t.video.deviceId,await n(t)),!s&&t.video.facingMode&&(delete t.video.facingMode,await n(t)),s||!t.video.width&&!t.video.height||(delete t.video.width,delete t.video.height,await n(t))),!s)throw i;return s}catch(t){throw null==s||s.getTracks().forEach((t=>{t.stop();})),"NotFoundError"===t.name&&(DOMException?t=new DOMException("No camera available, please use a device with an accessible camera.",t.name):(t=new Error("No camera available, please use a device with an accessible camera.")).name="NotFoundError"),t}},nT=function(){this._mediaStream&&(this._mediaStream.getTracks().forEach((t=>{t.stop();})),this._mediaStream=null),nP(this,RP,null,"f");},oT=async function(){nP(this,NP,!1,"f");const t=nP(this,OP,Symbol(),"f");if(sP(this,_P,"f")&&"pending"===sP(this,WP,"f")){try{await sP(this,_P,"f");}catch(t){}sP(this,kP,"m",iT).call(this);}if(t!==sP(this,OP,"f"))return;const e=nP(this,_P,(async()=>{nP(this,WP,"pending","f");try{if(this.videoSrc){if(!sP(this,DP,"f"))throw new Error("'videoEl' should be set.");await fT.playVideo(sP(this,DP,"f"),this.videoSrc,this.cameraOpenTimeout),sP(this,kP,"m",iT).call(this);}else {let t=await sP(this,kP,"m",eT).call(this);sP(this,kP,"m",nT).call(this);let e=await sP(this,kP,"m",sT).call(this,t);await this._getCameras(!1),sP(this,kP,"m",iT).call(this);const i=()=>{const t=e.getVideoTracks();let i,s;if(t.length&&(i=t[0]),i){const t=i.getSettings();if(t)for(let e of this._arrCameras)if(t.deviceId===e.deviceId){e._checked=!0,e.label=i.label,s=e;break}}return s},s=sP(this,IP,"f");if("object"==typeof s.video){let n=s.video.facingMode;if(n instanceof Array&&n.length&&(n=n[0]),"object"==typeof n&&(n=n.exact||n.ideal),!(sP(this,UP,"f")||this.ifSaveLastUsedCamera&&fT.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")||this.ifSkipCameraInspection||s.video.deviceId)){const s=i(),o=fT.findBestCamera(this._arrCameras,n,{getMainCameraInIOS:this.selectIOSRearMainCameraAsDefault});o&&o!=(null==s?void 0:s.deviceId)&&(e.getTracks().forEach((t=>{t.stop();})),t.video.deviceId={exact:o},e=await sP(this,kP,"m",sT).call(this,t),sP(this,kP,"m",iT).call(this));}}const n=i();(null==n?void 0:n.deviceId)&&(nP(this,UP,n&&n.deviceId,"f"),this.ifSaveLastUsedCamera&&fT.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",sP(this,UP,"f")),"object"==typeof t.video&&t.video.width&&t.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(t.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(t.video.height))))),sP(this,DP,"f")&&(await fT.playVideo(sP(this,DP,"f"),e,this.cameraOpenTimeout),sP(this,kP,"m",iT).call(this)),this._mediaStream=e;const o=e.getVideoTracks();(null==o?void 0:o.length)&&nP(this,RP,o[0],"f"),nP(this,BP,n,"f");}}catch(t){throw sP(this,kP,"m",aT).call(this),nP(this,WP,null,"f"),t}nP(this,WP,"fulfilled","f");})(),"f");return e},rT=async function(){var t;if("closed"===this.state||this.videoSrc)return;const e=null===(t=sP(this,BP,"f"))||void 0===t?void 0:t.deviceId,i=this.getResolution();await sP(this,kP,"m",oT).call(this);const s=this.getResolution();e&&e!==sP(this,BP,"f").deviceId&&sP(this,qP,"f").fire("camera:changed",[sP(this,BP,"f").deviceId,e],{target:this,async:!1}),i.width==s.width&&i.height==s.height||sP(this,qP,"f").fire("resolution:changed",[{width:s.width,height:s.height},{width:i.width,height:i.height}],{target:this,async:!1}),sP(this,qP,"f").fire("played",null,{target:this,async:!1});},aT=function(){sP(this,kP,"m",nT).call(this),nP(this,BP,null,"f"),sP(this,DP,"f")&&(sP(this,DP,"f").srcObject=null,this.videoSrc&&(sP(this,DP,"f").pause(),sP(this,DP,"f").currentTime=0)),nP(this,NP,!0,"f");try{this.resetSoftwareScale();}catch(t){}},lT=async function t(e,i){const s=t=>{if(!sP(this,RP,"f")||!this.isVideoPlaying||t.focusTaskId!=this._focusParameters.curFocusTaskId){sP(this,RP,"f")&&this.isVideoPlaying||(this._focusParameters.isDoingFocus=0);const e=new Error(`Focus task ${t.focusTaskId} canceled.`);throw e.name="DeprecatedTaskError",e}1===this._focusParameters.isDoingFocus&&Date.now()-t.timeStart>this._focusParameters.focusCancelableTime&&(this._focusParameters.isDoingFocus=-1);};let n;i=gT(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),await sP(this,RP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}),s(e),n=null==this._focusParameters.oldDistance?this._focusParameters.kTimeout*Math.max(Math.abs(1/this._focusParameters.fds.min-1/i),Math.abs(1/this._focusParameters.fds.max-1/i))+this._focusParameters.minTimeout:this._focusParameters.kTimeout*Math.abs(1/this._focusParameters.oldDistance-1/i)+this._focusParameters.minTimeout,this._focusParameters.oldDistance=i,await new Promise((t=>{setTimeout(t,n);})),s(e);let o=e.focusL-e.focusW/2,r=e.focusT-e.focusH/2,a=e.focusW,l=e.focusH;const h=this.getResolution();if(o>=h.width||r>=h.height)throw new Error("Invalid area.");o+a>h.width&&(a=h.width-o),r+l>h.height&&(l=h.height-r),o=Math.round(o),r=Math.round(r),a=Math.round(a),l=Math.round(l);const c=4*h.width*h.height*this._focusParameters.defaultTempBufferContainerLenRatio,d=4*a*l;let u=this._focusParameters.tempBufferContainer;if(u){const t=u.length;c>t&&c>=d?u=new Uint8Array(c):d>t&&d>=c&&(u=new Uint8Array(d));}else u=this._focusParameters.tempBufferContainer=new Uint8Array(Math.max(c,d));if(!this.imageDataGetter.getImageData(sP(this,DP,"f"),h.width,h.height,{sx:o,sy:r,sWidth:a,sHeight:l,dWidth:a,dHeight:l},{pixelFormat:gP.RGBA,bufferContainer:u}))return sP(this,kP,"m",t).call(this,e,i);const p=u;let g=0;for(let t=0,e=d-8;t<e;++t){let e=p[t]-p[t+8];++t;let i=p[t]-p[t+8];++t;let s=p[t]-p[t+8];++t,g+=e*e+i*i+s*s;}return -g},hT=async function t(e,i,s,n,o,r,a){let l;if(i=gT(i,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=gT(n,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r?r=gT(r,this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max):(r=gT(Math.sqrt((i||this._focusParameters.fds.step)*(n||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),a=await sP(this,kP,"m",lT).call(this,e,r)),a<=s&&a<=o?l=3:s<o&&s<a?l=1:o<s&&o<a&&(l=2),(n-i)/2<=this._focusParameters.fds.step)return 3===l||(1===l?await sP(this,RP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}):2===l&&await sP(this,RP,"f").applyConstraints({advanced:[{focusMode:"manual",focusDistance:n}]})),!0;if(1===l)return await sP(this,kP,"m",t).call(this,e,i,s,r,a);if(2===l)return await sP(this,kP,"m",t).call(this,e,r,a,n,o);if(3!==l)return s=await sP(this,kP,"m",lT).call(this,e,i),o=await sP(this,kP,"m",lT).call(this,e,n),await sP(this,kP,"m",t).call(this,e,i,s,n,o);let h=gT(Math.sqrt((i||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),c=gT(Math.sqrt((n||this._focusParameters.fds.step)*(r||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max);if(Math.abs(1/this._focusParameters.oldDistance-1/h)<=Math.abs(1/this._focusParameters.oldDistance-1/c)){let l=await sP(this,kP,"m",lT).call(this,e,h);if(l<a)return await sP(this,kP,"m",t).call(this,e,i,s,r,a,h,l);if(l==a)return await sP(this,kP,"m",t).call(this,e,h,l,r,a);let d=await sP(this,kP,"m",lT).call(this,e,c);if(l>a&&a<d)return await sP(this,kP,"m",t).call(this,e,h,l,c,d,r,a);if(a==d)return await sP(this,kP,"m",t).call(this,e,r,a,c,d);if(a>d)return await sP(this,kP,"m",t).call(this,e,r,a,n,o,c,d)}else {let l=await sP(this,kP,"m",lT).call(this,e,c);if(a>l)return await sP(this,kP,"m",t).call(this,e,r,a,n,o,c,l);if(a==l)return await sP(this,kP,"m",t).call(this,e,r,a,c,l);let d=await sP(this,kP,"m",lT).call(this,e,h);if(d>a&&a<l)return await sP(this,kP,"m",t).call(this,e,h,d,c,l,r,a);if(d==a)return await sP(this,kP,"m",t).call(this,e,h,d,r,a);if(d<a)return await sP(this,kP,"m",t).call(this,e,i,s,r,a,h,d)}return !1},cT=async function(t,e,i,s,n){var o;if(1==this._focusParameters.isDoingFocus)return !1;if(!t||"string"!=typeof t.x||"string"!=typeof t.y)throw new Error("Invalid 'centerPoint'.");if(!e||"string"!=typeof e)throw new Error("Invalid 'width'.");if(!i||"string"!=typeof i)throw new Error("Invalid 'height'.");const r=this.getResolution();let a=0,l=0;if(t.x.endsWith("px"))a=parseFloat(t.x);else {if(!t.x.endsWith("%"))throw new Error("Invalid 'centerPoint'.");a=parseFloat(t.x)/100*r.width;}if(t.y.endsWith("px"))l=parseFloat(t.y);else {if(!t.y.endsWith("%"))throw new Error("Invalid 'centerPoint'.");l=parseFloat(t.y)/100*r.height;}if(isNaN(a)||isNaN(l)||a<0||a>r.width||l<0||l>r.height)throw new Error("Invalid 'centerPoint'.");let h=0;if(e.endsWith("px"))h=parseFloat(e);else {if(!e.endsWith("%"))throw new Error("Invalid 'width'.");h=parseFloat(e)/100*r.width;}if(isNaN(h)||h<0)throw new Error("Invalid 'width'.");let c=0;if(i.endsWith("px"))c=parseFloat(i);else {if(!i.endsWith("%"))throw new Error("Invalid 'height'.");c=parseFloat(i)/100*r.height;}if(isNaN(c)||c<0)throw new Error("Invalid 'height'.");if(1!==sP(this,XP,"f")){const t=sP(this,XP,"f"),e=sP(this,GP,"f");h/=t,c/=t,a=(1-1/t)*e.x+a/t,l=(1-1/t)*e.y+l/t;}if(!this._focusSupported)throw new Error("Manual focus unsupported.");if(!this._focusParameters.fds&&(this._focusParameters.fds=null===(o=this.getCameraCapabilities())||void 0===o?void 0:o.focusDistance,!this._focusParameters.fds))throw this._focusSupported=!1,new Error("Manual focus unsupported.");null==this._focusParameters.kTimeout&&(this._focusParameters.kTimeout=(this._focusParameters.maxTimeout-this._focusParameters.minTimeout)/(1/this._focusParameters.fds.min-1/this._focusParameters.fds.max)),this._focusParameters.isDoingFocus=1;const d={focusL:a,focusT:l,focusW:h,focusH:c,focusTaskId:++this._focusParameters.curFocusTaskId,timeStart:Date.now()},u=async(t,e,i)=>{try{(null==e||e<this._focusParameters.fds.min)&&(e=this._focusParameters.fds.min),(null==i||i>this._focusParameters.fds.max)&&(i=this._focusParameters.fds.max),this._focusParameters.oldDistance=null;let s=gT(Math.sqrt(i*(e||this._focusParameters.fds.step)),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),n=gT(Math.sqrt((e||this._focusParameters.fds.step)*s),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),o=gT(Math.sqrt(s*i),this._focusParameters.fds.min,this._focusParameters.fds.step,this._focusParameters.fds.max),r=await sP(this,kP,"m",lT).call(this,t,o),a=await sP(this,kP,"m",lT).call(this,t,n),l=await sP(this,kP,"m",lT).call(this,t,s);if(a>l&&l<r){const e=await sP(this,kP,"m",hT).call(this,t,n,a,o,r,s,l);return this._focusParameters.isDoingFocus=0,e}if(a<l&&a<r){let i=await sP(this,kP,"m",lT).call(this,t,e);const o=await sP(this,kP,"m",hT).call(this,t,e,i,s,l,n,a);return this._focusParameters.isDoingFocus=0,o}if(l>r&&a>r){let e=await sP(this,kP,"m",lT).call(this,t,i);const n=await sP(this,kP,"m",hT).call(this,t,s,l,i,e,o,r);return this._focusParameters.isDoingFocus=0,n}if(a==l&&l<r){const e=await sP(this,kP,"m",hT).call(this,t,n,a,s,l);return this._focusParameters.isDoingFocus=0,e}if(l==r&&a>l){const e=await sP(this,kP,"m",hT).call(this,t,s,l,o,r);return this._focusParameters.isDoingFocus=0,e}return u(t,e,i)}catch(t){if("DeprecatedTaskError"!==t.name)throw t}};return u(d,s,n)},dT=function(t){if("opened"!==this.state)throw new Error("Video is not playing.");if(!t||"string"!=typeof t.x||"string"!=typeof t.y)throw new Error("Invalid 'center'.");const e=this.getResolution();let i=0,s=0;if(t.x.endsWith("px"))i=parseFloat(t.x);else {if(!t.x.endsWith("%"))throw new Error("Invalid scale center.");i=parseFloat(t.x)/100*e.width;}if(t.y.endsWith("px"))s=parseFloat(t.y);else {if(!t.y.endsWith("%"))throw new Error("Invalid scale center.");s=parseFloat(t.y)/100*e.height;}if(isNaN(i)||isNaN(s))throw new Error("Invalid scale center.");nP(this,GP,{x:i,y:s},"f");},uT=function(t){if("opened"!==this.state)throw new Error("Video is not playing.");const e=this.getResolution();return t&&t.x==e.width/2&&t.y==e.height/2},fT.browserInfo=cP,fT.onWarning=null===(AP=null===window||void 0===window?void 0:window.console)||void 0===AP?void 0:AP.warn;class ST{constructor(t){i(this,"isLooping",!1),i(this,"lastDetectTime",(new Date).getTime()),i(this,"loopTimer",void 0),i(this,"autoCaptureStartTime",0),i(this,"lastRenderedQuad",void 0),i(this,"animation",void 0),i(this,"cameraContext",void 0),i(this,"videoLayout",void 0),this.cameraContext=t;}getLoopState(){const{enableAutoCapture:t,enableAutoDetect:e}=this.cameraContext.config;return t||e}clearLoopTimer(){clearTimeout(this.loopTimer),this.loopTimer=null,this.isLooping=!1,this.autoCaptureStartTime=0,this.lastDetectTime=(new Date).getTime();}loopTimeout(){if(!this.cameraContext.isVideoPlaying&&!this.getLoopState())return;const t=this.getDetectRemainTime();this.loopTimer=setTimeout((async()=>{if(!this.getLoopState()||this.isLooping)return;this.isLooping=!0;const t=await this.loopTaskDetail();this.isLooping=!1,t&&this.getLoopState()&&setTimeout((()=>{this.getLoopState()&&this.loopTimeout();}),10);}),t);}async loopTaskDetail(){if(!(this.cameraContext&&this.cameraContext.isVideoPlaying&&this.cameraContext.videoEl&&this.cameraContext.canvasEl))return !1;if(!this.getLoopState())return !1;const{viewer:t}=this.cameraContext;if(this.lastDetectTime=(new Date).getTime(),!t.context.viewService.isBindContainer)return !0;if("hidden"===t.getViewerConfig().visibility)return !1;const{config:e}=this.cameraContext,{enableDetect:i}=t.context.core.detectorService,s=this.cameraContext.getFrameData();if(!s)return !1;const n={type:1,data:s.data.buffer,height:s.height,width:s.width};let o={success:!1};var r;i&&(o=await this.getDetectResult(n),0===s.data.length&&(s.data=new Uint8Array(n.data)),e.enableAutoDetect&&this.cameraContext.isVideoPlaying&&o.success&&null!==(r=o)&&void 0!==r&&r.location?(this.lastRenderedQuad?this.createDetectAnimation(this.lastRenderedQuad,o.location):this.drawQuadrilateral(o.location),this.lastRenderedQuad=o.location):(this.clearCanvas(),this.lastRenderedQuad=null));let a=!1;var l;if(e.enableAutoCapture){if((null===(l=o)||void 0===l?void 0:l.status)===Kd.AUTO_CAPTURE&&(a=!0),!i)if(this.autoCaptureStartTime<=0)this.autoCaptureStartTime=(new Date).getTime();else {(new Date).getTime()-this.autoCaptureStartTime>e.autoCaptureDelay&&(this.autoCaptureStartTime=0,a=!0);}}else this.autoCaptureStartTime=0;if(a){var h,c,d;if(null===(h=this.cameraContext.viewer)||void 0===h||!h.context)return !1;const t=await this.cameraContext.viewer.context.core.processService.resize(s.data.buffer,1,s.width,s.height,-1);if(this.cameraContext.isCapturedPages=!0,null===(c=this.cameraContext.viewer)||void 0===c||!c.context)return !1;await this.cameraContext.viewer.context.loadSource({extraPageData:[{index:0,perspectiveQuad:null===(d=o)||void 0===d?void 0:d.location}],fileData:t.data}),this.startCaptureAnimation(),await CT(),this.closeCaptureAnimation();}return !0}getDetectRemainTime(){const t=(new Date).getTime(),{maxFrameNumber:e}=this.cameraContext.config,i=t-this.lastDetectTime;return Math.max(0,1e3/e-i)}startLoop(){this.loopTimer||(this.getLoopState()?this.loopTimeout():(this.clearLoopTimer(),this.clearCanvas()));}closeLoop(){if(!this.loopTimer)return;const{context:t}=this.cameraContext.viewer,{detectorService:e}=t.core;e.resetDetector(),this.clearLoopTimer(),this.clearCanvas(),cancelAnimationFrame(this.animation);}updateVideoLayout(){const{videoEl:t,config:e}=this.cameraContext,{fullscreen:i}=e,{videoWidth:s,videoHeight:n}=t,{width:o,height:r}=t.getBoundingClientRect(),a={zoom:1,left:0,top:0};if(i){const t=Math.max(o/s,r/n);a.zoom=t;}else {const t=Math.min(o/s,r/n),e=(o-s*t)/2,i=(r-n*t)/2;a.zoom=t,a.left=e,a.top=i;}this.videoLayout=a;}async getDetectResult(t){const{cameraContext:e}=this,{context:i}=e.viewer,{detectorService:s}=i.core;if(!s.enableDetect)return Promise.resolve({success:!1});let n=t;if(!t){const t=e.getFrameData();n={type:1,data:t.data.buffer,height:t.height,width:t.width};}const{acceptedPolygonConfidence:o,enableAutoCapture:r,autoCaptureDelay:a}=e.config,l={acceptedPolygonConfidence:o,enableAutoCapture:r,autoCaptureDelay:a},h=await s.detect(n,l);return h||Promise.resolve({success:!1})}drawQuadrilateral(t){if(!this.loopTimer)return;const{canvasEl:e,viewer:i}=this.cameraContext;if(!e)return;const{zoom:s,left:n,top:o}=this.videoLayout,r=e.getContext("2d");r.save(),r.clearRect(0,0,e.width,e.height),r.translate(n,o),r.scale(s,s),r.beginPath(),r.moveTo(t[0][0],t[0][1]);for(let e=1;e<t.length;e++)r.lineTo(t[e][0],t[e][1]);r.closePath();const{quadSelectionStyle:a}=i.getViewerConfig(),{border:l,background:h}=a,{borderWidth:c,borderColor:d,borderStyle:u}=wn(l);let p=Cr(c).value/s;0===p&&(p=1);const g="solid"===u?[0,0]:[5*p,2*p];r.strokeStyle=d,r.fillStyle=h,r.lineCap="round",r.lineWidth=p,r.setLineDash(g),r.fill(),r.stroke(),r.restore();}clearCanvas(){const{canvasEl:t}=this.cameraContext;if(!t)return;t.getContext("2d").clearRect(0,0,t.width,t.height);}cancelAnimation(){this.clearCanvas(),cancelAnimationFrame(this.animation);}createDetectAnimation(t,e){let i=0;const s=()=>{this.clearCanvas();const n=t.map(((t,s)=>{const n=e[s];return [t[0]+(n[0]-t[0])*i,t[1]+(n[1]-t[1])*i]}));this.drawQuadrilateral(n),i<1&&(i+=.2,this.animation=requestAnimationFrame(s));};s();}startCaptureAnimation(){var t,e;this.cameraContext&&null!==(t=this.cameraContext)&&void 0!==t&&t.videoEl&&null!==(e=this.cameraContext)&&void 0!==e&&e.canvasEl&&(this.cameraContext.videoEl.style.filter="brightness(0%)",this.cameraContext.canvasEl.style.visibility="hidden");}closeCaptureAnimation(){var t,e;this.cameraContext&&null!==(t=this.cameraContext)&&void 0!==t&&t.videoEl&&null!==(e=this.cameraContext)&&void 0!==e&&e.canvasEl&&(this.cameraContext.videoEl.style.filter="brightness(100%)",this.cameraContext.canvasEl.style.visibility="");}}function CT(){return new Promise((t=>{setTimeout((()=>{t("");}),50);}))}const PT={tag:"div",id:"ddv-camera-container",className:"ddv-camera-container",children:[{tag:"video",id:"ddv-camera-video",class:"ddv-camera-camera"},{tag:"canvas",id:"ddv-camera-canvas",class:"ddv-camera-canvas"}]},TT={enableAutoCapture:!1,enableAutoDetect:!1,enableTorch:!1,maxFrameNumber:10,acceptedPolygonConfidence:65,fullscreen:!1,autoCaptureDelay:1e3};class AT{constructor(t){var e;if(i(this,"camera",void 0),i(this,"configHandler",{}),i(this,"isHttps",!0),i(this,"lastDeviceId",void 0),i(this,"isFirstPlayed",!0),i(this,"isTurningTorch",!1),i(this,"initializing",!1),i(this,"cameraContainer",void 0),i(this,"viewer",void 0),i(this,"loop",void 0),i(this,"videoEl",void 0),i(this,"canvasEl",void 0),i(this,"config",Ns(TT)),i(this,"bUser",!1),i(this,"canFrontCamera",!1),i(this,"isCapturedPages",!1),i(this,"lastEnvironmentCameraId",void 0),i(this,"cameraList",[]),i(this,"turnOnTheTorch",!1),i(this,"torchSupported",!1),this.viewer=t,this.camera=new fT,this.loop=new ST(this),this.initConfigHandler(),null!==(e=navigator)&&void 0!==e&&null!==(e=e.mediaDevices)&&void 0!==e&&e.getUserMedia||(this.isHttps=!1),this.isCaptureViewer&&this.isHttps){this.initializing=!0;const t=this.getCameras().then((t=>{this.cameraList=t;})),e=this.getFrontCamera().then((t=>{this.canFrontCamera=t,this.viewer.hooks.cameraInit.emit(Sf.create(t));})).catch((t=>{}));Promise.all([t,e]).finally((()=>{this.initializing=!1;}));}this.camera.setResolution(1280,720),this.bindCameraEvents(),this.initHooks(),this.handleViewerModeChanged(),this.bindNativeEvents(),this.handleExternalEvents();}initHooks(){this.bindViewerHooks(),this.bindGlobalHooks();}handleViewerModeChanged(){const{defaultDom:t,mainAndThbContainer:e}=this.viewer.context.viewService;if(this.isCaptureViewer){if(!this.cameraContainer){const e=Sm(PT,this.viewer.postfix);this.cameraContainer=e,Object.assign(e.style,this.viewer.context.viewerConfig.canvasStyle),t.appendChild(e);const i=e.getElementsByTagName("video")[0],s=e.getElementsByTagName("canvas")[0];i.setAttribute("playsinline","true"),i.setAttribute("muted","true"),i.setAttribute("disablePictureInPicture","true"),i.setAttribute("autoplay","autoplay"),i.setAttribute("poster","data:image/gif;base64,R0lGODlhAQABAIEAAAAAAAAAAAAAAAAAACH5BAEAAAAALAAAAAABAAEAAAgEAAEEBAA7"),i.style.transition="opacity 300ms, filter 100ms ease",this.bindCameraVideo(i),this.bindCameraCanvas(s),this.updateCameraConfig(TT);}Pm(this.cameraContainer,"flex"),Cm(e);}else Cm(this.cameraContainer),Pm(e,"flex");}initConfigHandler(){const t={maxFrameNumber:vT,enableAutoCapture:xT,enableAutoDetect:yT,acceptedPolygonConfidence:wT,fullscreen:bT,autoCaptureDelay:mT};this.configHandler=t;}bindViewerHooks(){this.viewer.hooks.visibleChanged.on((t=>{this.loop.closeLoop(),"visible"===t.newVisibility&&this.loop.startLoop();}),this);}bindGlobalHooks(){this.viewer.context.core.documentService.onAddPagesToDoc.on((t=>{if(!this.isCapturedPages)return;const e=mf.create(t.pageUids[0]);this.viewer.hooks.cameraCaptured.emit(e),this.isCapturedPages=!1;}),this.viewer);}bindCameraEvents(){const{camera:t}=this;t.on("paused",(()=>{this.loop.closeLoop();})),t.on("resumed",(()=>{this.loop.closeLoop(),this.loop.startLoop();})),t.on("before:open",(()=>{this.videoEl&&(this.videoEl.style.opacity="0");})),t.on("before:resolution:change",(()=>{this.videoEl&&(this.videoEl.style.opacity="0"),this.loop.closeLoop();})),t.on("before:camera:change",(()=>{this.videoEl&&(this.videoEl.style.opacity="0"),this.loop.closeLoop(),this.lastDeviceId=this.camera.getCamera().deviceId;})),t.on("camera:changed",(()=>{const t=yf.create(this.lastDeviceId,this.camera.getCamera().deviceId);this.viewer.hooks.cameraChanged.emit(t);})),t.on("played",(()=>{if(!this.videoEl||!this.isVideoPlaying)return;this.videoEl.style.opacity="1";const{enableTorch:t}=this.config,e=this.camera.getResolution();let i="unsupported";try{const t=this.camera.getCameraCapabilities();i=null!=t&&t.torch?"supported":"unsupported";}catch(t){}this.torchSupported="supported"===i,this.emitTorchChanged(i),"supported"===i&&t&&this.turnOnTorch().catch((()=>{this.config.enableTorch=!0;})),this.viewer.hooks.cameraPlayed.emit(bf.create(e)),this.loop.updateVideoLayout(),this.loop.closeLoop(),this.loop.startLoop();})),t.on("closed",(()=>{this.isVideoPlaying||(this.loop.closeLoop(),this.viewer.hooks.cameraClosed.emit(),this.emitTorchChanged("unsupported"));}));}emitTorchChanged(t){this.viewer.hooks.torchChanged.emit(Cf.create(t));}getPointerEvent(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=0,n=0,o=0,r=0;if(e){const{left:t,top:i}=e.getBoundingClientRect();o=t,r=i;}return t instanceof PointerEvent||t instanceof MouseEvent?(s=t.offsetX,n=t.offsetY):i?(s=t.changedTouches[0].clientX-o,n=t.changedTouches[0].clientY-r):(s=t.touches[0].clientX-o,n=t.touches[0].clientY-r),{index:-1,pageUid:"",imageX:-1,imageY:-1,canvasX:Math.floor(s),canvasY:Math.floor(n),nativeEvent:t}}handleExternalEvents(){this.viewer.hooks.cameraPlayed.on((t=>{const e={deviceId:this.camera.getCamera().deviceId,resolution:[t.resolution.width,t.resolution.height]};this.viewer.emit("played",e);}),this),this.viewer.hooks.cameraClosed.on((()=>{this.viewer.emit("stopped",{deviceId:this.lastDeviceId});}),this),this.viewer.hooks.cameraCaptured.on((t=>{this.viewer.emit("captured",{pageUid:t.pageUid});}),this),this.viewer.hooks.cameraChanged.on((t=>{this.viewer.emit("cameraChanged",{oldDeviceId:t.oldDeviceId,newDeviceId:t.newDeviceId});}),this);}bindNativeEvents(){const t=this.canvasEl;if(!t)return;const e=t=>{this.viewer.emitter.hasCallback("click")&&this.viewer.emit("click",this.getPointerEvent(t));},i=t=>{this.viewer.emitter.hasCallback("dblclick")&&this.viewer.emit("dblclick",this.getPointerEvent(t));},s=t=>{t.preventDefault(),this.viewer.emitter.hasCallback("rightclick")&&this.viewer.emit("rightclick",this.getPointerEvent(t));},n=()=>{setTimeout((()=>{this.resize();}),500);},o=()=>{this.isVideoPlaying&&(this.loop.closeLoop(),"visible"===document.visibilityState&&this.loop.startLoop());};t.addEventListener("click",e),t.addEventListener("dblclick",i),t.addEventListener("contextmenu",s),document.addEventListener("visibilitychange",o),window.addEventListener("orientationchange",n),this.viewer.hooks.destroy.on((()=>{t.removeEventListener("click",e),t.removeEventListener("dblclick",i),t.removeEventListener("contextmenu",s),document.removeEventListener("visibilitychange",o),window.removeEventListener("orientationchange",n);}));}get isCaptureViewer(){return this.viewer.context.viewerConfig.viewerMode===lg.CAPTURE}get isVideoPlaying(){return !!this.camera&&this.camera.isVideoPlaying}async getFrontCamera(){if(!this.isHttps)return ku.reject(ku.CAMERA_NEED_HTTPS);const t=await fT.testCameraAccess({video:{facingMode:{exact:"user"}}});return Promise.resolve(t.ok)}convertCamera(){if(!this.canFrontCamera)return Promise.reject();if("opening"===this.camera.state)return Promise.resolve();if(!this.bUser){const t=this.getCamera().deviceId;return this.camera.switchToFrontCamera().then((()=>(this.bUser=!0,this.lastEnvironmentCameraId=t,this.torchSupported&&this.emitTorchChanged("unsupported"),Promise.resolve())))}return this.setCamera(this.lastEnvironmentCameraId).then((()=>(this.bUser=!1,this.torchSupported&&this.emitTorchChanged("supported"),Promise.resolve())))}getFrameData(){if(!this.config.fullscreen)return this.camera.getFrameData();const{width:t,height:e}=this.videoEl.getBoundingClientRect(),i=this.videoEl.videoWidth,s=this.videoEl.videoHeight,n=Math.max(t/i,e/s),o=t/(i*n),r=e/(s*n),a=Math.floor((1-o)/2*i),l=Math.floor((1-r)/2*s),h=Math.floor(i*o),c=Math.floor(s*r);return this.camera.getFrameData({position:{sx:a,sy:l,sWidth:h,sHeight:c,dWidth:h,dHeight:c}})}updateCameraConfig(t){for(const[e,i]of Object.entries(t)){const t=this.configHandler[e];t&&!_s(i)&&t(this,i);}}bindCameraVideo(t){t instanceof HTMLVideoElement&&(this.camera.setVideoEl(t),this.videoEl=t);}bindCameraCanvas(t){t instanceof HTMLCanvasElement&&(this.canvasEl=t);}async capture(){this.loop.startCaptureAnimation(),await CT(),this.loop.closeCaptureAnimation(),ku.verbose(`[${Date.now()}][cv] start capture`);const t=this.getFrameData();if(ku.verbose(`[${Date.now()}][cv] get frame done`),!t)return null;const e={type:1,data:t.data.buffer,width:t.width,height:t.height},i=await this.loop.getDetectResult(e);ku.verbose(`[${Date.now()}][cv] get detect result done`),0===t.data.length&&(t.data=new Uint8Array(e.data));const s=await this.viewer.context.core.processService.resize(t.data.buffer,1,t.width,t.height,-1);return ku.verbose(`[${Date.now()}][cv] create image done`),this.isCapturedPages=!0,await this.viewer.context.loadSource({fileData:s.data,extraPageData:[{index:0,perspectiveQuad:i.success?i.location:void 0}]}),ku.verbose(`[${Date.now()}][cv] capture done`),s.data}async play(t){if(!this.isHttps)return Promise.reject(ku.CAMERA_NEED_HTTPS);if(!t&&this.isVideoPlaying)return Promise.resolve();const{fill:e,resolution:i}=t||{},s=this.camera.getResolution();if(Vs(e)&&this.updateCameraConfig({fullscreen:e}),this.isVideoPlaying&&kT(i)&&i[0]===s.width&&i[1]===s.height)return Promise.resolve();if(s.width,s.height,kT(i)){if(this.isVideoPlaying)return this.camera.setResolution(i[0],i[1]).then((t=>(this.resize(),Promise.resolve()))).catch();this.camera.setResolution(i[0],i[1]);}return !this.isFirstPlayed||this.isVideoPlaying||i||"opening"===this.camera.state||this.camera.setResolution(1280,720),this.initializing&&await new Promise((t=>{const e=setInterval((()=>{this.initializing||(clearInterval(e),t(""));}),100);})),this.isFirstPlayed&&(this.isFirstPlayed=!1),this.camera.open().then((async()=>(this.resize(),Promise.resolve()))).catch((t=>{let e=ku.CAMERA_OCCUPIED;return "Permission denied"===t.message&&(e=ku.CAMERA_DENIED),8===t.code&&(e=ku.CAMERA_NO_CAMERA),Promise.reject(e)}))}stop(){var t;this.loop.closeLoop(),this.lastDeviceId=this.getCamera().deviceId,null===(t=this.camera)||void 0===t||t.close();}async setCamera(t){let e="";Os(t)?e=t.deviceId||"":Xs(t)&&(e=t);let i=!1;const s=this.cameraList.length?this.cameraList:await this.getCameras();for(let t=0;t<s.length;t++)s[t].deviceId===e&&(i=!0);if(!i)return Promise.reject(ku.CAMERA_NOT_EXIST);await this.camera.setCamera(e).catch((t=>{let e=ku.CAMERA_OCCUPIED;"Permission denied"===t.message&&(e=ku.CAMERA_DENIED),8===t.code&&(e=ku.CAMERA_NO_CAMERA),Promise.reject(e);}));const n=this.camera.getResolution(),o={deviceId:e,width:n.width,height:n.height};return Promise.resolve(o)}getCamera(){const t=this.camera.getCamera();return {deviceId:t.deviceId,label:t.label}}async getCameras(){const t=(await this.camera.getAllCameras()).map((t=>({deviceId:t.deviceId,label:t.label})));return Promise.resolve(t)}async setResolution(t,e){const i=this.camera.getCamera();if(!i||""===i.deviceId)return Promise.reject(ku.CAMERA_NOT_EXIST);let s;if(js(t))s=t;else if(Ls(t)){const[i,n]=t;s=i,e=n;}let n=this.camera.getResolution();return js(s)&&js(e)&&(this.loop.closeLoop(),n=await this.camera.setResolution(s,e).catch((t=>{}))),Promise.resolve({deviceId:i.deviceId,...n})}getResolution(){const t=this.camera.getCamera();if(!t||""===t.deviceId)return [0,0];const e=this.camera.getResolution();return [e.width,e.height]}async getResolutions(){const t=(await this.camera.getResolutions()).map((t=>[t.width,t.height]));return Promise.resolve(t)}turnOnTorch(){const t=this.camera.getCamera();return t&&""!==t.deviceId?this.isTurningTorch?Promise.resolve():(this.isTurningTorch=!0,this.camera.turnOnTorch().then((()=>(this.isTurningTorch=!1,this.turnOnTheTorch=!0,this.config.enableTorch=!0,this.emitTorchChanged("on"),Promise.resolve()))).catch((t=>(this.isTurningTorch=!1,this.turnOnTheTorch=!1,this.config.enableTorch=!1,this.emitTorchChanged("off"),ku.reject(ku.CAMERA_NOT_SUPPORT_TORCH))))):Promise.reject(ku.CAMERA_NO_VIDEO)}turnOffTorch(){const t=this.camera.getCamera();return t&&""!==t.deviceId?this.camera.turnOffTorch().then((()=>(this.turnOnTheTorch=!1,this.config.enableTorch=!1,this.emitTorchChanged("off"),Promise.resolve()))).catch((t=>ku.reject(ku.CAMERA_NOT_SUPPORT_TORCH))):Promise.reject(ku.CAMERA_NO_VIDEO)}resize(){const{canvasEl:t}=this,{width:e,height:i}=t.getBoundingClientRect();t.width=Math.floor(e),t.height=Math.floor(i),this.loop.updateVideoLayout();}dispose(){var t,e;this.stop(),null===(t=this.loop)||void 0===t||t.closeLoop(),null===(e=this.camera)||void 0===e||e.dispose(),this.camera=null,this.loop=null,this.videoEl=null,this.canvasEl=null;}}function kT(t){return !!(Ls(t)&&js(t[0])&&js(t[1]))}const DT={install(t){const e=t.getClass("Viewer"),s=(n=e,class extends n{constructor(t){if(super(t),i(this,"cameraContext",void 0),this.context.viewerConfig.viewerMode===lg.CAPTURE){this.cameraContext=new AT(this);const e=TT;Os(t.viewerConfig)&&["enableTorch","enableAutoCapture","enableAutoDetect","acceptedPolygonConfidence","maxFrameNumber","autoCaptureDelay"].forEach((i=>{i in t.viewerConfig&&(e[i]=t.viewerConfig[i]);})),this.cameraContext.config={...e,defaultCameraConfig:TT},this.on("resized",(()=>{this.cameraContext.resize();}));}}isVideoPlaying(){return this.cameraContext.isVideoPlaying}convertCamera(){return this.cameraContext.convertCamera()}getCameraConfig(){return Ns(this.cameraContext.config)}updateCameraConfig(t){Os(t)&&this.cameraContext.updateCameraConfig(t);}capture(){return this.cameraContext.capture()}play(t){return this.cameraContext.play(t)}stop(){this.isVideoPlaying()?this.cameraContext.stop():ku.warning(ku.CAMERA_NO_VIDEO);}getCurrentCamera(){return this.cameraContext.getCamera()}getAllCameras(){return this.cameraContext.getCameras()}selectCamera(t){return this.cameraContext.setCamera(t)}getCurrentResolution(){return this.cameraContext.getResolution()}getResolutions(){return this.cameraContext.getResolutions()}setResolution(t,e){return this.cameraContext.setResolution(t,e)}turnOnTorch(){return this.cameraContext.turnOnTorch()}turnOffTorch(){return this.cameraContext.turnOffTorch()}dispose(){var t;this.cameraContext&&(null===(t=this.cameraContext)||void 0===t||t.dispose()),this.cameraContext=null,super.dispose();}});var n;t.setClass("Viewer",s);}};class RT{constructor(t){i(this,"uid",void 0),i(this,"areaUid",void 0),i(this,"isRect",!0),i(this,"vertexes",[]),i(this,"midpoints",[]),i(this,"points",[]),i(this,"keepAspectRatio",!1),i(this,"isConvex",!0),i(this,"renderer",void 0),i(this,"area",void 0),i(this,"slopeRatio",[]),i(this,"selectedPart",-1),i(this,"startX",null),i(this,"startY",null),i(this,"lastX",null),i(this,"lastY",null),i(this,"lastAspectRatio",1),i(this,"b1",void 0),i(this,"b2",void 0),i(this,"k1",void 0),i(this,"k2",void 0),this.uid=qs(),Object.assign(this,t),this.initBox(t.vertexes);}initBox(t){this.vertexes=t,this.midpoints=ET(this.vertexes),this.points=this.vertexes.slice().concat(this.midpoints.slice()),this.slopeRatio=$n(this.vertexes);}getRect(){if(!this.isRect)return null;const{minX:t,maxX:e,minY:i,maxY:s}=this.getBounds();return {left:t,top:i,width:e-t||1,height:s-i||1}}getQuad(){if(this.isRect)return null;const{points:t}=this,e=[];for(let i=0;i<4;i++)e.push([t[2*i],t[2*i+1]]);return e}getActivePartNum(t,e,i){const s=this.getSelectedCtrlPointNum(t,e,i);if(s>-1)return s;return this.isPointOnBox(t,e)?8:-1}getSelectedCtrlPointNum(t,e,i){const{points:s}=this,{width:n,height:o,zoom:r}=this.area,{ctrlWidth:a,ctrlHeight:l,ctrlRadiusMultipleMobile:h}=this.renderer.config.boxStyle;let c=l/2/r,d=a/2/r;i&&(d*=h,c*=h);const u=Gs(d,0,3*d),p=Gs(c,0,3*c);for(let i=0;i<8;i++){const r=s[2*i],a=s[2*i+1];if(t<=r+u&&t>=r-u&&e<=a+p&&e>=a-p&&t>=0-u&&t<=n+u&&e>=0-p&&e<=o+p&&(i<4&&this.renderer.config.enableEditCropBoxVertices||this.renderer.config.enableEditCropBoxMidpoints))return i}return -1}checkOrientation(t){if(t<0||t>7)return null;const{minX:e,maxX:i,minY:s,maxY:n}=this.getBounds(),{points:o}=this,r=o[2*t],a=o[2*t+1];let l="",h="";return r===i?l="e":r===e&&(l="w"),a===n?h="s":a===s&&(h="n"),t<4?h+l:h||l}onStartHandler(t,e,i,s){var n;if(null!==(n=i)&&void 0!==n||(i=this.getActivePartNum(t,e,s)),!(i<0)&&(this.startX=t,this.startY=e,this.lastX=t,this.lastY=e,this.selectedPart=i,!this.isRect&&i>3&&i<8)){const{points:t,slopeRatio:e}=this,s=i-4;this.k1=e[(s+1)%4],this.b1=t[(2*s+3)%8]-this.k1*t[(2*s+2)%8],this.k2=e[(s+3)%4],this.b2=t[(2*s+1)%8]-this.k2*t[(2*s+0)%8];}}onMoveHandler(t,e,i){const{selectedPart:s}=this;if(s<0)return;const n=t-this.lastX,o=e-this.lastY;if(0===n&&0===o)return;const{points:r}=this;let a=r.slice();var l;s<8?(null!==(l=i)&&void 0!==l||(i=s),this.isRect?a=this.moveRectPoint(a,i,t,e):(a=this.moveQuadPoint(a,i,t,e),this.slopeRatio=$n(r).slice(0,4),this.isConvex=Xn(a))):8===s&&(a=this.moveBox(a,n,o));const h=ET(a);this.points=a.slice(0,8).concat(h),this.midpoints=h,this.lastX=t,this.lastY=e;}onEndHandler(){const{startX:t,startY:e,vertexes:i,midpoints:s,lastX:n,lastY:o,selectedPart:r}=this;if(r<0)return;this.startX=0,this.startY=0,this.selectedPart=-1;let a=this.points.slice();const l=Xn(a);(t===n&&e===o||!l)&&(a=i.slice().concat(s)),this.isConvex=!0,this.vertexes=a.slice(0,8),this.midpoints=ET(a),this.points=a.slice(0,8).concat(this.midpoints),this.slopeRatio=$n(a).slice(0,4);}getBounds(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.points;return {minX:Math.min(t[0],t[2],t[4],t[6]),maxX:Math.max(t[0],t[2],t[4],t[6]),minY:Math.min(t[1],t[3],t[5],t[7]),maxY:Math.max(t[1],t[3],t[5],t[7])}}moveRectPoint(t,e,i,s){let n=0,o=0;const{enableEditCropBoxMidpoints:r,enableEditCropBoxVertices:a}=this.renderer.config;if(this.keepAspectRatio){const{minX:l,maxX:h,minY:c,maxY:d}=this.getBounds(),u=this.checkOrientation(e);let p=(h-l)/(d-c);0===p||p===1/0||p===-1/0||Number.isNaN(p)?p=this.lastAspectRatio:this.lastAspectRatio=p,n=0,o=0;let g="w",f=!1;if(e<4){if(a){if(f=!0,n=i-t[2*e],o=s-t[2*e+1],0===n||0===o)return t;g="w";}}else {const a=e-4;if(r){f=!0;const r={e:[(a+1)%4,"w"],s:[a,"h"],w:[a,"w"],n:[(a+1)%4,"h"]};if(["e","s","w","n"].includes(u)&&([e,g]=r[u]),n=i-t[2*a],o=s-t[2*a+1],0===n||0===o)return t}}if(f){const i=["ne","sw","n","w"];"h"===g?(n=o*p,i.includes(u)&&(n=-n)):(o=n/p,i.includes(u)&&(o=-o));const s=t[2*e]+n,r=t[2*e+1]+o,{width:a,height:l}=this.area;s<0?(n=0-t[2*e],o=0):s>a?(n=a-t[2*e],o=0):r<0?(o=0-t[2*e+1],n=0):r>l&&(o=l-t[2*e+1],n=0),t[2*e]+=n,t[2*e+1]+=o;const h=(e+1)%4,c=(e+3)%4;e%2?(t[2*h]+=n,t[2*c+1]+=o):(t[2*h+1]+=o,t[2*c]+=n);}}else if(e<4){if(a){if(n=i-t[2*e],o=s-t[2*e+1],0===n&&0===o)return t;t[2*e]=i,t[2*e+1]=s;const r=(e+1)%4,a=(e+3)%4;e%2?(t[2*r]=i,t[2*a+1]=s):(t[2*r+1]=s,t[2*a]=i);}}else {const n=e-4;if(r){const e=this.slopeRatio[n%4];0===e?(t[(2*n+3)%8]=s,t[(2*n+1)%8]=s):e!==1/0&&e!==-1/0||(t[(2*n+2)%8]=i,t[(2*n+0)%8]=i);}}return t}moveQuadPoint(t,e,i,s){const n=t.slice();if(e<4){const n=i-t[2*e],o=s-t[2*e+1];if(0===n&&0===o)return t;t[2*e]=i,t[2*e+1]=s;}else {const o=e-4,r=this.slopeRatio[o%4],a=s-r*i,l=-a/r,h=a,c=t[(2*o+9)%8]-r*t[(2*o+8)%8],d=-c/r,{k1:u,b1:p,k2:g,b2:f}=this;0===r?(t[(2*o+3)%8]=s,u!==1/0&&u!==-1/0&&(t[(2*o+2)%8]=(s-p)/u),t[(2*o+1)%8]=s,g!==1/0&&g!==-1/0&&(t[(2*o+0)%8]=(s-f)/g)):r===1/0||r===-1/0?(t[(2*o+2)%8]=i,t[(2*o+3)%8]=u*i+p,t[(2*o+0)%8]=i,t[(2*o+1)%8]=g*i+f):(0===u?t[(2*o+2)%8]+=l-d:u===1/0||u===-1/0?t[(2*o+3)%8]+=h-c:(t[(2*o+2)%8]=(p-a)/(r-u),t[(2*o+3)%8]=(r*p-u*a)/(r-u)),0===g?t[(2*o+0)%8]+=l-d:g===1/0||g===-1/0?t[(2*o+1)%8]+=h-c:(t[(2*o+0)%8]=(f-a)/(r-g),t[(2*o+1)%8]=(r*f-g*a)/(r-g)));for(let e=0;e<4;e++){const i=t[2*e],s=t[2*e+1];if(i<0||i>this.area.width||s<0||s>this.area.height)return n}}return t}moveBox(t,e,i){const{minX:s,maxX:n,minY:o,maxY:r}=this.getBounds(t);e=Gs(e,-s,this.area.width-n),i=Gs(i,-o,this.area.height-r);for(let s=0;s<4;s++)t[2*s]+=e,t[2*s+1]+=i;return t}isPointOnBox(t,e){if(this.isRect){const{minX:i,maxX:s,minY:n,maxY:o}=this.getBounds();return t>=i&&t<=s&&e>=n&&e<=o}const i=[...this.vertexes],s=[...this.midpoints],n=[];for(let t=0;t<4;t++)n.push([i[2*t],i[2*t+1]]),n.push([s[2*t],s[2*t+1]]);return function(t,e){let i,s,n,o,r=0;const a=e.length;for([n]=e,i=1;i<=a;i++)o=e[i%a],t[0]>Math.min(n[0],o[0])&&t[0]<=Math.max(n[0],o[0])&&t[1]<=Math.max(n[1],o[1])&&n[0]!==o[0]&&(s=(t[0]-n[0])*(o[1]-n[1])/(o[0]-n[0])+n[1],(n[1]===o[1]||t[1]<=s)&&(r+=1)),n=o;if(r%2==0)return !1;return !0}([t,e],n)}}function ET(t){const e=t.slice(0,8).concat(t[0],t[1]),i=[];for(let t=0;t<4;t++){const s=(e[2*t]+e[2*(t+1)])/2,n=(e[2*t+1]+e[2*(t+1)+1])/2;i.push(s,n);}return i}class MT{constructor(t,e,s){i(this,"areaUid",void 0),i(this,"left",void 0),i(this,"top",void 0),i(this,"width",void 0),i(this,"height",void 0),i(this,"boxes",void 0),i(this,"isVisible",!0),i(this,"zoom",1),i(this,"oldRect",void 0),i(this,"oldQuad",void 0),i(this,"isModified",!1),i(this,"isDrawNewBox",!1),i(this,"activeBoxUid",void 0),i(this,"activePartNum",-1),i(this,"startX",void 0),i(this,"startY",void 0),i(this,"isMouseDown",!1),i(this,"isDrawing",!1),i(this,"renderer",void 0),this.renderer=t,this.areaUid=e,this.boxes=[],this.updateAreaRect(s);}hasActiveBox(){return !!this.activeBoxUid}getFullVertexes(){return [0,0,this.width,0,this.width,this.height,0,this.height]}isContainRect(t){return t.left>=0&&t.left<=this.width&&t.left+t.width<=this.width&&t.top>=0&&t.top<=this.height&&t.top+t.height<=this.height}isContainBox(t){const e=t.getRect();return this.isContainRect(e)}isFullBox(t){const{vertexes:e}=t;return 0===e[0]&&0===e[1]&&e[2].toFixed(2)===this.width.toFixed(2)&&0===e[3]&&e[4].toFixed(2)===this.width.toFixed(2)&&e[5].toFixed(2)===this.height.toFixed(2)&&0===e[6]&&e[7].toFixed(2)===this.height.toFixed(2)}addRectBox(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t=this.handleBoundary(t),this.addBox(t,!0,e,i)}updateRectBox(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=t.getRect(),n=t.getQuad();if(e=this.handleBoundary(e),t.initBox(e),i){const e={box:t};t.isRect?(e.oldRect=s,e.newRect=t.getRect()):(e.oldQuad=n,e.newQuad=t.getQuad()),this.renderer.hooks.boxModified.emit(e);}}handleBoundary(t){t=[...t];for(let e=0;e<4;e++){const i=[t[2*e],t[2*e+1]];i[0]=Gs(i[0],0,this.width),i[1]=Gs(i[1],0,this.height),[t[2*e],t[2*e+1]]=i;}return t}addQuadBox(t){return this.addBox(t,!1)}addBox(t){let e=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const s=new RT({isRect:!(arguments.length>1&&void 0!==arguments[1])||arguments[1],area:this,renderer:this.renderer,vertexes:[...t],keepAspectRatio:this.renderer.config.keepAspectRatio});return this.boxes.push(s),e&&this.renderer.hooks.boxCreated.emit({box:s,fromEvent:i}),s}getBoxRects(){return this.boxes.map(((t,e)=>({index:e,...t.getRect()})))}getBoxByUid(t){return this.boxes.find((e=>e.uid===t))}deleteBoxByUid(t){const e=this.boxes.findIndex((e=>e.uid===t));e>-1&&this.boxes.splice(e,1);}clearBoxes(){this.boxes.length=0;}updateAreaRect(t){this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height;}setKeepAspectRatio(t){this.isDrawing||this.boxes.forEach((e=>{e.keepAspectRatio=t;}));}isTouchedPoint(t,e,i){return t=Gs(t,0,this.width),e=Gs(e,0,this.height),this.boxes.some((s=>{const n=s.getActivePartNum(t,e,i);return n>-1&&n<8}))}isTouchedBox(t,e,i){return t=Gs(t,0,this.width),e=Gs(e,0,this.height),this.boxes.some((s=>s.getActivePartNum(t,e,i)>-1))}onStartHandler(t,e,i){this.isMouseDown=!0,t=Gs(t,0,this.width),e=Gs(e,0,this.height),this.startX=t,this.startY=e;const s=this.boxes.find((s=>{const n=s.getActivePartNum(t,e,i);return n>-1&&(this.activePartNum=n),n>-1}));s&&(this.oldRect=s.getRect(),this.oldQuad=s.getQuad(),this.activeBoxUid=s.uid,s.keepAspectRatio=this.renderer.config.keepAspectRatio,s.onStartHandler(t,e,void 0,i));}onMoveHandler(t,e,i,s){if(!this.isMouseDown)return;let n;if(t=Gs(t,0,this.width),e=Gs(e,0,this.height),this.activeBoxUid){if(n=this.getBoxByUid(this.activeBoxUid),!n)return;const{keepAspectRatioWithShift:s,keepAspectRatio:o,enableMoveQuad:r}=this.renderer.config;if(n.isRect)n.keepAspectRatio=!(!i||!s)||o;else if(!r&&8===this.activePartNum)return;return n.onMoveHandler(t,e),void(this.isModified=!0)}const{enableCreateBoxByPointer:o,enableMultiple:r}=this.renderer.config;if((r||!this.boxes.length)&&o){const{startX:i,startY:o}=this;let r=e-o;const a=t-i;let l=-1;const h=2/this.zoom;if(a<-h&&r<-h?l=0:a>h&&r<-h?l=1:a>h&&r>h?l=2:a<-h&&r>h&&(l=3),l>-1){const{aspectRatio:h}=this.renderer.config;h>0&&(r=a/h,l%2&&(r=-a/h));const c=[],d=l%2?[i,o,i,o+r,t,o+r,t,o]:[t,o+r,i,o+r,i,o,t,o];for(let t=0;t<4;t++)c.push(d[2*(l+t)%8]),c.push(d[(2*(l+t)+1)%8]);n=this.addRectBox(c,!1),this.isDrawNewBox=!0,n.keepAspectRatio=h>0,this.isDrawing=!0,this.activeBoxUid=n.uid,n.onStartHandler(this.startX,this.startY,l,s),n.onMoveHandler(t,e,l);}}}onEndHandler(){if(!this.isMouseDown||!this.activeBoxUid)return;this.isMouseDown=!1;const t=this.getBoxByUid(this.activeBoxUid);if(t){if(t.keepAspectRatio=this.renderer.config.keepAspectRatio,t.onEndHandler(),this.isDrawNewBox)this.isDrawNewBox=!1,this.renderer.hooks.boxCreated.emit({box:t,fromEvent:!1});else if(this.isModified){const e={box:t};t.isRect?(e.oldRect=this.oldRect,e.newRect=t.getRect()):(e.oldQuad=this.oldQuad,e.newQuad=t.getQuad()),this.renderer.hooks.boxModified.emit(e);}this.oldRect=null,this.oldQuad=null,this.isModified=!1,this.isDrawing=!1,this.activeBoxUid=null,this.activePartNum=-1;}}isPointHover(t){let[e,i]=t;return e>=0&&e<=this.width&&i>=0&&i<=this.height}getCursorInfo(t,e,i){for(let s=this.boxes.length-1;s>=0;s--){const n=this.boxes[s],o=n.getActivePartNum(t,e,i);if(o>-1){let t="move";return o<8&&(t=n.checkOrientation(o)),{part:o,position:t,isRect:n.isRect}}}return null}}const IT={aspectRatio:0,keepAspectRatio:!1,keepAspectRatioWithShift:!0,enableMultiple:!1,enableCreateBoxByPointer:!0,enableCursor:!0,enableMask:!0,enableMagnifier:!0,moveThreshold:2,enableMoveQuad:!1,boxStyle:{borderColor:"orange",borderWidth:2,borderStyle:[5,2],background:"rgba(255,255,255,0)",ctrlBorderWidth:2,ctrlBorderRadius:4,ctrlBorderColor:"orange",ctrlWidth:16,ctrlHeight:16,ctrlBackground:"rgba(255,0,0,0)",invalidCtrlBorderColor:"red",invalidBorderColor:"red",ctrlRadiusMultipleMobile:2},enableEditCropBoxVertices:!0,enableEditCropBoxMidpoints:!0,enableHideEditingCropBoxVertex:!0,enableHideEditingCropBoxMidpoint:!0};class BT{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,"areas",void 0),i(this,"scrollTop",0),i(this,"scrollLeft",0),i(this,"zoom",1),i(this,"config",void 0),i(this,"canvasDom",void 0),i(this,"isMousedown",!1),i(this,"isEditing",!1),i(this,"editingCursor",18),i(this,"hoveredArea",void 0),i(this,"hooks",{boxCreated:en(),boxModified:en(),boxDeleted:en()}),this.areas=new Map,this.zoom=1,this.config=Ns(IT),Nn(t,this.config),this.setCanvasDom(t.canvas);}setCanvasDom(t){t&&(this.canvasDom=t);}updateConfig(t){Nn(t,this.config);}addArea(t,e){if(this.areas.has(t)){const i=this.areas.get(t);return i.updateAreaRect(e),i}const i=new MT(this,t,e);return this.areas.set(t,i),i}deleteArea(t){if(this.areas.has(t)){this.areas.get(t).boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);})),this.areas.delete(t);}}clearArea(){this.areas.forEach((t=>{t.boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);}));})),this.areas.clear();}clearAreaBoxes(t){if(this.areas.has(t)){const e=this.areas.get(t);e.boxes.forEach((t=>{this.hooks.boxDeleted.emit(t);})),e.clearBoxes();}}addRectBox(t,e){return this.areas.get(e).addRectBox(t)}addQuadBox(t,e){return this.areas.get(e).addQuadBox(t)}updateOptions(t){Object.assign(this,t),js(t.zoom)&&this.areas.forEach((e=>{e.zoom=t.zoom;}));}getAreaByUid(t){return this.areas.get(t)}deleteAreaByUid(t){this.areas.delete(t);}getHoveredArea(t){const e=this.nativeToCanvas(t);for(const t of this.areas.values()){const i=this.canvasToArea(e,t);if(t.isPointHover(i)&&t.isVisible)return t}return null}getHoveredAreaForCursor(t){const e=bn(t),i=this.nativeToCanvas(t);for(const t of this.areas.values()){const s=this.canvasToArea(i,t),[n,o]=s,r=t.isVisible&&t.boxes.find((t=>t.getActivePartNum(n,o,e)>-1));if(t.isPointHover(s)||r)return t}return null}isControlPointTouched(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return !1;const i=this.nativeToCanvas(t),[s,n]=this.canvasToArea(i,e),o=bn(t);return e.isTouchedPoint(s,n,o)}isBoxTouched(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return !1;const i=this.nativeToCanvas(t),[s,n]=this.canvasToArea(i,e),o=bn(t);return e.isTouchedBox(s,n,o)}onStartHandler(t){const e=this.getHoveredArea(t);if(!e||!e.isVisible)return;this.hoveredArea=e,this.isMousedown=!0;const i=this.nativeToCanvas(t),[s,n]=this.canvasToArea(i,e),o=bn(t);e.onStartHandler(s,n,o);}onMoveHandler(t){if(!this.canvasDom)return null;let e=null;const i=this.getHoveredArea(t),s=bn(t),n=this.nativeToCanvas(t);if(this.isMousedown){const[e,i]=this.canvasToArea(n,this.hoveredArea);this.hoveredArea.onMoveHandler(e,i,An(t),s);}if(this.config.enableCursor&&i&&"mouse"===t.pointerType)if(this.hasBox()){const[t,o]=this.canvasToArea(n,i),r=i.getCursorInfo(t,o,s);if(null===r)this.config.enableMultiple&&(e=18);else if(r.isRect){switch(r.position){case"n":case"s":e=20;break;case"w":case"e":e=21;break;case"nw":e=22;break;case"ne":e=23;break;case"sw":e=24;break;case"se":e=25;break;case"move":e=19;}}else r.part>-1&&r.part<8&&(e=18);}else e=18;return e}hasBox(){for(const t of this.areas.values())if(t.isVisible&&t.boxes.length)return !0;return !1}onEndHandler(t){this.isMousedown&&(this.isMousedown=!1,this.isEditing=!1,this.hoveredArea.onEndHandler(),this.hoveredArea=null);}render(){if(!this.canvasDom||!this.areas.size)return;const t=this.canvasDom.getContext("2d");t.setTransform(1,0,0,1,0,0),this.areas.forEach((e=>{e.isVisible&&e.boxes.length&&this.renderArea(t,e);}));}renderArea(t,e){const{borderStyle:i,borderColor:s,borderWidth:n,ctrlBorderColor:o,ctrlBackground:r,ctrlBorderWidth:a,ctrlBorderStyle:l,background:h,maskColor:c,invalidBorderColor:d,invalidCtrlBorderColor:u,ctrlBorderRadius:p,ctrlWidth:g,ctrlHeight:f}=this.config.boxStyle,v=devicePixelRatio,m=g*v,y=f*v,x=Math.min(p*v,m/2,y/2),w=[i[0]*v,i[1]*v],b=n*v,S=a*v,C=[l[0]*v,l[1]*v];t.save(),t.beginPath(),t.rect(e.left*v,e.top*v,e.width*e.zoom*v,e.height*e.zoom*v),t.closePath(),t.clip(),this.config.enableMask&&c&&(t.save(),t.beginPath(),t.rect(e.left*v,e.top*v,e.width*e.zoom*v,e.height*e.zoom*v),e.boxes.forEach((i=>{let s=this.areaPointsToCanvas(i.points.slice(0,8),e),n=this.areaPointsToCanvas(i.midpoints.slice(0,8),e);1!==v&&(s=s.map((t=>t*v)),n=n.map((t=>t*v))),t.moveTo(s[0],s[1]);for(let e=1;e<4;e++)t.lineTo(s[2*e],s[2*e+1]);})),t.closePath(),t.clip("evenodd"),t.fillStyle=c,t.fill(),t.restore()),e.boxes.forEach((i=>{let n=this.areaPointsToCanvas(i.points.slice(0,8),e),a=this.areaPointsToCanvas(i.midpoints.slice(0,8),e);1!==v&&(n=n.map((t=>t*v)),a=a.map((t=>t*v))),t.save(),t.setLineDash(w),t.strokeStyle=i.isConvex?s:d,t.fillStyle=""===h?"transparent":h,t.lineWidth=b,t.beginPath(),t.moveTo(n[0],n[1]);for(let e=1;e<4;e++)t.lineTo(n[2*e],n[2*e+1]);t.closePath(),t.fill(),t.stroke(),t.setLineDash(C),t.strokeStyle=i.isConvex?o:u,t.fillStyle=""===r?"transparent":r,t.lineWidth=S,this.config.enableEditCropBoxVertices&&this.drawCtrlPoints(t,n,m,y,x,this.config.enableHideEditingCropBoxVertex?i.selectedPart:-1),this.config.enableEditCropBoxMidpoints&&this.drawCtrlPoints(t,a,m,y,x,this.config.enableHideEditingCropBoxMidpoint?i.selectedPart-4:-1),t.restore();})),t.restore();}drawCtrlPoints(t,e,i,s,n,o){const r=i/2,a=s/2;for(let l=0;l<4;l++){if(l===o)continue;t.beginPath();const h=e[2*l],c=e[2*l+1];if(0===n)t.rect(h-r,c-a,i,s);else {const{PI:e}=Math;t.arc(h-r+n,c-a+n,n,e,3*e/2),t.arc(h+r-n,c-a+n,n,3*e/2,2*e),t.arc(h+r-n,c+a-n,n,0,e/2),t.arc(h-r+n,c+a-n,n,e/2,e);}t.closePath(),t.fill(),t.stroke();}}areaPointsToCanvas(t,e){const i=[];for(let s=0;s<4;s++){const[n,o]=this.areaToCanvas([t[2*s],t[2*s+1]],e);i.push(n,o);}return i}canvasToArea(t,e){let[i,s]=t;const{scrollLeft:n,scrollTop:o,zoom:r}=this;return i=(i-e.left+n)/r,s=(s-e.top+o)/r,[i,s]}areaToCanvas(t,e){let[i,s]=t;const{scrollLeft:n,scrollTop:o,zoom:r}=this;return i=i*r+e.left-n,s=s*r+e.top-o,[i,s]}nativeToCanvas(t){const e=function(t){return ["touchstart","touchend","touchmove"].includes(t.type)}(t)?t.targetTouches[0]:t,i=this.canvasDom.getBoundingClientRect(),{scrollX:s,scrollY:n}=window;return [e.pageX-s-i.left,e.pageY-n-i.top]}}class UT{constructor(t,e){i(this,"context",void 0),i(this,"core",void 0),i(this,"boxRenderer",void 0),i(this,"viewer",void 0),i(this,"isMousedown",!1),i(this,"canvas",void 0),i(this,"isRenderMagnifier",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),this.viewer=t,this.context=t.context,this.core=t.context.core,this.boxRenderer=e,this.canvas=this.context.rendererService.getCanvasDom();}afterRenderForMagnifier(){this.needRenderMagnifier&&(this.magnifierPoint,this.context.magnifierService.render("crop",this.canvas,this.magnifierPoint));}isEditCropBox(t){const e=this.boxRenderer.getHoveredArea(t);return !(!e||!e.isVisible||e.boxes.length&&!this.boxRenderer.isBoxTouched(t))}isNotOverCropBox(t){return this.boxRenderer.hasBox()&&!this.boxRenderer.isBoxTouched(t)}mousedown(t){const{context:e}=this,i=this.context.getActiveTab();if(null==i||!i.total)return;if("crop"!==this.context.viewerConfig.toolMode)return;const[s]=this.context.toCanvas(t),{page:n}=this.context.getPointerOverPageInfo(s.pageX,s.pageY).pageInfo;if(i&&n&&n.uid!==i.currentUid){const t=i.getPageIndex(n);i.gotoPage(t),this.context.emitPageChangedEvent(i),this.context.core.viewerService.onCurrentChangedByScroll.emit(Zg.create(i.uid,e.groupUid,e.uid,t)),this.context.emitPageChangedAfterRenderEvent(i);}this.isMousedown=!0,this.boxRenderer.onStartHandler(t);const o=!this.boxRenderer.hasBox()||this.boxRenderer.isControlPointTouched(t);this.isRenderMagnifier=o,o&&e.viewerConfig.enableMagnifier&&!km(t)&&(this.needRenderMagnifier=!0,this.magnifierPoint={x:s.pageX,y:s.pageY},this.afterRenderForMagnifier());}mousemove(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;if("crop"!==this.context.viewerConfig.toolMode)return;window.TouchEvent&&t instanceof TouchEvent&&t.cancelable&&t.preventDefault();const i=this.boxRenderer.onMoveHandler(t);if(km(t)&&this.context.applyCursorState(i),this.isMousedown&&this.context.render(79),this.isRenderMagnifier&&this.context.viewerConfig.enableMagnifier&&!km(t)){this.needRenderMagnifier=!0;const[e]=this.context.toCanvas(t);this.magnifierPoint={x:e.pageX,y:e.pageY};}}mouseup(t){this.isMousedown&&(this.boxRenderer.onEndHandler(t),this.needRenderMagnifier&&this.context.magnifierService.hide(),this.isRenderMagnifier=!1,this.isMousedown=!1,this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render(80));}afterPerspective(t){let{pageUid:e,docUid:i,width:s,height:n}=t;const{context:o}=this,r=o.tabService.getTab(i);if(!r)return;const a=r.getPageByUid(e);if(a&&(a.rWidth=s,a.rHeight=n,o.clearOptimization([a.uid])),r.isActive){if("crop"===o.viewerConfig.toolMode){this.boxRenderer.areas.forEach((t=>{t.clearBoxes();}));const t=this.boxRenderer.getAreaByUid(e),i=r.getPageByUid(e).getRect();null==t||t.updateAreaRect(i);}a&&(a.isLoaded=!1),o.scrollByCurrentChanged=!0;let t=!0;this.context.isDefaultViewer?"none"===r.context.fitMode&&(t=!1):this.context.isThumbnailViewer&&(t=!1),this.context.showTab(r,{isClearOptimization:t,renderReason:0});}}afterRotatePages(t){const{context:e}=this;if("crop"!==e.viewerConfig.toolMode)return;const i=this.context.getActiveTab();null!=i&&i.total&&i.uid===t.docUid&&(this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),t.pageUids.forEach((t=>{const e=this.boxRenderer.getAreaByUid(t),s=i.getPageByUid(t).getRect();null==e||e.updateAreaRect(s);})),this.context.render(81));}afterRender(t){const{context:e}=this;"crop"===e.viewerConfig.toolMode&&(t.allPages.forEach((e=>{const i=this.boxRenderer.getAreaByUid(e.uid);if(i){if(e.isVisible){const t=e.getRect();i.updateAreaRect(t);}"current"===this.viewer.cropMode?i.isVisible=e.uid===t.currentUid:i.isVisible=e.isVisible;}})),this.boxRenderer.updateOptions({zoom:t.context.zoom}),this.boxRenderer.render());}toolModeChanged(t){if("crop"!==t.oldToolMode&&"crop"===t.newToolMode){const t=this.context.getActiveTab();if(!t)return;t.allPages.forEach((e=>{const i=e.getRect(),s=this.boxRenderer.addArea(e.uid,i);"current"===this.viewer.cropMode?s.isVisible=e.uid===t.currentUid:s.isVisible=e.isVisible;})),this.boxRenderer.updateOptions({zoom:t.context.zoom});}else "crop"!==t.newToolMode&&"crop"===t.oldToolMode&&(this.boxRenderer.clearArea(),this.context.render(82));}pageChanged(t){if("crop"!==this.context.viewerConfig.toolMode)return;return this.context.getActiveTab()?0===t.total?(this.clearRedundantBoxes(),this.boxRenderer.clearArea(),void this.context.render(83)):void("current"===this.viewer.cropMode&&this.resetPageCropArea()):void 0}deletePages(t){t.pageUids.forEach((t=>{this.boxRenderer.deleteArea(t);}));}updatePage(t){const{context:e}=this;if("crop"!==e.viewerConfig.toolMode)return;const i=e.getActiveTab();if(i&&i.uid===t.docUid)if("current"===this.viewer.cropMode&&t.pageUid===i.currentUid)this.resetPageCropArea();else if("all"===this.viewer.cropMode){const s=this.boxRenderer.getAreaByUid(t.pageUid),n=i.getPageByUid(t.pageUid).getRect();s.updateAreaRect(n),this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),e.render(84);}}addPages(t){const e=this.context.getActiveTab();null!=e&&e.total&&e.uid===t.docUid&&(t.pageUids.forEach((t=>{const i=e.getPageByUid(t),s=i.getRect();this.boxRenderer.addArea(i.uid,s),this.boxRenderer.updateOptions({zoom:e.context.zoom});})),this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})));}resetPageCropArea(){const t=this.context.getActiveTab();this.clearRedundantBoxes();const e=t.getCurrentPage(),i=e.getRect();this.boxRenderer.addArea(e.uid,i),this.boxRenderer.updateOptions({zoom:t.context.zoom}),this.context.render(85);}clearRedundantBoxes(){const t=this.context.getActiveTab();t&&"current"===this.viewer.cropMode&&this.boxRenderer.areas.forEach((e=>{e.areaUid!==t.currentUid&&this.boxRenderer.clearAreaBoxes(e.areaUid);}));}}class LT{constructor(t,e){i(this,"context",void 0),i(this,"core",void 0),i(this,"boxRenderer",void 0),i(this,"viewer",void 0),i(this,"isMousedown",!1),i(this,"canSlide",!1),i(this,"isStart",!1),i(this,"startX",void 0),i(this,"isSliding",void 0),i(this,"slideDistance",void 0),i(this,"slideDirection",void 0),i(this,"slideRAF",void 0),i(this,"tabX",void 0),i(this,"tabY",void 0),i(this,"canvas",void 0),i(this,"isRenderMagnifier",!1),i(this,"needRenderMagnifier",!1),i(this,"magnifierPoint",void 0),this.viewer=t,this.context=t.context,this.core=t.context.core,this.boxRenderer=e,this.canvas=this.context.rendererService.getCanvasDom();}afterRenderForMagnifier(){this.needRenderMagnifier&&this.context.magnifierService.render("crop",this.canvas,this.magnifierPoint);}isNotOverQuadCtrl(t){return this.boxRenderer.hasBox()&&!this.boxRenderer.isControlPointTouched(t)}mousedown(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;this.isMousedown=!0;if(!this.boxRenderer.isControlPointTouched(t)&&this.context.viewerConfig.enableSlide)this.canSlide=!0,this.slideStart(t);else {this.boxRenderer.onStartHandler(t);const e=this.boxRenderer.isControlPointTouched(t);if(this.isRenderMagnifier=e,e&&this.context.viewerConfig.enableMagnifier&&!km(t)){const[e]=this.context.toCanvas(t);this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY},this.afterRenderForMagnifier();}}}mousemove(t){const e=this.context.getActiveTab();if(null==e||!e.total)return;if(bn(t)&&t.cancelable&&t.preventDefault(),this.canSlide)this.slideMove(t);else {const e=this.boxRenderer.onMoveHandler(t);if(km(t)&&this.context.applyCursorState(e),this.isMousedown&&this.context.render(86),this.isRenderMagnifier&&this.context.viewerConfig.enableMagnifier&&!km(t)){const[e]=this.context.toCanvas(t);this.needRenderMagnifier=!0,this.magnifierPoint={x:e.pageX,y:e.pageY};}}}mouseup(t){this.isMousedown&&(this.canSlide?this.slideEnd(t):this.boxRenderer.onEndHandler(t),this.isRenderMagnifier=!1,this.canSlide=!1,this.isMousedown=!1,this.needRenderMagnifier&&this.context.magnifierService.hide(),this.needRenderMagnifier=!1,this.magnifierPoint=null,this.context.render(87));}reRender(){const{context:t}=this,e=t.getActiveTab();null!=e&&e.total&&"visible"===t.viewerConfig.visibility&&(this.updatePageQuad(e),t.render(88));}updatePage(t){const{context:e}=this,i=e.getActiveTab();null!=i&&i.total&&"visible"===e.viewerConfig.visibility&&i.currentUid===t.pageUid&&(this.updatePageQuad(i),e.render(89));}afterRender(t){if(null==t||!t.total)return;const{boxRenderer:e}=this;let i=!1;t.visibleChildren.forEach((t=>{const s=e.getAreaByUid(t.uid);if(s&&t.isVisible){i=!0;const e=t.getRect();s.updateAreaRect(e);}})),e.updateOptions({zoom:t.context.zoom}),i&&e.render();}pageChanged(t){if(-1===t.current&&0===t.total)return void this.boxRenderer.clearArea();const e=this.context.getActiveTab();e&&this.updatePageQuad(e);}updatePageQuad(t){const{context:e}=this,i=t.getCurrentPage();if(!i)return !1;let s=null;const n=this.boxRenderer.getAreaByUid(i.uid);n&&n.boxes[0]&&(s=n.boxes[0].getQuad());const o=e.core.pageService.getPage(t.currentUid);this.boxRenderer.clearArea();const r=i.getRect(),a=this.boxRenderer.addArea(i.uid,r);this.boxRenderer.updateOptions({zoom:t.context.zoom});const l=o.getQuadVertices(),h=a.addQuadBox(l);let c=h.getQuad();return s&&(s=o.quadToPixelPPI(s)),c&&(c=o.quadToPixelPPI(c)),dv(s),dv(c),e.hooks.perspectiveQuadChanged.emit(Qg.create(c,s,o.isFull)),h}afterRotatePages(t){const e=this.context.getActiveTab();null!=e&&e.total&&t.pageUids.includes(e.currentUid)&&(this.updatePageQuad(e),this.context.render(90));}afterPerspective(t){let{pageUid:e,docUid:i}=t;const{context:s}=this,n=this.context.getActiveTab();if(null==n||!n.total)return;if(n.uid!==i||n.currentUid!==e)return;const o=n.getCurrentPage();o&&(o.isLoaded=!1),this.updatePageQuad(n),s.scrollByCurrentChanged=!0,s.showTab(n,{isClearOptimization:!0,renderReason:1});}slideStart(t){if(!this.context.viewerConfig.enableSlide)return;if(this.isSliding)return;const e=this.context.getActiveTab();if(null==e||!e.total)return;const{scrollLeft:i,scrollTop:s}=this.context.viewService.getMaxScrollValue();if(i>0||s>0)return;const n=this.context.toCanvas(t);if(n.length>1)return;const o=e.getPosition();this.tabX=o.x,this.tabY=o.y,this.startX=n[0].pageX,this.isStart=!0;}slideMove(t){if(!this.isStart)return;const{context:e}=this,{viewerConfig:i}=e,s=e.getActiveTab(),n=e.toCanvas(t)[0].pageX-this.startX;if(n>0?this.slideDirection="right":n<0&&(this.slideDirection="left"),this.slideDistance=Math.min(s.context.viewportWidth,Math.abs(n)),this.isSliding)"right"===this.slideDirection?s.setPosition({x:this.slideDistance+this.tabX,y:this.tabY,z:0}):"left"===this.slideDirection&&s.setPosition({x:-this.slideDistance+this.tabX,y:this.tabY,z:0}),e.render(91);else if(s&&"single"===s.context.displayMode&&"crop"===i.toolMode&&i.enableSlide){const{scrollLeft:t,scrollTop:s}=this.context.viewService.getMaxScrollValue();Math.abs(n)>i.startSlideThresholdForPerspective&&t<=0&&s<=0&&(this.isSliding=!0,e.configService.updateConfig({displayMode:"slide"}));}}slideEnd(t){if(!this.isStart)return;const{context:e}=this,i=e.getActiveTab(),{displayMode:s}=i.context;"slide"===s&&this.slide(i),this.isStart=!1;}slide(t){let e,i=0,s=0,n=0,o=!1;const{viewerConfig:r}=this.context,a=t.context.viewportWidth*r.slideThresholdForPerspective;this.slideDistance>=Math.max(a,r.startSlideThresholdForPerspective)?(s=t.context.viewportWidth,e=s-this.slideDistance,"left"===this.slideDirection?t.current!==t.total-1?(n=-this.slideDistance,i=-e/6):(s=0,e=this.slideDistance,o=!0,n=-this.slideDistance,i=e/6):0!==t.current?(n=this.slideDistance,i=e/6):(s=0,e=this.slideDistance,o=!0,n=this.slideDistance,i=-e/6)):(o=!0,s=0,e=this.slideDistance,"left"===this.slideDirection?(n=-this.slideDistance,i=e/6):(n=this.slideDistance,i=-e/6));const l=()=>{n+=i;const e=n>=0;if(Math.abs(n)>=s&&(n=s,e||(n*=-1)),t.setPosition({x:n+this.tabX,y:this.tabY,z:0}),Math.abs(n)===s)return o||("right"===this.slideDirection?this.context.viewer.gotoPage(t.current-1):this.context.viewer.gotoPage(t.current+1),this.context.configService.updateConfig({fitMode:"window"})),this.isSliding=!1,this.context.configService.updateConfig({displayMode:"single"}),void cancelAnimationFrame(this.slideRAF);this.slideRAF=requestAnimationFrame(l),this.context.render(92);};this.slideRAF=requestAnimationFrame(l);}}class OT{constructor(t){i(this,"service",void 0),this.service=t;}startHandler(t){this.service.mousedown(t);}moveHandler(t){this.service.mousemove(t);}endHandler(t){this.service.mouseup(t);}isEditCropBox(t){return this.service.isEditCropBox(t)}isNotOverCropBox(t){return this.service.isNotOverCropBox(t)}}class NT{constructor(t){i(this,"service",void 0),this.service=t;}startHandler(t){this.service.mousedown(t);}moveHandler(t){this.service.mousemove(t);}endHandler(t){this.service.mouseup(t);}isNotOverQuadCtrl(t){return this.service.isNotOverQuadCtrl(t)}}function _T(t){return class extends t{constructor(t){super(t),i(this,"boxRenderer",void 0),i(this,"iCropMode","current"),i(this,"cropRectService",void 0),i(this,"perspectiveQuadService",void 0);const{isDefaultViewer:e,isPerspectiveViewer:s}=this.context;(e||s)&&(this.initBoxRenderer(),this.bindExternalEvents()),this.cropRectService=new UT(this,this.boxRenderer),this.perspectiveQuadService=new LT(this,this.boxRenderer),this.listenDefaultViewerEventsForBox(),this.listenDefaultGlobalEventsForBox(),this.listenPerspectiveViewerEventsForBox(),this.listenPerspectiveGlobalEventsForBox(),this.context.hasBoxRendererModule=!0,this.context.cropBoxEditService=new OT(this.cropRectService),this.context.perspectiveQuadEditService=new NT(this.perspectiveQuadService);}initBoxRenderer(){if(!this.context.isDefaultViewer&&!this.context.isPerspectiveViewer)return;const{enableEditCropBoxMidpoints:t,enableEditCropBoxVertices:e,enableHideEditingCropBoxMidpoint:i,enableHideEditingCropBoxVertex:s}=this.context.viewerConfig;this.boxRenderer=new BT({enableEditCropBoxMidpoints:t,enableEditCropBoxVertices:e,enableHideEditingCropBoxMidpoint:i,enableHideEditingCropBoxVertex:s}),this.boxRenderer.setCanvasDom(this.context.rendererService.getCanvasDom()),this.updateQuadStyle(),this.context.hooks.quadSelectionStyleChanged.on((()=>{this.updateQuadStyle();}),this),this.hooks.resize.on((()=>{this.context.render(3);}),this);const{hooks:n}=this.boxRenderer;n.boxCreated.on((t=>{let{box:e,fromEvent:i}=t;const s=this.context.getActiveTab();if(null!=s&&s.total&&(this.context.isDefaultViewer&&e.isRect&&!i&&"all"===this.cropMode&&this.boxRenderer.areas.forEach((t=>{t.boxes.length?t.boxes.forEach((i=>{t.isContainBox(e)?t.updateRectBox(i,[...e.vertexes]):t.clearBoxes();})):t.isContainBox(e)&&t.addRectBox([...e.vertexes],!0,!0);})),e.isRect)){let t=e.getRect();t=Gn(t,Bo.displayResolution,72),t=WT(t,2);const i=af.create(t);this.hooks.cropRectDrawn.emit(i);}})),n.boxDeleted.on((t=>{const e=this.context.getActiveTab();if(null!=e&&e.total&&t.isRect){let e=t.getRect();e=Gn(e,Bo.displayResolution,72),e=WT(e,2);const i=rf.create(e);this.hooks.cropRectDeleted.emit(i);}})),n.boxModified.on((t=>{const e=this.context.getActiveTab();if(null==e||!e.total)return;const{box:i}=t;if(this.context.isDefaultViewer&&i.isRect){let{oldRect:e,newRect:s}=t,n=0;"all"===this.cropMode&&this.boxRenderer.areas.forEach((t=>{t.boxes.length?t.boxes.forEach((e=>{t.isContainBox(i)?(n+=1,t.updateRectBox(e,[...i.vertexes])):t.clearBoxes();})):t.isContainBox(i)&&t.addRectBox([...i.vertexes]);})),e&&(e=Gn(e,Bo.displayResolution,72),e=WT(e,2)),s&&(s=Gn(s,Bo.displayResolution,72),s=WT(s,2));if(!(e&&s&&e.left===s.left&&e.top===s.top&&e.width===s.width&&e.height===s.height)){n=Math.max(1,n);for(let t=0;t<n;t++){const t=lf.create(e,s);this.hooks.cropRectModified.emit(t);}}}if(this.context.isPerspectiveViewer&&!i.isRect){const e=this.context.core.pageService.getPage(i.area.areaUid),s=this.boxRenderer.getAreaByUid(i.area.areaUid);if(!s)return;const n=s.isFullBox(i);e.isFull=n,e.setActiveQuad(i.getQuad());let{oldQuad:o,newQuad:r}=t;o&&(o=e.quadToPixelPPI(o)),r&&(r=e.quadToPixelPPI(r)),dv(o),dv(r),this.hooks.perspectiveQuadChanged.emit(Qg.create(r,o,e.isFull));}}));}updateQuadStyle(){const t=this.context.styleService.getParsedQuadSelectionStyle();this.boxRenderer.updateConfig({boxStyle:t});}bindExternalEvents(){this.hooks.cropRectDrawn.on((t=>{this.emit("cropRectDrawn",{rect:t.rect});}),this),this.hooks.cropRectDeleted.on((t=>{this.emit("cropRectDeleted",{rect:t.rect});}),this),this.hooks.cropRectModified.on((t=>{this.emit("cropRectModified",{oldRect:t.oldRect,newRect:t.newRect});}),this),this.hooks.perspectiveQuadChanged.on((t=>{const{newQuad:e,oldQuad:i}=t;let s=!1;i&&e&&(s=Yn(i,e)),s||this.emit("quadModified",{oldQuad:i,newQuad:e});}),this);}get cropMode(){return this.iCropMode}set cropMode(t){if(this.iCropMode===t)return;const e=this.iCropMode;this.iCropMode=t,this.hooks.cropModeChanged.emit(new vf(e,t));const i=this.context.getActiveTab();if(null!=i&&i.total){if("current"===e&&"all"===t){const t=this.boxRenderer.getAreaByUid(i.currentUid);if(t){const e=t.boxes[0];e&&this.boxRenderer.areas.forEach((t=>{t.isContainBox(e)?t.boxes.length?t.updateRectBox(t.boxes[0],[...e.vertexes]):t.addRectBox([...e.vertexes]):t.clearBoxes();}));}}this.cropRectService.clearRedundantBoxes(),this.context.render(74);}}toggleFullPerspective(){const{context:t}=this;if(!t.isPerspectiveViewer)return;const e=t.getActiveTab();if(null==e||!e.total)return;t.core.pageService.getPage(e.currentUid).toggleFull()&&(this.perspectiveQuadService.updatePageQuad(e),t.render(75));}listenDefaultGlobalEventsForBox(){this.context.isPerspectiveViewer||(this.context.core.editService.onAfterRotatePages.on((t=>{this.cropRectService.afterRotatePages(t);}),this),this.context.core.onAfterPerspective.on((t=>{this.cropRectService.afterPerspective(t);}),this));}listenPerspectiveGlobalEventsForBox(){this.context.isPerspectiveViewer&&(this.context.core.editService.onAfterRotatePages.on((t=>{this.perspectiveQuadService.afterRotatePages(t);}),this),this.context.core.onAfterPerspective.on((t=>{this.perspectiveQuadService.afterPerspective(t);}),this));}listenPerspectiveViewerEventsForBox(){if(!this.context.isPerspectiveViewer)return;const{perspectiveQuadService:t}=this;this.hooks.resize.on((()=>{t.reRender();}),this),this.hooks.visibleChanged.on((()=>{t.reRender();}),this),this.hooks.updatePage.on((e=>{t.updatePage(e);}),this),this.hooks.afterRender.on((e=>{t.afterRender(e),t.afterRenderForMagnifier();}),this),this.hooks.pageChanged.on((e=>{t.pageChanged(e);}),this);}listenDefaultViewerEventsForBox(){if(!this.context.isDefaultViewer)return;const{cropRectService:t}=this;this.hooks.updatePage.on((e=>{t.updatePage(e);}),this),this.hooks.addPagesToDoc.on((e=>{t.addPages(e);}),this),this.hooks.afterRender.on((e=>{t.afterRender(e),t.afterRenderForMagnifier();}),this),this.hooks.toolModeChanged.on((e=>{t.toolModeChanged(e);}),this),this.hooks.pageChanged.on((e=>{t.pageChanged(e);}),this),this.hooks.deletePages.on((e=>{t.deletePages(e);}),this),this.hooks.beforeCropPages.on((()=>{this.clearRectBox();}),this),this.hooks.closeDocument.on((t=>{t.pages.forEach((t=>{this.boxRenderer.deleteArea(t);}));}),this);}setRectBox(t,e){const i=this.context.getActiveTab();if(!i||!i.total)return !1;_s(e)&&(e=[i.current]);return i.indicesToUids(e).forEach((e=>{let i=t;i=Gn(t,Bo.dataResolution,Bo.displayResolution);const s=(t=>{const{left:e,top:i,width:s,height:n}=t;return [e,i,e+s,i,e+s,i+n,e,i+n]})(i),n=this.boxRenderer.areas.get(e);n.boxes.length?n.updateRectBox(n.boxes[0],s,!0):n.addRectBox(s);})),this.context.render(76),!0}getRectBox(){const t=this.context.getActiveTab();if(t&&t.total){let e=null;if(t.allPages.find((t=>{const i=this.boxRenderer.getAreaByUid(t.uid);return !(null==i||!i.boxes.length)&&(e=i,!0)})),e){const t=e.boxes[0];if(null!=t&&t.isRect){let e=t.getRect();return e=Gn(e,Bo.displayResolution,Bo.dataResolution),e=WT(e,2),e.width=e.width||1,e.height=e.height||1,e}}}return null}getRenderedRectBoxCount(){const t=this.context.getActiveTab();let e=0;return t&&t.total&&this.boxRenderer.areas.forEach((t=>{e+=t.boxes.length;})),e}getMatchedCropBoxIndices(t){const e=this.context.getActiveTab();if(!e)return [];const i=[];return e.allPages.forEach(((e,s)=>{const{width:n,height:o}=this.context.viewer.getRealPtPageSize(s);(function(t,e,i){const{left:s,top:n,width:o,height:r}=t,a=1e-4;if(Math.abs(s-e)>a&&s>e||Math.abs(s+o-e)>a&&s+o>e||Math.abs(n-i)>a&&n>i||Math.abs(n+r-i)>a&&n+r>i)return !1;return !0})(t,n,o)&&i.push(s);})),i}getCropIndices(){const t=this.context.getActiveTab();let e=[];if(t&&t.total)if("all"===this.iCropMode){const i=[];this.boxRenderer.areas.forEach((t=>{t.boxes.length&&i.push(t.areaUid);})),e=t.uidsToIndices(i);}else e=[t.current];return e}clearRectBox(){return this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),!0}setQuadBox(t){const e=this.context.getActiveTab();if(!e||!e.total)return !1;const i=this.context.core.pageService.getPage(e.currentUid);let s=t;s=t.map((t=>Gn(t,i.resource.resolutionX,Bo.displayResolution)));const n=this.boxRenderer.getAreaByUid(e.currentUid),{width:o,height:r}=n,a=rv(s,o,r);return i.isFull=a,i.setActiveQuad(s),this.perspectiveQuadService.updatePageQuad(e),this.context.render(77),!0}getQuadBox(){const t=this.context.getActiveTab();if(t&&t.total){const e=this.boxRenderer.getAreaByUid(t.currentUid).boxes[0];if(!e.isRect){let i=e.getQuad();const s=this.context.core.pageService.getPage(t.currentUid);return i=i.map((t=>Gn(t,Bo.displayResolution,s.resource.resolutionX))),dv(i),i}}return null}resetQuadBox(t){const e=this.context.getActiveTab();if(null==e||!e.total)return !1;let i=[];return i=_s(t)?[e.currentUid]:e.indicesToUids(t),i.forEach((t=>{const i=this.context.core.pageService.getPage(t),{quad:s}=i;s?(i.isFull&&(i.isFull=!1),i.setActiveQuad(s),this.perspectiveQuadService.updatePageQuad(e)):i.isFull||(i.isFull=!0,this.perspectiveQuadService.updatePageQuad(e));})),this.context.render(78),!0}clearQuadBox(){return this.boxRenderer.areas.forEach((t=>{t.clearBoxes();})),!0}isConvexQuad(t){return Xn(t.flat())}}}function WT(t,e){return {left:qn(t.left,e),top:qn(t.top,e),width:qn(t.width,e),height:qn(t.height,e)}}const FT={install(t){const e=_T(t.getClass("Viewer"));t.setClass("Viewer",e);}};class HT extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="rotate",this.isValid=!0,this.core.commandService.onBeforeRefreshCommands.on((t=>{const{pageUids:e}=this.action;e.slice().forEach((i=>{if(t.pageUids.includes(i)){const t=e.indexOf(i);e.splice(t,1);}})),this.isValid=e.length>0;}),this);}execute(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).addAction(e);}));const i=Uf.create(e.docUid,e.angle,e.pageUids);return t.editService.onRotatePages.emit(i),t.editService.onAfterRotatePages.emit(i),!0}undo(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).deleteAction(e.actionUid);}));const i=Uf.create(e.docUid,e.angle,e.pageUids);t.editService.onRotatePages.emit(i),t.editService.onAfterRotatePages.emit(i);}}class VT extends Dm{constructor(t,e){super(),i(this,"action",void 0),i(this,"core",void 0),this.action=t,this.core=e,this.type="crop",this.isValid=!0,this.core.commandService.onBeforeRefreshCommands.on((t=>{const{pageUids:e}=this.action;e.slice().forEach((i=>{if(t.pageUids.includes(i)){const t=e.indexOf(i);e.splice(t,1);}})),this.isValid=e.length>0;}),this);}execute(){const{core:t,action:e}=this;e.pageUids.forEach((e=>{t.pageService.getPage(e).addAction(this.action);}));const i=Rf.create(e.docUid,e.rect,e.pageUids);return t.editService.onCropPages.emit(i),t.editService.onAfterCropPages.emit(i),!0}undo(){const{core:t,action:e}=this;e.pageUids.forEach((i=>{t.pageService.getPage(i).deleteAction(e.actionUid);}));const i=Rf.create(e.docUid,e.rect,e.pageUids);t.editService.onCropPages.emit(i),t.editService.onAfterCropPages.emit(i);}}class zT extends Qn{constructor(t){super(),i(this,"core",void 0),i(this,"onRotatePages",void 0),i(this,"onAfterRotatePages",void 0),i(this,"onCropPages",void 0),i(this,"onAfterCropPages",void 0),this.core=t,this.initEventEmitter();}initEventEmitter(){this.onRotatePages=to(this),this.onAfterRotatePages=to(this),this.onCropPages=to(this),this.onAfterCropPages=to(this);}rotatePages(t,e,i,s){const n={actionUid:qs(),type:"rotate",docUid:t,pageUids:[...e],angle:i,rotationType:s},{core:o}=this,r=new HT(n,o);return o.commandService.execute(r,t),!0}cropPages(t,e,i){const s={actionUid:qs(),type:"crop",docUid:t,pageUids:[...e],rect:{...i}},{core:n}=this,o=new VT(s,n);return n.commandService.execute(o,t),!0}}const $T={apply(t){t.editService=new zT(t);},install(t){const e=t.getClass("Viewer"),i=(s=e,class extends s{constructor(t){super(t),this.listenGlobalEventsForEdit(),this.listenViewerEventsForEdit();}listenGlobalEventsForEdit(){const{context:t}=this,e=e=>{let{docUid:i,pageUids:s}=e;const n=t.tabService.getTab(i);if(null!=n&&n.isActive){t.scrollByCurrentChanged=!0,t.clearOptimization(s);let e=!0;t.isDefaultViewer?"none"===n.context.fitMode&&(e=!1):t.isThumbnailViewer&&(e=!1),t.showTab(n,{isClearOptimization:e,renderReason:81});}};t.core.editService.onRotatePages.on(e,this),t.core.editService.onCropPages.on(e,this);}listenViewerEventsForEdit(){this.hooks.beforeLayout.on((t=>{const{core:{pageService:e},isDefaultViewer:i,isThumbnailViewer:s,isPerspectiveViewer:n}=this.context;(i||s||n)&&t.allPages.forEach((t=>{let n=null;const o=e.getPage(t.uid);n=i||s?o.getEditResult():o.getEditResultForPerspective(),n&&(t.rWidth=n.rWidth,t.rHeight=n.rHeight,t.cropLeft=n.cropLeft,t.cropTop=n.cropTop,t.cropWidth=n.cropWidth,t.cropHeight=n.cropHeight,t.rotation=n.rotation,t.mediaBoxRect=n.mediaBox,t.cropBoxRect=n.cropBox);}));}),this);}rotatePages(t,e){var i;if(t%360==0)return !0;const s=this.context.getActiveTab();if(!s)return !1;null!==(i=e)&&void 0!==i||(e=[s.current]);const n=s.indicesToUids(e);return this.context.core.editService.rotatePages(s.uid,n,t,"contain")}cropPages(t,e){var i;const s=this.context.getActiveTab();if(!s)return !1;null!==(i=e)&&void 0!==i||(e=[s.current]);const n=s.indicesToUids(e);t=Gn(t,Bo.dataResolution,Bo.displayResolution),this.hooks.beforeCropPages.emit();const o=this.context.core.editService.cropPages(s.uid,n,t);return this.context.clearSelectedTexts(),this.hooks.afterCropPages.emit(n),o}});var s;t.setClass("Viewer",i);}};class jT{async perspective(t,e,i,s,n){var o;const r=new wo,a=await r.initImage({source:e.data,isRGBA:e.type===uo.RGBA,width:e.width,height:e.height,isBGRA:e.type===uo.BGRA});if(t.taskInfo.canceled)return r.terminate(),null;if(a.srcBuffer&&(e.data=a.srcBuffer),null!=s&&s.angle&&(await r.rotate({angle:s.angle}),t.taskInfo.canceled))return r.terminate(),null;if(await r.perspective(i),t.taskInfo.canceled)return r.terminate(),null;const l=await r.getImage({jpegQuality:null==n?void 0:n.jpegQuality,ifDeleteObject:!0,isRGBA:e.type===uo.RGBA,bitDepth:null==n?void 0:n.bitDepth,xDpi:null==n?void 0:n.xdpi,yDpi:null==n?void 0:n.ydpi,returnType:go.RT_BINARY,outputType:null!==(o=null==n?void 0:n.outputType)&&void 0!==o?o:Mo[e.type]});await r.freeReservedData();const h={data:new Blob([l.imageData],{type:l.blobType}),width:l.imageWidth,height:l.imageHeight,resolutionX:l.imageXResolution,resolutionY:l.imageYResolution};return r.terminate(),h}}wm.registerPlugin(Gw),wm.registerPlugin(DT),wm.registerPlugin(FT),wm.registerPlugin($T),wm.registerPlugin(Sx),wm.registerPlugin(iP);const XT=new class{constructor(){i(this,"tasks",[]),i(this,"isRunning",!1),this.registerParser("image/jpeg",Mc),this.registerParser("image/bmp",Mc),this.registerParser("image/png",Mc),this.registerParser("image/tiff",Ic),this.registerParser("image/jp2",Mc),this.registerParser("application/pdf",kd),this.registerParser("image/rgba",Rd),this.registerParser("application/ddv-blank-image",Qd);}dispose(){this.reset();}reset(){Md.getAllParsers().forEach((t=>t.destroy())),Md.clear(),Ud.clear();}freeParserByFileUid(t){Od.execute(t);}registerParser(t,e){$d.execute({mime:t,parser:e});}unregisterParser(t){jd.execute(t);}registerCustomParser(t,e){Xd.execute({mime:t,parser:e});}unregisterCustomParser(t){Gd.execute(t);}getDefaultParserOptions(t){return Yd.execute(t)}setDefaultParserOptions(t,e){return qd.execute({mime:t,options:e})}getCustomParserClasses(t){return Jd.execute(t)}async parse(t,e,i,s,n){return Vd.execute({fileData:t,mime:e,fileUid:i,indices:s,parseOptions:n})}async parseAnnotation(t,e,i,s,n,o){return zd.execute({fileData:t,mime:e,fileUid:i,indices:n,parseOptions:o,parsedPages:s})}async getPage(t,e,i,s){return _d.execute({fileData:t,mime:e,fileUid:i,fileIndex:s})}cancelGetPage(t,e){Wd.execute({fileUid:t,fileIndex:e});}async renderPage(t,e,i,s,n,o){const r={taskInfo:o,params:[t,e,i,s,n,o],resolve:void 0,reject:void 0},a=new Promise(((t,e)=>{r.resolve=t,r.reject=e;}));return this.isRunning?(this.tasks.push(r),this.freshTasks(),a):(this.executeRenderPageTask(r),a)}async executeRenderPageTask(t){this.isRunning=!0;try{const e=await Fd.execute({fileData:t.params[0],mime:t.params[1],fileUid:t.params[2],fileIndex:t.params[3],config:t.params[4],task:t.taskInfo});t.resolve(e);}catch(e){t.reject(e);}if(this.freshTasks(),this.tasks.length>0){const t=this.tasks.pop();this.executeRenderPageTask(t);}else this.isRunning=!1;}freshTasks(){this.tasks.slice().forEach((t=>{if(t.taskInfo.canceled){t.resolve(null);const e=this.tasks.indexOf(t);this.tasks.splice(e,1);}}));}cancelRenderPage(t,e){Hd.execute({fileUid:t,task:e});}async getParseInfo(t,e,i,s){return Zd.execute({fileData:t,mime:e,fileUid:i,options:s})}async getPageTexts(t,e,i,s){return Nd.execute({fileData:t,mime:e,fileUid:i,indices:s})}},GT=new wm(XT,new class{constructor(){this.registerSaver("application/pdf",Jo),this.registerSaver("image/png",Zo),this.registerSaver("image/jpeg",Zo),this.registerSaver("image/tiff",Qo);}registerSaver(t,e){_o.execute({mime:t,saverConstructor:e});}unregisterSaver(t){Wo.execute(t);}getSaver(t){return No.execute(t)}},new class extends Ro{async handler(t){const[e,i,s,n]=t.params;return (new jT).perspective(t,e,i,s,n)}dispose(){}perspective(t,e,i,s){const n={taskUid:qs(),canceled:!1};return this.createTask("perspective",[t,e,i,s],n)}},new class extends Ro{constructor(){super(...arguments),i(this,"filter",void 0);}async handler(t){var e;const[i,s,n,o]=t.params;return await(null===(e=this.filter)||void 0===e?void 0:e.applyFilter(i,s))}get enableFilter(){return !!this.filter}async applyFilter(t,e,i,s){const n={taskUid:qs(),canceled:!1};return this.createTask("filter",[t,e,i,s],n)}cancelFilter(t,e){}setImageFilter(t){t?this.filter=t:this.filter&&(this.filter.destroy(),this.filter=null);}getDefaultFilterType(){var t;return null===(t=this.filter)||void 0===t?void 0:t.defaultFilterType}getSupportedFilters(){var t;return (null===(t=this.filter)||void 0===t?void 0:t.querySupported())||[]}},new class{constructor(){i(this,"detector",void 0);}get enableDetect(){return this.detector&&this.detector instanceof du}detect(t,e){var i;return null===(i=this.detector)||void 0===i?void 0:i.detect(t,e)}setDetector(t){t?this.detector=t:this.detector&&(this.detector.destroy(),this.detector=null);}resetDetector(){this.detector&&this.detector.reset();}reset(){var t;null===(t=this.detector)||void 0===t||t.destroy(),this.detector=null;}}),YT="Layout",qT="Button",JT="Capture",ZT="Flashlight",QT="CameraConvert",KT="CameraResolution",tA="AutoDetect",eA="AutoCapture",iA="ImagePreview",sA="Rotate",nA="RotateLeft",oA="RotateRight",rA="Delete",aA="DeleteCurrent",lA="DeleteAll",hA="Zoom",cA="ZoomIn",dA="ZoomOut",uA="ZoomByPercentage",pA="Crop",gA="CropMode",fA="CropCurrent",vA="CropAll",mA="FullQuad",yA="PerspectiveAll",xA="Undo",wA="Redo",bA="FitMode",SA="FitWindow",CA="FitHeight",PA="FitWidth",TA="ActualSize",AA="DisplayMode",kA="SinglePage",DA="ContinuousPage",RA="Pan",EA="Load",MA="Download",IA="Print",BA="Filter",UA="Restore",LA="ThumbnailSwitch",OA="Pagination",NA="TextSelectionMode",_A="Done",WA="Back",FA="Blank",HA="Close",VA="MainView",zA="SeparatorLine",$A="AnnotationSet",jA="EllipseAnnotation",XA="EraseAnnotation",GA="InkAnnotation",YA="LineAnnotation",qA="PolygonAnnotation",JA="PolylineAnnotation",ZA="RectAnnotation",QA="SelectAnnotation",KA="StampIconAnnotation",tk="StampImageAnnotation",ek="TextBoxAnnotation",ik="TextTypewriterAnnotation",sk="HighlightAnnotation",nk="UnderlineAnnotation",ok="StrikeoutAnnotation",rk="BringForward",ak="BringToFront",lk="SendBackward",hk="SendToBack",ck="TextSearchPanel",dk="TextSearchPanelSwitch";function uk(t,e,i,s){return !!_s(t)&&Ru.output(e,i,s,void 0,ku.PARAM_MISS,!0)}function pk(t,e,i,s){return !!Os(t)||Ru.output(e,i,s,void 0,ku.PARAM_INVALID)}class gk{static getTooltip(){return eP.getTooltip()}static setTooltip(t){const e="Elements.setTooltip",i="tooltip";return !(uk(t,1,e,i)||!pk(t,1,e,i))&&(eP.setTooltip(t),!0)}static getDisplayTextConfig(){return eP.getDisplayTextConfig()}static setDisplayTextConfig(t){const e="Elements.displayTextConfig",i="displayTextConfig";return !(uk(t,1,e,i)||!pk(t,1,e,i))&&(eP.setDisplayTextConfig(t),!0)}static get Layout(){return YT}static get Button(){return qT}static get Capture(){return JT}static get Flashlight(){return ZT}static get CameraConvert(){return QT}static get CameraResolution(){return KT}static get AutoDetect(){return tA}static get AutoCapture(){return eA}static get ImagePreview(){return iA}static get Rotate(){return sA}static get RotateLeft(){return nA}static get RotateRight(){return oA}static get Delete(){return rA}static get DeleteCurrent(){return aA}static get DeleteAll(){return lA}static get Zoom(){return hA}static get ZoomIn(){return cA}static get ZoomOut(){return dA}static get ZoomByPercentage(){return uA}static get Crop(){return pA}static get CropCurrent(){return fA}static get CropAll(){return vA}static get FullQuad(){return mA}static get PerspectiveAll(){return yA}static get Undo(){return xA}static get Redo(){return wA}static get Pan(){return RA}static get CropMode(){return gA}static get Load(){return EA}static get Download(){return MA}static get Print(){return IA}static get Filter(){return BA}static get Restore(){return UA}static get ThumbnailSwitch(){return LA}static get Pagination(){return OA}static get FitMode(){return bA}static get FitWindow(){return SA}static get FitHeight(){return CA}static get FitWidth(){return PA}static get ActualSize(){return TA}static get DisplayMode(){return AA}static get SinglePage(){return kA}static get ContinuousPage(){return DA}static get MainView(){return VA}static get SeparatorLine(){return zA}static get Done(){return _A}static get Back(){return WA}static get Blank(){return FA}static get Close(){return HA}static get AnnotationSet(){return $A}static get EllipseAnnotation(){return jA}static get EraseAnnotation(){return XA}static get InkAnnotation(){return GA}static get LineAnnotation(){return YA}static get PolygonAnnotation(){return qA}static get PolylineAnnotation(){return JA}static get RectAnnotation(){return ZA}static get SelectAnnotation(){return QA}static get StampIconAnnotation(){return KA}static get StampImageAnnotation(){return tk}static get TextBoxAnnotation(){return ek}static get TextTypewriterAnnotation(){return ik}static get BringForward(){return rk}static get BringToFront(){return ak}static get SendBackward(){return lk}static get SendToBack(){return hk}static get HighlightAnnotation(){return sk}static get UnderlineAnnotation(){return nk}static get StrikeoutAnnotation(){return ok}static get TextSelectionMode(){return NA}static get TextSearchPanel(){return ck}static get TextSearchPanelSwitch(){return dk}}const fk={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-capture-viewer-header-mobile",children:[{type:"CameraResolution",className:"ddv-capture-viewer-resolution"},gk.Flashlight]},gk.MainView,{type:"Layout",className:"ddv-capture-viewer-footer-mobile",children:[gk.AutoDetect,gk.AutoCapture,{type:"Capture",className:"ddv-capture-viewer-captureButton"},gk.ImagePreview,gk.CameraConvert]}]},vk={type:"Layout",flexDirection:"column",className:"ddv-edit-viewer-mobile",children:[{type:"Layout",className:"ddv-edit-viewer-header-mobile",children:[gk.Blank,gk.AnnotationSet,gk.Pagination,gk.Download,gk.TextSearchPanelSwitch]},gk.MainView,{type:"Layout",className:"ddv-edit-viewer-footer-mobile",children:[gk.DisplayMode,gk.RotateLeft,gk.Crop,gk.Undo,gk.Delete,gk.Load]},{type:gk.TextSearchPanel,className:"ddv-edit-viewer-search-mobile"}]},mk={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-perspective-viewer-header-mobile",children:[gk.Blank,gk.Pagination,gk.PerspectiveAll]},gk.MainView,{type:"Layout",className:"ddv-perspective-viewer-footer-mobile",children:[gk.FullQuad,gk.RotateLeft,gk.RotateRight,gk.DeleteCurrent,gk.DeleteAll]}]},yk={type:"Layout",flexDirection:"column",className:"ddv-capture-viewer-desktop",children:[{type:"Layout",className:"ddv-capture-viewer-header-desktop",children:[{type:gk.CameraResolution,className:"ddv-capture-viewer-resolution-desktop"},gk.AutoDetect,{type:gk.Capture,className:"ddv-capture-viewer-capture-desktop"},gk.AutoCapture]},gk.MainView,{type:gk.ImagePreview,className:"ddv-capture-viewer-image-preview-desktop"}]},xk={type:"Layout",flexDirection:"column",children:[{type:"Layout",className:"ddv-perspective-viewer-header-desktop",children:[gk.FullQuad,gk.RotateLeft,gk.RotateRight,gk.DeleteCurrent,gk.DeleteAll,{type:gk.Pagination,className:"ddv-perspective-viewer-pagination-desktop"},{type:gk.PerspectiveAll,className:"ddv-perspective-viewer-perspective-desktop"}]},gk.MainView]},wk={type:gk.Layout,flexDirection:"column",className:"ddv-edit-viewer-desktop",children:[{type:gk.Layout,className:"ddv-edit-viewer-header-desktop",children:[{type:gk.Layout,enableScroll:!0,children:[gk.ThumbnailSwitch,gk.Zoom,gk.FitMode,gk.DisplayMode,gk.RotateLeft,gk.RotateRight,gk.Crop,gk.Undo,gk.Redo,gk.DeleteCurrent,gk.DeleteAll,gk.Pan,gk.TextSelectionMode,gk.SeparatorLine,gk.AnnotationSet]},{type:gk.Layout,children:[{type:gk.Pagination,className:"ddv-edit-viewer-pagination-desktop"},gk.Load,gk.Download,gk.Print,gk.TextSearchPanelSwitch]}]},{type:gk.Layout,flexDirection:"row",children:[gk.MainView,gk.TextSearchPanel]}]},bk={type:gk.Layout,children:[gk.MainView]};Ns(vk).children[0].children=[gk.Blank,gk.Blank,gk.Pagination,gk.AnnotationSet,gk.Download];const Sk=Ns(wk);var Ck,Pk;Sk.children[0].children[0].enableScroll=!0,Sk.children[0].children[0].children.push(gk.SeparatorLine,gk.AnnotationSet),function(t){t.REJECTED="rejected",t.ACCEPTED="accepted",t.INITIAL_HERE="initialHere",t.SIGN_HERE="signHere",t.WITNESS="witness",t.APPROVED="approved",t.NOT_APPROVED="notApproved",t.DRAFT="draft",t.FINAL="final",t.COMPLETED="completed",t.CONFIDENTIAL="confidential",t.VOID="void";}(Ck||(Ck={})),function(t){t.NONE="none",t.OPEN="open",t.OPEN_REVERSE="openReverse",t.CLOSED="closed",t.CLOSED_REVERSE="closedReverse",t.BUTT="butt",t.SLASH="slash",t.SQUARE="square",t.DIAMOND="diamond",t.CIRCLE="circle";}(Pk||(Pk={}));const Tk={background:"#e2e1de"},Ak={border:"1px solid #707070",background:"#fff"},kk={border:"2px solid #fe8e14",background:"rgba(255,255,255,0)",maskColor:"rgba(128,128,128,0.6)",ctrlBorderRadius:"50%",ctrlBackground:"#fe8e14",ctrlBorder:"2px solid #fe8e14",ctrlWidth:"15px",ctrlHeight:"15px",invalidCtrlBorderColor:"red",invalidBorderColor:"red"},Dk={opacity:1,borderWidth:1,borderColor:"rgb(0,0,0)",background:"",lineDash:[0,0]},Rk={content:"",color:"rgb(0,0,0)",fontSize:16,fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",lineThrough:!1,underline:!1},Ek={content:"",color:"rgb(0,0,0)",fontSize:1536/72,fontFamily:"Helvetica",fontStyle:"normal",fontWeight:"normal",lineThrough:!1,underline:!1};$s()&&(Dk.borderWidth=3,Rk.fontSize=72);const Mk={...Dk,lineEnding:{start:Pk.NONE,end:Pk.NONE}},Ik={paletteConfig:{maxFontSize:256,maxBorderWidth:40,colorList:["#F01314","#FD7C10","#FFEE5F","#07C37F","#0E68F5","#9D3BFE","#000000","#FF9494","#87440C","#B7A514","#046743","#50C9FF","#EBA3ED","#ffffff","#CECECE"],labels:{text:"Text",stroke:"Stroke",fill:"Fill",opacity:"Opacity",style:"Style",standardBusiness:"StandardBusiness"}},toolbarConfig:{},annotationSelectionStyle:{border:"1px solid #59626A",background:"",ctrlBorderRadius:"6px",ctrlWidth:"12px",ctrlHeight:"12px",ctrlBorder:"1px solid #59626A",ctrlBackground:"white"},inkCreateDelay:1e3,showOnTopWhenSelected:!1,enableContinuousDrawing:!1,defaultStyleConfig:{rectangle:{...Dk},ellipse:{...Dk},polygon:{...Dk},polyline:{...Mk},line:{...Mk},ink:{opacity:1,borderWidth:$s()?3:1,borderColor:"rgb(0,0,0)"},textBox:{...Dk,textAlign:"left",textContent:{...Rk}},textTypewriter:{opacity:1,textContent:{...Rk}},stamp:{opacity:1,stamp:Ck.DRAFT},highlight:{background:"#FD7C10",opacity:1},underline:{borderColor:"#0E68F5",opacity:1},strikeout:{borderColor:"#F01314",opacity:1}}},Bk={canvasStyle:{...Tk},quadSelectionStyle:{...kk},enableAutoCapture:!1,enableAutoDetect:!1,enableTorch:!1,maxFrameNumber:10,acceptedPolygonConfidence:80};function Uk(t,e){return !!t.getActiveTab()||Ru.output(e,void 0,void 0,void 0,ku.DOC_NOT_OPEN)}function Lk(t,e,i,s){return !i.getActiveTab().doc.pages.length&&Ru.output(s,t,e,void 0,ku.DOC_NO_IMAGE,!0)}function Ok(t,e,i,s){return !!function(t){return !(!js(t)||js(t)&&!Number.isInteger(t))}(t)||Ru.output(s,e,i,void 0,ku.PARAM_INVALID)}function Nk(t,e,i,s,n){const o=dE.isUiConfigValid(t,s);if(o.length>0)return Ru.output(n,i,s,o);const r=QR(t,e);return !r||Ru.output(n,e.charAt(0).toUpperCase()+e.slice(1),r,void 0,ku.ELEMENT_UNSUPPORTED)}function _k(t,e,i,s,n,o){return (t<e||t>i)&&Ru.output(s,n,o,void 0,ku.PARAM_OUT_OF_RANGE,!0)}function Wk(t,e,i,s){return !!t.includes(e)||Ru.output(i,s,void 0,void 0,ku.PAGE_NOT_EXIST)}function Fk(t,e,i,s){return !!zs(t)||Ru.output(s,e,i,void 0,ku.PARAM_INVALID)}function Hk(t,e,i,s,n){const o=Ru.formatError(Ru.isStringAndNotEmpty(t,n));return !o||Ru.output(e,i,s,void 0,o)}function Vk(t,e,i,s,n,o,r){const a=dE.isNumberArrayValid(t,n,o,r);return !a.length||Ru.output(e,i,s,a,ku.PARAM_INVALID)}class zk{getIsBoundContainer(t){return t.context.viewService.isBindContainer}bindContainer(t,e,i){uk(e,0,i,"container");const s=dE.isContainerParamValid(e);s&&Ru.error(i,"container",void 0,s),t.bindContainer(e);}unbindContainer(t){t.unbindContainer();}getIsVisible(t){return "visible"===t.getViewerConfig().visibility}show(t){t.show();}hide(t){t.hide();}getCurrentDocument(t){var e;const i=null===(e=t.getActiveTab())||void 0===e?void 0:e.uid;return i?PE.getDocument(i):null}openDocument(t,e,i){const s="docUid or doc";uk(t,0,i,s),function(t){if(Xs(t))return 0!==t.trim().length;return !1}(t)||Os(t)||Ru.error(i,s,void 0,ku.PARAM_INVALID);const n=Os(t)?t.uid:t;!function(t,e,i,s,n){!!t.getDocument(e)||Ru.output(i,s,n,void 0,ku.DOC_NOT_EXIST);}(GT.documentService,n,0,i,s),GT.getViewer(e)||Ru.error(i,"viewerUid",void 0,ku.PARAM_INVALID),GT.openDocument(n,e);}closeDocument(t,e){return !!Uk(t,1)&&(t.closeDocument(),!0)}getStyle(t,e,i,s,n){const o="styleName";if(uk(i,1,n,o)||!Hk(i,1,n,o))return null;if(!s.includes(i))return Ru.warning(n,o,void 0,ku.PARAM_NOT_SUPPORT),null;if("annotationSelectionStyle"===i){return t.getAnnotationConfig().controlsStyle}const r=t.getViewerConfig();if(i in r){const t=function(t,e){const i=["border","background"],s=["left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY","opacity","visibility"],n={pageStyle:i,selectedPageStyle:i,hoveredPageStyle:i,canvasStyle:[...i,"cursor"],checkboxStyle:[...s,"checkMarkColor","checkMarkLineWidth"],pageNumberStyle:[...s,"color","fontSize","fontFamily","onPage"],quadSelectionStyle:["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground","invalidCtrlBorderColor","invalidBorderColor"]};if(t in n){const i=n[t];return Object.fromEntries(Object.entries(e).filter((t=>{let[e,s]=t;return i.includes(e)})))}return Ns(e)}(i,r[i]);return "capture"===e&&"quadSelectionStyle"===i?{border:t.border,background:t.background}:t}return null}updateStyle(t,e,i,s,n){return !(uk(e,1,n,"styleName")||uk(i,1,n,"style")||!Hk(e,1,n,"styleName")||!pk(i,1,n,"style")||!function(t,e,i,s,n,o){if(!Hk(t,o,s,n))return !1;if(!i.includes(t))return Ru.output(o,s,n,void 0,ku.PARAM_NOT_SUPPORT);const r=oE(t,e);return !r.length||Ru.output(o,s,"style",r)}(e,i,s,n,"styleName",1))&&("annotationSelectionStyle"===e?(t.updateAnnotationConfig({controlsStyle:i}),!0):(t.updateViewerConfig({[e]:i}),!0))}getUiConfig(t){return t.getUiConfig()}updateUiConfig(t,e,i,s){const n="uiConfig";return !(uk(e,1,s,n)||!Nk(e,i,s,n,1))&&t.updateUiConfig(e)}indexToUid(t,e,i){const s="index";if(uk(e,1,i,s)||!Ok(e,i,s,1)||!Uk(t,1)||Lk(void 0,void 0,t,1))return "";return _k(e,0,t.getPageCounts()-1,1,i,s)?"":t.indexToUid(e)}uidToIndex(t,e,i){if(uk(e,1,i,"uid")||!Hk(e,1,i,"uid",!1)||!Uk(t,1)||Lk(void 0,void 0,t,1))return -1;return Wk(this.getCurrentDocument(t).pages,e,1,i)?t.uidToIndex(e):-1}getCurrentPageUid(t){return Uk(t,1)?Lk(void 0,void 0,t,1)?"":t.getCurrentPageUid():""}getCurrentPageIndex(t){return Uk(t,1)?Lk(void 0,void 0,t,1)?-1:t.getCurrentPageIndex():-1}getPageCount(t){return Uk(t,1)?t.getPageCounts():-1}gotoPage(t,e,i){const s="index";if(uk(e,1,i,s)||!Ok(e,i,s,1)||!Uk(t,1)||Lk(void 0,void 0,t,1))return -1;return _k(e,0,t.getPageCounts()-1,1,i,s)?-1:t.gotoPage(e)}rotate(t,e,i,s){if(uk(e,1,s,"angle")||!Ok(e,s,"angle",1)||!function(t,e,i,s){return t%90==0||Ru.output(s,e,i,void 0,ku.PARAM_NOT_SUPPORT)}(e,s,"angle",1)||!Uk(t,1)||Lk(void 0,void 0,t,1))return !1;if(!_s(i)){if(!Vk(i,1,s,"indices",0,this.getPageCount(t)-1))return !1}return t.rotatePages(e,i)}saveOperation(t){return !!Uk(t,1)&&t.saveOperations()}on(t,e,i,s){!uk(i,1,e,"eventName")&&!uk(s,1,e,"listener")&&Hk(i,1,e,"eventName",!1)&&Fk(s,e,"listener",1)&&t.on(i,s);}off(t,e,i,s){!uk(i,1,e,"eventName")&&Hk(i,1,e,"eventName",!1)&&(_s(s)||Fk(s,e,"listener",1))&&t.off(i,s);}destroy(t){t&&t.dispose();}}function $k(t,e,i,s){return !!Vs(t)||Ru.output(s,e,i,void 0,ku.PARAM_INVALID)}function jk(t,e,i,s,n,o){const r=Ru.formatError(Ru.isNumberAndIsInRange(t,n,o));return !r||Ru.output(e,i,s,void 0,r)}function Xk(t,e,i,s,n){if(!Os(t))return Ru.output(i,s,n,void 0,ku.PARAM_INVALID);const o=[],r=["pageStyle","hoveredPageStyle","selectedPageStyle","currentPageStyle","placeholderStyle","canvasStyle","pageNumberStyle","checkboxStyle","quadSelectionStyle"];return Object.keys(t).forEach((i=>{const s=t[i];if("container"===i)o.push(...dE.isContainerKeyValid(s,n));else if("uiConfig"===i){const t=dE.isUiConfigValid(s,"option.uiConfig");if(t.length>0)o.push(...t);else {const t=QR(s,e);if(t){const i=ku.buildError(ku.ELEMENT_UNSUPPORTED,e.charAt(0).toUpperCase()+e.slice(1),t);o.push(`option.uiConfig: ${i.message}`);}}}else "viewerConfig"!==i&&"thumbnailConfig"!==i||Object.keys(s).forEach((t=>{const e=s[t];if(r.includes(t)){const s=oE(t,e);o.push(...s.map((t=>`${i}.${t}`)));}}));})),!(o.length>0)||Ru.output(i,s,n,o)}const Gk=["canvasStyle","quadSelectionStyle"],Yk="CaptureViewer";var qk=new WeakMap,Jk=new WeakMap,Zk=new WeakSet;class Qk{constructor(t){var e;v(this,Zk),f(this,qk,{writable:!0,value:void 0}),f(this,Jk,{writable:!0,value:new zk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0);const o=`new ${Yk}`;Ap.makeSureCoreLicenseExist(),Ap.makeSureCameraLicenseExist(),_s(t)||Xk(t,"captureViewer",0,o,"option");const r=Nn((null==t?void 0:t.viewerConfig)||{},Ns({...Bk,viewerMode:lg.CAPTURE})),a=$s()?fk:yk;n(this,qk,GT.createViewer({uiConfig:Ns(a),...t,viewerConfig:r})),null!=t&&null!==(e=t.viewerConfig)&&void 0!==e&&e.enableAutoDetect&&!s(this,qk).context.core.detectorService.enableDetect&&ku.warning(ku.DOC_DETECT_MISS),this.uid=s(this,qk).uid,this.groupUid=s(this,qk).groupUid,this.postfix=s(this,qk).postfix,p(this,Zk,Kk).call(this);}get isVisible(){return s(this,Jk).getIsVisible(s(this,qk))}get isBoundContainer(){return s(this,Jk).getIsBoundContainer(s(this,qk))}get currentDocument(){return s(this,Jk).getCurrentDocument(s(this,qk))}get acceptedPolygonConfidence(){return s(this,qk).getCameraConfig().acceptedPolygonConfidence}set acceptedPolygonConfidence(t){const e="acceptedPolygonConfidence";jk(t,1,`${Yk}.${e}`,e,0,100)&&s(this,qk).updateCameraConfig({acceptedPolygonConfidence:t});}get maxFrameNumber(){return s(this,qk).getCameraConfig().maxFrameNumber}set maxFrameNumber(t){const e="maxFrameNumber";jk(t,1,`${Yk}.${e}`,e,1e-6,60)&&s(this,qk).updateCameraConfig({maxFrameNumber:t});}get enableAutoDetect(){return s(this,qk).getCameraConfig().enableAutoDetect}set enableAutoDetect(t){const e="enableAutoDetect",i=`${Yk}.${e}`;$k(t,i,e,1)&&(t&&!s(this,qk).context.core.detectorService.enableDetect&&Ru.warning(i,void 0,void 0,ku.DOC_DETECT_MISS),s(this,qk).updateCameraConfig({enableAutoDetect:t}));}get enableAutoCapture(){return s(this,qk).getCameraConfig().enableAutoCapture}set enableAutoCapture(t){const e="enableAutoCapture";$k(t,`${Yk}.${e}`,e,1)&&s(this,qk).updateCameraConfig({enableAutoCapture:t});}bindContainer(t){s(this,Jk).bindContainer(s(this,qk),t,`${Yk}.bindContainer`);}unbindContainer(){s(this,Jk).unbindContainer(s(this,qk));}show(){s(this,Jk).show(s(this,qk));}hide(){s(this,Jk).hide(s(this,qk));}getUiConfig(){return s(this,Jk).getUiConfig(s(this,qk))}updateUiConfig(t){return s(this,Jk).updateUiConfig(s(this,qk),t,"captureViewer",`${Yk}.updateUiConfig`)}openDocument(t){s(this,Jk).openDocument(t,this.uid,`${Yk}.openDocument`);}closeDocument(){return s(this,Jk).closeDocument(s(this,qk),`${Yk}.closeDocument`)}getStyle(t){return s(this,Jk).getStyle(s(this,qk),"capture",t,Gk,`${Yk}.getStyle`)}updateStyle(t,e){return s(this,Jk).updateStyle(s(this,qk),t,e,Gk,`${Yk}.updateStyle`)}capture(){return s(this,qk).isVideoPlaying()?s(this,qk).context.viewService.isBindContainer?s(this,qk).capture():ku.reject(ku.CONTAINER_NO_BOUND):ku.reject(ku.CAMERA_NO_VIDEO)}play(t){const e=`${Yk}.play`;if(!_s(t)){const i=function(t,e,i,s){const n=dE.isVideoConfig(t,s);return !n.length||Ru.output(e,i,s,n)}(t,2,e,"config");if(!0!==i)return i}return s(this,qk).play(t).catch((t=>ku.reject(t,e)))}stop(){s(this,qk).stop();}getCurrentCamera(){return s(this,qk).getCurrentCamera()}getAllCameras(){return s(this,qk).getAllCameras()}selectCamera(t){const e=`${Yk}.selectCamera`,i="cameraObjectOrDeviceID",n=uk(t,2,e,i);if(n)return n;if(Xs(t)){const s=Hk(t,2,e,i,!1);if(!0!==s)return s}else {const s=function(t,e,i,s){const n=dE.isVideoDeviceInfo(t,s);return !n.length||Ru.output(e,i,s,n)}(t,2,e,i);if(!0!==s)return s}return s(this,qk).selectCamera(t).catch((t=>ku.reject(t,e,i)))}getCurrentResolution(){return s(this,qk).getCurrentResolution()}turnOnTorch(){return s(this,qk).turnOnTorch().catch((t=>ku.reject(t)))}turnOffTorch(){return s(this,qk).turnOffTorch().catch((t=>ku.reject(t)))}on(t,e){s(this,Jk).on(s(this,qk),`${Yk}.on`,t,e);}off(t,e){s(this,Jk).off(s(this,qk),`${Yk}.off`,t,e);}destroy(){s(this,Jk).destroy(s(this,qk));}}function Kk(){s(this,qk).hooks.destroy.on((()=>{n(this,qk,null),Object.setPrototypeOf(this,null);}));}const tD={canvasStyle:{...Tk},currentPageStyle:{border:"4px solid #fe8e14"},pageStyle:{border:"6px solid rgba(0,0,0,0)",background:"rgba(255,255,255,0)"},selectedPageStyle:{border:"6px solid #AAAAAA",background:"#AAAAAA"},hoveredPageStyle:{border:"6px solid #AAAAAA",background:"#AAAAAA"},placeholderStyle:{border:"6px solid rgba(136,136,136,0.2)",background:"rgba(136,136,136,0.2)"},pageNumberStyle:{onPage:!1,visibility:"visible",width:"32px",height:"24px",background:"rgba(255,255,255,0)",border:"0px solid #000",borderRadius:"0px",opacity:1,color:"#323234",fontSize:"14px",fontFamily:"Open Sans",left:"50%",top:"",right:"",bottom:"3px",translateX:"-50%",translateY:"0px"},checkboxStyle:{left:"2px",top:"2px",width:"16px",height:"16px",background:"#fff",border:"2px solid #999999",borderRadius:"0px",translateX:"0px",translateY:"0px",opacity:1,visibility:"visible",checkMarkColor:"#FE8E14",checkMarkLineWidth:"2px"},rows:2,columns:2,multiselectMode:!1,scrollToLatest:!1,enableDragPage:!0,scrollDirection:"vertical",enableAutoScrollForDragPages:!0},eD={...tD,visibility:"hidden",size:"180px",position:"left",rows:4,columns:1,canvasStyle:{background:"#DDDDDD"}},iD={canvasStyle:{...Tk},pageStyle:{...Ak},quadSelectionStyle:{...kk},currentPageStyle:{border:"",background:""},minZoom:.01,maxZoom:64,scrollDirection:"vertical",enableSlide:!0,scrollToLatest:!1,enableMagnifier:!0,enableLoadSourceByDrag:!0,enableAutoScrollForTextSelection:!0},sD=["canvasStyle","pageStyle","selectedPageStyle","hoveredPageStyle","placeholderStyle","pageNumberStyle","checkboxStyle","currentPageStyle","cursorStyle"];var nD=new WeakSet;class oD{constructor(t){var e,s;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"BaseBrowseViewer";v(this,nD),i(this,"v",void 0),i(this,"vCommon",new zk),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),i(this,"errorPrefix",void 0),this.errorPrefix=n;const o=`new ${this.errorPrefix}`;Ap.makeSureCoreLicenseExist(),_s(t)||Xk(t,"browseViewer",0,o,"option");const r=cE(null==t?void 0:t.keyboardInteractionConfig),a=Nn((null==t?void 0:t.viewerConfig)||{},Ns({...tD,viewerMode:lg.THUMBNAIL,displayMode:"multiple",toolMode:"pan",enableOptimizePage:!0})),l={passwordLoaderConfig:{enabled:null!==(e=null==t||null===(s=t.viewerConfig)||void 0===s?void 0:s.enablePasswordLoader)&&void 0!==e?e:"BrowseViewer"===n}};this.v=GT.createViewer({uiConfig:Ns(bk),...t,viewerConfig:{enablePopup:!0,...a,...r},popupConfig:l}),this.uid=this.v.uid,this.groupUid=this.v.groupUid,this.postfix=this.v.postfix,p(this,nD,rD).call(this);}get isVisible(){return this.vCommon.getIsVisible(this.v)}get isBoundContainer(){return this.vCommon.getIsBoundContainer(this.v)}set multiselectMode(t){const e="multiselectMode";$k(t,`${this.errorPrefix}.${e}`,e,1)&&this.v.updateViewerConfig({multiselectMode:t});}get multiselectMode(){return this.v.getViewerConfig().multiselectMode}show(){this.vCommon.show(this.v);}hide(){this.vCommon.hide(this.v);}getUiConfig(){return this.vCommon.getUiConfig(this.v)}updateUiConfig(t){return this.vCommon.updateUiConfig(this.v,t,"browseViewer",`${this.errorPrefix}.updateUiConfig`)}getStyle(t){return this.vCommon.getStyle(this.v,"browse",t,sD,`${this.errorPrefix}.getStyle`)}updateStyle(t,e){const i=`${this.errorPrefix}.updateStyle`;return this.vCommon.updateStyle(this.v,t,e,sD,i)}getSelectedPageIndices(){return Uk(this.v,1)?this.v.getSelectedPageIndices():[]}selectAllPages(){if(!Uk(this.v,1))return [];if(0===this.v.getPageCounts()){const t=`${this.errorPrefix}.selectAllPages`;return Ru.output(1,t,void 0,void 0,ku.DOC_NO_IMAGE),[]}return this.v.selectAllPages()}selectPages(t){const e=`${this.errorPrefix}.selectPages`,i="indices";if(uk(t,1,e,i)||!Uk(this.v,1))return [];return Vk(t,1,e,i,0,this.v.getPageCounts()-1)?this.v.selectPagesByIndices(t):[]}setRowAndColumn(t,e){const i=`${this.errorPrefix}.setRowAndColumn`,s="row",n="column",{maxColumns:o,maxRows:r}=this.v.getViewerConfig();return !(uk(t,1,i,s)||uk(e,1,i,n)||!Ok(t,i,s,1)||!Ok(e,i,n,1)||_k(t,1,r,1,i,s)||_k(e,1,o,1,i,n))&&this.v.setRowAndColumn(t,e)}on(t,e){this.vCommon.on(this.v,`${this.errorPrefix}.on`,t,e);}off(t,e){this.vCommon.off(this.v,`${this.errorPrefix}.off`,t,e);}getVisiblePagesInfo(){return this.v.getVisiblePagesInfo()}}function rD(){this.v.hooks.destroy.on((()=>{this.v=null,Object.setPrototypeOf(this,null);}));}function aD(t,e,i,s,n){const o=dE.isAnnotationOptionsValid(t,s,n);return !o.length||Ru.output(e,i,s,o)}const lD={borderColor:"rgb(0,0,0)",background:"",borderWidth:1,opacity:1,lineDash:[0,0],flags:{print:!0,noView:!1,readOnly:!1},rotation:0};var hD=new WeakMap;class cD{constructor(t){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),f(this,hD,{writable:!0,value:void 0}),n(this,hD,t),this.uid=qs(),this.creationDate=Jf(),this.modificationDate=this.creationDate;}get source(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return null}get pageUid(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(uk(t,1,e,"options"))return;if(!$k(t,e,"options",1))return;GT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?GT.annotationService.flattenAnnotations([this.uid]):GT.annotationService.unFlattenAnnotation(this.uid));}getOptions(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);if(t){const e=t.getConfig(),i=pD(e,this.type);n(this,hD,{...i}),this.modificationDate=e.comment.modificationDate;}return vD(this.type,s(this,hD))}updateOptions(t){const e="Annotation.updateOptions";if(uk(t,1,e,"options"))return !1;if(!pk(t,1,e,"options"))return !1;if(!aD(t,1,e,"options",this.type))return !1;const i=this.getOptions(),n=dD(this.type,t,i);if(["rectangle","stamp","ellipse","textBox","ink"].includes(this.type)||(n.has("rotated")&&n.delete("rotated"),js(null==t?void 0:t.angle)&&(t.angle=void 0)),!n.size)return !0;this.getOptions(),Nn(t,s(this,hD)),t.flags={...s(this,hD).flags,...t.flags||{}};const o=uD({...t},this.type);var r;if(["highlight","underline","strikeout"].includes(this.type)&&(null!=o&&null!==(r=o.style)&&void 0!==r&&null!==(r=r.lines)&&void 0!==r&&r.length)){const{lines:t}=o.style,e=16,i=t[0],s=t[t.length-1],n={left:i.left,top:i.top,width:e,height:e},r={left:s.left+s.width-e,top:s.top,width:e,height:s.height};o.startCharRect=n,o.endCharRect=r;const a=Am(t);o.style.borderWidth=a;}return GT.annotationService.updateAnnotations([{annotationUid:this.uid,options:o}],void 0,[...n]),!0}}function dD(t,e,i){const s="startPoint",n="endPoint",o=new Map([[["x","y"],"moved"],[["width","height","rects"],"resized"],[["rotation"],"rotated"],[["flags"],"flagsChanged"],[["borderWidth","borderColor","background","opacity","textAlign","lineCap","lineJoin","miterLimit","lineDash","lineEnding","textContents"],"appearanceChanged"],[["textContents","stamp"],"contentChanged"]]),r=Ns(e);r.flags={...i.flags,...(null==r?void 0:r.flags)||{}},["line","polyline"].includes(t)&&e.lineEnding&&(r.lineEnding={...i.lineEnding,...(null==r?void 0:r.lineEnding)||{}});const a=new Set,l=Object.keys(r);return l.forEach((e=>{if(!nE(i[e],r[e]))if("points"!==e||"ink"!==t&&"polygon"!==t&&"polyline"!==t)if(e!==s&&e!==n||"line"!==t)for(const[t,i]of o)t.includes(e)&&!a.has(i)&&a.add(i);else l.includes(s)&&l.includes(n)&&lE([i[s],i[n]],[r[s],r[n]])?a.add("moved"):a.add("resized");else lE(i[e],r[e])?a.add("moved"):a.add("resized");})),a}function uD(t,e){const i=Ns(t),s={style:i,flags:[],transform:{}},{lineEnding:n,points:o,textContents:r,stamp:a,borderWidth:l,x:h,y:c,width:d,height:u,startPoint:p,endPoint:g,lineDash:f,rects:v}=i||{},m=Bo.dataResolution,y=Bo.displayResolution,x=["ink","line","polygon","polyline","highlight","underline","strikeout"].includes(e);if(v&&(s.style.lines=wD(v,m,y,"date")),o&&("ink"===e?s.style.segments=xD(o,m,y):s.style.points=yD(o,m,y)),n&&(s.style.lineEnding=gD(n,"date")),a&&(s.style.imageData=null,a instanceof Blob||Xs(a)&&jR(a)?s.style.imageData=a:Xs(a)?s.style.iconName=fD(a,"date"):hE(a)&&(s.style.stampConfig=a)),_s(l)||(s.style.borderWidth=Gn(l,m,y)),_s(h)||(x?delete s.style.x:s.style.x=Gn(h,m,y)),_s(c)||(x?delete s.style.y:s.style.y=Gn(c,m,y)),_s(d)||(s.style.width=Gn(d,m,y)),_s(u)||(s.style.height=Gn(u,m,y)),_s(f)||(s.style.lineDash=Gn(f,m,y)),_s(p)||(s.style.startPoint=Gn(p,m,y)),_s(g)||(s.style.endPoint=Gn(g,m,y)),r){const t=[];r.forEach((e=>{null!=e&&e.fontSize&&(e.fontSize=Gn(e.fontSize,m,y)),Xs(e.fontFamily)&&""===(null==e?void 0:e.fontFamily.trim())&&(e.fontFamily="Helvetica"),t.push({...Ek,...e});})),s.style.textContents=t;}return js(t.rotation)&&(s.transform.angle=t.rotation),t.flags&&(t.flags.print&&s.flags.push("print"),t.flags.noView&&s.flags.push("noView"),t.flags.readOnly&&s.flags.push("readOnly"),t.flags.noResize&&s.flags.push("noResize"),t.flags.noRotate&&s.flags.push("noRotate"),t.flags.noMove&&s.flags.push("noMove")),s}function pD(t,e){var i,s,n,o,r,a,l,h,c,d,u;const{lineEnding:p,iconName:g,imageData:f,segments:v,textContents:m,borderWidth:y,x:x,y:w,width:b,height:S,startPoint:C,endPoint:P,lineDash:T,points:A,stampConfig:k,lines:D}=(null==t?void 0:t.style)||{},R=Bo.displayResolution,E=Bo.dataResolution;if(D&&(t.style.rects=wD(D,R,E,"user")),A&&(t.style.points=yD(A,R,E)),v&&"ink"===e&&(t.style.points=xD(v,R,E),delete t.style.segments),p&&(t.style.lineEnding=gD(p,"user")),(f||g||k)&&(t.style.stamp=f||fD(g,"user")||Ns(k),delete t.style.iconName,delete t.style.imageData,delete t.style.stampConfig),_s(y)||(t.style.borderWidth=Gn(y,R,E)),_s(x)||(t.style.x=Gn(x,R,E)),_s(w)||(t.style.y=Gn(w,R,E)),_s(b)||(t.style.width=Gn(b,R,E)),_s(S)||(t.style.height=Gn(S,R,E)),_s(C)||(t.style.startPoint=Gn(C,R,E)),_s(P)||(t.style.endPoint=Gn(P,R,E)),_s(T)||(t.style.lineDash=Gn(T,R,E)),m){const e=[];m.forEach((t=>{null!=t&&t.fontSize&&(t.fontSize=Gn(t.fontSize,R,E)),Xs(t.fontFamily)&&""===(null==t?void 0:t.fontFamily.trim())&&(t.fontFamily="Helvetica"),e.push({...Ek,...t});})),t.style.textContents=e;}return null===(i=t.style)||void 0===i||delete i.lineJoin,null===(s=t.style)||void 0===s||delete s.lineCap,null===(n=t.style)||void 0===n||delete n.miterLimit,{...t.style,rotation:null!==(o=null===(r=t.transform)||void 0===r?void 0:r.angle)&&void 0!==o?o:void 0,flags:{print:!(null===(a=t.flags)||void 0===a||!a.includes("print")),noView:!(null===(l=t.flags)||void 0===l||!l.includes("noView")),readOnly:!(null===(h=t.flags)||void 0===h||!h.includes("readOnly")),noResize:!(null===(c=t.flags)||void 0===c||!c.includes("noResize")),noRotate:!(null===(d=t.flags)||void 0===d||!d.includes("noRotate")),noMove:!(null===(u=t.flags)||void 0===u||!u.includes("noMove"))}}}function gD(t,e){const i={None:Pk.NONE,OpenArrow:Pk.OPEN,ROpenArrow:Pk.OPEN_REVERSE,ClosedArrow:Pk.CLOSED,RClosedArrow:Pk.CLOSED_REVERSE,Butt:Pk.BUTT,Slash:Pk.SLASH,Square:Pk.SQUARE,Diamond:Pk.DIAMOND,Circle:Pk.CIRCLE};if("user"===e){const[e,s]=t;return {start:i[e],end:i[s]}}return [sE(i,t.start)[0]||"None",sE(i,t.end)[0]||"None"]}function fD(t,e){const i={[Ck.REJECTED]:rh.REJECTED,[Ck.ACCEPTED]:rh.ACCEPTED,[Ck.INITIAL_HERE]:rh.INITIAL_HERE,[Ck.SIGN_HERE]:rh.SIGN_HERE,[Ck.WITNESS]:rh.WITNESS,[Ck.APPROVED]:rh.APPROVED,[Ck.NOT_APPROVED]:rh.NOT_APPROVED,[Ck.DRAFT]:rh.DRAFT,[Ck.FINAL]:rh.FINAL,[Ck.COMPLETED]:rh.COMPLETED,[Ck.CONFIDENTIAL]:rh.CONFIDENTIAL,[Ck.VOID]:rh.VOID};return "user"===e?sE(i,t)[0]||t:i[t]||rh.DRAFT}function vD(t,e){const i=["opacity","flags"],s=["x","y","width","height"],n=["borderColor","borderWidth","lineDash"],o=[...i,...n,...s,"background","rotation"],r=["points","background",...n,...i],a=["rects","opacity"],l={rectangle:o,ellipse:o,polygon:r,polyline:["lineEnding",...r],stamp:["stamp",...s,...i,"rotation"],ink:["points","borderWidth","borderColor","rotation",...i],line:["startPoint","endPoint","lineEnding","background",...n,...i],textBox:["textContents","textAlign","background","rotation",...i,...n,...s],textTypewriter:["x","y","textContents",...i],highlight:[...a,...i,"background"],underline:[...a,...i,"borderColor"],strikeout:[...a,...i,"borderColor"]}[t];if(!l)return e;const h={};for(const i in e)if(l.includes(i)){let s=e[i];"rects"===i?h[i]=s.map((t=>({x:jn(t.x,2),y:jn(t.y,2),width:jn(t.width,2),height:jn(t.height,2)}))):"points"!==i||"ink"!==t&&"polygon"!==t&&"polyline"!==t?"startPoint"!==i&&"endPoint"!==i||"line"!==t?"borderColor"===i||"background"===i?h[i]=mD(s,2):"opacity"===i?(s>1&&(s=1),s<0&&(s=0),h[i]=jn(s,2)):"textContents"===i?h[i]=s.map((t=>(void 0!==t.color&&(t.color=mD(t.color,2)),void 0!==t.fontSize&&(t.fontSize=jn(t.fontSize,2)),t))):"lineDash"===i?h[i]=s.map((t=>jn(t,2))):js(e[i])?h[i]=jn(s,2):h[i]=s:h[i]={x:jn(s.x,2),y:jn(s.y,2)}:Ls(s[0])?h[i]=s.map((t=>t.map((t=>({x:jn(t.x,2),y:jn(t.y,2)}))))):h[i]=s.map((t=>({x:jn(t.x,2),y:jn(t.y,2)})));}return h}function mD(t,e){if(t&&t.startsWith("rgb")){const i=/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+)\s*)?\)/,s=t.match(i);if(s){const t=parseInt(s[1],10),i=parseInt(s[2],10),n=parseInt(s[3],10);let o=void 0!==s[4]?parseFloat(s[4]):void 0;if(void 0!==o){o<0&&(o=0),o>1&&(o=1);const s=function(t,e){const i=t.toString();if(/^\d+\.\d{3,}$/.test(i))return parseFloat(t.toFixed(e));return t}(o,e);return `rgba(${t},${i},${n},${s})`}return `rgb(${t},${i},${n})`}}return t}function yD(t,e,i){return t.map((t=>({x:Gn(t.x,e,i),y:Gn(t.y,e,i)})))}function xD(t,e,i){return t.map((t=>t.map((t=>({x:Gn(t.x,e,i),y:Gn(t.y,e,i)})))))}function wD(t,e,i,s){return "date"===s?t.map((t=>({left:Gn(t.x,e,i),top:Gn(t.y,e,i),width:Gn(t.width,e,i),height:Gn(t.height,e,i)}))):t.map((t=>({x:Gn(t.left,e,i),y:Gn(t.top,e,i),width:Gn(t.width,e,i),height:Gn(t.height,e,i)})))}const bD={...lD,x:10,y:10,width:100,height:100};class SD extends cD{constructor(t){super(t=Nn(t||{},Ns(bD)));}get type(){return "rectangle"}}const CD={...lD,x:10,y:10,width:100,height:80};class PD extends cD{constructor(t){super(t=Nn(t||{},Ns(CD)));}get type(){return "ellipse"}}const TD={...lD,points:[[{x:10,y:10},{x:110,y:80}],[{x:110,y:10},{x:10,y:80}]]};class AD extends cD{constructor(t){super(t=Nn(t||{},Ns(TD)));}get type(){return "ink"}}const kD={...lD,startPoint:{x:10,y:10},endPoint:{x:110,y:80},lineEnding:{start:Pk.NONE,end:Pk.NONE},flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class DD extends cD{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super(t=Nn(i||{},Ns(kD)));}get type(){return "line"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super.updateOptions(i)}}const RD={...lD,points:[{x:60,y:10},{x:10,y:55},{x:30,y:110},{x:90,y:110},{x:110,y:55}],flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class ED extends cD{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super(t=Nn(i||{},Ns(RD)));}get type(){return "polygon"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super.updateOptions(i)}}const MD={...lD,points:[{x:10,y:40},{x:50,y:80},{x:110,y:10}],lineEnding:{start:Pk.NONE,end:Pk.NONE},flags:{print:!0,noView:!1,readOnly:!1,noRotate:!0}};class ID extends cD{constructor(t){var e;let i=t;!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super(t=Nn(i||{},Ns(MD)));}get type(){return "polyline"}updateOptions(t){var e;let i=t;return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(i=Ns(t),i.flags.noRotate=!0),super.updateOptions(i)}}async function BD(t,e,i,s,n){const o=[`${n}.${s} is invalid`];let r=!1;if(Hs(t)){const e=await Fn(t);["image/bmp","image/jpeg","image/png"].includes(e)||(r=!0);}else r=!0;return !r||Ru.output(e,i,n,o)}const UD={x:10,y:10,stamp:Ck.DRAFT,width:void 0,height:void 0,opacity:1,flags:{print:!0,noView:!1,readOnly:!1},rotation:0},LD={[Ck.REJECTED]:[23.58,23.54],[Ck.ACCEPTED]:[28.39,24.6],[Ck.INITIAL_HERE]:[126.26,33.78],[Ck.SIGN_HERE]:[126.26,33.78],[Ck.WITNESS]:[126.26,33.78],[Ck.APPROVED]:[211.33,59.33],[Ck.NOT_APPROVED]:[284.83,59.33],[Ck.DRAFT]:[144.19,59.66],[Ck.FINAL]:[123.73,59.66],[Ck.COMPLETED]:[227.83,59.33],[Ck.CONFIDENTIAL]:[272.83,59.33],[Ck.VOID]:[114.71,59.66]};var OD=new WeakMap;class ND{constructor(t){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),f(this,OD,{writable:!0,value:void 0}),t=Nn(t||{},Ns(UD)),!Xs(t.stamp)||!LD[t.stamp]||js(t.width)&&js(t.height)||(t.width=t.width||LD[t.stamp][0],t.height=t.height||LD[t.stamp][1]),n(this,OD,t),this.uid=qs(),this.creationDate=Jf(),this.modificationDate=this.creationDate;}get source(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "stamp"}get pageUid(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(uk(t,1,e,"options"))return;if(!$k(t,e,"options",1))return;GT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?GT.annotationService.flattenAnnotations([this.uid]):GT.annotationService.unFlattenAnnotation(this.uid));}getOptions(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);if(t){const e=t.getConfig(),i=pD(e,this.type);n(this,OD,{...i}),this.modificationDate=e.comment.modificationDate;}return vD(this.type,s(this,OD))}async updateOptions(t){const e="Annotation.updateOptions";if(uk(t,0,e,"options"))return;if(!pk(t,0,e,"options"))return;if(!aD(t,0,e,"options",this.type))return;if(Hs(t.stamp)&&!await BD(t.stamp,0,e,"stamp","options"))return;const i=this.getOptions(),n=dD(this.type,t,i);if(!n.size)return;this.getOptions(),Nn(t,s(this,OD)),t.flags={...s(this,OD).flags,...t.flags||{}};let o=t;o={x:s(this,OD).x,y:s(this,OD).y,width:s(this,OD).width,height:s(this,OD).height,...o},null!=t&&t.stamp||(o={...o,stamp:null});const r=uD(o,this.type);r.style={...i,...r.style},GT.annotationService.updateAnnotations([{annotationUid:this.uid,options:r}],void 0,[...n]);}}const _D={...lD,x:10,y:10,width:150,height:80,textAlign:"left",textContents:[{content:"Insert text here"}]};class WD extends cD{constructor(t){super(t=Nn(t||{},Ns(_D)));}get type(){return "textBox"}}const FD={x:10,y:10,textContents:[{content:"Insert text here"}],opacity:1,author:"",subject:"",flags:{print:!0,noView:!1,readOnly:!1,noResize:!0,noRotate:!0}};class HD extends cD{constructor(t){var e,i;const s=Ns(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noResize)&&(s.flags.noResize=!0),super(t=Nn(s||{},Ns(FD)));}get type(){return "textTypewriter"}updateOptions(t){var e,i;const s=Ns(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noResize)&&(s.flags.noResize=!0),super.updateOptions(s)}}function VD(t,e,i,s,n,o){const r=Ru.formatError({isValid:Ls(t)});if(r)return Ru.output(e,i,s,void 0,r);const a=[];return t.forEach(((t,e)=>{const i=Ru.formatDetails(Du("Array",n,`[${e}]`,!0),Ru.isStringAndNotEmpty(t,o));a.push(...i);})),!a.length||Ru.output(e,i,s,a)}function zD(t,e,i,s,n){const o=[];return e.forEach(((e,i)=>{t.has(e)||o.push(`annotationUids[${i}]: The specified annotation(s) do not exist.`);})),!o.length||Ru.output(i,s,n,o,ku.ANNOTATION_NOT_EXIST)}function $D(t,e,i,s,n){return !!t.has(e)||Ru.output(i,s,n,void 0,ku.ANNOTATION_NOT_EXIST)}class jD{constructor(){i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),this.uid=qs(),this.creationDate=Jf(),this.modificationDate=Jf();}get source(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "unknown"}get pageUid(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get flattened(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(uk(t,1,e,"options"))return;if(!$k(t,e,"options",1))return;GT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?GT.annotationService.flattenAnnotations([this.uid]):GT.annotationService.unFlattenAnnotation(this.uid));}}var XD=new WeakMap;class GD{constructor(t){f(this,XD,{writable:!0,value:void 0}),i(this,"uid",null),i(this,"creationDate",""),i(this,"modificationDate",""),this.uid=qs(),this.creationDate=Jf(),this.modificationDate=Jf(),n(this,XD,t);}get source(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.source:""}get type(){return "incomplete"}get pageUid(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return t?t.pageUid:""}get raw(){return s(this,XD)}get flattened(){const t=GT.annotationService.annotationApp.getAnnotationByUid(this.uid);return !!t&&t.flattened}set flattened(t){const e="Annotation.flattened";if(uk(t,1,e,"options"))return;if(!$k(t,e,"options",1))return;GT.annotationService.annotationApp.getAnnotationByUid(this.uid).flattened!==t&&(t?GT.annotationService.flattenAnnotations([this.uid]):GT.annotationService.unFlattenAnnotation(this.uid));}}const YD={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],background:"#FD7C10",opacity:1};class qD extends cD{constructor(t){var e,i;const s=Ns(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super(t=Nn(s||{},Ns(YD)));}get type(){return "highlight"}updateOptions(t){var e,i;const s=Ns(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super.updateOptions(s)}}const JD={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],borderColor:"#0E68F5",opacity:1};class ZD extends cD{constructor(t){var e,i;const s=Ns(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super(t=Nn(s||{},Ns(JD)));}get type(){return "underline"}updateOptions(t){var e,i;const s=Ns(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super.updateOptions(s)}}const QD={flags:{print:!0,noView:!1,readOnly:!1,noMove:!0,noRotate:!0},rects:[{x:10,y:10,width:100,height:100}],borderColor:"#F01314",opacity:1};class KD extends cD{constructor(t){var e,i;const s=Ns(t);!1===(null===(e=t)||void 0===e||null===(e=e.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null===(i=t)||void 0===i||null===(i=i.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super(t=Nn(s||{},Ns(QD)));}get type(){return "strikeout"}updateOptions(t){var e,i;const s=Ns(t);return !1===(null==t||null===(e=t.flags)||void 0===e?void 0:e.noRotate)&&(s.flags.noRotate=!0),!1===(null==t||null===(i=t.flags)||void 0===i?void 0:i.noMove)&&(s.flags.noMove=!0),super.updateOptions(s)}}const tR=["annotationsAdded","annotationsDeleted","annotationsModified","annotationLayerChanged"],eR="AnnotationManager",iR=new Map;var sR=new WeakMap,nR=new WeakMap,oR=new WeakMap,rR=new WeakSet,aR=new WeakSet;function lR(t,e){switch(t){case"rectangle":return new SD(e);case"ellipse":return new PD(e);case"polygon":return new ED(e);case"polyline":return new ID(e);case"line":return new DD(e);case"stamp":return new ND(e);case"ink":return new AD(e);case"textBox":return new WD(e);case"textTypewriter":return new HD(e);case"unknown":return new jD;case"highlight":return new qD(e);case"underline":return new ZD(e);case"strikeout":return new KD(e);case"incomplete":return new GD((null==e?void 0:e.annotationRaw)||{});default:return null}}function hR(t,e){s(this,oR).emit(t,e);}const cR=new class{constructor(){v(this,aR),v(this,rR),f(this,sR,{writable:!0,value:void 0}),f(this,nR,{writable:!0,value:void 0}),f(this,oR,{writable:!0,value:void 0}),n(this,sR,GT),n(this,nR,iR),n(this,oR,new Qs);const t=s(this,sR).annotationService.annotationApp.hooks;t.annotationCreated.on((t=>{const e=t.annotations.reduce(((t,e)=>{if(!s(this,nR).has(e.uid)){const t=e.getConfig(),i=pD(t),n=p(this,rR,lR).call(this,t.type,i);n&&(n.uid=t.uid,n.creationDate=t.comment.creationDate,n.modificationDate=t.comment.modificationDate,s(this,nR).set(t.uid,n));}return t.push(e.uid),t}),[]);p(this,aR,hR).call(this,"annotationsAdded",{annotationUids:e});})),t.annotationDeleted.on((t=>{t.annotations.forEach((t=>{if(s(this,nR).has(t.uid)){this.getAnnotationsByUids([t.uid])[0].modificationDate="",s(this,nR).delete(t.uid);}}));const e=t.annotations.map((t=>t.uid));t.emitEvent&&p(this,aR,hR).call(this,"annotationsDeleted",{annotationUids:e});})),t.annotationUpdated.on((t=>{const e={modifiedAnnotations:t.updateDetails.map((t=>{const e=this.getAnnotationsByUids([t.annotationUid])[0],i=e.type,s=GT.annotationService.annotationApp.getAnnotationByUid(e.uid);return e.modificationDate=s.comment.modificationDate,{uid:t.annotationUid,oldOptions:vD(i,pD(Ns(t.from.all),i)),newOptions:vD(i,pD(Ns(t.to.all),i))}})),actions:[...t.updateActions]};s(this,oR).hasCallback("annotationsModified")&&(e.actions.includes("flattenedChanged")||p(this,aR,hR).call(this,"annotationsModified",e));}));const e=(t,e)=>{s(this,sR).annotationService.enableEmitLayerChanged&&p(this,aR,hR).call(this,"annotationLayerChanged",{oldAnnotationUidList:[...t.from],newAnnotationUidList:[...t.to]});};t.bringFroward.on((t=>{e(t);})),t.bringToFront.on((t=>{e(t);})),t.sendBackward.on((t=>{e(t);})),t.sendToBack.on((t=>{e(t);}));}createAnnotation(t,e,i){const n="AnnotationManager.createAnnotation",o="pageUid",r="type",a="annotationOptions";let l=null;try{Ap.makeSureCoreLicenseExist(),Ap.makeSureAnnotationLicenseExist(),uk(t,0,n,o),uk(e,0,n,r),Hk(t,0,n,o,!1),function(t,e,i,s){Xs(t)?!!["rectangle","ellipse","polygon","polyline","line","stamp","ink","textBox","textTypewriter","highlight","underline","strikeout"].includes(t)||Ru.output(e,i,s,void 0,ku.PARAM_NOT_SUPPORT):Ru.output(e,i,s,void 0,ku.PARAM_INVALID);}(e,0,n,r),l=s(this,sR).pageService.getPage(t),l||Ru.error(n,o,void 0,ku.PAGE_NOT_EXIST),_s(i)||(pk(i,0,n,a),aD(i,0,n,a,e));}catch(t){if("stamp"===e)return Promise.reject(t);throw t}const h=Ns(i||{}),c=()=>{var i,n,o;const r=p(this,rR,lR).call(this,e,h);s(this,nR).set(r.uid,r);const a=s(this,sR).pageService.getPage(t).doc.uid,c=uD(r.getOptions(),e);if("textTypewriter"===e){const t=l.mediaBox.width,e=l.mediaBox.width-c.style.x;c.style.width=e<0?t:e;}if("underline"===e||"strikeout"===e){var d;const t=Am(null==c||null===(d=c.style)||void 0===d?void 0:d.lines)||1;c.style.borderWidth=t;}const u={uid:r.uid,docUid:a,pageUid:t,type:e,style:c.style,transform:c.transform,flags:c.flags,source:"api",comment:{annotationUid:r.uid,author:(null===(i=c.comment)||void 0===i?void 0:i.author)||"",subject:(null===(n=c.comment)||void 0===n?void 0:n.subject)||"",contents:(null===(o=c.comment)||void 0===o?void 0:o.contents)||"",creationDate:r.creationDate,modificationDate:r.creationDate,markedStates:[],reviewStates:[],replies:[]}};return s(this,sR).annotationService.createAnnotation(a,u),r};if("stamp"===e&&Hs(null==h?void 0:h.stamp)){const t=h;return new Promise((async(e,i)=>{try{await BD(t.stamp,0,n,"stamp",a);}catch(t){return void i(t)}if(!js(t.width)||!js(t.height)){const e=new bo,s=await e.readImageInfo({fileSource:t.stamp}).catch((t=>{i(t);}));let n=s.imageWidth,o=s.imageHeight;if(n>400||o>400){const t=Math.max(n/400,o/400);n/=t,o/=t;}t.width=n,t.height=o;}e(c());}))}return c()}deleteAnnotations(t){const e=`${eR}.deleteAnnotations`,i="annotationUids";return !(uk(t,1,e,i)||!VD(t,1,e,i,void 0,!1)||!zD(s(this,nR),t,1,e,i))&&(s(this,sR).annotationService.deleteAnnotations(t),!0)}getAnnotationsByUids(t){const e=`${eR}.getAnnotationsByUids`,i="annotationUids";return !uk(t,1,e,i)&&VD(t,1,e,i,void 0,!1)&&zD(s(this,nR),t,1,e,i)?t.map((t=>s(this,nR).get(t))):[]}getAnnotationsByPage(t){const e=`${eR}.getAnnotationsByPage`,i="pageUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1))return [];if(!s(this,sR).pageService.getPage(t))return Ru.warning(e,i,void 0,ku.PAGE_NOT_EXIST),[];const n=s(this,sR).annotationService.getAnnotationUidsByLayer(t),o=[];return n.forEach((t=>{const e=s(this,nR).get(t);e&&o.push(e);})),o}getAnnotationsByDoc(t){const e=`${eR}.getAnnotationsByDoc`,i="docUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1))return [];const n=s(this,sR).documentService.getDocument(t);if(!n)return Ru.warning(e,i,void 0,ku.DOC_NOT_EXIST),[];return n.pages.reduce(((t,e)=>(s(this,sR).annotationService.getAnnotationUidsByLayer(e).forEach((e=>{const i=s(this,nR).get(e);i&&t.push(i);})),t)),[])}bringAnnotationForward(t){const e=`${eR}.bringAnnotationForward`,i="annotationUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1)||!$D(s(this,nR),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return s(this,sR).annotationService.bringForward(t)}sendAnnotationBackward(t){const e=`${eR}.sendAnnotationBackward`,i="annotationUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1)||!$D(s(this,nR),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return s(this,sR).annotationService.sendBackward(t)}bringAnnotationToFront(t){const e=`${eR}.bringAnnotationToFront`,i="annotationUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1)||!$D(s(this,nR),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return s(this,sR).annotationService.bringToFront(t)}sendAnnotationToBack(t){const e=`${eR}.sendAnnotationToBack`,i="annotationUid";if(uk(t,1,e,i)||!Hk(t,1,e,i,!1)||!$D(s(this,nR),t,1,e,i))return !1;if(this.getAnnotationsByUids([t])[0].flattened)return !0;return s(this,sR).annotationService.sendToBack(t)}on(t,e){const i="AnnotationManager.on",n="eventName",o="listener";!uk(t,1,i,n)&&!uk(e,1,i,o)&&Hk(t,1,i,n,!1)&&Fk(e,i,o,1)&&(tR.includes(t)?s(this,oR).on(t,e):ku.warning(ku.PARAM_NOT_SUPPORT,i,n));}off(t,e){const i="AnnotationManager.off",n="eventName";!uk(t,1,i,n)&&Hk(t,1,i,n,!1)&&(_s(e)||Fk(e,i,"listener",1))&&(tR.includes(t)?s(this,oR).off(t,e):ku.warning(ku.PARAM_NOT_SUPPORT,i,n));}};function dR(t,e,i,s,n,o){const r=[];let a=!1;if(n.length)n.forEach(((t,e)=>{const{width:n,height:o}=i.getRealPtPageSize(t);iE(s,n,o)||r.push(`indices[${t}]: ${ku.RECT_EXCEED_PAGE_BOUND.message}`);})),r.length>0&&(a=!0);else {const{width:t,height:e}=i.getRealPtPageSize();iE(s,t,e)||(a=!0);}return !!a&&Ru.output(o,t,e,r.length?r:void 0,ku.RECT_EXCEED_PAGE_BOUND,!0)}function uR(t,e,i,s){const n=dE.isRectValid(t);return !!n.length&&Ru.output(s,e,i,n,void 0,!0)}const pR=["canvasStyle","pageStyle","quadSelectionStyle","currentPageStyle","annotationSelectionStyle","cursorStyle"],gR="EditViewer";var fR=new WeakMap,vR=new WeakMap,mR=new WeakMap,yR=new WeakSet,xR=new WeakSet,wR=new WeakSet,bR=new WeakSet;class SR{constructor(t){var e,o,r,a,l,h;v(this,bR),v(this,wR),v(this,xR),v(this,yR),f(this,fR,{writable:!0,value:void 0}),f(this,vR,{writable:!0,value:!0}),f(this,mR,{writable:!0,value:new zk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),i(this,"thumbnail",void 0);Ap.makeSureCoreLicenseExist(),_s(t)||Xk(t,"editViewer",0,"new EditViewer","option");const c=cE(null==t?void 0:t.keyboardInteractionConfig);!1===(null==t||null===(e=t.viewerConfig)||void 0===e?void 0:e.enableMagnifier)&&(t.viewerConfig.enableTextMagnifier=!1);const d=Nn((null==t?void 0:t.viewerConfig)||{},Ns({...iD,viewerMode:lg.DEFAULT,displayMode:"continuous",enablePopup:!0,enableOptimizePage:!0}));if(d.minZoom>d.maxZoom){ku.warning(ku.MIN_ZOOM_INVALID);const t=d.maxZoom;d.maxZoom=d.minZoom,d.minZoom=t;}const{maxZoom:u,minZoom:g}=d;d.maxZoom=u>64||u<.01?64:u,d.minZoom=g>64||g<.01?.01:g,$s()&&(Ik.toolbarConfig.style={scale:"0.9"}),n(this,fR,GT.createViewer({uiConfig:Ns($s()?vk:wk),...t,viewerConfig:{...d,...c},popupConfig:{annotationToolBarConfig:{...null==Ik?void 0:Ik.toolbarConfig,...null==t||null===(o=t.annotationConfig)||void 0===o?void 0:o.toolbarConfig},annotationPaletteConfig:{...Ik.paletteConfig,...null==t||null===(r=t.annotationConfig)||void 0===r?void 0:r.paletteConfig},annotationCustomStampPanelConfig:{...null==t||null===(a=t.annotationConfig)||void 0===a?void 0:a.customStampPanelConfig},passwordLoaderConfig:{enabled:null===(l=null==t||null===(h=t.viewerConfig)||void 0===h?void 0:h.enablePasswordLoader)||void 0===l||l}}})),this.uid=s(this,fR).uid,this.groupUid=s(this,fR).groupUid,this.postfix=s(this,fR).postfix;const m=Nn(Ns(null==t?void 0:t.annotationConfig)||{},Ns(Ik));s(this,fR).updateAnnotationConfig(KR(m)),ZR(s(this,fR).getUiConfig()).includes(gk.Filter)&&!s(this,fR).context.core.filterService.enableFilter&&ku.warning(ku.IMG_FILTER_MISS),t&&!1===t.createThumbnail||p(this,wR,TR).call(this,null==t?void 0:t.thumbnailConfig,c),t&&!_s(null==t?void 0:t.adaptiveIconSize)&&n(this,vR,t.adaptiveIconSize),s(this,fR).rootDom&&(s(this,fR).rootDom.style.fontSize="20px",$R(this,s(this,fR).rootDom,s(this,vR))),UE.forEach((t=>{s(this,fR).addFontToUi(t);})),p(this,bR,AR).call(this),p(this,xR,PR).call(this),p(this,yR,CR).call(this);}get isVisible(){return s(this,mR).getIsVisible(s(this,fR))}get isBoundContainer(){return s(this,mR).getIsBoundContainer(s(this,fR))}get currentDocument(){return s(this,mR).getCurrentDocument(s(this,fR))}get zoom(){return parseFloat(s(this,fR).getViewerConfig().zoom.toFixed(4))}set zoom(t){const{maxZoom:e,minZoom:i}=s(this,fR).getViewerConfig();(function(t,e,i,s,n,o){const r=Ru.formatError(Ru.isNumberAndIsInRange(t));return r?Ru.output(e,i,s,void 0,r):(t<n&&Ru.output(e,i,s,void 0,ku.ZOOM_TOO_SMALL),t>o&&Ru.output(e,i,s,void 0,ku.ZOOM_TOO_LARGE),!0)})(t,1,`${gR}.zoom`,"zoom",i,e)&&s(this,fR).updateViewerConfig({zoom:t});}get zoomOrigin(){return s(this,fR).getViewerConfig().zoomOrigin}set zoomOrigin(t){(function(t,e,i,s){const n=dE.isZoomOriginValid(t);return !n.length||Ru.output(s,e,i,n)})(t,`${gR}.zoomOrigin`,"zoomOrigin",1)&&s(this,fR).updateViewerConfig({zoomOrigin:{x:t.x,y:t.y}});}get displayMode(){const{displayMode:t}=s(this,fR).getViewerConfig(),e=s(this,fR).getActiveTab();return e?e.context.displayMode:t}set displayMode(t){const e="displayMode",i=`${gR}.${e}`;Hk(t,1,i,e)&&(["single","continuous"].includes(t)?s(this,fR).updateViewerConfig({displayMode:t}):ku.warning(ku.PARAM_NOT_SUPPORT,i,e));}get toolMode(){const{toolMode:t}=s(this,fR).getViewerConfig();return t}set toolMode(t){const e="toolMode",i=`${gR}.${e}`;Hk(t,1,i,e)&&function(t,e,i,s){return !!["crop","pan","annotation","textSelection"].includes(t)||Ru.output(e,i,s,void 0,ku.PARAM_NOT_SUPPORT)}(t,1,i,e)&&s(this,fR).updateViewerConfig({toolMode:t});}get annotationMode(){const{annotationMode:t}=s(this,fR).getViewerConfig();return t}set annotationMode(t){const e="annotationMode",i=`${gR}.${e}`;Hk(t,1,i,e)&&function(t,e,i,s){return !!["rectangle","ellipse","line","polygon","polyline","ink","textBox","textTypewriter","stamp","erase","select","highlight","underline","strikeout"].includes(t)||Ru.output(e,i,s,void 0,ku.PARAM_NOT_SUPPORT)}(t,1,i,e)&&s(this,fR).updateViewerConfig({annotationMode:t});}get fitMode(){const{fitMode:t}=s(this,fR).getViewerConfig(),e=s(this,fR).getActiveTab();return e?e.context.fitMode:t}set fitMode(t){const e=`${gR}.fitMode`,i="fitMode";Hk(t,1,e,i)&&function(t,e,i,s){return !!["width","height","window","actualSize"].includes(t)||Ru.output(e,i,s,void 0,ku.PARAM_NOT_SUPPORT)}(t,1,e,i)&&s(this,fR).updateViewerConfig({fitMode:t});}get cropMode(){return s(this,fR).cropMode}set cropMode(t){const e=`${gR}.cropMode`,i="cropMode";Hk(t,1,e,i)&&function(t,e,i,s){return !!["all","current"].includes(t)||Ru.output(e,i,s,void 0,ku.PARAM_NOT_SUPPORT)}(t,1,e,i)&&(s(this,fR).cropMode=t);}bindContainer(t){s(this,mR).bindContainer(s(this,fR),t,`${gR}.bindContainer`);}unbindContainer(){s(this,mR).unbindContainer(s(this,fR));}show(){s(this,mR).show(s(this,fR)),$R(this,s(this,fR).rootDom,s(this,vR));}hide(){s(this,mR).hide(s(this,fR));}getUiConfig(){return s(this,mR).getUiConfig(s(this,fR))}updateUiConfig(t){s(this,fR).selectAnnotations([]);return !!s(this,mR).updateUiConfig(s(this,fR),t,"editViewer",`${gR}.updateUiConfig`)&&(s(this,fR).emit("thumbnailBind",this.thumbnail.uid),$R(this,s(this,fR).rootDom,s(this,vR)),!0)}openDocument(t){s(this,mR).openDocument(t,this.uid,`${gR}.openDocument`);}closeDocument(){return s(this,mR).closeDocument(s(this,fR),`${gR}.closeDocument`)}getStyle(t){return s(this,mR).getStyle(s(this,fR),"edit",t,pR,`${gR}.getStyle`)}updateStyle(t,e){const i=`${gR}.updateStyle`;return s(this,mR).updateStyle(s(this,fR),t,e,pR,i)}setParallelScrollCount(t){const e=`${gR}.setParallelScrollCount`,i="count",{maxColumns:n,maxRows:o}=s(this,fR).getViewerConfig();return !(uk(t,1,e,i)||!Ok(t,e,i,1)||_k(t,1,o,1,e,i)||_k(t,1,n,1,e,i))&&("continuous"!==this.displayMode?(ku.warning(ku.ROW_COLUMN_CAN_NOT_CHANGE,e),!1):s(this,fR).setRowAndColumn(t,t))}setCropRect(t){const e=`${gR}.setCropRect`,i="rect";if(uk(t,1,e,i)||uR(t,e,i,1)||!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return !1;const n="current"===this.cropMode?[s(this,fR).getCurrentPageIndex()]:s(this,fR).getMatchedCropBoxIndices(t);return !dR(e,i,s(this,fR),t,n,1)&&("crop"!==this.toolMode?(ku.warning(ku.TOOL_MODE_NOT_AVAILABLE,e),!1):s(this,fR).setRectBox(t))}getCropRect(){return Uk(s(this,fR),1)?s(this,fR).getRectBox():null}crop(t,e){const i=`${gR}.crop`,n=s(this,fR).getPageCounts(),o="rect";if(uk(t,1,i,o)||uR(t,i,o,1)||!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return !1;let r;if(e&&e.length>0){if(!Vk(e,1,i,"indices",0,n-1))return !1;r=e;}else r="current"===this.cropMode?[s(this,fR).getCurrentPageIndex()]:s(this,fR).getMatchedCropBoxIndices(t);return !dR(i,o,s(this,fR),t,r,1)&&s(this,fR).cropPages(t,r)}rotate(t,e){const i=`${gR}.rotate`;return s(this,mR).rotate(s(this,fR),t,e,i)}undo(){if(!Uk(s(this,fR),1))return !1;const t=s(this,fR).undo();return t||ku.warning(ku.UNDO_NOOP),t}redo(){if(!Uk(s(this,fR),1))return !1;const t=s(this,fR).redo();return t||ku.warning(ku.REDO_NOOP),t}saveOperations(){return s(this,mR).saveOperation(s(this,fR))}indexToUid(t){const e=`${gR}.indexToUid`;return s(this,mR).indexToUid(s(this,fR),t,e)}uidToIndex(t){const e=`${gR}.uidToIndex`;return s(this,mR).uidToIndex(s(this,fR),t,e)}getCurrentPageUid(){return s(this,mR).getCurrentPageUid(s(this,fR))}getCurrentPageIndex(){return s(this,mR).getCurrentPageIndex(s(this,fR))}getPageCount(){return s(this,mR).getPageCount(s(this,fR))}goToPage(t){const e=`${gR}.goToPage`;return s(this,mR).gotoPage(s(this,fR),t,e)}selectAnnotations(t){const e=`${gR}.selectAnnotations`,i="annotationUids";if(!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1)||uk(t,1,e,i)||!VD(t,1,e,i,void 0,!1))return !1;if(["textSelection","crop"].includes(this.toolMode))return ku.warning(ku.TOOL_MODE_NOT_AVAILABLE,e),!1;t=[...new Set(t)];const n=[],o=[],r=[],a=[],l=this.getCurrentPageUid(),h=t.reduce(((t,e,s)=>{const h=GT.annotationService.getAnnotationByUid(e);return h?h.pageUid!==l?n.push(`${i}[${s}]: The specified annotation is not on the current page.`):"incomplete"===h.type||"unknown"===h.type?o.push(`${i}[${s}]: ${ku.UNSELECTED_UNKNOWN.message}`):h.flags.includes("readOnly")||h.flags.includes("noView")?r.push(`${i}[${s}]: ${ku.UNSELECTED_READONLY.message}`):h.flattened?a.push(`${i}[${s}]: ${ku.UNSELECTED_FLATTENED.message}`):t.push(e):n.push(`${i}[${s}]: The specified annotation does not exist.`),t}),[]),c=[{result:n,exceptionType:ku.ANNOTATION_SELECT},{result:o,exceptionType:ku.UNSELECTED_UNKNOWN},{result:r,exceptionType:ku.UNSELECTED_READONLY},{result:a,exceptionType:ku.UNSELECTED_FLATTENED}];for(const{result:t,exceptionType:s}of c)if(t.length){const n=s;return n.details=t,ku.warning(n,e,i),!1}const d=s(this,fR).getSelectedAnnotations().map((t=>t.uid));return d.length===h.length&&function(t,e){if(t.length!==e.length)return !1;const i=t.slice().sort(),s=e.slice().sort();for(let t=0;t<i.length;t++)if(i[t]!==s[t])return !1;return !0}(d,h)||s(this,fR).selectAnnotations(h),!0}getSelectedAnnotations(){if(!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return [];return s(this,fR).getSelectedAnnotations().length?cR.getAnnotationsByUids(s(this,fR).getSelectedAnnotations().map((t=>t.uid))):[]}async copySelectedTexts(){await s(this,fR).copySelectedTexts();}on(t,e){s(this,mR).on(s(this,fR),`${gR}.on`,t,e);}off(t,e){s(this,mR).off(s(this,fR),`${gR}.off`,t,e);}destroy(){s(this,mR).destroy(s(this,fR));}setAnnotationDrawingStyle(t){var e,i;const n=`${gR}.setAnnotationDrawingStyle`,o="config";if(uk(t,1,n,o)||!pk(t,1,n,o))return !1;const r=dE.isAnnotationDrawingStyleValid(t,o);if(r.length){const t=ku.PARAM_INVALID;return t.details=r,ku.warning(t,n,o),!1}(null==t||null===(e=t.textBox)||void 0===e||null===(e=e.textContent)||void 0===e?void 0:e.fontSize)<=0&&(t.textBox.textContent.fontSize=1),(null==t||null===(i=t.textTypewriter)||void 0===i||null===(i=i.textContent)||void 0===i?void 0:i.fontSize)<=0&&(t.textTypewriter.textContent.fontSize=1);const a=s(this,fR).getAnnotationConfig().defaultStyleConfig;if(null!=t&&t.line){const e=gD(a.line.lineEnding,"user");t.line.lineEnding={...e,...t.line.lineEnding};}if(null!=t&&t.polyline){const e=gD(a.polyline.lineEnding,"user");t.polyline.lineEnding={...e,...t.polyline.lineEnding};}const l=KR({defaultStyleConfig:t});return s(this,fR).updateAnnotationConfig(l),!0}getTextSelection(){const t=s(this,fR).context.getTextSelection();return t.forEach((t=>{t.rects=t.rects.map((t=>({x:jn(t.x,2),y:jn(t.y,2),width:jn(t.width,2),height:jn(t.height,2)})));})),t}async searchNextText(t,e){const i=`${gR}.searchNextText`;if(uk(t,1,i,"text")||!Hk(t,1,i,"text")||!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return !1;if(e){const t=dE.isSearchTextOptionsValid(e,"options");if(t.length){const e=ku.PARAM_INVALID;return e.details=t,ku.warning(e,i,"options"),!1}}return s(this,fR).searchNextText(t,e).then((t=>(t||ku.warning(ku.NO_RESULTS_FOUND),t)))}async searchPrevText(t,e){const i=`${gR}.searchPrevText`;if(uk(t,1,i,"text")||!Hk(t,1,i,"text")||!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return !1;if(e){const t=dE.isSearchTextOptionsValid(e,"options");if(t.length){const e=ku.PARAM_INVALID;return e.details=t,ku.warning(e,i,"options"),!1}}return s(this,fR).searchPrevText(t,e).then((t=>(t||ku.warning(ku.NO_RESULTS_FOUND),t)))}async searchFullText(t,e){const i=`${gR}.searchFullText`;if(uk(t,1,i,"text")||!Hk(t,1,i,"text")||!Uk(s(this,fR),1)||Lk(void 0,void 0,s(this,fR),1))return !1;if(e){const t=dE.isSearchTextOptionsValid(e,"options");if(t.length){const e=ku.PARAM_INVALID;return e.details=t,ku.warning(e,i,"options"),!1}}return s(this,fR).searchFullText(t,e).then((t=>(t||ku.warning(ku.NO_RESULTS_FOUND),t)))}getVisiblePagesInfo(){return s(this,fR).getVisiblePagesInfo()}getAnnotationDrawingStyle(){return tE(s(this,fR).getAnnotationConfig().defaultStyleConfig)}}function CR(){s(this,fR).hooks.annotationDefaultStyleChanged.on((t=>{s(this,fR).emitter.hasCallback("annotationDrawingStyleChanged")&&s(this,fR).emit("annotationDrawingStyleChanged",{newDrawingStyle:tE(Ns(t.newStyle)),oldDrawingStyle:tE(Ns(t.oldStyle))});}));}function PR(){s(this,fR).hooks.destroy.on((()=>{var t;null===(t=this.thumbnail)||void 0===t||t.vCommon.destroy(this.thumbnail.v),this.thumbnail=null,n(this,fR,null),Object.setPrototypeOf(this,null);}));}function TR(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=t||{},n=Ns(eD);$s()&&(n.size="100%",n.rows=3,n.columns=2,n.canvasStyle.background="#4B4B4B",n.pageNumberStyle.color="white",n.enableOptimizePage=!0),Nn(i,n);const{mainAndThbContainer:o,mainContainer:r,thumbnailContainer:a}=s(this,fR).context.viewService,{size:l,position:h,visibility:c}=n,d=Ns(bk);let u="row",p=l,g="100%",f="left"===h?"-1":"1";"top"!==h&&"bottom"!==h||(u="column",p="100%",g=l,f="top"===h?"-1":"1");const v=`ddv-edit-viewer-thumb-${h}`;d.className=v,Object.assign(a.style,{width:p,height:g,order:f,display:"visible"===c?"block":"none"}),o.style.flexDirection=u,o.insertBefore(a,r),s(this,fR).context.resize(),s(this,fR).context.viewerConfig.hasThb=!0;const m=new oD({container:a,viewerConfig:{...n,...e},groupUid:this.groupUid,uiConfig:d},`${gR}.thumbnail`);this.thumbnail=m,s(this,fR).emit("thumbnailBind",m.uid),m.v.emit("thumbnailBind",s(this,fR).uid),m.on("click",(()=>{s(this,fR).emit("ui_hidePopup",null);}));}function AR(){this.on("resized",(t=>{$R(this,s(this,fR).rootDom,s(this,vR));}));}const kR={canvasStyle:{...Tk},pageStyle:{...Ak},quadSelectionStyle:{...kk},enableSlide:!0,enableMagnifier:!0};function DR(t,e,i,s){const n=dE.isQuadValid(t);return n.length?Ru.output(e,i,s,n):!!Xn(t.flat())||Ru.output(e,i,s,void 0,ku.PARAM_INVALID)}function RR(t,e,i,s){return !!function(t,e,i){for(let s=0;s<t.length;s++)if(t[s][0]>e||t[s][1]>i)return !0;return !1}(t,i,s)&&(Ru.output(e,void 0,void 0,void 0,ku.QUAD_EXCEED_PAGE_BOUND),!0)}const ER=["canvasStyle","pageStyle","quadSelectionStyle","cursorStyle"],MR="PerspectiveViewer";var IR=new WeakMap,BR=new WeakMap,UR=new WeakSet;class LR{constructor(t){var e,o;v(this,UR),f(this,IR,{writable:!0,value:void 0}),f(this,BR,{writable:!0,value:new zk}),i(this,"uid",void 0),i(this,"groupUid",void 0),i(this,"postfix",void 0),Ap.makeSureCoreLicenseExist(),_s(t)||Xk(t,"perspectiveViewer",0,`new ${MR}`,"option");const r=Nn((null==t?void 0:t.viewerConfig)||{},Ns({...kR,viewerMode:lg.PERSPECTIVE,toolMode:"crop"})),a=$s()?mk:xk;n(this,IR,GT.createViewer({uiConfig:Ns(a),...t,viewerConfig:{enablePopup:!0,...r},popupConfig:{passwordLoaderConfig:{enabled:null===(e=null==t||null===(o=t.viewerConfig)||void 0===o?void 0:o.enablePasswordLoader)||void 0===e||e}}})),this.uid=s(this,IR).uid,this.groupUid=s(this,IR).groupUid,this.postfix=s(this,IR).postfix,p(this,UR,OR).call(this);}get isVisible(){return s(this,BR).getIsVisible(s(this,IR))}get isBoundContainer(){return s(this,BR).getIsBoundContainer(s(this,IR))}get currentDocument(){return s(this,BR).getCurrentDocument(s(this,IR))}bindContainer(t){s(this,BR).bindContainer(s(this,IR),t,`${MR}.bindContainer`);}unbindContainer(){s(this,BR).unbindContainer(s(this,IR));}show(){s(this,BR).show(s(this,IR));}hide(){s(this,BR).hide(s(this,IR));}getUiConfig(){return s(this,BR).getUiConfig(s(this,IR))}updateUiConfig(t){return s(this,BR).updateUiConfig(s(this,IR),t,"perspectiveViewer",`${MR}.updateUiConfig`)}openDocument(t){s(this,BR).openDocument(t,this.uid,`${MR}.openDocument`);}closeDocument(){return s(this,BR).closeDocument(s(this,IR),`${MR}.closeDocument`)}getStyle(t){return s(this,BR).getStyle(s(this,IR),"perspective",t,ER,`${MR}.getStyle`)}updateStyle(t,e){const i=`${MR}.updateStyle`;return s(this,BR).updateStyle(s(this,IR),t,e,ER,i)}setQuadSelection(t){const e=`${MR}.setQuadSelection`,i="quad";if(uk(t,1,e,i)||!DR(t,1,e,i)||!Uk(s(this,IR),1)||Lk(e,void 0,s(this,IR),1))return !1;const{width:n,height:o}=s(this,IR).getRealPixelSize();return !RR(t,1,n,o)&&s(this,IR).setQuadBox(t)}getQuadSelection(){const t=`${MR}.getQuadSelection`;return !Uk(s(this,IR),1)||Lk(t,void 0,s(this,IR),1)?null:s(this,IR).getQuadBox()}resetQuadSelection(t){const e=`${MR}.resetQuadSelection`;if(!Uk(s(this,IR),1)||Lk(e,void 0,s(this,IR),1))return !1;if(!_s(t)){if(!Vk(t,1,e,"indices",0,s(this,IR).getPageCounts()-1))return !1}return s(this,IR).resetQuadBox(t)}applyPerspective(t){const e=`${MR}.applyPerspective`,i="quad";uk(t,0,e,i),DR(t,0,e,i),Uk(s(this,IR),0),Lk(e,void 0,s(this,IR),0);let{width:n,height:o}=s(this,IR).getRealPixelSize();return n=Math.round(n),o=Math.round(o),RR(t,0,n,o),s(this,IR).perspectivePage(t)}rotate(t,e){const i=`${MR}.rotate`;return s(this,BR).rotate(s(this,IR),t,e,i)}saveOperations(){return s(this,BR).saveOperation(s(this,IR))}goToPage(t){const e=`${MR}.goToPage`;return s(this,BR).gotoPage(s(this,IR),t,e)}indexToUid(t){const e=`${MR}.indexToUid`;return s(this,BR).indexToUid(s(this,IR),t,e)}uidToIndex(t){const e=`${MR}.uidToIndex`;return s(this,BR).uidToIndex(s(this,IR),t,e)}getCurrentPageUid(){return s(this,BR).getCurrentPageUid(s(this,IR))}getCurrentPageIndex(){return s(this,BR).getCurrentPageIndex(s(this,IR))}getPageCount(){return s(this,BR).getPageCount(s(this,IR))}on(t,e){s(this,BR).on(s(this,IR),`${MR}.on`,t,e);}off(t,e){s(this,BR).off(s(this,IR),`${MR}.off`,t,e);}destroy(){s(this,BR).destroy(s(this,IR));}getVisiblePagesInfo(){return s(this,IR).getVisiblePagesInfo()}}function OR(){s(this,IR).hooks.destroy.on((()=>{n(this,IR,null),Object.setPrototypeOf(this,null);}));}class NR extends oD{constructor(t){super(t,"BrowseViewer");}get currentDocument(){return this.vCommon.getCurrentDocument(this.v)}bindContainer(t){this.vCommon.bindContainer(this.v,t,`${this.errorPrefix}.bindContainer`);}unbindContainer(){this.vCommon.unbindContainer(this.v);}openDocument(t){this.vCommon.openDocument(t,this.uid,`${this.errorPrefix}.openDocument`);}closeDocument(){return this.vCommon.closeDocument(this.v,`${this.errorPrefix}.closeDocument`)}rotate(t,e){const i=`${this.errorPrefix}.rotate`;return this.vCommon.rotate(this.v,t,e,i)}indexToUid(t){const e=`${this.errorPrefix}.indexToUid`;return this.vCommon.indexToUid(this.v,t,e)}uidToIndex(t){const e=`${this.errorPrefix}.uidToIndex`;return this.vCommon.uidToIndex(this.v,t,e)}getCurrentPageUid(){return this.vCommon.getCurrentPageUid(this.v)}getCurrentPageIndex(){return this.vCommon.getCurrentPageIndex(this.v)}getPageCount(){return this.vCommon.getPageCount(this.v)}goToPage(t){const e=`${this.errorPrefix}.goToPage`;return this.vCommon.gotoPage(this.v,t,e)}saveOperations(){return this.vCommon.saveOperation(this.v)}destroy(){this.vCommon.destroy(this.v);}}var _R=new WeakMap,WR=new WeakMap,FR=new WeakMap,HR=new WeakSet;class VR{constructor(t){v(this,HR),f(this,_R,{writable:!0,value:void 0}),f(this,WR,{writable:!0,value:void 0}),f(this,FR,{writable:!0,value:!1}),i(this,"uid",void 0),i(this,"isDestroyed",!1),i(this,"postfix",void 0);this.uid=qs(),this.postfix=`-${this.uid}`,n(this,WR,new Qs),_s(t)||Xk(t,"customViewer",0,"new CustomViewer","option");let e=null==t?void 0:t.uiConfig;(!e||Os(e)&&0===Object.keys(e).length)&&(e={type:"Layout"}),p(this,HR,zR).call(this),n(this,_R,new vb({container:null==t?void 0:t.container,emitter:s(this,WR),postfix:this.uid,uiConfig:e,injection:{viewer:{postfix:this.postfix}}})),null!=t&&t.container&&e&&s(this,_R).bindContainer(t.container);}get isBoundContainer(){return s(this,FR)}get isVisible(){return "none"!==s(this,_R).rootDom.style.display}bindContainer(t){const e="CustomViewer.bindContainer";uk(t,0,e,"container");const i=dE.isContainerParamValid(t);i&&Ru.error(e,"container",void 0,i);s(this,_R).bindContainer(t)&&n(this,FR,!0);}unbindContainer(){s(this,_R).unbindContainer(),n(this,FR,!1);}hide(){s(this,_R).rootDom.style.display="none";}show(){s(this,_R).rootDom.style.display="flex";}getUiConfig(){return s(this,_R).uiConfig}updateUiConfig(t){const e="CustomViewer.updateUiConfig",i="uiConfig";return !(uk(t,1,e,i)||!Nk(t,"customViewer",e,i,1))&&s(this,_R).updateUiConfig(t)}on(t,e){const i="CustomViewer.on";!uk(t,1,i,"eventName")&&!uk(e,1,i,"listener")&&Hk(t,1,i,"eventName",!1)&&Fk(e,i,"listener",1)&&s(this,WR).on(t,e);}off(t,e){const i="CustomViewer.off";!uk(t,1,i,"eventName")&&Hk(t,1,i,"eventName",!1)&&(_s(e)||Fk(e,i,"listener",1))&&s(this,WR).off(t,e);}destroy(){this.isDestroyed||(s(this,_R).dispose(),s(this,WR).destroy(),n(this,_R,null),n(this,WR,null)),this.isDestroyed=!0,Object.setPrototypeOf(this,null);}}function zR(){vb.registerComponent({Root:bb,Layout:yb,Button:mb,Blank:bC,SeparatorLine:Sb,Close:SC,Done:PC,Back:CC});}function $R(t,e,i){if(!i||$s()||!t.isVisible)return;const s=e,n=s.clientWidth;if(t instanceof SR){let t=20;n<1280&&(t=Math.max(13.5,n/1280*20)),s.style.fontSize=`${t}px`;}}function jR(t){if(t instanceof Blob)return !0;if(Xs(t)){const e=t=>{try{new URL(t);return !0}catch(t){return !1}};return !(!(t=>/^data:image\/([a-zA-Z]*);base64,/.test(t))(t)&&!e(t))}return !1}function XR(t){return !![Ck.REJECTED,Ck.ACCEPTED,Ck.INITIAL_HERE,Ck.SIGN_HERE,Ck.WITNESS,Ck.APPROVED,Ck.NOT_APPROVED,Ck.DRAFT,Ck.FINAL,Ck.COMPLETED,Ck.CONFIDENTIAL,Ck.VOID].includes(t)}function GR(t){return !!XR(t)||(!!Hs(t)||!!hE(t))}function YR(t){return !!Os(t)&&!(null!=t&&t.content&&!Xs(t.content)||null!=t&&t.color&&!Xs(t.color)||null!=t&&t.fontFamily&&!Xs(t.fontFamily)||null!=t&&t.fontSize&&!js(t.fontSize)||null!=t&&t.lineThrough&&!Vs(t.lineThrough)||null!=t&&t.underline&&!Vs(t.underline)||null!=t&&t.fontWeight&&!["normal","bold"].includes(t.fontWeight)||null!=t&&t.fontStyle&&!["normal","italic"].includes(t.fontStyle))}function qR(t){return !!Os(t)&&(!!(js(null==t?void 0:t.x)&&js(null==t?void 0:t.y)&&js(null==t?void 0:t.width)&&js(null==t?void 0:t.height))&&!(t.width<=0||t.height<=0))}function JR(t,e){const i=["Load","Download","Print"],s=["Layout","Button","Blank","SeparatorLine","Close","Done","Back"],n=[...s,"MainView"],o=["Pagination","RotateLeft","RotateRight","Delete","DeleteCurrent","DeleteAll"],r=[...n,...o,...i,"PerspectiveAll","FullQuad"],a=[...n,...o,...i],l=[...n,"Capture","Flashlight","CameraConvert","CameraResolution","AutoDetect","AutoCapture","ImagePreview"],h=[...n,...o,...i,"Zoom","ZoomIn","ZoomOut","ZoomByPercentage","ThumbnailSwitch","FitMode","DisplayMode","Crop","Filter","Undo","Redo","Pan","FitWidth","FitHeight","FitWindow","ActualSize","SinglePage","ContinuousPage","AnnotationSet","EllipseAnnotation","EraseAnnotation","InkAnnotation","LineAnnotation","PolygonAnnotation","PolylineAnnotation","RectAnnotation","SelectAnnotation","StampIconAnnotation","StampImageAnnotation","TextBoxAnnotation","TextTypewriterAnnotation","BringForward","BringToFront","SendBackward","SendToBack","TextSearchPanel","TextSearchPanelSwitch","TextSelectionMode","HighlightAnnotation","UnderlineAnnotation","StrikeoutAnnotation"];let c;switch(e){case"captureViewer":c=l;break;case"editViewer":c=h;break;case"perspectiveViewer":c=r;break;case"customViewer":c=s;break;case"browseViewer":c=a;}const d=[];return null!=t&&t.type&&!c.includes(null==t?void 0:t.type)&&d.push(t.type),null!=t&&t.children&&t.children.forEach((t=>{Xs(t)&&!c.includes(t)&&d.push(t),Os(t)&&d.push(...JR(t,e));})),d}function ZR(t){const e=[];return null!=t&&t.type&&e.push(t.type),null!=t&&t.children&&t.children.forEach((t=>{Xs(t)&&e.push(t),Os(t)&&e.push(...ZR(t));})),[...new Set(e)]}function QR(t,e){const i=JR(t,e);if(i.length>0){let t="";return i.forEach(((e,s)=>{s===i.length-1?t+=`${e}`:t+=`${e} `;})),t}return !1}function KR(t){const{defaultStyleConfig:e}=t;Object.keys(e).forEach((t=>{const i=e[t];"object"==typeof i&&null!==i&&((t=>{if("lineEnding"in t&&"object"==typeof t.lineEnding&&null!==t.lineEnding){const e=gD(t.lineEnding,"date");delete t.lineEnding,t.lineEnding=e;}})(i),(t=>{"borderWidth"in t&&(t.borderWidth=Gn(js(null==t?void 0:t.borderWidth)?t.borderWidth:1,Bo.dataResolution,Bo.displayResolution));})(i),(t=>{if("textContent"in t)if(Os(t.textContent)){var e,i,s,n,o,r,a;js(null==t||null===(e=t.textContent)||void 0===e?void 0:e.fontSize)&&(t.textContent.fontSize=Gn(null==t||null===(a=t.textContent)||void 0===a?void 0:a.fontSize,Bo.dataResolution,Bo.displayResolution)),null!=t&&null!==(i=t.textContent)&&void 0!==i&&i.fontStyle&&!["normal","italic"].includes(null==t||null===(s=t.textContent)||void 0===s?void 0:s.fontStyle)&&(t.textContent.fontStyle="normal"),null!=t&&null!==(n=t.textContent)&&void 0!==n&&n.fontWeight&&!["normal","bold"].includes(null==t||null===(o=t.textContent)||void 0===o?void 0:o.fontWeight)&&(t.textContent.fontWeight="normal"),""===(null==t||null===(r=t.textContent)||void 0===r?void 0:r.fontFamily)&&(t.textContent.fontFamily="Helvetica");}else t.textContent={};})(i),(t=>{"lineDash"in t&&t.lineDash.length&&(t.lineDash=Gn(t.lineDash,Bo.dataResolution,Bo.displayResolution));})(i),(t=>{"textAlign"in t&&!["left","right","center","justify"].includes(null==t?void 0:t.textAlign)&&(t.textAlign="left");})(i),(t=>{"opacity"in t&&(!js(null==t?void 0:t.opacity)||(null==t?void 0:t.opacity)<0||(null==t?void 0:t.opacity)>1)&&(t.opacity=1);})(i),"stamp"===t&&(t=>{t.stamp instanceof Blob&&(t.imageData=t.stamp),Xs(t.stamp)&&(jR(t.stamp)?t.imageData=t.stamp:t.stampIcon=XR(t.stamp)?fD(t.stamp,"date"):fD(Ck.DRAFT,"date")),hE(t.stamp)&&(t.stampConfig=t.stamp),delete t.stamp;})(i));}));return {...t,controlsStyle:t.annotationSelectionStyle}}function tE(t){return Object.keys(t).forEach((e=>{const i=t[e];"object"==typeof i&&null!==i&&((t=>{if("lineEnding"in t){const e=gD(t.lineEnding,"user");t.lineEnding=e;}})(i),(t=>{"borderWidth"in t&&(t.borderWidth=Gn(t.borderWidth,Bo.displayResolution,Bo.dataResolution,!0));})(i),(t=>{var e,i;"textContent"in t&&null!=t&&null!==(e=t.textContent)&&void 0!==e&&e.fontSize&&(t.textContent.fontSize=Gn(null==t||null===(i=t.textContent)||void 0===i?void 0:i.fontSize,Bo.displayResolution,Bo.dataResolution,!0));})(i),(t=>{"lineDash"in t&&(t.lineDash=Gn(t.lineDash,Bo.displayResolution,Bo.dataResolution,!0));})(i),"stamp"===e&&(t=>{t.imageData&&(t.stamp=t.imageData),delete t.imageData,t.stampConfig&&(t.stamp||(t.stamp=t.stampConfig)),delete t.stampConfig,t.stampIcon&&(t.stamp||(t.stamp=fD(t.stampIcon,"user"))),delete t.stampIcon;})(i));})),t}function eE(t){if(""===t)return !0;const e=document.createElement("div");e.style.border=t;const i=t=>""===t||"initial"===t,{borderWidth:s,borderColor:n,borderStyle:o}=e.style;return !(i(s)||i(n)||i(o))}function iE(t,e,i){const{left:s,top:n,width:o,height:r}=t,a=1e-4;return !(Math.abs(s-e)>a&&s>e||Math.abs(s+o-e)>a&&s+o>e||Math.abs(n-i)>a&&n>i||Math.abs(n+r-i)>a&&n+r>i)}function sE(t,e){return Object.keys(t).filter((i=>t[i]===e))}function nE(t,e){if(t===e)return !0;if(Os(t)&&Os(e)&&Object.keys(t).length===Object.keys(e).length)for(const i in t){if(!Object.prototype.hasOwnProperty.call(e,i))return !1;if(!nE(t[i],e[i]))return !1}else {if(!Ls(t)||!Ls(e)||t.length!==e.length)return !1;for(let i=0;i<t.length;i++)if(!nE(t[i],e[i]))return !1}return !0}function oE(t,e){let i;switch(t){case"canvasStyle":i=function(t,e){const i=[];i.push(...aE(t,{border:(null==e?void 0:e.border)||"",background:(null==e?void 0:e.background)||""})),_s(null==e?void 0:e.cursor)||Xs(e.cursor)||i.push(`${t}.cursor is invalid`);return i}(t,e);break;case"pageNumberStyle":i=function(t,e){const i=[],s=["color","fontSize","fontFamily","left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY"];return Object.keys(e).forEach((n=>{-1!==s.indexOf(n)&&(Xs(e[n])||i.push(`${t}.${n} is invalid.`)),"border"===n&&Xs(e[n])&&!eE(e[n])&&i.push(`${t}.border is invalid.`),("onPage"===n&&!Vs(e[n])||"opacity"===n&&!js(e[n])||"visibility"===n&&-1===["visible","hidden"].indexOf(e[n]))&&i.push(`${t}.${n} is invalid.`);})),i}(t,e);break;case"checkBoxStyle":i=function(t,e){const i=[],s=["checkMarkColor","checkMarkLineWidth","left","top","right","bottom","width","height","background","border","borderRadius","translateX","translateY"];return Object.keys(e).forEach((n=>{-1!==s.indexOf(n)&&(Xs(e[n])||i.push(`${t}.${n} is invalid.`)),"border"===n&&Xs(e[n])&&!eE(e[n])&&i.push(`${t}.border is invalid.`),("opacity"===n&&!js(e[n])||"visibility"===n&&-1===["visible","hidden"].indexOf(e[n]))&&i.push(`${t}.${n} is invalid.`);})),i}(t,e);break;case"quadSelectionStyle":i=function(t,e){const i=[],s=["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground","invalidCtrlBorderColor","invalidBorderColor"];return Object.keys(e).forEach((n=>{-1!==s.indexOf(n)&&(Xs(e[n])||i.push(`${t}.${n} is invalid`)),"border"!==n&&"ctrlBorder"!==n||!Xs(e[n])||eE(e[n])||i.push(`${t}.${n} is invalid`);})),i}(t,e);break;case"annotationSelectionStyle":i=function(t,e){const i=[],s=["border","background","ctrlBorderRadius","ctrlBorder","ctrlWidth","ctrlHeight","ctrlBackground"];return Object.keys(e).forEach((n=>{-1!==s.indexOf(n)&&(Xs(e[n])||i.push(`${t}.${n} is invalid.`)),"border"!==n&&"ctrlBorder"!==n||!Xs(e[n])||eE(e[n])||i.push(`${t}.${n} is invalid.`);})),i}(t,e);break;default:i=aE(t,e);}return i}function rE(t){return !!js(t)&&t>=0}function aE(t,e){const i=[];return Object.keys(e).forEach((s=>{-1!==["background","border"].indexOf(s)&&(Xs(e[s])||i.push(`${t}.${s} is invalid.`),"border"===s&&e[s]&&Xs(e[s])&&!eE(e[s])&&i.push(`${t}.border is invalid.`));})),i}function lE(t,e){const i=t.flat(2),s=e.flat(2);if(i.length!==s.length)return !1;const n=s[0].x-i[0].x,o=s[1].y-i[1].y;for(let t=1;t<i.length;t++){if(s[t].x-i[t].x!==n)return !1;if(s[t].y-i[t].y!==o)return !1}return !0}function hE(t){return Array.isArray(t)&&t.every((t=>"object"==typeof t&&null!==t))}function cE(t){const e={};return !1===(null==t?void 0:t.enableZoom)&&(e.enableZoomInWithKeyboard=!1,e.enableZoomOutWithKeyboard=!1),!1===(null==t?void 0:t.enableUndoRedo)&&(e.enableUndoWithKeyboard=!1,e.enableRedoWithKeyboard=!1),!1===(null==t?void 0:t.enableAnnotationClipboard)&&(e.enableCopyCutPasteWithKeyboard=!1),!1===(null==t?void 0:t.enableMoveAnnotation)&&(e.enableMoveAnnotationWithKeyboard=!1),!1===(null==t?void 0:t.enableDeleteAnnotation)&&(e.enableDeleteWithKeyboard=!1),!1===(null==t?void 0:t.enablePageNavigation)&&(e.enableSelectPageWithKeyboard=!1),!1===(null==t?void 0:t.enableMultiplePagesSelection)&&(e.enableSelectWithShift=!1,e.enableSelectWithCtrl=!1,e.enableSelectAllWithKeyboard=!1),!1===(null==t?void 0:t.enableMultipleAnnotationsSelection)&&(e.enableMultipleSelectAnnotationWithKeyboard=!1),e}class dE{static isLicenseValid(t){if(Xs(t)){const e=t.trim();return 0===e.length||e.startsWith("DLS")||(e.startsWith("f")||e.startsWith("t"))&&e.length>50}return !1}static isQuadValid(t,e){const i=[],s=Du("Quad",e);if(_s(t))return i.push(`${s} is missing.`),i;const n=Ru.isArrayAndMeetMinLength(t,4),o=Ru.formatDetails(s,n);return o.length?(i.push(...o),i):(t.forEach(((t,s)=>{const n=Du("Quad",e,`[${s}]`,!0),o=Ru.isArrayAndMeetMinLength(t,2),r=Ru.formatDetails(Du("Array",n),o);r.length?i.push(...r):t.forEach(((t,e)=>{const s=Ru.isNumberAndIsInRange(t),o=Ru.formatDetails(Du("Array",n,`[${e}]`,!0),s);o.length&&i.push(...o);}));})),i)}static isRectValid(t,e){const i=[],s=Du("Rect",e);if(_s(t))return i.push(`${s} is missing.`),i;const n=Ru.formatDetails(s,Os(t));return n.length?(i.push(...n),i):(["left","top","width","height"].forEach((s=>{const n=Ru.formatDetails(Du("Rect",e,s),Ru.isNumberAndIsInRange(t[s]));n.length&&i.push(...n);})),i)}static isUpdatedSourceValid(t,e,i){const s=[],n="UpdatedSource",o=Ru.formatDetails(Du(n,e),Os(t));if(o.length)return s.push(...o),s;const r=dE.isSourceValid(t,"source",i);if(r.length&&s.push(...r),!_s(t.fileIndex)){const i=Ru.formatDetails(Du(n,e,"fileIndex"),Ru.isNumberAndIsInRange(t.fileIndex,0));s.push(...i);}return s}static isSourceValid(t,e,i){const s=[],n="Source",o=Ru.formatDetails(Du(n,e),Os(t));if(o.length)return s.push(...o),s;const r=Ru.formatDetails(Du(n,e,"fileData"),Hs(t.fileData));return r.length?(s.push(...r),s):s}static isSourcesValid(t,e,i){const s=[],n="Source[]",o=Ru.formatDetails(Du(n,e),Ru.isArrayAndMeetMinLength(t));return o.length?(s.push(...o),s):(t.forEach(((t,o)=>{s.push(...this.isSourceValid(t,Du(n,e,`[${o}]`,!0),i));})),s)}static isLoadSourceOptionsValid(t,e){const i=[],s="LoadSourceOptions",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.insertBeforeIndex)){const n=Ru.formatDetails(Du(s,e,"insertBeforeIndex"),Ru.isNumberAndIsInRange(t.insertBeforeIndex));i.push(...n);}if(!_s(t.exception)){const n=Ru.formatDetails(Du(s,e,"exception"),Ru.isStringAndNotEmpty(t.exception,!1));i.push(...n);}return i}static isHandlerTypeValid(t){return {isValid:Xs(t)&&["documentBoundariesDetect","imageFilter"].includes(t)}}static isContainerKeyValid(t,e){const i="container";let s;if(Zs(t)&&(s=t),Xs(t)){const e=document.getElementById(t);Zs(e)&&(s=e);}const n=[];return s||n.push(`${Du(i,e,i)}: ${ku.CONTAINER_NOT_EXIST.message}`),n}static isContainerParamValid(t){return Xs(t)||Zs(t)?this.isContainerKeyValid(t).length>0?ku.CONTAINER_NOT_EXIST:null:ku.PARAM_INVALID}static isUiConfigValid(t,e){const i="UiConfig",s=[],n=Ru.formatDetails(Du(i,e),Os(t));if(n.length)return s.push(...n),s;const o=Ru.formatDetails(Du(i,e,"type"),Ru.isStringAndNotEmpty(t.type,!1));if(s.push(...o),["id","name","flexDirection","tooltip","className","label"].forEach((n=>{if(!_s(t[n])){const o=Ru.formatDetails(Du(i,e,n),Ru.isStringAndNotEmpty(t[n]));s.push(...o);}})),["style","events"].forEach((n=>{if(!_s(t[n])){const o=Ru.formatDetails(Du(i,e,n),Os(t[n]));s.push(...o);}})),!_s(t.children)){const n=Ru.formatDetails(Du(i,e,"children"),Ru.isArrayAndMeetMinLength(t.children));if(n.length)return s.push(...n),s;t.children.forEach(((t,n)=>{if(Xs(t)||Os(t)||s.push(`${i}.children[${n}] is invalid.`),Os(t)){const o=this.isUiConfigValid(t,Du(i,e,`children[${n}]`));s.push(...o);}}));}return s}static isDocOptionsValid(t,e){const i=[],s=e||"CreateDocumentOptions",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.name)){const n=Ru.formatDetails(Du(s,e,"name"),Ru.isStringAndNotEmpty(t.name,!1));i.push(...n);}if(!_s(t.author)){const n=Ru.formatDetails(Du(s,e,"author"),Ru.isStringAndNotEmpty(t.author,!1));i.push(...n);}if(!_s(t.creationDate)){const n=Ru.formatDetails(Du(s,e,"creationDate"),Ru.isPdfDate(t.creationDate));i.push(...n);}if(!_s(t.deleteOriginal)){const n=Ru.formatDetails(Du(s,e,"deleteOriginal"),Vs(t.deleteOriginal));i.push(...n);}return i}static isTransferOptionsValid(t,e,i,s){const n=[],o="TransferOptions",r=Ru.formatDetails(Du(o,s),Os(t));if(r.length)return n.push(...r),n;if(!_s(t.sourceIndices)){const r=this.isNumberArrayValid(t.sourceIndices,e,i,Du(o,s,"sourceIndices"));n.push(...r);}if(!_s(t.insertBeforeIndex)){const e=Ru.formatDetails(Du(o,s,"insertBeforeIndex"),Ru.isNumberAndIsInRange(t.insertBeforeIndex,0));n.push(...e);}return n}static isNumberArrayValid(t,e,i,s){return this.isTypeArrayValid("number",t,e,i,s)}static isStringArrayValid(t,e){return this.isTypeArrayValid("string",t,void 0,void 0,e)}static isBlobArrayValid(t,e){return this.isTypeArrayValid("blob",t,void 0,void 0,e)}static isTypeArrayValid(t,e,i,s,n){const o=[],r=Ru.formatDetails(Du("Array",n),Ru.isArrayAndMeetMinLength(e));return r.length?(o.push(...r),o):(e.forEach(((e,r)=>{let a=null;"blob"===t?a=Hs(e):"number"===t?a=Ru.isNumberAndIsInRange(e,i,s):"string"===t&&(a=Ru.isStringAndNotEmpty(e));const l=Ru.formatDetails(Du("Array",n,`[${r}]`,!0),a);o.push(...l);})),o)}static isRotationValid(t,e){const i=[],s=Du("",e,"rotation"),n=Ru.formatDetails(s,Ru.isNumberAndIsInRange(t));return n.length?(i.push(...n),i):(i.length||t%90==0||i.push(`'${s}' is not supported.`),i)}static isFilterTypeValid(t,e,i){const s=[],n=Du("",i,"filter"),o=Ru.formatDetails(n,Ru.isStringAndNotEmpty(t,!1));return o.length?(s.push(...o),s):(!s.length&&"none"!==t&&Ls(e)&&e.length>0&&!e.includes(t)&&s.push(`'${n}' is not supported.`),s)}static isSaveJpegSettingsValid(t,e){const i=[],s="SaveJpegSettings",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.quality)){const n=Ru.formatDetails(Du(s,e,"quality"),Ru.isNumberAndIsInRange(t.quality,0,100));i.push(...n);}if(!_s(t.saveAnnotation)){const n=Ru.formatDetails(Du(s,e,"saveAnnotation"),Vs(t.saveAnnotation));i.push(...n);}return i}static isSavePngSettingsValid(t,e){const i=[],s="SavePngSettings",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.saveAnnotation)){const n=Ru.formatDetails(Du(s,e,"saveAnnotation"),Vs(t.saveAnnotation));i.push(...n);}return i}static isSavePdfSettingsValid(t,e){const i=[],s="SavePdfSettings",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(["author","creator","keyWords","producer","subject","title"].forEach((n=>{const o=t[n];if(!_s(o)){const t=Ru.formatDetails(Du(s,e,n),Ru.isStringAndNotEmpty(o,!1));i.push(...t);}})),!_s(t.compression)){const n=Ru.formatDetails(Du(s,e,"compression"),jo.has(t.compression));i.push(...n);}if(!_s(t.creationDate)){const n=Ru.formatDetails(Du(s,e,"creationDate"),Ru.isPdfDate(t.creationDate));i.push(...n);}if(!_s(t.modifiedDate)){const n=Ru.formatDetails(Du(s,e,"modifiedDate"),Ru.isPdfDate(t.modifiedDate));i.push(...n);}if(!_s(t.pageType)){const n=Ru.formatDetails(Du(s,e,"pageType"),$o.has(t.pageType));i.push(...n);}if(!_s(t.version)){const n=Ru.formatDetails(Du(s,e,"version"),this.isPdfVersionValid(t.version));i.push(...n);}if(!_s(t.mimeType)){const n=Ru.formatDetails(Du(s,e,"mimeType"),Ru.isStringAndNotEmpty(t.mimeType));i.push(...n);}if(!_s(t.quality)){const n=Ru.formatDetails(Du(s,e,"quality"),Ru.isNumberAndIsInRange(t.quality,0,100));i.push(...n);}if(!_s(t.password)){const n=Ru.formatDetails(Du(s,e,"password"),Ru.isStringAndNotEmpty(t.password));i.push(...n),!n.length&&t.password.length>32&&i.push("The specified password exceeds 32 characters.");}if(!_s(t.saveAnnotation)){const n=Ru.formatDetails(Du(s,e,"saveAnnotation"),["none","image","annotation","flatten"].includes(t.saveAnnotation));i.push(...n);}if(!_s(t.imageScaleFactor)){const n=Ru.formatDetails(Du(s,e,"imageScaleFactor"),Ru.isNumberAndIsInRange(t.imageScaleFactor,Number.MIN_VALUE,1));i.push(...n);}return i}static isPdfVersionValid(t){return !!Xs(t)&&["1.1","1.2","1.3","1.4","1.5","1.6","1.7"].includes(t.trim())}static isSaveTiffSettingsValid(t,e){const i=[],s="SaveTiffSettings",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.compression)){const n=Ru.formatDetails(Du(s,e,"compression"),Xo.has(t.compression));i.push(...n);}if(!_s(t.customTag)){const n=Ru.formatDetails(Du(s,e,"customTag"),Ru.isArrayAndMeetMinLength(t.customTag));i.push(...n),n.length||t.customTag.forEach(((t,n)=>{const o=this.isTiffCustomTagValid(t,Du(s,e,`customTag[${n}]`));i.push(...o);}));}if(!_s(t.quality)){const n=Ru.formatDetails(Du(s,e,"quality"),Ru.isNumberAndIsInRange(t.quality,0,100));i.push(...n);}return i}static isTiffCustomTagValid(t,e){const i=[],s="CustomTag",n=Ru.formatDetails(Du(s,e),Os(t));if(n.length)return i.push(...n),i;if(!_s(t.content)){const n=Ru.formatDetails(Du(s,e,"content"),Ru.isStringAndNotEmpty(t.content,!1));i.push(...n);}if(!_s(t.contentIsBase64)){const n=Ru.formatDetails(Du(s,e,"contentIsBase64"),Vs(t.contentIsBase64));i.push(...n);}if(!_s(t.id)){const n=Ru.formatDetails(Du(s,e,"id"),Ru.isNumberAndIsInRange(t.id));i.push(...n);}return i}static isVideoDeviceInfo(t,e){const i=[],s=Ru.formatDetails(e,Os(t));i.push(...s);const n=Ru.formatDetails(Du(e,void 0,"deviceId"),Ru.isStringAndNotEmpty(t.deviceId,!1));i.push(...n);const o=Ru.formatDetails(Du(e,void 0,"label"),Ru.isStringAndNotEmpty(t.label,!1));return i.push(...o),i}static isVideoConfig(t,e){const i=[],s=Ru.formatDetails(e,Os(t));if(s.length)return i.push(...s),i;if(!_s(t.fill)){const s=Ru.formatDetails(Du(e,void 0,"fill"),Vs(t.fill));i.push(...s);}if(!_s(t.resolution)){const s=dE.isNumberArrayValid(t.resolution,0,void 0,Du(e,void 0,"resolution"));i.push(...s);}return i}static isZoomOriginValid(t){const e=[],i=Ru.formatDetails("zoomOrigin",Os(t));return i.length?(e.push(...i),e):(["x","y"].forEach((i=>{const s=t[i];_s(s)?e.push(`ZoomOrigin.${i} is missing.`):["start","center","end"].includes(s)||e.push(`ZoomOrigin.${i} is valid.`);})),e)}static isAnnotationOptionsValid(t,e,i){const s=[],n=["x","y","rotation"],o=["width","height","borderWidth","opacity","miterLimit","fontSize"],r=["borderColor","background","icon","lineCap","lineJoin","textAlign","content","color","fontFamily","fontWeight","fontStyle"],a=["points"],l=["textContents"],h=["startPoint","endPoint"],c=["flags"],d=["stamp"],u=["lineDash"],p=["rects"],g=t=>!!Os(t)&&(!!js(null==t?void 0:t.x)&&!!js(null==t?void 0:t.y)),f=function(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Ls(t))return !1;if(e&&t.length<2)return !1;for(let e=0;e<t.length;e++)if(!g(t[e]))return !1;return !0};return Object.keys(t).forEach((v=>{const m=t[v];let y=!0;(n.includes(v)&&!js(m)||o.includes(v)&&!rE(m)||r.includes(v)&&!Xs(m)||l.includes(v)&&!((t,e)=>{if(!Ls(t))return !1;if("textTypewriter"===e&&0===t.length)return !1;for(let e=0;e<t.length;e++){const i=t[e];if(!Os(i))return !1;if(!YR(i))return !1}return !0})(m,i)||h.includes(v)&&!g(m)||c.includes(v)&&!Os(m)||d.includes(v)&&!GR(m)||u.includes(v)&&!(t=>{if(!Ls(t))return !1;for(let e=0;e<t.length;e++)if(!rE(t[e]))return !1;return !0})(m)||p.includes(v)&&!(t=>{if(!Ls(t))return !1;if(0===t.length)return !1;for(let e=0;e<t.length;e++){const i=t[e];if(!Os(i))return !1;if(!qR(i))return !1}return !0})(m))&&(y=!1),a.includes(v)&&("ink"===i?(t=>{if(!Ls(t))return !1;if(!t.length)return !1;for(let e=0;e<t.length;e++)if(!f(t[e],!1))return !1;return !0})(t[v])||(y=!1):f(t[v])||(y=!1)),y||s.push(`${e}.${v} is invalid`);})),s}static isAnnotationDrawingStyleValid(t,e){const i=["opacity","borderWidth"],s=["borderColor","background","textAlign"],n=["lineEnding","textContent"],o=[];return Object.keys(t).forEach((r=>{if(["rectangle","ellipse","polygon","polyline","line","ink","textBox","textTypewriter","stamp","highlight","underline","strikeout"].includes(r)){const a=t[r];Os(a)?Object.keys(a).forEach((t=>{const l=a[t];let h=!0;(i.includes(t)&&!js(l)||s.includes(t)&&!Xs(l)||n.includes(t)&&!Os(l))&&(h=!1),"stamp"!==t||GR(l)||(h=!1),"textContent"===t&&h&&(null!=l&&l.content&&!Xs(l.content)||null!=l&&l.color&&!Xs(l.color)||null!=l&&l.fontFamily&&!Xs(l.fontFamily)||null!=l&&l.fontSize&&!js(l.fontSize)||null!=l&&l.lineThrough&&!Vs(l.lineThrough)||null!=l&&l.underline&&!Vs(l.underline)||null!=l&&l.fontWeight&&!["normal","bold"].includes(l.fontWeight)||null!=l&&l.fontStyle&&!["normal","italic"].includes(l.fontStyle))&&(h=!1),h||o.push(`${e}[${r}].${t} is invalid`);})):o.push(`${e}[${r}] is invalid`);}})),o}static isSearchTextOptionsValid(t,e){const i=[],s=Ru.formatDetails(e,Os(t));return s.length?(i.push(...s),i):(["caseSensitive","wholeWord"].forEach((s=>{if(!_s(t[s])){const n=Ru.formatDetails(Du(e,void 0,s),Vs(t[s]));i.push(...n);}})),i)}}var uE=new WeakMap,pE=new WeakMap,gE=new WeakMap;class fE{constructor(t,e){f(this,gE,{get:vE,set:void 0}),f(this,uE,{writable:!0,value:void 0}),f(this,pE,{writable:!0,value:void 0}),n(this,uE,t),n(this,pE,e);}get name(){return s(this,pE).name}get uid(){return s(this,pE).uid}get pages(){return s(this,pE).pages.slice()}get creationDate(){return s(this,pE).creationDate}get author(){return s(this,pE).author}async loadSource(t,e){const i="IDocument.loadSource",n="sources";Ap.makeSureLoadLicenseExist(),uk(t,0,i,n);!function(t,e,i,s,n){let o=[];if(Ls(t)){for(let i=0;i<t.length;i++)if(!Hs(t[i]))if(Os(t[i])){const s=dE.isSourceValid(t[i],Du("Source",void 0,`[${i}]`,!0),e);s.length&&o.push(...s);}else {const t=Ru.formatDetails(Du("Source",n,`[${i}]`,!0),!1);o.push(...t);}}else Hs(t)||(o=dE.isSourceValid(t,void 0,e));!o.length||Ru.output(i,s,n,o);}(t,s(this,uE).filterService.getSupportedFilters().map((t=>t.type)),0,i,n),Os(e)?function(t,e,i,s){const n=dE.isLoadSourceOptionsValid(t,void 0);!n.length||Ru.output(e,i,s,n);}(e,0,i,"loadSourceOptions"):_s(e)||jk(e,0,i,"index",0),Ls(t)||(t=[t]),t=t.map((t=>Hs(t)?{fileData:t}:(t.extraPageData=[],t)));const o=ku.buildInfo("loadSource",{docUid:this.uid,current:0,total:t.length});return ku.info(o),s(this,uE).loadSource(t,this.uid,e,o).catch((t=>(o.status="Failed",ku.info(o),ku.reject(t,i))))}getPageData(t){const e="IDocument.getPageData",i="pageUid";uk(t,0,e,i),Hk(t,0,e,i,!1),this.pages.includes(t)||Ru.error(e,i,void 0,ku.PAGE_NOT_EXIST);return s(this,uE).getPageData(t)}async updatePage(t,e){const i="IDocument.updatePage",n="pageUid";Ap.makeSureLoadLicenseExist(),uk(t,0,i,n),uk(e,0,i,"data"),Hk(t,0,i,n,!1),Wk(this.pages,t,0,i);return function(t,e,i,s,n){const o=dE.isUpdatedSourceValid(t,Du("UpdatedSource",void 0),e);!o.length||Ru.output(i,s,n,o);}(e,s(this,uE).filterService.getSupportedFilters().map((t=>t.type)),0,i,"source"),e.rotation=void 0,e.perspectiveQuad=void 0,e.filer=void 0,s(this,uE).updatePage(t,e).catch((t=>-80101===t.code?ku.reject(t,i,"fileData"):ku.reject(t,i,"source")))}deletePages(t){const e="IDocument.deletePages",i="indices";if(uk(t,1,e,i)||!Vk(t,1,e,i,0,s(this,gE)-1))return !1;const n=t.map((t=>s(this,pE).pages[t]));return s(this,uE).deletePages(this.uid,n)}deleteAllPages(){return s(this,pE).pages.slice(),s(this,uE).deleteAllPages(this.uid)}movePages(t,e){const i="IDocument.movePages",n="indices";uk(t,0,i,n),Vk(t,0,i,n,0,s(this,gE)-1),_s(e)||jk(e,0,i,"insertBeforeIndex",0),e=e>s(this,gE)-1?void 0:e,s(this,uE).movePages(this.uid,t,e);}switchPage(t,e){const i="IDocument.switchPage",n="oneIndex",o="anotherIndex";uk(t,0,i,n),uk(e,0,i,o),jk(t,0,i,n,0,s(this,gE)-1),jk(e,0,i,o,0,s(this,gE)-1),s(this,uE).documentService.swapPages(this.uid,t,e);}rename(t){const e="IDocument.rename",i="name";return !uk(t,1,e,i)&&(!!Hk(t,1,e,i)&&s(this,uE).documentService.renameDocument(this.uid,t))}setPageCustomData(t,e){const i="IDocument.setPageCustomData",n="pageUid";return uk(t,0,i,n),uk(e,0,i,"data"),Hk(t,0,i,n,!1),Wk(this.pages,t,0,i),s(this,uE).setCustomData(t,e)}getPageCustomData(t){const e="IDocument.getPageCustomData",i="pageUid";return uk(t,0,e,i),Hk(t,0,e,i,!1),Wk(this.pages,t,0,e),s(this,uE).getCustomData(t)}async saveToJpeg(t,e){const i="IDocument.saveToJpeg",n="index";uk(t,0,i,n),jk(t,0,i,n,0,s(this,gE)-1),_s(e)||function(t,e,i){const s=dE.isSaveJpegSettingsValid(t);!s.length||Ru.output(e,i,"saveJpegSettings",s);}(e,0,i);const o=this.pages[t],r=ku.buildInfo("save",{docUid:this.uid,pageUids:[o],current:0,total:1});return ku.info(r),s(this,uE).fileSaveService.saveToJpeg(o,e,r).catch((t=>{r.status="Failed",ku.info(r),ku.reject(t,i);}))}saveToPng(t,e){const i="IDocument.saveToPng",n="index";uk(t,0,i,n),jk(t,0,i,n,0,s(this,gE)-1),_s(e)||function(t,e,i){const s=dE.isSavePngSettingsValid(t);s.length&&Ru.output(e,i,"savePngSettings",s);}(e,0,i);const o=this.pages[t],r=ku.buildInfo("save",{docUid:this.uid,pageUids:[o],current:0,total:1});return ku.info(r),s(this,uE).fileSaveService.saveToPng(o,e,r).catch((t=>(r.status="Failed",ku.info(r),ku.reject(t,i))))}saveToPdf(t,e){const i="IDocument.saveToPdf";0===this.pages.length&&ku.throw(ku.DOC_NO_IMAGE),Ls(t)?Vk(t,0,i,"indices",0,s(this,gE)-1):(e=t,t=Array.from(Array(this.pages.length).keys())),_s(e)||function(t,e,i){const s=dE.isSavePdfSettingsValid(t);!s.length||Ru.output(e,i,"savePdfSettings",s);}(e,0,i);const n=[];t.forEach((t=>{n.push(this.pages[t]);}));try{!e||"annotation"!==e.saveAnnotation&&"flatten"!==e.saveAnnotation||Ap.makeSureAnnotationLicenseExist();}catch(t){return Promise.reject(t)}const o=ku.buildInfo("save",{docUid:this.uid,pageUids:n,current:0,total:n.length});return ku.info(o),s(this,uE).fileSaveService.saveToPdf(n,e,o).catch((t=>(o.status="Failed",ku.info(o),ku.reject(t,i))))}saveToTiff(t,e){const i="IDocument.saveToTiff";0===this.pages.length&&ku.throw(ku.DOC_NO_IMAGE),Ls(t)?Vk(t,0,i,"indices",0,s(this,gE)-1):(e=t,t=Array.from(Array(this.pages.length).keys())),_s(e)||function(t,e,i){const s=dE.isSaveTiffSettingsValid(t);!s.length||Ru.output(e,i,"saveTiffSettings",s);}(e,0,i);const n=[];t.forEach((t=>{n.push(this.pages[t]);}));const o=ku.buildInfo("save",{docUid:this.uid,pageUids:n,current:0,total:n.length});return ku.info(o),s(this,uE).fileSaveService.saveToTiff(n,e,o).catch((t=>(o.status="Failed",ku.info(o),ku.reject(t,i))))}print(t,e){const i="IDocument.print";let n,o=e;var r;(Ls(t)?(Vk(t,0,i,"indices",0,s(this,gE)-1),n=t):o=t,_s(o))||(_s(null===(r=o)||void 0===r?void 0:r.printAnnotation)||Vs(o.printAnnotation)||Ru.error(i,"setting.printAnnotation",void 0,ku.PARAM_INVALID));0===this.pages.length&&ku.throw(ku.DOC_NO_IMAGE),s(this,uE).printPages(this.uid,n,o);}insertBlankPage(t,e,i){const n="IDocument.insertBlankPage",o="pageWidth",r="pageHeight";Ap.makeSureLoadLicenseExist(),uk(t,0,n,o),uk(e,0,n,r),jk(t,0,n,o,.72,7200),jk(e,0,n,r,.72,7200),_s(i)||jk(i,0,n,"insertBeforeIndex",0);return s(this,uE).insertBlankPage(this.uid,Math.floor(Gn(t,Bo.dataResolution,72))||1,Math.floor(Gn(e,Bo.dataResolution,72))||1,72,72,i)}isPageModified(t){const e="IDocument.isPageModified",i="index";uk(t,0,e,i),jk(t,0,e,i,0,s(this,gE)-1);const n=this.pages[t];return s(this,uE).isPageModified(n)}createTextSearcher(t,e){const i="IDocument.createTextSearcher";if(uk(t,0,i,"text"),Hk(t,0,i,"text"),!_s(e)){const t=dE.isSearchTextOptionsValid(e,"options");if(t.length){const e=ku.PARAM_INVALID;e.details=t,ku.error(e,i,"options");}}""===t&&ku.error(ku.PARAM_INVALID,i,"text");return s(this,uE).createTextSearcher(this.uid,t,e)}}function vE(){return s(this,pE).pages.length}function mE(t,e,i,s,n){if(!_s(t)){const o="transferOptions",r=dE.isTransferOptionsValid(t,e,i,o);if(r.length)return Ru.output(s,n,o,r)}return !0}function yE(t,e,i,s){if(!_s(t)){const n=dE.isDocOptionsValid(t);if(n.length)return Ru.output(e,i,s,n)}return !0}function xE(t,e,i,s,n){const o=e.reduce(((e,i,s)=>(t.has(i)||e.push(`${n}[${s}]:The specified document(s) do not exist.`),e)),[]);return !o.length||Ru.output(i,s,n,o,ku.DOC_NOT_EXIST,!0)}const wE=["documentCreated","documentDeleted","pagesAdded","pagesDeleted"];var bE=new WeakMap,SE=new WeakMap,CE=new WeakMap;const PE=new class extends Qn{constructor(){super(),f(this,bE,{writable:!0,value:void 0}),f(this,SE,{writable:!0,value:void 0}),f(this,CE,{writable:!0,value:void 0}),n(this,CE,new Qs),n(this,bE,GT),n(this,SE,new Map),GT.onAfterUnload.on((()=>{s(this,SE).clear(),s(this,CE).removeAllEventListeners();}),this);const{documentService:t}=GT;t.onDocumentCreated.on((t=>{const e=s(this,bE).getDocument(t.docUid),i=new fE(s(this,bE),e);s(this,SE).set(i.uid,i),s(this,CE).emit("documentCreated",t);}),this),t.onDocumentDeleted.on((t=>{s(this,SE).has(t.docUid)&&s(this,SE).delete(t.docUid),s(this,CE).emit("documentDeleted",t);}),this),t.onPagesAddedOut.on((t=>{t.indices.length&&t.pageUids.length&&s(this,CE).emit("pagesAdded",t);}),this),t.onDeletePagesFromDoc.on((t=>{s(this,CE).emit("pagesDeleted",t);}),this),t.onDeleteAllPagesFromDoc.on((t=>{s(this,CE).emit("pagesDeleted",t);}),this);}createDocument(t){yE(t,0,"DocumentManager.createDocument","createDocumentOptions");const e=s(this,bE).createDocument(t);return s(this,SE).get(e.uid)}getDocument(t){const e="DocumentManager.getDocument",i="docUid";if(uk(t,1,e,i)||!Hk(t,1,e,i))return null;const n=s(this,SE).get(t);return n||(Ru.warning(e,i,void 0,ku.DOC_NOT_EXIST),null)}getAllDocuments(){return Array.from(s(this,SE).values())}deleteDocuments(t){const e="DocumentManager.deleteDocuments",i="docUids";return !(uk(t,1,e,i)||!VD(t,1,e,i,void 0,!1)||!xE(s(this,SE),t,1,e,i))&&s(this,bE).deleteDocuments([...new Set(t)])}deleteAllDocuments(){const t=s(this,bE).documentService.getAllDocuments();return s(this,bE).deleteDocuments(t.map((t=>t.uid)))}copyPagesToDocument(t,e,i){const n="DocumentManager.copyPagesToDocument",o="sourceDocUid",r="targetDocUid";uk(t,0,n,o),uk(e,0,n,r),Hk(t,0,n,o),Hk(e,0,n,r);const a=s(this,SE).get(t),l=s(this,SE).get(e);return a&&l||ku.throw(ku.DOC_NOT_EXIST,n),mE(i,0,a.pages.length-1,0,n),s(this,bE).transferDocument(t,e,{...i,copy:!0})}movePagesToDocument(t,e,i){const n="DocumentManager.movePagesToDocument",o="sourceDocUid",r="targetDocUid";uk(t,0,n,o),uk(e,0,n,r),Hk(t,0,n,o),Hk(e,0,n,r);const a=s(this,SE).get(t),l=s(this,SE).get(e);return a&&l||ku.throw(ku.DOC_NOT_EXIST,n),mE(i,0,a.pages.length-1,0,n),s(this,bE).transferDocument(t,e,i)}mergeDocuments(t,e){const i="DocumentManager.mergeDocuments",n="docUids";uk(t,0,i,n),VD(t,0,i,n,void 0,!1),function(t){return new Set(t).size!==t.length}(t)&&Ru.error(void 0,void 0,void 0,ku.DOC_UID_DUPLICATE),xE(s(this,SE),t,0,i,n),yE(e,0,i,"mergeDocumentOptions");const o=s(this,bE).mergeDocuments(t,e);return s(this,SE).get(o.uid)}on(t,e){const i="DocumentManager.on";!uk(t,1,i,"eventName")&&!uk(e,1,i,"listener")&&Hk(t,1,i,"eventName",!1)&&Fk(e,i,"listener",1)&&(wE.includes(t)?s(this,CE).on(t,e):ku.warning(ku.PARAM_NOT_SUPPORT,i,"eventName"));}off(t,e){const i="DocumentManager.off";!uk(t,1,i,"eventName")&&Hk(t,1,i,"eventName",!1)&&(_s(e)||Fk(e,i,"listener",1))&&(wE.includes(t)?s(this,CE).off(t,e):ku.warning(ku.PARAM_NOT_SUPPORT,i,"eventName"));}},{currentScript:TE}=document;function AE(){return `${(()=>{if(!as&&TE){let{src:t}=TE;const e=t.indexOf("?");if(-1!==e)t=t.substring(0,e);else {const e=t.indexOf("#");-1!==e&&(t=t.substring(0,e));}return t.substring(0,t.lastIndexOf("/")+1)}return "./"})()}engine`}let kE="";function DE(){let t,i;var s;if(""===kE&&(CoreModule&&CoreModule.engineResourcePaths?(t=CoreModule.engineResourcePaths.ddv,i=CoreModule.engineResourcePaths.rootDirectory):null!==(s=window)&&void 0!==s&&null!==(s=s.Dynamsoft)&&void 0!==s&&null!==(s=s.Core)&&void 0!==s&&null!==(s=s.CoreModule)&&void 0!==s&&null!==(s=s.engineResourcePaths)&&void 0!==s&&s.ddv&&(t=window.Dynamsoft.Core.CoreModule.engineResourcePaths.ddv,window.Dynamsoft.Core.CoreModule.engineResourcePaths.rootDirectory&&(i=window.Dynamsoft.Core.CoreModule.engineResourcePaths.rootDirectory)),t))if(Xs(t)&&(kE=t),Xs(kE)){if(kE.startsWith("https://")||kE.startsWith("http://"));else if(kE.startsWith("@engineRootDirectory/")){let t=i;i&&Xs(i)&&i.length>0?"/"===t.charAt(t.length-1)&&(t=t.substring(0,t.length-1)):t="",kE=kE.replace("@engineRootDirectory",t);}else if("@engineRootDirectory"===kE&&(kE=""),i&&Xs(i)&&i.length>0){let t="";"/"!==i.charAt(i.length-1)&&(t="/"),kE=[i,t,kE].join("");}}else kE="";return kE}var RE=new WeakMap,EE=new WeakMap,ME=new WeakMap;const IE=new class{constructor(){f(this,RE,{writable:!0,value:""}),f(this,EE,{writable:!0,value:""}),f(this,ME,{writable:!0,value:""});}get versionInfo(){return {viewer:Up,engine:no.version}}set engineResourcePath(t){Xs(t)?n(this,ME,t):ku.throw(ku.PARAM_INVALID,"Core.engineResourcePath","engineResourcePath");}get engineResourcePath(){const t=DE();return ""!==t?(n(this,ME,t),t):(""===s(this,ME)&&n(this,ME,AE()),s(this,ME))}set license(t){!function(t,e,i,s){const n=Ru.formatError({isValid:dE.isLicenseValid(t)});!n||Ru.output(e,i,s,void 0,n);}(t,0,"Core.license","license"),n(this,EE,t);}get license(){return s(this,EE)}set deviceFriendlyName(t){Xs(t)?n(this,RE,t):ku.throw(ku.PARAM_INVALID,"Core.deviceFriendlyName","deviceFriendlyName");}get deviceFriendlyName(){return s(this,RE)}loadWasm(){return async function(t){let e=t.trim();e.endsWith("/")||(e=`${e}/`);const i=ku.buildInfo("loadWasm",{});if(ku.info(i),no.resourceDir=e,!await no.isResourceDirValid())return i.status="Failed",ku.info(i),ku.reject(ku.RESOURCE_NOT_FOUND,"DDV.Core.loadWasm");const s=no.preloadModule("proc"),n=no.preloadModule("pdf");await Promise.all([s,n]),i.status="Completed",ku.info(i);}(this.engineResourcePath)}init(){return ng({license:s(this,EE),engineResourcePath:this.engineResourcePath,deviceFriendlyName:s(this,RE)})}};var BE;!function(t){t.NONE="none",t.BLACK_AND_WHITE="blackAndWhite",t.GRAY="gray",t.REMOVE_SHADOW="removeShadow",t.SAVE_INK="saveInk",t.ENHANCE="enhance",t.INVERT="invert";}(BE||(BE={}));const UE=[],LE={documentManager:PE,Core:IE,Elements:gk,DocumentDetect:du,ImageFilter:class{constructor(){v(this,Pu),v(this,Cu);}get defaultFilterType(){return tu.NONE}async applyFilter(t,e,i,s){const n=new wo,o=p(this,Cu,Tu).call(this,e,i),r=p(this,Pu,Au).call(this,{outputType:Mo[t.type],...s||{}});let a;try{const i=await n.initImage({source:t.data,isRGBA:t.type===uo.RGBA,width:t.width,height:t.height,isBGRA:t.type===uo.BGRA});let s;i.srcBuffer&&(t.data=i.srcBuffer),e===tu.NONE?(s=await n.getImage({jpegQuality:r.jpegQuality,ifDeleteObject:!0,isRGBA:t.type===uo.RGBA,bitDepth:r.bitDepth,xDpi:r.xdpi,yDpi:r.ydpi,outputType:r.outputType,returnType:go.RT_BINARY}),n.freeReservedData()):s=await n.filter(bu.get(e),o,r),a=new Blob([s.imageData],{type:s.blobType});}finally{n.terminate();}return a}querySupported(){return [{type:tu.NONE,label:"Original"},{type:tu.BLACK_AND_WHITE,label:"B&W"},{type:tu.GRAY,label:"Grayscale"},{type:tu.SAVE_INK,label:"Save Toner"}]}destroy(){}},BrowseViewer:NR,CaptureViewer:Qk,CustomViewer:VR,EditViewer:SR,PerspectiveViewer:LR,get lastError(){return ku.getLastError()},clearLastError(){ku.lastError=void 0;},Experiments:{get(t,e){switch(t){case"WasmEnv":return no;case"ImageProcess":return new Iu;case"FileParser.Options":return GT.getFileParserDefaultOptions(e);case"InnerViewer":return GT.getViewer(e);case"PageSourceInfo":return GT.getPageSourceInfo(e);case"AnnotationInkSignatureBoard":return lx;case"AnnotationCustomStampBoard":return wx;default:return}},set(t,e){switch(t){case"FileParser.Options":return GT.setFileParserDefaultOptions(e.type,e.options);case"ClearExternalHandler":return GT.clearExternalHandler(e.type);default:return}}},async addFonts(t){const e="DDV.addFonts";if(uk(t,0,e,"fonts"))return [];const i=function(t,e,i,s,n){const o=Ru.formatError({isValid:Ls(t)});if(o)return Ru.output(e,i,s,void 0,o);const r=[];return t.forEach(((t,e)=>{const i=Ru.formatDetails(Du("Array",n,`[${e}]`,!0),Hs(t));r.push(...i);})),!!r.length&&Ru.output(e,i,s,r)}(t,0,e,"fonts","font");if(i)return [];const s=[];try{for(let e=0;e<t.length;e++){const i=t[e],n=new Po,o=await n.getFontInfo(i).catch((t=>{throw n.terminate(),t}));n.terminate();for(let t=0;t<o.fontInfo.length;t++){const e=o.fontInfo[t];if(s.includes(e.family)||s.push(e.family),!UE.includes(e.family)){let t=e.family;try{const e=new FontFace(t,o.srcBuffer,{style:"normal",weight:"normal",display:"swap"}),i=await e.load();document.fonts.add(i);}catch(e){t=`"${t}"`;const i=new FontFace(t,o.srcBuffer,{style:"normal",weight:"normal",display:"swap"}),s=await i.load();document.fonts.add(s);}UE.push(e.family);const i=`${t}${e.isBold?"Bold":""}${e.isItalic?"Italic":""}`;Co.addPdfFont(i,o.srcBuffer),GT.getViewers().forEach((e=>{e.addFontToUi(t),e.context.render();}));}}}}catch(t){return ku.reject(ku.PARAM_INVALID,e,"fonts")}return Promise.resolve(s)},getDefaultUiConfig(t){const e="DDV.getDefaultUiConfig",i="viewerType";if(uk(t,1,i,e)||!Hk(t,1,e,i)||!function(t,e,i,s){return !!["editViewer","perspectiveViewer","captureViewer","browseViewer"].includes(t)||Ru.output(s,e,i,void 0,ku.PARAM_NOT_SUPPORT)}(t,e,i,1))return null;let s=null;if($s()){s={editViewer:vk,perspectiveViewer:mk,captureViewer:fk,browseViewer:bk}[t];}else {s={editViewer:wk,perspectiveViewer:xk,captureViewer:yk,browseViewer:bk}[t];}return Ns(s)},setProcessingHandler(t,e){const i="DDV.setProcessingHandler",s="type",n="handler";switch(uk(t,0,i,s),uk(e,0,i,n),function(t,e,i,s){const n=Ru.formatError(dE.isHandlerTypeValid(t));n&&Ru.output(e,i,s,void 0,n);}(t,0,i,s),t){case"documentBoundariesDetect":("function"!=typeof(o=e).detect||"function"!=typeof o.destroy)&&Ru.error(i,n);break;case"imageFilter":(function(t){return "function"==typeof t.querySupported&&"defaultFilterType"in t&&"function"==typeof t.applyFilter&&"function"==typeof t.destroy})(e)||Ru.error(i,n);}var o;try{switch(t){case"documentBoundariesDetect":GT.setDetectHandler(t,e);break;case"imageFilter":GT.setImageFilterHandler(e);}}catch(t){ku.throw(t,i);}},setFileParser(t,e){GT.setFileParser(t,e);},unload(){this.Core.deviceFriendlyName="",this.Core.engineResourcePath=DE(),this.Core.license="",GT.unload(),iR.clear(),this.off("error"),this.off("warning"),this.off("verbose"),this.off("info");},on(t,e){const i="DDV.on";if(uk(t,1,i,"eventName")||uk(e,1,i,"listener")||!Hk(t,1,i,"eventName",!1)||!Fk(e,i,"listener",1))return;const s={error:"error",warning:"warning",verbose:"verbose",info:"info"}[t];s?ku.on(s,e):ku.throw(ku.PARAM_NOT_SUPPORT,i,"eventName");},off(t,e){const i="DDV.off";if(uk(t,1,i,"eventName")||!Hk(t,1,i,"eventName",!1))return;if(!_s(e)&&!Fk(e,i,"listener",1))return;const s={error:"error",warning:"warning",verbose:"verbose",info:"info"}[t];s?ku.off(s,e):ku.throw(ku.PARAM_NOT_SUPPORT,i,"eventName");},EnumImageDataType:uo,EnumConvertMode:Cd,EnumDocumentDetectionStatus:Kd,EnumImageFilterType:BE,EnumPDFCompressionType:Ho,EnumPDFPageType:Vo,EnumTIFFCompressionType:Fo,EnumStampIcon:Ck,EnumLineEnding:Pk,EnumAnnotationRenderMode:Pd,annotationManager:cR};window.Dynamsoft||(window.Dynamsoft={}),window.Dynamsoft.DDV=LE;

export { NR as BrowseViewer, Qk as CaptureViewer, VR as CustomViewer, LE as DDV, SR as EditViewer, Pd as EnumAnnotationRenderMode, Cd as EnumConvertMode, Kd as EnumDocumentDetectionStatus, uo as EnumImageDataType, BE as EnumImageFilterType, Ho as EnumPDFCompressionType, Vo as EnumPDFPageType, Fo as EnumTIFFCompressionType, LR as PerspectiveViewer };
